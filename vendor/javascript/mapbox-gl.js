import Ye from"process";var ut=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var pt={};var wt=Ye;(function(Ye,ut){pt=ut()})(0,(function(){var Ye,pt,Tt;function define(ut,wt){if(Ye)if(pt){var St="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+Ye+")(sharedChunk); ("+pt+")(sharedChunk); self.onerror = null;";var It={};Ye(It);Tt=wt(It);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(Tt.workerUrl=window.URL.createObjectURL(new Blob([St],{type:"text/javascript"})))}else pt=wt;else Ye=wt}define(["exports"],(function(Ye){var pt="3.5.2";let Tt;const St={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==Tt){const Ye=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{Tt=null!=wt.env.API_URL_REGEX?new RegExp(wt.env.API_URL_REGEX):Ye}catch(ut){Tt=Ye}}return Tt},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!St.API_URL)return null;try{const Ye=new URL(St.API_URL);return"api.mapbox.cn"===Ye.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===Ye.hostname?"https://events.mapbox.com/events/v2":null}catch(Ye){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function i(Ye){return St.API_URL_REGEX.test(Ye)}function s(Ye){return 0===Ye.indexOf("mapbox:")}function a(Ye){return St.API_CDN_URL_REGEX.test(Ye)}function o(Ye){return St.API_SPRITE_REGEX.test(Ye)}function l(Ye){return St.API_STYLE_REGEX.test(Ye)&&!o(Ye)}const It={create:"create",load:"load",fullLoad:"fullLoad"},Lt={mark(Ye){performance.mark(Ye)},measure(Ye,ut,pt){performance.measure(Ye,ut,pt)}};function h(Ye){const ut=Ye.name.split("?")[0];return a(ut)&&ut.includes("mapbox-gl.js")?"javascript":a(ut)&&ut.includes("mapbox-gl.css")?"css":function(Ye){return St.API_FONTS_REGEX.test(Ye)}(ut)?"fontRange":o(ut)?"sprite":l(ut)?"style":function(Ye){return St.API_TILEJSON_REGEX.test(Ye)}(ut)?"tilejson":"other"}function p(Ye){return Ye&&Ye.__esModule&&Object.prototype.hasOwnProperty.call(Ye,"default")?Ye.default:Ye}var $t={},Xt={};Object.defineProperty(Xt,"__esModule",{value:!0}),Xt.setMatrixArrayType=function(Ye){Xt.ARRAY_TYPE=Lr=Ye},Xt.toRadian=function(Ye){return Ye*fn},Xt.equals=function(Ye,ut){return Math.abs(Ye-ut)<=Sr*Math.max(1,Math.abs(Ye),Math.abs(ut))},Xt.RANDOM=Xt.ARRAY_TYPE=Xt.EPSILON=void 0;var Sr=1e-6;Xt.EPSILON=Sr;var Lr="undefined"!=typeof Float32Array?Float32Array:Array;Xt.ARRAY_TYPE=Lr;var Qr=Math.random;Xt.RANDOM=Qr;var fn=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var Ye=0,ut=arguments.length;ut--;)Ye+=arguments[ut]*arguments[ut];return Math.sqrt(Ye)});var xn={};function v(Ye){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},v(Ye)}Object.defineProperty(xn,"__esModule",{value:!0}),xn.create=function(){var Ye=new vn.ARRAY_TYPE(4);return vn.ARRAY_TYPE!=Float32Array&&(Ye[1]=0,Ye[2]=0),Ye[0]=1,Ye[3]=1,Ye},xn.clone=function(Ye){var ut=new vn.ARRAY_TYPE(4);return ut[0]=Ye[0],ut[1]=Ye[1],ut[2]=Ye[2],ut[3]=Ye[3],ut},xn.copy=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[3],Ye},xn.identity=function(Ye){return Ye[0]=1,Ye[1]=0,Ye[2]=0,Ye[3]=1,Ye},xn.fromValues=function(Ye,ut,pt,wt){var Tt=new vn.ARRAY_TYPE(4);return Tt[0]=Ye,Tt[1]=ut,Tt[2]=pt,Tt[3]=wt,Tt},xn.set=function(Ye,ut,pt,wt,Tt){return Ye[0]=ut,Ye[1]=pt,Ye[2]=wt,Ye[3]=Tt,Ye},xn.transpose=function(Ye,ut){if(Ye===ut){var pt=ut[1];Ye[1]=ut[2],Ye[2]=pt}else Ye[0]=ut[0],Ye[1]=ut[2],Ye[2]=ut[1],Ye[3]=ut[3];return Ye},xn.invert=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=pt*St-Tt*wt;return It?(Ye[0]=St*(It=1/It),Ye[1]=-wt*It,Ye[2]=-Tt*It,Ye[3]=pt*It,Ye):null},xn.adjoint=function(Ye,ut){var pt=ut[0];return Ye[0]=ut[3],Ye[1]=-ut[1],Ye[2]=-ut[2],Ye[3]=pt,Ye},xn.determinant=function(Ye){return Ye[0]*Ye[3]-Ye[2]*Ye[1]},xn.multiply=M,xn.rotate=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=Math.sin(pt),$t=Math.cos(pt);return Ye[0]=wt*$t+St*Lt,Ye[1]=Tt*$t+It*Lt,Ye[2]=wt*-Lt+St*$t,Ye[3]=Tt*-Lt+It*$t,Ye},xn.scale=function(Ye,ut,pt){var wt=ut[1],Tt=ut[2],St=ut[3],It=pt[0],Lt=pt[1];return Ye[0]=ut[0]*It,Ye[1]=wt*It,Ye[2]=Tt*Lt,Ye[3]=St*Lt,Ye},xn.fromRotation=function(Ye,ut){var pt=Math.sin(ut),wt=Math.cos(ut);return Ye[0]=wt,Ye[1]=pt,Ye[2]=-pt,Ye[3]=wt,Ye},xn.fromScaling=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=0,Ye[2]=0,Ye[3]=ut[1],Ye},xn.str=function(Ye){return"mat2("+Ye[0]+", "+Ye[1]+", "+Ye[2]+", "+Ye[3]+")"},xn.frob=function(Ye){return Math.hypot(Ye[0],Ye[1],Ye[2],Ye[3])},xn.LDU=function(Ye,ut,pt,wt){return Ye[2]=wt[2]/wt[0],pt[0]=wt[0],pt[1]=wt[1],pt[3]=wt[3]-Ye[2]*pt[1],[Ye,ut,pt]},xn.add=function(Ye,ut,pt){return Ye[0]=ut[0]+pt[0],Ye[1]=ut[1]+pt[1],Ye[2]=ut[2]+pt[2],Ye[3]=ut[3]+pt[3],Ye},xn.subtract=A,xn.exactEquals=function(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]&&Ye[2]===ut[2]&&Ye[3]===ut[3]},xn.equals=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=Ye[2],St=Ye[3],It=ut[0],Lt=ut[1],$t=ut[2],Xt=ut[3];return Math.abs(pt-It)<=vn.EPSILON*Math.max(1,Math.abs(pt),Math.abs(It))&&Math.abs(wt-Lt)<=vn.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Lt))&&Math.abs(Tt-$t)<=vn.EPSILON*Math.max(1,Math.abs(Tt),Math.abs($t))&&Math.abs(St-Xt)<=vn.EPSILON*Math.max(1,Math.abs(St),Math.abs(Xt))},xn.multiplyScalar=function(Ye,ut,pt){return Ye[0]=ut[0]*pt,Ye[1]=ut[1]*pt,Ye[2]=ut[2]*pt,Ye[3]=ut[3]*pt,Ye},xn.multiplyScalarAndAdd=function(Ye,ut,pt,wt){return Ye[0]=ut[0]+pt[0]*wt,Ye[1]=ut[1]+pt[1]*wt,Ye[2]=ut[2]+pt[2]*wt,Ye[3]=ut[3]+pt[3]*wt,Ye},xn.sub=xn.mul=void 0;var vn=function(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==v(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=w(void 0);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}(Xt);function w(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(w=function(Ye){return Ye?pt:ut})(Ye)}function M(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=pt[0],$t=pt[1],Xt=pt[2],Sr=pt[3];return Ye[0]=wt*Lt+St*$t,Ye[1]=Tt*Lt+It*$t,Ye[2]=wt*Xt+St*Sr,Ye[3]=Tt*Xt+It*Sr,Ye}function A(Ye,ut,pt){return Ye[0]=ut[0]-pt[0],Ye[1]=ut[1]-pt[1],Ye[2]=ut[2]-pt[2],Ye[3]=ut[3]-pt[3],Ye}xn.mul=M,xn.sub=A;var kn={};function I(Ye){return I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},I(Ye)}Object.defineProperty(kn,"__esModule",{value:!0}),kn.create=function(){var Ye=new Wn.ARRAY_TYPE(6);return Wn.ARRAY_TYPE!=Float32Array&&(Ye[1]=0,Ye[2]=0,Ye[4]=0,Ye[5]=0),Ye[0]=1,Ye[3]=1,Ye},kn.clone=function(Ye){var ut=new Wn.ARRAY_TYPE(6);return ut[0]=Ye[0],ut[1]=Ye[1],ut[2]=Ye[2],ut[3]=Ye[3],ut[4]=Ye[4],ut[5]=Ye[5],ut},kn.copy=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[3],Ye[4]=ut[4],Ye[5]=ut[5],Ye},kn.identity=function(Ye){return Ye[0]=1,Ye[1]=0,Ye[2]=0,Ye[3]=1,Ye[4]=0,Ye[5]=0,Ye},kn.fromValues=function(Ye,ut,pt,wt,Tt,St){var It=new Wn.ARRAY_TYPE(6);return It[0]=Ye,It[1]=ut,It[2]=pt,It[3]=wt,It[4]=Tt,It[5]=St,It},kn.set=function(Ye,ut,pt,wt,Tt,St,It){return Ye[0]=ut,Ye[1]=pt,Ye[2]=wt,Ye[3]=Tt,Ye[4]=St,Ye[5]=It,Ye},kn.invert=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=ut[4],Lt=ut[5],$t=pt*St-wt*Tt;return $t?(Ye[0]=St*($t=1/$t),Ye[1]=-wt*$t,Ye[2]=-Tt*$t,Ye[3]=pt*$t,Ye[4]=(Tt*Lt-St*It)*$t,Ye[5]=(wt*It-pt*Lt)*$t,Ye):null},kn.determinant=function(Ye){return Ye[0]*Ye[3]-Ye[1]*Ye[2]},kn.multiply=P,kn.rotate=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=Math.sin(pt),Sr=Math.cos(pt);return Ye[0]=wt*Sr+St*Xt,Ye[1]=Tt*Sr+It*Xt,Ye[2]=wt*-Xt+St*Sr,Ye[3]=Tt*-Xt+It*Sr,Ye[4]=Lt,Ye[5]=$t,Ye},kn.scale=function(Ye,ut,pt){var wt=ut[1],Tt=ut[2],St=ut[3],It=ut[4],Lt=ut[5],$t=pt[0],Xt=pt[1];return Ye[0]=ut[0]*$t,Ye[1]=wt*$t,Ye[2]=Tt*Xt,Ye[3]=St*Xt,Ye[4]=It,Ye[5]=Lt,Ye},kn.translate=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=pt[0],Sr=pt[1];return Ye[0]=wt,Ye[1]=Tt,Ye[2]=St,Ye[3]=It,Ye[4]=wt*Xt+St*Sr+Lt,Ye[5]=Tt*Xt+It*Sr+$t,Ye},kn.fromRotation=function(Ye,ut){var pt=Math.sin(ut),wt=Math.cos(ut);return Ye[0]=wt,Ye[1]=pt,Ye[2]=-pt,Ye[3]=wt,Ye[4]=0,Ye[5]=0,Ye},kn.fromScaling=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=0,Ye[2]=0,Ye[3]=ut[1],Ye[4]=0,Ye[5]=0,Ye},kn.fromTranslation=function(Ye,ut){return Ye[0]=1,Ye[1]=0,Ye[2]=0,Ye[3]=1,Ye[4]=ut[0],Ye[5]=ut[1],Ye},kn.str=function(Ye){return"mat2d("+Ye[0]+", "+Ye[1]+", "+Ye[2]+", "+Ye[3]+", "+Ye[4]+", "+Ye[5]+")"},kn.frob=function(Ye){return Math.hypot(Ye[0],Ye[1],Ye[2],Ye[3],Ye[4],Ye[5],1)},kn.add=function(Ye,ut,pt){return Ye[0]=ut[0]+pt[0],Ye[1]=ut[1]+pt[1],Ye[2]=ut[2]+pt[2],Ye[3]=ut[3]+pt[3],Ye[4]=ut[4]+pt[4],Ye[5]=ut[5]+pt[5],Ye},kn.subtract=z,kn.multiplyScalar=function(Ye,ut,pt){return Ye[0]=ut[0]*pt,Ye[1]=ut[1]*pt,Ye[2]=ut[2]*pt,Ye[3]=ut[3]*pt,Ye[4]=ut[4]*pt,Ye[5]=ut[5]*pt,Ye},kn.multiplyScalarAndAdd=function(Ye,ut,pt,wt){return Ye[0]=ut[0]+pt[0]*wt,Ye[1]=ut[1]+pt[1]*wt,Ye[2]=ut[2]+pt[2]*wt,Ye[3]=ut[3]+pt[3]*wt,Ye[4]=ut[4]+pt[4]*wt,Ye[5]=ut[5]+pt[5]*wt,Ye},kn.exactEquals=function(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]&&Ye[2]===ut[2]&&Ye[3]===ut[3]&&Ye[4]===ut[4]&&Ye[5]===ut[5]},kn.equals=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=Ye[2],St=Ye[3],It=Ye[4],Lt=Ye[5],$t=ut[0],Xt=ut[1],Sr=ut[2],Lr=ut[3],Qr=ut[4],fn=ut[5];return Math.abs(pt-$t)<=Wn.EPSILON*Math.max(1,Math.abs(pt),Math.abs($t))&&Math.abs(wt-Xt)<=Wn.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Xt))&&Math.abs(Tt-Sr)<=Wn.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Sr))&&Math.abs(St-Lr)<=Wn.EPSILON*Math.max(1,Math.abs(St),Math.abs(Lr))&&Math.abs(It-Qr)<=Wn.EPSILON*Math.max(1,Math.abs(It),Math.abs(Qr))&&Math.abs(Lt-fn)<=Wn.EPSILON*Math.max(1,Math.abs(Lt),Math.abs(fn))},kn.sub=kn.mul=void 0;var Wn=function(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==I(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=k(void 0);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}(Xt);function k(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(k=function(Ye){return Ye?pt:ut})(Ye)}function P(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=pt[0],Sr=pt[1],Lr=pt[2],Qr=pt[3],fn=pt[4],xn=pt[5];return Ye[0]=wt*Xt+St*Sr,Ye[1]=Tt*Xt+It*Sr,Ye[2]=wt*Lr+St*Qr,Ye[3]=Tt*Lr+It*Qr,Ye[4]=wt*fn+St*xn+Lt,Ye[5]=Tt*fn+It*xn+$t,Ye}function z(Ye,ut,pt){return Ye[0]=ut[0]-pt[0],Ye[1]=ut[1]-pt[1],Ye[2]=ut[2]-pt[2],Ye[3]=ut[3]-pt[3],Ye[4]=ut[4]-pt[4],Ye[5]=ut[5]-pt[5],Ye}kn.mul=P,kn.sub=z;var Xn={};function B(Ye){return B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},B(Ye)}Object.defineProperty(Xn,"__esModule",{value:!0}),Xn.create=function(){var Ye=new Jn.ARRAY_TYPE(9);return Jn.ARRAY_TYPE!=Float32Array&&(Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[5]=0,Ye[6]=0,Ye[7]=0),Ye[0]=1,Ye[4]=1,Ye[8]=1,Ye},Xn.fromMat4=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[4],Ye[4]=ut[5],Ye[5]=ut[6],Ye[6]=ut[8],Ye[7]=ut[9],Ye[8]=ut[10],Ye},Xn.clone=function(Ye){var ut=new Jn.ARRAY_TYPE(9);return ut[0]=Ye[0],ut[1]=Ye[1],ut[2]=Ye[2],ut[3]=Ye[3],ut[4]=Ye[4],ut[5]=Ye[5],ut[6]=Ye[6],ut[7]=Ye[7],ut[8]=Ye[8],ut},Xn.copy=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[3],Ye[4]=ut[4],Ye[5]=ut[5],Ye[6]=ut[6],Ye[7]=ut[7],Ye[8]=ut[8],Ye},Xn.fromValues=function(Ye,ut,pt,wt,Tt,St,It,Lt,$t){var Xt=new Jn.ARRAY_TYPE(9);return Xt[0]=Ye,Xt[1]=ut,Xt[2]=pt,Xt[3]=wt,Xt[4]=Tt,Xt[5]=St,Xt[6]=It,Xt[7]=Lt,Xt[8]=$t,Xt},Xn.set=function(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt){return Ye[0]=ut,Ye[1]=pt,Ye[2]=wt,Ye[3]=Tt,Ye[4]=St,Ye[5]=It,Ye[6]=Lt,Ye[7]=$t,Ye[8]=Xt,Ye},Xn.identity=function(Ye){return Ye[0]=1,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=1,Ye[5]=0,Ye[6]=0,Ye[7]=0,Ye[8]=1,Ye},Xn.transpose=function(Ye,ut){if(Ye===ut){var pt=ut[1],wt=ut[2],Tt=ut[5];Ye[1]=ut[3],Ye[2]=ut[6],Ye[3]=pt,Ye[5]=ut[7],Ye[6]=wt,Ye[7]=Tt}else Ye[0]=ut[0],Ye[1]=ut[3],Ye[2]=ut[6],Ye[3]=ut[1],Ye[4]=ut[4],Ye[5]=ut[7],Ye[6]=ut[2],Ye[7]=ut[5],Ye[8]=ut[8];return Ye},Xn.invert=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=ut[4],Lt=ut[5],$t=ut[6],Xt=ut[7],Sr=ut[8],Lr=Sr*It-Lt*Xt,Qr=-Sr*St+Lt*$t,fn=Xt*St-It*$t,xn=pt*Lr+wt*Qr+Tt*fn;return xn?(Ye[0]=Lr*(xn=1/xn),Ye[1]=(-Sr*wt+Tt*Xt)*xn,Ye[2]=(Lt*wt-Tt*It)*xn,Ye[3]=Qr*xn,Ye[4]=(Sr*pt-Tt*$t)*xn,Ye[5]=(-Lt*pt+Tt*St)*xn,Ye[6]=fn*xn,Ye[7]=(-Xt*pt+wt*$t)*xn,Ye[8]=(It*pt-wt*St)*xn,Ye):null},Xn.adjoint=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=ut[4],Lt=ut[5],$t=ut[6],Xt=ut[7],Sr=ut[8];return Ye[0]=It*Sr-Lt*Xt,Ye[1]=Tt*Xt-wt*Sr,Ye[2]=wt*Lt-Tt*It,Ye[3]=Lt*$t-St*Sr,Ye[4]=pt*Sr-Tt*$t,Ye[5]=Tt*St-pt*Lt,Ye[6]=St*Xt-It*$t,Ye[7]=wt*$t-pt*Xt,Ye[8]=pt*It-wt*St,Ye},Xn.determinant=function(Ye){var ut=Ye[3],pt=Ye[4],wt=Ye[5],Tt=Ye[6],St=Ye[7],It=Ye[8];return Ye[0]*(It*pt-wt*St)+Ye[1]*(-It*ut+wt*Tt)+Ye[2]*(St*ut-pt*Tt)},Xn.multiply=R,Xn.translate=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=ut[8],Qr=pt[0],fn=pt[1];return Ye[0]=wt,Ye[1]=Tt,Ye[2]=St,Ye[3]=It,Ye[4]=Lt,Ye[5]=$t,Ye[6]=Qr*wt+fn*It+Xt,Ye[7]=Qr*Tt+fn*Lt+Sr,Ye[8]=Qr*St+fn*$t+Lr,Ye},Xn.rotate=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=ut[8],Qr=Math.sin(pt),fn=Math.cos(pt);return Ye[0]=fn*wt+Qr*It,Ye[1]=fn*Tt+Qr*Lt,Ye[2]=fn*St+Qr*$t,Ye[3]=fn*It-Qr*wt,Ye[4]=fn*Lt-Qr*Tt,Ye[5]=fn*$t-Qr*St,Ye[6]=Xt,Ye[7]=Sr,Ye[8]=Lr,Ye},Xn.scale=function(Ye,ut,pt){var wt=pt[0],Tt=pt[1];return Ye[0]=wt*ut[0],Ye[1]=wt*ut[1],Ye[2]=wt*ut[2],Ye[3]=Tt*ut[3],Ye[4]=Tt*ut[4],Ye[5]=Tt*ut[5],Ye[6]=ut[6],Ye[7]=ut[7],Ye[8]=ut[8],Ye},Xn.fromTranslation=function(Ye,ut){return Ye[0]=1,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=1,Ye[5]=0,Ye[6]=ut[0],Ye[7]=ut[1],Ye[8]=1,Ye},Xn.fromRotation=function(Ye,ut){var pt=Math.sin(ut),wt=Math.cos(ut);return Ye[0]=wt,Ye[1]=pt,Ye[2]=0,Ye[3]=-pt,Ye[4]=wt,Ye[5]=0,Ye[6]=0,Ye[7]=0,Ye[8]=1,Ye},Xn.fromScaling=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=ut[1],Ye[5]=0,Ye[6]=0,Ye[7]=0,Ye[8]=1,Ye},Xn.fromMat2d=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=0,Ye[3]=ut[2],Ye[4]=ut[3],Ye[5]=0,Ye[6]=ut[4],Ye[7]=ut[5],Ye[8]=1,Ye},Xn.fromQuat=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=pt+pt,Lt=wt+wt,$t=Tt+Tt,Xt=pt*It,Sr=wt*It,Lr=wt*Lt,Qr=Tt*It,fn=Tt*Lt,xn=Tt*$t,vn=St*It,kn=St*Lt,Wn=St*$t;return Ye[0]=1-Lr-xn,Ye[3]=Sr-Wn,Ye[6]=Qr+kn,Ye[1]=Sr+Wn,Ye[4]=1-Xt-xn,Ye[7]=fn-vn,Ye[2]=Qr-kn,Ye[5]=fn+vn,Ye[8]=1-Xt-Lr,Ye},Xn.normalFromMat4=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=ut[4],Lt=ut[5],$t=ut[6],Xt=ut[7],Sr=ut[8],Lr=ut[9],Qr=ut[10],fn=ut[11],xn=ut[12],vn=ut[13],kn=ut[14],Wn=ut[15],Xn=pt*Lt-wt*It,Jn=pt*$t-Tt*It,Qn=pt*Xt-St*It,ko=wt*$t-Tt*Lt,Fo=wt*Xt-St*Lt,is=Tt*Xt-St*$t,ns=Sr*vn-Lr*xn,ss=Sr*kn-Qr*xn,as=Sr*Wn-fn*xn,ds=Lr*kn-Qr*vn,ps=Lr*Wn-fn*vn,ms=Qr*Wn-fn*kn,Js=Xn*ms-Jn*ps+Qn*ds+ko*as-Fo*ss+is*ns;return Js?(Ye[0]=(Lt*ms-$t*ps+Xt*ds)*(Js=1/Js),Ye[1]=($t*as-It*ms-Xt*ss)*Js,Ye[2]=(It*ps-Lt*as+Xt*ns)*Js,Ye[3]=(Tt*ps-wt*ms-St*ds)*Js,Ye[4]=(pt*ms-Tt*as+St*ss)*Js,Ye[5]=(wt*as-pt*ps-St*ns)*Js,Ye[6]=(vn*is-kn*Fo+Wn*ko)*Js,Ye[7]=(kn*Qn-xn*is-Wn*Jn)*Js,Ye[8]=(xn*Fo-vn*Qn+Wn*Xn)*Js,Ye):null},Xn.projection=function(Ye,ut,pt){return Ye[0]=2/ut,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=-2/pt,Ye[5]=0,Ye[6]=-1,Ye[7]=1,Ye[8]=1,Ye},Xn.str=function(Ye){return"mat3("+Ye[0]+", "+Ye[1]+", "+Ye[2]+", "+Ye[3]+", "+Ye[4]+", "+Ye[5]+", "+Ye[6]+", "+Ye[7]+", "+Ye[8]+")"},Xn.frob=function(Ye){return Math.hypot(Ye[0],Ye[1],Ye[2],Ye[3],Ye[4],Ye[5],Ye[6],Ye[7],Ye[8])},Xn.add=function(Ye,ut,pt){return Ye[0]=ut[0]+pt[0],Ye[1]=ut[1]+pt[1],Ye[2]=ut[2]+pt[2],Ye[3]=ut[3]+pt[3],Ye[4]=ut[4]+pt[4],Ye[5]=ut[5]+pt[5],Ye[6]=ut[6]+pt[6],Ye[7]=ut[7]+pt[7],Ye[8]=ut[8]+pt[8],Ye},Xn.subtract=V,Xn.multiplyScalar=function(Ye,ut,pt){return Ye[0]=ut[0]*pt,Ye[1]=ut[1]*pt,Ye[2]=ut[2]*pt,Ye[3]=ut[3]*pt,Ye[4]=ut[4]*pt,Ye[5]=ut[5]*pt,Ye[6]=ut[6]*pt,Ye[7]=ut[7]*pt,Ye[8]=ut[8]*pt,Ye},Xn.multiplyScalarAndAdd=function(Ye,ut,pt,wt){return Ye[0]=ut[0]+pt[0]*wt,Ye[1]=ut[1]+pt[1]*wt,Ye[2]=ut[2]+pt[2]*wt,Ye[3]=ut[3]+pt[3]*wt,Ye[4]=ut[4]+pt[4]*wt,Ye[5]=ut[5]+pt[5]*wt,Ye[6]=ut[6]+pt[6]*wt,Ye[7]=ut[7]+pt[7]*wt,Ye[8]=ut[8]+pt[8]*wt,Ye},Xn.exactEquals=function(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]&&Ye[2]===ut[2]&&Ye[3]===ut[3]&&Ye[4]===ut[4]&&Ye[5]===ut[5]&&Ye[6]===ut[6]&&Ye[7]===ut[7]&&Ye[8]===ut[8]},Xn.equals=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=Ye[2],St=Ye[3],It=Ye[4],Lt=Ye[5],$t=Ye[6],Xt=Ye[7],Sr=Ye[8],Lr=ut[0],Qr=ut[1],fn=ut[2],xn=ut[3],vn=ut[4],kn=ut[5],Wn=ut[6],Xn=ut[7],Qn=ut[8];return Math.abs(pt-Lr)<=Jn.EPSILON*Math.max(1,Math.abs(pt),Math.abs(Lr))&&Math.abs(wt-Qr)<=Jn.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Qr))&&Math.abs(Tt-fn)<=Jn.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(fn))&&Math.abs(St-xn)<=Jn.EPSILON*Math.max(1,Math.abs(St),Math.abs(xn))&&Math.abs(It-vn)<=Jn.EPSILON*Math.max(1,Math.abs(It),Math.abs(vn))&&Math.abs(Lt-kn)<=Jn.EPSILON*Math.max(1,Math.abs(Lt),Math.abs(kn))&&Math.abs($t-Wn)<=Jn.EPSILON*Math.max(1,Math.abs($t),Math.abs(Wn))&&Math.abs(Xt-Xn)<=Jn.EPSILON*Math.max(1,Math.abs(Xt),Math.abs(Xn))&&Math.abs(Sr-Qn)<=Jn.EPSILON*Math.max(1,Math.abs(Sr),Math.abs(Qn))},Xn.sub=Xn.mul=void 0;var Jn=function(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==B(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=C(void 0);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}(Xt);function C(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(C=function(Ye){return Ye?pt:ut})(Ye)}function R(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=ut[8],Qr=pt[0],fn=pt[1],xn=pt[2],vn=pt[3],kn=pt[4],Wn=pt[5],Xn=pt[6],Jn=pt[7],Qn=pt[8];return Ye[0]=Qr*wt+fn*It+xn*Xt,Ye[1]=Qr*Tt+fn*Lt+xn*Sr,Ye[2]=Qr*St+fn*$t+xn*Lr,Ye[3]=vn*wt+kn*It+Wn*Xt,Ye[4]=vn*Tt+kn*Lt+Wn*Sr,Ye[5]=vn*St+kn*$t+Wn*Lr,Ye[6]=Xn*wt+Jn*It+Qn*Xt,Ye[7]=Xn*Tt+Jn*Lt+Qn*Sr,Ye[8]=Xn*St+Jn*$t+Qn*Lr,Ye}function V(Ye,ut,pt){return Ye[0]=ut[0]-pt[0],Ye[1]=ut[1]-pt[1],Ye[2]=ut[2]-pt[2],Ye[3]=ut[3]-pt[3],Ye[4]=ut[4]-pt[4],Ye[5]=ut[5]-pt[5],Ye[6]=ut[6]-pt[6],Ye[7]=ut[7]-pt[7],Ye[8]=ut[8]-pt[8],Ye}Xn.mul=R,Xn.sub=V;var Qn={};function O(Ye){return O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},O(Ye)}Object.defineProperty(Qn,"__esModule",{value:!0}),Qn.create=function(){var Ye=new ko.ARRAY_TYPE(16);return ko.ARRAY_TYPE!=Float32Array&&(Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[11]=0,Ye[12]=0,Ye[13]=0,Ye[14]=0),Ye[0]=1,Ye[5]=1,Ye[10]=1,Ye[15]=1,Ye},Qn.clone=function(Ye){var ut=new ko.ARRAY_TYPE(16);return ut[0]=Ye[0],ut[1]=Ye[1],ut[2]=Ye[2],ut[3]=Ye[3],ut[4]=Ye[4],ut[5]=Ye[5],ut[6]=Ye[6],ut[7]=Ye[7],ut[8]=Ye[8],ut[9]=Ye[9],ut[10]=Ye[10],ut[11]=Ye[11],ut[12]=Ye[12],ut[13]=Ye[13],ut[14]=Ye[14],ut[15]=Ye[15],ut},Qn.copy=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[3],Ye[4]=ut[4],Ye[5]=ut[5],Ye[6]=ut[6],Ye[7]=ut[7],Ye[8]=ut[8],Ye[9]=ut[9],Ye[10]=ut[10],Ye[11]=ut[11],Ye[12]=ut[12],Ye[13]=ut[13],Ye[14]=ut[14],Ye[15]=ut[15],Ye},Qn.fromValues=function(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn){var kn=new ko.ARRAY_TYPE(16);return kn[0]=Ye,kn[1]=ut,kn[2]=pt,kn[3]=wt,kn[4]=Tt,kn[5]=St,kn[6]=It,kn[7]=Lt,kn[8]=$t,kn[9]=Xt,kn[10]=Sr,kn[11]=Lr,kn[12]=Qr,kn[13]=fn,kn[14]=xn,kn[15]=vn,kn},Qn.set=function(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn){return Ye[0]=ut,Ye[1]=pt,Ye[2]=wt,Ye[3]=Tt,Ye[4]=St,Ye[5]=It,Ye[6]=Lt,Ye[7]=$t,Ye[8]=Xt,Ye[9]=Sr,Ye[10]=Lr,Ye[11]=Qr,Ye[12]=fn,Ye[13]=xn,Ye[14]=vn,Ye[15]=kn,Ye},Qn.identity=N,Qn.transpose=function(Ye,ut){if(Ye===ut){var pt=ut[1],wt=ut[2],Tt=ut[3],St=ut[6],It=ut[7],Lt=ut[11];Ye[1]=ut[4],Ye[2]=ut[8],Ye[3]=ut[12],Ye[4]=pt,Ye[6]=ut[9],Ye[7]=ut[13],Ye[8]=wt,Ye[9]=St,Ye[11]=ut[14],Ye[12]=Tt,Ye[13]=It,Ye[14]=Lt}else Ye[0]=ut[0],Ye[1]=ut[4],Ye[2]=ut[8],Ye[3]=ut[12],Ye[4]=ut[1],Ye[5]=ut[5],Ye[6]=ut[9],Ye[7]=ut[13],Ye[8]=ut[2],Ye[9]=ut[6],Ye[10]=ut[10],Ye[11]=ut[14],Ye[12]=ut[3],Ye[13]=ut[7],Ye[14]=ut[11],Ye[15]=ut[15];return Ye},Qn.invert=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=ut[4],Lt=ut[5],$t=ut[6],Xt=ut[7],Sr=ut[8],Lr=ut[9],Qr=ut[10],fn=ut[11],xn=ut[12],vn=ut[13],kn=ut[14],Wn=ut[15],Xn=pt*Lt-wt*It,Jn=pt*$t-Tt*It,Qn=pt*Xt-St*It,ko=wt*$t-Tt*Lt,Fo=wt*Xt-St*Lt,is=Tt*Xt-St*$t,ns=Sr*vn-Lr*xn,ss=Sr*kn-Qr*xn,as=Sr*Wn-fn*xn,ds=Lr*kn-Qr*vn,ps=Lr*Wn-fn*vn,ms=Qr*Wn-fn*kn,Js=Xn*ms-Jn*ps+Qn*ds+ko*as-Fo*ss+is*ns;return Js?(Ye[0]=(Lt*ms-$t*ps+Xt*ds)*(Js=1/Js),Ye[1]=(Tt*ps-wt*ms-St*ds)*Js,Ye[2]=(vn*is-kn*Fo+Wn*ko)*Js,Ye[3]=(Qr*Fo-Lr*is-fn*ko)*Js,Ye[4]=($t*as-It*ms-Xt*ss)*Js,Ye[5]=(pt*ms-Tt*as+St*ss)*Js,Ye[6]=(kn*Qn-xn*is-Wn*Jn)*Js,Ye[7]=(Sr*is-Qr*Qn+fn*Jn)*Js,Ye[8]=(It*ps-Lt*as+Xt*ns)*Js,Ye[9]=(wt*as-pt*ps-St*ns)*Js,Ye[10]=(xn*Fo-vn*Qn+Wn*Xn)*Js,Ye[11]=(Lr*Qn-Sr*Fo-fn*Xn)*Js,Ye[12]=(Lt*ss-It*ds-$t*ns)*Js,Ye[13]=(pt*ds-wt*ss+Tt*ns)*Js,Ye[14]=(vn*Jn-xn*ko-kn*Xn)*Js,Ye[15]=(Sr*ko-Lr*Jn+Qr*Xn)*Js,Ye):null},Qn.adjoint=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=ut[4],Lt=ut[5],$t=ut[6],Xt=ut[7],Sr=ut[8],Lr=ut[9],Qr=ut[10],fn=ut[11],xn=ut[12],vn=ut[13],kn=ut[14],Wn=ut[15];return Ye[0]=Lt*(Qr*Wn-fn*kn)-Lr*($t*Wn-Xt*kn)+vn*($t*fn-Xt*Qr),Ye[1]=-(wt*(Qr*Wn-fn*kn)-Lr*(Tt*Wn-St*kn)+vn*(Tt*fn-St*Qr)),Ye[2]=wt*($t*Wn-Xt*kn)-Lt*(Tt*Wn-St*kn)+vn*(Tt*Xt-St*$t),Ye[3]=-(wt*($t*fn-Xt*Qr)-Lt*(Tt*fn-St*Qr)+Lr*(Tt*Xt-St*$t)),Ye[4]=-(It*(Qr*Wn-fn*kn)-Sr*($t*Wn-Xt*kn)+xn*($t*fn-Xt*Qr)),Ye[5]=pt*(Qr*Wn-fn*kn)-Sr*(Tt*Wn-St*kn)+xn*(Tt*fn-St*Qr),Ye[6]=-(pt*($t*Wn-Xt*kn)-It*(Tt*Wn-St*kn)+xn*(Tt*Xt-St*$t)),Ye[7]=pt*($t*fn-Xt*Qr)-It*(Tt*fn-St*Qr)+Sr*(Tt*Xt-St*$t),Ye[8]=It*(Lr*Wn-fn*vn)-Sr*(Lt*Wn-Xt*vn)+xn*(Lt*fn-Xt*Lr),Ye[9]=-(pt*(Lr*Wn-fn*vn)-Sr*(wt*Wn-St*vn)+xn*(wt*fn-St*Lr)),Ye[10]=pt*(Lt*Wn-Xt*vn)-It*(wt*Wn-St*vn)+xn*(wt*Xt-St*Lt),Ye[11]=-(pt*(Lt*fn-Xt*Lr)-It*(wt*fn-St*Lr)+Sr*(wt*Xt-St*Lt)),Ye[12]=-(It*(Lr*kn-Qr*vn)-Sr*(Lt*kn-$t*vn)+xn*(Lt*Qr-$t*Lr)),Ye[13]=pt*(Lr*kn-Qr*vn)-Sr*(wt*kn-Tt*vn)+xn*(wt*Qr-Tt*Lr),Ye[14]=-(pt*(Lt*kn-$t*vn)-It*(wt*kn-Tt*vn)+xn*(wt*$t-Tt*Lt)),Ye[15]=pt*(Lt*Qr-$t*Lr)-It*(wt*Qr-Tt*Lr)+Sr*(wt*$t-Tt*Lt),Ye},Qn.determinant=function(Ye){var ut=Ye[0],pt=Ye[1],wt=Ye[2],Tt=Ye[3],St=Ye[4],It=Ye[5],Lt=Ye[6],$t=Ye[7],Xt=Ye[8],Sr=Ye[9],Lr=Ye[10],Qr=Ye[11],fn=Ye[12],xn=Ye[13],vn=Ye[14],kn=Ye[15];return(ut*It-pt*St)*(Lr*kn-Qr*vn)-(ut*Lt-wt*St)*(Sr*kn-Qr*xn)+(ut*$t-Tt*St)*(Sr*vn-Lr*xn)+(pt*Lt-wt*It)*(Xt*kn-Qr*fn)-(pt*$t-Tt*It)*(Xt*vn-Lr*fn)+(wt*$t-Tt*Lt)*(Xt*xn-Sr*fn)},Qn.multiply=j,Qn.translate=function(Ye,ut,pt){var wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn=pt[0],kn=pt[1],Wn=pt[2];return ut===Ye?(Ye[12]=ut[0]*vn+ut[4]*kn+ut[8]*Wn+ut[12],Ye[13]=ut[1]*vn+ut[5]*kn+ut[9]*Wn+ut[13],Ye[14]=ut[2]*vn+ut[6]*kn+ut[10]*Wn+ut[14],Ye[15]=ut[3]*vn+ut[7]*kn+ut[11]*Wn+ut[15]):(Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=ut[8],Qr=ut[9],fn=ut[10],xn=ut[11],Ye[0]=wt=ut[0],Ye[1]=Tt,Ye[2]=St,Ye[3]=It,Ye[4]=Lt,Ye[5]=$t,Ye[6]=Xt,Ye[7]=Sr,Ye[8]=Lr,Ye[9]=Qr,Ye[10]=fn,Ye[11]=xn,Ye[12]=wt*vn+Lt*kn+Lr*Wn+ut[12],Ye[13]=Tt*vn+$t*kn+Qr*Wn+ut[13],Ye[14]=St*vn+Xt*kn+fn*Wn+ut[14],Ye[15]=It*vn+Sr*kn+xn*Wn+ut[15]),Ye},Qn.scale=function(Ye,ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2];return Ye[0]=ut[0]*wt,Ye[1]=ut[1]*wt,Ye[2]=ut[2]*wt,Ye[3]=ut[3]*wt,Ye[4]=ut[4]*Tt,Ye[5]=ut[5]*Tt,Ye[6]=ut[6]*Tt,Ye[7]=ut[7]*Tt,Ye[8]=ut[8]*St,Ye[9]=ut[9]*St,Ye[10]=ut[10]*St,Ye[11]=ut[11]*St,Ye[12]=ut[12],Ye[13]=ut[13],Ye[14]=ut[14],Ye[15]=ut[15],Ye},Qn.rotate=function(Ye,ut,pt,wt){var Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn,Fo,is,ns,ss,as,ds,ps,ms=wt[0],Js=wt[1],ua=wt[2],ba=Math.hypot(ms,Js,ua);return ba<ko.EPSILON?null:(ms*=ba=1/ba,Js*=ba,ua*=ba,Tt=Math.sin(pt),St=Math.cos(pt),$t=ut[1],Xt=ut[2],Sr=ut[3],Qr=ut[5],fn=ut[6],xn=ut[7],kn=ut[9],Wn=ut[10],Xn=ut[11],Jn=ms*ms*(It=1-St)+St,is=ms*Js*It-ua*Tt,ns=Js*Js*It+St,ss=ua*Js*It+ms*Tt,as=ms*ua*It+Js*Tt,ds=Js*ua*It-ms*Tt,ps=ua*ua*It+St,Ye[0]=(Lt=ut[0])*Jn+(Lr=ut[4])*(Qn=Js*ms*It+ua*Tt)+(vn=ut[8])*(Fo=ua*ms*It-Js*Tt),Ye[1]=$t*Jn+Qr*Qn+kn*Fo,Ye[2]=Xt*Jn+fn*Qn+Wn*Fo,Ye[3]=Sr*Jn+xn*Qn+Xn*Fo,Ye[4]=Lt*is+Lr*ns+vn*ss,Ye[5]=$t*is+Qr*ns+kn*ss,Ye[6]=Xt*is+fn*ns+Wn*ss,Ye[7]=Sr*is+xn*ns+Xn*ss,Ye[8]=Lt*as+Lr*ds+vn*ps,Ye[9]=$t*as+Qr*ds+kn*ps,Ye[10]=Xt*as+fn*ds+Wn*ps,Ye[11]=Sr*as+xn*ds+Xn*ps,ut!==Ye&&(Ye[12]=ut[12],Ye[13]=ut[13],Ye[14]=ut[14],Ye[15]=ut[15]),Ye)},Qn.rotateX=function(Ye,ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt),St=ut[4],It=ut[5],Lt=ut[6],$t=ut[7],Xt=ut[8],Sr=ut[9],Lr=ut[10],Qr=ut[11];return ut!==Ye&&(Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[3],Ye[12]=ut[12],Ye[13]=ut[13],Ye[14]=ut[14],Ye[15]=ut[15]),Ye[4]=St*Tt+Xt*wt,Ye[5]=It*Tt+Sr*wt,Ye[6]=Lt*Tt+Lr*wt,Ye[7]=$t*Tt+Qr*wt,Ye[8]=Xt*Tt-St*wt,Ye[9]=Sr*Tt-It*wt,Ye[10]=Lr*Tt-Lt*wt,Ye[11]=Qr*Tt-$t*wt,Ye},Qn.rotateY=function(Ye,ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt),St=ut[0],It=ut[1],Lt=ut[2],$t=ut[3],Xt=ut[8],Sr=ut[9],Lr=ut[10],Qr=ut[11];return ut!==Ye&&(Ye[4]=ut[4],Ye[5]=ut[5],Ye[6]=ut[6],Ye[7]=ut[7],Ye[12]=ut[12],Ye[13]=ut[13],Ye[14]=ut[14],Ye[15]=ut[15]),Ye[0]=St*Tt-Xt*wt,Ye[1]=It*Tt-Sr*wt,Ye[2]=Lt*Tt-Lr*wt,Ye[3]=$t*Tt-Qr*wt,Ye[8]=St*wt+Xt*Tt,Ye[9]=It*wt+Sr*Tt,Ye[10]=Lt*wt+Lr*Tt,Ye[11]=$t*wt+Qr*Tt,Ye},Qn.rotateZ=function(Ye,ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt),St=ut[0],It=ut[1],Lt=ut[2],$t=ut[3],Xt=ut[4],Sr=ut[5],Lr=ut[6],Qr=ut[7];return ut!==Ye&&(Ye[8]=ut[8],Ye[9]=ut[9],Ye[10]=ut[10],Ye[11]=ut[11],Ye[12]=ut[12],Ye[13]=ut[13],Ye[14]=ut[14],Ye[15]=ut[15]),Ye[0]=St*Tt+Xt*wt,Ye[1]=It*Tt+Sr*wt,Ye[2]=Lt*Tt+Lr*wt,Ye[3]=$t*Tt+Qr*wt,Ye[4]=Xt*Tt-St*wt,Ye[5]=Sr*Tt-It*wt,Ye[6]=Lr*Tt-Lt*wt,Ye[7]=Qr*Tt-$t*wt,Ye},Qn.fromTranslation=function(Ye,ut){return Ye[0]=1,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=1,Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[10]=1,Ye[11]=0,Ye[12]=ut[0],Ye[13]=ut[1],Ye[14]=ut[2],Ye[15]=1,Ye},Qn.fromScaling=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=ut[1],Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[10]=ut[2],Ye[11]=0,Ye[12]=0,Ye[13]=0,Ye[14]=0,Ye[15]=1,Ye},Qn.fromRotation=function(Ye,ut,pt){var wt,Tt,St,It=pt[0],Lt=pt[1],$t=pt[2],Xt=Math.hypot(It,Lt,$t);return Xt<ko.EPSILON?null:(It*=Xt=1/Xt,Lt*=Xt,$t*=Xt,wt=Math.sin(ut),Tt=Math.cos(ut),Ye[0]=It*It*(St=1-Tt)+Tt,Ye[1]=Lt*It*St+$t*wt,Ye[2]=$t*It*St-Lt*wt,Ye[3]=0,Ye[4]=It*Lt*St-$t*wt,Ye[5]=Lt*Lt*St+Tt,Ye[6]=$t*Lt*St+It*wt,Ye[7]=0,Ye[8]=It*$t*St+Lt*wt,Ye[9]=Lt*$t*St-It*wt,Ye[10]=$t*$t*St+Tt,Ye[11]=0,Ye[12]=0,Ye[13]=0,Ye[14]=0,Ye[15]=1,Ye)},Qn.fromXRotation=function(Ye,ut){var pt=Math.sin(ut),wt=Math.cos(ut);return Ye[0]=1,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=wt,Ye[6]=pt,Ye[7]=0,Ye[8]=0,Ye[9]=-pt,Ye[10]=wt,Ye[11]=0,Ye[12]=0,Ye[13]=0,Ye[14]=0,Ye[15]=1,Ye},Qn.fromYRotation=function(Ye,ut){var pt=Math.sin(ut),wt=Math.cos(ut);return Ye[0]=wt,Ye[1]=0,Ye[2]=-pt,Ye[3]=0,Ye[4]=0,Ye[5]=1,Ye[6]=0,Ye[7]=0,Ye[8]=pt,Ye[9]=0,Ye[10]=wt,Ye[11]=0,Ye[12]=0,Ye[13]=0,Ye[14]=0,Ye[15]=1,Ye},Qn.fromZRotation=function(Ye,ut){var pt=Math.sin(ut),wt=Math.cos(ut);return Ye[0]=wt,Ye[1]=pt,Ye[2]=0,Ye[3]=0,Ye[4]=-pt,Ye[5]=wt,Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[10]=1,Ye[11]=0,Ye[12]=0,Ye[13]=0,Ye[14]=0,Ye[15]=1,Ye},Qn.fromRotationTranslation=q,Qn.fromQuat2=function(Ye,ut){var pt=new ko.ARRAY_TYPE(3),wt=-ut[0],Tt=-ut[1],St=-ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=wt*wt+Tt*Tt+St*St+It*It;return Lr>0?(pt[0]=2*(Lt*It+Sr*wt+$t*St-Xt*Tt)/Lr,pt[1]=2*($t*It+Sr*Tt+Xt*wt-Lt*St)/Lr,pt[2]=2*(Xt*It+Sr*St+Lt*Tt-$t*wt)/Lr):(pt[0]=2*(Lt*It+Sr*wt+$t*St-Xt*Tt),pt[1]=2*($t*It+Sr*Tt+Xt*wt-Lt*St),pt[2]=2*(Xt*It+Sr*St+Lt*Tt-$t*wt)),q(Ye,ut,pt),Ye},Qn.getTranslation=function(Ye,ut){return Ye[0]=ut[12],Ye[1]=ut[13],Ye[2]=ut[14],Ye},Qn.getScaling=$,Qn.getRotation=function(Ye,ut){var pt=new ko.ARRAY_TYPE(3);$(pt,ut);var wt=1/pt[0],Tt=1/pt[1],St=1/pt[2],It=ut[0]*wt,Lt=ut[1]*Tt,$t=ut[2]*St,Xt=ut[4]*wt,Sr=ut[5]*Tt,Lr=ut[6]*St,Qr=ut[8]*wt,fn=ut[9]*Tt,xn=ut[10]*St,vn=It+Sr+xn,kn=0;return vn>0?(kn=2*Math.sqrt(vn+1),Ye[3]=.25*kn,Ye[0]=(Lr-fn)/kn,Ye[1]=(Qr-$t)/kn,Ye[2]=(Lt-Xt)/kn):It>Sr&&It>xn?(kn=2*Math.sqrt(1+It-Sr-xn),Ye[3]=(Lr-fn)/kn,Ye[0]=.25*kn,Ye[1]=(Lt+Xt)/kn,Ye[2]=(Qr+$t)/kn):Sr>xn?(kn=2*Math.sqrt(1+Sr-It-xn),Ye[3]=(Qr-$t)/kn,Ye[0]=(Lt+Xt)/kn,Ye[1]=.25*kn,Ye[2]=(Lr+fn)/kn):(kn=2*Math.sqrt(1+xn-It-Sr),Ye[3]=(Lt-Xt)/kn,Ye[0]=(Qr+$t)/kn,Ye[1]=(Lr+fn)/kn,Ye[2]=.25*kn),Ye},Qn.fromRotationTranslationScale=function(Ye,ut,pt,wt){var Tt=ut[0],St=ut[1],It=ut[2],Lt=ut[3],$t=Tt+Tt,Xt=St+St,Sr=It+It,Lr=Tt*$t,Qr=Tt*Xt,fn=Tt*Sr,xn=St*Xt,vn=St*Sr,kn=It*Sr,Wn=Lt*$t,Xn=Lt*Xt,Jn=Lt*Sr,Qn=wt[0],ko=wt[1],Fo=wt[2];return Ye[0]=(1-(xn+kn))*Qn,Ye[1]=(Qr+Jn)*Qn,Ye[2]=(fn-Xn)*Qn,Ye[3]=0,Ye[4]=(Qr-Jn)*ko,Ye[5]=(1-(Lr+kn))*ko,Ye[6]=(vn+Wn)*ko,Ye[7]=0,Ye[8]=(fn+Xn)*Fo,Ye[9]=(vn-Wn)*Fo,Ye[10]=(1-(Lr+xn))*Fo,Ye[11]=0,Ye[12]=pt[0],Ye[13]=pt[1],Ye[14]=pt[2],Ye[15]=1,Ye},Qn.fromRotationTranslationScaleOrigin=function(Ye,ut,pt,wt,Tt){var St=ut[0],It=ut[1],Lt=ut[2],$t=ut[3],Xt=St+St,Sr=It+It,Lr=Lt+Lt,Qr=St*Xt,fn=St*Sr,xn=St*Lr,vn=It*Sr,kn=It*Lr,Wn=Lt*Lr,Xn=$t*Xt,Jn=$t*Sr,Qn=$t*Lr,ko=wt[0],Fo=wt[1],is=wt[2],ns=Tt[0],ss=Tt[1],as=Tt[2],ds=(1-(vn+Wn))*ko,ps=(fn+Qn)*ko,ms=(xn-Jn)*ko,Js=(fn-Qn)*Fo,ua=(1-(Qr+Wn))*Fo,ba=(kn+Xn)*Fo,Ra=(xn+Jn)*is,La=(kn-Xn)*is,ll=(1-(Qr+vn))*is;return Ye[0]=ds,Ye[1]=ps,Ye[2]=ms,Ye[3]=0,Ye[4]=Js,Ye[5]=ua,Ye[6]=ba,Ye[7]=0,Ye[8]=Ra,Ye[9]=La,Ye[10]=ll,Ye[11]=0,Ye[12]=pt[0]+ns-(ds*ns+Js*ss+Ra*as),Ye[13]=pt[1]+ss-(ps*ns+ua*ss+La*as),Ye[14]=pt[2]+as-(ms*ns+ba*ss+ll*as),Ye[15]=1,Ye},Qn.fromQuat=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=pt+pt,Lt=wt+wt,$t=Tt+Tt,Xt=pt*It,Sr=wt*It,Lr=wt*Lt,Qr=Tt*It,fn=Tt*Lt,xn=Tt*$t,vn=St*It,kn=St*Lt,Wn=St*$t;return Ye[0]=1-Lr-xn,Ye[1]=Sr+Wn,Ye[2]=Qr-kn,Ye[3]=0,Ye[4]=Sr-Wn,Ye[5]=1-Xt-xn,Ye[6]=fn+vn,Ye[7]=0,Ye[8]=Qr+kn,Ye[9]=fn-vn,Ye[10]=1-Xt-Lr,Ye[11]=0,Ye[12]=0,Ye[13]=0,Ye[14]=0,Ye[15]=1,Ye},Qn.frustum=function(Ye,ut,pt,wt,Tt,St,It){var Lt=1/(pt-ut),$t=1/(Tt-wt),Xt=1/(St-It);return Ye[0]=2*St*Lt,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=2*St*$t,Ye[6]=0,Ye[7]=0,Ye[8]=(pt+ut)*Lt,Ye[9]=(Tt+wt)*$t,Ye[10]=(It+St)*Xt,Ye[11]=-1,Ye[12]=0,Ye[13]=0,Ye[14]=It*St*2*Xt,Ye[15]=0,Ye},Qn.perspectiveNO=G,Qn.perspectiveZO=function(Ye,ut,pt,wt,Tt){var St,It=1/Math.tan(ut/2);return Ye[0]=It/pt,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=It,Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[11]=-1,Ye[12]=0,Ye[13]=0,Ye[15]=0,null!=Tt&&Tt!==1/0?(Ye[10]=Tt*(St=1/(wt-Tt)),Ye[14]=Tt*wt*St):(Ye[10]=-1,Ye[14]=-wt),Ye},Qn.perspectiveFromFieldOfView=function(Ye,ut,pt,wt){var Tt=Math.tan(ut.upDegrees*Math.PI/180),St=Math.tan(ut.downDegrees*Math.PI/180),It=Math.tan(ut.leftDegrees*Math.PI/180),Lt=Math.tan(ut.rightDegrees*Math.PI/180),$t=2/(It+Lt),Xt=2/(Tt+St);return Ye[0]=$t,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=Xt,Ye[6]=0,Ye[7]=0,Ye[8]=-(It-Lt)*$t*.5,Ye[9]=(Tt-St)*Xt*.5,Ye[10]=wt/(pt-wt),Ye[11]=-1,Ye[12]=0,Ye[13]=0,Ye[14]=wt*pt/(pt-wt),Ye[15]=0,Ye},Qn.orthoNO=Y,Qn.orthoZO=function(Ye,ut,pt,wt,Tt,St,It){var Lt=1/(ut-pt),$t=1/(wt-Tt),Xt=1/(St-It);return Ye[0]=-2*Lt,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=-2*$t,Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[10]=Xt,Ye[11]=0,Ye[12]=(ut+pt)*Lt,Ye[13]=(Tt+wt)*$t,Ye[14]=St*Xt,Ye[15]=1,Ye},Qn.lookAt=function(Ye,ut,pt,wt){var Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn=ut[0],vn=ut[1],kn=ut[2],Wn=wt[0],Xn=wt[1],Jn=wt[2],Qn=pt[0],Fo=pt[1],is=pt[2];return Math.abs(xn-Qn)<ko.EPSILON&&Math.abs(vn-Fo)<ko.EPSILON&&Math.abs(kn-is)<ko.EPSILON?N(Ye):(Sr=xn-Qn,Lr=vn-Fo,Qr=kn-is,Tt=Xn*(Qr*=fn=1/Math.hypot(Sr,Lr,Qr))-Jn*(Lr*=fn),St=Jn*(Sr*=fn)-Wn*Qr,It=Wn*Lr-Xn*Sr,(fn=Math.hypot(Tt,St,It))?(Tt*=fn=1/fn,St*=fn,It*=fn):(Tt=0,St=0,It=0),Lt=Lr*It-Qr*St,$t=Qr*Tt-Sr*It,Xt=Sr*St-Lr*Tt,(fn=Math.hypot(Lt,$t,Xt))?(Lt*=fn=1/fn,$t*=fn,Xt*=fn):(Lt=0,$t=0,Xt=0),Ye[0]=Tt,Ye[1]=Lt,Ye[2]=Sr,Ye[3]=0,Ye[4]=St,Ye[5]=$t,Ye[6]=Lr,Ye[7]=0,Ye[8]=It,Ye[9]=Xt,Ye[10]=Qr,Ye[11]=0,Ye[12]=-(Tt*xn+St*vn+It*kn),Ye[13]=-(Lt*xn+$t*vn+Xt*kn),Ye[14]=-(Sr*xn+Lr*vn+Qr*kn),Ye[15]=1,Ye)},Qn.targetTo=function(Ye,ut,pt,wt){var Tt=ut[0],St=ut[1],It=ut[2],Lt=wt[0],$t=wt[1],Xt=wt[2],Sr=Tt-pt[0],Lr=St-pt[1],Qr=It-pt[2],fn=Sr*Sr+Lr*Lr+Qr*Qr;fn>0&&(Sr*=fn=1/Math.sqrt(fn),Lr*=fn,Qr*=fn);var xn=$t*Qr-Xt*Lr,vn=Xt*Sr-Lt*Qr,kn=Lt*Lr-$t*Sr;return(fn=xn*xn+vn*vn+kn*kn)>0&&(xn*=fn=1/Math.sqrt(fn),vn*=fn,kn*=fn),Ye[0]=xn,Ye[1]=vn,Ye[2]=kn,Ye[3]=0,Ye[4]=Lr*kn-Qr*vn,Ye[5]=Qr*xn-Sr*kn,Ye[6]=Sr*vn-Lr*xn,Ye[7]=0,Ye[8]=Sr,Ye[9]=Lr,Ye[10]=Qr,Ye[11]=0,Ye[12]=Tt,Ye[13]=St,Ye[14]=It,Ye[15]=1,Ye},Qn.str=function(Ye){return"mat4("+Ye[0]+", "+Ye[1]+", "+Ye[2]+", "+Ye[3]+", "+Ye[4]+", "+Ye[5]+", "+Ye[6]+", "+Ye[7]+", "+Ye[8]+", "+Ye[9]+", "+Ye[10]+", "+Ye[11]+", "+Ye[12]+", "+Ye[13]+", "+Ye[14]+", "+Ye[15]+")"},Qn.frob=function(Ye){return Math.hypot(Ye[0],Ye[1],Ye[2],Ye[3],Ye[4],Ye[5],Ye[6],Ye[7],Ye[8],Ye[9],Ye[10],Ye[11],Ye[12],Ye[13],Ye[14],Ye[15])},Qn.add=function(Ye,ut,pt){return Ye[0]=ut[0]+pt[0],Ye[1]=ut[1]+pt[1],Ye[2]=ut[2]+pt[2],Ye[3]=ut[3]+pt[3],Ye[4]=ut[4]+pt[4],Ye[5]=ut[5]+pt[5],Ye[6]=ut[6]+pt[6],Ye[7]=ut[7]+pt[7],Ye[8]=ut[8]+pt[8],Ye[9]=ut[9]+pt[9],Ye[10]=ut[10]+pt[10],Ye[11]=ut[11]+pt[11],Ye[12]=ut[12]+pt[12],Ye[13]=ut[13]+pt[13],Ye[14]=ut[14]+pt[14],Ye[15]=ut[15]+pt[15],Ye},Qn.subtract=X,Qn.multiplyScalar=function(Ye,ut,pt){return Ye[0]=ut[0]*pt,Ye[1]=ut[1]*pt,Ye[2]=ut[2]*pt,Ye[3]=ut[3]*pt,Ye[4]=ut[4]*pt,Ye[5]=ut[5]*pt,Ye[6]=ut[6]*pt,Ye[7]=ut[7]*pt,Ye[8]=ut[8]*pt,Ye[9]=ut[9]*pt,Ye[10]=ut[10]*pt,Ye[11]=ut[11]*pt,Ye[12]=ut[12]*pt,Ye[13]=ut[13]*pt,Ye[14]=ut[14]*pt,Ye[15]=ut[15]*pt,Ye},Qn.multiplyScalarAndAdd=function(Ye,ut,pt,wt){return Ye[0]=ut[0]+pt[0]*wt,Ye[1]=ut[1]+pt[1]*wt,Ye[2]=ut[2]+pt[2]*wt,Ye[3]=ut[3]+pt[3]*wt,Ye[4]=ut[4]+pt[4]*wt,Ye[5]=ut[5]+pt[5]*wt,Ye[6]=ut[6]+pt[6]*wt,Ye[7]=ut[7]+pt[7]*wt,Ye[8]=ut[8]+pt[8]*wt,Ye[9]=ut[9]+pt[9]*wt,Ye[10]=ut[10]+pt[10]*wt,Ye[11]=ut[11]+pt[11]*wt,Ye[12]=ut[12]+pt[12]*wt,Ye[13]=ut[13]+pt[13]*wt,Ye[14]=ut[14]+pt[14]*wt,Ye[15]=ut[15]+pt[15]*wt,Ye},Qn.exactEquals=function(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]&&Ye[2]===ut[2]&&Ye[3]===ut[3]&&Ye[4]===ut[4]&&Ye[5]===ut[5]&&Ye[6]===ut[6]&&Ye[7]===ut[7]&&Ye[8]===ut[8]&&Ye[9]===ut[9]&&Ye[10]===ut[10]&&Ye[11]===ut[11]&&Ye[12]===ut[12]&&Ye[13]===ut[13]&&Ye[14]===ut[14]&&Ye[15]===ut[15]},Qn.equals=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=Ye[2],St=Ye[3],It=Ye[4],Lt=Ye[5],$t=Ye[6],Xt=Ye[7],Sr=Ye[8],Lr=Ye[9],Qr=Ye[10],fn=Ye[11],xn=Ye[12],vn=Ye[13],kn=Ye[14],Wn=Ye[15],Xn=ut[0],Jn=ut[1],Qn=ut[2],Fo=ut[3],is=ut[4],ns=ut[5],ss=ut[6],as=ut[7],ds=ut[8],ps=ut[9],ms=ut[10],Js=ut[11],ua=ut[12],ba=ut[13],Ra=ut[14],La=ut[15];return Math.abs(pt-Xn)<=ko.EPSILON*Math.max(1,Math.abs(pt),Math.abs(Xn))&&Math.abs(wt-Jn)<=ko.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Jn))&&Math.abs(Tt-Qn)<=ko.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Qn))&&Math.abs(St-Fo)<=ko.EPSILON*Math.max(1,Math.abs(St),Math.abs(Fo))&&Math.abs(It-is)<=ko.EPSILON*Math.max(1,Math.abs(It),Math.abs(is))&&Math.abs(Lt-ns)<=ko.EPSILON*Math.max(1,Math.abs(Lt),Math.abs(ns))&&Math.abs($t-ss)<=ko.EPSILON*Math.max(1,Math.abs($t),Math.abs(ss))&&Math.abs(Xt-as)<=ko.EPSILON*Math.max(1,Math.abs(Xt),Math.abs(as))&&Math.abs(Sr-ds)<=ko.EPSILON*Math.max(1,Math.abs(Sr),Math.abs(ds))&&Math.abs(Lr-ps)<=ko.EPSILON*Math.max(1,Math.abs(Lr),Math.abs(ps))&&Math.abs(Qr-ms)<=ko.EPSILON*Math.max(1,Math.abs(Qr),Math.abs(ms))&&Math.abs(fn-Js)<=ko.EPSILON*Math.max(1,Math.abs(fn),Math.abs(Js))&&Math.abs(xn-ua)<=ko.EPSILON*Math.max(1,Math.abs(xn),Math.abs(ua))&&Math.abs(vn-ba)<=ko.EPSILON*Math.max(1,Math.abs(vn),Math.abs(ba))&&Math.abs(kn-Ra)<=ko.EPSILON*Math.max(1,Math.abs(kn),Math.abs(Ra))&&Math.abs(Wn-La)<=ko.EPSILON*Math.max(1,Math.abs(Wn),Math.abs(La))},Qn.sub=Qn.mul=Qn.ortho=Qn.perspective=void 0;var ko=function(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==O(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=U(void 0);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}(Xt);function U(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(U=function(Ye){return Ye?pt:ut})(Ye)}function N(Ye){return Ye[0]=1,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=1,Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[10]=1,Ye[11]=0,Ye[12]=0,Ye[13]=0,Ye[14]=0,Ye[15]=1,Ye}function j(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=ut[8],Qr=ut[9],fn=ut[10],xn=ut[11],vn=ut[12],kn=ut[13],Wn=ut[14],Xn=ut[15],Jn=pt[0],Qn=pt[1],ko=pt[2],Fo=pt[3];return Ye[0]=Jn*wt+Qn*Lt+ko*Lr+Fo*vn,Ye[1]=Jn*Tt+Qn*$t+ko*Qr+Fo*kn,Ye[2]=Jn*St+Qn*Xt+ko*fn+Fo*Wn,Ye[3]=Jn*It+Qn*Sr+ko*xn+Fo*Xn,Ye[4]=(Jn=pt[4])*wt+(Qn=pt[5])*Lt+(ko=pt[6])*Lr+(Fo=pt[7])*vn,Ye[5]=Jn*Tt+Qn*$t+ko*Qr+Fo*kn,Ye[6]=Jn*St+Qn*Xt+ko*fn+Fo*Wn,Ye[7]=Jn*It+Qn*Sr+ko*xn+Fo*Xn,Ye[8]=(Jn=pt[8])*wt+(Qn=pt[9])*Lt+(ko=pt[10])*Lr+(Fo=pt[11])*vn,Ye[9]=Jn*Tt+Qn*$t+ko*Qr+Fo*kn,Ye[10]=Jn*St+Qn*Xt+ko*fn+Fo*Wn,Ye[11]=Jn*It+Qn*Sr+ko*xn+Fo*Xn,Ye[12]=(Jn=pt[12])*wt+(Qn=pt[13])*Lt+(ko=pt[14])*Lr+(Fo=pt[15])*vn,Ye[13]=Jn*Tt+Qn*$t+ko*Qr+Fo*kn,Ye[14]=Jn*St+Qn*Xt+ko*fn+Fo*Wn,Ye[15]=Jn*It+Qn*Sr+ko*xn+Fo*Xn,Ye}function q(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=wt+wt,$t=Tt+Tt,Xt=St+St,Sr=wt*Lt,Lr=wt*$t,Qr=wt*Xt,fn=Tt*$t,xn=Tt*Xt,vn=St*Xt,kn=It*Lt,Wn=It*$t,Xn=It*Xt;return Ye[0]=1-(fn+vn),Ye[1]=Lr+Xn,Ye[2]=Qr-Wn,Ye[3]=0,Ye[4]=Lr-Xn,Ye[5]=1-(Sr+vn),Ye[6]=xn+kn,Ye[7]=0,Ye[8]=Qr+Wn,Ye[9]=xn-kn,Ye[10]=1-(Sr+fn),Ye[11]=0,Ye[12]=pt[0],Ye[13]=pt[1],Ye[14]=pt[2],Ye[15]=1,Ye}function $(Ye,ut){var pt=ut[4],wt=ut[5],Tt=ut[6],St=ut[8],It=ut[9],Lt=ut[10];return Ye[0]=Math.hypot(ut[0],ut[1],ut[2]),Ye[1]=Math.hypot(pt,wt,Tt),Ye[2]=Math.hypot(St,It,Lt),Ye}function G(Ye,ut,pt,wt,Tt){var St,It=1/Math.tan(ut/2);return Ye[0]=It/pt,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=It,Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[11]=-1,Ye[12]=0,Ye[13]=0,Ye[15]=0,null!=Tt&&Tt!==1/0?(Ye[10]=(Tt+wt)*(St=1/(wt-Tt)),Ye[14]=2*Tt*wt*St):(Ye[10]=-1,Ye[14]=-2*wt),Ye}function Y(Ye,ut,pt,wt,Tt,St,It){var Lt=1/(ut-pt),$t=1/(wt-Tt),Xt=1/(St-It);return Ye[0]=-2*Lt,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye[4]=0,Ye[5]=-2*$t,Ye[6]=0,Ye[7]=0,Ye[8]=0,Ye[9]=0,Ye[10]=2*Xt,Ye[11]=0,Ye[12]=(ut+pt)*Lt,Ye[13]=(Tt+wt)*$t,Ye[14]=(It+St)*Xt,Ye[15]=1,Ye}function X(Ye,ut,pt){return Ye[0]=ut[0]-pt[0],Ye[1]=ut[1]-pt[1],Ye[2]=ut[2]-pt[2],Ye[3]=ut[3]-pt[3],Ye[4]=ut[4]-pt[4],Ye[5]=ut[5]-pt[5],Ye[6]=ut[6]-pt[6],Ye[7]=ut[7]-pt[7],Ye[8]=ut[8]-pt[8],Ye[9]=ut[9]-pt[9],Ye[10]=ut[10]-pt[10],Ye[11]=ut[11]-pt[11],Ye[12]=ut[12]-pt[12],Ye[13]=ut[13]-pt[13],Ye[14]=ut[14]-pt[14],Ye[15]=ut[15]-pt[15],Ye}Qn.perspective=G,Qn.ortho=Y,Qn.mul=j,Qn.sub=X;var Fo={},is={};function K(Ye){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},K(Ye)}Object.defineProperty(is,"__esModule",{value:!0}),is.create=Q,is.clone=function(Ye){var ut=new ns.ARRAY_TYPE(3);return ut[0]=Ye[0],ut[1]=Ye[1],ut[2]=Ye[2],ut},is.length=tt,is.fromValues=function(Ye,ut,pt){var wt=new ns.ARRAY_TYPE(3);return wt[0]=Ye,wt[1]=ut,wt[2]=pt,wt},is.copy=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye},is.set=function(Ye,ut,pt,wt){return Ye[0]=ut,Ye[1]=pt,Ye[2]=wt,Ye},is.add=function(Ye,ut,pt){return Ye[0]=ut[0]+pt[0],Ye[1]=ut[1]+pt[1],Ye[2]=ut[2]+pt[2],Ye},is.subtract=et,is.multiply=rt,is.divide=nt,is.ceil=function(Ye,ut){return Ye[0]=Math.ceil(ut[0]),Ye[1]=Math.ceil(ut[1]),Ye[2]=Math.ceil(ut[2]),Ye},is.floor=function(Ye,ut){return Ye[0]=Math.floor(ut[0]),Ye[1]=Math.floor(ut[1]),Ye[2]=Math.floor(ut[2]),Ye},is.min=function(Ye,ut,pt){return Ye[0]=Math.min(ut[0],pt[0]),Ye[1]=Math.min(ut[1],pt[1]),Ye[2]=Math.min(ut[2],pt[2]),Ye},is.max=function(Ye,ut,pt){return Ye[0]=Math.max(ut[0],pt[0]),Ye[1]=Math.max(ut[1],pt[1]),Ye[2]=Math.max(ut[2],pt[2]),Ye},is.round=function(Ye,ut){return Ye[0]=Math.round(ut[0]),Ye[1]=Math.round(ut[1]),Ye[2]=Math.round(ut[2]),Ye},is.scale=function(Ye,ut,pt){return Ye[0]=ut[0]*pt,Ye[1]=ut[1]*pt,Ye[2]=ut[2]*pt,Ye},is.scaleAndAdd=function(Ye,ut,pt,wt){return Ye[0]=ut[0]+pt[0]*wt,Ye[1]=ut[1]+pt[1]*wt,Ye[2]=ut[2]+pt[2]*wt,Ye},is.distance=it,is.squaredDistance=st,is.squaredLength=at,is.negate=function(Ye,ut){return Ye[0]=-ut[0],Ye[1]=-ut[1],Ye[2]=-ut[2],Ye},is.inverse=function(Ye,ut){return Ye[0]=1/ut[0],Ye[1]=1/ut[1],Ye[2]=1/ut[2],Ye},is.normalize=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=pt*pt+wt*wt+Tt*Tt;return St>0&&(St=1/Math.sqrt(St)),Ye[0]=ut[0]*St,Ye[1]=ut[1]*St,Ye[2]=ut[2]*St,Ye},is.dot=ot,is.cross=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=pt[0],Lt=pt[1],$t=pt[2];return Ye[0]=Tt*$t-St*Lt,Ye[1]=St*It-wt*$t,Ye[2]=wt*Lt-Tt*It,Ye},is.lerp=function(Ye,ut,pt,wt){var Tt=ut[0],St=ut[1],It=ut[2];return Ye[0]=Tt+wt*(pt[0]-Tt),Ye[1]=St+wt*(pt[1]-St),Ye[2]=It+wt*(pt[2]-It),Ye},is.hermite=function(Ye,ut,pt,wt,Tt,St){var It=St*St,Lt=It*(2*St-3)+1,$t=It*(St-2)+St,Xt=It*(St-1),Sr=It*(3-2*St);return Ye[0]=ut[0]*Lt+pt[0]*$t+wt[0]*Xt+Tt[0]*Sr,Ye[1]=ut[1]*Lt+pt[1]*$t+wt[1]*Xt+Tt[1]*Sr,Ye[2]=ut[2]*Lt+pt[2]*$t+wt[2]*Xt+Tt[2]*Sr,Ye},is.bezier=function(Ye,ut,pt,wt,Tt,St){var It=1-St,Lt=It*It,$t=St*St,Xt=Lt*It,Sr=3*St*Lt,Lr=3*$t*It,Qr=$t*St;return Ye[0]=ut[0]*Xt+pt[0]*Sr+wt[0]*Lr+Tt[0]*Qr,Ye[1]=ut[1]*Xt+pt[1]*Sr+wt[1]*Lr+Tt[1]*Qr,Ye[2]=ut[2]*Xt+pt[2]*Sr+wt[2]*Lr+Tt[2]*Qr,Ye},is.random=function(Ye,ut){ut=ut||1;var pt=2*ns.RANDOM()*Math.PI,wt=2*ns.RANDOM()-1,Tt=Math.sqrt(1-wt*wt)*ut;return Ye[0]=Math.cos(pt)*Tt,Ye[1]=Math.sin(pt)*Tt,Ye[2]=wt*ut,Ye},is.transformMat4=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=pt[3]*wt+pt[7]*Tt+pt[11]*St+pt[15];return Ye[0]=(pt[0]*wt+pt[4]*Tt+pt[8]*St+pt[12])/(It=It||1),Ye[1]=(pt[1]*wt+pt[5]*Tt+pt[9]*St+pt[13])/It,Ye[2]=(pt[2]*wt+pt[6]*Tt+pt[10]*St+pt[14])/It,Ye},is.transformMat3=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2];return Ye[0]=wt*pt[0]+Tt*pt[3]+St*pt[6],Ye[1]=wt*pt[1]+Tt*pt[4]+St*pt[7],Ye[2]=wt*pt[2]+Tt*pt[5]+St*pt[8],Ye},is.transformQuat=function(Ye,ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=ut[0],Lt=ut[1],$t=ut[2],Xt=Tt*$t-St*Lt,Sr=St*It-wt*$t,Lr=wt*Lt-Tt*It,Qr=Tt*Lr-St*Sr,fn=St*Xt-wt*Lr,xn=wt*Sr-Tt*Xt,vn=2*pt[3];return Sr*=vn,Lr*=vn,fn*=2,xn*=2,Ye[0]=It+(Xt*=vn)+(Qr*=2),Ye[1]=Lt+Sr+fn,Ye[2]=$t+Lr+xn,Ye},is.rotateX=function(Ye,ut,pt,wt){var Tt=[],St=[];return Tt[0]=ut[0]-pt[0],Tt[1]=ut[1]-pt[1],Tt[2]=ut[2]-pt[2],St[0]=Tt[0],St[1]=Tt[1]*Math.cos(wt)-Tt[2]*Math.sin(wt),St[2]=Tt[1]*Math.sin(wt)+Tt[2]*Math.cos(wt),Ye[0]=St[0]+pt[0],Ye[1]=St[1]+pt[1],Ye[2]=St[2]+pt[2],Ye},is.rotateY=function(Ye,ut,pt,wt){var Tt=[],St=[];return Tt[0]=ut[0]-pt[0],Tt[1]=ut[1]-pt[1],Tt[2]=ut[2]-pt[2],St[0]=Tt[2]*Math.sin(wt)+Tt[0]*Math.cos(wt),St[1]=Tt[1],St[2]=Tt[2]*Math.cos(wt)-Tt[0]*Math.sin(wt),Ye[0]=St[0]+pt[0],Ye[1]=St[1]+pt[1],Ye[2]=St[2]+pt[2],Ye},is.rotateZ=function(Ye,ut,pt,wt){var Tt=[],St=[];return Tt[0]=ut[0]-pt[0],Tt[1]=ut[1]-pt[1],Tt[2]=ut[2]-pt[2],St[0]=Tt[0]*Math.cos(wt)-Tt[1]*Math.sin(wt),St[1]=Tt[0]*Math.sin(wt)+Tt[1]*Math.cos(wt),St[2]=Tt[2],Ye[0]=St[0]+pt[0],Ye[1]=St[1]+pt[1],Ye[2]=St[2]+pt[2],Ye},is.angle=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=Ye[2],St=ut[0],It=ut[1],Lt=ut[2],$t=Math.sqrt(pt*pt+wt*wt+Tt*Tt)*Math.sqrt(St*St+It*It+Lt*Lt),Xt=$t&&ot(Ye,ut)/$t;return Math.acos(Math.min(Math.max(Xt,-1),1))},is.zero=function(Ye){return Ye[0]=0,Ye[1]=0,Ye[2]=0,Ye},is.str=function(Ye){return"vec3("+Ye[0]+", "+Ye[1]+", "+Ye[2]+")"},is.exactEquals=function(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]&&Ye[2]===ut[2]},is.equals=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=Ye[2],St=ut[0],It=ut[1],Lt=ut[2];return Math.abs(pt-St)<=ns.EPSILON*Math.max(1,Math.abs(pt),Math.abs(St))&&Math.abs(wt-It)<=ns.EPSILON*Math.max(1,Math.abs(wt),Math.abs(It))&&Math.abs(Tt-Lt)<=ns.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Lt))},is.forEach=is.sqrLen=is.len=is.sqrDist=is.dist=is.div=is.mul=is.sub=void 0;var ns=function(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==K(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=J(void 0);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}(Xt);function J(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(J=function(Ye){return Ye?pt:ut})(Ye)}function Q(){var Ye=new ns.ARRAY_TYPE(3);return ns.ARRAY_TYPE!=Float32Array&&(Ye[0]=0,Ye[1]=0,Ye[2]=0),Ye}function tt(Ye){return Math.hypot(Ye[0],Ye[1],Ye[2])}function et(Ye,ut,pt){return Ye[0]=ut[0]-pt[0],Ye[1]=ut[1]-pt[1],Ye[2]=ut[2]-pt[2],Ye}function rt(Ye,ut,pt){return Ye[0]=ut[0]*pt[0],Ye[1]=ut[1]*pt[1],Ye[2]=ut[2]*pt[2],Ye}function nt(Ye,ut,pt){return Ye[0]=ut[0]/pt[0],Ye[1]=ut[1]/pt[1],Ye[2]=ut[2]/pt[2],Ye}function it(Ye,ut){return Math.hypot(ut[0]-Ye[0],ut[1]-Ye[1],ut[2]-Ye[2])}function st(Ye,ut){var pt=ut[0]-Ye[0],wt=ut[1]-Ye[1],Tt=ut[2]-Ye[2];return pt*pt+wt*wt+Tt*Tt}function at(Ye){var ut=Ye[0],pt=Ye[1],wt=Ye[2];return ut*ut+pt*pt+wt*wt}function ot(Ye,ut){return Ye[0]*ut[0]+Ye[1]*ut[1]+Ye[2]*ut[2]}is.sub=et,is.mul=rt,is.div=nt,is.dist=it,is.sqrDist=st,is.len=tt,is.sqrLen=at;var ss,as=(ss=Q(),function(Ye,ut,pt,wt,Tt,St){var It,Lt;for(ut||(ut=3),pt||(pt=0),Lt=wt?Math.min(wt*ut+pt,Ye.length):Ye.length,It=pt;It<Lt;It+=ut)ss[0]=Ye[It],ss[1]=Ye[It+1],ss[2]=Ye[It+2],Tt(ss,ss,St),Ye[It]=ss[0],Ye[It+1]=ss[1],Ye[It+2]=ss[2];return Ye});is.forEach=as;var ds={};function ht(Ye){return ht="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},ht(Ye)}Object.defineProperty(ds,"__esModule",{value:!0}),ds.create=dt,ds.clone=function(Ye){var ut=new ps.ARRAY_TYPE(4);return ut[0]=Ye[0],ut[1]=Ye[1],ut[2]=Ye[2],ut[3]=Ye[3],ut},ds.fromValues=function(Ye,ut,pt,wt){var Tt=new ps.ARRAY_TYPE(4);return Tt[0]=Ye,Tt[1]=ut,Tt[2]=pt,Tt[3]=wt,Tt},ds.copy=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[3],Ye},ds.set=function(Ye,ut,pt,wt,Tt){return Ye[0]=ut,Ye[1]=pt,Ye[2]=wt,Ye[3]=Tt,Ye},ds.add=function(Ye,ut,pt){return Ye[0]=ut[0]+pt[0],Ye[1]=ut[1]+pt[1],Ye[2]=ut[2]+pt[2],Ye[3]=ut[3]+pt[3],Ye},ds.subtract=mt,ds.multiply=yt,ds.divide=gt,ds.ceil=function(Ye,ut){return Ye[0]=Math.ceil(ut[0]),Ye[1]=Math.ceil(ut[1]),Ye[2]=Math.ceil(ut[2]),Ye[3]=Math.ceil(ut[3]),Ye},ds.floor=function(Ye,ut){return Ye[0]=Math.floor(ut[0]),Ye[1]=Math.floor(ut[1]),Ye[2]=Math.floor(ut[2]),Ye[3]=Math.floor(ut[3]),Ye},ds.min=function(Ye,ut,pt){return Ye[0]=Math.min(ut[0],pt[0]),Ye[1]=Math.min(ut[1],pt[1]),Ye[2]=Math.min(ut[2],pt[2]),Ye[3]=Math.min(ut[3],pt[3]),Ye},ds.max=function(Ye,ut,pt){return Ye[0]=Math.max(ut[0],pt[0]),Ye[1]=Math.max(ut[1],pt[1]),Ye[2]=Math.max(ut[2],pt[2]),Ye[3]=Math.max(ut[3],pt[3]),Ye},ds.round=function(Ye,ut){return Ye[0]=Math.round(ut[0]),Ye[1]=Math.round(ut[1]),Ye[2]=Math.round(ut[2]),Ye[3]=Math.round(ut[3]),Ye},ds.scale=function(Ye,ut,pt){return Ye[0]=ut[0]*pt,Ye[1]=ut[1]*pt,Ye[2]=ut[2]*pt,Ye[3]=ut[3]*pt,Ye},ds.scaleAndAdd=function(Ye,ut,pt,wt){return Ye[0]=ut[0]+pt[0]*wt,Ye[1]=ut[1]+pt[1]*wt,Ye[2]=ut[2]+pt[2]*wt,Ye[3]=ut[3]+pt[3]*wt,Ye},ds.distance=xt,ds.squaredDistance=bt,ds.length=vt,ds.squaredLength=_t,ds.negate=function(Ye,ut){return Ye[0]=-ut[0],Ye[1]=-ut[1],Ye[2]=-ut[2],Ye[3]=-ut[3],Ye},ds.inverse=function(Ye,ut){return Ye[0]=1/ut[0],Ye[1]=1/ut[1],Ye[2]=1/ut[2],Ye[3]=1/ut[3],Ye},ds.normalize=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=pt*pt+wt*wt+Tt*Tt+St*St;return It>0&&(It=1/Math.sqrt(It)),Ye[0]=pt*It,Ye[1]=wt*It,Ye[2]=Tt*It,Ye[3]=St*It,Ye},ds.dot=function(Ye,ut){return Ye[0]*ut[0]+Ye[1]*ut[1]+Ye[2]*ut[2]+Ye[3]*ut[3]},ds.cross=function(Ye,ut,pt,wt){var Tt=pt[0]*wt[1]-pt[1]*wt[0],St=pt[0]*wt[2]-pt[2]*wt[0],It=pt[0]*wt[3]-pt[3]*wt[0],Lt=pt[1]*wt[2]-pt[2]*wt[1],$t=pt[1]*wt[3]-pt[3]*wt[1],Xt=pt[2]*wt[3]-pt[3]*wt[2],Sr=ut[0],Lr=ut[1],Qr=ut[2],fn=ut[3];return Ye[0]=Lr*Xt-Qr*$t+fn*Lt,Ye[1]=-Sr*Xt+Qr*It-fn*St,Ye[2]=Sr*$t-Lr*It+fn*Tt,Ye[3]=-Sr*Lt+Lr*St-Qr*Tt,Ye},ds.lerp=function(Ye,ut,pt,wt){var Tt=ut[0],St=ut[1],It=ut[2],Lt=ut[3];return Ye[0]=Tt+wt*(pt[0]-Tt),Ye[1]=St+wt*(pt[1]-St),Ye[2]=It+wt*(pt[2]-It),Ye[3]=Lt+wt*(pt[3]-Lt),Ye},ds.random=function(Ye,ut){var pt,wt,Tt,St,It,Lt;ut=ut||1;do{It=(pt=2*ps.RANDOM()-1)*pt+(wt=2*ps.RANDOM()-1)*wt}while(It>=1);do{Lt=(Tt=2*ps.RANDOM()-1)*Tt+(St=2*ps.RANDOM()-1)*St}while(Lt>=1);var $t=Math.sqrt((1-It)/Lt);return Ye[0]=ut*pt,Ye[1]=ut*wt,Ye[2]=ut*Tt*$t,Ye[3]=ut*St*$t,Ye},ds.transformMat4=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3];return Ye[0]=pt[0]*wt+pt[4]*Tt+pt[8]*St+pt[12]*It,Ye[1]=pt[1]*wt+pt[5]*Tt+pt[9]*St+pt[13]*It,Ye[2]=pt[2]*wt+pt[6]*Tt+pt[10]*St+pt[14]*It,Ye[3]=pt[3]*wt+pt[7]*Tt+pt[11]*St+pt[15]*It,Ye},ds.transformQuat=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=pt[0],Lt=pt[1],$t=pt[2],Xt=pt[3],Sr=Xt*wt+Lt*St-$t*Tt,Lr=Xt*Tt+$t*wt-It*St,Qr=Xt*St+It*Tt-Lt*wt,fn=-It*wt-Lt*Tt-$t*St;return Ye[0]=Sr*Xt+fn*-It+Lr*-$t-Qr*-Lt,Ye[1]=Lr*Xt+fn*-Lt+Qr*-It-Sr*-$t,Ye[2]=Qr*Xt+fn*-$t+Sr*-Lt-Lr*-It,Ye[3]=ut[3],Ye},ds.zero=function(Ye){return Ye[0]=0,Ye[1]=0,Ye[2]=0,Ye[3]=0,Ye},ds.str=function(Ye){return"vec4("+Ye[0]+", "+Ye[1]+", "+Ye[2]+", "+Ye[3]+")"},ds.exactEquals=function(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]&&Ye[2]===ut[2]&&Ye[3]===ut[3]},ds.equals=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=Ye[2],St=Ye[3],It=ut[0],Lt=ut[1],$t=ut[2],Xt=ut[3];return Math.abs(pt-It)<=ps.EPSILON*Math.max(1,Math.abs(pt),Math.abs(It))&&Math.abs(wt-Lt)<=ps.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Lt))&&Math.abs(Tt-$t)<=ps.EPSILON*Math.max(1,Math.abs(Tt),Math.abs($t))&&Math.abs(St-Xt)<=ps.EPSILON*Math.max(1,Math.abs(St),Math.abs(Xt))},ds.forEach=ds.sqrLen=ds.len=ds.sqrDist=ds.dist=ds.div=ds.mul=ds.sub=void 0;var ps=function(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==ht(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=ft(void 0);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}(Xt);function ft(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(ft=function(Ye){return Ye?pt:ut})(Ye)}function dt(){var Ye=new ps.ARRAY_TYPE(4);return ps.ARRAY_TYPE!=Float32Array&&(Ye[0]=0,Ye[1]=0,Ye[2]=0,Ye[3]=0),Ye}function mt(Ye,ut,pt){return Ye[0]=ut[0]-pt[0],Ye[1]=ut[1]-pt[1],Ye[2]=ut[2]-pt[2],Ye[3]=ut[3]-pt[3],Ye}function yt(Ye,ut,pt){return Ye[0]=ut[0]*pt[0],Ye[1]=ut[1]*pt[1],Ye[2]=ut[2]*pt[2],Ye[3]=ut[3]*pt[3],Ye}function gt(Ye,ut,pt){return Ye[0]=ut[0]/pt[0],Ye[1]=ut[1]/pt[1],Ye[2]=ut[2]/pt[2],Ye[3]=ut[3]/pt[3],Ye}function xt(Ye,ut){return Math.hypot(ut[0]-Ye[0],ut[1]-Ye[1],ut[2]-Ye[2],ut[3]-Ye[3])}function bt(Ye,ut){var pt=ut[0]-Ye[0],wt=ut[1]-Ye[1],Tt=ut[2]-Ye[2],St=ut[3]-Ye[3];return pt*pt+wt*wt+Tt*Tt+St*St}function vt(Ye){return Math.hypot(Ye[0],Ye[1],Ye[2],Ye[3])}function _t(Ye){var ut=Ye[0],pt=Ye[1],wt=Ye[2],Tt=Ye[3];return ut*ut+pt*pt+wt*wt+Tt*Tt}ds.sub=mt,ds.mul=yt,ds.div=gt,ds.dist=xt,ds.sqrDist=bt,ds.len=vt,ds.sqrLen=_t;var ms=function(){var Ye=dt();return function(ut,pt,wt,Tt,St,It){var Lt,$t;for(pt||(pt=4),wt||(wt=0),$t=Tt?Math.min(Tt*pt+wt,ut.length):ut.length,Lt=wt;Lt<$t;Lt+=pt)Ye[0]=ut[Lt],Ye[1]=ut[Lt+1],Ye[2]=ut[Lt+2],Ye[3]=ut[Lt+3],St(Ye,Ye,It),ut[Lt]=Ye[0],ut[Lt+1]=Ye[1],ut[Lt+2]=Ye[2],ut[Lt+3]=Ye[3];return ut}}();function Mt(Ye){return Mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},Mt(Ye)}ds.forEach=ms,Object.defineProperty(Fo,"__esModule",{value:!0}),Fo.create=zt,Fo.identity=function(Ye){return Ye[0]=0,Ye[1]=0,Ye[2]=0,Ye[3]=1,Ye},Fo.setAxisAngle=Et,Fo.getAxisAngle=function(Ye,ut){var pt=2*Math.acos(ut[3]),wt=Math.sin(pt/2);return wt>Js.EPSILON?(Ye[0]=ut[0]/wt,Ye[1]=ut[1]/wt,Ye[2]=ut[2]/wt):(Ye[0]=1,Ye[1]=0,Ye[2]=0),pt},Fo.getAngle=function(Ye,ut){var pt=ll(Ye,ut);return Math.acos(2*pt*pt-1)},Fo.multiply=Bt,Fo.rotateX=function(Ye,ut,pt){pt*=.5;var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=Math.sin(pt),$t=Math.cos(pt);return Ye[0]=wt*$t+It*Lt,Ye[1]=Tt*$t+St*Lt,Ye[2]=St*$t-Tt*Lt,Ye[3]=It*$t-wt*Lt,Ye},Fo.rotateY=function(Ye,ut,pt){pt*=.5;var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=Math.sin(pt),$t=Math.cos(pt);return Ye[0]=wt*$t-St*Lt,Ye[1]=Tt*$t+It*Lt,Ye[2]=St*$t+wt*Lt,Ye[3]=It*$t-Tt*Lt,Ye},Fo.rotateZ=function(Ye,ut,pt){pt*=.5;var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=Math.sin(pt),$t=Math.cos(pt);return Ye[0]=wt*$t+Tt*Lt,Ye[1]=Tt*$t-wt*Lt,Ye[2]=St*$t+It*Lt,Ye[3]=It*$t-St*Lt,Ye},Fo.calculateW=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2];return Ye[0]=pt,Ye[1]=wt,Ye[2]=Tt,Ye[3]=Math.sqrt(Math.abs(1-pt*pt-wt*wt-Tt*Tt)),Ye},Fo.exp=Dt,Fo.ln=Ct,Fo.pow=function(Ye,ut,pt){return Ct(Ye,ut),La(Ye,Ye,pt),Dt(Ye,Ye),Ye},Fo.slerp=Rt,Fo.random=function(Ye){var ut=Js.RANDOM(),pt=Js.RANDOM(),wt=Js.RANDOM(),Tt=Math.sqrt(1-ut),St=Math.sqrt(ut);return Ye[0]=Tt*Math.sin(2*Math.PI*pt),Ye[1]=Tt*Math.cos(2*Math.PI*pt),Ye[2]=St*Math.sin(2*Math.PI*wt),Ye[3]=St*Math.cos(2*Math.PI*wt),Ye},Fo.invert=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=pt*pt+wt*wt+Tt*Tt+St*St,Lt=It?1/It:0;return Ye[0]=-pt*Lt,Ye[1]=-wt*Lt,Ye[2]=-Tt*Lt,Ye[3]=St*Lt,Ye},Fo.conjugate=function(Ye,ut){return Ye[0]=-ut[0],Ye[1]=-ut[1],Ye[2]=-ut[2],Ye[3]=ut[3],Ye},Fo.fromMat3=Vt,Fo.fromEuler=function(Ye,ut,pt,wt){var Tt=.5*Math.PI/180;ut*=Tt,pt*=Tt,wt*=Tt;var St=Math.sin(ut),It=Math.cos(ut),Lt=Math.sin(pt),$t=Math.cos(pt),Xt=Math.sin(wt),Sr=Math.cos(wt);return Ye[0]=St*$t*Sr-It*Lt*Xt,Ye[1]=It*Lt*Sr+St*$t*Xt,Ye[2]=It*$t*Xt-St*Lt*Sr,Ye[3]=It*$t*Sr+St*Lt*Xt,Ye},Fo.str=function(Ye){return"quat("+Ye[0]+", "+Ye[1]+", "+Ye[2]+", "+Ye[3]+")"},Fo.setAxes=Fo.sqlerp=Fo.rotationTo=Fo.equals=Fo.exactEquals=Fo.normalize=Fo.sqrLen=Fo.squaredLength=Fo.len=Fo.length=Fo.lerp=Fo.dot=Fo.scale=Fo.mul=Fo.add=Fo.set=Fo.copy=Fo.fromValues=Fo.clone=void 0;var Js=Pt(Xt),ua=Pt(Xn),ba=Pt(is),Ra=Pt(ds);function kt(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(kt=function(Ye){return Ye?pt:ut})(Ye)}function Pt(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==Mt(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=kt(ut);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}function zt(){var Ye=new Js.ARRAY_TYPE(4);return Js.ARRAY_TYPE!=Float32Array&&(Ye[0]=0,Ye[1]=0,Ye[2]=0),Ye[3]=1,Ye}function Et(Ye,ut,pt){pt*=.5;var wt=Math.sin(pt);return Ye[0]=wt*ut[0],Ye[1]=wt*ut[1],Ye[2]=wt*ut[2],Ye[3]=Math.cos(pt),Ye}function Bt(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=pt[0],$t=pt[1],Xt=pt[2],Sr=pt[3];return Ye[0]=wt*Sr+It*Lt+Tt*Xt-St*$t,Ye[1]=Tt*Sr+It*$t+St*Lt-wt*Xt,Ye[2]=St*Sr+It*Xt+wt*$t-Tt*Lt,Ye[3]=It*Sr-wt*Lt-Tt*$t-St*Xt,Ye}function Dt(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=Math.sqrt(pt*pt+wt*wt+Tt*Tt),Lt=Math.exp(St),$t=It>0?Lt*Math.sin(It)/It:0;return Ye[0]=pt*$t,Ye[1]=wt*$t,Ye[2]=Tt*$t,Ye[3]=Lt*Math.cos(It),Ye}function Ct(Ye,ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=Math.sqrt(pt*pt+wt*wt+Tt*Tt),Lt=It>0?Math.atan2(It,St)/It:0;return Ye[0]=pt*Lt,Ye[1]=wt*Lt,Ye[2]=Tt*Lt,Ye[3]=.5*Math.log(pt*pt+wt*wt+Tt*Tt+St*St),Ye}function Rt(Ye,ut,pt,wt){var Tt,St,It,Lt,$t,Xt=ut[0],Sr=ut[1],Lr=ut[2],Qr=ut[3],fn=pt[0],xn=pt[1],vn=pt[2],kn=pt[3];return(St=Xt*fn+Sr*xn+Lr*vn+Qr*kn)<0&&(St=-St,fn=-fn,xn=-xn,vn=-vn,kn=-kn),1-St>Js.EPSILON?(Tt=Math.acos(St),It=Math.sin(Tt),Lt=Math.sin((1-wt)*Tt)/It,$t=Math.sin(wt*Tt)/It):(Lt=1-wt,$t=wt),Ye[0]=Lt*Xt+$t*fn,Ye[1]=Lt*Sr+$t*xn,Ye[2]=Lt*Lr+$t*vn,Ye[3]=Lt*Qr+$t*kn,Ye}function Vt(Ye,ut){var pt,wt=ut[0]+ut[4]+ut[8];if(wt>0)pt=Math.sqrt(wt+1),Ye[3]=.5*pt,Ye[0]=(ut[5]-ut[7])*(pt=.5/pt),Ye[1]=(ut[6]-ut[2])*pt,Ye[2]=(ut[1]-ut[3])*pt;else{var Tt=0;ut[4]>ut[0]&&(Tt=1),ut[8]>ut[3*Tt+Tt]&&(Tt=2);var St=(Tt+1)%3,It=(Tt+2)%3;pt=Math.sqrt(ut[3*Tt+Tt]-ut[3*St+St]-ut[3*It+It]+1),Ye[Tt]=.5*pt,Ye[3]=(ut[3*St+It]-ut[3*It+St])*(pt=.5/pt),Ye[St]=(ut[3*St+Tt]+ut[3*Tt+St])*pt,Ye[It]=(ut[3*It+Tt]+ut[3*Tt+It])*pt}return Ye}Fo.clone=Ra.clone,Fo.fromValues=Ra.fromValues,Fo.copy=Ra.copy,Fo.set=Ra.set,Fo.add=Ra.add,Fo.mul=Bt;var La=Ra.scale;Fo.scale=La;var ll=Ra.dot;Fo.dot=ll,Fo.lerp=Ra.lerp;var yl=Ra.length;Fo.length=yl,Fo.len=yl;var Tl=Ra.squaredLength;Fo.squaredLength=Tl,Fo.sqrLen=Tl;var Al=Ra.normalize;Fo.normalize=Al,Fo.exactEquals=Ra.exactEquals,Fo.equals=Ra.equals;var Il,Pl,ec,tc=(Il=ba.create(),Pl=ba.fromValues(1,0,0),ec=ba.fromValues(0,1,0),function(Ye,ut,pt){var wt=ba.dot(ut,pt);return wt<-.999999?(ba.cross(Il,Pl,ut),ba.len(Il)<1e-6&&ba.cross(Il,ec,ut),ba.normalize(Il,Il),Et(Ye,Il,Math.PI),Ye):wt>.999999?(Ye[0]=0,Ye[1]=0,Ye[2]=0,Ye[3]=1,Ye):(ba.cross(Il,ut,pt),Ye[0]=Il[0],Ye[1]=Il[1],Ye[2]=Il[2],Ye[3]=1+wt,Al(Ye,Ye))});Fo.rotationTo=tc;var ic,nc,oc=(ic=zt(),nc=zt(),function(Ye,ut,pt,wt,Tt,St){return Rt(ic,ut,Tt,St),Rt(nc,pt,wt,St),Rt(Ye,ic,nc,2*St*(1-St)),Ye});Fo.sqlerp=oc;var sc,ac=(sc=ua.create(),function(Ye,ut,pt,wt){return sc[0]=pt[0],sc[3]=pt[1],sc[6]=pt[2],sc[1]=wt[0],sc[4]=wt[1],sc[7]=wt[2],sc[2]=-ut[0],sc[5]=-ut[1],sc[8]=-ut[2],Al(Ye,Vt(Ye,sc))});Fo.setAxes=ac;var lc={};function Jt(Ye){return Jt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},Jt(Ye)}Object.defineProperty(lc,"__esModule",{value:!0}),lc.create=function(){var Ye=new cc.ARRAY_TYPE(8);return cc.ARRAY_TYPE!=Float32Array&&(Ye[0]=0,Ye[1]=0,Ye[2]=0,Ye[4]=0,Ye[5]=0,Ye[6]=0,Ye[7]=0),Ye[3]=1,Ye},lc.clone=function(Ye){var ut=new cc.ARRAY_TYPE(8);return ut[0]=Ye[0],ut[1]=Ye[1],ut[2]=Ye[2],ut[3]=Ye[3],ut[4]=Ye[4],ut[5]=Ye[5],ut[6]=Ye[6],ut[7]=Ye[7],ut},lc.fromValues=function(Ye,ut,pt,wt,Tt,St,It,Lt){var $t=new cc.ARRAY_TYPE(8);return $t[0]=Ye,$t[1]=ut,$t[2]=pt,$t[3]=wt,$t[4]=Tt,$t[5]=St,$t[6]=It,$t[7]=Lt,$t},lc.fromRotationTranslationValues=function(Ye,ut,pt,wt,Tt,St,It){var Lt=new cc.ARRAY_TYPE(8);Lt[0]=Ye,Lt[1]=ut,Lt[2]=pt,Lt[3]=wt;var $t=.5*Tt,Xt=.5*St,Sr=.5*It;return Lt[4]=$t*wt+Xt*pt-Sr*ut,Lt[5]=Xt*wt+Sr*Ye-$t*pt,Lt[6]=Sr*wt+$t*ut-Xt*Ye,Lt[7]=-$t*Ye-Xt*ut-Sr*pt,Lt},lc.fromRotationTranslation=ie,lc.fromTranslation=function(Ye,ut){return Ye[0]=0,Ye[1]=0,Ye[2]=0,Ye[3]=1,Ye[4]=.5*ut[0],Ye[5]=.5*ut[1],Ye[6]=.5*ut[2],Ye[7]=0,Ye},lc.fromRotation=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[3],Ye[4]=0,Ye[5]=0,Ye[6]=0,Ye[7]=0,Ye},lc.fromMat4=function(Ye,ut){var pt=uc.create();dc.getRotation(pt,ut);var wt=new cc.ARRAY_TYPE(3);return dc.getTranslation(wt,ut),ie(Ye,pt,wt),Ye},lc.copy=se,lc.identity=function(Ye){return Ye[0]=0,Ye[1]=0,Ye[2]=0,Ye[3]=1,Ye[4]=0,Ye[5]=0,Ye[6]=0,Ye[7]=0,Ye},lc.set=function(Ye,ut,pt,wt,Tt,St,It,Lt,$t){return Ye[0]=ut,Ye[1]=pt,Ye[2]=wt,Ye[3]=Tt,Ye[4]=St,Ye[5]=It,Ye[6]=Lt,Ye[7]=$t,Ye},lc.getDual=function(Ye,ut){return Ye[0]=ut[4],Ye[1]=ut[5],Ye[2]=ut[6],Ye[3]=ut[7],Ye},lc.setDual=function(Ye,ut){return Ye[4]=ut[0],Ye[5]=ut[1],Ye[6]=ut[2],Ye[7]=ut[3],Ye},lc.getTranslation=function(Ye,ut){var pt=ut[4],wt=ut[5],Tt=ut[6],St=ut[7],It=-ut[0],Lt=-ut[1],$t=-ut[2],Xt=ut[3];return Ye[0]=2*(pt*Xt+St*It+wt*$t-Tt*Lt),Ye[1]=2*(wt*Xt+St*Lt+Tt*It-pt*$t),Ye[2]=2*(Tt*Xt+St*$t+pt*Lt-wt*It),Ye},lc.translate=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=.5*pt[0],$t=.5*pt[1],Xt=.5*pt[2],Sr=ut[4],Lr=ut[5],Qr=ut[6],fn=ut[7];return Ye[0]=wt,Ye[1]=Tt,Ye[2]=St,Ye[3]=It,Ye[4]=It*Lt+Tt*Xt-St*$t+Sr,Ye[5]=It*$t+St*Lt-wt*Xt+Lr,Ye[6]=It*Xt+wt*$t-Tt*Lt+Qr,Ye[7]=-wt*Lt-Tt*$t-St*Xt+fn,Ye},lc.rotateX=function(Ye,ut,pt){var wt=-ut[0],Tt=-ut[1],St=-ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=Lt*It+Sr*wt+$t*St-Xt*Tt,Qr=$t*It+Sr*Tt+Xt*wt-Lt*St,fn=Xt*It+Sr*St+Lt*Tt-$t*wt,xn=Sr*It-Lt*wt-$t*Tt-Xt*St;return uc.rotateX(Ye,ut,pt),Ye[4]=Lr*(It=Ye[3])+xn*(wt=Ye[0])+Qr*(St=Ye[2])-fn*(Tt=Ye[1]),Ye[5]=Qr*It+xn*Tt+fn*wt-Lr*St,Ye[6]=fn*It+xn*St+Lr*Tt-Qr*wt,Ye[7]=xn*It-Lr*wt-Qr*Tt-fn*St,Ye},lc.rotateY=function(Ye,ut,pt){var wt=-ut[0],Tt=-ut[1],St=-ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=Lt*It+Sr*wt+$t*St-Xt*Tt,Qr=$t*It+Sr*Tt+Xt*wt-Lt*St,fn=Xt*It+Sr*St+Lt*Tt-$t*wt,xn=Sr*It-Lt*wt-$t*Tt-Xt*St;return uc.rotateY(Ye,ut,pt),Ye[4]=Lr*(It=Ye[3])+xn*(wt=Ye[0])+Qr*(St=Ye[2])-fn*(Tt=Ye[1]),Ye[5]=Qr*It+xn*Tt+fn*wt-Lr*St,Ye[6]=fn*It+xn*St+Lr*Tt-Qr*wt,Ye[7]=xn*It-Lr*wt-Qr*Tt-fn*St,Ye},lc.rotateZ=function(Ye,ut,pt){var wt=-ut[0],Tt=-ut[1],St=-ut[2],It=ut[3],Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=Lt*It+Sr*wt+$t*St-Xt*Tt,Qr=$t*It+Sr*Tt+Xt*wt-Lt*St,fn=Xt*It+Sr*St+Lt*Tt-$t*wt,xn=Sr*It-Lt*wt-$t*Tt-Xt*St;return uc.rotateZ(Ye,ut,pt),Ye[4]=Lr*(It=Ye[3])+xn*(wt=Ye[0])+Qr*(St=Ye[2])-fn*(Tt=Ye[1]),Ye[5]=Qr*It+xn*Tt+fn*wt-Lr*St,Ye[6]=fn*It+xn*St+Lr*Tt-Qr*wt,Ye[7]=xn*It-Lr*wt-Qr*Tt-fn*St,Ye},lc.rotateByQuatAppend=function(Ye,ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=ut[0],$t=ut[1],Xt=ut[2],Sr=ut[3];return Ye[0]=Lt*It+Sr*wt+$t*St-Xt*Tt,Ye[1]=$t*It+Sr*Tt+Xt*wt-Lt*St,Ye[2]=Xt*It+Sr*St+Lt*Tt-$t*wt,Ye[3]=Sr*It-Lt*wt-$t*Tt-Xt*St,Ye[4]=(Lt=ut[4])*It+(Sr=ut[7])*wt+($t=ut[5])*St-(Xt=ut[6])*Tt,Ye[5]=$t*It+Sr*Tt+Xt*wt-Lt*St,Ye[6]=Xt*It+Sr*St+Lt*Tt-$t*wt,Ye[7]=Sr*It-Lt*wt-$t*Tt-Xt*St,Ye},lc.rotateByQuatPrepend=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=pt[0],$t=pt[1],Xt=pt[2],Sr=pt[3];return Ye[0]=wt*Sr+It*Lt+Tt*Xt-St*$t,Ye[1]=Tt*Sr+It*$t+St*Lt-wt*Xt,Ye[2]=St*Sr+It*Xt+wt*$t-Tt*Lt,Ye[3]=It*Sr-wt*Lt-Tt*$t-St*Xt,Ye[4]=wt*(Sr=pt[7])+It*(Lt=pt[4])+Tt*(Xt=pt[6])-St*($t=pt[5]),Ye[5]=Tt*Sr+It*$t+St*Lt-wt*Xt,Ye[6]=St*Sr+It*Xt+wt*$t-Tt*Lt,Ye[7]=It*Sr-wt*Lt-Tt*$t-St*Xt,Ye},lc.rotateAroundAxis=function(Ye,ut,pt,wt){if(Math.abs(wt)<cc.EPSILON)return se(Ye,ut);var Tt=Math.hypot(pt[0],pt[1],pt[2]);wt*=.5;var St=Math.sin(wt),It=St*pt[0]/Tt,Lt=St*pt[1]/Tt,$t=St*pt[2]/Tt,Xt=Math.cos(wt),Sr=ut[0],Lr=ut[1],Qr=ut[2],fn=ut[3];Ye[0]=Sr*Xt+fn*It+Lr*$t-Qr*Lt,Ye[1]=Lr*Xt+fn*Lt+Qr*It-Sr*$t,Ye[2]=Qr*Xt+fn*$t+Sr*Lt-Lr*It,Ye[3]=fn*Xt-Sr*It-Lr*Lt-Qr*$t;var xn=ut[4],vn=ut[5],kn=ut[6],Wn=ut[7];return Ye[4]=xn*Xt+Wn*It+vn*$t-kn*Lt,Ye[5]=vn*Xt+Wn*Lt+kn*It-xn*$t,Ye[6]=kn*Xt+Wn*$t+xn*Lt-vn*It,Ye[7]=Wn*Xt-xn*It-vn*Lt-kn*$t,Ye},lc.add=function(Ye,ut,pt){return Ye[0]=ut[0]+pt[0],Ye[1]=ut[1]+pt[1],Ye[2]=ut[2]+pt[2],Ye[3]=ut[3]+pt[3],Ye[4]=ut[4]+pt[4],Ye[5]=ut[5]+pt[5],Ye[6]=ut[6]+pt[6],Ye[7]=ut[7]+pt[7],Ye},lc.multiply=ae,lc.scale=function(Ye,ut,pt){return Ye[0]=ut[0]*pt,Ye[1]=ut[1]*pt,Ye[2]=ut[2]*pt,Ye[3]=ut[3]*pt,Ye[4]=ut[4]*pt,Ye[5]=ut[5]*pt,Ye[6]=ut[6]*pt,Ye[7]=ut[7]*pt,Ye},lc.lerp=function(Ye,ut,pt,wt){var Tt=1-wt;return fc(ut,pt)<0&&(wt=-wt),Ye[0]=ut[0]*Tt+pt[0]*wt,Ye[1]=ut[1]*Tt+pt[1]*wt,Ye[2]=ut[2]*Tt+pt[2]*wt,Ye[3]=ut[3]*Tt+pt[3]*wt,Ye[4]=ut[4]*Tt+pt[4]*wt,Ye[5]=ut[5]*Tt+pt[5]*wt,Ye[6]=ut[6]*Tt+pt[6]*wt,Ye[7]=ut[7]*Tt+pt[7]*wt,Ye},lc.invert=function(Ye,ut){var pt=xc(ut);return Ye[0]=-ut[0]/pt,Ye[1]=-ut[1]/pt,Ye[2]=-ut[2]/pt,Ye[3]=ut[3]/pt,Ye[4]=-ut[4]/pt,Ye[5]=-ut[5]/pt,Ye[6]=-ut[6]/pt,Ye[7]=ut[7]/pt,Ye},lc.conjugate=function(Ye,ut){return Ye[0]=-ut[0],Ye[1]=-ut[1],Ye[2]=-ut[2],Ye[3]=ut[3],Ye[4]=-ut[4],Ye[5]=-ut[5],Ye[6]=-ut[6],Ye[7]=ut[7],Ye},lc.normalize=function(Ye,ut){var pt=xc(ut);if(pt>0){pt=Math.sqrt(pt);var wt=ut[0]/pt,Tt=ut[1]/pt,St=ut[2]/pt,It=ut[3]/pt,Lt=ut[4],$t=ut[5],Xt=ut[6],Sr=ut[7],Lr=wt*Lt+Tt*$t+St*Xt+It*Sr;Ye[0]=wt,Ye[1]=Tt,Ye[2]=St,Ye[3]=It,Ye[4]=(Lt-wt*Lr)/pt,Ye[5]=($t-Tt*Lr)/pt,Ye[6]=(Xt-St*Lr)/pt,Ye[7]=(Sr-It*Lr)/pt}return Ye},lc.str=function(Ye){return"quat2("+Ye[0]+", "+Ye[1]+", "+Ye[2]+", "+Ye[3]+", "+Ye[4]+", "+Ye[5]+", "+Ye[6]+", "+Ye[7]+")"},lc.exactEquals=function(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]&&Ye[2]===ut[2]&&Ye[3]===ut[3]&&Ye[4]===ut[4]&&Ye[5]===ut[5]&&Ye[6]===ut[6]&&Ye[7]===ut[7]},lc.equals=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=Ye[2],St=Ye[3],It=Ye[4],Lt=Ye[5],$t=Ye[6],Xt=Ye[7],Sr=ut[0],Lr=ut[1],Qr=ut[2],fn=ut[3],xn=ut[4],vn=ut[5],kn=ut[6],Wn=ut[7];return Math.abs(pt-Sr)<=cc.EPSILON*Math.max(1,Math.abs(pt),Math.abs(Sr))&&Math.abs(wt-Lr)<=cc.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Lr))&&Math.abs(Tt-Qr)<=cc.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Qr))&&Math.abs(St-fn)<=cc.EPSILON*Math.max(1,Math.abs(St),Math.abs(fn))&&Math.abs(It-xn)<=cc.EPSILON*Math.max(1,Math.abs(It),Math.abs(xn))&&Math.abs(Lt-vn)<=cc.EPSILON*Math.max(1,Math.abs(Lt),Math.abs(vn))&&Math.abs($t-kn)<=cc.EPSILON*Math.max(1,Math.abs($t),Math.abs(kn))&&Math.abs(Xt-Wn)<=cc.EPSILON*Math.max(1,Math.abs(Xt),Math.abs(Wn))},lc.sqrLen=lc.squaredLength=lc.len=lc.length=lc.dot=lc.mul=lc.setReal=lc.getReal=void 0;var cc=ne(Xt),uc=ne(Fo),dc=ne(Qn);function re(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(re=function(Ye){return Ye?pt:ut})(Ye)}function ne(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==Jt(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=re(ut);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}function ie(Ye,ut,pt){var wt=.5*pt[0],Tt=.5*pt[1],St=.5*pt[2],It=ut[0],Lt=ut[1],$t=ut[2],Xt=ut[3];return Ye[0]=It,Ye[1]=Lt,Ye[2]=$t,Ye[3]=Xt,Ye[4]=wt*Xt+Tt*$t-St*Lt,Ye[5]=Tt*Xt+St*It-wt*$t,Ye[6]=St*Xt+wt*Lt-Tt*It,Ye[7]=-wt*It-Tt*Lt-St*$t,Ye}function se(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye[2]=ut[2],Ye[3]=ut[3],Ye[4]=ut[4],Ye[5]=ut[5],Ye[6]=ut[6],Ye[7]=ut[7],Ye}function ae(Ye,ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=pt[4],$t=pt[5],Xt=pt[6],Sr=pt[7],Lr=ut[4],Qr=ut[5],fn=ut[6],xn=ut[7],vn=pt[0],kn=pt[1],Wn=pt[2],Xn=pt[3];return Ye[0]=wt*Xn+It*vn+Tt*Wn-St*kn,Ye[1]=Tt*Xn+It*kn+St*vn-wt*Wn,Ye[2]=St*Xn+It*Wn+wt*kn-Tt*vn,Ye[3]=It*Xn-wt*vn-Tt*kn-St*Wn,Ye[4]=wt*Sr+It*Lt+Tt*Xt-St*$t+Lr*Xn+xn*vn+Qr*Wn-fn*kn,Ye[5]=Tt*Sr+It*$t+St*Lt-wt*Xt+Qr*Xn+xn*kn+fn*vn-Lr*Wn,Ye[6]=St*Sr+It*Xt+wt*$t-Tt*Lt+fn*Xn+xn*Wn+Lr*kn-Qr*vn,Ye[7]=It*Sr-wt*Lt-Tt*$t-St*Xt+xn*Xn-Lr*vn-Qr*kn-fn*Wn,Ye}lc.getReal=uc.copy,lc.setReal=uc.copy,lc.mul=ae;var fc=uc.dot;lc.dot=fc;var gc=uc.length;lc.length=gc,lc.len=gc;var xc=uc.squaredLength;lc.squaredLength=xc,lc.sqrLen=xc;var Mc={};function he(Ye){return he="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},he(Ye)}Object.defineProperty(Mc,"__esModule",{value:!0}),Mc.create=de,Mc.clone=function(Ye){var ut=new Ac.ARRAY_TYPE(2);return ut[0]=Ye[0],ut[1]=Ye[1],ut},Mc.fromValues=function(Ye,ut){var pt=new Ac.ARRAY_TYPE(2);return pt[0]=Ye,pt[1]=ut,pt},Mc.copy=function(Ye,ut){return Ye[0]=ut[0],Ye[1]=ut[1],Ye},Mc.set=function(Ye,ut,pt){return Ye[0]=ut,Ye[1]=pt,Ye},Mc.add=function(Ye,ut,pt){return Ye[0]=ut[0]+pt[0],Ye[1]=ut[1]+pt[1],Ye},Mc.subtract=me,Mc.multiply=ye,Mc.divide=ge,Mc.ceil=function(Ye,ut){return Ye[0]=Math.ceil(ut[0]),Ye[1]=Math.ceil(ut[1]),Ye},Mc.floor=function(Ye,ut){return Ye[0]=Math.floor(ut[0]),Ye[1]=Math.floor(ut[1]),Ye},Mc.min=function(Ye,ut,pt){return Ye[0]=Math.min(ut[0],pt[0]),Ye[1]=Math.min(ut[1],pt[1]),Ye},Mc.max=function(Ye,ut,pt){return Ye[0]=Math.max(ut[0],pt[0]),Ye[1]=Math.max(ut[1],pt[1]),Ye},Mc.round=function(Ye,ut){return Ye[0]=Math.round(ut[0]),Ye[1]=Math.round(ut[1]),Ye},Mc.scale=function(Ye,ut,pt){return Ye[0]=ut[0]*pt,Ye[1]=ut[1]*pt,Ye},Mc.scaleAndAdd=function(Ye,ut,pt,wt){return Ye[0]=ut[0]+pt[0]*wt,Ye[1]=ut[1]+pt[1]*wt,Ye},Mc.distance=xe,Mc.squaredDistance=be,Mc.length=ve,Mc.squaredLength=_e,Mc.negate=function(Ye,ut){return Ye[0]=-ut[0],Ye[1]=-ut[1],Ye},Mc.inverse=function(Ye,ut){return Ye[0]=1/ut[0],Ye[1]=1/ut[1],Ye},Mc.normalize=function(Ye,ut){var pt=ut[0],wt=ut[1],Tt=pt*pt+wt*wt;return Tt>0&&(Tt=1/Math.sqrt(Tt)),Ye[0]=ut[0]*Tt,Ye[1]=ut[1]*Tt,Ye},Mc.dot=function(Ye,ut){return Ye[0]*ut[0]+Ye[1]*ut[1]},Mc.cross=function(Ye,ut,pt){var wt=ut[0]*pt[1]-ut[1]*pt[0];return Ye[0]=Ye[1]=0,Ye[2]=wt,Ye},Mc.lerp=function(Ye,ut,pt,wt){var Tt=ut[0],St=ut[1];return Ye[0]=Tt+wt*(pt[0]-Tt),Ye[1]=St+wt*(pt[1]-St),Ye},Mc.random=function(Ye,ut){ut=ut||1;var pt=2*Ac.RANDOM()*Math.PI;return Ye[0]=Math.cos(pt)*ut,Ye[1]=Math.sin(pt)*ut,Ye},Mc.transformMat2=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1];return Ye[0]=pt[0]*wt+pt[2]*Tt,Ye[1]=pt[1]*wt+pt[3]*Tt,Ye},Mc.transformMat2d=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1];return Ye[0]=pt[0]*wt+pt[2]*Tt+pt[4],Ye[1]=pt[1]*wt+pt[3]*Tt+pt[5],Ye},Mc.transformMat3=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1];return Ye[0]=pt[0]*wt+pt[3]*Tt+pt[6],Ye[1]=pt[1]*wt+pt[4]*Tt+pt[7],Ye},Mc.transformMat4=function(Ye,ut,pt){var wt=ut[0],Tt=ut[1];return Ye[0]=pt[0]*wt+pt[4]*Tt+pt[12],Ye[1]=pt[1]*wt+pt[5]*Tt+pt[13],Ye},Mc.rotate=function(Ye,ut,pt,wt){var Tt=ut[0]-pt[0],St=ut[1]-pt[1],It=Math.sin(wt),Lt=Math.cos(wt);return Ye[0]=Tt*Lt-St*It+pt[0],Ye[1]=Tt*It+St*Lt+pt[1],Ye},Mc.angle=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=ut[0],St=ut[1],It=Math.sqrt(pt*pt+wt*wt)*Math.sqrt(Tt*Tt+St*St);return Math.acos(Math.min(Math.max(It&&(pt*Tt+wt*St)/It,-1),1))},Mc.zero=function(Ye){return Ye[0]=0,Ye[1]=0,Ye},Mc.str=function(Ye){return"vec2("+Ye[0]+", "+Ye[1]+")"},Mc.exactEquals=function(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]},Mc.equals=function(Ye,ut){var pt=Ye[0],wt=Ye[1],Tt=ut[0],St=ut[1];return Math.abs(pt-Tt)<=Ac.EPSILON*Math.max(1,Math.abs(pt),Math.abs(Tt))&&Math.abs(wt-St)<=Ac.EPSILON*Math.max(1,Math.abs(wt),Math.abs(St))},Mc.forEach=Mc.sqrLen=Mc.sqrDist=Mc.dist=Mc.div=Mc.mul=Mc.sub=Mc.len=void 0;var Ac=function(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==he(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=fe(void 0);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}(Xt);function fe(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(fe=function(Ye){return Ye?pt:ut})(Ye)}function de(){var Ye=new Ac.ARRAY_TYPE(2);return Ac.ARRAY_TYPE!=Float32Array&&(Ye[0]=0,Ye[1]=0),Ye}function me(Ye,ut,pt){return Ye[0]=ut[0]-pt[0],Ye[1]=ut[1]-pt[1],Ye}function ye(Ye,ut,pt){return Ye[0]=ut[0]*pt[0],Ye[1]=ut[1]*pt[1],Ye}function ge(Ye,ut,pt){return Ye[0]=ut[0]/pt[0],Ye[1]=ut[1]/pt[1],Ye}function xe(Ye,ut){return Math.hypot(ut[0]-Ye[0],ut[1]-Ye[1])}function be(Ye,ut){var pt=ut[0]-Ye[0],wt=ut[1]-Ye[1];return pt*pt+wt*wt}function ve(Ye){return Math.hypot(Ye[0],Ye[1])}function _e(Ye){var ut=Ye[0],pt=Ye[1];return ut*ut+pt*pt}Mc.len=ve,Mc.sub=me,Mc.mul=ye,Mc.div=ge,Mc.dist=xe,Mc.sqrDist=be,Mc.sqrLen=_e;var Sc=function(){var Ye=de();return function(ut,pt,wt,Tt,St,It){var Lt,$t;for(pt||(pt=2),wt||(wt=0),$t=Tt?Math.min(Tt*pt+wt,ut.length):ut.length,Lt=wt;Lt<$t;Lt+=pt)Ye[0]=ut[Lt],Ye[1]=ut[Lt+1],St(Ye,Ye,It),ut[Lt]=Ye[0],ut[Lt+1]=Ye[1];return ut}}();function Me(Ye){return Me="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(Ye){return typeof Ye}:function(Ye){return Ye&&"function"==typeof Symbol&&Ye.constructor===Symbol&&Ye!==Symbol.prototype?"symbol":typeof Ye},Me(Ye)}Mc.forEach=Sc,Object.defineProperty($t,"__esModule",{value:!0}),Ye.aA=$t.vec4=Ye._=$t.vec3=$t.vec2=$t.quat2=Ye.av=$t.quat=Ye.ad=$t.mat4=Ye.bC=$t.mat3=$t.mat2d=Ye.aC=$t.mat2=$t.glMatrix=void 0;var Dc=Re(Xt);$t.glMatrix=Dc;var qc=Re(xn);Ye.aC=$t.mat2=qc;var $c=Re(kn);$t.mat2d=$c;var mh=Re(Xn);Ye.bC=$t.mat3=mh;var yh=Re(Qn);Ye.ad=$t.mat4=yh;var Th=Re(Fo);Ye.av=$t.quat=Th;var Sh=Re(lc);$t.quat2=Sh;var Ih=Re(Mc);$t.vec2=Ih;var zh=Re(is);Ye._=$t.vec3=zh;var kh=Re(ds);function Ce(Ye){if("function"!=typeof WeakMap)return null;var ut=new WeakMap,pt=new WeakMap;return(Ce=function(Ye){return Ye?pt:ut})(Ye)}function Re(Ye,ut){if(Ye&&Ye.__esModule)return Ye;if(null===Ye||"object"!==Me(Ye)&&"function"!=typeof Ye)return{default:Ye};var pt=Ce(ut);if(pt&&pt.has(Ye))return pt.get(Ye);var wt={},Tt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var St in Ye)if("default"!==St&&Object.prototype.hasOwnProperty.call(Ye,St)){var It=Tt?Object.getOwnPropertyDescriptor(Ye,St):null;It&&(It.get||It.set)?Object.defineProperty(wt,St,It):wt[St]=Ye[St]}return wt.default=Ye,pt&&pt.set(Ye,wt),wt}Ye.aA=$t.vec4=kh;var qh=Le;function Le(Ye,pt,wt,Tt){(this||ut).cx=3*Ye,(this||ut).bx=3*(wt-Ye)-(this||ut).cx,(this||ut).ax=1-(this||ut).cx-(this||ut).bx,(this||ut).cy=3*pt,(this||ut).by=3*(Tt-pt)-(this||ut).cy,(this||ut).ay=1-(this||ut).cy-(this||ut).by,(this||ut).p1x=Ye,(this||ut).p1y=pt,(this||ut).p2x=wt,(this||ut).p2y=Tt}Le.prototype={sampleCurveX:function(Ye){return(((this||ut).ax*Ye+(this||ut).bx)*Ye+(this||ut).cx)*Ye},sampleCurveY:function(Ye){return(((this||ut).ay*Ye+(this||ut).by)*Ye+(this||ut).cy)*Ye},sampleCurveDerivativeX:function(Ye){return(3*(this||ut).ax*Ye+2*(this||ut).bx)*Ye+(this||ut).cx},solveCurveX:function(Ye,ut){if(void 0===ut&&(ut=1e-6),Ye<0)return 0;if(Ye>1)return 1;for(var pt=Ye,wt=0;wt<8;wt++){var Tt=this.sampleCurveX(pt)-Ye;if(Math.abs(Tt)<ut)return pt;var St=this.sampleCurveDerivativeX(pt);if(Math.abs(St)<1e-6)break;pt-=Tt/St}var It=0,Lt=1;for(pt=Ye,wt=0;wt<20&&(Tt=this.sampleCurveX(pt),!(Math.abs(Tt-Ye)<ut));wt++)Ye>Tt?It=pt:Lt=pt,pt=.5*(Lt-It)+It;return pt},solve:function(Ye,ut){return this.sampleCurveY(this.solveCurveX(Ye,ut))}};var Jh=p(qh),Qh=Ue;function Ue(Ye,pt){(this||ut).x=Ye,(this||ut).y=pt}Ue.prototype={clone:function(){return new Ue((this||ut).x,(this||ut).y)},add:function(Ye){return this.clone()._add(Ye)},sub:function(Ye){return this.clone()._sub(Ye)},multByPoint:function(Ye){return this.clone()._multByPoint(Ye)},divByPoint:function(Ye){return this.clone()._divByPoint(Ye)},mult:function(Ye){return this.clone()._mult(Ye)},div:function(Ye){return this.clone()._div(Ye)},rotate:function(Ye){return this.clone()._rotate(Ye)},rotateAround:function(Ye,ut){return this.clone()._rotateAround(Ye,ut)},matMult:function(Ye){return this.clone()._matMult(Ye)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||ut).x*(this||ut).x+(this||ut).y*(this||ut).y)},equals:function(Ye){return(this||ut).x===Ye.x&&(this||ut).y===Ye.y},dist:function(Ye){return Math.sqrt(this.distSqr(Ye))},distSqr:function(Ye){var pt=Ye.x-(this||ut).x,wt=Ye.y-(this||ut).y;return pt*pt+wt*wt},angle:function(){return Math.atan2((this||ut).y,(this||ut).x)},angleTo:function(Ye){return Math.atan2((this||ut).y-Ye.y,(this||ut).x-Ye.x)},angleWith:function(Ye){return this.angleWithSep(Ye.x,Ye.y)},angleWithSep:function(Ye,pt){return Math.atan2((this||ut).x*pt-(this||ut).y*Ye,(this||ut).x*Ye+(this||ut).y*pt)},_matMult:function(Ye){var pt=Ye[2]*(this||ut).x+Ye[3]*(this||ut).y;return(this||ut).x=Ye[0]*(this||ut).x+Ye[1]*(this||ut).y,(this||ut).y=pt,this||ut},_add:function(Ye){return(this||ut).x+=Ye.x,(this||ut).y+=Ye.y,this||ut},_sub:function(Ye){return(this||ut).x-=Ye.x,(this||ut).y-=Ye.y,this||ut},_mult:function(Ye){return(this||ut).x*=Ye,(this||ut).y*=Ye,this||ut},_div:function(Ye){return(this||ut).x/=Ye,(this||ut).y/=Ye,this||ut},_multByPoint:function(Ye){return(this||ut).x*=Ye.x,(this||ut).y*=Ye.y,this||ut},_divByPoint:function(Ye){return(this||ut).x/=Ye.x,(this||ut).y/=Ye.y,this||ut},_unit:function(){return this._div(this.mag()),this||ut},_perp:function(){var Ye=(this||ut).y;return(this||ut).y=(this||ut).x,(this||ut).x=-Ye,this||ut},_rotate:function(Ye){var pt=Math.cos(Ye),wt=Math.sin(Ye),Tt=wt*(this||ut).x+pt*(this||ut).y;return(this||ut).x=pt*(this||ut).x-wt*(this||ut).y,(this||ut).y=Tt,this||ut},_rotateAround:function(Ye,pt){var wt=Math.cos(Ye),Tt=Math.sin(Ye),St=pt.y+Tt*((this||ut).x-pt.x)+wt*((this||ut).y-pt.y);return(this||ut).x=pt.x+wt*((this||ut).x-pt.x)-Tt*((this||ut).y-pt.y),(this||ut).y=St,this||ut},_round:function(){return(this||ut).x=Math.round((this||ut).x),(this||ut).y=Math.round((this||ut).y),this||ut}},Ue.convert=function(Ye){return Ye instanceof Ue?Ye:Array.isArray(Ye)?new Ue(Ye[0],Ye[1]):Ye};var wu=p(Qh);const Tu=Math.PI/180,Mu=180/Math.PI;function $e(Ye){return Ye*Tu}function Ge(Ye){return Ye*Mu}const Iu=[[0,0],[1,0],[1,1],[0,1]];function Xe(Ye){if(Ye<=0)return 0;if(Ye>=1)return 1;const ut=Ye*Ye,pt=ut*Ye;return 4*(Ye<.5?pt:3*(Ye-ut)+pt-.75)}function Ze(Ye,ut,pt,wt){const Tt=new Jh(Ye,ut,pt,wt);return function(Ye){return Tt.solve(Ye)}}const Fu=Ze(.25,.1,.25,1);function Ke(Ye,ut,pt){return Math.min(pt,Math.max(ut,Ye))}function We(Ye,ut,pt){return(pt=Ke((pt-Ye)/(ut-Ye),0,1))*pt*(3-2*pt)}function Je(Ye,ut,pt){const wt=pt-ut,Tt=((Ye-ut)%wt+wt)%wt+ut;return Tt===ut?pt:Tt}function Qe(Ye,ut,pt){if(!Ye.length)return pt(null,[]);let wt=Ye.length;const Tt=new Array(Ye.length);let St=null;Ye.forEach(((Ye,It)=>{ut(Ye,((Ye,ut)=>{Ye&&(St=Ye),Tt[It]=ut,0==--wt&&pt(St,Tt)}))}))}function tr(Ye){const ut=[];for(const pt in Ye)ut.push(Ye[pt]);return ut}function er(Ye,...ut){for(const pt of ut)for(const ut in pt)Ye[ut]=pt[ut];return Ye}let Nu=1;function nr(){return Nu++}function ir(){return function t(Ye){return Ye?(Ye^Math.random()*(16>>Ye/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function sr(Ye){return Ye<=1?1:Math.pow(2,Math.ceil(Math.log(Ye)/Math.LN2))}function ar(Ye){return!!Ye&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(Ye)}function or(Ye,ut){Ye.forEach((Ye=>{ut[Ye]&&(ut[Ye]=ut[Ye].bind(ut))}))}function lr(Ye,ut){return-1!==Ye.indexOf(ut,Ye.length-ut.length)}function ur(Ye,pt,wt){const Tt={};for(const wt in Ye)Tt[wt]=pt.call(this||ut,Ye[wt],wt,Ye);return Tt}function cr(Ye,pt,wt){const Tt={};for(const wt in Ye)pt.call(this||ut,Ye[wt],wt,Ye)&&(Tt[wt]=Ye[wt]);return Tt}function hr(Ye){return Array.isArray(Ye)?Ye.map(hr):"object"==typeof Ye&&Ye?ur(Ye,hr):Ye}const ju={};function fr(Ye){ju[Ye]||("undefined"!=typeof console&&console.warn(Ye),ju[Ye]=!0)}function dr(Ye,ut,pt){return(pt.y-Ye.y)*(ut.x-Ye.x)>(ut.y-Ye.y)*(pt.x-Ye.x)}function mr(Ye){let ut=0;for(let pt,wt,Tt=0,St=Ye.length,It=St-1;Tt<St;It=Tt++)pt=Ye[Tt],wt=Ye[It],ut+=(wt.x-pt.x)*(pt.y+wt.y);return ut}function yr([Ye,ut,pt]){const wt=$e(ut+90),Tt=$e(pt);return{x:Ye*Math.cos(wt)*Math.sin(Tt),y:Ye*Math.sin(wt)*Math.sin(Tt),z:Ye*Math.cos(Tt),azimuthal:ut,polar:pt}}function gr(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function xr(Ye){const ut={};if(Ye.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((Ye,pt,wt,Tt)=>{const St=wt||Tt;return ut[pt]=!St||St.toLowerCase(),""})),ut["max-age"]){const Ye=parseInt(ut["max-age"],10);isNaN(Ye)?delete ut["max-age"]:ut["max-age"]=Ye}return ut}let Ju,ed,td,id,rd,nd,od=null;function Ir(Ye){try{const ut=self[Ye];return ut.setItem("_mapbox_test_",1),ut.removeItem("_mapbox_test_"),!0}catch(Ye){return!1}}function Tr(Ye,ut){return[Ye[4*ut],Ye[4*ut+1],Ye[4*ut+2],Ye[4*ut+3]]}function kr(Ye,ut,pt,wt){for(;ut<pt;){const Tt=ut+pt>>1;Ye[Tt]<wt?ut=Tt+1:pt=Tt}return ut}function Pr(Ye,ut,pt,wt){for(;ut<pt;){const Tt=ut+pt>>1;Ye[Tt]<=wt?ut=Tt+1:pt=Tt}return ut}function zr(Ye){return Ye>0?1/(1.001-Ye):1+Ye}function Er(Ye){return Ye>0?1-1/(1.001-Ye):-Ye}function Br(){return null==Ju&&(Ju=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),Ju}const sd={now:()=>void 0!==id?id:performance.now(),setNow(Ye){id=Ye},restoreNow(){id=void 0},frame(Ye){const ut=requestAnimationFrame(Ye);return{cancel:()=>cancelAnimationFrame(ut)}},getImageData(Ye,ut=0){const{width:pt,height:wt}=Ye;rd||(rd=document.createElement("canvas"));const Tt=rd.getContext("2d",{willReadFrequently:!0});if(!Tt)throw new Error("failed to create canvas 2d context");return(pt>rd.width||wt>rd.height)&&(rd.width=pt,rd.height=wt),Tt.clearRect(-ut,-ut,pt+2*ut,wt+2*ut),Tt.drawImage(Ye,0,0,pt,wt),Tt.getImageData(-ut,-ut,pt+2*ut,wt+2*ut)},resolveURL:Ye=>(ed||(ed=document.createElement("a")),ed.href=Ye,ed.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==td&&(td=window.matchMedia("(prefers-reduced-motion: reduce)")),td.matches)},hasCanvasFingerprintNoise(){if(void 0!==nd)return nd;if(!Br())return nd=!1,!1;const Ye=new OffscreenCanvas(85,1),ut=Ye.getContext("2d",{willReadFrequently:!0});let pt=0;for(let wt=0;wt<Ye.width;++wt)ut.fillStyle=`rgba(${pt++},${pt++},${pt++}, 255)`,ut.fillRect(wt,0,1,1);const wt=ut.getImageData(0,0,Ye.width,Ye.height);pt=0;for(let Ye=0;Ye<wt.data.length;++Ye)if(Ye%4!=3&&pt++!==wt.data[Ye])return nd=!0,!0;return nd=!1,!1}};function Cr(Ye,ut){const pt=Ye.indexOf("?");if(pt<0)return`${Ye}?${new URLSearchParams(ut).toString()}`;const wt=new URLSearchParams(Ye.slice(pt));for(const Ye in ut)wt.set(Ye,ut[Ye]);return`${Ye.slice(0,pt)}?${wt.toString()}`}function Rr(Ye,ut={persistentParams:[]}){const pt=Ye.indexOf("?");if(pt<0)return Ye;const wt=new URLSearchParams,Tt=new URLSearchParams(Ye.slice(pt));for(const Ye of ut.persistentParams){const ut=Tt.get(Ye);ut&&wt.set(Ye,ut)}const St=wt.toString();return`${Ye.slice(0,pt)}${St.length>0?`?${St}`:""}`}const ad="mapbox-tiles";let md=500,Cd=50;let Pd,zd;function Nr(){try{return caches}catch(Ye){}}function jr(){const Ye=Nr();Ye&&!Pd&&(Pd=Ye.open(ad))}let Rd=1/0;const Ld={supported:!1,testSupport:function(Ye){!Nd&&Fd&&(Vd?Kr(Ye):Od=Ye)}};let Od,Fd,Nd=!1,Vd=!1;const Ud="undefined"!=typeof self?self:{};function Kr(Ye){const ut=Ye.createTexture();Ye.bindTexture(Ye.TEXTURE_2D,ut);try{if(Ye.texImage2D(Ye.TEXTURE_2D,0,Ye.RGBA,Ye.RGBA,Ye.UNSIGNED_BYTE,Fd),Ye.isContextLost())return;Ld.supported=!0}catch(Ye){}Ye.deleteTexture(ut),Nd=!0}Ud.document&&(Fd=Ud.document.createElement("img"),Fd.onload=function(){Od&&Kr(Od),Od=null,Vd=!0},Fd.onerror=function(){Nd=!0,Od=null},Fd.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const jd={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(jd);class Jr extends Error{constructor(Ye,ut,pt){401===ut&&i(pt)&&(Ye+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(Ye),this.status=ut,this.url=pt}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Gd=gr()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href;const tn=function(Ye,ut){if(!(/^file:/.test(pt=Ye.url)||/^file:/.test(Gd())&&!/^\w+:/.test(pt))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(Ye,ut){const pt=new AbortController,wt=new Request(Ye.url,{method:Ye.method||"GET",body:Ye.body,credentials:Ye.credentials,headers:Ye.headers,referrer:Gd(),referrerPolicy:Ye.referrerPolicy,signal:pt.signal});let Tt=!1,St=!1;const It=(Lt=wt.url).indexOf("sku=")>0&&i(Lt);var Lt;"json"===Ye.type&&wt.headers.set("Accept","application/json");const u=(pt,Tt,Lt)=>{if(St)return;if(pt&&"SecurityError"!==pt.message&&fr(pt.toString()),Tt&&Lt)return c(Tt);const $t=Date.now();fetch(wt).then((pt=>{if(pt.ok){const Ye=It?pt.clone():null;return c(pt,Ye,$t)}return ut(new Jr(pt.statusText,pt.status,Ye.url))})).catch((pt=>{"AbortError"!==pt.name&&ut(new Error(`${pt.message} ${Ye.url}`))}))},c=(pt,It,Lt)=>{("arrayBuffer"===Ye.type?pt.arrayBuffer():"json"===Ye.type?pt.json():pt.text()).then((Ye=>{St||(It&&Lt&&function(Ye,ut,pt){if(jr(),!Pd)return;const wt=xr(ut.headers.get("Cache-Control")||"");if(wt["no-store"])return;const Tt={status:ut.status,statusText:ut.statusText,headers:new Headers};ut.headers.forEach(((Ye,ut)=>Tt.headers.set(ut,Ye))),wt["max-age"]&&Tt.headers.set("Expires",new Date(pt+1e3*wt["max-age"]).toUTCString());const St=Tt.headers.get("Expires");if(!St)return;if(new Date(St).getTime()-pt<42e4)return;let It=Rr(Ye.url,{persistentParams:["language","worldview"]});if(206===ut.status){const ut=Ye.headers.get("Range");if(!ut)return;Tt.status=200,It=Cr(It,{range:ut})}!function(Ye,ut){if(void 0===zd)try{new Response(new ReadableStream),zd=!0}catch(Ye){zd=!1}zd?ut(Ye.body):Ye.blob().then(ut)}(ut,(Ye=>{const pt=new Response(200!==(wt=ut.status)&&404!==wt&&[101,103,204,205,304].includes(wt)?null:Ye,Tt);var wt;jr(),Pd&&Pd.then((Ye=>Ye.put(It,pt))).catch((Ye=>fr(Ye.message)))}))}(wt,It,Lt),Tt=!0,ut(null,Ye,pt.headers.get("Cache-Control"),pt.headers.get("Expires")))})).catch((Ye=>{St||ut(new Error(Ye.message))}))};return It?function(Ye,ut){if(jr(),!Pd)return ut(null);Pd.then((pt=>{let wt=Rr(Ye.url,{persistentParams:["language","worldview"]});const Tt=Ye.headers.get("Range");Tt&&(wt=Cr(wt,{range:Tt})),pt.match(wt).then((Ye=>{const Tt=function(Ye){if(!Ye)return!1;const ut=new Date(Ye.headers.get("Expires")||0),pt=xr(Ye.headers.get("Cache-Control")||"");return ut>Date.now()&&!pt["no-cache"]}(Ye);pt.delete(wt),Tt&&pt.put(wt,Ye.clone()),ut(null,Ye,Tt)})).catch(ut)})).catch(ut)}(wt,u):u(null,null),{cancel:()=>{St=!0,Tt||pt.abort()}}}(Ye,ut);if(gr()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",Ye,ut,void 0,!0)}var pt;return function(Ye,ut){const pt=new XMLHttpRequest;pt.open(Ye.method||"GET",Ye.url,!0),"arrayBuffer"===Ye.type&&(pt.responseType="arraybuffer");for(const ut in Ye.headers)pt.setRequestHeader(ut,Ye.headers[ut]);return"json"===Ye.type&&(pt.responseType="text",pt.setRequestHeader("Accept","application/json")),pt.withCredentials="include"===Ye.credentials,pt.onerror=()=>{ut(new Error(pt.statusText))},pt.onload=()=>{if((pt.status>=200&&pt.status<300||0===pt.status)&&null!==pt.response){let wt=pt.response;if("json"===Ye.type)try{wt=JSON.parse(pt.response)}catch(Ye){return ut(Ye)}ut(null,wt,pt.getResponseHeader("Cache-Control"),pt.getResponseHeader("Expires"))}else ut(new Jr(pt.statusText,pt.status,Ye.url))},pt.send(Ye.body),{cancel:()=>pt.abort()}}(Ye,ut)},en=function(Ye,ut){return tn(er(Ye,{type:"arrayBuffer"}),ut)};function rn(Ye){const ut=document.createElement("a");return ut.href=Ye,ut.protocol===location.protocol&&ut.host===location.host}const qd="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Zd,$d;Zd=[],$d=0;const on=function(Ye,pt){if(Ld.supported&&(Ye.headers||(Ye.headers={}),Ye.headers.accept="image/webp,*/*"),$d>=St.MAX_PARALLEL_IMAGE_REQUESTS){const wt={requestParameters:Ye,callback:pt,cancelled:!1,cancel(){(this||ut).cancelled=!0}};return Zd.push(wt),wt}$d++;let wt=!1;const i=()=>{if(!wt)for(wt=!0,$d--;Zd.length&&$d<St.MAX_PARALLEL_IMAGE_REQUESTS;){const Ye=Zd.shift(),{requestParameters:ut,callback:pt,cancelled:wt}=Ye;wt||(Ye.cancel=on(ut,pt).cancel)}},Tt=en(Ye,((Ye,ut,wt,Tt)=>{i(),Ye?pt(Ye):ut&&(self.createImageBitmap?function(Ye,ut){const pt=new Blob([new Uint8Array(Ye)],{type:"image/png"});createImageBitmap(pt).then((Ye=>{ut(null,Ye)})).catch((Ye=>{ut(new Error(`Could not load image because of ${Ye.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(ut,((Ye,ut)=>pt(Ye,ut,wt,Tt))):function(Ye,ut){const pt=new Image;pt.onload=()=>{ut(null,pt),URL.revokeObjectURL(pt.src),pt.onload=null,requestAnimationFrame((()=>{pt.src=qd}))},pt.onerror=()=>ut(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const wt=new Blob([new Uint8Array(Ye)],{type:"image/png"});pt.src=Ye.byteLength?URL.createObjectURL(wt):qd}(ut,((Ye,ut)=>pt(Ye,ut,wt,Tt))))}));return{cancel:()=>{Tt.cancel(),i()}}},Wd="01",Hd="NO_ACCESS_TOKEN",Xd=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function hn(Ye){const ut=Ye.match(Xd);if(!ut)throw new Error("Unable to parse URL object");return{protocol:ut[1],authority:ut[2],path:ut[3]||"/",params:ut[4]?ut[4].split("&"):[]}}function pn(Ye){const ut=Ye.params.length?`?${Ye.params.join("&")}`:"";return`${Ye.protocol}://${Ye.authority}${Ye.path}${ut}`}const Yd="mapbox.eventData";function dn(Ye){if(!Ye)return null;const ut=Ye.split(".");if(!ut||3!==ut.length)return null;try{return JSON.parse(decodeURIComponent(atob(ut[1]).split("").map((Ye=>"%"+("00"+Ye.charCodeAt(0).toString(16)).slice(-2))).join("")))}catch(Ye){return null}}class mn{constructor(Ye){this.type=Ye,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(Ye){const ut=dn(St.ACCESS_TOKEN);let pt="";return pt=ut&&ut.u?btoa(encodeURIComponent(ut.u).replace(/%([0-9A-F]{2})/g,((Ye,ut)=>String.fromCharCode(Number("0x"+ut))))):St.ACCESS_TOKEN||"",Ye?`${Yd}.${Ye}:${pt}`:`${Yd}:${pt}`}fetchEventData(){const Ye=Ir("localStorage"),ut=this.getStorageKey(),pt=this.getStorageKey("uuid");if(Ye)try{const Ye=localStorage.getItem(ut);Ye&&(this.eventData=JSON.parse(Ye));const wt=localStorage.getItem(pt);wt&&(this.anonId=wt)}catch(Ye){fr("Unable to read from LocalStorage")}}saveEventData(){const Ye=Ir("localStorage"),ut=this.getStorageKey(),pt=this.getStorageKey("uuid"),wt=this.anonId;if(Ye&&wt)try{localStorage.setItem(pt,wt),Object.keys(this.eventData).length>=1&&localStorage.setItem(ut,JSON.stringify(this.eventData))}catch(Ye){fr("Unable to write to LocalStorage")}}processRequests(Ye){}postEvent(Ye,ut,pt,wt){if(!St.EVENTS_URL)return;const Tt=hn(St.EVENTS_URL);Tt.params.push(`access_token=${wt||St.ACCESS_TOKEN||""}`);const It={event:this.type,created:new Date(Ye).toISOString()},Lt=ut?er(It,ut):It,$t={url:pn(Tt),headers:{"Content-Type":"text/plain"},body:JSON.stringify([Lt])};this.pendingRequest=function(Ye,ut){return tn(er(Ye,{method:"POST"}),ut)}($t,(Ye=>{this.pendingRequest=null,pt(Ye),this.saveEventData(),this.processRequests(wt)}))}queueRequest(Ye,ut){this.queue.push(Ye),this.processRequests(ut)}}const Jd=new class extends mn{constructor(Ye){super("appUserTurnstile"),this._customAccessToken=Ye}postTurnstileEvent(Ye,ut){St.EVENTS_URL&&St.ACCESS_TOKEN&&Array.isArray(Ye)&&Ye.some((Ye=>s(Ye)||i(Ye)))&&this.queueRequest(Date.now(),ut)}processRequests(Ye){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const ut=dn(St.ACCESS_TOKEN),wt=ut?ut.u:St.ACCESS_TOKEN;let Tt=wt!==this.eventData.tokenU;ar(this.anonId)||(this.anonId=ir(),Tt=!0);const It=this.queue.shift();if(this.eventData.lastSuccess){const Ye=new Date(this.eventData.lastSuccess),ut=new Date(It),pt=(It-this.eventData.lastSuccess)/864e5;Tt=Tt||pt>=1||pt<-1||Ye.getDate()!==ut.getDate()}else Tt=!0;Tt?this.postEvent(It,{sdkIdentifier:"mapbox-gl-js",sdkVersion:pt,skuId:Wd,"enabled.telemetry":!1,userId:this.anonId},(Ye=>{Ye||(this.eventData.lastSuccess=It,this.eventData.tokenU=wt)}),Ye):this.processRequests()}},Qd=Jd.postTurnstileEvent.bind(Jd),ep=new class extends mn{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(Ye,ut,pt,wt){this.skuToken=ut,this.errorCb=wt,St.EVENTS_URL&&(pt||St.ACCESS_TOKEN?this.queueRequest({id:Ye,timestamp:Date.now()},pt):this.errorCb(new Error(Hd)))}processRequests(Ye){if(this.pendingRequest||0===this.queue.length)return;const{id:ut,timestamp:wt}=this.queue.shift();ut&&this.success[ut]||(this.anonId||this.fetchEventData(),ar(this.anonId)||(this.anonId=ir()),this.postEvent(wt,{sdkIdentifier:"mapbox-gl-js",sdkVersion:pt,skuId:Wd,skuToken:this.skuToken,userId:this.anonId},(Ye=>{Ye?this.errorCb(Ye):ut&&(this.success[ut]=!0)}),Ye))}remove(){this.errorCb=null}},tp=ep.postMapLoadEvent.bind(ep),sp=new class extends mn{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(Ye){let ut=this.mapInstanceIdMap.get(Ye);return ut||(ut=ir(),this.mapInstanceIdMap.set(Ye,ut)),ut}getEventId(Ye){const ut=this.eventIdPerMapInstanceMap.get(Ye)||0;return this.eventIdPerMapInstanceMap.set(Ye,ut+1),ut}postStyleLoadEvent(Ye,ut){const{map:pt,style:wt,importedStyles:Tt}=ut;if(!St.EVENTS_URL||!Ye&&!St.ACCESS_TOKEN)return;const It=this.getMapInstanceId(pt),Lt={mapInstanceId:It,eventId:this.getEventId(It),style:wt};Tt.length&&(Lt.importedStyles=Tt),this.queueRequest({timestamp:Date.now(),payload:Lt},Ye)}processRequests(Ye){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:ut,payload:pt}=this.queue.shift();this.postEvent(ut,pt,(()=>{}),Ye)}},ap=sp.postStyleLoadEvent.bind(sp),mp=new class extends mn{constructor(){super("gljs.performance")}postPerformanceEvent(Ye,ut){St.EVENTS_URL&&(Ye||St.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:ut},Ye)}processRequests(Ye){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:ut,performanceData:wt}=this.queue.shift(),Tt=function(Ye){const ut=performance.getEntriesByType("resource"),wt=performance.getEntriesByType("mark"),Tt=function(Ye){const ut={};if(Ye)for(const pt in Ye)if("other"!==pt)for(const wt of Ye[pt]){const Ye=`${pt}ResolveRangeMin`,Tt=`${pt}ResolveRangeMax`,St=`${pt}RequestCount`,It=`${pt}RequestCachedCount`;ut[Ye]=Math.min(ut[Ye]||1/0,wt.startTime),ut[Tt]=Math.max(ut[Tt]||-1/0,wt.responseEnd);const o=Ye=>{void 0===ut[Ye]&&(ut[Ye]=0),++ut[Ye]};void 0!==wt.transferSize&&0===wt.transferSize&&o(It),o(St)}return ut}(function(Ye,ut){const pt={};if(Ye)for(const wt of Ye){const Ye=ut(wt);void 0===pt[Ye]&&(pt[Ye]=[]),pt[Ye].push(wt)}return pt}(ut,h)),St=window.devicePixelRatio,Lt=navigator.connection||navigator.mozConnection||navigator.webkitConnection,$t=Lt?Lt.effectiveType:void 0,Xt={counters:[],metadata:[],attributes:[]},p=(Ye,ut,pt)=>{null!=pt&&Ye.push({name:ut,value:pt.toString()})};for(const Ye in Tt)p(Xt.counters,Ye,Tt[Ye]);if(Ye.interactionRange[0]!==1/0&&Ye.interactionRange[1]!==-1/0&&(p(Xt.counters,"interactionRangeMin",Ye.interactionRange[0]),p(Xt.counters,"interactionRangeMax",Ye.interactionRange[1])),wt)for(const Ye of Object.keys(It)){const ut=It[Ye],pt=wt.find((Ye=>Ye.name===ut));pt&&p(Xt.counters,ut,pt.startTime)}return p(Xt.counters,"visibilityHidden",Ye.visibilityHidden),p(Xt.attributes,"style",function(Ye){if(Ye)for(const ut of Ye){const Ye=ut.name.split("?")[0];if(l(Ye)){const ut=Ye.split("/").slice(-2);if(2===ut.length)return`mapbox://styles/${ut[0]}/${ut[1]}`}}}(ut)),p(Xt.attributes,"terrainEnabled",Ye.terrainEnabled?"true":"false"),p(Xt.attributes,"fogEnabled",Ye.fogEnabled?"true":"false"),p(Xt.attributes,"projection",Ye.projection),p(Xt.attributes,"zoom",Ye.zoom),p(Xt.metadata,"devicePixelRatio",St),p(Xt.metadata,"connectionEffectiveType",$t),p(Xt.metadata,"navigatorUserAgent",navigator.userAgent),p(Xt.metadata,"screenWidth",window.screen.width),p(Xt.metadata,"screenHeight",window.screen.height),p(Xt.metadata,"windowWidth",window.innerWidth),p(Xt.metadata,"windowHeight",window.innerHeight),p(Xt.metadata,"mapWidth",Ye.width/St),p(Xt.metadata,"mapHeight",Ye.height/St),p(Xt.metadata,"webglRenderer",Ye.renderer),p(Xt.metadata,"webglVendor",Ye.vendor),p(Xt.metadata,"sdkVersion",pt),p(Xt.metadata,"sdkIdentifier","mapbox-gl-js"),Xt}(wt);for(const Ye of Tt.metadata);for(const Ye of Tt.counters);for(const Ye of Tt.attributes);this.postEvent(ut,Tt,(()=>{}),Ye)}},_p=mp.postPerformanceEvent.bind(mp),yp=new class extends mn{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(Ye,ut,pt,wt){if(!St.API_URL||!St.SESSION_PATH)return;const Tt=hn(St.API_URL+St.SESSION_PATH);Tt.params.push(`sku=${ut||""}`),Tt.params.push(`access_token=${wt||St.ACCESS_TOKEN||""}`);const It={url:pn(Tt),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(Ye,ut){return tn(er(Ye,{method:"GET"}),ut)}(It,(Ye=>{this.pendingRequest=null,pt(Ye),this.saveEventData(),this.processRequests(wt)}))}getSessionAPI(Ye,ut,pt,wt){this.skuToken=ut,this.errorCb=wt,St.SESSION_PATH&&St.API_URL&&(pt||St.ACCESS_TOKEN?this.queueRequest({id:Ye,timestamp:Date.now()},pt):this.errorCb(new Error(Hd)))}processRequests(Ye){if(this.pendingRequest||0===this.queue.length)return;const{id:ut,timestamp:pt}=this.queue.shift();ut&&this.success[ut]||this.getSession(pt,this.skuToken,(Ye=>{Ye?this.errorCb(Ye):ut&&(this.success[ut]=!0)}),Ye)}remove(){this.errorCb=null}},xp=yp.getSessionAPI.bind(yp),vp=new Set;var bp={exports:{}},Jp={exports:function(Ye,ut){var pt,wt,Tt,St,It,Lt,$t,Xt;for(wt=Ye.length-(pt=3&Ye.length),Tt=ut,It=3432918353,Lt=461845907,Xt=0;Xt<wt;)$t=255&Ye.charCodeAt(Xt)|(255&Ye.charCodeAt(++Xt))<<8|(255&Ye.charCodeAt(++Xt))<<16|(255&Ye.charCodeAt(++Xt))<<24,++Xt,Tt=27492+(65535&(St=5*(65535&(Tt=(Tt^=$t=(65535&($t=($t=(65535&$t)*It+((($t>>>16)*It&65535)<<16)&4294967295)<<15|$t>>>17))*Lt+((($t>>>16)*Lt&65535)<<16)&4294967295)<<13|Tt>>>19))+((5*(Tt>>>16)&65535)<<16)&4294967295))+((58964+(St>>>16)&65535)<<16);switch($t=0,pt){case 3:$t^=(255&Ye.charCodeAt(Xt+2))<<16;case 2:$t^=(255&Ye.charCodeAt(Xt+1))<<8;case 1:Tt^=$t=(65535&($t=($t=(65535&($t^=255&Ye.charCodeAt(Xt)))*It+((($t>>>16)*It&65535)<<16)&4294967295)<<15|$t>>>17))*Lt+((($t>>>16)*Lt&65535)<<16)&4294967295}return Tt^=Ye.length,Tt=2246822507*(65535&(Tt^=Tt>>>16))+((2246822507*(Tt>>>16)&65535)<<16)&4294967295,Tt=3266489909*(65535&(Tt^=Tt>>>13))+((3266489909*(Tt>>>16)&65535)<<16)&4294967295,(Tt^=Tt>>>16)>>>0}},Qp={exports:({},function(Ye,ut){for(var pt,wt=Ye.length,Tt=ut^wt,St=0;wt>=4;)pt=1540483477*(65535&(pt=255&Ye.charCodeAt(St)|(255&Ye.charCodeAt(++St))<<8|(255&Ye.charCodeAt(++St))<<16|(255&Ye.charCodeAt(++St))<<24))+((1540483477*(pt>>>16)&65535)<<16),Tt=1540483477*(65535&Tt)+((1540483477*(Tt>>>16)&65535)<<16)^(pt=1540483477*(65535&(pt^=pt>>>24))+((1540483477*(pt>>>16)&65535)<<16)),wt-=4,++St;switch(wt){case 3:Tt^=(255&Ye.charCodeAt(St+2))<<16;case 2:Tt^=(255&Ye.charCodeAt(St+1))<<8;case 1:Tt=1540483477*(65535&(Tt^=255&Ye.charCodeAt(St)))+((1540483477*(Tt>>>16)&65535)<<16)}return Tt=1540483477*(65535&(Tt^=Tt>>>13))+((1540483477*(Tt>>>16)&65535)<<16),(Tt^=Tt>>>15)>>>0})},nf=Jp.exports,of=Qp.exports;bp.exports=nf,bp.exports.murmur3=nf,bp.exports.murmur2=of;var sf=p(bp.exports);class Dn{constructor(Ye,...ut){er(this,ut[0]||{}),this.type=Ye}}class Cn extends Dn{constructor(Ye,ut={}){super("error",er({error:Ye},ut))}}function Rn(Ye,ut,pt){pt[Ye]&&-1!==pt[Ye].indexOf(ut)||(pt[Ye]=pt[Ye]||[],pt[Ye].push(ut))}function Vn(Ye,ut,pt){if(pt&&pt[Ye]){const wt=pt[Ye].indexOf(ut);-1!==wt&&pt[Ye].splice(wt,1)}}class Ln{on(Ye,ut){return this._listeners=this._listeners||{},Rn(Ye,ut,this._listeners),this}off(Ye,ut){return Vn(Ye,ut,this._listeners),Vn(Ye,ut,this._oneTimeListeners),this}once(Ye,ut){return ut?(this._oneTimeListeners=this._oneTimeListeners||{},Rn(Ye,ut,this._oneTimeListeners),this):new Promise((ut=>this.once(Ye,ut)))}fire(Ye,ut){const pt="string"==typeof Ye?new Dn(Ye,ut):Ye,wt=pt.type;if(this.listens(wt)){pt.target=this;const Ye=this._listeners&&this._listeners[wt]?this._listeners[wt].slice():[];for(const ut of Ye)ut.call(this,pt);const ut=this._oneTimeListeners&&this._oneTimeListeners[wt]?this._oneTimeListeners[wt].slice():[];for(const Ye of ut)Vn(wt,Ye,this._oneTimeListeners),Ye.call(this,pt);const Tt=this._eventedParent;Tt&&(er(pt,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),Tt.fire(pt))}else pt instanceof Cn&&console.error(pt.error);return this}listens(Ye){return!!(this._listeners&&this._listeners[Ye]&&this._listeners[Ye].length>0||this._oneTimeListeners&&this._oneTimeListeners[Ye]&&this._oneTimeListeners[Ye].length>0||this._eventedParent&&this._eventedParent.listens(Ye))}setEventedParent(Ye,ut){return this._eventedParent=Ye,this._eventedParentData=ut,this}}Ye.F=void 0;var af={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Fn(Ye){return(Ye=Math.round(Ye))<0?0:Ye>255?255:Ye}function Un(Ye){return Fn("%"===Ye[Ye.length-1]?parseFloat(Ye)/100*255:parseInt(Ye))}function Nn(Ye){return(ut="%"===Ye[Ye.length-1]?parseFloat(Ye)/100:parseFloat(Ye))<0?0:ut>1?1:ut;var ut}function jn(Ye,ut,pt){return pt<0?pt+=1:pt>1&&(pt-=1),6*pt<1?Ye+(ut-Ye)*pt*6:2*pt<1?ut:3*pt<2?Ye+(ut-Ye)*(2/3-pt)*6:Ye}try{Ye.F={}.parseCSSColor=function(Ye){var ut,pt=Ye.replace(/ /g,"").toLowerCase();if(pt in af)return af[pt].slice();if("#"===pt[0])return 4===pt.length?(ut=parseInt(pt.substr(1),16))>=0&&ut<=4095?[(3840&ut)>>4|(3840&ut)>>8,240&ut|(240&ut)>>4,15&ut|(15&ut)<<4,1]:null:7===pt.length&&(ut=parseInt(pt.substr(1),16))>=0&&ut<=16777215?[(16711680&ut)>>16,(65280&ut)>>8,255&ut,1]:null;var wt=pt.indexOf("("),Tt=pt.indexOf(")");if(-1!==wt&&Tt+1===pt.length){var St=pt.substr(0,wt),It=pt.substr(wt+1,Tt-(wt+1)).split(","),Lt=1;switch(St){case"rgba":if(4!==It.length)return null;Lt=Nn(It.pop());case"rgb":return 3!==It.length?null:[Un(It[0]),Un(It[1]),Un(It[2]),Lt];case"hsla":if(4!==It.length)return null;Lt=Nn(It.pop());case"hsl":if(3!==It.length)return null;var $t=(parseFloat(It[0])%360+360)%360/360,Xt=Nn(It[1]),Sr=Nn(It[2]),Lr=Sr<=.5?Sr*(Xt+1):Sr+Xt-Sr*Xt,Qr=2*Sr-Lr;return[Fn(255*jn(Qr,Lr,$t+1/3)),Fn(255*jn(Qr,Lr,$t)),Fn(255*jn(Qr,Lr,$t-1/3)),Lt];default:return null}}return null}}catch(Ye){}class qn{constructor(Ye,ut,pt,wt=1){this.r=Ye,this.g=ut,this.b=pt,this.a=wt}static parse(ut){if(!ut)return;if(ut instanceof qn)return ut;if("string"!=typeof ut)return;const pt=Ye.F(ut);return pt?new qn(pt[0]/255*pt[3],pt[1]/255*pt[3],pt[2]/255*pt[3],pt[3]):void 0}toString(){const[Ye,ut,pt,wt]=0===this.a?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(Ye)},${Math.round(ut)},${Math.round(pt)},${wt})`}toRenderColor(Ye){const{r:ut,g:pt,b:wt,a:Tt}=this;return new $n(Ye,ut,pt,wt,Tt)}}class $n{constructor(Ye,ut,pt,wt,Tt){if(Ye){const St=Ye.image.height,It=St*St;ut=0===Tt?0:ut/Tt*(St-1),pt=0===Tt?0:pt/Tt*(St-1),wt=0===Tt?0:wt/Tt*(St-1);const Lt=Math.floor(ut),$t=Math.floor(pt),Xt=Math.floor(wt),Sr=Math.ceil(ut),Lr=Math.ceil(pt),Qr=Math.ceil(wt),fn=ut-Lt,xn=pt-$t,vn=wt-Xt,kn=Ye.image.data,Wn=4*(Lt+$t*It+Xt*St),Xn=4*(Lt+$t*It+Qr*St),Jn=4*(Lt+Lr*It+Xt*St),Qn=4*(Lt+Lr*It+Qr*St),ko=4*(Sr+$t*It+Xt*St),Fo=4*(Sr+$t*It+Qr*St),is=4*(Sr+Lr*It+Xt*St),ns=4*(Sr+Lr*It+Qr*St);if(Wn<0||ns>=kn.length)throw new Error("out of range");this.r=Gn(Gn(Gn(kn[Wn],kn[Xn],vn),Gn(kn[Jn],kn[Qn],vn),xn),Gn(Gn(kn[ko],kn[Fo],vn),Gn(kn[is],kn[ns],vn),xn),fn)/255*Tt,this.g=Gn(Gn(Gn(kn[Wn+1],kn[Xn+1],vn),Gn(kn[Jn+1],kn[Qn+1],vn),xn),Gn(Gn(kn[ko+1],kn[Fo+1],vn),Gn(kn[is+1],kn[ns+1],vn),xn),fn)/255*Tt,this.b=Gn(Gn(Gn(kn[Wn+2],kn[Xn+2],vn),Gn(kn[Jn+2],kn[Qn+2],vn),xn),Gn(Gn(kn[ko+2],kn[Fo+2],vn),Gn(kn[is+2],kn[ns+2],vn),xn),fn)/255*Tt,this.a=Tt}else this.r=ut,this.g=pt,this.b=wt,this.a=Tt}toArray(){const{r:Ye,g:ut,b:pt,a:wt}=this;return 0===wt?[0,0,0,0]:[255*Ye/wt,255*ut/wt,255*pt/wt,wt]}toArray01(){const{r:Ye,g:ut,b:pt,a:wt}=this;return 0===wt?[0,0,0,0]:[Ye/wt,ut/wt,pt/wt,wt]}toArray01Scaled(Ye){const{r:ut,g:pt,b:wt,a:Tt}=this;return 0===Tt?[0,0,0]:[ut/Tt*Ye,pt/Tt*Ye,wt/Tt*Ye]}toArray01PremultipliedAlpha(){const{r:Ye,g:ut,b:pt,a:wt}=this;return[Ye,ut,pt,wt]}toArray01Linear(){const{r:Ye,g:ut,b:pt,a:wt}=this;return 0===wt?[0,0,0,0]:[Math.pow(Ye/wt,2.2),Math.pow(ut/wt,2.2),Math.pow(pt/wt,2.2),wt]}}function Gn(Ye,ut,pt){return Ye*(1-pt)+ut*pt}function Yn(Ye,ut,pt){return Ye.map(((Ye,wt)=>Gn(Ye,ut[wt],pt)))}qn.black=new qn(0,0,0,1),qn.white=new qn(1,1,1,1),qn.transparent=new qn(0,0,0,0),qn.red=new qn(1,0,0,1),qn.blue=new qn(0,0,1,1);var lf=Object.freeze({__proto__:null,array:Yn,color:function(Ye,ut,pt){return new qn(Gn(Ye.r,ut.r,pt),Gn(Ye.g,ut.g,pt),Gn(Ye.b,ut.b,pt),Gn(Ye.a,ut.a,pt))},number:Gn});function Zn(Ye,...ut){for(const pt of ut)for(const ut in pt)Ye[ut]=pt[ut];return Ye}class Hn extends Error{constructor(Ye,ut){super(ut),this.message=ut,this.key=Ye}}class Kn{constructor(Ye,ut=[]){this.parent=Ye,this.bindings={};for(const[Ye,pt]of ut)this.bindings[Ye]=pt}concat(Ye){return new Kn(this,Ye)}get(Ye){if(this.bindings[Ye])return this.bindings[Ye];if(this.parent)return this.parent.get(Ye);throw new Error(`${Ye} not found in scope.`)}has(Ye){return!!this.bindings[Ye]||!!this.parent&&this.parent.has(Ye)}}const cf={kind:"null"},hf={kind:"number"},uf={kind:"string"},df={kind:"boolean"},pf={kind:"color"},ff={kind:"object"},xf={kind:"value"},bf={kind:"collator"},wf={kind:"formatted"},Af={kind:"resolvedImage"};function oi(Ye,ut){return{kind:"array",itemType:Ye,N:ut}}function li(Ye){if("array"===Ye.kind){const ut=li(Ye.itemType);return"number"==typeof Ye.N?`array<${ut}, ${Ye.N}>`:"value"===Ye.itemType.kind?"array":`array<${ut}>`}return Ye.kind}const Sf=[cf,hf,uf,df,pf,wf,ff,oi(xf),Af];function ci(Ye,ut){if("error"===ut.kind)return null;if("array"===Ye.kind){if("array"===ut.kind&&(0===ut.N&&"value"===ut.itemType.kind||!ci(Ye.itemType,ut.itemType))&&("number"!=typeof Ye.N||Ye.N===ut.N))return null}else{if(Ye.kind===ut.kind)return null;if("value"===Ye.kind)for(const Ye of Sf)if(!ci(Ye,ut))return null}return`Expected ${li(Ye)} but found ${li(ut)} instead.`}function hi(Ye,ut){return ut.some((ut=>ut.kind===Ye.kind))}function pi(Ye,ut){return ut.some((ut=>"null"===ut?null===Ye:"array"===ut?Array.isArray(Ye):"object"===ut?Ye&&!Array.isArray(Ye)&&"object"==typeof Ye:ut===typeof Ye))}class fi{constructor(Ye,ut,pt){this.sensitivity=Ye?ut?"variant":"case":ut?"accent":"base",this.locale=pt,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(Ye,ut){return this.collator.compare(Ye,ut)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class di{constructor(Ye,ut,pt,wt,Tt){this.text=Ye.normalize?Ye.normalize():Ye,this.image=ut,this.scale=pt,this.fontStack=wt,this.textColor=Tt}}class mi{constructor(Ye){this.sections=Ye}static fromString(Ye){return new mi([new di(Ye,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((Ye=>0!==Ye.text.length||Ye.image&&0!==Ye.image.namePrimary.length))}static factory(Ye){return Ye instanceof mi?Ye:mi.fromString(Ye)}toString(){return 0===this.sections.length?"":this.sections.map((Ye=>Ye.text)).join("")}serialize(){const Ye=["format"];for(const ut of this.sections){if(ut.image){Ye.push(["image",ut.image.namePrimary]);continue}Ye.push(ut.text);const pt={};ut.fontStack&&(pt["text-font"]=["literal",ut.fontStack.split(",")]),ut.scale&&(pt["font-scale"]=ut.scale),ut.textColor&&(pt["text-color"]=["rgba"].concat(ut.textColor.toRenderColor(null).toArray())),Ye.push(pt)}return Ye}}class yi{constructor(Ye){this.namePrimary=Ye.namePrimary,Ye.nameSecondary&&(this.nameSecondary=Ye.nameSecondary),this.available=Ye.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(Ye,ut){return Ye?new yi({namePrimary:Ye,nameSecondary:ut,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function gi(Ye,ut,pt,wt){return"number"==typeof Ye&&Ye>=0&&Ye<=255&&"number"==typeof ut&&ut>=0&&ut<=255&&"number"==typeof pt&&pt>=0&&pt<=255?void 0===wt||"number"==typeof wt&&wt>=0&&wt<=1?null:`Invalid rgba value [${[Ye,ut,pt,wt].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof wt?[Ye,ut,pt,wt]:[Ye,ut,pt]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function xi(Ye){if(null===Ye)return!0;if("string"==typeof Ye)return!0;if("boolean"==typeof Ye)return!0;if("number"==typeof Ye)return!0;if(Ye instanceof qn)return!0;if(Ye instanceof fi)return!0;if(Ye instanceof mi)return!0;if(Ye instanceof yi)return!0;if(Array.isArray(Ye)){for(const ut of Ye)if(!xi(ut))return!1;return!0}if("object"==typeof Ye){for(const ut in Ye)if(!xi(Ye[ut]))return!1;return!0}return!1}function bi(Ye){if(null===Ye)return cf;if("string"==typeof Ye)return uf;if("boolean"==typeof Ye)return df;if("number"==typeof Ye)return hf;if(Ye instanceof qn)return pf;if(Ye instanceof fi)return bf;if(Ye instanceof mi)return wf;if(Ye instanceof yi)return Af;if(Array.isArray(Ye)){const ut=Ye.length;let pt;for(const ut of Ye){const Ye=bi(ut);if(pt){if(pt===Ye)continue;pt=xf;break}pt=Ye}return oi(pt||xf,ut)}return ff}function vi(Ye){const ut=typeof Ye;return null===Ye?"":"string"===ut||"number"===ut||"boolean"===ut?String(Ye):Ye instanceof qn||Ye instanceof mi||Ye instanceof yi?Ye.toString():JSON.stringify(Ye)}class _i{constructor(Ye,ut){this.type=Ye,this.value=ut}static parse(Ye,ut){if(2!==Ye.length)return ut.error(`'literal' expression requires exactly one argument, but found ${Ye.length-1} instead.`);if(!xi(Ye[1]))return ut.error("invalid value");const pt=Ye[1];let wt=bi(pt);const Tt=ut.expectedType;return"array"!==wt.kind||0!==wt.N||!Tt||"array"!==Tt.kind||"number"==typeof Tt.N&&0!==Tt.N||(wt=Tt),new _i(wt,pt)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof qn?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof mi?this.value.serialize():this.value}}class wi{constructor(Ye){this.name="ExpressionEvaluationError",this.message=Ye}toJSON(){return this.message}}const Hf={string:uf,number:hf,boolean:df,object:ff};class Ai{constructor(Ye,ut){this.type=Ye,this.args=ut}static parse(Ye,ut){if(Ye.length<2)return ut.error("Expected at least one argument.");let pt,wt=1;const Tt=Ye[0];if("array"===Tt){let Tt,St;if(Ye.length>2){const pt=Ye[1];if("string"!=typeof pt||!(pt in Hf)||"object"===pt)return ut.error('The item type argument of "array" must be one of string, number, boolean',1);Tt=Hf[pt],wt++}else Tt=xf;if(Ye.length>3){if(null!==Ye[2]&&("number"!=typeof Ye[2]||Ye[2]<0||Ye[2]!==Math.floor(Ye[2])))return ut.error('The length argument to "array" must be a positive integer literal',2);St=Ye[2],wt++}pt=oi(Tt,St)}else pt=Hf[Tt];const St=[];for(;wt<Ye.length;wt++){const pt=ut.parse(Ye[wt],wt,xf);if(!pt)return null;St.push(pt)}return new Ai(pt,St)}evaluate(Ye){for(let ut=0;ut<this.args.length;ut++){const pt=this.args[ut].evaluate(Ye);if(!ci(this.type,bi(pt)))return pt;if(ut===this.args.length-1)throw new wi(`Expected value to be of type ${li(this.type)}, but found ${li(bi(pt))} instead.`)}return null}eachChild(Ye){this.args.forEach(Ye)}outputDefined(){return this.args.every((Ye=>Ye.outputDefined()))}serialize(){const Ye=this.type,ut=[Ye.kind];if("array"===Ye.kind){const pt=Ye.itemType;if("string"===pt.kind||"number"===pt.kind||"boolean"===pt.kind){ut.push(pt.kind);const wt=Ye.N;("number"==typeof wt||this.args.length>1)&&ut.push(wt)}}return ut.concat(this.args.map((Ye=>Ye.serialize())))}}class Si{constructor(Ye){this.type=wf,this.sections=Ye}static parse(Ye,ut){if(Ye.length<2)return ut.error("Expected at least one argument.");const pt=Ye[1];if(!Array.isArray(pt)&&"object"==typeof pt)return ut.error("First argument must be an image or text section.");const wt=[];let Tt=!1;for(let pt=1;pt<=Ye.length-1;++pt){const St=Ye[pt];if(Tt&&"object"==typeof St&&!Array.isArray(St)){Tt=!1;let Ye=null;if(St["font-scale"]&&(Ye=ut.parse(St["font-scale"],1,hf),!Ye))return null;let pt=null;if(St["text-font"]&&(pt=ut.parse(St["text-font"],1,oi(uf)),!pt))return null;let It=null;if(St["text-color"]&&(It=ut.parse(St["text-color"],1,pf),!It))return null;const Lt=wt[wt.length-1];Lt.scale=Ye,Lt.font=pt,Lt.textColor=It}else{const St=ut.parse(Ye[pt],1,xf);if(!St)return null;const It=St.type.kind;if("string"!==It&&"value"!==It&&"null"!==It&&"resolvedImage"!==It)return ut.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");Tt=!0,wt.push({content:St,scale:null,font:null,textColor:null})}}return new Si(wt)}evaluate(Ye){return new mi(this.sections.map((ut=>{const pt=ut.content.evaluate(Ye);return bi(pt)===Af?new di("",pt,null,null,null):new di(vi(pt),null,ut.scale?ut.scale.evaluate(Ye):null,ut.font?ut.font.evaluate(Ye).join(","):null,ut.textColor?ut.textColor.evaluate(Ye):null)})))}eachChild(Ye){for(const ut of this.sections)Ye(ut.content),ut.scale&&Ye(ut.scale),ut.font&&Ye(ut.font),ut.textColor&&Ye(ut.textColor)}outputDefined(){return!1}serialize(){const Ye=["format"];for(const ut of this.sections){Ye.push(ut.content.serialize());const pt={};ut.scale&&(pt["font-scale"]=ut.scale.serialize()),ut.font&&(pt["text-font"]=ut.font.serialize()),ut.textColor&&(pt["text-color"]=ut.textColor.serialize()),Ye.push(pt)}return Ye}}class Ii{constructor(Ye,ut){this.type=Af,this.inputPrimary=Ye,this.inputSecondary=ut}static parse(Ye,ut){if(Ye.length<2)return ut.error("Expected two or more arguments.");const pt=ut.parse(Ye[1],1,uf);if(!pt)return ut.error("No image name provided.");if(2===Ye.length)return new Ii(pt);const wt=ut.parse(Ye[2],1,uf);return wt?new Ii(pt,wt):ut.error("Secondary image variant is not a string.")}evaluate(Ye){const ut=yi.fromString(this.inputPrimary.evaluate(Ye),this.inputSecondary?this.inputSecondary.evaluate(Ye):void 0);return ut&&Ye.availableImages&&(ut.available=Ye.availableImages.indexOf(ut.namePrimary)>-1,ut.nameSecondary&&ut.available&&Ye.availableImages&&(ut.available=Ye.availableImages.indexOf(ut.nameSecondary)>-1)),ut}eachChild(Ye){Ye(this.inputPrimary),this.inputSecondary&&Ye(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Ti(Ye){return Ye instanceof Number?"number":Ye instanceof String?"string":Ye instanceof Boolean?"boolean":Array.isArray(Ye)?"array":null===Ye?"null":typeof Ye}const rm={"to-boolean":df,"to-color":pf,"to-number":hf,"to-string":uf};class Pi{constructor(Ye,ut){this.type=Ye,this.args=ut}static parse(Ye,ut){if(Ye.length<2)return ut.error("Expected at least one argument.");const pt=Ye[0],wt=[];let Tt=cf;if("to-array"===pt){if(!Array.isArray(Ye[1]))return null;const pt=Ye[1].length;if(ut.expectedType){if("array"!==ut.expectedType.kind)return ut.error(`Expected ${ut.expectedType.kind} but found array.`);Tt=oi(ut.expectedType.itemType,pt)}else{if(!(pt>0&&xi(Ye[1][0])))return null;Tt=oi(bi(Ye[1][0]),pt)}for(let St=0;St<pt;St++){const pt=Ye[1][St];let It;if("array"===Ti(pt))It=ut.parse(pt,void 0,Tt.itemType);else{const Ye=Ti(pt);if(Ye!==Tt.itemType.kind)return ut.error(`Expected ${Tt.itemType.kind} but found ${Ye}.`);It=ut.registry.literal.parse(["literal",void 0===pt?null:pt],ut)}if(!It)return null;wt.push(It)}}else{if(("to-boolean"===pt||"to-string"===pt)&&2!==Ye.length)return ut.error("Expected one argument.");Tt=rm[pt];for(let pt=1;pt<Ye.length;pt++){const Tt=ut.parse(Ye[pt],pt,xf);if(!Tt)return null;wt.push(Tt)}}return new Pi(Tt,wt)}evaluate(Ye){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(Ye));if("color"===this.type.kind){let ut,pt;for(const wt of this.args){if(ut=wt.evaluate(Ye),pt=null,ut instanceof qn)return ut;if("string"==typeof ut){const pt=Ye.parseColor(ut);if(pt)return pt}else if(Array.isArray(ut)&&(pt=ut.length<3||ut.length>4?`Invalid rbga value ${JSON.stringify(ut)}: expected an array containing either three or four numeric values.`:gi(ut[0],ut[1],ut[2],ut[3]),!pt))return new qn(ut[0]/255,ut[1]/255,ut[2]/255,ut[3])}throw new wi(pt||`Could not parse color from value '${"string"==typeof ut?ut:String(JSON.stringify(ut))}'`)}if("number"===this.type.kind){let ut=null;for(const pt of this.args){if(ut=pt.evaluate(Ye),null===ut)return 0;const wt=Number(ut);if(!isNaN(wt))return wt}throw new wi(`Could not convert ${JSON.stringify(ut)} to number.`)}return"formatted"===this.type.kind?mi.fromString(vi(this.args[0].evaluate(Ye))):"resolvedImage"===this.type.kind?yi.fromString(vi(this.args[0].evaluate(Ye))):"array"===this.type.kind?this.args.map((ut=>ut.evaluate(Ye))):vi(this.args[0].evaluate(Ye))}eachChild(Ye){this.args.forEach(Ye)}outputDefined(){return this.args.every((Ye=>Ye.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new Si([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Ii(this.args[0]).serialize();const Ye="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((ut=>{Ye.push(ut.serialize())})),Ye}}const nm=["Unknown","Point","LineString","Polygon"];class Ei{constructor(Ye,ut){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=Ye,this.options=ut}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?nm[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(Ye){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const Ye=this.featureDistanceData.center,ut=this.featureDistanceData.scale,{x:pt,y:wt}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(pt*ut-Ye[0])+this.featureDistanceData.bearing[1]*(wt*ut-Ye[1])}return 0}parseColor(Ye){let ut=this._parseColorCache[Ye];return ut||(ut=this._parseColorCache[Ye]=qn.parse(Ye)),ut}getConfig(Ye){return this.options?this.options.get(Ye):null}}class Bi{constructor(Ye,ut,pt,wt,Tt){this.name=Ye,this.type=ut,this._evaluate=pt,this.args=wt,this._overloadIndex=Tt}evaluate(Ye){if(!this._evaluate){const Ye=Bi.definitions[this.name];this._evaluate=Array.isArray(Ye)?Ye[2]:Ye.overloads[this._overloadIndex][1]}return this._evaluate(Ye,this.args)}eachChild(Ye){this.args.forEach(Ye)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((Ye=>Ye.serialize())))}static parse(Ye,ut){const pt=Ye[0],wt=Bi.definitions[pt];if(!wt)return ut.error(`Unknown expression "${pt}". If you wanted a literal array, use ["literal", [...]].`,0);const Tt=Array.isArray(wt)?wt[0]:wt.type,St=Array.isArray(wt)?[[wt[1],wt[2]]]:wt.overloads,It=[];let Lt=null,$t=-1;for(const[wt,Xt]of St){if(Array.isArray(wt)&&wt.length!==Ye.length-1)continue;It.push(wt),$t++,Lt=new Fm(ut.registry,ut.path,null,ut.scope,void 0,ut._scope,ut.options);const St=[];let Sr=!1;for(let ut=1;ut<Ye.length;ut++){const pt=Ye[ut],Tt=Array.isArray(wt)?wt[ut-1]:wt.type,It=Lt.parse(pt,1+St.length,Tt);if(!It){Sr=!0;break}St.push(It)}if(!Sr)if(Array.isArray(wt)&&wt.length!==St.length)Lt.error(`Expected ${wt.length} arguments, but found ${St.length} instead.`);else{for(let Ye=0;Ye<St.length;Ye++){const ut=Array.isArray(wt)?wt[Ye]:wt.type,pt=St[Ye];Lt.concat(Ye+1).checkSubtype(ut,pt.type)}if(0===Lt.errors.length)return new Bi(pt,Tt,Xt,St,$t)}}if(1===It.length)ut.errors.push(...Lt.errors);else{const pt=(It.length?It:St.map((([Ye])=>Ye))).map(Di).join(" | "),wt=[];for(let pt=1;pt<Ye.length;pt++){const Tt=ut.parse(Ye[pt],1+wt.length);if(!Tt)return null;wt.push(li(Tt.type))}ut.error(`Expected arguments of type ${pt}, but found (${wt.join(", ")}) instead.`)}return null}static register(Ye,ut){Bi.definitions=ut;for(const pt in ut)Ye[pt]=Bi}}function Di(Ye){return Array.isArray(Ye)?`(${Ye.map(li).join(", ")})`:`(${li(Ye.type)}...)`}class Ci{constructor(Ye,ut,pt){this.type=bf,this.locale=pt,this.caseSensitive=Ye,this.diacriticSensitive=ut}static parse(Ye,ut){if(2!==Ye.length)return ut.error("Expected one argument.");const pt=Ye[1];if("object"!=typeof pt||Array.isArray(pt))return ut.error("Collator options argument must be an object.");const wt=ut.parse(void 0!==pt["case-sensitive"]&&pt["case-sensitive"],1,df);if(!wt)return null;const Tt=ut.parse(void 0!==pt["diacritic-sensitive"]&&pt["diacritic-sensitive"],1,df);if(!Tt)return null;let St=null;return pt.locale&&(St=ut.parse(pt.locale,1,uf),!St)?null:new Ci(wt,Tt,St)}evaluate(Ye){return new fi(this.caseSensitive.evaluate(Ye),this.diacriticSensitive.evaluate(Ye),this.locale?this.locale.evaluate(Ye):null)}eachChild(Ye){Ye(this.caseSensitive),Ye(this.diacriticSensitive),this.locale&&Ye(this.locale)}outputDefined(){return!1}serialize(){const Ye={};return Ye["case-sensitive"]=this.caseSensitive.serialize(),Ye["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(Ye.locale=this.locale.serialize()),["collator",Ye]}}function Ri(Ye,ut,pt=0,wt=Ye.length-1,Tt=Li){for(;wt>pt;){if(wt-pt>600){const St=wt-pt+1,It=ut-pt+1,Lt=Math.log(St),$t=.5*Math.exp(2*Lt/3),Xt=.5*Math.sqrt(Lt*$t*(St-$t)/St)*(It-St/2<0?-1:1);Ri(Ye,ut,Math.max(pt,Math.floor(ut-It*$t/St+Xt)),Math.min(wt,Math.floor(ut+(St-It)*$t/St+Xt)),Tt)}const St=Ye[ut];let It=pt,Lt=wt;for(Vi(Ye,pt,ut),Tt(Ye[wt],St)>0&&Vi(Ye,pt,wt);It<Lt;){for(Vi(Ye,It,Lt),It++,Lt--;Tt(Ye[It],St)<0;)It++;for(;Tt(Ye[Lt],St)>0;)Lt--}0===Tt(Ye[pt],St)?Vi(Ye,pt,Lt):(Lt++,Vi(Ye,Lt,wt)),Lt<=ut&&(pt=Lt+1),ut<=Lt&&(wt=Lt-1)}}function Vi(Ye,ut,pt){const wt=Ye[ut];Ye[ut]=Ye[pt],Ye[pt]=wt}function Li(Ye,ut){return Ye<ut?-1:Ye>ut?1:0}function Oi(Ye){let ut=0;for(let pt,wt,Tt=0,St=Ye.length,It=St-1;Tt<St;It=Tt++)pt=Ye[Tt],wt=Ye[It],ut+=(wt.x-pt.x)*(pt.y+wt.y);return ut}function Fi(Ye,ut){Ye[0]=Math.min(Ye[0],ut[0]),Ye[1]=Math.min(Ye[1],ut[1]),Ye[2]=Math.max(Ye[2],ut[0]),Ye[3]=Math.max(Ye[3],ut[1])}function Ui(Ye,ut){return!(Ye[0]<=ut[0]||Ye[2]>=ut[2]||Ye[1]<=ut[1]||Ye[3]>=ut[3])}function Ni(Ye,ut,pt){const wt=Ye[0]-ut[0],Tt=Ye[1]-ut[1],St=Ye[0]-pt[0],It=Ye[1]-pt[1];return wt*It-St*Tt==0&&wt*St<=0&&Tt*It<=0}function ji(Ye,ut,pt=!1){let wt=!1;for(let Lt=0,$t=ut.length;Lt<$t;Lt++){const $t=ut[Lt];for(let ut=0,Lt=$t.length,Xt=Lt-1;ut<Lt;Xt=ut++){const Lt=$t[Xt],Sr=$t[ut];if(Ni(Ye,Lt,Sr))return pt;(St=Lt)[1]>(Tt=Ye)[1]!=(It=Sr)[1]>Tt[1]&&Tt[0]<(It[0]-St[0])*(Tt[1]-St[1])/(It[1]-St[1])+St[0]&&(wt=!wt)}}var Tt,St,It;return wt}function qi(Ye,ut,pt,wt){const Tt=wt[0]-pt[0],St=wt[1]-pt[1],It=(Ye[0]-pt[0])*St-Tt*(Ye[1]-pt[1]),Lt=(ut[0]-pt[0])*St-Tt*(ut[1]-pt[1]);return It>0&&Lt<0||It<0&&Lt>0}function $i(Ye,ut,pt,wt){return 0!=(Tt=[wt[0]-pt[0],wt[1]-pt[1]])[0]*(St=[ut[0]-Ye[0],ut[1]-Ye[1]])[1]-Tt[1]*St[0]&&!(!qi(Ye,ut,pt,wt)||!qi(pt,wt,Ye,ut));var Tt,St}const cm=8192;function Yi(Ye,ut){const pt=(180+Ye[0])/360,wt=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+Ye[1]*Math.PI/360)))/360,Tt=Math.pow(2,ut.z);return[Math.round(pt*Tt*cm),Math.round(wt*Tt*cm)]}function Xi(Ye,ut){for(let pt=0;pt<ut.length;pt++)if(ji(Ye,ut[pt]))return!0;return!1}function Zi(Ye,ut,pt){for(const wt of pt)for(let pt=0,Tt=wt.length,St=Tt-1;pt<Tt;St=pt++)if($i(Ye,ut,wt[St],wt[pt]))return!0;return!1}function Hi(Ye,ut){for(let pt=0;pt<Ye.length;++pt)if(!ji(Ye[pt],ut))return!1;for(let pt=0;pt<Ye.length-1;++pt)if(Zi(Ye[pt],Ye[pt+1],ut))return!1;return!0}function Ki(Ye,ut){for(let pt=0;pt<ut.length;pt++)if(Hi(Ye,ut[pt]))return!0;return!1}function Wi(Ye,ut,pt){const wt=[];for(let Tt=0;Tt<Ye.length;Tt++){const St=[];for(let wt=0;wt<Ye[Tt].length;wt++){const It=Yi(Ye[Tt][wt],pt);Fi(ut,It),St.push(It)}wt.push(St)}return wt}function Ji(Ye,ut,pt){const wt=[];for(let Tt=0;Tt<Ye.length;Tt++){const St=Wi(Ye[Tt],ut,pt);wt.push(St)}return wt}function Qi(Ye,ut,pt,wt){if(Ye[0]<pt[0]||Ye[0]>pt[2]){const ut=.5*wt;let Tt=Ye[0]-pt[0]>ut?-wt:pt[0]-Ye[0]>ut?wt:0;0===Tt&&(Tt=Ye[0]-pt[2]>ut?-wt:pt[2]-Ye[0]>ut?wt:0),Ye[0]+=Tt}Fi(ut,Ye)}function ts(Ye,ut,pt,wt){const Tt=Math.pow(2,wt.z)*cm,St=[wt.x*cm,wt.y*cm],It=[];if(!Ye)return It;for(const wt of Ye)for(const Ye of wt){const wt=[Ye.x+St[0],Ye.y+St[1]];Qi(wt,ut,pt,Tt),It.push(wt)}return It}function es(Ye,ut,pt,wt){const Tt=Math.pow(2,wt.z)*cm,St=[wt.x*cm,wt.y*cm],It=[];if(!Ye)return It;for(const pt of Ye){const Ye=[];for(const wt of pt){const pt=[wt.x+St[0],wt.y+St[1]];Fi(ut,pt),Ye.push(pt)}It.push(Ye)}if(ut[2]-ut[0]<=Tt/2){(Lt=ut)[0]=Lt[1]=1/0,Lt[2]=Lt[3]=-1/0;for(const Ye of It)for(const wt of Ye)Qi(wt,ut,pt,Tt)}var Lt;return It}class rs{constructor(Ye,ut){this.type=df,this.geojson=Ye,this.geometries=ut}static parse(Ye,ut){if(2!==Ye.length)return ut.error(`'within' expression requires exactly one argument, but found ${Ye.length-1} instead.`);if(xi(Ye[1])){const ut=Ye[1];if("FeatureCollection"===ut.type)for(let Ye=0;Ye<ut.features.length;++Ye){const pt=ut.features[Ye].geometry.type;if("Polygon"===pt||"MultiPolygon"===pt)return new rs(ut,ut.features[Ye].geometry)}else if("Feature"===ut.type){const Ye=ut.geometry.type;if("Polygon"===Ye||"MultiPolygon"===Ye)return new rs(ut,ut.geometry)}else if("Polygon"===ut.type||"MultiPolygon"===ut.type)return new rs(ut,ut)}return ut.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(Ye){if(null!=Ye.geometry()&&null!=Ye.canonicalID()){if("Point"===Ye.geometryType())return function(Ye,ut){const pt=[1/0,1/0,-1/0,-1/0],wt=[1/0,1/0,-1/0,-1/0],Tt=Ye.canonicalID();if(!Tt)return!1;if("Polygon"===ut.type){const St=Wi(ut.coordinates,wt,Tt),It=ts(Ye.geometry(),pt,wt,Tt);if(!Ui(pt,wt))return!1;for(const Ye of It)if(!ji(Ye,St))return!1}if("MultiPolygon"===ut.type){const St=Ji(ut.coordinates,wt,Tt),It=ts(Ye.geometry(),pt,wt,Tt);if(!Ui(pt,wt))return!1;for(const Ye of It)if(!Xi(Ye,St))return!1}return!0}(Ye,this.geometries);if("LineString"===Ye.geometryType())return function(Ye,ut){const pt=[1/0,1/0,-1/0,-1/0],wt=[1/0,1/0,-1/0,-1/0],Tt=Ye.canonicalID();if(!Tt)return!1;if("Polygon"===ut.type){const St=Wi(ut.coordinates,wt,Tt),It=es(Ye.geometry(),pt,wt,Tt);if(!Ui(pt,wt))return!1;for(const Ye of It)if(!Hi(Ye,St))return!1}if("MultiPolygon"===ut.type){const St=Ji(ut.coordinates,wt,Tt),It=es(Ye.geometry(),pt,wt,Tt);if(!Ui(pt,wt))return!1;for(const Ye of It)if(!Ki(Ye,St))return!1}return!0}(Ye,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const hm={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},dm=1/298.257223563,pm=dm*(2-dm),mm=Math.PI/180;class os{static fromTile(Ye,ut,pt){const wt=Math.PI*(1-2*(Ye+.5)/Math.pow(2,ut)),Tt=Math.atan(.5*(Math.exp(wt)-Math.exp(-wt)))/mm;return new os(Tt,pt)}static get units(){return hm}constructor(Ye,ut){if(void 0===Ye)throw new Error("No latitude given.");if(ut&&!hm[ut])throw new Error(`Unknown unit ${ut}. Use one of: ${Object.keys(hm).join(", ")}`);const pt=6378.137*mm*(ut?hm[ut]:1),wt=Math.cos(Ye*mm),Tt=1/(1-pm*(1-wt*wt)),St=Math.sqrt(Tt);this.kx=pt*St*wt,this.ky=pt*St*Tt*(1-pm)}distance(Ye,ut){const pt=cs(Ye[0]-ut[0])*this.kx,wt=(Ye[1]-ut[1])*this.ky;return Math.sqrt(pt*pt+wt*wt)}bearing(Ye,ut){const pt=cs(ut[0]-Ye[0])*this.kx;return Math.atan2(pt,(ut[1]-Ye[1])*this.ky)/mm}destination(Ye,ut,pt){const wt=pt*mm;return this.offset(Ye,Math.sin(wt)*ut,Math.cos(wt)*ut)}offset(Ye,ut,pt){return[Ye[0]+ut/this.kx,Ye[1]+pt/this.ky]}lineDistance(Ye){let ut=0;for(let pt=0;pt<Ye.length-1;pt++)ut+=this.distance(Ye[pt],Ye[pt+1]);return ut}area(Ye){let ut=0;for(let pt=0;pt<Ye.length;pt++){const wt=Ye[pt];for(let Ye=0,Tt=wt.length,St=Tt-1;Ye<Tt;St=Ye++)ut+=cs(wt[Ye][0]-wt[St][0])*(wt[Ye][1]+wt[St][1])*(pt?-1:1)}return Math.abs(ut)/2*this.kx*this.ky}along(Ye,ut){let pt=0;if(ut<=0)return Ye[0];for(let wt=0;wt<Ye.length-1;wt++){const Tt=Ye[wt],St=Ye[wt+1],It=this.distance(Tt,St);if(pt+=It,pt>ut)return us(Tt,St,(ut-(pt-It))/It)}return Ye[Ye.length-1]}pointToSegmentDistance(Ye,ut,pt){let[wt,Tt]=ut,St=cs(pt[0]-wt)*this.kx,It=(pt[1]-Tt)*this.ky;if(0!==St||0!==It){const ut=(cs(Ye[0]-wt)*this.kx*St+(Ye[1]-Tt)*this.ky*It)/(St*St+It*It);ut>1?(wt=pt[0],Tt=pt[1]):ut>0&&(wt+=St/this.kx*ut,Tt+=It/this.ky*ut)}return St=cs(Ye[0]-wt)*this.kx,It=(Ye[1]-Tt)*this.ky,Math.sqrt(St*St+It*It)}pointOnLine(Ye,ut){let pt=1/0,wt=Ye[0][0],Tt=Ye[0][1],St=0,It=0;for(let Lt=0;Lt<Ye.length-1;Lt++){let $t=Ye[Lt][0],Xt=Ye[Lt][1],Sr=cs(Ye[Lt+1][0]-$t)*this.kx,Lr=(Ye[Lt+1][1]-Xt)*this.ky,Qr=0;0===Sr&&0===Lr||(Qr=(cs(ut[0]-$t)*this.kx*Sr+(ut[1]-Xt)*this.ky*Lr)/(Sr*Sr+Lr*Lr),Qr>1?($t=Ye[Lt+1][0],Xt=Ye[Lt+1][1]):Qr>0&&($t+=Sr/this.kx*Qr,Xt+=Lr/this.ky*Qr)),Sr=cs(ut[0]-$t)*this.kx,Lr=(ut[1]-Xt)*this.ky;const fn=Sr*Sr+Lr*Lr;fn<pt&&(pt=fn,wt=$t,Tt=Xt,St=Lt,It=Qr)}return{point:[wt,Tt],index:St,t:Math.max(0,Math.min(1,It))}}lineSlice(Ye,ut,pt){let wt=this.pointOnLine(pt,Ye),Tt=this.pointOnLine(pt,ut);if(wt.index>Tt.index||wt.index===Tt.index&&wt.t>Tt.t){const Ye=wt;wt=Tt,Tt=Ye}const St=[wt.point],It=wt.index+1,Lt=Tt.index;!ls(pt[It],St[0])&&It<=Lt&&St.push(pt[It]);for(let Ye=It+1;Ye<=Lt;Ye++)St.push(pt[Ye]);return ls(pt[Lt],Tt.point)||St.push(Tt.point),St}lineSliceAlong(Ye,ut,pt){let wt=0;const Tt=[];for(let St=0;St<pt.length-1;St++){const It=pt[St],Lt=pt[St+1],$t=this.distance(It,Lt);if(wt+=$t,wt>Ye&&0===Tt.length&&Tt.push(us(It,Lt,(Ye-(wt-$t))/$t)),wt>=ut)return Tt.push(us(It,Lt,(ut-(wt-$t))/$t)),Tt;wt>Ye&&Tt.push(Lt)}return Tt}bufferPoint(Ye,ut){const pt=ut/this.ky,wt=ut/this.kx;return[Ye[0]-wt,Ye[1]-pt,Ye[0]+wt,Ye[1]+pt]}bufferBBox(Ye,ut){const pt=ut/this.ky,wt=ut/this.kx;return[Ye[0]-wt,Ye[1]-pt,Ye[2]+wt,Ye[3]+pt]}insideBBox(Ye,ut){return cs(Ye[0]-ut[0])>=0&&cs(Ye[0]-ut[2])<=0&&Ye[1]>=ut[1]&&Ye[1]<=ut[3]}}function ls(Ye,ut){return Ye[0]===ut[0]&&Ye[1]===ut[1]}function us(Ye,ut,pt){const wt=cs(ut[0]-Ye[0]);return[Ye[0]+wt*pt,Ye[1]+(ut[1]-Ye[1])*pt]}function cs(Ye){for(;Ye<-180;)Ye+=360;for(;Ye>180;)Ye-=360;return Ye}class hs{constructor(Ye=[],ut=((Ye,ut)=>Ye<ut?-1:Ye>ut?1:0)){if(this.data=Ye,this.length=this.data.length,this.compare=ut,this.length>0)for(let Ye=(this.length>>1)-1;Ye>=0;Ye--)this._down(Ye)}push(Ye){this.data.push(Ye),this._up(this.length++)}pop(){if(0===this.length)return;const Ye=this.data[0],ut=this.data.pop();return--this.length>0&&(this.data[0]=ut,this._down(0)),Ye}peek(){return this.data[0]}_up(Ye){const{data:ut,compare:pt}=this,wt=ut[Ye];for(;Ye>0;){const Tt=Ye-1>>1,St=ut[Tt];if(pt(wt,St)>=0)break;ut[Ye]=St,Ye=Tt}ut[Ye]=wt}_down(Ye){const{data:ut,compare:pt}=this,wt=this.length>>1,Tt=ut[Ye];for(;Ye<wt;){let wt=1+(Ye<<1);const St=wt+1;if(St<this.length&&pt(ut[St],ut[wt])<0&&(wt=St),pt(ut[wt],Tt)>=0)break;ut[Ye]=ut[wt],Ye=wt}ut[Ye]=Tt}}var ym=8192;function fs(Ye,ut){return ut.dist-Ye.dist}const Dm=100,Bm=50;function ys(Ye){const ut=[1/0,1/0,-1/0,-1/0];if(ut.length!==Ye.length)return!1;for(let pt=0;pt<ut.length;pt++)if(ut[pt]!==Ye[pt])return!1;return!0}function gs(Ye){return Ye[1]-Ye[0]+1}function xs(Ye,ut){const pt=Ye[1]>=Ye[0]&&Ye[1]<ut;return pt||console.warn("Distance Expression: Index is out of range"),pt}function bs(Ye,ut){if(Ye[0]>Ye[1])return[null,null];const pt=gs(Ye);if(ut){if(2===pt)return[Ye,null];const ut=Math.floor(pt/2);return[[Ye[0],Ye[0]+ut],[Ye[0]+ut,Ye[1]]]}{if(1===pt)return[Ye,null];const ut=Math.floor(pt/2)-1;return[[Ye[0],Ye[0]+ut],[Ye[0]+ut+1,Ye[1]]]}}function vs(Ye,ut){const pt=[1/0,1/0,-1/0,-1/0];if(!xs(ut,Ye.length))return pt;for(let wt=ut[0];wt<=ut[1];++wt)Fi(pt,Ye[wt]);return pt}function _s(Ye){const ut=[1/0,1/0,-1/0,-1/0];for(let pt=0;pt<Ye.length;++pt)for(let wt=0;wt<Ye[pt].length;++wt)Fi(ut,Ye[pt][wt]);return ut}function ws(Ye,ut,pt){if(ys(Ye)||ys(ut))return NaN;let wt=0,Tt=0;return Ye[2]<ut[0]&&(wt=ut[0]-Ye[2]),Ye[0]>ut[2]&&(wt=Ye[0]-ut[2]),Ye[1]>ut[3]&&(Tt=Ye[1]-ut[3]),Ye[3]<ut[1]&&(Tt=ut[1]-Ye[3]),pt.distance([0,0],[wt,Tt])}function Ms(Ye){return 360*Ye-180}function As(Ye){return 360/Math.PI*Math.atan(Math.exp((180-360*Ye)*Math.PI/180))-90}function Ss(Ye,ut){const pt=Math.pow(2,ut.z),wt=(Ye.y/ym+ut.y)/pt;return[Ms((Ye.x/ym+ut.x)/pt),As(wt)]}function Is(Ye,ut){const pt=[];for(let wt=0;wt<Ye.length;++wt)pt.push(Ss(Ye[wt],ut));return pt}function Ts(Ye,ut,pt){const wt=pt.pointOnLine(ut,Ye).point;return pt.distance(Ye,wt)}function ks(Ye,ut,pt,wt,Tt){const St=pt.slice(wt[0],wt[1]+1);let It=1/0;for(let pt=ut[0];pt<=ut[1];++pt)if(0===(It=Math.min(It,Ts(Ye[pt],St,Tt))))return 0;return It}function Ps(Ye,ut,pt,wt,Tt){const St=Math.min(Tt.pointToSegmentDistance(Ye,pt,wt),Tt.pointToSegmentDistance(ut,pt,wt)),It=Math.min(Tt.pointToSegmentDistance(pt,Ye,ut),Tt.pointToSegmentDistance(wt,Ye,ut));return Math.min(St,It)}function zs(Ye,ut,pt,wt,Tt){if(!xs(ut,Ye.length)||!xs(wt,pt.length))return NaN;let St=1/0;for(let It=ut[0];It<ut[1];++It)for(let ut=wt[0];ut<wt[1];++ut){if($i(Ye[It],Ye[It+1],pt[ut],pt[ut+1]))return 0;St=Math.min(St,Ps(Ye[It],Ye[It+1],pt[ut],pt[ut+1],Tt))}return St}function Es(Ye,ut,pt,wt,Tt){if(!xs(ut,Ye.length)||!xs(wt,pt.length))return NaN;let St=1/0;for(let It=ut[0];It<=ut[1];++It)for(let ut=wt[0];ut<=wt[1];++ut)if(0===(St=Math.min(St,Tt.distance(Ye[It],pt[ut]))))return St;return St}function Bs(Ye,ut,pt){if(ji(Ye,ut,!0))return 0;let wt=1/0;for(const Tt of ut){const ut=Tt.length;if(ut<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(Tt[0]!==Tt[ut-1]&&0===(wt=Math.min(wt,pt.pointToSegmentDistance(Ye,Tt[ut-1],Tt[0]))))return wt;if(0===(wt=Math.min(wt,Ts(Ye,Tt,pt))))return wt}return wt}function Ds(Ye,ut,pt,wt){if(!xs(ut,Ye.length))return NaN;for(let wt=ut[0];wt<=ut[1];++wt)if(ji(Ye[wt],pt,!0))return 0;let Tt=1/0;for(let St=ut[0];St<ut[1];++St)for(const ut of pt)for(let pt=0,It=ut.length,Lt=It-1;pt<It;Lt=pt++){if($i(Ye[St],Ye[St+1],ut[Lt],ut[pt]))return 0;Tt=Math.min(Tt,Ps(Ye[St],Ye[St+1],ut[Lt],ut[pt],wt))}return Tt}function Cs(Ye,ut){for(const pt of Ye)for(let Ye=0;Ye<=pt.length-1;++Ye)if(ji(pt[Ye],ut,!0))return!0;return!1}function Rs(Ye,ut,pt,wt=1/0){const Tt=_s(Ye),St=_s(ut);if(wt!==1/0&&ws(Tt,St,pt)>=wt)return wt;if(Ui(Tt,St)){if(Cs(Ye,ut))return 0}else if(Cs(ut,Ye))return 0;let It=wt;for(const wt of Ye)for(let Ye=0,Tt=wt.length,St=Tt-1;Ye<Tt;St=Ye++)for(const Tt of ut)for(let ut=0,Lt=Tt.length,$t=Lt-1;ut<Lt;$t=ut++){if($i(wt[St],wt[Ye],Tt[$t],Tt[ut]))return 0;It=Math.min(It,Ps(wt[St],wt[Ye],Tt[$t],Tt[ut],pt))}return It}function Vs(Ye,ut,pt,wt,Tt,St,It){if(null===St||null===It)return;const Lt=ws(vs(wt,St),vs(Tt,It),pt);Lt<ut&&Ye.push({dist:Lt,range1:St,range2:It})}function Ls(Ye,ut,pt,wt,Tt=1/0){let St=Math.min(wt.distance(Ye[0],pt[0][0]),Tt);if(0===St)return St;const It=new hs([{dist:0,range1:[0,Ye.length-1],range2:[0,0]}],fs),Lt=ut?Bm:Dm,$t=_s(pt);for(;It.length;){const Tt=It.pop();if(Tt.dist>=St)continue;const Xt=Tt.range1;if(gs(Xt)<=Lt){if(!xs(Xt,Ye.length))return NaN;if(ut){const ut=Ds(Ye,Xt,pt,wt);if(0===(St=Math.min(St,ut)))return St}else for(let ut=Xt[0];ut<=Xt[1];++ut){const Tt=Bs(Ye[ut],pt,wt);if(0===(St=Math.min(St,Tt)))return St}}else{const pt=bs(Xt,ut);if(null!==pt[0]){const ut=ws(vs(Ye,pt[0]),$t,wt);ut<St&&It.push({dist:ut,range1:pt[0],range2:[0,0]})}if(null!==pt[1]){const ut=ws(vs(Ye,pt[1]),$t,wt);ut<St&&It.push({dist:ut,range1:pt[1],range2:[0,0]})}}}return St}function Os(Ye,ut,pt,wt,Tt,St=1/0){let It=Math.min(St,Tt.distance(Ye[0],pt[0]));if(0===It)return It;const Lt=new hs([{dist:0,range1:[0,Ye.length-1],range2:[0,pt.length-1]}],fs),$t=ut?Bm:Dm,Xt=wt?Bm:Dm;for(;Lt.length;){const St=Lt.pop();if(St.dist>=It)continue;const Sr=St.range1,Lr=St.range2;if(gs(Sr)<=$t&&gs(Lr)<=Xt){if(!xs(Sr,Ye.length)||!xs(Lr,pt.length))return NaN;if(ut&&wt?It=Math.min(It,zs(Ye,Sr,pt,Lr,Tt)):ut||wt?ut&&!wt?It=Math.min(It,ks(pt,Lr,Ye,Sr,Tt)):!ut&&wt&&(It=Math.min(It,ks(Ye,Sr,pt,Lr,Tt))):It=Math.min(It,Es(Ye,Sr,pt,Lr,Tt)),0===It)return It}else{const St=bs(Sr,ut),$t=bs(Lr,wt);Vs(Lt,It,Tt,Ye,pt,St[0],$t[0]),Vs(Lt,It,Tt,Ye,pt,St[0],$t[1]),Vs(Lt,It,Tt,Ye,pt,St[1],$t[0]),Vs(Lt,It,Tt,Ye,pt,St[1],$t[1])}}return It}function Fs(Ye,ut,pt,wt,Tt=1/0){let St=Tt;const It=vs(Ye,[0,Ye.length-1]);for(const Tt of pt)if(!(St!==1/0&&ws(It,vs(Tt,[0,Tt.length-1]),wt)>=St)&&(St=Math.min(St,Os(Ye,ut,Tt,!0,wt,St)),0===St))return St;return St}function Us(Ye,ut,pt,wt,Tt=1/0){let St=Tt;const It=vs(Ye,[0,Ye.length-1]);for(const Tt of pt){if(St!==1/0&&ws(It,_s(Tt),wt)>=St)continue;const pt=Ls(Ye,ut,Tt,wt,St);if(isNaN(pt))return pt;if(0===(St=Math.min(St,pt)))return St}return St}function Ns(Ye){return"Point"===Ye||"MultiPoint"===Ye||"LineString"===Ye||"MultiLineString"===Ye||"Polygon"===Ye||"MultiPolygon"===Ye}class js{constructor(Ye,ut){this.type=hf,this.geojson=Ye,this.geometries=ut}static parse(Ye,ut){if(2!==Ye.length)return ut.error(`'distance' expression requires either one argument, but found ' ${Ye.length-1} instead.`);if(xi(Ye[1])){const ut=Ye[1];if("FeatureCollection"===ut.type){for(let Ye=0;Ye<ut.features.length;++Ye)if(Ns(ut.features[Ye].geometry.type))return new js(ut,ut.features[Ye].geometry)}else if("Feature"===ut.type){if(Ns(ut.geometry.type))return new js(ut,ut.geometry)}else if(Ns(ut.type))return new js(ut,ut)}return ut.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(Ye){const ut=Ye.geometry(),pt=Ye.canonicalID();if(null!=ut&&null!=pt){if("Point"===Ye.geometryType())return function(Ye,ut,pt){const wt=[];for(const pt of Ye)for(const Ye of pt)wt.push(Ss(Ye,ut));const Tt=new os(wt[0][1],"meters");return"Point"===pt.type||"MultiPoint"===pt.type||"LineString"===pt.type?Os(wt,!1,"Point"===pt.type?[pt.coordinates]:pt.coordinates,"LineString"===pt.type,Tt):"MultiLineString"===pt.type?Fs(wt,!1,pt.coordinates,Tt):"Polygon"===pt.type||"MultiPolygon"===pt.type?Us(wt,!1,"Polygon"===pt.type?[pt.coordinates]:pt.coordinates,Tt):null}(ut,pt,this.geometries);if("LineString"===Ye.geometryType())return function(Ye,ut,pt){const wt=[];for(const pt of Ye){const Ye=[];for(const wt of pt)Ye.push(Ss(wt,ut));wt.push(Ye)}const Tt=new os(wt[0][0][1],"meters");if("Point"===pt.type||"MultiPoint"===pt.type||"LineString"===pt.type)return Fs("Point"===pt.type?[pt.coordinates]:pt.coordinates,"LineString"===pt.type,wt,Tt);if("MultiLineString"===pt.type){let Ye=1/0;for(let ut=0;ut<pt.coordinates.length;ut++){const St=Fs(pt.coordinates[ut],!0,wt,Tt,Ye);if(isNaN(St))return St;if(0===(Ye=Math.min(Ye,St)))return Ye}return Ye}if("Polygon"===pt.type||"MultiPolygon"===pt.type){let Ye=1/0;for(let ut=0;ut<wt.length;ut++){const St=Us(wt[ut],!0,"Polygon"===pt.type?[pt.coordinates]:pt.coordinates,Tt,Ye);if(isNaN(St))return St;if(0===(Ye=Math.min(Ye,St)))return Ye}return Ye}return null}(ut,pt,this.geometries);if("Polygon"===Ye.geometryType())return function(Ye,ut,pt){const wt=[];for(const pt of function(Ye,ut){const pt=Ye.length;if(pt<=1)return[Ye];const wt=[];let Tt,St;for(let ut=0;ut<pt;ut++){const pt=Oi(Ye[ut]);0!==pt&&(Ye[ut].area=Math.abs(pt),void 0===St&&(St=pt<0),St===pt<0?(Tt&&wt.push(Tt),Tt=[Ye[ut]]):Tt.push(Ye[ut]))}return Tt&&wt.push(Tt),wt}(Ye)){const Ye=[];for(let wt=0;wt<pt.length;++wt)Ye.push(Is(pt[wt],ut));wt.push(Ye)}const Tt=new os(wt[0][0][0][1],"meters");if("Point"===pt.type||"MultiPoint"===pt.type||"LineString"===pt.type)return Us("Point"===pt.type?[pt.coordinates]:pt.coordinates,"LineString"===pt.type,wt,Tt);if("MultiLineString"===pt.type){let Ye=1/0;for(let ut=0;ut<pt.coordinates.length;ut++){const St=Us(pt.coordinates[ut],!0,wt,Tt,Ye);if(isNaN(St))return St;if(0===(Ye=Math.min(Ye,St)))return Ye}return Ye}return"Polygon"===pt.type||"MultiPolygon"===pt.type?function(Ye,ut,pt){let wt=1/0;for(const Tt of Ye)for(const Ye of ut){const ut=Rs(Tt,Ye,pt,wt);if(isNaN(ut))return ut;if(0===(wt=Math.min(wt,ut)))return wt}return wt}("Polygon"===pt.type?[pt.coordinates]:pt.coordinates,wt,Tt):null}(ut,pt,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function qs(Ye,ut){switch(Ye){case"string":return vi(ut);case"number":return+ut;case"boolean":return!!ut;case"color":return qn.parse(ut);case"formatted":return mi.fromString(vi(ut));case"resolvedImage":return yi.fromString(vi(ut))}return ut}function $s(Ye,ut,pt,wt){return void 0!==wt&&(Ye=wt*Math.round(Ye/wt)),void 0!==ut&&Ye<ut&&(Ye=ut),void 0!==pt&&Ye>pt&&(Ye=pt),Ye}class Gs{constructor(Ye,ut,pt){this.type=Ye,this.key=ut,this.scope=pt}static parse(Ye,ut){let pt=ut.expectedType;if(null==pt&&(pt=xf),Ye.length<2||Ye.length>3)return ut.error("Invalid number of arguments for 'config' expression.");const wt=ut.parse(Ye[1],1);if(!(wt instanceof _i))return ut.error("Key name of 'config' expression must be a string literal.");if(Ye.length>=3){const Tt=ut.parse(Ye[2],2);return Tt instanceof _i?new Gs(pt,vi(wt.value),vi(Tt.value)):ut.error("Scope of 'config' expression must be a string literal.")}return new Gs(pt,vi(wt.value))}evaluate(Ye){const ut=[this.key,this.scope,Ye.scope].filter(Boolean).join(""),pt=Ye.getConfig(ut);if(!pt)return null;const{type:wt,value:Tt,values:St,minValue:It,maxValue:Lt,stepValue:$t}=pt,Xt=pt.default.evaluate(Ye);let Sr=Xt;if(Tt){const ut=Ye.scope;Ye.scope=(ut||"").split("").slice(1).join(""),Sr=Tt.evaluate(Ye),Ye.scope=ut}return wt&&(Sr=qs(wt,Sr)),void 0===Sr||void 0===It&&void 0===Lt&&void 0===$t||("number"==typeof Sr?Sr=$s(Sr,It,Lt,$t):Array.isArray(Sr)&&(Sr=Sr.map((Ye=>"number"==typeof Ye?$s(Ye,It,Lt,$t):Ye)))),void 0!==Tt&&void 0!==Sr&&St&&!St.includes(Sr)&&(Sr=Xt,wt&&(Sr=qs(wt,Sr))),(wt&&wt!==this.type||void 0!==Sr&&bi(Sr)!==this.type)&&(Sr=qs(this.type.kind,Sr)),Sr}eachChild(){}outputDefined(){return!1}serialize(){const Ye=["config",this.key];return this.scope&&Ye.concat(this.key),Ye}}function Ys(Ye){if(Ye instanceof Bi){if("get"===Ye.name&&1===Ye.args.length)return!1;if("feature-state"===Ye.name)return!1;if("has"===Ye.name&&1===Ye.args.length)return!1;if("properties"===Ye.name||"geometry-type"===Ye.name||"id"===Ye.name)return!1;if(/^filter-/.test(Ye.name))return!1}if(Ye instanceof rs)return!1;if(Ye instanceof js)return!1;let ut=!0;return Ye.eachChild((Ye=>{ut&&!Ys(Ye)&&(ut=!1)})),ut}function Xs(Ye){if(Ye instanceof Bi&&"feature-state"===Ye.name)return!1;let ut=!0;return Ye.eachChild((Ye=>{ut&&!Xs(Ye)&&(ut=!1)})),ut}function Zs(Ye){if(Ye instanceof Gs)return!1;let ut=!0;return Ye.eachChild((Ye=>{ut&&!Zs(Ye)&&(ut=!1)})),ut}function Hs(Ye,ut){if(Ye instanceof Bi&&ut.indexOf(Ye.name)>=0)return!1;let pt=!0;return Ye.eachChild((Ye=>{pt&&!Hs(Ye,ut)&&(pt=!1)})),pt}class Ks{constructor(Ye,ut){this.type=ut.type,this.name=Ye,this.boundExpression=ut}static parse(Ye,ut){if(2!==Ye.length||"string"!=typeof Ye[1])return ut.error("'var' expression requires exactly one string literal argument.");const pt=Ye[1];return ut.scope.has(pt)?new Ks(pt,ut.scope.get(pt)):ut.error(`Unknown variable "${pt}". Make sure "${pt}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(Ye){return this.boundExpression.evaluate(Ye)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ws{constructor(Ye,ut=[],pt,wt=new Kn,Tt=[],St,It){this.registry=Ye,this.path=ut,this.key=ut.map((Ye=>`[${Ye}]`)).join(""),this.scope=wt,this.errors=Tt,this.expectedType=pt,this._scope=St,this.options=It}parse(Ye,ut,pt,wt,Tt={}){return ut||pt?this.concat(ut,pt,wt)._parse(Ye,Tt):this._parse(Ye,Tt)}_parse(Ye,ut){function r(Ye,ut,pt){return"assert"===pt?new Ai(ut,[Ye]):"coerce"===pt?new Pi(ut,[Ye]):Ye}if(null!==Ye&&"string"!=typeof Ye&&"boolean"!=typeof Ye&&"number"!=typeof Ye||(Ye=["literal",Ye]),Array.isArray(Ye)){if(0===Ye.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const pt="string"==typeof Ye[0]?this.registry[Ye[0]]:void 0;if(pt){let wt=pt.parse(Ye,this);if(!wt)return null;if(this.expectedType){const Ye=this.expectedType,pt=wt.type;if("string"!==Ye.kind&&"number"!==Ye.kind&&"boolean"!==Ye.kind&&"object"!==Ye.kind&&"array"!==Ye.kind||"value"!==pt.kind)if("color"!==Ye.kind&&"formatted"!==Ye.kind&&"resolvedImage"!==Ye.kind||"value"!==pt.kind&&"string"!==pt.kind){if(this.checkSubtype(Ye,pt))return null}else wt=r(wt,Ye,ut.typeAnnotation||"coerce");else wt=r(wt,Ye,ut.typeAnnotation||"assert")}if(!(wt instanceof _i)&&"resolvedImage"!==wt.type.kind&&Qs(wt)){const ut=new Ei(this._scope,this.options);try{wt=new _i(wt.type,wt.evaluate(ut))}catch(Ye){return this.error(Ye.message),null}}return wt}return Pi.parse(["to-array",Ye],this)}return this.error(void 0===Ye?"'undefined' value invalid. Use null instead.":"object"==typeof Ye?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof Ye} instead.`)}concat(Ye,ut,pt){const wt="number"==typeof Ye?this.path.concat(Ye):this.path,Tt=pt?this.scope.concat(pt):this.scope;return new Ws(this.registry,wt,ut||null,Tt,this.errors,this._scope,this.options)}error(Ye,...ut){const pt=`${this.key}${ut.map((Ye=>`[${Ye}]`)).join("")}`;this.errors.push(new Hn(pt,Ye))}checkSubtype(Ye,ut){const pt=ci(Ye,ut);return pt&&this.error(pt),pt}}var Fm=Ws;function Qs(Ye){if(Ye instanceof Ks)return Qs(Ye.boundExpression);if(Ye instanceof Bi&&"error"===Ye.name)return!1;if(Ye instanceof Ci)return!1;if(Ye instanceof rs)return!1;if(Ye instanceof js)return!1;if(Ye instanceof Gs)return!1;const ut=Ye instanceof Pi||Ye instanceof Ai;let pt=!0;return Ye.eachChild((Ye=>{pt=ut?pt&&Qs(Ye):pt&&Ye instanceof _i})),!!pt&&Ys(Ye)&&Hs(Ye,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function ta(Ye,ut){const pt=Ye.length-1;let wt,Tt,St=0,It=pt,Lt=0;for(;St<=It;)if(Lt=Math.floor((St+It)/2),wt=Ye[Lt],Tt=Ye[Lt+1],wt<=ut){if(Lt===pt||ut<Tt)return Lt;St=Lt+1}else{if(!(wt>ut))throw new wi("Input is not a number.");It=Lt-1}return 0}class ea{constructor(Ye,ut,pt){this.type=Ye,this.input=ut,this.labels=[],this.outputs=[];for(const[Ye,ut]of pt)this.labels.push(Ye),this.outputs.push(ut)}static parse(Ye,ut){if(Ye.length-1<4)return ut.error(`Expected at least 4 arguments, but found only ${Ye.length-1}.`);if((Ye.length-1)%2!=0)return ut.error("Expected an even number of arguments.");const pt=ut.parse(Ye[1],1,hf);if(!pt)return null;const wt=[];let Tt=null;ut.expectedType&&"value"!==ut.expectedType.kind&&(Tt=ut.expectedType);for(let pt=1;pt<Ye.length;pt+=2){const St=1===pt?-1/0:Ye[pt],It=Ye[pt+1],Lt=pt,$t=pt+1;if("number"!=typeof St)return ut.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',Lt);if(wt.length&&wt[wt.length-1][0]>=St)return ut.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',Lt);const Xt=ut.parse(It,$t,Tt);if(!Xt)return null;Tt=Tt||Xt.type,wt.push([St,Xt])}return new ea(Tt,pt,wt)}evaluate(Ye){const ut=this.labels,pt=this.outputs;if(1===ut.length)return pt[0].evaluate(Ye);const wt=this.input.evaluate(Ye);if(wt<=ut[0])return pt[0].evaluate(Ye);const Tt=ut.length;return wt>=ut[Tt-1]?pt[Tt-1].evaluate(Ye):pt[ta(ut,wt)].evaluate(Ye)}eachChild(Ye){Ye(this.input);for(const ut of this.outputs)Ye(ut)}outputDefined(){return this.outputs.every((Ye=>Ye.outputDefined()))}serialize(){const Ye=["step",this.input.serialize()];for(let ut=0;ut<this.labels.length;ut++)ut>0&&Ye.push(this.labels[ut]),Ye.push(this.outputs[ut].serialize());return Ye}}const Um=.95047,$m=1.08883,Hm=4/29,Ym=6/29,Qm=3*Ym*Ym,i_=Ym*Ym*Ym,s_=Math.PI/180,d_=180/Math.PI;function ca(Ye){return Ye>i_?Math.pow(Ye,1/3):Ye/Qm+Hm}function ha(Ye){return Ye>Ym?Ye*Ye*Ye:Qm*(Ye-Hm)}function pa(Ye){return 255*(Ye<=.0031308?12.92*Ye:1.055*Math.pow(Ye,1/2.4)-.055)}function fa(Ye){return(Ye/=255)<=.04045?Ye/12.92:Math.pow((Ye+.055)/1.055,2.4)}function da(Ye){const ut=fa(Ye.r),pt=fa(Ye.g),wt=fa(Ye.b),Tt=ca((.4124564*ut+.3575761*pt+.1804375*wt)/Um),St=ca((.2126729*ut+.7151522*pt+.072175*wt)/1);return{l:116*St-16,a:500*(Tt-St),b:200*(St-ca((.0193339*ut+.119192*pt+.9503041*wt)/$m)),alpha:Ye.a}}function ma(Ye){let ut=(Ye.l+16)/116,pt=isNaN(Ye.a)?ut:ut+Ye.a/500,wt=isNaN(Ye.b)?ut:ut-Ye.b/200;return ut=1*ha(ut),pt=Um*ha(pt),wt=$m*ha(wt),new qn(pa(3.2404542*pt-1.5371385*ut-.4985314*wt),pa(-.969266*pt+1.8760108*ut+.041556*wt),pa(.0556434*pt-.2040259*ut+1.0572252*wt),Ye.alpha)}function ya(Ye,ut,pt){const wt=ut-Ye;return Ye+pt*(wt>180||wt<-180?wt-360*Math.round(wt/360):wt)}const p_={forward:da,reverse:ma,interpolate:function(Ye,ut,pt){return{l:Gn(Ye.l,ut.l,pt),a:Gn(Ye.a,ut.a,pt),b:Gn(Ye.b,ut.b,pt),alpha:Gn(Ye.alpha,ut.alpha,pt)}}},f_={forward:function(Ye){const{l:ut,a:pt,b:wt}=da(Ye),Tt=Math.atan2(wt,pt)*d_;return{h:Tt<0?Tt+360:Tt,c:Math.sqrt(pt*pt+wt*wt),l:ut,alpha:Ye.a}},reverse:function(Ye){const ut=Ye.h*s_,pt=Ye.c;return ma({l:Ye.l,a:Math.cos(ut)*pt,b:Math.sin(ut)*pt,alpha:Ye.alpha})},interpolate:function(Ye,ut,pt){return{h:ya(Ye.h,ut.h,pt),c:Gn(Ye.c,ut.c,pt),l:Gn(Ye.l,ut.l,pt),alpha:Gn(Ye.alpha,ut.alpha,pt)}}};var m_=Object.freeze({__proto__:null,hcl:f_,lab:p_});class va{constructor(Ye,ut,pt,wt,Tt){this.type=Ye,this.operator=ut,this.interpolation=pt,this.input=wt,this.labels=[],this.outputs=[];for(const[Ye,ut]of Tt)this.labels.push(Ye),this.outputs.push(ut)}static interpolationFactor(Ye,ut,pt,wt){let Tt=0;if("exponential"===Ye.name)Tt=_a(ut,Ye.base,pt,wt);else if("linear"===Ye.name)Tt=_a(ut,1,pt,wt);else if("cubic-bezier"===Ye.name){const St=Ye.controlPoints;Tt=new Jh(St[0],St[1],St[2],St[3]).solve(_a(ut,1,pt,wt))}return Tt}static parse(Ye,ut){let[pt,wt,Tt,...St]=Ye;if(!Array.isArray(wt)||0===wt.length)return ut.error("Expected an interpolation type expression.",1);if("linear"===wt[0])wt={name:"linear"};else if("exponential"===wt[0]){const Ye=wt[1];if("number"!=typeof Ye)return ut.error("Exponential interpolation requires a numeric base.",1,1);wt={name:"exponential",base:Ye}}else{if("cubic-bezier"!==wt[0])return ut.error(`Unknown interpolation type ${String(wt[0])}`,1,0);{const Ye=wt.slice(1);if(4!==Ye.length||Ye.some((Ye=>"number"!=typeof Ye||Ye<0||Ye>1)))return ut.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);wt={name:"cubic-bezier",controlPoints:Ye}}}if(Ye.length-1<4)return ut.error(`Expected at least 4 arguments, but found only ${Ye.length-1}.`);if((Ye.length-1)%2!=0)return ut.error("Expected an even number of arguments.");if(Tt=ut.parse(Tt,2,hf),!Tt)return null;const It=[];let Lt=null;"interpolate-hcl"===pt||"interpolate-lab"===pt?Lt=pf:ut.expectedType&&"value"!==ut.expectedType.kind&&(Lt=ut.expectedType);for(let Ye=0;Ye<St.length;Ye+=2){const pt=St[Ye],wt=St[Ye+1],Tt=Ye+3,$t=Ye+4;if("number"!=typeof pt)return ut.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',Tt);if(It.length&&It[It.length-1][0]>=pt)return ut.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',Tt);const Xt=ut.parse(wt,$t,Lt);if(!Xt)return null;Lt=Lt||Xt.type,It.push([pt,Xt])}return"number"===Lt.kind||"color"===Lt.kind||"array"===Lt.kind&&"number"===Lt.itemType.kind&&"number"==typeof Lt.N?new va(Lt,pt,wt,Tt,It):ut.error(`Type ${li(Lt)} is not interpolatable.`)}evaluate(Ye){const ut=this.labels,pt=this.outputs;if(1===ut.length)return pt[0].evaluate(Ye);const wt=this.input.evaluate(Ye);if(wt<=ut[0])return pt[0].evaluate(Ye);const Tt=ut.length;if(wt>=ut[Tt-1])return pt[Tt-1].evaluate(Ye);const St=ta(ut,wt),It=va.interpolationFactor(this.interpolation,wt,ut[St],ut[St+1]),Lt=pt[St].evaluate(Ye),$t=pt[St+1].evaluate(Ye);return"interpolate"===this.operator?lf[this.type.kind.toLowerCase()](Lt,$t,It):"interpolate-hcl"===this.operator?f_.reverse(f_.interpolate(f_.forward(Lt),f_.forward($t),It)):p_.reverse(p_.interpolate(p_.forward(Lt),p_.forward($t),It))}eachChild(Ye){Ye(this.input);for(const ut of this.outputs)Ye(ut)}outputDefined(){return this.outputs.every((Ye=>Ye.outputDefined()))}serialize(){let Ye;Ye="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const ut=[this.operator,Ye,this.input.serialize()];for(let Ye=0;Ye<this.labels.length;Ye++)ut.push(this.labels[Ye],this.outputs[Ye].serialize());return ut}}function _a(Ye,ut,pt,wt){const Tt=wt-pt,St=Ye-pt;return 0===Tt?0:1===ut?St/Tt:(Math.pow(ut,St)-1)/(Math.pow(ut,Tt)-1)}class wa{constructor(Ye,ut){this.type=Ye,this.args=ut}static parse(Ye,ut){if(Ye.length<2)return ut.error("Expectected at least one argument.");let pt=null;const wt=ut.expectedType;wt&&"value"!==wt.kind&&(pt=wt);const Tt=[];for(const wt of Ye.slice(1)){const Ye=ut.parse(wt,1+Tt.length,pt,void 0,{typeAnnotation:"omit"});if(!Ye)return null;pt=pt||Ye.type,Tt.push(Ye)}const St=wt&&Tt.some((Ye=>ci(wt,Ye.type)));return new wa(St?xf:pt,Tt)}evaluate(Ye){let ut,pt=null,wt=0;for(const Tt of this.args){if(wt++,pt=Tt.evaluate(Ye),pt&&pt instanceof yi&&!pt.available&&(ut||(ut=pt),pt=null,wt===this.args.length))return ut;if(null!==pt)break}return pt}eachChild(Ye){this.args.forEach(Ye)}outputDefined(){return this.args.every((Ye=>Ye.outputDefined()))}serialize(){const Ye=["coalesce"];return this.eachChild((ut=>{Ye.push(ut.serialize())})),Ye}}class Ma{constructor(Ye,ut){this.type=ut.type,this.bindings=[].concat(Ye),this.result=ut}evaluate(Ye){return this.result.evaluate(Ye)}eachChild(Ye){for(const ut of this.bindings)Ye(ut[1]);Ye(this.result)}static parse(Ye,ut){if(Ye.length<4)return ut.error(`Expected at least 3 arguments, but found ${Ye.length-1} instead.`);const pt=[];for(let wt=1;wt<Ye.length-1;wt+=2){const Tt=Ye[wt];if("string"!=typeof Tt)return ut.error(`Expected string, but found ${typeof Tt} instead.`,wt);if(/[^a-zA-Z0-9_]/.test(Tt))return ut.error("Variable names must contain only alphanumeric characters or '_'.",wt);const St=ut.parse(Ye[wt+1],wt+1);if(!St)return null;pt.push([Tt,St])}const wt=ut.parse(Ye[Ye.length-1],Ye.length-1,ut.expectedType,pt);return wt?new Ma(pt,wt):null}outputDefined(){return this.result.outputDefined()}serialize(){const Ye=["let"];for(const[ut,pt]of this.bindings)Ye.push(ut,pt.serialize());return Ye.push(this.result.serialize()),Ye}}class Aa{constructor(Ye,ut,pt){this.type=Ye,this.index=ut,this.input=pt}static parse(Ye,ut){if(3!==Ye.length)return ut.error(`Expected 2 arguments, but found ${Ye.length-1} instead.`);const pt=ut.parse(Ye[1],1,hf),wt=ut.parse(Ye[2],2,oi(ut.expectedType||xf));return pt&&wt?new Aa(wt.type.itemType,pt,wt):null}evaluate(Ye){const ut=this.index.evaluate(Ye),pt=this.input.evaluate(Ye);if(ut<0)throw new wi(`Array index out of bounds: ${ut} < 0.`);if(ut>=pt.length)throw new wi(`Array index out of bounds: ${ut} > ${pt.length-1}.`);if(ut!==Math.floor(ut))throw new wi(`Array index must be an integer, but found ${ut} instead.`);return pt[ut]}eachChild(Ye){Ye(this.index),Ye(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Sa{constructor(Ye,ut){this.type=df,this.needle=Ye,this.haystack=ut}static parse(Ye,ut){if(3!==Ye.length)return ut.error(`Expected 2 arguments, but found ${Ye.length-1} instead.`);const pt=ut.parse(Ye[1],1,xf),wt=ut.parse(Ye[2],2,xf);return pt&&wt?hi(pt.type,[df,uf,hf,cf,xf])?new Sa(pt,wt):ut.error(`Expected first argument to be of type boolean, string, number or null, but found ${li(pt.type)} instead`):null}evaluate(Ye){const ut=this.needle.evaluate(Ye),pt=this.haystack.evaluate(Ye);if(null==pt)return!1;if(!pi(ut,["boolean","string","number","null"]))throw new wi(`Expected first argument to be of type boolean, string, number or null, but found ${li(bi(ut))} instead.`);if(!pi(pt,["string","array"]))throw new wi(`Expected second argument to be of type array or string, but found ${li(bi(pt))} instead.`);return pt.indexOf(ut)>=0}eachChild(Ye){Ye(this.needle),Ye(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Ia{constructor(Ye,ut,pt){this.type=hf,this.needle=Ye,this.haystack=ut,this.fromIndex=pt}static parse(Ye,ut){if(Ye.length<=2||Ye.length>=5)return ut.error(`Expected 3 or 4 arguments, but found ${Ye.length-1} instead.`);const pt=ut.parse(Ye[1],1,xf),wt=ut.parse(Ye[2],2,xf);if(!pt||!wt)return null;if(!hi(pt.type,[df,uf,hf,cf,xf]))return ut.error(`Expected first argument to be of type boolean, string, number or null, but found ${li(pt.type)} instead`);if(4===Ye.length){const Tt=ut.parse(Ye[3],3,hf);return Tt?new Ia(pt,wt,Tt):null}return new Ia(pt,wt)}evaluate(Ye){const ut=this.needle.evaluate(Ye),pt=this.haystack.evaluate(Ye);if(!pi(ut,["boolean","string","number","null"]))throw new wi(`Expected first argument to be of type boolean, string, number or null, but found ${li(bi(ut))} instead.`);if(!pi(pt,["string","array"]))throw new wi(`Expected second argument to be of type array or string, but found ${li(bi(pt))} instead.`);if(this.fromIndex){const wt=this.fromIndex.evaluate(Ye);return pt.indexOf(ut,wt)}return pt.indexOf(ut)}eachChild(Ye){Ye(this.needle),Ye(this.haystack),this.fromIndex&&Ye(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const Ye=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),Ye]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Ta{constructor(Ye,ut,pt,wt,Tt,St){this.inputType=Ye,this.type=ut,this.input=pt,this.cases=wt,this.outputs=Tt,this.otherwise=St}static parse(Ye,ut){if(Ye.length<5)return ut.error(`Expected at least 4 arguments, but found only ${Ye.length-1}.`);if(Ye.length%2!=1)return ut.error("Expected an even number of arguments.");let pt,wt;ut.expectedType&&"value"!==ut.expectedType.kind&&(wt=ut.expectedType);const Tt={},St=[];for(let It=2;It<Ye.length-1;It+=2){let Lt=Ye[It];const $t=Ye[It+1];Array.isArray(Lt)||(Lt=[Lt]);const Xt=ut.concat(It);if(0===Lt.length)return Xt.error("Expected at least one branch label.");for(const Ye of Lt){if("number"!=typeof Ye&&"string"!=typeof Ye)return Xt.error("Branch labels must be numbers or strings.");if("number"==typeof Ye&&Math.abs(Ye)>Number.MAX_SAFE_INTEGER)return Xt.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof Ye&&Math.floor(Ye)!==Ye)return Xt.error("Numeric branch labels must be integer values.");if(pt){if(Xt.checkSubtype(pt,bi(Ye)))return null}else pt=bi(Ye);if(void 0!==Tt[String(Ye)])return Xt.error("Branch labels must be unique.");Tt[String(Ye)]=St.length}const Sr=ut.parse($t,It,wt);if(!Sr)return null;wt=wt||Sr.type,St.push(Sr)}const It=ut.parse(Ye[1],1,xf);if(!It)return null;const Lt=ut.parse(Ye[Ye.length-1],Ye.length-1,wt);return Lt?"value"!==It.type.kind&&ut.concat(1).checkSubtype(pt,It.type)?null:new Ta(pt,wt,It,Tt,St,Lt):null}evaluate(Ye){const ut=this.input.evaluate(Ye);return(bi(ut)===this.inputType&&this.outputs[this.cases[ut]]||this.otherwise).evaluate(Ye)}eachChild(Ye){Ye(this.input),this.outputs.forEach(Ye),Ye(this.otherwise)}outputDefined(){return this.outputs.every((Ye=>Ye.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const Ye=["match",this.input.serialize()],ut=Object.keys(this.cases).sort(),pt=[],wt={};for(const Ye of ut){const ut=wt[this.cases[Ye]];void 0===ut?(wt[this.cases[Ye]]=pt.length,pt.push([this.cases[Ye],[Ye]])):pt[ut][1].push(Ye)}const i=Ye=>"number"===this.inputType.kind?Number(Ye):Ye;for(const[ut,wt]of pt)Ye.push(1===wt.length?i(wt[0]):wt.map(i)),Ye.push(this.outputs[ut].serialize());return Ye.push(this.otherwise.serialize()),Ye}}class ka{constructor(Ye,ut,pt){this.type=Ye,this.branches=ut,this.otherwise=pt}static parse(Ye,ut){if(Ye.length<4)return ut.error(`Expected at least 3 arguments, but found only ${Ye.length-1}.`);if(Ye.length%2!=0)return ut.error("Expected an odd number of arguments.");let pt;ut.expectedType&&"value"!==ut.expectedType.kind&&(pt=ut.expectedType);const wt=[];for(let Tt=1;Tt<Ye.length-1;Tt+=2){const St=ut.parse(Ye[Tt],Tt,df);if(!St)return null;const It=ut.parse(Ye[Tt+1],Tt+1,pt);if(!It)return null;wt.push([St,It]),pt=pt||It.type}const Tt=ut.parse(Ye[Ye.length-1],Ye.length-1,pt);return Tt?new ka(pt,wt,Tt):null}evaluate(Ye){for(const[ut,pt]of this.branches)if(ut.evaluate(Ye))return pt.evaluate(Ye);return this.otherwise.evaluate(Ye)}eachChild(Ye){for(const[ut,pt]of this.branches)Ye(ut),Ye(pt);Ye(this.otherwise)}outputDefined(){return this.branches.every((([Ye,ut])=>ut.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const Ye=["case"];return this.eachChild((ut=>{Ye.push(ut.serialize())})),Ye}}class Pa{constructor(Ye,ut,pt,wt){this.type=Ye,this.input=ut,this.beginIndex=pt,this.endIndex=wt}static parse(Ye,ut){if(Ye.length<=2||Ye.length>=5)return ut.error(`Expected 3 or 4 arguments, but found ${Ye.length-1} instead.`);const pt=ut.parse(Ye[1],1,xf),wt=ut.parse(Ye[2],2,hf);if(!pt||!wt)return null;if(!hi(pt.type,[oi(xf),uf,xf]))return ut.error(`Expected first argument to be of type array or string, but found ${li(pt.type)} instead`);if(4===Ye.length){const Tt=ut.parse(Ye[3],3,hf);return Tt?new Pa(pt.type,pt,wt,Tt):null}return new Pa(pt.type,pt,wt)}evaluate(Ye){const ut=this.input.evaluate(Ye),pt=this.beginIndex.evaluate(Ye);if(!pi(ut,["string","array"]))throw new wi(`Expected first argument to be of type array or string, but found ${li(bi(ut))} instead.`);if(this.endIndex){const wt=this.endIndex.evaluate(Ye);return ut.slice(pt,wt)}return ut.slice(pt)}eachChild(Ye){Ye(this.input),Ye(this.beginIndex),this.endIndex&&Ye(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const Ye=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),Ye]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function za(Ye,ut){return"=="===Ye||"!="===Ye?"boolean"===ut.kind||"string"===ut.kind||"number"===ut.kind||"null"===ut.kind||"value"===ut.kind:"string"===ut.kind||"number"===ut.kind||"value"===ut.kind}function Ea(Ye,ut,pt,wt){return 0===wt.compare(ut,pt)}function Ba(Ye,ut,pt){const wt="=="!==Ye&&"!="!==Ye;return class i{constructor(Ye,ut,pt){this.type=df,this.lhs=Ye,this.rhs=ut,this.collator=pt,this.hasUntypedArgument="value"===Ye.type.kind||"value"===ut.type.kind}static parse(Ye,ut){if(3!==Ye.length&&4!==Ye.length)return ut.error("Expected two or three arguments.");const pt=Ye[0];let Tt=ut.parse(Ye[1],1,xf);if(!Tt)return null;if(!za(pt,Tt.type))return ut.concat(1).error(`"${pt}" comparisons are not supported for type '${li(Tt.type)}'.`);let St=ut.parse(Ye[2],2,xf);if(!St)return null;if(!za(pt,St.type))return ut.concat(2).error(`"${pt}" comparisons are not supported for type '${li(St.type)}'.`);if(Tt.type.kind!==St.type.kind&&"value"!==Tt.type.kind&&"value"!==St.type.kind)return ut.error(`Cannot compare types '${li(Tt.type)}' and '${li(St.type)}'.`);wt&&("value"===Tt.type.kind&&"value"!==St.type.kind?Tt=new Ai(St.type,[Tt]):"value"!==Tt.type.kind&&"value"===St.type.kind&&(St=new Ai(Tt.type,[St])));let It=null;if(4===Ye.length){if("string"!==Tt.type.kind&&"string"!==St.type.kind&&"value"!==Tt.type.kind&&"value"!==St.type.kind)return ut.error("Cannot use collator to compare non-string types.");if(It=ut.parse(Ye[3],3,bf),!It)return null}return new i(Tt,St,It)}evaluate(Tt){const St=this.lhs.evaluate(Tt),It=this.rhs.evaluate(Tt);if(wt&&this.hasUntypedArgument){const ut=bi(St),pt=bi(It);if(ut.kind!==pt.kind||"string"!==ut.kind&&"number"!==ut.kind)throw new wi(`Expected arguments for "${Ye}" to be (string, string) or (number, number), but found (${ut.kind}, ${pt.kind}) instead.`)}if(this.collator&&!wt&&this.hasUntypedArgument){const Ye=bi(St),pt=bi(It);if("string"!==Ye.kind||"string"!==pt.kind)return ut(Tt,St,It)}return this.collator?pt(Tt,St,It,this.collator.evaluate(Tt)):ut(Tt,St,It)}eachChild(Ye){Ye(this.lhs),Ye(this.rhs),this.collator&&Ye(this.collator)}outputDefined(){return!0}serialize(){const ut=[Ye];return this.eachChild((Ye=>{ut.push(Ye.serialize())})),ut}}}const __=Ba("==",(function(Ye,ut,pt){return ut===pt}),Ea),g_=Ba("!=",(function(Ye,ut,pt){return ut!==pt}),(function(Ye,ut,pt,wt){return!Ea(0,ut,pt,wt)})),y_=Ba("<",(function(Ye,ut,pt){return ut<pt}),(function(Ye,ut,pt,wt){return wt.compare(ut,pt)<0})),x_=Ba(">",(function(Ye,ut,pt){return ut>pt}),(function(Ye,ut,pt,wt){return wt.compare(ut,pt)>0})),v_=Ba("<=",(function(Ye,ut,pt){return ut<=pt}),(function(Ye,ut,pt,wt){return wt.compare(ut,pt)<=0})),b_=Ba(">=",(function(Ye,ut,pt){return ut>=pt}),(function(Ye,ut,pt,wt){return wt.compare(ut,pt)>=0}));class Fa{constructor(Ye,ut,pt,wt,Tt,St){this.type=uf,this.number=Ye,this.locale=ut,this.currency=pt,this.unit=wt,this.minFractionDigits=Tt,this.maxFractionDigits=St}static parse(Ye,ut){if(3!==Ye.length)return ut.error("Expected two arguments.");const pt=ut.parse(Ye[1],1,hf);if(!pt)return null;const wt=Ye[2];if("object"!=typeof wt||Array.isArray(wt))return ut.error("NumberFormat options argument must be an object.");let Tt=null;if(wt.locale&&(Tt=ut.parse(wt.locale,1,uf),!Tt))return null;let St=null;if(wt.currency&&(St=ut.parse(wt.currency,1,uf),!St))return null;let It=null;if(wt.unit&&(It=ut.parse(wt.unit,1,uf),!It))return null;let Lt=null;if(wt["min-fraction-digits"]&&(Lt=ut.parse(wt["min-fraction-digits"],1,hf),!Lt))return null;let $t=null;return wt["max-fraction-digits"]&&($t=ut.parse(wt["max-fraction-digits"],1,hf),!$t)?null:new Fa(pt,Tt,St,It,Lt,$t)}evaluate(Ye){return new Intl.NumberFormat(this.locale?this.locale.evaluate(Ye):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(Ye):void 0,unit:this.unit?this.unit.evaluate(Ye):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(Ye):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(Ye):void 0}).format(this.number.evaluate(Ye))}eachChild(Ye){Ye(this.number),this.locale&&Ye(this.locale),this.currency&&Ye(this.currency),this.unit&&Ye(this.unit),this.minFractionDigits&&Ye(this.minFractionDigits),this.maxFractionDigits&&Ye(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const Ye={};return this.locale&&(Ye.locale=this.locale.serialize()),this.currency&&(Ye.currency=this.currency.serialize()),this.unit&&(Ye.unit=this.unit.serialize()),this.minFractionDigits&&(Ye["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(Ye["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),Ye]}}class Ua{constructor(Ye){this.type=hf,this.input=Ye}static parse(Ye,ut){if(2!==Ye.length)return ut.error(`Expected 1 argument, but found ${Ye.length-1} instead.`);const pt=ut.parse(Ye[1],1);return pt?"array"!==pt.type.kind&&"string"!==pt.type.kind&&"value"!==pt.type.kind?ut.error(`Expected argument of type string or array, but found ${li(pt.type)} instead.`):new Ua(pt):null}evaluate(Ye){const ut=this.input.evaluate(Ye);if("string"==typeof ut)return ut.length;if(Array.isArray(ut))return ut.length;throw new wi(`Expected value to be of type string or array, but found ${li(bi(ut))} instead.`)}eachChild(Ye){Ye(this.input)}outputDefined(){return!1}serialize(){const Ye=["length"];return this.eachChild((ut=>{Ye.push(ut.serialize())})),Ye}}function Na(Ye){return function(){Ye=1831565813+(Ye|=0)|0;let ut=Math.imul(Ye^Ye>>>15,1|Ye);return ut=ut+Math.imul(ut^ut>>>7,61|ut)^ut,((ut^ut>>>14)>>>0)/4294967296}}const w_={"==":__,"!=":g_,">":x_,"<":y_,">=":b_,"<=":v_,array:Ai,at:Aa,boolean:Ai,case:ka,coalesce:wa,collator:Ci,format:Si,image:Ii,in:Sa,"index-of":Ia,interpolate:va,"interpolate-hcl":va,"interpolate-lab":va,length:Ua,let:Ma,literal:_i,match:Ta,number:Ai,"number-format":Fa,object:Ai,slice:Pa,step:ea,string:Ai,"to-boolean":Pi,"to-color":Pi,"to-number":Pi,"to-string":Pi,var:Ks,within:rs,distance:js,config:Gs};function qa(Ye,[ut,pt,wt,Tt]){ut=ut.evaluate(Ye),pt=pt.evaluate(Ye),wt=wt.evaluate(Ye);const St=Tt?Tt.evaluate(Ye):1,It=gi(ut,pt,wt,St);if(It)throw new wi(It);return new qn(ut/255*St,pt/255*St,wt/255*St,St)}function $a(Ye,[ut,pt,wt,Tt]){ut=ut.evaluate(Ye),pt=pt.evaluate(Ye),wt=wt.evaluate(Ye);const St=Tt?Tt.evaluate(Ye):1,It=function(Ye,ut,pt,wt){return"number"==typeof Ye&&Ye>=0&&Ye<=360?"number"==typeof ut&&ut>=0&&ut<=100&&"number"==typeof pt&&pt>=0&&pt<=100?void 0===wt||"number"==typeof wt&&wt>=0&&wt<=1?null:`Invalid hsla value [${[Ye,ut,pt,wt].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof wt?[Ye,ut,pt,wt]:[Ye,ut,pt]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof wt?[Ye,ut,pt,wt]:[Ye,ut,pt]).join(", ")}]: 'h' must be between 0 and 360.`}(ut,pt,wt,St);if(It)throw new wi(It);const Lt=`hsla(${ut}, ${pt}%, ${wt}%, ${St})`,$t=qn.parse(Lt);if(!$t)throw new wi(`Failed to parse HSLA color: ${Lt}`);return $t}function Ga(Ye,ut){return Ye in ut}function Ya(Ye,ut){const pt=ut[Ye];return void 0===pt?null:pt}function Xa(Ye){return{type:Ye}}function Za(Ye){return{result:"success",value:Ye}}function Ha(Ye){return{result:"error",value:Ye}}function Ka(Ye,ut){return!!Ye&&!!Ye.parameters&&Ye.parameters.indexOf(ut)>-1}function Wa(Ye){return"data-driven"===Ye["property-type"]}function Ja(Ye){return Ka(Ye.expression,"measure-light")}function Qa(Ye){return Ka(Ye.expression,"zoom")}function to(Ye){return!!Ye.expression&&Ye.expression.interpolated}function eo(Ye){return"object"==typeof Ye&&null!==Ye&&!Array.isArray(Ye)}function ro(Ye){return Ye}function no(Ye,ut){const pt="color"===ut.type,wt=Ye.stops&&"object"==typeof Ye.stops[0][0],Tt=wt||!(wt||void 0!==Ye.property),St=Ye.type||(to(ut)?"exponential":"interval");if(pt&&((Ye=Zn({},Ye)).stops&&(Ye.stops=Ye.stops.map((Ye=>[Ye[0],qn.parse(Ye[1])]))),Ye.default=qn.parse(Ye.default?Ye.default:ut.default)),Ye.colorSpace&&"rgb"!==Ye.colorSpace&&!m_[Ye.colorSpace])throw new Error(`Unknown color space: ${Ye.colorSpace}`);let It,Lt,$t;if("exponential"===St)It=oo;else if("interval"===St)It=ao;else if("categorical"===St){It=so,Lt=Object.create(null);for(const ut of Ye.stops)Lt[ut[0]]=ut[1];$t=typeof Ye.stops[0][0]}else{if("identity"!==St)throw new Error(`Unknown function type "${St}"`);It=lo}if(wt){const pt={},wt=[];for(let ut=0;ut<Ye.stops.length;ut++){const Tt=Ye.stops[ut],St=Tt[0].zoom;void 0===pt[St]&&(pt[St]={zoom:St,type:Ye.type,property:Ye.property,default:Ye.default,stops:[]},wt.push(St)),pt[St].stops.push([Tt[0].value,Tt[1]])}const Tt=[];for(const Ye of wt)Tt.push([pt[Ye].zoom,no(pt[Ye],ut)]);const St={name:"linear"};return{kind:"composite",interpolationType:St,interpolationFactor:va.interpolationFactor.bind(void 0,St),zoomStops:Tt.map((Ye=>Ye[0])),evaluate:({zoom:pt},wt)=>oo({stops:Tt,base:Ye.base},ut,pt).evaluate(pt,wt)}}if(Tt){const pt="exponential"===St?{name:"exponential",base:void 0!==Ye.base?Ye.base:1}:null;return{kind:"camera",interpolationType:pt,interpolationFactor:va.interpolationFactor.bind(void 0,pt),zoomStops:Ye.stops.map((Ye=>Ye[0])),evaluate:({zoom:pt})=>It(Ye,ut,pt,Lt,$t)}}return{kind:"source",evaluate(pt,wt){const Tt=wt&&wt.properties?wt.properties[Ye.property]:void 0;return void 0===Tt?io(Ye.default,ut.default):It(Ye,ut,Tt,Lt,$t)}}}function io(Ye,ut,pt){return void 0!==Ye?Ye:void 0!==ut?ut:void 0!==pt?pt:void 0}function so(Ye,ut,pt,wt,Tt){return io(typeof pt===Tt?wt[pt]:void 0,Ye.default,ut.default)}function ao(Ye,ut,pt){if("number"!==Ti(pt))return io(Ye.default,ut.default);const wt=Ye.stops.length;if(1===wt)return Ye.stops[0][1];if(pt<=Ye.stops[0][0])return Ye.stops[0][1];if(pt>=Ye.stops[wt-1][0])return Ye.stops[wt-1][1];const Tt=ta(Ye.stops.map((Ye=>Ye[0])),pt);return Ye.stops[Tt][1]}function oo(Ye,ut,pt){const wt=void 0!==Ye.base?Ye.base:1;if("number"!==Ti(pt))return io(Ye.default,ut.default);const Tt=Ye.stops.length;if(1===Tt)return Ye.stops[0][1];if(pt<=Ye.stops[0][0])return Ye.stops[0][1];if(pt>=Ye.stops[Tt-1][0])return Ye.stops[Tt-1][1];const St=ta(Ye.stops.map((Ye=>Ye[0])),pt),It=function(Ye,ut,pt,wt){const Tt=wt-pt,St=Ye-pt;return 0===Tt?0:1===ut?St/Tt:(Math.pow(ut,St)-1)/(Math.pow(ut,Tt)-1)}(pt,wt,Ye.stops[St][0],Ye.stops[St+1][0]),Lt=Ye.stops[St][1],$t=Ye.stops[St+1][1];let Xt=lf[ut.type]||ro;if(Ye.colorSpace&&"rgb"!==Ye.colorSpace){const ut=m_[Ye.colorSpace];Xt=(Ye,pt)=>ut.reverse(ut.interpolate(ut.forward(Ye),ut.forward(pt),It))}return"function"==typeof Lt.evaluate?{evaluate(...Ye){const ut=Lt.evaluate.apply(void 0,Ye),pt=$t.evaluate.apply(void 0,Ye);if(void 0!==ut&&void 0!==pt)return Xt(ut,pt,It)}}:Xt(Lt,$t,It)}function lo(Ye,ut,pt){return"color"===ut.type?pt=qn.parse(pt):"formatted"===ut.type?pt=mi.fromString(pt.toString()):"resolvedImage"===ut.type?pt=yi.fromString(pt.toString()):Ti(pt)===ut.type||"enum"===ut.type&&ut.values[pt]||(pt=void 0),io(pt,Ye.default,ut.default)}Bi.register(w_,{error:[{kind:"error"},[uf],(Ye,[ut])=>{throw new wi(ut.evaluate(Ye))}],typeof:[uf,[xf],(Ye,[ut])=>li(bi(ut.evaluate(Ye)))],"to-rgba":[oi(hf,4),[pf],(Ye,[ut])=>ut.evaluate(Ye).toRenderColor(null).toArray()],rgb:[pf,[hf,hf,hf],qa],rgba:[pf,[hf,hf,hf,hf],qa],hsl:[pf,[hf,hf,hf],$a],hsla:[pf,[hf,hf,hf,hf],$a],has:{type:df,overloads:[[[uf],(Ye,[ut])=>Ga(ut.evaluate(Ye),Ye.properties())],[[uf,ff],(Ye,[ut,pt])=>Ga(ut.evaluate(Ye),pt.evaluate(Ye))]]},get:{type:xf,overloads:[[[uf],(Ye,[ut])=>Ya(ut.evaluate(Ye),Ye.properties())],[[uf,ff],(Ye,[ut,pt])=>Ya(ut.evaluate(Ye),pt.evaluate(Ye))]]},"feature-state":[xf,[uf],(Ye,[ut])=>Ya(ut.evaluate(Ye),Ye.featureState||{})],properties:[ff,[],Ye=>Ye.properties()],"geometry-type":[uf,[],Ye=>Ye.geometryType()],id:[xf,[],Ye=>Ye.id()],zoom:[hf,[],Ye=>Ye.globals.zoom],pitch:[hf,[],Ye=>Ye.globals.pitch||0],"distance-from-center":[hf,[],Ye=>Ye.distanceFromCenter()],"measure-light":[hf,[uf],(Ye,[ut])=>Ye.measureLight(ut.evaluate(Ye))],"heatmap-density":[hf,[],Ye=>Ye.globals.heatmapDensity||0],"line-progress":[hf,[],Ye=>Ye.globals.lineProgress||0],"raster-value":[hf,[],Ye=>Ye.globals.rasterValue||0],"raster-particle-speed":[hf,[],Ye=>Ye.globals.rasterParticleSpeed||0],"sky-radial-progress":[hf,[],Ye=>Ye.globals.skyRadialProgress||0],accumulated:[xf,[],Ye=>void 0===Ye.globals.accumulated?null:Ye.globals.accumulated],"+":[hf,Xa(hf),(Ye,ut)=>{let pt=0;for(const wt of ut)pt+=wt.evaluate(Ye);return pt}],"*":[hf,Xa(hf),(Ye,ut)=>{let pt=1;for(const wt of ut)pt*=wt.evaluate(Ye);return pt}],"-":{type:hf,overloads:[[[hf,hf],(Ye,[ut,pt])=>ut.evaluate(Ye)-pt.evaluate(Ye)],[[hf],(Ye,[ut])=>-ut.evaluate(Ye)]]},"/":[hf,[hf,hf],(Ye,[ut,pt])=>ut.evaluate(Ye)/pt.evaluate(Ye)],"%":[hf,[hf,hf],(Ye,[ut,pt])=>ut.evaluate(Ye)%pt.evaluate(Ye)],ln2:[hf,[],()=>Math.LN2],pi:[hf,[],()=>Math.PI],e:[hf,[],()=>Math.E],"^":[hf,[hf,hf],(Ye,[ut,pt])=>Math.pow(ut.evaluate(Ye),pt.evaluate(Ye))],sqrt:[hf,[hf],(Ye,[ut])=>Math.sqrt(ut.evaluate(Ye))],log10:[hf,[hf],(Ye,[ut])=>Math.log(ut.evaluate(Ye))/Math.LN10],ln:[hf,[hf],(Ye,[ut])=>Math.log(ut.evaluate(Ye))],log2:[hf,[hf],(Ye,[ut])=>Math.log(ut.evaluate(Ye))/Math.LN2],sin:[hf,[hf],(Ye,[ut])=>Math.sin(ut.evaluate(Ye))],cos:[hf,[hf],(Ye,[ut])=>Math.cos(ut.evaluate(Ye))],tan:[hf,[hf],(Ye,[ut])=>Math.tan(ut.evaluate(Ye))],asin:[hf,[hf],(Ye,[ut])=>Math.asin(ut.evaluate(Ye))],acos:[hf,[hf],(Ye,[ut])=>Math.acos(ut.evaluate(Ye))],atan:[hf,[hf],(Ye,[ut])=>Math.atan(ut.evaluate(Ye))],min:[hf,Xa(hf),(Ye,ut)=>Math.min(...ut.map((ut=>ut.evaluate(Ye))))],max:[hf,Xa(hf),(Ye,ut)=>Math.max(...ut.map((ut=>ut.evaluate(Ye))))],abs:[hf,[hf],(Ye,[ut])=>Math.abs(ut.evaluate(Ye))],round:[hf,[hf],(Ye,[ut])=>{const pt=ut.evaluate(Ye);return pt<0?-Math.round(-pt):Math.round(pt)}],floor:[hf,[hf],(Ye,[ut])=>Math.floor(ut.evaluate(Ye))],ceil:[hf,[hf],(Ye,[ut])=>Math.ceil(ut.evaluate(Ye))],"filter-==":[df,[uf,xf],(Ye,[ut,pt])=>Ye.properties()[ut.value]===pt.value],"filter-id-==":[df,[xf],(Ye,[ut])=>Ye.id()===ut.value],"filter-type-==":[df,[uf],(Ye,[ut])=>Ye.geometryType()===ut.value],"filter-<":[df,[uf,xf],(Ye,[ut,pt])=>{const wt=Ye.properties()[ut.value],Tt=pt.value;return typeof wt==typeof Tt&&wt<Tt}],"filter-id-<":[df,[xf],(Ye,[ut])=>{const pt=Ye.id(),wt=ut.value;return typeof pt==typeof wt&&pt<wt}],"filter->":[df,[uf,xf],(Ye,[ut,pt])=>{const wt=Ye.properties()[ut.value],Tt=pt.value;return typeof wt==typeof Tt&&wt>Tt}],"filter-id->":[df,[xf],(Ye,[ut])=>{const pt=Ye.id(),wt=ut.value;return typeof pt==typeof wt&&pt>wt}],"filter-<=":[df,[uf,xf],(Ye,[ut,pt])=>{const wt=Ye.properties()[ut.value],Tt=pt.value;return typeof wt==typeof Tt&&wt<=Tt}],"filter-id-<=":[df,[xf],(Ye,[ut])=>{const pt=Ye.id(),wt=ut.value;return typeof pt==typeof wt&&pt<=wt}],"filter->=":[df,[uf,xf],(Ye,[ut,pt])=>{const wt=Ye.properties()[ut.value],Tt=pt.value;return typeof wt==typeof Tt&&wt>=Tt}],"filter-id->=":[df,[xf],(Ye,[ut])=>{const pt=Ye.id(),wt=ut.value;return typeof pt==typeof wt&&pt>=wt}],"filter-has":[df,[xf],(Ye,[ut])=>ut.value in Ye.properties()],"filter-has-id":[df,[],Ye=>null!==Ye.id()&&void 0!==Ye.id()],"filter-type-in":[df,[oi(uf)],(Ye,[ut])=>ut.value.indexOf(Ye.geometryType())>=0],"filter-id-in":[df,[oi(xf)],(Ye,[ut])=>ut.value.indexOf(Ye.id())>=0],"filter-in-small":[df,[uf,oi(xf)],(Ye,[ut,pt])=>pt.value.indexOf(Ye.properties()[ut.value])>=0],"filter-in-large":[df,[uf,oi(xf)],(Ye,[ut,pt])=>function(Ye,ut,pt,wt){for(;pt<=wt;){const Tt=pt+wt>>1;if(ut[Tt]===Ye)return!0;ut[Tt]>Ye?wt=Tt-1:pt=Tt+1}return!1}(Ye.properties()[ut.value],pt.value,0,pt.value.length-1)],all:{type:df,overloads:[[[df,df],(Ye,[ut,pt])=>ut.evaluate(Ye)&&pt.evaluate(Ye)],[Xa(df),(Ye,ut)=>{for(const pt of ut)if(!pt.evaluate(Ye))return!1;return!0}]]},any:{type:df,overloads:[[[df,df],(Ye,[ut,pt])=>ut.evaluate(Ye)||pt.evaluate(Ye)],[Xa(df),(Ye,ut)=>{for(const pt of ut)if(pt.evaluate(Ye))return!0;return!1}]]},"!":[df,[df],(Ye,[ut])=>!ut.evaluate(Ye)],"is-supported-script":[df,[uf],(Ye,[ut])=>{const pt=Ye.globals&&Ye.globals.isSupportedScript;return!pt||pt(ut.evaluate(Ye))}],upcase:[uf,[uf],(Ye,[ut])=>ut.evaluate(Ye).toUpperCase()],downcase:[uf,[uf],(Ye,[ut])=>ut.evaluate(Ye).toLowerCase()],concat:[uf,Xa(xf),(Ye,ut)=>ut.map((ut=>vi(ut.evaluate(Ye)))).join("")],"resolved-locale":[uf,[bf],(Ye,[ut])=>ut.evaluate(Ye).resolvedLocale()],random:[hf,[hf,hf,xf],(Ye,ut)=>{const[pt,wt,Tt]=ut.map((ut=>ut.evaluate(Ye)));if(pt>wt)return pt;if(pt===wt)return pt;let St;if("string"==typeof Tt)St=function(Ye){let ut=0;if(0===Ye.length)return ut;for(let pt=0;pt<Ye.length;pt++)ut=(ut<<5)-ut+Ye.charCodeAt(pt),ut|=0;return ut}(Tt);else{if("number"!=typeof Tt)throw new wi(`Invalid seed input: ${Tt}`);St=Tt}return pt+Na(St)()*(wt-pt)}]});class uo{constructor(Ye,ut,pt,wt){this.expression=Ye,this._warningHistory={},this._evaluator=new Ei(pt,wt),this._defaultValue=ut?function(Ye){return"color"===Ye.type&&(eo(Ye.default)||Array.isArray(Ye.default))?new qn(0,0,0,0):"color"===Ye.type?qn.parse(Ye.default)||null:void 0===Ye.default?null:Ye.default}(ut):null,this._enumValues=ut&&"enum"===ut.type?ut.values:null}evaluateWithoutErrorHandling(Ye,ut,pt,wt,Tt,St,It,Lt){return this._evaluator.globals=Ye,this._evaluator.feature=ut,this._evaluator.featureState=pt,this._evaluator.canonical=wt||null,this._evaluator.availableImages=Tt||null,this._evaluator.formattedSection=St,this._evaluator.featureTileCoord=It||null,this._evaluator.featureDistanceData=Lt||null,this.expression.evaluate(this._evaluator)}evaluate(Ye,ut,pt,wt,Tt,St,It,Lt){this._evaluator.globals=Ye,this._evaluator.feature=ut||null,this._evaluator.featureState=pt||null,this._evaluator.canonical=wt||null,this._evaluator.availableImages=Tt||null,this._evaluator.formattedSection=St||null,this._evaluator.featureTileCoord=It||null,this._evaluator.featureDistanceData=Lt||null;try{const Ye=this.expression.evaluate(this._evaluator);if(null==Ye||"number"==typeof Ye&&Ye!=Ye)return this._defaultValue;if(this._enumValues&&!(Ye in this._enumValues))throw new wi(`Expected value to be one of ${Object.keys(this._enumValues).map((Ye=>JSON.stringify(Ye))).join(", ")}, but found ${JSON.stringify(Ye)} instead.`);return Ye}catch(Ye){return this._warningHistory[Ye.message]||(this._warningHistory[Ye.message]=!0,"undefined"!=typeof console&&console.warn(Ye.message)),this._defaultValue}}}function co(Ye){return Array.isArray(Ye)&&Ye.length>0&&"string"==typeof Ye[0]&&Ye[0]in w_}function ho(Ye,ut,pt,wt){const Tt=new Fm(w_,[],ut?function(Ye){const ut={color:pf,string:uf,number:hf,enum:uf,boolean:df,formatted:wf,resolvedImage:Af};return"array"===Ye.type?oi(ut[Ye.value]||xf,Ye.length):ut[Ye.type]}(ut):void 0,void 0,void 0,pt,wt),St=Tt.parse(Ye,void 0,void 0,void 0,ut&&"string"===ut.type?{typeAnnotation:"coerce"}:void 0);return St?Za(new uo(St,ut,pt,wt)):Ha(Tt.errors)}class po{constructor(Ye,ut,pt){this.kind=Ye,this._styleExpression=ut,this.isLightConstant=pt,this.isStateDependent="constant"!==Ye&&!Xs(ut.expression),this.isConfigDependent=!Zs(ut.expression)}evaluateWithoutErrorHandling(Ye,ut,pt,wt,Tt,St){return this._styleExpression.evaluateWithoutErrorHandling(Ye,ut,pt,wt,Tt,St)}evaluate(Ye,ut,pt,wt,Tt,St){return this._styleExpression.evaluate(Ye,ut,pt,wt,Tt,St)}}class fo{constructor(Ye,ut,pt,wt,Tt){this.kind=Ye,this.zoomStops=pt,this._styleExpression=ut,this.isStateDependent="camera"!==Ye&&!Xs(ut.expression),this.isLightConstant=Tt,this.isConfigDependent=!Zs(ut.expression),this.interpolationType=wt}evaluateWithoutErrorHandling(Ye,ut,pt,wt,Tt,St){return this._styleExpression.evaluateWithoutErrorHandling(Ye,ut,pt,wt,Tt,St)}evaluate(Ye,ut,pt,wt,Tt,St){return this._styleExpression.evaluate(Ye,ut,pt,wt,Tt,St)}interpolationFactor(Ye,ut,pt){return this.interpolationType?va.interpolationFactor(this.interpolationType,Ye,ut,pt):0}}function mo(Ye,ut,pt,wt){if("error"===(Ye=ho(Ye,ut,pt,wt)).result)return Ye;const Tt=Ye.value.expression,St=Ys(Tt);if(!St&&!Wa(ut))return Ha([new Hn("","data expressions not supported")]);const It=Hs(Tt,["zoom","pitch","distance-from-center"]);if(!It&&!Qa(ut))return Ha([new Hn("","zoom expressions not supported")]);const Lt=Hs(Tt,["measure-light"]);if(!Lt&&!Ja(ut))return Ha([new Hn("","measure-light expression not supported")]);const $t=ut.expression&&ut.expression.relaxZoomRestriction,Xt=go(Tt);return Xt||It||$t?Xt instanceof Hn?Ha([Xt]):Xt instanceof va&&!to(ut)?Ha([new Hn("",'"interpolate" expressions cannot be used with this property')]):Za(Xt?new fo(St?"camera":"composite",Ye.value,Xt.labels,Xt instanceof va?Xt.interpolation:void 0,Lt):new po(St?"constant":"source",Ye.value,Lt)):Ha([new Hn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class yo{constructor(Ye,ut){this._parameters=Ye,this._specification=ut,Zn(this,no(this._parameters,this._specification))}static deserialize(Ye){return new yo(Ye._parameters,Ye._specification)}static serialize(Ye){return{_parameters:Ye._parameters,_specification:Ye._specification}}}function go(Ye){let ut=null;if(Ye instanceof Ma)ut=go(Ye.result);else if(Ye instanceof wa){for(const pt of Ye.args)if(ut=go(pt),ut)break}else(Ye instanceof ea||Ye instanceof va)&&Ye.input instanceof Bi&&"zoom"===Ye.input.name&&(ut=Ye);return ut instanceof Hn||Ye.eachChild((Ye=>{const pt=go(Ye);pt instanceof Hn?ut=pt:ut&&pt&&ut!==pt&&(ut=new Hn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),ut}var T_=vo,E_=3;function vo(Ye,pt,wt){var Tt=(this||ut).cells=[];if(Ye instanceof ArrayBuffer){(this||ut).arrayBuffer=Ye;var St=new Int32Array((this||ut).arrayBuffer);Ye=St[0],(this||ut).d=(pt=St[1])+2*(wt=St[2]);for(var It=0;It<(this||ut).d*(this||ut).d;It++){var Lt=St[E_+It],$t=St[E_+It+1];Tt.push(Lt===$t?null:St.subarray(Lt,$t))}var Xt=St[E_+Tt.length+1];(this||ut).keys=St.subarray(St[E_+Tt.length],Xt),(this||ut).bboxes=St.subarray(Xt),(this||ut).insert=(this||ut)._insertReadonly}else{(this||ut).d=pt+2*wt;for(var Sr=0;Sr<(this||ut).d*(this||ut).d;Sr++)Tt.push([]);(this||ut).keys=[],(this||ut).bboxes=[]}(this||ut).n=pt,(this||ut).extent=Ye,(this||ut).padding=wt,(this||ut).scale=pt/Ye,(this||ut).uid=0;var Lr=wt/pt*Ye;(this||ut).min=-Lr,(this||ut).max=Ye+Lr}vo.prototype.insert=function(Ye,pt,wt,Tt,St){this._forEachCell(pt,wt,Tt,St,(this||ut)._insertCell,(this||ut).uid++),(this||ut).keys.push(Ye),(this||ut).bboxes.push(pt),(this||ut).bboxes.push(wt),(this||ut).bboxes.push(Tt),(this||ut).bboxes.push(St)},vo.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},vo.prototype._insertCell=function(Ye,pt,wt,Tt,St,It){(this||ut).cells[St].push(It)},vo.prototype.query=function(Ye,pt,wt,Tt,St){var It=(this||ut).min,Lt=(this||ut).max;if(Ye<=It&&pt<=It&&Lt<=wt&&Lt<=Tt&&!St)return Array.prototype.slice.call((this||ut).keys);var $t=[];return this._forEachCell(Ye,pt,wt,Tt,(this||ut)._queryCell,$t,{},St),$t},vo.prototype._queryCell=function(Ye,pt,wt,Tt,St,It,Lt,$t){var Xt=(this||ut).cells[St];if(null!==Xt)for(var Sr=(this||ut).keys,Lr=(this||ut).bboxes,Qr=0;Qr<Xt.length;Qr++){var fn=Xt[Qr];if(void 0===Lt[fn]){var xn=4*fn;($t?$t(Lr[xn+0],Lr[xn+1],Lr[xn+2],Lr[xn+3]):Ye<=Lr[xn+2]&&pt<=Lr[xn+3]&&wt>=Lr[xn+0]&&Tt>=Lr[xn+1])?(Lt[fn]=!0,It.push(Sr[fn])):Lt[fn]=!1}}},vo.prototype._forEachCell=function(Ye,pt,wt,Tt,St,It,Lt,$t){for(var Xt=this._convertToCellCoord(Ye),Sr=this._convertToCellCoord(pt),Lr=this._convertToCellCoord(wt),Qr=this._convertToCellCoord(Tt),fn=Xt;fn<=Lr;fn++)for(var xn=Sr;xn<=Qr;xn++){var vn=(this||ut).d*xn+fn;if((!$t||$t(this._convertFromCellCoord(fn),this._convertFromCellCoord(xn),this._convertFromCellCoord(fn+1),this._convertFromCellCoord(xn+1)))&&St.call(this||ut,Ye,pt,wt,Tt,vn,It,Lt,$t))return}},vo.prototype._convertFromCellCoord=function(Ye){return(Ye-(this||ut).padding)/(this||ut).scale},vo.prototype._convertToCellCoord=function(Ye){return Math.max(0,Math.min((this||ut).d-1,Math.floor(Ye*(this||ut).scale)+(this||ut).padding))},vo.prototype.toArrayBuffer=function(){if((this||ut).arrayBuffer)return(this||ut).arrayBuffer;for(var Ye=(this||ut).cells,pt=E_+(this||ut).cells.length+1+1,wt=0,Tt=0;Tt<(this||ut).cells.length;Tt++)wt+=(this||ut).cells[Tt].length;var St=new Int32Array(pt+wt+(this||ut).keys.length+(this||ut).bboxes.length);St[0]=(this||ut).extent,St[1]=(this||ut).n,St[2]=(this||ut).padding;for(var It=pt,Lt=0;Lt<Ye.length;Lt++){var $t=Ye[Lt];St[E_+Lt]=It,St.set($t,It),It+=$t.length}return St[E_+Ye.length]=It,St.set((this||ut).keys,It),St[E_+Ye.length+1]=It+=(this||ut).keys.length,St.set((this||ut).bboxes,It),It+=(this||ut).bboxes.length,St.buffer};var M_=p(T_);const A_={};function Mo(Ye,ut,pt={}){Object.defineProperty(Ye,"_classRegistryKey",{value:ut,writable:!1}),A_[ut]={klass:Ye,omit:pt.omit||[]}}Mo(Object,"Object"),M_.serialize=function(Ye,ut){const pt=Ye.toArrayBuffer();return ut&&ut.add(pt),{buffer:pt}},M_.deserialize=function(Ye){return new M_(Ye.buffer)},Object.defineProperty(M_,"name",{value:"Grid"}),Mo(M_,"Grid"),Mo(qn,"Color"),Mo(Error,"Error"),Mo(mi,"Formatted"),Mo(di,"FormattedSection"),Mo(Jr,"AJAXError"),Mo(yi,"ResolvedImage"),Mo(yo,"StylePropertyFunction"),Mo(uo,"StyleExpression",{omit:["_evaluator"]}),Mo(fo,"ZoomDependentExpression"),Mo(po,"ZoomConstantExpression"),Mo(Bi,"CompoundExpression",{omit:["_evaluate"]});for(const Ye in w_)A_[w_[Ye]._classRegistryKey]||Mo(w_[Ye],`Expression${Ye}`);function Ao(Ye){return Ye&&"undefined"!=typeof ArrayBuffer&&(Ye instanceof ArrayBuffer||Ye.constructor&&"ArrayBuffer"===Ye.constructor.name)}function So(Ye){return self.ImageBitmap&&Ye instanceof ImageBitmap}function Io(Ye,ut){if(null==Ye||"boolean"==typeof Ye||"number"==typeof Ye||"string"==typeof Ye||Ye instanceof Boolean||Ye instanceof Number||Ye instanceof String||Ye instanceof Date||Ye instanceof RegExp)return Ye;if(Ao(Ye)||So(Ye))return ut&&ut.add(Ye),Ye;if(ArrayBuffer.isView(Ye)){const pt=Ye;return ut&&ut.add(pt.buffer),pt}if(Ye instanceof ImageData)return ut&&ut.add(Ye.data.buffer),Ye;if(Array.isArray(Ye)){const pt=[];for(const wt of Ye)pt.push(Io(wt,ut));return pt}if(Ye instanceof Map){const ut={$name:"Map"};for(const[pt,wt]of Ye.entries())ut[pt]=Io(wt);return ut}if("object"==typeof Ye){const pt=Ye.constructor,wt=pt._classRegistryKey;if(!wt)throw new Error(`can't serialize object of unregistered class ${wt}`);const Tt=pt.serialize?pt.serialize(Ye,ut):{};if(!pt.serialize){for(const pt in Ye)Ye.hasOwnProperty(pt)&&(A_[wt].omit.indexOf(pt)>=0||(Tt[pt]=Io(Ye[pt],ut)));Ye instanceof Error&&(Tt.message=Ye.message)}if(Tt.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==wt&&(Tt.$name=wt),Tt}throw new Error("can't serialize object of type "+typeof Ye)}function To(Ye){if(null==Ye||"boolean"==typeof Ye||"number"==typeof Ye||"string"==typeof Ye||Ye instanceof Boolean||Ye instanceof Number||Ye instanceof String||Ye instanceof Date||Ye instanceof RegExp||Ao(Ye)||So(Ye)||ArrayBuffer.isView(Ye)||Ye instanceof ImageData)return Ye;if(Array.isArray(Ye))return Ye.map(To);if("object"==typeof Ye){const ut=Ye.$name||"Object";if("Map"===ut){const ut=new Map;for(const pt of Object.keys(Ye))"$name"!==pt&&ut.set(pt,To(Ye[pt]));return ut}const{klass:pt}=A_[ut];if(!pt)throw new Error(`can't deserialize unregistered class ${ut}`);if(pt.deserialize)return pt.deserialize(Ye);const wt=Object.create(pt.prototype);for(const ut of Object.keys(Ye))"$name"!==ut&&(wt[ut]=To(Ye[ut]));return wt}throw new Error("can't deserialize object of type "+typeof Ye)}const S_={"Latin-1 Supplement":Ye=>Ye>=128&&Ye<=255,Arabic:Ye=>Ye>=1536&&Ye<=1791,"Arabic Supplement":Ye=>Ye>=1872&&Ye<=1919,"Arabic Extended-A":Ye=>Ye>=2208&&Ye<=2303,"Hangul Jamo":Ye=>Ye>=4352&&Ye<=4607,"Unified Canadian Aboriginal Syllabics":Ye=>Ye>=5120&&Ye<=5759,Khmer:Ye=>Ye>=6016&&Ye<=6143,"Unified Canadian Aboriginal Syllabics Extended":Ye=>Ye>=6320&&Ye<=6399,"General Punctuation":Ye=>Ye>=8192&&Ye<=8303,"Letterlike Symbols":Ye=>Ye>=8448&&Ye<=8527,"Number Forms":Ye=>Ye>=8528&&Ye<=8591,"Miscellaneous Technical":Ye=>Ye>=8960&&Ye<=9215,"Control Pictures":Ye=>Ye>=9216&&Ye<=9279,"Optical Character Recognition":Ye=>Ye>=9280&&Ye<=9311,"Enclosed Alphanumerics":Ye=>Ye>=9312&&Ye<=9471,"Geometric Shapes":Ye=>Ye>=9632&&Ye<=9727,"Miscellaneous Symbols":Ye=>Ye>=9728&&Ye<=9983,"Miscellaneous Symbols and Arrows":Ye=>Ye>=11008&&Ye<=11263,"CJK Radicals Supplement":Ye=>Ye>=11904&&Ye<=12031,"Kangxi Radicals":Ye=>Ye>=12032&&Ye<=12255,"Ideographic Description Characters":Ye=>Ye>=12272&&Ye<=12287,"CJK Symbols and Punctuation":Ye=>Ye>=12288&&Ye<=12351,Hiragana:Ye=>Ye>=12352&&Ye<=12447,Katakana:Ye=>Ye>=12448&&Ye<=12543,Bopomofo:Ye=>Ye>=12544&&Ye<=12591,"Hangul Compatibility Jamo":Ye=>Ye>=12592&&Ye<=12687,Kanbun:Ye=>Ye>=12688&&Ye<=12703,"Bopomofo Extended":Ye=>Ye>=12704&&Ye<=12735,"CJK Strokes":Ye=>Ye>=12736&&Ye<=12783,"Katakana Phonetic Extensions":Ye=>Ye>=12784&&Ye<=12799,"Enclosed CJK Letters and Months":Ye=>Ye>=12800&&Ye<=13055,"CJK Compatibility":Ye=>Ye>=13056&&Ye<=13311,"CJK Unified Ideographs Extension A":Ye=>Ye>=13312&&Ye<=19903,"Yijing Hexagram Symbols":Ye=>Ye>=19904&&Ye<=19967,"CJK Unified Ideographs":Ye=>Ye>=19968&&Ye<=40959,"Yi Syllables":Ye=>Ye>=40960&&Ye<=42127,"Yi Radicals":Ye=>Ye>=42128&&Ye<=42191,"Hangul Jamo Extended-A":Ye=>Ye>=43360&&Ye<=43391,"Hangul Syllables":Ye=>Ye>=44032&&Ye<=55215,"Hangul Jamo Extended-B":Ye=>Ye>=55216&&Ye<=55295,"Private Use Area":Ye=>Ye>=57344&&Ye<=63743,"CJK Compatibility Ideographs":Ye=>Ye>=63744&&Ye<=64255,"Arabic Presentation Forms-A":Ye=>Ye>=64336&&Ye<=65023,"Vertical Forms":Ye=>Ye>=65040&&Ye<=65055,"CJK Compatibility Forms":Ye=>Ye>=65072&&Ye<=65103,"Small Form Variants":Ye=>Ye>=65104&&Ye<=65135,"Arabic Presentation Forms-B":Ye=>Ye>=65136&&Ye<=65279,"Halfwidth and Fullwidth Forms":Ye=>Ye>=65280&&Ye<=65519,"CJK Unified Ideographs Extension B":Ye=>Ye>=131072&&Ye<=173791};function Po(Ye){for(const ut of Ye)if(Bo(ut.charCodeAt(0)))return!0;return!1}function zo(Ye){for(const ut of Ye)if(!Eo(ut.charCodeAt(0)))return!1;return!0}function Eo(Ye){return!(S_.Arabic(Ye)||S_["Arabic Supplement"](Ye)||S_["Arabic Extended-A"](Ye)||S_["Arabic Presentation Forms-A"](Ye)||S_["Arabic Presentation Forms-B"](Ye))}function Bo(Ye){return!(746!==Ye&&747!==Ye&&(Ye<4352||!(S_["Bopomofo Extended"](Ye)||S_.Bopomofo(Ye)||S_["CJK Compatibility Forms"](Ye)&&!(Ye>=65097&&Ye<=65103)||S_["CJK Compatibility Ideographs"](Ye)||S_["CJK Compatibility"](Ye)||S_["CJK Radicals Supplement"](Ye)||S_["CJK Strokes"](Ye)||!(!S_["CJK Symbols and Punctuation"](Ye)||Ye>=12296&&Ye<=12305||Ye>=12308&&Ye<=12319||12336===Ye)||S_["CJK Unified Ideographs Extension A"](Ye)||S_["CJK Unified Ideographs"](Ye)||S_["Enclosed CJK Letters and Months"](Ye)||S_["Hangul Compatibility Jamo"](Ye)||S_["Hangul Jamo Extended-A"](Ye)||S_["Hangul Jamo Extended-B"](Ye)||S_["Hangul Jamo"](Ye)||S_["Hangul Syllables"](Ye)||S_.Hiragana(Ye)||S_["Ideographic Description Characters"](Ye)||S_.Kanbun(Ye)||S_["Kangxi Radicals"](Ye)||S_["Katakana Phonetic Extensions"](Ye)||S_.Katakana(Ye)&&12540!==Ye||!(!S_["Halfwidth and Fullwidth Forms"](Ye)||65288===Ye||65289===Ye||65293===Ye||Ye>=65306&&Ye<=65310||65339===Ye||65341===Ye||65343===Ye||Ye>=65371&&Ye<=65503||65507===Ye||Ye>=65512&&Ye<=65519)||!(!S_["Small Form Variants"](Ye)||Ye>=65112&&Ye<=65118||Ye>=65123&&Ye<=65126)||S_["Unified Canadian Aboriginal Syllabics"](Ye)||S_["Unified Canadian Aboriginal Syllabics Extended"](Ye)||S_["Vertical Forms"](Ye)||S_["Yijing Hexagram Symbols"](Ye)||S_["Yi Syllables"](Ye)||S_["Yi Radicals"](Ye))))}function Do(Ye){return!(Bo(Ye)||function(Ye){return!!(S_["Latin-1 Supplement"](Ye)&&(167===Ye||169===Ye||174===Ye||177===Ye||188===Ye||189===Ye||190===Ye||215===Ye||247===Ye)||S_["General Punctuation"](Ye)&&(8214===Ye||8224===Ye||8225===Ye||8240===Ye||8241===Ye||8251===Ye||8252===Ye||8258===Ye||8263===Ye||8264===Ye||8265===Ye||8273===Ye)||S_["Letterlike Symbols"](Ye)||S_["Number Forms"](Ye)||S_["Miscellaneous Technical"](Ye)&&(Ye>=8960&&Ye<=8967||Ye>=8972&&Ye<=8991||Ye>=8996&&Ye<=9e3||9003===Ye||Ye>=9085&&Ye<=9114||Ye>=9150&&Ye<=9165||9167===Ye||Ye>=9169&&Ye<=9179||Ye>=9186&&Ye<=9215)||S_["Control Pictures"](Ye)&&9251!==Ye||S_["Optical Character Recognition"](Ye)||S_["Enclosed Alphanumerics"](Ye)||S_["Geometric Shapes"](Ye)||S_["Miscellaneous Symbols"](Ye)&&!(Ye>=9754&&Ye<=9759)||S_["Miscellaneous Symbols and Arrows"](Ye)&&(Ye>=11026&&Ye<=11055||Ye>=11088&&Ye<=11097||Ye>=11192&&Ye<=11243)||S_["CJK Symbols and Punctuation"](Ye)||S_.Katakana(Ye)||S_["Private Use Area"](Ye)||S_["CJK Compatibility Forms"](Ye)||S_["Small Form Variants"](Ye)||S_["Halfwidth and Fullwidth Forms"](Ye)||8734===Ye||8756===Ye||8757===Ye||Ye>=9984&&Ye<=10087||Ye>=10102&&Ye<=10131||65532===Ye||65533===Ye)}(Ye))}function Co(Ye){return Ye>=1424&&Ye<=2303||S_["Arabic Presentation Forms-A"](Ye)||S_["Arabic Presentation Forms-B"](Ye)}function Ro(Ye,ut){return!(!ut&&Co(Ye)||Ye>=2304&&Ye<=3583||Ye>=3840&&Ye<=4255||S_.Khmer(Ye))}function Vo(Ye){for(const ut of Ye)if(Co(ut.charCodeAt(0)))return!0;return!1}const I_="deferred",C_="loading",P_="loaded";let z_=null,D_="unavailable",R_=null;const qo=function(Ye){Ye&&"string"==typeof Ye&&Ye.indexOf("NetworkError")>-1&&(D_="error"),z_&&z_(Ye)};function $o(){L_.fire(new Dn("pluginStateChange",{pluginStatus:D_,pluginURL:R_}))}const L_=new Ln,Yo=function(){return D_},Xo=function(){if(D_!==I_||!R_)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");D_=C_,$o(),R_&&en({url:R_},(Ye=>{Ye?qo(Ye):(D_=P_,$o())}))},k_={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>D_===P_||null!=k_.applyArabicShaping,isLoading:()=>D_===C_,setState(Ye){D_=Ye.pluginStatus,R_=Ye.pluginURL},isParsed:()=>null!=k_.applyArabicShaping&&null!=k_.processBidirectionalText&&null!=k_.processStyledBidirectionalText,getPluginURL:()=>R_};class Ho{constructor(Ye,ut){this.zoom=Ye,ut?(this.now=ut.now,this.fadeDuration=ut.fadeDuration,this.transition=ut.transition,this.pitch=ut.pitch,this.brightness=ut.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(Ye){return function(Ye,ut){for(const pt of Ye)if(!Ro(pt.charCodeAt(0),ut))return!1;return!0}(Ye,k_.isLoaded())}}class Ko{constructor(Ye,ut,pt,wt){this.property=Ye,this.value=ut,this.expression=function(Ye,ut,pt,wt){if(eo(Ye))return new yo(Ye,ut);if(co(Ye)||Array.isArray(Ye)&&Ye.length>0){const Tt=mo(Ye,ut,pt,wt);if("error"===Tt.result)throw new Error(Tt.value.map((Ye=>`${Ye.key}: ${Ye.message}`)).join(", "));return Tt.value}{let pt=Ye;return"string"==typeof Ye&&"color"===ut.type&&(pt=qn.parse(Ye)),{kind:"constant",isConfigDependent:!1,evaluate:()=>pt}}}(void 0===ut?Ye.specification.default:ut,Ye.specification,pt,wt)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(Ye,ut,pt){return this.property.possiblyEvaluate(this,Ye,ut,pt)}}class Wo{constructor(Ye,ut,pt){this.property=Ye,this.value=new Ko(Ye,void 0,ut,pt)}transitioned(Ye,ut){return new Qo(this.property,this.value,ut,er({},Ye.transition,this.transition),Ye.now)}untransitioned(){return new Qo(this.property,this.value,null,{},0)}}class Jo{constructor(Ye,ut,pt){this._properties=Ye,this._values=Object.create(Ye.defaultTransitionablePropertyValues),this._scope=ut,this._options=pt,this.isConfigDependent=!1}getValue(Ye){return hr(this._values[Ye].value.value)}setValue(Ye,ut){this._values.hasOwnProperty(Ye)||(this._values[Ye]=new Wo(this._values[Ye].property,this._scope,this._options)),this._values[Ye].value=new Ko(this._values[Ye].property,null===ut?void 0:hr(ut),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[Ye].value.expression.isConfigDependent}setTransitionOrValue(Ye,ut){ut&&(this._options=ut);const pt=this._properties.properties;if(Ye)for(const ut in Ye){const wt=Ye[ut];if(lr(ut,"-transition")){const Ye=ut.slice(0,-11);pt[Ye]&&this.setTransition(Ye,wt)}else pt.hasOwnProperty(ut)&&this.setValue(ut,wt)}}getTransition(Ye){return hr(this._values[Ye].transition)}setTransition(Ye,ut){this._values.hasOwnProperty(Ye)||(this._values[Ye]=new Wo(this._values[Ye].property)),this._values[Ye].transition=hr(ut)||void 0}serialize(){const Ye={};for(const ut of Object.keys(this._values)){const pt=this.getValue(ut);void 0!==pt&&(Ye[ut]=pt);const wt=this.getTransition(ut);void 0!==wt&&(Ye[`${ut}-transition`]=wt)}return Ye}transitioned(Ye,ut){const pt=new tl(this._properties);for(const wt of Object.keys(this._values))pt._values[wt]=this._values[wt].transitioned(Ye,ut._values[wt]);return pt}untransitioned(){const Ye=new tl(this._properties);for(const ut of Object.keys(this._values))Ye._values[ut]=this._values[ut].untransitioned();return Ye}}class Qo{constructor(Ye,ut,pt,wt,Tt){const St=wt.delay||0,It=wt.duration||0;Tt=Tt||0,this.property=Ye,this.value=ut,this.begin=Tt+St,this.end=this.begin+It,Ye.specification.transition&&(wt.delay||wt.duration)&&(this.prior=pt)}possiblyEvaluate(Ye,ut,pt){const wt=Ye.now||0,Tt=this.value.possiblyEvaluate(Ye,ut,pt),St=this.prior;if(St){if(wt>this.end)return this.prior=null,Tt;if(this.value.isDataDriven())return this.prior=null,Tt;if(wt<this.begin)return St.possiblyEvaluate(Ye,ut,pt);{const It=(wt-this.begin)/(this.end-this.begin);return this.property.interpolate(St.possiblyEvaluate(Ye,ut,pt),Tt,Xe(It))}}return Tt}}class tl{constructor(Ye){this._properties=Ye,this._values=Object.create(Ye.defaultTransitioningPropertyValues)}possiblyEvaluate(Ye,ut,pt){const wt=new nl(this._properties);for(const Tt of Object.keys(this._values))wt._values[Tt]=this._values[Tt].possiblyEvaluate(Ye,ut,pt);return wt}hasTransition(){for(const Ye of Object.keys(this._values))if(this._values[Ye].prior)return!0;return!1}}class el{constructor(Ye,ut,pt){this._properties=Ye,this._values=Object.create(Ye.defaultPropertyValues),this._scope=ut,this._options=pt,this.isConfigDependent=!1}getValue(Ye){return hr(this._values[Ye].value)}setValue(Ye,ut){this._values[Ye]=new Ko(this._values[Ye].property,null===ut?void 0:hr(ut),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[Ye].expression.isConfigDependent}serialize(){const Ye={};for(const ut of Object.keys(this._values)){const pt=this.getValue(ut);void 0!==pt&&(Ye[ut]=pt)}return Ye}possiblyEvaluate(Ye,ut,pt){const wt=new nl(this._properties);for(const Tt of Object.keys(this._values))wt._values[Tt]=this._values[Tt].possiblyEvaluate(Ye,ut,pt);return wt}}class rl{constructor(Ye,ut,pt){this.property=Ye,this.value=ut,this.parameters=pt}isConstant(){return"constant"===this.value.kind}constantOr(Ye){return"constant"===this.value.kind?this.value.value:Ye}evaluate(Ye,ut,pt,wt){return this.property.evaluate(this.value,this.parameters,Ye,ut,pt,wt)}}class nl{constructor(Ye){this._properties=Ye,this._values=Object.create(Ye.defaultPossiblyEvaluatedValues)}get(Ye){return this._values[Ye]}}class il{constructor(Ye){this.specification=Ye}possiblyEvaluate(Ye,ut){return Ye.expression.evaluate(ut)}interpolate(Ye,ut,pt){const wt=lf[this.specification.type];return wt?wt(Ye,ut,pt):Ye}}class sl{constructor(Ye,ut){this.specification=Ye,this.overrides=ut}possiblyEvaluate(Ye,ut,pt,wt){return new rl(this,"constant"===Ye.expression.kind||"camera"===Ye.expression.kind?{kind:"constant",value:Ye.expression.evaluate(ut,null,{},pt,wt)}:Ye.expression,ut)}interpolate(Ye,ut,pt){if("constant"!==Ye.value.kind||"constant"!==ut.value.kind)return Ye;if(void 0===Ye.value.value||void 0===ut.value.value)return new rl(this,{kind:"constant",value:void 0},Ye.parameters);const wt=lf[this.specification.type];return wt?new rl(this,{kind:"constant",value:wt(Ye.value.value,ut.value.value,pt)},Ye.parameters):Ye}evaluate(Ye,ut,pt,wt,Tt,St){return"constant"===Ye.kind?Ye.value:Ye.evaluate(ut,pt,wt,Tt,St)}}class al{constructor(Ye){this.specification=Ye}possiblyEvaluate(Ye,ut,pt,wt){return!!Ye.expression.evaluate(ut,null,{},pt,wt)}interpolate(){return!1}}class ol{constructor(Ye){this.properties=Ye,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const ut=new Ho(0,{});for(const pt in Ye){const wt=Ye[pt];wt.specification.overridable&&this.overridableProperties.push(pt);const Tt=this.defaultPropertyValues[pt]=new Ko(wt,void 0),St=this.defaultTransitionablePropertyValues[pt]=new Wo(wt);this.defaultTransitioningPropertyValues[pt]=St.untransitioned(),this.defaultPossiblyEvaluatedValues[pt]=Tt.possiblyEvaluate(ut)}}}Mo(sl,"DataDrivenProperty"),Mo(il,"DataConstantProperty"),Mo(al,"ColorRampProperty");var O_=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{"experimental":true}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant","experimental":true}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function ul(Ye){return Ye instanceof Number||Ye instanceof String||Ye instanceof Boolean?Ye.valueOf():Ye}function cl(Ye){if(Array.isArray(Ye))return Ye.map(cl);if(Ye instanceof Object&&!(Ye instanceof Number||Ye instanceof String||Ye instanceof Boolean)){const ut={};for(const pt in Ye)ut[pt]=cl(Ye[pt]);return ut}return ul(Ye)}function hl(Ye){if(!0===Ye||!1===Ye)return!0;if(!Array.isArray(Ye)||0===Ye.length)return!1;switch(Ye[0]){case"has":return Ye.length>=2&&"$id"!==Ye[1]&&"$type"!==Ye[1];case"in":return Ye.length>=3&&("string"!=typeof Ye[1]||Array.isArray(Ye[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==Ye.length||Array.isArray(Ye[1])||Array.isArray(Ye[2]);case"any":case"all":for(const ut of Ye.slice(1))if(!hl(ut)&&"boolean"!=typeof ut)return!1;return!0;default:return!0}}function pl(Ye,ut="fill"){if(null==Ye)return{filter:()=>!0,needGeometry:!1,needFeature:!1};hl(Ye)||(Ye=bl(Ye));const pt=Ye;let wt=!0;try{wt=function(Ye){if(!ml(Ye))return Ye;let ut=cl(Ye);return dl(ut),ut=fl(ut),ut}(pt)}catch(Ye){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(pt,null,2)}\n        `)}const Tt=O_[`filter_${ut}`],St=ho(wt,Tt);let It=null;if("error"===St.result)throw new Error(St.value.map((Ye=>`${Ye.key}: ${Ye.message}`)).join(", "));It=(Ye,ut,pt)=>St.value.evaluate(Ye,ut,{},pt);let Lt=null,$t=null;if(wt!==pt){const Ye=ho(pt,Tt);if("error"===Ye.result)throw new Error(Ye.value.map((Ye=>`${Ye.key}: ${Ye.message}`)).join(", "));Lt=(ut,pt,wt,Tt,St)=>Ye.value.evaluate(ut,pt,{},wt,void 0,void 0,Tt,St),$t=!Ys(Ye.value.expression)}return{filter:It,dynamicFilter:Lt||void 0,needGeometry:xl(wt),needFeature:!!$t}}function fl(Ye){if(!Array.isArray(Ye))return Ye;const ut=function(Ye){if(B_.has(Ye[0]))for(let ut=1;ut<Ye.length;ut++)if(ml(Ye[ut]))return!0;return Ye}(Ye);return!0===ut?ut:ut.map((Ye=>fl(Ye)))}function dl(Ye){let ut=!1;const pt=[];if("case"===Ye[0]){for(let wt=1;wt<Ye.length-1;wt+=2)ut=ut||ml(Ye[wt]),pt.push(Ye[wt+1]);pt.push(Ye[Ye.length-1])}else if("match"===Ye[0]){ut=ut||ml(Ye[1]);for(let ut=2;ut<Ye.length-1;ut+=2)pt.push(Ye[ut+1]);pt.push(Ye[Ye.length-1])}else if("step"===Ye[0]){ut=ut||ml(Ye[1]);for(let ut=1;ut<Ye.length-1;ut+=2)pt.push(Ye[ut+1])}ut&&(Ye.length=0,Ye.push("any",...pt));for(let ut=1;ut<Ye.length;ut++)dl(Ye[ut])}function ml(Ye){if(!Array.isArray(Ye))return!1;if("pitch"===(ut=Ye[0])||"distance-from-center"===ut)return!0;var ut;for(let ut=1;ut<Ye.length;ut++)if(ml(Ye[ut]))return!0;return!1}const B_=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function gl(Ye,ut){return Ye<ut?-1:Ye>ut?1:0}function xl(Ye){if(!Array.isArray(Ye))return!1;if("within"===Ye[0]||"distance"===Ye[0])return!0;for(let ut=1;ut<Ye.length;ut++)if(xl(Ye[ut]))return!0;return!1}function bl(Ye){if(!Ye)return!0;const ut=Ye[0];return Ye.length<=1?"any"!==ut:"=="===ut?vl(Ye[1],Ye[2],"=="):"!="===ut?Ml(vl(Ye[1],Ye[2],"==")):"<"===ut||">"===ut||"<="===ut||">="===ut?vl(Ye[1],Ye[2],ut):"any"===ut?(pt=Ye.slice(1),["any"].concat(pt.map(bl))):"all"===ut?["all"].concat(Ye.slice(1).map(bl)):"none"===ut?["all"].concat(Ye.slice(1).map(bl).map(Ml)):"in"===ut?_l(Ye[1],Ye.slice(2)):"!in"===ut?Ml(_l(Ye[1],Ye.slice(2))):"has"===ut?wl(Ye[1]):"!has"!==ut||Ml(wl(Ye[1]));var pt}function vl(Ye,ut,pt){switch(Ye){case"$type":return[`filter-type-${pt}`,ut];case"$id":return[`filter-id-${pt}`,ut];default:return[`filter-${pt}`,Ye,ut]}}function _l(Ye,ut){if(0===ut.length)return!1;switch(Ye){case"$type":return["filter-type-in",["literal",ut]];case"$id":return["filter-id-in",["literal",ut]];default:return ut.length>200&&!ut.some((Ye=>typeof Ye!=typeof ut[0]))?["filter-in-large",Ye,["literal",ut.sort(gl)]]:["filter-in-small",Ye,["literal",ut]]}}function wl(Ye){switch(Ye){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",Ye]}}function Ml(Ye){return["!",Ye]}const F_="";function Sl(Ye,ut){return ut?`${Ye}${F_}${ut}`:Ye}const N_="-transition",V_=new Set(["fill","line","background","hillshade","raster"]);class kl extends Ln{constructor(Ye,ut,pt,wt,Tt){if(super(),this.id=Ye.id,this.fqid=Sl(this.id,pt),this.type=Ye.type,this.scope=pt,this.lut=wt,this.options=Tt,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,"custom"!==Ye.type&&(this.metadata=Ye.metadata,this.minzoom=Ye.minzoom,this.maxzoom=Ye.maxzoom,"background"!==Ye.type&&"sky"!==Ye.type&&"slot"!==Ye.type&&(this.source=Ye.source,this.sourceLayer=Ye["source-layer"],this.filter=Ye.filter),Ye.slot&&(this.slot=Ye.slot),ut.layout&&(this._unevaluatedLayout=new el(ut.layout,this.scope,Tt),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),ut.paint)){this._transitionablePaint=new Jo(ut.paint,this.scope,Tt);for(const ut in Ye.paint)this.setPaintProperty(ut,Ye.paint[ut]);for(const ut in Ye.layout)this.setLayoutProperty(ut,Ye.layout[ut]);this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new nl(ut.paint)}}onAdd(Ye){}onRemove(Ye){}isDraped(Ye){return V_.has(this.type)}getLayoutProperty(Ye){return"visibility"===Ye?this.visibility:this._unevaluatedLayout.getValue(Ye)}setLayoutProperty(Ye,ut){if("custom"===this.type&&"visibility"===Ye)return void(this.visibility=ut);const pt=this._unevaluatedLayout;pt._properties.properties[Ye]&&(pt.setValue(Ye,ut),this.isConfigDependent=this.isConfigDependent||pt.isConfigDependent,"visibility"===Ye&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(Ye){return lr(Ye,N_)?this._transitionablePaint.getTransition(Ye.slice(0,-11)):this._transitionablePaint.getValue(Ye)}setPaintProperty(Ye,ut){const pt=this._transitionablePaint,wt=pt._properties.properties;if(lr(Ye,N_)){const Tt=Ye.slice(0,-11);return wt[Tt]&&pt.setTransition(Tt,ut||void 0),!1}if(!wt[Ye])return!1;const Tt=pt._values[Ye],St=Tt.value.isDataDriven(),It=Tt.value;pt.setValue(Ye,ut),this.isConfigDependent=this.isConfigDependent||pt.isConfigDependent,this._handleSpecialPaintPropertyUpdate(Ye);const Lt=pt._values[Ye].value,$t=Lt.isDataDriven(),Xt=lr(Ye,"pattern")||"line-dasharray"===Ye;return $t||St||Xt||this._handleOverridablePaintPropertyUpdate(Ye,It,Lt)}_handleSpecialPaintPropertyUpdate(Ye){}getProgramIds(){return null}getDefaultProgramParams(Ye,ut,pt){return null}_handleOverridablePaintPropertyUpdate(Ye,ut,pt){return!1}isHidden(Ye){return!!(this.minzoom&&Ye<this.minzoom)||!!(this.maxzoom&&Ye>=this.maxzoom)||"none"===this.visibility}updateTransitions(Ye){this._transitioningPaint=this._transitionablePaint.transitioned(Ye,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(Ye,ut){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(Ye,void 0,ut)),this.paint=this._transitioningPaint.possiblyEvaluate(Ye,void 0,ut)}serialize(){return cr({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((Ye,ut)=>!(void 0===Ye||"layout"===ut&&!Object.keys(Ye).length||"paint"===ut&&!Object.keys(Ye).length)))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const Ye in this.paint._values){const ut=this.paint.get(Ye);if(ut instanceof rl&&Wa(ut.property.specification)&&("source"===ut.value.kind||"composite"===ut.value.kind)&&ut.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=pl(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(Ye){this._stats&&("shadow"===Ye.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(Ye){}queryIntersectsFeature(Ye,ut,pt,wt,Tt,St,It,Lt,$t){}queryIntersectsMatchingFeature(Ye,ut,pt,wt){}}const U_={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class zl{constructor(Ye,ut){this._structArray=Ye,this._pos1=ut*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class El{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(Ye,ut){return Ye._trim(),ut&&(Ye.isTransferred=!0,ut.add(Ye.arrayBuffer)),{length:Ye.length,arrayBuffer:Ye.arrayBuffer}}static deserialize(Ye){const ut=Object.create(this.prototype);return ut.arrayBuffer=Ye.arrayBuffer,ut.length=Ye.length,ut.capacity=Ye.arrayBuffer.byteLength/ut.bytesPerElement,ut._refreshViews(),ut}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(Ye){this.reserve(Ye),this.length=Ye}reserve(Ye){if(Ye>this.capacity){this.capacity=Math.max(Ye,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const ut=this.uint8;this._refreshViews(),ut&&this.uint8.set(ut)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...Ye){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...Ye){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Bl(Ye,ut=1){let pt=0,wt=0;return{members:Ye.map((Ye=>{const Tt=U_[Ye.type].BYTES_PER_ELEMENT,St=pt=Dl(pt,Math.max(ut,Tt)),It=Ye.components||1;return wt=Math.max(wt,Tt),pt+=Tt*It,{name:Ye.name,type:Ye.type,components:It,offset:St}})),size:Dl(pt,Math.max(wt,ut)),alignment:ut}}function Dl(Ye,ut){return Math.ceil(Ye/ut)*ut}class Cl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(Ye,ut){const pt=this.length;return this.resize(pt+1),this.emplace(pt,Ye,ut)}emplace(Ye,ut,pt){const wt=2*Ye;return this.int16[wt+0]=ut,this.int16[wt+1]=pt,Ye}}Cl.prototype.bytesPerElement=4,Mo(Cl,"StructArrayLayout2i4");class Rl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt){const wt=this.length;return this.resize(wt+1),this.emplace(wt,Ye,ut,pt)}emplace(Ye,ut,pt,wt){const Tt=3*Ye;return this.int16[Tt+0]=ut,this.int16[Tt+1]=pt,this.int16[Tt+2]=wt,Ye}}Rl.prototype.bytesPerElement=6,Mo(Rl,"StructArrayLayout3i6");class Vl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,Ye,ut,pt,wt)}emplace(Ye,ut,pt,wt,Tt){const St=4*Ye;return this.int16[St+0]=ut,this.int16[St+1]=pt,this.int16[St+2]=wt,this.int16[St+3]=Tt,Ye}}Vl.prototype.bytesPerElement=8,Mo(Vl,"StructArrayLayout4i8");class Ll extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,Ye,ut,pt,wt,Tt)}emplace(Ye,ut,pt,wt,Tt,St){const It=5*Ye;return this.int16[It+0]=ut,this.int16[It+1]=pt,this.int16[It+2]=wt,this.int16[It+3]=Tt,this.int16[It+4]=St,Ye}}Ll.prototype.bytesPerElement=10,Mo(Ll,"StructArrayLayout5i10");class Ol extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It){const Lt=this.length;return this.resize(Lt+1),this.emplace(Lt,Ye,ut,pt,wt,Tt,St,It)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=6*Ye,Xt=12*Ye,Sr=3*Ye;return this.int16[$t+0]=ut,this.int16[$t+1]=pt,this.uint8[Xt+4]=wt,this.uint8[Xt+5]=Tt,this.uint8[Xt+6]=St,this.uint8[Xt+7]=It,this.float32[Sr+2]=Lt,Ye}}Ol.prototype.bytesPerElement=12,Mo(Ol,"StructArrayLayout2i4ub1f12");class Fl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,Ye,ut,pt,wt)}emplace(Ye,ut,pt,wt,Tt){const St=4*Ye;return this.float32[St+0]=ut,this.float32[St+1]=pt,this.float32[St+2]=wt,this.float32[St+3]=Tt,Ye}}Fl.prototype.bytesPerElement=16,Mo(Fl,"StructArrayLayout4f16");class Ul extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt){const wt=this.length;return this.resize(wt+1),this.emplace(wt,Ye,ut,pt)}emplace(Ye,ut,pt,wt){const Tt=3*Ye;return this.float32[Tt+0]=ut,this.float32[Tt+1]=pt,this.float32[Tt+2]=wt,Ye}}Ul.prototype.bytesPerElement=12,Mo(Ul,"StructArrayLayout3f12");class Nl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,Ye,ut,pt,wt,Tt)}emplace(Ye,ut,pt,wt,Tt,St){const It=6*Ye,Lt=3*Ye;return this.uint16[It+0]=ut,this.uint16[It+1]=pt,this.uint16[It+2]=wt,this.uint16[It+3]=Tt,this.float32[Lt+2]=St,Ye}}Nl.prototype.bytesPerElement=12,Mo(Nl,"StructArrayLayout4ui1f12");class jl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,Ye,ut,pt,wt)}emplace(Ye,ut,pt,wt,Tt){const St=4*Ye;return this.uint16[St+0]=ut,this.uint16[St+1]=pt,this.uint16[St+2]=wt,this.uint16[St+3]=Tt,Ye}}jl.prototype.bytesPerElement=8,Mo(jl,"StructArrayLayout4ui8");class ql extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St){const It=this.length;return this.resize(It+1),this.emplace(It,Ye,ut,pt,wt,Tt,St)}emplace(Ye,ut,pt,wt,Tt,St,It){const Lt=6*Ye;return this.int16[Lt+0]=ut,this.int16[Lt+1]=pt,this.int16[Lt+2]=wt,this.int16[Lt+3]=Tt,this.int16[Lt+4]=St,this.int16[Lt+5]=It,Ye}}ql.prototype.bytesPerElement=12,Mo(ql,"StructArrayLayout6i12");class $l extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr){const Qr=this.length;return this.resize(Qr+1),this.emplace(Qr,Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr){const fn=12*Ye;return this.int16[fn+0]=ut,this.int16[fn+1]=pt,this.int16[fn+2]=wt,this.int16[fn+3]=Tt,this.uint16[fn+4]=St,this.uint16[fn+5]=It,this.uint16[fn+6]=Lt,this.uint16[fn+7]=$t,this.int16[fn+8]=Xt,this.int16[fn+9]=Sr,this.int16[fn+10]=Lr,this.int16[fn+11]=Qr,Ye}}$l.prototype.bytesPerElement=24,Mo($l,"StructArrayLayout4i4ui4i24");class Gl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St){const It=this.length;return this.resize(It+1),this.emplace(It,Ye,ut,pt,wt,Tt,St)}emplace(Ye,ut,pt,wt,Tt,St,It){const Lt=10*Ye,$t=5*Ye;return this.int16[Lt+0]=ut,this.int16[Lt+1]=pt,this.int16[Lt+2]=wt,this.float32[$t+2]=Tt,this.float32[$t+3]=St,this.float32[$t+4]=It,Ye}}Gl.prototype.bytesPerElement=20,Mo(Gl,"StructArrayLayout3i3f20");class Yl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(Ye){const ut=this.length;return this.resize(ut+1),this.emplace(ut,Ye)}emplace(Ye,ut){return this.uint32[1*Ye+0]=ut,Ye}}Yl.prototype.bytesPerElement=4,Mo(Yl,"StructArrayLayout1ul4");class Xl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye){const ut=this.length;return this.resize(ut+1),this.emplace(ut,Ye)}emplace(Ye,ut){return this.float32[1*Ye+0]=ut,Ye}}Xl.prototype.bytesPerElement=4,Mo(Xl,"StructArrayLayout1f4");class Zl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(Ye,ut){const pt=this.length;return this.resize(pt+1),this.emplace(pt,Ye,ut)}emplace(Ye,ut,pt){const wt=2*Ye;return this.uint16[wt+0]=ut,this.uint16[wt+1]=pt,Ye}}Zl.prototype.bytesPerElement=4,Mo(Zl,"StructArrayLayout2ui4");class Hl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr){const fn=this.length;return this.resize(fn+1),this.emplace(fn,Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn){const xn=20*Ye,vn=10*Ye;return this.int16[xn+0]=ut,this.int16[xn+1]=pt,this.int16[xn+2]=wt,this.int16[xn+3]=Tt,this.int16[xn+4]=St,this.float32[vn+3]=It,this.float32[vn+4]=Lt,this.float32[vn+5]=$t,this.float32[vn+6]=Xt,this.int16[xn+14]=Sr,this.uint32[vn+8]=Lr,this.uint16[xn+18]=Qr,this.uint16[xn+19]=fn,Ye}}Hl.prototype.bytesPerElement=40,Mo(Hl,"StructArrayLayout5i4f1i1ul2ui40");class Kl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It){const Lt=this.length;return this.resize(Lt+1),this.emplace(Lt,Ye,ut,pt,wt,Tt,St,It)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=8*Ye;return this.int16[$t+0]=ut,this.int16[$t+1]=pt,this.int16[$t+2]=wt,this.int16[$t+4]=Tt,this.int16[$t+5]=St,this.int16[$t+6]=It,this.int16[$t+7]=Lt,Ye}}Kl.prototype.bytesPerElement=16,Mo(Kl,"StructArrayLayout3i2i2i16");class Wl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,Ye,ut,pt,wt,Tt)}emplace(Ye,ut,pt,wt,Tt,St){const It=4*Ye,Lt=8*Ye;return this.float32[It+0]=ut,this.float32[It+1]=pt,this.float32[It+2]=wt,this.int16[Lt+6]=Tt,this.int16[Lt+7]=St,Ye}}Wl.prototype.bytesPerElement=16,Mo(Wl,"StructArrayLayout2f1f2i16");class Jl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,Ye,ut,pt,wt)}emplace(Ye,ut,pt,wt,Tt){const St=12*Ye,It=3*Ye;return this.uint8[St+0]=ut,this.uint8[St+1]=pt,this.float32[It+1]=wt,this.float32[It+2]=Tt,Ye}}Jl.prototype.bytesPerElement=12,Mo(Jl,"StructArrayLayout2ub2f12");class Ql extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt){const wt=this.length;return this.resize(wt+1),this.emplace(wt,Ye,ut,pt)}emplace(Ye,ut,pt,wt){const Tt=3*Ye;return this.uint16[Tt+0]=ut,this.uint16[Tt+1]=pt,this.uint16[Tt+2]=wt,Ye}}Ql.prototype.bytesPerElement=6,Mo(Ql,"StructArrayLayout3ui6");class tu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn){const ko=this.length;return this.resize(ko+1),this.emplace(ko,Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn,ko){const Fo=30*Ye,is=15*Ye,ns=60*Ye;return this.int16[Fo+0]=ut,this.int16[Fo+1]=pt,this.int16[Fo+2]=wt,this.float32[is+2]=Tt,this.float32[is+3]=St,this.uint16[Fo+8]=It,this.uint16[Fo+9]=Lt,this.uint32[is+5]=$t,this.uint32[is+6]=Xt,this.uint32[is+7]=Sr,this.uint16[Fo+16]=Lr,this.uint16[Fo+17]=Qr,this.uint16[Fo+18]=fn,this.float32[is+10]=xn,this.float32[is+11]=vn,this.uint8[ns+48]=kn,this.uint8[ns+49]=Wn,this.uint8[ns+50]=Xn,this.uint32[is+13]=Jn,this.int16[Fo+28]=Qn,this.uint8[ns+58]=ko,Ye}}tu.prototype.bytesPerElement=60,Mo(tu,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class eu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn,ko,Fo,is,ns,ss,as,ds,ps,ms,Js,ua,ba,Ra){const La=this.length;return this.resize(La+1),this.emplace(La,Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn,ko,Fo,is,ns,ss,as,ds,ps,ms,Js,ua,ba,Ra)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn,ko,Fo,is,ns,ss,as,ds,ps,ms,Js,ua,ba,Ra,La){const ll=22*Ye,yl=44*Ye,Tl=88*Ye;return this.float32[ll+0]=ut,this.float32[ll+1]=pt,this.int16[yl+4]=wt,this.int16[yl+5]=Tt,this.int16[yl+6]=St,this.int16[yl+7]=It,this.int16[yl+8]=Lt,this.int16[yl+9]=$t,this.int16[yl+10]=Xt,this.int16[yl+11]=Sr,this.int16[yl+12]=Lr,this.uint16[yl+13]=Qr,this.uint16[yl+14]=fn,this.uint16[yl+15]=xn,this.uint16[yl+16]=vn,this.uint16[yl+17]=kn,this.uint16[yl+18]=Wn,this.uint16[yl+19]=Xn,this.uint16[yl+20]=Jn,this.uint16[yl+21]=Qn,this.uint16[yl+22]=ko,this.uint16[yl+23]=Fo,this.uint16[yl+24]=is,this.uint16[yl+25]=ns,this.uint16[yl+26]=ss,this.uint16[yl+27]=as,this.uint32[ll+14]=ds,this.float32[ll+15]=ps,this.float32[ll+16]=ms,this.float32[ll+17]=Js,this.float32[ll+18]=ua,this.float32[ll+19]=ba,this.float32[ll+20]=Ra,this.uint8[Tl+84]=La,Ye}}eu.prototype.bytesPerElement=88,Mo(eu,"StructArrayLayout2f9i15ui1ul6f1ub88");class ru extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,Ye,ut,pt,wt,Tt)}emplace(Ye,ut,pt,wt,Tt,St){const It=5*Ye;return this.float32[It+0]=ut,this.float32[It+1]=pt,this.float32[It+2]=wt,this.float32[It+3]=Tt,this.float32[It+4]=St,Ye}}ru.prototype.bytesPerElement=20,Mo(ru,"StructArrayLayout5f20");class nu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It){const Lt=this.length;return this.resize(Lt+1),this.emplace(Lt,Ye,ut,pt,wt,Tt,St,It)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=7*Ye;return this.float32[$t+0]=ut,this.float32[$t+1]=pt,this.float32[$t+2]=wt,this.float32[$t+3]=Tt,this.float32[$t+4]=St,this.float32[$t+5]=It,this.float32[$t+6]=Lt,Ye}}nu.prototype.bytesPerElement=28,Mo(nu,"StructArrayLayout7f28");class iu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut){const pt=this.length;return this.resize(pt+1),this.emplace(pt,Ye,ut)}emplace(Ye,ut,pt){const wt=2*Ye;return this.float32[wt+0]=ut,this.float32[wt+1]=pt,Ye}}iu.prototype.bytesPerElement=8,Mo(iu,"StructArrayLayout2f8");class su extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,Ye,ut,pt,wt)}emplace(Ye,ut,pt,wt,Tt){const St=6*Ye;return this.uint32[3*Ye+0]=ut,this.uint16[St+2]=pt,this.uint16[St+3]=wt,this.uint16[St+4]=Tt,Ye}}su.prototype.bytesPerElement=12,Mo(su,"StructArrayLayout1ul3ui12");class au extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(Ye){const ut=this.length;return this.resize(ut+1),this.emplace(ut,Ye)}emplace(Ye,ut){return this.uint16[1*Ye+0]=ut,Ye}}au.prototype.bytesPerElement=2,Mo(au,"StructArrayLayout1ui2");class ou extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn){const kn=this.length;return this.resize(kn+1),this.emplace(kn,Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn){const Wn=16*Ye;return this.float32[Wn+0]=ut,this.float32[Wn+1]=pt,this.float32[Wn+2]=wt,this.float32[Wn+3]=Tt,this.float32[Wn+4]=St,this.float32[Wn+5]=It,this.float32[Wn+6]=Lt,this.float32[Wn+7]=$t,this.float32[Wn+8]=Xt,this.float32[Wn+9]=Sr,this.float32[Wn+10]=Lr,this.float32[Wn+11]=Qr,this.float32[Wn+12]=fn,this.float32[Wn+13]=xn,this.float32[Wn+14]=vn,this.float32[Wn+15]=kn,Ye}}ou.prototype.bytesPerElement=64,Mo(ou,"StructArrayLayout16f64");class lu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(Ye,ut,pt,wt,Tt,St,It){const Lt=this.length;return this.resize(Lt+1),this.emplace(Lt,Ye,ut,pt,wt,Tt,St,It)}emplace(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=10*Ye,Xt=5*Ye;return this.uint16[$t+0]=ut,this.uint16[$t+1]=pt,this.uint16[$t+2]=wt,this.uint16[$t+3]=Tt,this.float32[Xt+2]=St,this.float32[Xt+3]=It,this.float32[Xt+4]=Lt,Ye}}lu.prototype.bytesPerElement=20,Mo(lu,"StructArrayLayout4ui3f20");class uu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(Ye){const ut=this.length;return this.resize(ut+1),this.emplace(ut,Ye)}emplace(Ye,ut){return this.int16[1*Ye+0]=ut,Ye}}uu.prototype.bytesPerElement=2,Mo(uu,"StructArrayLayout1i2");class cu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(Ye){const ut=this.length;return this.resize(ut+1),this.emplace(ut,Ye)}emplace(Ye,ut){return this.uint8[1*Ye+0]=ut,Ye}}cu.prototype.bytesPerElement=1,Mo(cu,"StructArrayLayout1ub1");class hu extends zl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}hu.prototype.size=40;class pu extends Hl{get(Ye){return new hu(this,Ye)}}Mo(pu,"CollisionBoxArray");class fu extends zl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(Ye){this._structArray.uint8[this._pos1+49]=Ye}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(Ye){this._structArray.uint8[this._pos1+50]=Ye}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(Ye){this._structArray.uint32[this._pos4+13]=Ye}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(Ye){this._structArray.uint8[this._pos1+58]=Ye}}fu.prototype.size=60;class du extends tu{get(Ye){return new fu(this,Ye)}}Mo(du,"PlacedSymbolArray");class mu extends zl{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(Ye){this._structArray.uint32[this._pos4+14]=Ye}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(Ye){this._structArray.float32[this._pos4+18]=Ye}get occlusionState(){return this._structArray.float32[this._pos4+19]}set occlusionState(Ye){this._structArray.float32[this._pos4+19]=Ye}get occlusionOpacity(){return this._structArray.float32[this._pos4+20]}set occlusionOpacity(Ye){this._structArray.float32[this._pos4+20]=Ye}get hasIconTextFit(){return this._structArray.uint8[this._pos1+84]}}mu.prototype.size=88;class yu extends eu{get(Ye){return new mu(this,Ye)}}Mo(yu,"SymbolInstanceArray");class gu extends Xl{getoffsetX(Ye){return this.float32[1*Ye+0]}}Mo(gu,"GlyphOffsetArray");class xu extends Cl{getx(Ye){return this.int16[2*Ye+0]}gety(Ye){return this.int16[2*Ye+1]}}Mo(xu,"SymbolLineVertexArray");class bu extends zl{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}bu.prototype.size=12;class vu extends su{get(Ye){return new bu(this,Ye)}}Mo(vu,"FeatureIndexArray");class _u extends Zl{geta_centroid_pos0(Ye){return this.uint16[2*Ye+0]}geta_centroid_pos1(Ye){return this.uint16[2*Ye+1]}}Mo(_u,"FillExtrusionCentroidArray");const j_=Bl([{name:"a_pos",components:2,type:"Int16"}],4),G_=Bl([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Au{constructor(Ye=[]){this.segments=Ye}_prepareSegment(Ye,ut,pt,wt){let Tt=this.segments[this.segments.length-1];return Ye>Au.MAX_VERTEX_ARRAY_LENGTH&&fr(`Max vertices per segment is ${Au.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${Ye}`),(!Tt||Tt.vertexLength+Ye>Au.MAX_VERTEX_ARRAY_LENGTH||Tt.sortKey!==wt)&&(Tt={vertexOffset:ut,primitiveOffset:pt,vertexLength:0,primitiveLength:0},void 0!==wt&&(Tt.sortKey=wt),this.segments.push(Tt)),Tt}prepareSegment(Ye,ut,pt,wt){return this._prepareSegment(Ye,ut.length,pt.length,wt)}get(){return this.segments}destroy(){for(const Ye of this.segments)for(const ut in Ye.vaos)Ye.vaos[ut].destroy()}static simpleSegment(Ye,ut,pt,wt){return new Au([{vertexOffset:Ye,primitiveOffset:ut,vertexLength:pt,primitiveLength:wt,vaos:{},sortKey:0}])}}function Su(Ye,ut){return 256*(Ye=Ke(Math.floor(Ye),0,255))+Ke(Math.floor(ut),0,255)}Au.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Mo(Au,"SegmentVector");const q_=Bl([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Z_=Bl([{name:"a_dash",components:4,type:"Uint16"}]);class ku{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(Ye,ut,pt,wt){this.ids.push(Pu(Ye)),this.positions.push(ut,pt,wt)}eachPosition(Ye,ut){const pt=Pu(Ye);let wt=0,Tt=this.ids.length-1;for(;wt<Tt;){const Ye=wt+Tt>>1;this.ids[Ye]>=pt?Tt=Ye:wt=Ye+1}for(;this.ids[wt]===pt;)ut(this.positions[3*wt],this.positions[3*wt+1],this.positions[3*wt+2]),wt++}static serialize(Ye,ut){const pt=new Float64Array(Ye.ids),wt=new Uint32Array(Ye.positions);return zu(pt,wt,0,pt.length-1),ut&&(ut.add(pt.buffer),ut.add(wt.buffer)),{ids:pt,positions:wt}}static deserialize(Ye){const ut=new ku;let pt;ut.ids=Ye.ids,ut.positions=Ye.positions;for(const Ye of ut.ids)Ye!==pt&&ut.uniqueIds.push(Ye),pt=Ye;return ut.indexed=!0,ut}}function Pu(Ye){const ut=+Ye;return!isNaN(ut)&&Number.MIN_SAFE_INTEGER<=ut&&ut<=Number.MAX_SAFE_INTEGER?ut:sf(String(Ye))}function zu(Ye,ut,pt,wt){for(;pt<wt;){const Tt=Ye[pt+wt>>1];let St=pt-1,It=wt+1;for(;;){do{St++}while(Ye[St]<Tt);do{It--}while(Ye[It]>Tt);if(St>=It)break;Eu(Ye,St,It),Eu(ut,3*St,3*It),Eu(ut,3*St+1,3*It+1),Eu(ut,3*St+2,3*It+2)}It-pt<wt-It?(zu(Ye,ut,pt,It),pt=It+1):(zu(Ye,ut,It+1,wt),wt=It)}}function Eu(Ye,ut,pt){const wt=Ye[ut];Ye[ut]=Ye[pt],Ye[pt]=wt}Mo(ku,"FeaturePositionMap");class Bu{constructor(Ye){this.gl=Ye.gl,this.initialized=!1}fetchUniformLocation(Ye,ut){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(Ye,ut),this.initialized=!0),!!this.location}set(Ye,ut,pt){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Du extends Bu{constructor(Ye){super(Ye),this.current=0}set(Ye,ut,pt){this.fetchUniformLocation(Ye,ut)&&this.current!==pt&&(this.current=pt,this.gl.uniform1i(this.location,pt))}}class Cu extends Bu{constructor(Ye){super(Ye),this.current=0}set(Ye,ut,pt){this.fetchUniformLocation(Ye,ut)&&this.current!==pt&&(this.current=pt,this.gl.uniform1f(this.location,pt))}}class Ru extends Bu{constructor(Ye){super(Ye),this.current=[0,0]}set(Ye,ut,pt){this.fetchUniformLocation(Ye,ut)&&(pt[0]===this.current[0]&&pt[1]===this.current[1]||(this.current=pt,this.gl.uniform2f(this.location,pt[0],pt[1])))}}class Vu extends Bu{constructor(Ye){super(Ye),this.current=[0,0,0]}set(Ye,ut,pt){this.fetchUniformLocation(Ye,ut)&&(pt[0]===this.current[0]&&pt[1]===this.current[1]&&pt[2]===this.current[2]||(this.current=pt,this.gl.uniform3f(this.location,pt[0],pt[1],pt[2])))}}class Lu extends Bu{constructor(Ye){super(Ye),this.current=[0,0,0,0]}set(Ye,ut,pt){this.fetchUniformLocation(Ye,ut)&&(pt[0]===this.current[0]&&pt[1]===this.current[1]&&pt[2]===this.current[2]&&pt[3]===this.current[3]||(this.current=pt,this.gl.uniform4f(this.location,pt[0],pt[1],pt[2],pt[3])))}}class Ou extends Bu{constructor(Ye){super(Ye),this.current=qn.transparent.toRenderColor(null)}set(Ye,ut,pt){this.fetchUniformLocation(Ye,ut)&&(pt.r===this.current.r&&pt.g===this.current.g&&pt.b===this.current.b&&pt.a===this.current.a||(this.current=pt,this.gl.uniform4f(this.location,pt.r,pt.g,pt.b,pt.a)))}}const $_=new Float32Array(16);class Uu extends Bu{constructor(Ye){super(Ye),this.current=$_}set(Ye,ut,pt){if(this.fetchUniformLocation(Ye,ut)){if(pt[12]!==this.current[12]||pt[0]!==this.current[0])return this.current=pt,void this.gl.uniformMatrix4fv(this.location,!1,pt);for(let Ye=1;Ye<16;Ye++)if(pt[Ye]!==this.current[Ye]){this.current=pt,this.gl.uniformMatrix4fv(this.location,!1,pt);break}}}}const W_=new Float32Array(9),H_=new Float32Array(4);class qu extends Bu{constructor(Ye){super(Ye),this.current=H_}set(Ye,ut,pt){if(this.fetchUniformLocation(Ye,ut))for(let Ye=0;Ye<4;Ye++)if(pt[Ye]!==this.current[Ye]){this.current=pt,this.gl.uniformMatrix2fv(this.location,!1,pt);break}}}function $u(Ye){return[Su(255*Ye.r,255*Ye.g),Su(255*Ye.b,255*Ye.a)]}class Gu{constructor(Ye,ut,pt,wt){this.value=Ye,this.uniformNames=ut.map((Ye=>`u_${Ye}`)),this.type=pt,this.context=wt}setUniform(Ye,ut,pt,wt,Tt){const St=wt.constantOr(this.value);ut.set(Ye,Tt,St instanceof qn?St.toRenderColor(this.context.lut):St)}getBinding(Ye,ut){return"color"===this.type?new Ou(Ye):new Cu(Ye)}}class Yu{constructor(Ye,ut){this.uniformNames=ut.map((Ye=>`u_${Ye}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(Ye){this.pixelRatio=Ye.pixelRatio||1,this.pattern=Ye.tl.concat(Ye.br)}setUniform(Ye,ut,pt,wt,Tt){const St="u_pattern"===Tt||"u_dash"===Tt?this.pattern:"u_pixel_ratio"===Tt?this.pixelRatio:null;St&&ut.set(Ye,Tt,St)}getBinding(Ye,ut){return"u_pattern"===ut||"u_dash"===ut?new Lu(Ye):new Cu(Ye)}}class Xu{constructor(Ye,ut,pt,wt){this.expression=Ye,this.type=pt,this.maxValue=0,this.paintVertexAttributes=ut.map((Ye=>({name:`a_${Ye}`,type:"Float32",components:"color"===pt?2:1,offset:0}))),this.paintVertexArray=new wt}populatePaintArray(Ye,ut,pt,wt,Tt,St,It){const Lt=this.paintVertexArray.length,$t=this.expression.evaluate(new Ho(0,{brightness:St}),ut,{},Tt,wt,It);this.paintVertexArray.resize(Ye),this._setPaintValue(Lt,Ye,$t,this.context)}updatePaintArray(Ye,ut,pt,wt,Tt,St,It){const Lt=this.expression.evaluate({zoom:0,brightness:It},pt,wt,void 0,Tt);this._setPaintValue(Ye,ut,Lt,this.context)}_setPaintValue(Ye,ut,pt,wt){if("color"===this.type){const Tt=$u(pt.toRenderColor(wt.lut));for(let pt=Ye;pt<ut;pt++)this.paintVertexArray.emplace(pt,Tt[0],Tt[1])}else{for(let wt=Ye;wt<ut;wt++)this.paintVertexArray.emplace(wt,pt);this.maxValue=Math.max(this.maxValue,Math.abs(pt))}}upload(Ye){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=Ye.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Zu{constructor(Ye,ut,pt,wt,Tt,St){this.expression=Ye,this.uniformNames=ut.map((Ye=>`u_${Ye}_t`)),this.type=pt,this.useIntegerZoom=wt,this.context=Tt,this.maxValue=0,this.paintVertexAttributes=ut.map((Ye=>({name:`a_${Ye}`,type:"Float32",components:"color"===pt?4:2,offset:0}))),this.paintVertexArray=new St}populatePaintArray(Ye,ut,pt,wt,Tt,St,It){const Lt=this.expression.evaluate(new Ho(this.context.zoom,{brightness:St}),ut,{},Tt,wt,It),$t=this.expression.evaluate(new Ho(this.context.zoom+1,{brightness:St}),ut,{},Tt,wt,It),Xt=this.paintVertexArray.length;this.paintVertexArray.resize(Ye),this._setPaintValue(Xt,Ye,Lt,$t,this.context)}updatePaintArray(Ye,ut,pt,wt,Tt,St,It){const Lt=this.expression.evaluate({zoom:this.context.zoom,brightness:It},pt,wt,void 0,Tt),$t=this.expression.evaluate({zoom:this.context.zoom+1,brightness:It},pt,wt,void 0,Tt);this._setPaintValue(Ye,ut,Lt,$t,this.context)}_setPaintValue(Ye,ut,pt,wt,Tt){if("color"===this.type){const wt=$u(pt.toRenderColor(Tt.lut)),St=$u(pt.toRenderColor(Tt.lut));for(let pt=Ye;pt<ut;pt++)this.paintVertexArray.emplace(pt,wt[0],wt[1],St[0],St[1])}else{for(let Tt=Ye;Tt<ut;Tt++)this.paintVertexArray.emplace(Tt,pt,wt);this.maxValue=Math.max(this.maxValue,Math.abs(pt),Math.abs(wt))}}upload(Ye){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=Ye.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(Ye,ut,pt,wt,Tt){const St=this.useIntegerZoom?Math.floor(pt.zoom):pt.zoom,It=Ke(this.expression.interpolationFactor(St,this.context.zoom,this.context.zoom+1),0,1);ut.set(Ye,Tt,It)}getBinding(Ye,ut){return new Cu(Ye)}}class Hu{constructor(Ye,ut,pt,wt,Tt){this.expression=Ye,this.layerId=Tt,this.paintVertexAttributes=("array"===pt?Z_:q_).members;for(let Ye=0;Ye<ut.length;++Ye);this.paintVertexArray=new wt}populatePaintArray(Ye,ut,pt,wt){const Tt=this.paintVertexArray.length;this.paintVertexArray.resize(Ye),this._setPaintValues(Tt,Ye,ut.patterns&&ut.patterns[this.layerId],pt)}updatePaintArray(Ye,ut,pt,wt,Tt,St,It){this._setPaintValues(Ye,ut,pt.patterns&&pt.patterns[this.layerId],St)}_setPaintValues(Ye,ut,pt,wt){if(!wt||!pt)return;const Tt=wt[pt];if(!Tt)return;const{tl:St,br:It,pixelRatio:Lt}=Tt;for(let pt=Ye;pt<ut;pt++)this.paintVertexArray.emplace(pt,St[0],St[1],It[0],It[1],Lt)}upload(Ye){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=Ye.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ku{constructor(Ye,ut,pt=(()=>!0)){this.binders={},this._buffers=[],this.context=ut;const wt=[];for(const Tt in Ye.paint._values){const St=Ye.paint.get(Tt);if(!pt(Tt))continue;if(!(St instanceof rl&&Wa(St.property.specification)))continue;const It=Qu(Tt,Ye.type),Lt=St.value,$t=St.property.specification.type,Xt=!!St.property.useIntegerZoom,Sr="line-dasharray"===Tt||Tt.endsWith("pattern"),Lr="line-dasharray"===Tt&&"constant"!==Ye.layout.get("line-cap").value.kind;if("constant"!==Lt.kind||Lr)if("source"===Lt.kind||Lr||Sr){const ut=rc(Tt,$t,"source");this.binders[Tt]=Sr?new Hu(Lt,It,$t,ut,Ye.id):new Xu(Lt,It,$t,ut),wt.push(`/a_${Tt}`)}else{const Ye=rc(Tt,$t,"composite");this.binders[Tt]=new Zu(Lt,It,$t,Xt,ut,Ye),wt.push(`/z_${Tt}`)}else this.binders[Tt]=Sr?new Yu(Lt.value,It):new Gu(Lt.value,It,$t,ut),wt.push(`/u_${Tt}`)}this.cacheKey=wt.sort().join("")}getMaxValue(Ye){const ut=this.binders[Ye];return ut instanceof Xu||ut instanceof Zu?ut.maxValue:0}populatePaintArrays(Ye,ut,pt,wt,Tt,St,It){for(const Lt in this.binders){const $t=this.binders[Lt];$t.context=this.context,($t instanceof Xu||$t instanceof Zu||$t instanceof Hu)&&$t.populatePaintArray(Ye,ut,pt,wt,Tt,St,It)}}setConstantPatternPositions(Ye){for(const ut in this.binders){const pt=this.binders[ut];pt instanceof Yu&&pt.setConstantPatternPositions(Ye)}}updatePaintArrays(Ye,ut,pt,wt,Tt,St,It,Lt){let $t=!1;const Xt=Object.keys(Ye),Sr=0!==Xt.length,Lr=Sr?Xt:ut.uniqueIds;this.context.lut=Tt.lut;for(const Xt in this.binders){const Qr=this.binders[Xt];if(Qr.context=this.context,(Qr instanceof Xu||Qr instanceof Zu||Qr instanceof Hu)&&(!0===Qr.expression.isStateDependent||!1===Qr.expression.isLightConstant)){const fn=Tt.paint.get(Xt);Qr.expression=fn.value;for(const pt of Lr){const Tt=Ye[pt.toString()];ut.eachPosition(pt,((Ye,ut,pt)=>{const $t=wt.feature(Ye);Qr.updatePaintArray(ut,pt,$t,Tt,St,It,Lt)}))}if(!Sr)for(const ut of pt.uniqueIds){const Tt=Ye[ut.toString()];pt.eachPosition(ut,((Ye,ut,pt)=>{const $t=wt.feature(Ye);Qr.updatePaintArray(ut,pt,$t,Tt,St,It,Lt)}))}$t=!0}}return $t}defines(){const Ye=[];for(const ut in this.binders){const pt=this.binders[ut];(pt instanceof Gu||pt instanceof Yu)&&Ye.push(...pt.uniformNames.map((Ye=>`#define HAS_UNIFORM_${Ye}`)))}return Ye}getBinderAttributes(){const Ye=[];for(const ut in this.binders){const pt=this.binders[ut];if(pt instanceof Xu||pt instanceof Zu||pt instanceof Hu)for(let ut=0;ut<pt.paintVertexAttributes.length;ut++)Ye.push(pt.paintVertexAttributes[ut].name)}return Ye}getBinderUniforms(){const Ye=[];for(const ut in this.binders){const pt=this.binders[ut];if(pt instanceof Gu||pt instanceof Yu||pt instanceof Zu)for(const ut of pt.uniformNames)Ye.push(ut)}return Ye}getPaintVertexBuffers(){return this._buffers}getUniforms(Ye){const ut=[];for(const pt in this.binders){const wt=this.binders[pt];if(wt instanceof Gu||wt instanceof Yu||wt instanceof Zu)for(const Tt of wt.uniformNames)ut.push({name:Tt,property:pt,binding:wt.getBinding(Ye,Tt)})}return ut}setUniforms(Ye,ut,pt,wt,Tt){for(const{name:ut,property:St,binding:It}of pt)this.binders[St].setUniform(Ye,It,Tt,wt.get(St),ut)}updatePaintBuffers(){this._buffers=[];for(const Ye in this.binders){const ut=this.binders[Ye];(ut instanceof Xu||ut instanceof Zu||ut instanceof Hu)&&ut.paintVertexBuffer&&this._buffers.push(ut.paintVertexBuffer)}}upload(Ye){for(const ut in this.binders){const pt=this.binders[ut];(pt instanceof Xu||pt instanceof Zu||pt instanceof Hu)&&pt.upload(Ye)}this.updatePaintBuffers()}destroy(){for(const Ye in this.binders){const ut=this.binders[Ye];(ut instanceof Xu||ut instanceof Zu||ut instanceof Hu)&&ut.destroy()}}}class Wu{constructor(Ye,ut,pt=(()=>!0)){this.programConfigurations={};for(const wt of Ye)this.programConfigurations[wt.id]=new Ku(wt,ut,pt);this.needsUpload=!1,this._featureMap=new ku,this._featureMapWithoutIds=new ku,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(Ye,ut,pt,wt,Tt,St,It,Lt){for(const pt in this.programConfigurations)this.programConfigurations[pt].populatePaintArrays(Ye,ut,wt,Tt,St,It,Lt);void 0!==ut.id?this._featureMap.add(ut.id,pt,this._bufferOffset,Ye):(this._featureMapWithoutIds.add(this._idlessCounter,pt,this._bufferOffset,Ye),this._idlessCounter+=1),this._bufferOffset=Ye,this.needsUpload=!0}updatePaintArrays(Ye,ut,pt,wt,Tt,St){for(const It of pt)this.needsUpload=this.programConfigurations[It.id].updatePaintArrays(Ye,this._featureMap,this._featureMapWithoutIds,ut,It,wt,Tt,St||0)||this.needsUpload}get(Ye){return this.programConfigurations[Ye]}upload(Ye){if(this.needsUpload){for(const ut in this.programConfigurations)this.programConfigurations[ut].upload(Ye);this.needsUpload=!1}}destroy(){for(const Ye in this.programConfigurations)this.programConfigurations[Ye].destroy()}}const X_={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function Qu(Ye,ut){return X_[Ye]||[Ye.replace(`${ut}-`,"").replace(/-/g,"_")]}const Y_={"line-pattern":{source:Nl,composite:Nl},"fill-pattern":{source:Nl,composite:Nl},"fill-extrusion-pattern":{source:Nl,composite:Nl},"line-dasharray":{source:jl,composite:jl}},K_={color:{source:iu,composite:Fl},number:{source:Xl,composite:iu}};function rc(Ye,ut,pt){const wt=Y_[Ye];return wt&&wt[pt]||K_[ut][pt]}Mo(Gu,"ConstantBinder"),Mo(Yu,"PatternConstantBinder"),Mo(Xu,"SourceExpressionBinder"),Mo(Hu,"PatternCompositeBinder"),Mo(Zu,"CompositeExpressionBinder"),Mo(Ku,"ProgramConfiguration",{omit:["_buffers"]}),Mo(Wu,"ProgramConfigurationSet");const J_=ym/Math.PI/2,Q_=5,sg=6,lg=16383,cg=64,hg=[cg,32,16],ug=-J_,pg=J_;function hc(Ye,ut,pt,wt=J_){return pt=$e(pt),[Ye*Math.sin(pt)*wt,-ut*wt,Ye*Math.cos(pt)*wt]}function pc(Ye,ut,pt){return hc(Math.cos($e(Ye)),Math.sin($e(Ye)),ut,pt)}const mg=6371008.8,_g=2*Math.PI*mg;class mc{constructor(Ye,ut){if(isNaN(Ye)||isNaN(ut))throw new Error(`Invalid LngLat object: (${Ye}, ${ut})`);if(this.lng=+Ye,this.lat=+ut,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new mc(Je(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(Ye){const ut=Math.PI/180,pt=this.lat*ut,wt=Ye.lat*ut,Tt=Math.sin(pt)*Math.sin(wt)+Math.cos(pt)*Math.cos(wt)*Math.cos((Ye.lng-this.lng)*ut);return mg*Math.acos(Math.min(Tt,1))}toBounds(Ye=0){const ut=360*Ye/40075017,pt=ut/Math.cos(Math.PI/180*this.lat);return new yc({lng:this.lng-pt,lat:this.lat-ut},{lng:this.lng+pt,lat:this.lat+ut})}toEcef(Ye){return pc(this.lat,this.lng,J_+Ye*J_/mg)}static convert(Ye){if(Ye instanceof mc)return Ye;if(Array.isArray(Ye)&&(2===Ye.length||3===Ye.length))return new mc(Number(Ye[0]),Number(Ye[1]));if(!Array.isArray(Ye)&&"object"==typeof Ye&&null!==Ye)return new mc(Number("lng"in Ye?Ye.lng:Ye.lon),Number(Ye.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class yc{constructor(Ye,ut){if(Ye)if(ut)this.setSouthWest(Ye).setNorthEast(ut);else if(4===Ye.length){const ut=Ye;this.setSouthWest([ut[0],ut[1]]).setNorthEast([ut[2],ut[3]])}else{const ut=Ye;this.setSouthWest(ut[0]).setNorthEast(ut[1])}}setNorthEast(Ye){return this._ne=Ye instanceof mc?new mc(Ye.lng,Ye.lat):mc.convert(Ye),this}setSouthWest(Ye){return this._sw=Ye instanceof mc?new mc(Ye.lng,Ye.lat):mc.convert(Ye),this}extend(Ye){const ut=this._sw,pt=this._ne;let wt,Tt;if(Ye instanceof mc)wt=Ye,Tt=Ye;else{if(!(Ye instanceof yc))return Array.isArray(Ye)?4===Ye.length||Ye.every(Array.isArray)?this.extend(yc.convert(Ye)):this.extend(mc.convert(Ye)):"object"==typeof Ye&&null!==Ye&&Ye.hasOwnProperty("lat")&&(Ye.hasOwnProperty("lon")||Ye.hasOwnProperty("lng"))?this.extend(mc.convert(Ye)):this;if(wt=Ye._sw,Tt=Ye._ne,!wt||!Tt)return this}return ut||pt?(ut.lng=Math.min(wt.lng,ut.lng),ut.lat=Math.min(wt.lat,ut.lat),pt.lng=Math.max(Tt.lng,pt.lng),pt.lat=Math.max(Tt.lat,pt.lat)):(this._sw=new mc(wt.lng,wt.lat),this._ne=new mc(Tt.lng,Tt.lat)),this}getCenter(){return new mc((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new mc(this.getWest(),this.getNorth())}getSouthEast(){return new mc(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(Ye){const{lng:ut,lat:pt}=mc.convert(Ye);let wt=this._sw.lng<=ut&&ut<=this._ne.lng;return this._sw.lng>this._ne.lng&&(wt=this._sw.lng>=ut&&ut>=this._ne.lng),this._sw.lat<=pt&&pt<=this._ne.lat&&wt}static convert(Ye){return!Ye||Ye instanceof yc?Ye:new yc(Ye)}}var bg={};!function(Ye,ut){!function(Ye){function e(Ye,ut,pt){var wt=r(256*Ye,256*(ut=Math.pow(2,pt)-ut-1),pt),Tt=r(256*(Ye+1),256*(ut+1),pt);return wt[0]+","+wt[1]+","+Tt[0]+","+Tt[1]}function r(Ye,ut,pt){var wt=2*Math.PI*6378137/256/Math.pow(2,pt);return[Ye*wt-2*Math.PI*6378137/2,ut*wt-2*Math.PI*6378137/2]}Ye.getURL=function(Ye,ut,pt,wt,Tt,St){return St=St||{},Ye+"?"+["bbox="+e(pt,wt,Tt),"format="+(St.format||"image/png"),"service="+(St.service||"WMS"),"version="+(St.version||"1.1.1"),"request="+(St.request||"GetMap"),"srs="+(St.srs||"EPSG:3857"),"width="+(St.width||256),"height="+(St.height||256),"layers="+ut].join("&")},Ye.getTileBBox=e,Ye.getMercCoords=r,Object.defineProperty(Ye,"__esModule",{value:!0})}(ut)}(0,bg);var zg=bg;class bc{constructor(Ye,ut,pt){this.z=Ye,this.x=ut,this.y=pt,this.key=wc(0,Ye,Ye,ut,pt)}equals(Ye){return this.z===Ye.z&&this.x===Ye.x&&this.y===Ye.y}url(Ye,ut){const pt=zg.getTileBBox(this.x,this.y,this.z),wt=function(Ye,ut,pt){let wt,Tt="";for(let St=Ye;St>0;St--)wt=1<<St-1,Tt+=(ut&wt?1:0)+(pt&wt?2:0);return Tt}(this.z,this.x,this.y);return Ye[(this.x+this.y)%Ye.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===ut?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",wt).replace("{bbox-epsg-3857}",pt)}toString(){return`${this.z}/${this.x}/${this.y}`}}class vc{constructor(Ye,ut){this.wrap=Ye,this.canonical=ut,this.key=wc(Ye,ut.z,ut.z,ut.x,ut.y)}}class _c{constructor(Ye,ut,pt,wt,Tt){this.overscaledZ=Ye,this.wrap=ut,this.canonical=new bc(pt,+wt,+Tt),this.key=0===ut&&Ye===pt?this.canonical.key:wc(ut,Ye,pt,wt,Tt)}equals(Ye){return this.overscaledZ===Ye.overscaledZ&&this.wrap===Ye.wrap&&this.canonical.equals(Ye.canonical)}scaledTo(Ye){const ut=this.canonical.z-Ye;return Ye>this.canonical.z?new _c(Ye,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new _c(Ye,this.wrap,Ye,this.canonical.x>>ut,this.canonical.y>>ut)}calculateScaledKey(Ye,ut=!0){if(this.overscaledZ===Ye&&ut)return this.key;if(Ye>this.canonical.z)return wc(this.wrap*+ut,Ye,this.canonical.z,this.canonical.x,this.canonical.y);{const pt=this.canonical.z-Ye;return wc(this.wrap*+ut,Ye,Ye,this.canonical.x>>pt,this.canonical.y>>pt)}}isChildOf(Ye){if(Ye.wrap!==this.wrap)return!1;const ut=this.canonical.z-Ye.canonical.z;return 0===Ye.overscaledZ||Ye.overscaledZ<this.overscaledZ&&Ye.canonical.z<this.canonical.z&&Ye.canonical.x===this.canonical.x>>ut&&Ye.canonical.y===this.canonical.y>>ut}children(Ye){if(this.overscaledZ>=Ye)return[new _c(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const ut=this.canonical.z+1,pt=2*this.canonical.x,wt=2*this.canonical.y;return[new _c(ut,this.wrap,ut,pt,wt),new _c(ut,this.wrap,ut,pt+1,wt),new _c(ut,this.wrap,ut,pt,wt+1),new _c(ut,this.wrap,ut,pt+1,wt+1)]}isLessThan(Ye){return this.wrap<Ye.wrap||!(this.wrap>Ye.wrap)&&(this.overscaledZ<Ye.overscaledZ||!(this.overscaledZ>Ye.overscaledZ)&&(this.canonical.x<Ye.canonical.x||!(this.canonical.x>Ye.canonical.x)&&this.canonical.y<Ye.canonical.y))}wrapped(){return new _c(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(Ye){return new _c(this.overscaledZ,Ye,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new vc(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function wc(Ye,ut,pt,wt,Tt){const St=1<<Math.min(pt,22);let It=St*(Tt%St)+wt%St;return Ye&&pt<22&&(It+=St*St*((Ye<0?-2*Ye-1:2*Ye)%(1<<2*(22-pt)))),16*(32*It+pt)+(ut-pt)}const Dg=[Ye=>{let ut=Ye.canonical.x-1,pt=Ye.wrap;return ut<0&&(ut=(1<<Ye.canonical.z)-1,pt--),new _c(Ye.overscaledZ,pt,Ye.canonical.z,ut,Ye.canonical.y)},Ye=>{let ut=Ye.canonical.x+1,pt=Ye.wrap;return ut===1<<Ye.canonical.z&&(ut=0,pt++),new _c(Ye.overscaledZ,pt,Ye.canonical.z,ut,Ye.canonical.y)},Ye=>new _c(Ye.overscaledZ,Ye.wrap,Ye.canonical.z,Ye.canonical.x,(0===Ye.canonical.y?1<<Ye.canonical.z:Ye.canonical.y)-1),Ye=>new _c(Ye.overscaledZ,Ye.wrap,Ye.canonical.z,Ye.canonical.x,Ye.canonical.y===(1<<Ye.canonical.z)-1?0:Ye.canonical.y+1)];Mo(bc,"CanonicalTileID"),Mo(_c,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Rg=0,kg=25.5;function Ic(Ye){return _g*Math.cos(Ye*Math.PI/180)}function Tc(Ye){return(180+Ye)/360}function kc(Ye){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+Ye*Math.PI/360)))/360}function Pc(Ye,ut){return Ye/Ic(ut)}function zc(Ye){return 360*Ye-180}function Ec(Ye){return 360/Math.PI*Math.atan(Math.exp((180-360*Ye)*Math.PI/180))-90}function Bc(Ye,ut){return Ye*Ic(Ec(ut))}const Bg=85.051129;function Cc(Ye){return Math.cos($e(Ke(Ye,-Bg,Bg)))}function Rc(Ye,ut){const pt=Ke(ut,Rg,kg),wt=Math.pow(2,pt);return Cc(Ye)*_g/(512*wt)}function Vc(Ye){return 1/Math.cos(Ye*Math.PI/180)}function Lc(Ye,ut=0){const pt=Math.exp(Math.PI*(1-(Ye.y+ut/ym)/(1<<Ye.z)*2));return 80150034*pt/(pt*pt+1)/ym/(1<<Ye.z)}class Oc{constructor(Ye,ut,pt=0){this.x=+Ye,this.y=+ut,this.z=+pt}static fromLngLat(Ye,ut=0){const pt=mc.convert(Ye);return new Oc(Tc(pt.lng),kc(pt.lat),Pc(ut,pt.lat))}toLngLat(){return new mc(zc(this.x),Ec(this.y))}toAltitude(){return Bc(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/_g*Vc(Ec(this.y))}}function Fc(Ye,ut,pt,wt,Tt,St,It,Lt,$t){const Xt=(ut+wt)/2,Sr=(pt+Tt)/2,Lr=new wu(Xt,Sr);Lt(Lr),function(Ye,ut,pt,wt,Tt,St){const It=pt-Tt,Lt=wt-St;return Math.abs((wt-ut)*It-(pt-Ye)*Lt)/Math.hypot(It,Lt)}(Lr.x,Lr.y,St.x,St.y,It.x,It.y)>=$t?(Fc(Ye,ut,pt,Xt,Sr,St,Lr,Lt,$t),Fc(Ye,Xt,Sr,wt,Tt,Lr,It,Lt,$t)):Ye.push(It)}function Uc(Ye,ut,pt){let wt=Ye[0],Tt=wt.x,St=wt.y;ut(wt);const It=[wt];for(let Lt=1;Lt<Ye.length;Lt++){const $t=Ye[Lt],{x:Xt,y:Sr}=$t;ut($t),Fc(It,Tt,St,Xt,Sr,wt,$t,ut,pt),Tt=Xt,St=Sr,wt=$t}return It}function Nc(Ye,ut,pt,wt){if(wt(ut,pt)){const Tt=ut.add(pt)._mult(.5);Nc(Ye,ut,Tt,wt),Nc(Ye,Tt,pt,wt)}else Ye.push(pt)}function jc(Ye,ut){let pt=Ye[0];const wt=[pt];for(let Tt=1;Tt<Ye.length;Tt++){const St=Ye[Tt];Nc(wt,pt,St,ut),pt=St}return wt}const Vg=Math.pow(2,14)-1,Zg=-Vg-1;function Gc(Ye,ut){const pt=Math.round(Ye.x*ut),wt=Math.round(Ye.y*ut);return Ye.x=Ke(pt,Zg,Vg),Ye.y=Ke(wt,Zg,Vg),(pt<Ye.x||pt>Ye.x+1||wt<Ye.y||wt>Ye.y+1)&&fr("Geometry exceeds allowed extent, reduce your vector tile buffer size"),Ye}function Yc(Ye,ut,pt){const wt=Ye.loadGeometry(),Tt=Ye.extent,St=ym/Tt;if(ut&&pt&&pt.projection.isReprojectedInTileSpace){const St=1<<ut.z,{scale:It,x:Lt,y:$t,projection:Xt}=pt,c=Ye=>{const pt=zc((ut.x+Ye.x/Tt)/St),wt=Ec((ut.y+Ye.y/Tt)/St),Sr=Xt.project(pt,wt);Ye.x=(Sr.x*It-Lt)*Tt,Ye.y=(Sr.y*It-$t)*Tt};for(let ut=0;ut<wt.length;ut++)if(1!==Ye.type)wt[ut]=Uc(wt[ut],c,1);else{const Ye=[];for(const pt of wt[ut])pt.x<0||pt.x>=Tt||pt.y<0||pt.y>=Tt||(c(pt),Ye.push(pt));wt[ut]=Ye}}for(const Ye of wt)for(const ut of Ye)Gc(ut,St);return wt}function Xc(Ye,ut){return{type:Ye.type,id:Ye.id,properties:Ye.properties,geometry:ut?Yc(Ye):[]}}function Zc(Ye,ut,pt,wt,Tt){Ye.emplaceBack(2*ut+(wt+1)/2,2*pt+(Tt+1)/2)}function Hc(Ye,ut,pt){const wt=16384;Ye.emplaceBack(ut.x,ut.y,ut.z,pt[0]*wt,pt[1]*wt,pt[2]*wt)}class Kc{constructor(Ye){this.zoom=Ye.zoom,this.overscaling=Ye.overscaling,this.layers=Ye.layers,this.layerIds=this.layers.map((Ye=>Ye.fqid)),this.index=Ye.index,this.hasPattern=!1,this.projection=Ye.projection,this.layoutVertexArray=new Cl,this.indexArray=new Ql,this.segments=new Au,this.programConfigurations=new Wu(Ye.layers,{zoom:Ye.zoom,lut:Ye.lut}),this.stateDependentLayerIds=this.layers.filter((Ye=>Ye.isStateDependent())).map((Ye=>Ye.id))}updateFootprints(Ye,ut){}populate(Ye,ut,pt,wt){const Tt=this.layers[0],St=[];let It=null;"circle"===Tt.type&&(It=Tt.layout.get("circle-sort-key"));for(const{feature:ut,id:Tt,index:Lt,sourceLayerIndex:$t}of Ye){const Ye=this.layers[0]._featureFilter.needGeometry,Xt=Xc(ut,Ye);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Xt,pt))continue;const Sr=It?It.evaluate(Xt,{},pt):void 0,Lr={id:Tt,properties:ut.properties,type:ut.type,sourceLayerIndex:$t,index:Lt,geometry:Ye?Xt.geometry:Yc(ut,pt,wt),patterns:{},sortKey:Sr};St.push(Lr)}It&&St.sort(((Ye,ut)=>Ye.sortKey-ut.sortKey));let Lt=null;"globe"===wt.projection.name&&(this.globeExtVertexArray=new ql,Lt=wt.projection);for(const wt of St){const{geometry:Tt,index:St,sourceLayerIndex:It}=wt,$t=Ye[St].feature;this.addFeature(wt,Tt,St,ut.availableImages,pt,Lt,ut.brightness),ut.featureIndex.insert($t,Tt,St,It,this.index)}}update(Ye,ut,pt,wt,Tt){const St=0!==Object.keys(Ye).length;St&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(Ye,ut,St?this.stateDependentLayers:this.layers,pt,wt,Tt)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(Ye){this.uploaded||(this.layoutVertexBuffer=Ye.createVertexBuffer(this.layoutVertexArray,j_.members),this.indexBuffer=Ye.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=Ye.createVertexBuffer(this.globeExtVertexArray,G_.members))),this.programConfigurations.upload(Ye),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(Ye,ut,pt,wt,Tt,St,It){for(const pt of ut)for(const ut of pt){const pt=ut.x,wt=ut.y;if(pt<0||pt>=ym||wt<0||wt>=ym)continue;if(St){const Ye=St.projectTilePoint(pt,wt,Tt),ut=St.upVector(Tt,pt,wt),It=this.globeExtVertexArray;Hc(It,Ye,ut),Hc(It,Ye,ut),Hc(It,Ye,ut),Hc(It,Ye,ut)}const It=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,Ye.sortKey),Lt=It.vertexLength;Zc(this.layoutVertexArray,pt,wt,-1,-1),Zc(this.layoutVertexArray,pt,wt,1,-1),Zc(this.layoutVertexArray,pt,wt,1,1),Zc(this.layoutVertexArray,pt,wt,-1,1),this.indexArray.emplaceBack(Lt,Lt+1,Lt+2),this.indexArray.emplaceBack(Lt,Lt+2,Lt+3),It.vertexLength+=4,It.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,Ye,pt,{},wt,Tt,It)}}function Wc(Ye,ut){for(let pt=0;pt<Ye.length;pt++)if(ah(ut,Ye[pt]))return!0;for(let pt=0;pt<ut.length;pt++)if(ah(Ye,ut[pt]))return!0;return!!eh(Ye,ut)}function Jc(Ye,ut,pt){return!!ah(Ye,ut)||!!nh(ut,Ye,pt)}function Qc(Ye,ut){if(1===Ye.length)return sh(ut,Ye[0]);for(let pt=0;pt<ut.length;pt++){const wt=ut[pt];for(let ut=0;ut<wt.length;ut++)if(ah(Ye,wt[ut]))return!0}for(let pt=0;pt<Ye.length;pt++)if(sh(ut,Ye[pt]))return!0;for(let pt=0;pt<ut.length;pt++)if(eh(Ye,ut[pt]))return!0;return!1}function th(Ye,ut,pt){if(Ye.length>1){if(eh(Ye,ut))return!0;for(let wt=0;wt<ut.length;wt++)if(nh(ut[wt],Ye,pt))return!0}for(let wt=0;wt<Ye.length;wt++)if(nh(Ye[wt],ut,pt))return!0;return!1}function eh(Ye,ut){if(0===Ye.length||0===ut.length)return!1;for(let pt=0;pt<Ye.length-1;pt++){const wt=Ye[pt],Tt=Ye[pt+1];for(let Ye=0;Ye<ut.length-1;Ye++)if(rh(wt,Tt,ut[Ye],ut[Ye+1]))return!0}return!1}function rh(Ye,ut,pt,wt){return dr(Ye,pt,wt)!==dr(ut,pt,wt)&&dr(Ye,ut,pt)!==dr(Ye,ut,wt)}function nh(Ye,ut,pt){const wt=pt*pt;if(1===ut.length)return Ye.distSqr(ut[0])<wt;for(let pt=1;pt<ut.length;pt++)if(ih(Ye,ut[pt-1],ut[pt])<wt)return!0;return!1}function ih(Ye,ut,pt){const wt=ut.distSqr(pt);if(0===wt)return Ye.distSqr(ut);const Tt=((Ye.x-ut.x)*(pt.x-ut.x)+(Ye.y-ut.y)*(pt.y-ut.y))/wt;return Ye.distSqr(Tt<0?ut:Tt>1?pt:pt.sub(ut)._mult(Tt)._add(ut))}function sh(Ye,ut){let pt,wt,Tt,St=!1;for(let It=0;It<Ye.length;It++){pt=Ye[It];for(let Ye=0,It=pt.length-1;Ye<pt.length;It=Ye++)wt=pt[Ye],Tt=pt[It],wt.y>ut.y!=Tt.y>ut.y&&ut.x<(Tt.x-wt.x)*(ut.y-wt.y)/(Tt.y-wt.y)+wt.x&&(St=!St)}return St}function ah(Ye,ut){let pt=!1;for(let wt=0,Tt=Ye.length-1;wt<Ye.length;Tt=wt++){const St=Ye[wt],It=Ye[Tt];St.y>ut.y!=It.y>ut.y&&ut.x<(It.x-St.x)*(ut.y-St.y)/(It.y-St.y)+St.x&&(pt=!pt)}return pt}function oh(Ye,ut,pt,wt,Tt){for(const St of Ye)if(ut<=St.x&&pt<=St.y&&wt>=St.x&&Tt>=St.y)return!0;const St=[new wu(ut,pt),new wu(ut,Tt),new wu(wt,Tt),new wu(wt,pt)];if(Ye.length>2)for(const ut of St)if(ah(Ye,ut))return!0;for(let ut=0;ut<Ye.length-1;ut++)if(lh(Ye[ut],Ye[ut+1],St))return!0;return!1}function lh(Ye,ut,pt){const wt=pt[0],Tt=pt[2];if(Ye.x<wt.x&&ut.x<wt.x||Ye.x>Tt.x&&ut.x>Tt.x||Ye.y<wt.y&&ut.y<wt.y||Ye.y>Tt.y&&ut.y>Tt.y)return!1;const St=dr(Ye,ut,pt[0]);return St!==dr(Ye,ut,pt[1])||St!==dr(Ye,ut,pt[2])||St!==dr(Ye,ut,pt[3])}function uh(Ye,ut,pt,wt,Tt,St){let It=ut.y-Ye.y,Lt=Ye.x-ut.x;if(St=St||0){const Ye=It*It+Lt*Lt;if(0===Ye)return!0;const ut=Math.sqrt(Ye);It/=ut,Lt/=ut}return!((pt.x-Ye.x)*It+(pt.y-Ye.y)*Lt-St<0||(wt.x-Ye.x)*It+(wt.y-Ye.y)*Lt-St<0||(Tt.x-Ye.x)*It+(Tt.y-Ye.y)*Lt-St<0)}function ch(Ye,ut,pt,wt,Tt,St,It){return!(uh(Ye,ut,wt,Tt,St,It)||uh(ut,pt,wt,Tt,St,It)||uh(pt,Ye,wt,Tt,St,It)||uh(wt,Tt,Ye,ut,pt,It)||uh(Tt,St,Ye,ut,pt,It)||uh(St,wt,Ye,ut,pt,It))}function hh(Ye,ut,pt){const wt=ut.paint.get(Ye).value;return"constant"===wt.kind?wt.value:pt.programConfigurations.get(ut.id).getMaxValue(Ye)}function ph(Ye){return Math.sqrt(Ye[0]*Ye[0]+Ye[1]*Ye[1])}function fh(Ye,ut,pt,wt,Tt){if(!ut[0]&&!ut[1])return Ye;const St=wu.convert(ut)._mult(Tt);"viewport"===pt&&St._rotate(-wt);const It=[];for(let ut=0;ut<Ye.length;ut++)It.push(Ye[ut].sub(St));return It}function dh(Ye,ut,pt,wt){const Tt=wu.convert(Ye)._mult(wt);return"viewport"===ut&&Tt._rotate(-pt),Tt}Mo(Kc,"CircleBucket",{omit:["layers"]});const Wg=new ol({"circle-sort-key":new sl(O_.layout_circle["circle-sort-key"]),visibility:new il(O_.layout_circle.visibility)});var Hg={paint:new ol({"circle-radius":new sl(O_.paint_circle["circle-radius"]),"circle-color":new sl(O_.paint_circle["circle-color"]),"circle-blur":new sl(O_.paint_circle["circle-blur"]),"circle-opacity":new sl(O_.paint_circle["circle-opacity"]),"circle-translate":new il(O_.paint_circle["circle-translate"]),"circle-translate-anchor":new il(O_.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new il(O_.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new il(O_.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new sl(O_.paint_circle["circle-stroke-width"]),"circle-stroke-color":new sl(O_.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new sl(O_.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new il(O_.paint_circle["circle-emissive-strength"])}),layout:Wg};class gh{constructor(Ye,ut){this.pos=Ye,this.dir=ut}intersectsPlane(ut,pt,wt){const Tt=Ye._.dot(pt,this.dir);if(Math.abs(Tt)<1e-6)return!1;const St=((ut[0]-this.pos[0])*pt[0]+(ut[1]-this.pos[1])*pt[1]+(ut[2]-this.pos[2])*pt[2])/Tt;return wt[0]=this.pos[0]+this.dir[0]*St,wt[1]=this.pos[1]+this.dir[1]*St,wt[2]=this.pos[2]+this.dir[2]*St,!0}closestPointOnSphere(ut,pt,wt){if(Ye._.equals(this.pos,ut)||0===pt)return wt[0]=wt[1]=wt[2]=0,!1;const[Tt,St,It]=this.dir,Lt=this.pos[0]-ut[0],$t=this.pos[1]-ut[1],Xt=this.pos[2]-ut[2],Sr=Tt*Tt+St*St+It*It,Lr=2*(Lt*Tt+$t*St+Xt*It),Qr=Lr*Lr-4*Sr*(Lt*Lt+$t*$t+Xt*Xt-pt*pt);if(Qr<0){const Ye=Math.max(-Lr/2,0),ut=Lt+Tt*Ye,Sr=$t+St*Ye,Qr=Xt+It*Ye,fn=Math.hypot(ut,Sr,Qr);return wt[0]=ut*pt/fn,wt[1]=Sr*pt/fn,wt[2]=Qr*pt/fn,!1}{const Ye=(-Lr-Math.sqrt(Qr))/(2*Sr);if(Ye<0){const Ye=Math.hypot(Lt,$t,Xt);return wt[0]=Lt*pt/Ye,wt[1]=$t*pt/Ye,wt[2]=Xt*pt/Ye,!1}return wt[0]=Lt+Tt*Ye,wt[1]=$t+St*Ye,wt[2]=Xt+It*Ye,!0}}}class xh{constructor(Ye,ut,pt,wt,Tt){this.TL=Ye,this.TR=ut,this.BR=pt,this.BL=wt,this.horizon=Tt}static fromInvProjectionMatrix(ut,pt,wt){const Tt=[-1,1,1],St=[1,1,1],It=[1,-1,1],Lt=[-1,-1,1],$t=Ye._.transformMat4(Tt,Tt,ut),Xt=Ye._.transformMat4(St,St,ut),Sr=Ye._.transformMat4(It,It,ut),Lr=Ye._.transformMat4(Lt,Lt,ut);return new xh($t,Xt,Sr,Lr,pt/wt)}}function bh(ut,pt,wt){let Tt=1/0,St=-1/0;const It=[];for(const Lt of ut){Ye._.sub(It,Lt,pt);const ut=Ye._.dot(It,wt);Tt=Math.min(Tt,ut),St=Math.max(St,ut)}return[Tt,St]}function vh(ut,pt){let wt=!0;for(let Tt=0;Tt<ut.planes.length;Tt++){const St=ut.planes[Tt];let It=0;for(let ut=0;ut<pt.length;ut++)It+=Ye._.dot(St,pt[ut])+St[3]>=0;if(0===It)return 0;It!==pt.length&&(wt=!1)}return wt?2:1}function _h(Ye,ut){for(const pt of Ye.projections){const wt=bh(ut,Ye.points[0],pt.axis);if(pt.projection[1]<wt[0]||pt.projection[0]>wt[1])return 0}return 1}function wh(ut,pt){let wt=0;const Tt=[0,0,0,0];for(let St=0;St<ut.length;St++)Tt[0]=ut[St][0],Tt[1]=ut[St][1],Tt[2]=ut[St][2],Tt[3]=1,Ye.aA.dot(Tt,pt)>=0&&wt++;return wt}class Mh{constructor(ut,pt){this.points=ut||new Array(8).fill([0,0,0]),this.planes=pt||new Array(6).fill([0,0,0,0]),this.bounds=Ah.fromPoints(this.points),this.projections=[],this.frustumEdges=[Ye._.sub([],this.points[2],this.points[3]),Ye._.sub([],this.points[0],this.points[3]),Ye._.sub([],this.points[4],this.points[0]),Ye._.sub([],this.points[5],this.points[1]),Ye._.sub([],this.points[6],this.points[2]),Ye._.sub([],this.points[7],this.points[3])];for(const Ye of this.frustumEdges){const ut=[0,-Ye[2],Ye[1]],pt=[Ye[2],0,-Ye[0]];this.projections.push({axis:ut,projection:bh(this.points,this.points[0],ut)}),this.projections.push({axis:pt,projection:bh(this.points,this.points[0],pt)})}}static fromInvProjectionMatrix(ut,pt,wt,Tt){const St=Math.pow(2,wt),It=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((wt=>{const It=Ye.aA.transformMat4([],wt,ut),Lt=1/It[3]/pt*St;return Ye.aA.mul(It,It,[Lt,Lt,Tt?1/It[3]:Lt,Lt])})),Lt=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((ut=>{const pt=Ye._.sub([],It[ut[0]],It[ut[1]]),wt=Ye._.sub([],It[ut[2]],It[ut[1]]),Tt=Ye._.normalize([],Ye._.cross([],pt,wt)),St=-Ye._.dot(Tt,It[ut[1]]);return Tt.concat(St)})),$t=[];for(let Ye=0;Ye<It.length;Ye++)$t.push([It[Ye][0],It[Ye][1],It[Ye][2]]);return new Mh($t,Lt)}intersectsPrecise(ut,pt,wt){for(let Ye=0;Ye<pt.length;Ye++)if(!wh(ut,pt[Ye]))return 0;for(let Ye=0;Ye<this.planes.length;Ye++)if(!wh(ut,this.planes[Ye]))return 0;for(const pt of wt)for(const wt of this.frustumEdges){const Tt=Ye._.cross([],pt,wt),St=Ye._.length(Tt);if(0===St)continue;Ye._.scale(Tt,Tt,1/St);const It=bh(this.points,this.points[0],Tt),Lt=bh(ut,this.points[0],Tt);if(It[0]>Lt[1]||Lt[0]>It[1])return 0}return 1}}class Ah{static fromPoints(ut){const pt=[1/0,1/0,1/0],wt=[-1/0,-1/0,-1/0];for(const Tt of ut)Ye._.min(pt,pt,Tt),Ye._.max(wt,wt,Tt);return new Ah(pt,wt)}static fromTileIdAndHeight(Ye,ut,pt){const wt=1<<Ye.canonical.z,Tt=Ye.canonical.x,St=Ye.canonical.y;return new Ah([Tt/wt,St/wt,ut],[(Tt+1)/wt,(St+1)/wt,pt])}static applyTransform(ut,pt){const wt=ut.getCorners();for(let ut=0;ut<wt.length;++ut)Ye._.transformMat4(wt[ut],wt[ut],pt);return Ah.fromPoints(wt)}static applyTransformFast(Ye,ut){const pt=[ut[12],ut[13],ut[14]],wt=[...pt];for(let Tt=0;Tt<3;Tt++)for(let St=0;St<3;St++){const It=ut[4*St+Tt],Lt=It*Ye.min[St],$t=It*Ye.max[St];pt[Tt]+=Math.min(Lt,$t),wt[Tt]+=Math.max(Lt,$t)}return new Ah(pt,wt)}static projectAabbCorners(ut,pt){const wt=ut.getCorners();for(let ut=0;ut<wt.length;++ut)Ye._.transformMat4(wt[ut],wt[ut],pt);return wt}constructor(ut,pt){this.min=ut,this.max=pt,this.center=Ye._.scale([],Ye._.add([],this.min,this.max),.5)}quadrant(ut){const pt=[ut%2==0,ut<2],wt=Ye._.clone(this.min),Tt=Ye._.clone(this.max);for(let Ye=0;Ye<pt.length;Ye++)wt[Ye]=pt[Ye]?this.min[Ye]:this.center[Ye],Tt[Ye]=pt[Ye]?this.center[Ye]:this.max[Ye];return Tt[2]=this.max[2],new Ah(wt,Tt)}distanceX(Ye){return Math.max(Math.min(this.max[0],Ye[0]),this.min[0])-Ye[0]}distanceY(Ye){return Math.max(Math.min(this.max[1],Ye[1]),this.min[1])-Ye[1]}distanceZ(Ye){return Math.max(Math.min(this.max[2],Ye[2]),this.min[2])-Ye[2]}getCorners(){const Ye=this.min,ut=this.max;return[[Ye[0],Ye[1],Ye[2]],[ut[0],Ye[1],Ye[2]],[ut[0],ut[1],Ye[2]],[Ye[0],ut[1],Ye[2]],[Ye[0],Ye[1],ut[2]],[ut[0],Ye[1],ut[2]],[ut[0],ut[1],ut[2]],[Ye[0],ut[1],ut[2]]]}intersects(Ye){return this.intersectsAabb(Ye.bounds)?vh(Ye,this.getCorners()):0}intersectsFlat(Ye){return this.intersectsAabb(Ye.bounds)?vh(Ye,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(Ye,ut){return ut||this.intersects(Ye)?_h(Ye,this.getCorners()):0}intersectsPreciseFlat(Ye,ut){return ut||this.intersectsFlat(Ye)?_h(Ye,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(Ye){for(let ut=0;ut<3;++ut)if(this.min[ut]>Ye.max[ut]||Ye.min[ut]>this.max[ut])return!1;return!0}intersectsAabbXY(Ye){return!(this.min[0]>Ye.max[0]||Ye.min[0]>this.max[0]||this.min[1]>Ye.max[1]||Ye.min[1]>this.max[1])}encapsulate(Ye){for(let ut=0;ut<3;ut++)this.min[ut]=Math.min(this.min[ut],Ye.min[ut]),this.max[ut]=Math.max(this.max[ut],Ye.max[ut])}encapsulatePoint(Ye){for(let ut=0;ut<3;ut++)this.min[ut]=Math.min(this.min[ut],Ye[ut]),this.max[ut]=Math.max(this.max[ut],Ye[ut])}closestPoint(Ye){return[Math.max(Math.min(this.max[0],Ye[0]),this.min[0]),Math.max(Math.min(this.max[1],Ye[1]),this.min[1]),Math.max(Math.min(this.max[2],Ye[2]),this.min[2])]}}Mo(Ah,"Aabb");const Xg=Bl([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Kg}=Xg,Jg=Bl([{name:"a_pos_3",components:3,type:"Int16"}]);var ty=Bl([{name:"a_pos",type:"Int16",components:2}]);function Ph(Ye){return Ye*J_/mg}const iy=[new Ah([ug,ug,ug],[pg,pg,pg]),new Ah([ug,ug,ug],[0,0,pg]),new Ah([0,ug,ug],[pg,0,pg]),new Ah([ug,0,ug],[0,pg,pg]),new Ah([0,0,ug],[pg,pg,pg])];function Eh(ut,pt,wt,Tt=!0){const St=Ye._.scale([],ut._camera.position,ut.worldSize),It=[pt,wt,1,1];Ye.aA.transformMat4(It,It,ut.pixelMatrixInverse),Ye.aA.scale(It,It,1/It[3]);const Lt=Ye._.sub([],It,St),$t=Ye._.normalize([],Lt),Xt=ut.globeMatrix,Sr=[Xt[12],Xt[13],Xt[14]],Lr=Ye._.sub([],Sr,St),Qr=Ye._.length(Lr),fn=Ye._.normalize([],Lr),xn=ut.worldSize/(2*Math.PI),vn=Ye._.dot(fn,$t),kn=Math.asin(xn/Qr);if(kn<Math.acos(vn)){if(!Tt)return null;const ut=[],pt=[];Ye._.scale(ut,$t,Qr/vn),Ye._.normalize(pt,Ye._.sub(pt,ut,Lr)),Ye._.normalize($t,Ye._.add($t,Lr,Ye._.scale($t,pt,Math.tan(kn)*Qr)))}const Wn=[];new gh(St,$t).closestPointOnSphere(Sr,xn,Wn);const Xn=Ye._.normalize([],Tr(Xt,0)),Jn=Ye._.normalize([],Tr(Xt,1)),Qn=Ye._.normalize([],Tr(Xt,2)),ko=Ye._.dot(Xn,Wn),Fo=Ye._.dot(Jn,Wn),is=Ye._.dot(Qn,Wn),ns=Ge(Math.asin(-Fo/xn));let ss=Ge(Math.atan2(ko,is));ss=ut.center.lng+function(Ye,ut){const pt=(ut-Ye+180)%360-180;return pt<-180?pt+360:pt}(ut.center.lng,ss);const as=Tc(ss),ds=Ke(kc(ns),0,1);return new Oc(as,ds)}class Bh{constructor(ut,pt,wt){this.a=Ye._.sub([],ut,wt),this.b=Ye._.sub([],pt,wt),this.center=wt;const Tt=Ye._.normalize([],this.a),St=Ye._.normalize([],this.b);this.angle=Math.acos(Ye._.dot(Tt,St))}}function Dh(Ye,ut){if(0===Ye.angle)return null;let pt;return pt=0===Ye.a[ut]?1/Ye.angle*.5*Math.PI:1/Ye.angle*Math.atan(Ye.b[ut]/Ye.a[ut]/Math.sin(Ye.angle)-1/Math.tan(Ye.angle)),pt<0||pt>1?null:function(Ye,ut,pt,wt){const Tt=Math.sin(pt);return Ye*(Math.sin((1-wt)*pt)/Tt)+ut*(Math.sin(wt*pt)/Tt)}(Ye.a[ut],Ye.b[ut],Ye.angle,Ke(pt,0,1))+Ye.center[ut]}function Ch(Ye){if(Ye.z<=1)return iy[Ye.z+2*Ye.y+Ye.x];const ut=Uh(Fh(Ye));return Ah.fromPoints(ut)}function Rh(ut,pt,wt){return Ye._.scale(ut,ut,1-wt),Ye._.scaleAndAdd(ut,ut,pt,wt)}function Vh(ut,pt){const wt=Hh(pt.zoom);if(0===wt)return Ch(ut);const Tt=Fh(ut),St=Uh(Tt),It=Tc(Tt.getWest())*pt.worldSize,Lt=Tc(Tt.getEast())*pt.worldSize,$t=kc(Tt.getNorth())*pt.worldSize,Xt=kc(Tt.getSouth())*pt.worldSize,Sr=[It,$t,0],Lr=[Lt,$t,0],Qr=[It,Xt,0],fn=[Lt,Xt,0],xn=Ye.ad.invert([],pt.globeMatrix);return Ye._.transformMat4(Sr,Sr,xn),Ye._.transformMat4(Lr,Lr,xn),Ye._.transformMat4(Qr,Qr,xn),Ye._.transformMat4(fn,fn,xn),St[0]=Rh(St[0],Qr,wt),St[1]=Rh(St[1],fn,wt),St[2]=Rh(St[2],Lr,wt),St[3]=Rh(St[3],Sr,wt),Ah.fromPoints(St)}function Lh(ut,pt,wt){for(const Tt of ut)Ye._.transformMat4(Tt,Tt,pt),Ye._.scale(Tt,Tt,wt)}function Oh(ut,pt,wt,Tt){const St=pt/ut.worldSize,It=ut.globeMatrix;if(wt.z<=1){const Ye=Ch(wt).getCorners();return Lh(Ye,It,St),Ah.fromPoints(Ye)}const Lt=Fh(wt,Tt),$t=Uh(Lt,J_+Ph(ut._tileCoverLift));Lh($t,It,St);const Xt=Number.MAX_VALUE,Sr=[-Xt,-Xt,-Xt],Lr=[Xt,Xt,Xt];if(Lt.contains(ut.center)){for(const ut of $t)Ye._.min(Lr,Lr,ut),Ye._.max(Sr,Sr,ut);Sr[2]=0;const pt=ut.point,wt=[pt.x*St,pt.y*St,0];return Ye._.min(Lr,Lr,wt),Ye._.max(Sr,Sr,wt),new Ah(Lr,Sr)}if(ut._tileCoverLift>0){for(const ut of $t)Ye._.min(Lr,Lr,ut),Ye._.max(Sr,Sr,ut);return new Ah(Lr,Sr)}const Qr=[It[12]*St,It[13]*St,It[14]*St],fn=Lt.getCenter(),xn=Ke(ut.center.lat,-Bg,Bg),vn=Ke(fn.lat,-Bg,Bg),kn=Tc(ut.center.lng),Wn=kc(xn);let Xn=kn-Tc(fn.lng);const Jn=Wn-kc(vn);Xn>.5?Xn-=1:Xn<-.5&&(Xn+=1);let Qn=0;if(Math.abs(Xn)>Math.abs(Jn))Qn=Xn>=0?1:3;else{Qn=Jn>=0?0:2;const ut=[It[4]*St,It[5]*St,It[6]*St],pt=-Math.sin($e(Jn>=0?Lt.getSouth():Lt.getNorth()))*J_;Ye._.scaleAndAdd(Qr,Qr,ut,pt)}const ko=$t[Qn],Fo=$t[(Qn+1)%4],is=new Bh(ko,Fo,Qr),ns=[Dh(is,0)||ko[0],Dh(is,1)||ko[1],Dh(is,2)||ko[2]],ss=Hh(ut.zoom);if(ss>0){const Tt=function({x:Ye,y:ut,z:pt},wt,Tt,St,It){const Lt=1/(1<<pt);let $t=Ye*Lt,Xt=$t+Lt,Sr=ut*Lt,Lr=Sr+Lt,Qr=0;const fn=($t+Xt)/2-St;return fn>.5?Qr=-1:fn<-.5&&(Qr=1),$t=(($t+Qr)*wt-(St*=wt))*Tt+St,Xt=((Xt+Qr)*wt-St)*Tt+St,Sr=(Sr*wt-(It*=wt))*Tt+It,Lr=(Lr*wt-It)*Tt+It,[[$t,Lr,0],[Xt,Lr,0],[Xt,Sr,0],[$t,Sr,0]]}(wt,pt,ut._pixelsPerMercatorPixel,kn,Wn);for(let Ye=0;Ye<$t.length;Ye++)Rh($t[Ye],Tt[Ye],ss);const St=Ye._.add([],Tt[Qn],Tt[(Qn+1)%4]);Ye._.scale(St,St,.5),Rh(ns,St,ss)}for(const ut of $t)Ye._.min(Lr,Lr,ut),Ye._.max(Sr,Sr,ut);return Lr[2]=Math.min(ko[2],Fo[2]),Ye._.min(Lr,Lr,ns),Ye._.max(Sr,Sr,ns),new Ah(Lr,Sr)}function Fh({x:Ye,y:ut,z:pt},wt=!1){const Tt=1/(1<<pt),St=new mc(zc(Ye*Tt),ut===(1<<pt)-1&&wt?-90:Ec((ut+1)*Tt)),It=new mc(zc((Ye+1)*Tt),0===ut&&wt?90:Ec(ut*Tt));return new yc(St,It)}function Uh(Ye,ut=J_){const pt=$e(Ye.getNorth()),wt=$e(Ye.getSouth()),Tt=Math.cos(pt),St=Math.cos(wt),It=Math.sin(pt),Lt=Math.sin(wt),$t=Ye.getWest(),Xt=Ye.getEast();return[hc(St,Lt,$t,ut),hc(St,Lt,Xt,ut),hc(Tt,It,Xt,ut),hc(Tt,It,$t,ut)]}function Nh(Ye,ut,pt,wt){const Tt=1<<pt.z,St=(Ye/ym+pt.x)/Tt;return pc(Ec((ut/ym+pt.y)/Tt),zc(St),wt)}function jh({min:Ye,max:ut}){return lg/Math.max(ut[0]-Ye[0],ut[1]-Ye[1],ut[2]-Ye[2])}const sy=new Float64Array(16);function $h(ut){const pt=jh(ut),wt=Ye.ad.fromScaling(sy,[pt,pt,pt]);return Ye.ad.translate(wt,wt,Ye._.negate([],ut.min))}function Gh(ut){const pt=Ye.ad.fromTranslation(sy,ut.min),wt=1/jh(ut);return Ye.ad.scale(pt,pt,[wt,wt,wt])}function Yh(Ye){const ut=ym/(2*Math.PI);return Ye/(2*Math.PI)/ut}function Xh(Ye,ut){return ym/(512*Math.pow(2,Ye))*jh(Ch(ut))}function Zh(ut,pt,wt,Tt,St){const It=Yh(wt),Lt=[ut,pt,-wt/(2*Math.PI)],$t=Ye.ad.identity(new Float64Array(16));return Ye.ad.translate($t,$t,Lt),Ye.ad.scale($t,$t,[It,It,It]),Ye.ad.rotateX($t,$t,$e(-St)),Ye.ad.rotateY($t,$t,$e(-Tt)),$t}function Hh(Ye){return We(Q_,sg,Ye)}function Kh(ut,pt){const wt=pc(pt.lat,pt.lng),Tt=function(ut){const pt=pc(ut._center.lat,ut._center.lng),wt=Ye._.fromValues(0,1,0);let Tt=Ye._.cross([],wt,pt);const St=Ye.ad.fromRotation([],-ut.angle,pt);Tt=Ye._.transformMat4(Tt,Tt,St),Ye.ad.fromRotation(St,-ut._pitch,Tt);const It=Ye._.normalize([],pt);return Ye._.scale(It,It,Ph(ut.cameraToCenterDistance/ut.pixelsPerMeter)),Ye._.transformMat4(It,It,St),Ye._.add([],pt,It)}(ut),St=Ye._.subtract([],Tt,wt);return Ye._.angle(St,wt)}function Wh(Ye,ut){return Kh(Ye,ut)>Math.PI/2*1.01}const Ey=$e(85),Sy=Math.cos(Ey),Cy=Math.sin(Ey),ky=Ye.ad.create(),rp=Ye=>{const ut=[];return"map"===Ye.paint.get("circle-pitch-alignment")&&ut.push("PITCH_WITH_MAP"),"map"===Ye.paint.get("circle-pitch-scale")&&ut.push("SCALE_WITH_MAP"),ut};function np(ut,pt,wt,Tt,St,It,Lt,$t,Xt){if(It&&ut.queryGeometry.isAboveHorizon)return!1;It&&(Xt*=ut.pixelToTileUnitsFactor);const Sr=ut.tileID.canonical,Lr=wt.projection.upVectorScale(Sr,wt.center.lat,wt.worldSize).metersToTile;for(const Qr of pt)for(const pt of Qr){const Qr=pt.add($t),fn=St&&wt.elevation?wt.elevation.exaggeration()*St.getElevationAt(Qr.x,Qr.y,!0):0,xn=wt.projection.projectTilePoint(Qr.x,Qr.y,Sr);if(fn>0){const Ye=wt.projection.upVector(Sr,Qr.x,Qr.y);xn.x+=Ye[0]*Lr*fn,xn.y+=Ye[1]*Lr*fn,xn.z+=Ye[2]*Lr*fn}const vn=It?Qr:ip(xn.x,xn.y,xn.z,Tt),kn=It?ut.tilespaceRays.map((Ye=>op(Ye,fn))):ut.queryGeometry.screenGeometry,Wn=Ye.aA.transformMat4([],[xn.x,xn.y,xn.z,1],Tt);if(!Lt&&It?Xt*=Wn[3]/wt.cameraToCenterDistance:Lt&&!It&&(Xt*=wt.cameraToCenterDistance/Wn[3]),It){const Ye=Ec((pt.y/ym+Sr.y)/(1<<Sr.z));Xt/=wt.projection.pixelsPerMeter(Ye,1)/Pc(1,Ye)}if(Jc(kn,vn,Xt))return!0}return!1}function ip(ut,pt,wt,Tt){const St=Ye.aA.transformMat4([],[ut,pt,wt,1],Tt);return new wu(St[0]/St[3],St[1]/St[3])}const By=Ye._.fromValues(0,0,0),Gy=Ye._.fromValues(0,0,1);function op(ut,pt){const wt=Ye._.create();return By[2]=pt,ut.intersectsPlane(By,Gy,wt),new wu(wt[0],wt[1])}class lp extends Kc{}function up(Ye,{width:ut,height:pt},wt,Tt){if(Tt){if(Tt instanceof Uint8ClampedArray)Tt=new Uint8Array(Tt.buffer);else if(Tt.length!==ut*pt*wt)throw new RangeError("mismatched image size")}else Tt=new Uint8Array(ut*pt*wt);return Ye.width=ut,Ye.height=pt,Ye.data=Tt,Ye}function cp(Ye,ut,pt){const{width:wt,height:Tt}=ut;wt===Ye.width&&Tt===Ye.height||(hp(Ye,ut,{x:0,y:0},{x:0,y:0},{width:Math.min(Ye.width,wt),height:Math.min(Ye.height,Tt)},pt,null),Ye.width=wt,Ye.height=Tt,Ye.data=ut.data)}function hp(Ye,ut,pt,wt,Tt,St,It,Lt){if(0===Tt.width||0===Tt.height)return ut;if(Tt.width>Ye.width||Tt.height>Ye.height||pt.x>Ye.width-Tt.width||pt.y>Ye.height-Tt.height)throw new RangeError("out of range source coordinates for image copy");if(Tt.width>ut.width||Tt.height>ut.height||wt.x>ut.width-Tt.width||wt.y>ut.height-Tt.height)throw new RangeError("out of range destination coordinates for image copy");const $t=Ye.data,Xt=ut.data,Sr=4===St&&Lt;for(let Lt=0;Lt<Tt.height;Lt++){const Lr=((pt.y+Lt)*Ye.width+pt.x)*St,Qr=((wt.y+Lt)*ut.width+wt.x)*St;if(Sr)for(let Ye=0;Ye<Tt.width;Ye++){const ut=Lr+Ye*St+3,pt=Qr+Ye*St;Xt[pt+0]=255,Xt[pt+1]=255,Xt[pt+2]=255,Xt[pt+3]=$t[ut]}else if(It)for(let Ye=0;Ye<Tt.width;Ye++){const ut=Lr+Ye*St,pt=Qr+Ye*St,wt=$t[ut+3],Tt=new qn($t[ut+0]/255*wt,$t[ut+1]/255*wt,$t[ut+2]/255*wt,wt).toRenderColor(It).toArray();Xt[pt+0]=Tt[0],Xt[pt+1]=Tt[1],Xt[pt+2]=Tt[2],Xt[pt+3]=Tt[3]}else for(let Ye=0;Ye<Tt.width*St;Ye++)Xt[Qr+Ye]=$t[Lr+Ye]}return ut}Mo(lp,"HeatmapBucket",{omit:["layers"]});class pp{constructor(Ye,ut){up(this,Ye,1,ut)}resize(Ye){cp(this,new pp(Ye),1)}clone(){return new pp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(Ye,ut,pt,wt,Tt){hp(Ye,ut,pt,wt,Tt,1,null)}}class fp{constructor(Ye,ut){up(this,Ye,4,ut)}resize(Ye){cp(this,new fp(Ye),4)}replace(Ye,ut){ut?this.data.set(Ye):this.data=Ye instanceof Uint8ClampedArray?new Uint8Array(Ye.buffer):Ye}clone(){return new fp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(Ye,ut,pt,wt,Tt,St,It){hp(Ye,ut,pt,wt,Tt,4,St,It)}}class dp{constructor(Ye,ut){this.width=Ye.width,this.height=Ye.height,this.data=ut instanceof Uint8Array?new Float32Array(ut.buffer):ut}}Mo(pp,"AlphaImage"),Mo(fp,"RGBAImage");const $y=new ol({visibility:new il(O_.layout_heatmap.visibility)});var Hy={paint:new ol({"heatmap-radius":new sl(O_.paint_heatmap["heatmap-radius"]),"heatmap-weight":new sl(O_.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new il(O_.paint_heatmap["heatmap-intensity"]),"heatmap-color":new al(O_.paint_heatmap["heatmap-color"]),"heatmap-opacity":new il(O_.paint_heatmap["heatmap-opacity"])}),layout:$y};function gp(Ye){const ut={},pt=Ye.resolution||256,wt=Ye.clips?Ye.clips.length:1,Tt=Ye.image||new fp({width:pt,height:wt}),s=(pt,wt,St)=>{ut[Ye.evaluationKey]=St;const It=Ye.expression.evaluate(ut);It&&(Tt.data[pt+wt+0]=Math.floor(255*It.r/It.a),Tt.data[pt+wt+1]=Math.floor(255*It.g/It.a),Tt.data[pt+wt+2]=Math.floor(255*It.b/It.a),Tt.data[pt+wt+3]=Math.floor(255*It.a))};if(Ye.clips)for(let ut=0,Tt=0;ut<wt;++ut,Tt+=4*pt)for(let wt=0,St=0;wt<pt;wt++,St+=4){const It=wt/(pt-1),{start:Lt,end:$t}=Ye.clips[ut];s(Tt,St,Lt*(1-It)+$t*It)}else for(let Ye=0,ut=0;Ye<pt;Ye++,ut+=4)s(0,ut,Ye/(pt-1));return Tt}const Ky=new ol({visibility:new il(O_.layout_hillshade.visibility)});var ex={paint:new ol({"hillshade-illumination-direction":new il(O_.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new il(O_.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new il(O_.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new il(O_.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new il(O_.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new il(O_.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new il(O_.paint_hillshade["hillshade-emissive-strength"])}),layout:Ky};const tx=Bl([{name:"a_pos",components:2,type:"Int16"}],4),{members:rx}=tx;function wp(Ye,ut,pt=2){const wt=ut&&ut.length,Tt=wt?ut[0]*pt:Ye.length;let St=Mp(Ye,0,Tt,pt,!0);const It=[];if(!St||St.next===St.prev)return It;let Lt,$t,Xt;if(wt&&(St=function(Ye,ut,pt,wt){const Tt=[];for(let pt=0,St=ut.length;pt<St;pt++){const It=Mp(Ye,ut[pt]*wt,pt<St-1?ut[pt+1]*wt:Ye.length,wt,!1);It===It.next&&(It.steiner=!0),Tt.push(Cp(It))}Tt.sort(zp);for(let Ye=0;Ye<Tt.length;Ye++)pt=Ep(Tt[Ye],pt);return pt}(Ye,ut,St,pt)),Ye.length>80*pt){Lt=1/0,$t=1/0;let ut=-1/0,wt=-1/0;for(let St=pt;St<Tt;St+=pt){const pt=Ye[St],Tt=Ye[St+1];pt<Lt&&(Lt=pt),Tt<$t&&($t=Tt),pt>ut&&(ut=pt),Tt>wt&&(wt=Tt)}Xt=Math.max(ut-Lt,wt-$t),Xt=0!==Xt?32767/Xt:0}return Sp(St,It,pt,Lt,$t,Xt,0),It}function Mp(Ye,ut,pt,wt,Tt){let St;if(Tt===function(Ye,ut,pt,wt){let Tt=0;for(let St=ut,It=pt-wt;St<pt;St+=wt)Tt+=(Ye[It]-Ye[St])*(Ye[St+1]+Ye[It+1]),It=St;return Tt}(Ye,ut,pt,wt)>0)for(let Tt=ut;Tt<pt;Tt+=wt)St=$p(Tt/wt|0,Ye[Tt],Ye[Tt+1],St);else for(let Tt=pt-wt;Tt>=ut;Tt-=wt)St=$p(Tt/wt|0,Ye[Tt],Ye[Tt+1],St);return St&&Op(St,St.next)&&(Gp(St),St=St.next),St}function Ap(Ye,ut){if(!Ye)return Ye;ut||(ut=Ye);let pt,wt=Ye;do{if(pt=!1,wt.steiner||!Op(wt,wt.next)&&0!==Lp(wt.prev,wt,wt.next))wt=wt.next;else{if(Gp(wt),wt=ut=wt.prev,wt===wt.next)break;pt=!0}}while(pt||wt!==ut);return ut}function Sp(Ye,ut,pt,wt,Tt,St,It){if(!Ye)return;!It&&St&&function(Ye,ut,pt,wt){let Tt=Ye;do{0===Tt.z&&(Tt.z=Dp(Tt.x,Tt.y,ut,pt,wt)),Tt.prevZ=Tt.prev,Tt.nextZ=Tt.next,Tt=Tt.next}while(Tt!==Ye);Tt.prevZ.nextZ=null,Tt.prevZ=null,function(Ye){let ut,pt=1;do{let wt,Tt=Ye;Ye=null;let St=null;for(ut=0;Tt;){ut++;let It=Tt,Lt=0;for(let Ye=0;Ye<pt&&(Lt++,It=It.nextZ,It);Ye++);let $t=pt;for(;Lt>0||$t>0&&It;)0!==Lt&&(0===$t||!It||Tt.z<=It.z)?(wt=Tt,Tt=Tt.nextZ,Lt--):(wt=It,It=It.nextZ,$t--),St?St.nextZ=wt:Ye=wt,wt.prevZ=St,St=wt;Tt=It}St.nextZ=null,pt*=2}while(ut>1)}(Tt)}(Ye,wt,Tt,St);let Lt=Ye;for(;Ye.prev!==Ye.next;){const $t=Ye.prev,Xt=Ye.next;if(St?Tp(Ye,wt,Tt,St):Ip(Ye))ut.push($t.i,Ye.i,Xt.i),Gp(Ye),Ye=Xt.next,Lt=Xt.next;else if((Ye=Xt)===Lt){It?1===It?Sp(Ye=kp(Ap(Ye),ut),ut,pt,wt,Tt,St,2):2===It&&Pp(Ye,ut,pt,wt,Tt,St):Sp(Ap(Ye),ut,pt,wt,Tt,St,1);break}}}function Ip(Ye){const ut=Ye.prev,pt=Ye,wt=Ye.next;if(Lp(ut,pt,wt)>=0)return!1;const Tt=ut.x,St=pt.x,It=wt.x,Lt=ut.y,$t=pt.y,Xt=wt.y,Sr=Tt<St?Tt<It?Tt:It:St<It?St:It,Lr=Lt<$t?Lt<Xt?Lt:Xt:$t<Xt?$t:Xt,Qr=Tt>St?Tt>It?Tt:It:St>It?St:It,fn=Lt>$t?Lt>Xt?Lt:Xt:$t>Xt?$t:Xt;let xn=wt.next;for(;xn!==ut;){if(xn.x>=Sr&&xn.x<=Qr&&xn.y>=Lr&&xn.y<=fn&&Rp(Tt,Lt,St,$t,It,Xt,xn.x,xn.y)&&Lp(xn.prev,xn,xn.next)>=0)return!1;xn=xn.next}return!0}function Tp(Ye,ut,pt,wt){const Tt=Ye.prev,St=Ye,It=Ye.next;if(Lp(Tt,St,It)>=0)return!1;const Lt=Tt.x,$t=St.x,Xt=It.x,Sr=Tt.y,Lr=St.y,Qr=It.y,fn=Lt<$t?Lt<Xt?Lt:Xt:$t<Xt?$t:Xt,xn=Sr<Lr?Sr<Qr?Sr:Qr:Lr<Qr?Lr:Qr,vn=Lt>$t?Lt>Xt?Lt:Xt:$t>Xt?$t:Xt,kn=Sr>Lr?Sr>Qr?Sr:Qr:Lr>Qr?Lr:Qr,Wn=Dp(fn,xn,ut,pt,wt),Xn=Dp(vn,kn,ut,pt,wt);let Jn=Ye.prevZ,Qn=Ye.nextZ;for(;Jn&&Jn.z>=Wn&&Qn&&Qn.z<=Xn;){if(Jn.x>=fn&&Jn.x<=vn&&Jn.y>=xn&&Jn.y<=kn&&Jn!==Tt&&Jn!==It&&Rp(Lt,Sr,$t,Lr,Xt,Qr,Jn.x,Jn.y)&&Lp(Jn.prev,Jn,Jn.next)>=0)return!1;if(Jn=Jn.prevZ,Qn.x>=fn&&Qn.x<=vn&&Qn.y>=xn&&Qn.y<=kn&&Qn!==Tt&&Qn!==It&&Rp(Lt,Sr,$t,Lr,Xt,Qr,Qn.x,Qn.y)&&Lp(Qn.prev,Qn,Qn.next)>=0)return!1;Qn=Qn.nextZ}for(;Jn&&Jn.z>=Wn;){if(Jn.x>=fn&&Jn.x<=vn&&Jn.y>=xn&&Jn.y<=kn&&Jn!==Tt&&Jn!==It&&Rp(Lt,Sr,$t,Lr,Xt,Qr,Jn.x,Jn.y)&&Lp(Jn.prev,Jn,Jn.next)>=0)return!1;Jn=Jn.prevZ}for(;Qn&&Qn.z<=Xn;){if(Qn.x>=fn&&Qn.x<=vn&&Qn.y>=xn&&Qn.y<=kn&&Qn!==Tt&&Qn!==It&&Rp(Lt,Sr,$t,Lr,Xt,Qr,Qn.x,Qn.y)&&Lp(Qn.prev,Qn,Qn.next)>=0)return!1;Qn=Qn.nextZ}return!0}function kp(Ye,ut){let pt=Ye;do{const wt=pt.prev,Tt=pt.next.next;!Op(wt,Tt)&&Fp(wt,pt,pt.next,Tt)&&jp(wt,Tt)&&jp(Tt,wt)&&(ut.push(wt.i,pt.i,Tt.i),Gp(pt),Gp(pt.next),pt=Ye=Tt),pt=pt.next}while(pt!==Ye);return Ap(pt)}function Pp(Ye,ut,pt,wt,Tt,St){let It=Ye;do{let Ye=It.next.next;for(;Ye!==It.prev;){if(It.i!==Ye.i&&Vp(It,Ye)){let Lt=qp(It,Ye);return It=Ap(It,It.next),Lt=Ap(Lt,Lt.next),Sp(It,ut,pt,wt,Tt,St,0),void Sp(Lt,ut,pt,wt,Tt,St,0)}Ye=Ye.next}It=It.next}while(It!==Ye)}function zp(Ye,ut){return Ye.x-ut.x}function Ep(Ye,ut){const pt=function(Ye,ut){let pt=ut;const wt=Ye.x,Tt=Ye.y;let St,It=-1/0;do{if(Tt<=pt.y&&Tt>=pt.next.y&&pt.next.y!==pt.y){const Ye=pt.x+(Tt-pt.y)*(pt.next.x-pt.x)/(pt.next.y-pt.y);if(Ye<=wt&&Ye>It&&(It=Ye,St=pt.x<pt.next.x?pt:pt.next,Ye===wt))return St}pt=pt.next}while(pt!==ut);if(!St)return null;const Lt=St,$t=St.x,Xt=St.y;let Sr=1/0;pt=St;do{if(wt>=pt.x&&pt.x>=$t&&wt!==pt.x&&Rp(Tt<Xt?wt:It,Tt,$t,Xt,Tt<Xt?It:wt,Tt,pt.x,pt.y)){const ut=Math.abs(Tt-pt.y)/(wt-pt.x);jp(pt,Ye)&&(ut<Sr||ut===Sr&&(pt.x>St.x||pt.x===St.x&&Bp(St,pt)))&&(St=pt,Sr=ut)}pt=pt.next}while(pt!==Lt);return St}(Ye,ut);if(!pt)return ut;const wt=qp(pt,Ye);return Ap(wt,wt.next),Ap(pt,pt.next)}function Bp(Ye,ut){return Lp(Ye.prev,Ye,ut.prev)<0&&Lp(ut.next,Ye,Ye.next)<0}function Dp(Ye,ut,pt,wt,Tt){return(Ye=1431655765&((Ye=858993459&((Ye=252645135&((Ye=16711935&((Ye=(Ye-pt)*Tt|0)|Ye<<8))|Ye<<4))|Ye<<2))|Ye<<1))|(ut=1431655765&((ut=858993459&((ut=252645135&((ut=16711935&((ut=(ut-wt)*Tt|0)|ut<<8))|ut<<4))|ut<<2))|ut<<1))<<1}function Cp(Ye){let ut=Ye,pt=Ye;do{(ut.x<pt.x||ut.x===pt.x&&ut.y<pt.y)&&(pt=ut),ut=ut.next}while(ut!==Ye);return pt}function Rp(Ye,ut,pt,wt,Tt,St,It,Lt){return(Tt-It)*(ut-Lt)>=(Ye-It)*(St-Lt)&&(Ye-It)*(wt-Lt)>=(pt-It)*(ut-Lt)&&(pt-It)*(St-Lt)>=(Tt-It)*(wt-Lt)}function Vp(Ye,ut){return Ye.next.i!==ut.i&&Ye.prev.i!==ut.i&&!function(Ye,ut){let pt=Ye;do{if(pt.i!==Ye.i&&pt.next.i!==Ye.i&&pt.i!==ut.i&&pt.next.i!==ut.i&&Fp(pt,pt.next,Ye,ut))return!0;pt=pt.next}while(pt!==Ye);return!1}(Ye,ut)&&(jp(Ye,ut)&&jp(ut,Ye)&&function(Ye,ut){let pt=Ye,wt=!1;const Tt=(Ye.x+ut.x)/2,St=(Ye.y+ut.y)/2;do{pt.y>St!=pt.next.y>St&&pt.next.y!==pt.y&&Tt<(pt.next.x-pt.x)*(St-pt.y)/(pt.next.y-pt.y)+pt.x&&(wt=!wt),pt=pt.next}while(pt!==Ye);return wt}(Ye,ut)&&(Lp(Ye.prev,Ye,ut.prev)||Lp(Ye,ut.prev,ut))||Op(Ye,ut)&&Lp(Ye.prev,Ye,Ye.next)>0&&Lp(ut.prev,ut,ut.next)>0)}function Lp(Ye,ut,pt){return(ut.y-Ye.y)*(pt.x-ut.x)-(ut.x-Ye.x)*(pt.y-ut.y)}function Op(Ye,ut){return Ye.x===ut.x&&Ye.y===ut.y}function Fp(Ye,ut,pt,wt){const Tt=Np(Lp(Ye,ut,pt)),St=Np(Lp(Ye,ut,wt)),It=Np(Lp(pt,wt,Ye)),Lt=Np(Lp(pt,wt,ut));return Tt!==St&&It!==Lt||!(0!==Tt||!Up(Ye,pt,ut))||!(0!==St||!Up(Ye,wt,ut))||!(0!==It||!Up(pt,Ye,wt))||!(0!==Lt||!Up(pt,ut,wt))}function Up(Ye,ut,pt){return ut.x<=Math.max(Ye.x,pt.x)&&ut.x>=Math.min(Ye.x,pt.x)&&ut.y<=Math.max(Ye.y,pt.y)&&ut.y>=Math.min(Ye.y,pt.y)}function Np(Ye){return Ye>0?1:Ye<0?-1:0}function jp(Ye,ut){return Lp(Ye.prev,Ye,Ye.next)<0?Lp(Ye,ut,Ye.next)>=0&&Lp(Ye,Ye.prev,ut)>=0:Lp(Ye,ut,Ye.prev)<0||Lp(Ye,Ye.next,ut)<0}function qp(Ye,ut){const pt=Yp(Ye.i,Ye.x,Ye.y),wt=Yp(ut.i,ut.x,ut.y),Tt=Ye.next,St=ut.prev;return Ye.next=ut,ut.prev=Ye,pt.next=Tt,Tt.prev=pt,wt.next=pt,pt.prev=wt,St.next=wt,wt.prev=St,wt}function $p(Ye,ut,pt,wt){const Tt=Yp(Ye,ut,pt);return wt?(Tt.next=wt.next,Tt.prev=wt,wt.next.prev=Tt,wt.next=Tt):(Tt.prev=Tt,Tt.next=Tt),Tt}function Gp(Ye){Ye.next.prev=Ye.prev,Ye.prev.next=Ye.next,Ye.prevZ&&(Ye.prevZ.nextZ=Ye.nextZ),Ye.nextZ&&(Ye.nextZ.prevZ=Ye.prevZ)}function Yp(Ye,ut,pt){return{i:Ye,x:ut,y:pt,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Xp(Ye,ut){const pt=Ye.length;if(pt<=1)return[Ye];const wt=[];let Tt,St;for(let ut=0;ut<pt;ut++){const pt=mr(Ye[ut]);0!==pt&&(Ye[ut].area=Math.abs(pt),void 0===St&&(St=pt<0),St===pt<0?(Tt&&wt.push(Tt),Tt=[Ye[ut]]):Tt.push(Ye[ut]))}if(Tt&&wt.push(Tt),ut>1)for(let Ye=0;Ye<wt.length;Ye++)wt[Ye].length<=ut||(Ri(wt[Ye],ut,1,wt[Ye].length-1,Zp),wt[Ye]=wt[Ye].slice(0,ut));return wt}function Zp(Ye,ut){return ut.area-Ye.area}function Hp(Ye,ut,pt){const wt=pt.patternDependencies;let Tt=!1;for(const pt of ut){const ut=pt.paint.get(`${Ye}-pattern`);ut.isConstant()||(Tt=!0);const St=ut.constantOr(null);St&&(Tt=!0,wt[St]=!0)}return Tt}function Kp(Ye,ut,pt,wt,Tt){const St=Tt.patternDependencies;for(const It of ut){const ut=It.paint.get(`${Ye}-pattern`).value;if("constant"!==ut.kind){let Ye=ut.evaluate({zoom:wt},pt,{},Tt.availableImages);Ye=Ye&&Ye.name?Ye.name:Ye,St[Ye]=!0,pt.patterns[It.id]=Ye}}return pt}class Wp{constructor(Ye){this.zoom=Ye.zoom,this.overscaling=Ye.overscaling,this.layers=Ye.layers,this.layerIds=this.layers.map((Ye=>Ye.fqid)),this.index=Ye.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Cl,this.indexArray=new Ql,this.indexArray2=new Zl,this.programConfigurations=new Wu(Ye.layers,{zoom:Ye.zoom,lut:Ye.lut}),this.segments=new Au,this.segments2=new Au,this.stateDependentLayerIds=this.layers.filter((Ye=>Ye.isStateDependent())).map((Ye=>Ye.id)),this.projection=Ye.projection}updateFootprints(Ye,ut){}populate(Ye,ut,pt,wt){this.hasPattern=Hp("fill",this.layers,ut);const Tt=this.layers[0].layout.get("fill-sort-key"),St=[];for(const{feature:It,id:Lt,index:$t,sourceLayerIndex:Xt}of Ye){const Ye=this.layers[0]._featureFilter.needGeometry,Sr=Xc(It,Ye);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Sr,pt))continue;const Lr=Tt?Tt.evaluate(Sr,{},pt,ut.availableImages):void 0,Qr={id:Lt,properties:It.properties,type:It.type,sourceLayerIndex:Xt,index:$t,geometry:Ye?Sr.geometry:Yc(It,pt,wt),patterns:{},sortKey:Lr};St.push(Qr)}Tt&&St.sort(((Ye,ut)=>Ye.sortKey-ut.sortKey));for(const wt of St){const{geometry:Tt,index:St,sourceLayerIndex:It}=wt;if(this.hasPattern){const Ye=Kp("fill",this.layers,wt,this.zoom,ut);this.patternFeatures.push(Ye)}else this.addFeature(wt,Tt,St,pt,{},ut.availableImages,ut.brightness);ut.featureIndex.insert(Ye[St].feature,Tt,St,It,this.index)}}update(Ye,ut,pt,wt,Tt){const St=0!==Object.keys(Ye).length;St&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(Ye,ut,St?this.stateDependentLayers:this.layers,pt,wt,Tt)}addFeatures(Ye,ut,pt,wt,Tt,St){for(const Ye of this.patternFeatures)this.addFeature(Ye,Ye.geometry,Ye.index,ut,pt,wt,St)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(Ye){this.uploaded||(this.layoutVertexBuffer=Ye.createVertexBuffer(this.layoutVertexArray,rx),this.indexBuffer=Ye.createIndexBuffer(this.indexArray),this.indexBuffer2=Ye.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(Ye),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(Ye,ut,pt,wt,Tt,St=[],It){for(const Ye of Xp(ut,500)){let ut=0;for(const pt of Ye)ut+=pt.length;const pt=this.segments.prepareSegment(ut,this.layoutVertexArray,this.indexArray),wt=pt.vertexLength,Tt=[],St=[];for(const ut of Ye){if(0===ut.length)continue;ut!==Ye[0]&&St.push(Tt.length/2);const pt=this.segments2.prepareSegment(ut.length,this.layoutVertexArray,this.indexArray2),wt=pt.vertexLength;this.layoutVertexArray.emplaceBack(ut[0].x,ut[0].y),this.indexArray2.emplaceBack(wt+ut.length-1,wt),Tt.push(ut[0].x),Tt.push(ut[0].y);for(let Ye=1;Ye<ut.length;Ye++)this.layoutVertexArray.emplaceBack(ut[Ye].x,ut[Ye].y),this.indexArray2.emplaceBack(wt+Ye-1,wt+Ye),Tt.push(ut[Ye].x),Tt.push(ut[Ye].y);pt.vertexLength+=ut.length,pt.primitiveLength+=ut.length}const It=wp(Tt,St);for(let Ye=0;Ye<It.length;Ye+=3)this.indexArray.emplaceBack(wt+It[Ye],wt+It[Ye+1],wt+It[Ye+2]);pt.vertexLength+=ut,pt.primitiveLength+=It.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,Ye,pt,Tt,St,wt,It)}}Mo(Wp,"FillBucket",{omit:["layers","patternFeatures"]});const _x=new ol({"fill-sort-key":new sl(O_.layout_fill["fill-sort-key"]),visibility:new il(O_.layout_fill.visibility)});var gx={paint:new ol({"fill-antialias":new il(O_.paint_fill["fill-antialias"]),"fill-opacity":new sl(O_.paint_fill["fill-opacity"]),"fill-color":new sl(O_.paint_fill["fill-color"]),"fill-outline-color":new sl(O_.paint_fill["fill-outline-color"]),"fill-translate":new il(O_.paint_fill["fill-translate"]),"fill-translate-anchor":new il(O_.paint_fill["fill-translate-anchor"]),"fill-pattern":new sl(O_.paint_fill["fill-pattern"]),"fill-emissive-strength":new il(O_.paint_fill["fill-emissive-strength"])}),layout:_x};class tf{constructor(Ye,ut,pt,wt){if(this.triangleCount=ut.length/3,this.min=new wu(0,0),this.max=new wu(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===Ye.length)return;const[Tt,St]=[Ye[0].clone(),Ye[0].clone()];for(let ut=1;ut<Ye.length;++ut){const pt=Ye[ut];Tt.x=Math.min(Tt.x,pt.x),Tt.y=Math.min(Tt.y,pt.y),St.x=Math.max(St.x,pt.x),St.y=Math.max(St.y,pt.y)}if(wt){const Ye=Math.ceil(Math.max(St.x-Tt.x,St.y-Tt.y)/wt);pt=Math.max(pt,Ye)}if(0===pt)return;this.min=Tt,this.max=St;const It=this.max.sub(this.min);It.x=Math.max(It.x,1),It.y=Math.max(It.y,1);const Lt=Math.max(It.x,It.y)/pt;this.cellsX=Math.max(1,Math.ceil(It.x/Lt)),this.cellsY=Math.max(1,Math.ceil(It.y/Lt)),this.xScale=1/Lt,this.yScale=1/Lt;const $t=[];for(let pt=0;pt<this.triangleCount;pt++){const wt=Ye[ut[3*pt+0]].sub(this.min),Tt=Ye[ut[3*pt+1]].sub(this.min),St=Ye[ut[3*pt+2]].sub(this.min),It=ef(Math.floor(Math.min(wt.x,Tt.x,St.x)),this.xScale,this.cellsX),Xt=ef(Math.floor(Math.max(wt.x,Tt.x,St.x)),this.xScale,this.cellsX),Sr=ef(Math.floor(Math.min(wt.y,Tt.y,St.y)),this.yScale,this.cellsY),Lr=ef(Math.floor(Math.max(wt.y,Tt.y,St.y)),this.yScale,this.cellsY),Qr=new wu(0,0),fn=new wu(0,0),xn=new wu(0,0),vn=new wu(0,0);for(let Ye=Sr;Ye<=Lr;++Ye){Qr.y=fn.y=Ye*Lt,xn.y=vn.y=(Ye+1)*Lt;for(let ut=It;ut<=Xt;++ut)Qr.x=xn.x=ut*Lt,fn.x=vn.x=(ut+1)*Lt,(ch(wt,Tt,St,Qr,fn,vn)||ch(wt,Tt,St,Qr,vn,xn))&&$t.push({cellIdx:Ye*this.cellsX+ut,triIdx:pt})}}if(0===$t.length)return;$t.sort(((Ye,ut)=>Ye.cellIdx-ut.cellIdx||Ye.triIdx-ut.triIdx));let Xt=0;for(;Xt<$t.length;){const Ye=$t[Xt].cellIdx,ut={start:this.payload.length,len:0};for(;Xt<$t.length&&$t[Xt].cellIdx===Ye;)++ut.len,this.payload.push($t[Xt++].triIdx);this.cells[Ye]=ut}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(Ye,ut){if(0===this.triangleCount||0===this.cells.length)return;if(Ye.x>this.max.x||this.min.x>Ye.x||Ye.y>this.max.y||this.min.y>Ye.y)return;const pt=ef(Ye.x-this.min.x,this.xScale,this.cellsX),wt=ef(Ye.y-this.min.y,this.yScale,this.cellsY),Tt=this.cells[wt*this.cellsX+pt];if(Tt){this._lazyInitLookup();for(let Ye=0;Ye<Tt.len;Ye++){const pt=this.payload[Tt.start+Ye],wt=Math.floor(pt/8),St=1<<pt%8;if(!(this.lookup[wt]&St)&&(this.lookup[wt]|=St,ut.push(pt),ut.length===this.triangleCount))return}}}query(Ye,ut,pt){if(0===this.triangleCount||0===this.cells.length)return;if(Ye.x>this.max.x||this.min.x>ut.x)return;if(Ye.y>this.max.y||this.min.y>ut.y)return;this._lazyInitLookup();const wt=ef(Ye.x-this.min.x,this.xScale,this.cellsX),Tt=ef(ut.x-this.min.x,this.xScale,this.cellsX),St=ef(Ye.y-this.min.y,this.yScale,this.cellsY),It=ef(ut.y-this.min.y,this.yScale,this.cellsY);for(let Ye=St;Ye<=It;Ye++)for(let ut=wt;ut<=Tt;ut++){const wt=this.cells[Ye*this.cellsX+ut];if(wt)for(let Ye=0;Ye<wt.len;Ye++){const ut=this.payload[wt.start+Ye],Tt=Math.floor(ut/8),St=1<<ut%8;if(!(this.lookup[Tt]&St)&&(this.lookup[Tt]|=St,pt.push(ut),pt.length===this.triangleCount))return}}}}function ef(Ye,ut,pt){return Math.max(0,Math.min(pt-1,Math.floor(Ye*ut)))}Mo(tf,"TriangleGridIndex");class rf{constructor(Ye){this.zoom=Ye.zoom,this.layers=Ye.layers,this.layerIds=this.layers.map((Ye=>Ye.fqid)),this.index=Ye.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((Ye=>Ye.isStateDependent())).map((Ye=>Ye.id)),this.footprints=[]}updateFootprints(Ye,ut){for(const pt of this.footprints)ut.push({footprint:pt,id:Ye})}populate(Ye,ut,pt,wt){const Tt=[];for(const{feature:ut,id:St,index:It,sourceLayerIndex:Lt}of Ye){const Ye=this.layers[0]._featureFilter.needGeometry,$t=Xc(ut,Ye);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),$t,pt))continue;const Xt={id:St,properties:ut.properties,type:ut.type,sourceLayerIndex:Lt,index:It,geometry:Ye?$t.geometry:Yc(ut,pt,wt),patterns:{}};Tt.push(Xt)}for(const wt of Tt){const{geometry:Tt,index:St,sourceLayerIndex:It}=wt;this.addFeature(wt,Tt,St,pt,{},ut.availableImages,ut.brightness),ut.featureIndex.insert(Ye[St].feature,Tt,St,It,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(Ye){}update(Ye,ut,pt,wt,Tt){}destroy(){}addFeature(Ye,ut,pt,wt,Tt,St=[],It){for(const Ye of Xp(ut,2)){const ut=[],pt=[],wt=[],Tt=new wu(1/0,1/0),St=new wu(-1/0,-1/0);for(const It of Ye)if(0!==It.length){It!==Ye[0]&&wt.push(pt.length/2);for(let Ye=0;Ye<It.length;Ye++)pt.push(It[Ye].x),pt.push(It[Ye].y),ut.push(It[Ye]),Tt.x=Math.min(Tt.x,It[Ye].x),Tt.y=Math.min(Tt.y,It[Ye].y),St.x=Math.max(St.x,It[Ye].x),St.y=Math.max(St.y,It[Ye].y)}const It=wp(pt,wt),Lt=new tf(ut,It,8,256);this.footprints.push({vertices:ut,indices:It,grid:Lt,min:Tt,max:St})}}}Mo(rf,"ClipBucket",{omit:["layers"]});const xx=new ol({"clip-layer-types":new il(O_.layout_clip["clip-layer-types"])});var vx={paint:new ol({}),layout:xx};const bx=Bl([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),wx=Bl([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Tx=Bl([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Ax=Bl([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Sx=Bl([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Ix}=bx;var Cx={},Px=Qh,zx=mf;function mf(Ye,pt,wt,Tt,St){(this||ut).properties={},(this||ut).extent=wt,(this||ut).type=0,(this||ut)._pbf=Ye,(this||ut)._geometry=-1,(this||ut)._keys=Tt,(this||ut)._values=St,Ye.readFields(yf,this||ut,pt)}function yf(Ye,ut,pt){1==Ye?ut.id=pt.readVarint():2==Ye?function(Ye,ut){for(var pt=Ye.readVarint()+Ye.pos;Ye.pos<pt;){var wt=ut._keys[Ye.readVarint()],Tt=ut._values[Ye.readVarint()];ut.properties[wt]=Tt}}(pt,ut):3==Ye?ut.type=pt.readVarint():4==Ye&&(ut._geometry=pt.pos)}function gf(Ye){for(var ut,pt,wt=0,Tt=0,St=Ye.length,It=St-1;Tt<St;It=Tt++)wt+=((pt=Ye[It]).x-(ut=Ye[Tt]).x)*(ut.y+pt.y);return wt}mf.types=["Unknown","Point","LineString","Polygon"],mf.prototype.loadGeometry=function(){var Ye=(this||ut)._pbf;Ye.pos=(this||ut)._geometry;for(var pt,wt=Ye.readVarint()+Ye.pos,Tt=1,St=0,It=0,Lt=0,$t=[];Ye.pos<wt;){if(St<=0){var Xt=Ye.readVarint();Tt=7&Xt,St=Xt>>3}if(St--,1===Tt||2===Tt)It+=Ye.readSVarint(),Lt+=Ye.readSVarint(),1===Tt&&(pt&&$t.push(pt),pt=[]),pt.push(new Px(It,Lt));else{if(7!==Tt)throw new Error("unknown command "+Tt);pt&&pt.push(pt[0].clone())}}return pt&&$t.push(pt),$t},mf.prototype.bbox=function(){var Ye=(this||ut)._pbf;Ye.pos=(this||ut)._geometry;for(var pt=Ye.readVarint()+Ye.pos,wt=1,Tt=0,St=0,It=0,Lt=1/0,$t=-1/0,Xt=1/0,Sr=-1/0;Ye.pos<pt;){if(Tt<=0){var Lr=Ye.readVarint();wt=7&Lr,Tt=Lr>>3}if(Tt--,1===wt||2===wt)(St+=Ye.readSVarint())<Lt&&(Lt=St),St>$t&&($t=St),(It+=Ye.readSVarint())<Xt&&(Xt=It),It>Sr&&(Sr=It);else if(7!==wt)throw new Error("unknown command "+wt)}return[Lt,Xt,$t,Sr]},mf.prototype.toGeoJSON=function(Ye,pt,wt){var Tt,St,It=(this||ut).extent*Math.pow(2,wt),Lt=(this||ut).extent*Ye,$t=(this||ut).extent*pt,Xt=this.loadGeometry(),Sr=mf.types[(this||ut).type];function c(Ye){for(var ut=0;ut<Ye.length;ut++){var pt=Ye[ut];Ye[ut]=[360*(pt.x+Lt)/It-180,360/Math.PI*Math.atan(Math.exp((180-360*(pt.y+$t)/It)*Math.PI/180))-90]}}switch((this||ut).type){case 1:var Lr=[];for(Tt=0;Tt<Xt.length;Tt++)Lr[Tt]=Xt[Tt][0];c(Xt=Lr);break;case 2:for(Tt=0;Tt<Xt.length;Tt++)c(Xt[Tt]);break;case 3:for(Xt=function(Ye){var ut=Ye.length;if(ut<=1)return[Ye];for(var pt,wt,Tt=[],St=0;St<ut;St++){var It=gf(Ye[St]);0!==It&&(void 0===wt&&(wt=It<0),wt===It<0?(pt&&Tt.push(pt),pt=[Ye[St]]):pt.push(Ye[St]))}return pt&&Tt.push(pt),Tt}(Xt),Tt=0;Tt<Xt.length;Tt++)for(St=0;St<Xt[Tt].length;St++)c(Xt[Tt][St])}1===Xt.length?Xt=Xt[0]:Sr="Multi"+Sr;var Qr={type:"Feature",geometry:{type:Sr,coordinates:Xt},properties:(this||ut).properties};return"id"in(this||ut)&&(Qr.id=(this||ut).id),Qr};var Dx=zx,Rx=vf;function vf(Ye,pt){(this||ut).version=1,(this||ut).name=null,(this||ut).extent=4096,(this||ut).length=0,(this||ut)._pbf=Ye,(this||ut)._keys=[],(this||ut)._values=[],(this||ut)._features=[],Ye.readFields(_f,this||ut,pt),(this||ut).length=(this||ut)._features.length}function _f(Ye,ut,pt){15===Ye?ut.version=pt.readVarint():1===Ye?ut.name=pt.readString():5===Ye?ut.extent=pt.readVarint():2===Ye?ut._features.push(pt.pos):3===Ye?ut._keys.push(pt.readString()):4===Ye&&ut._values.push(function(Ye){for(var ut=null,pt=Ye.readVarint()+Ye.pos;Ye.pos<pt;){var wt=Ye.readVarint()>>3;ut=1===wt?Ye.readString():2===wt?Ye.readFloat():3===wt?Ye.readDouble():4===wt?Ye.readVarint64():5===wt?Ye.readVarint():6===wt?Ye.readSVarint():7===wt?Ye.readBoolean():null}return ut}(pt))}vf.prototype.feature=function(Ye){if(Ye<0||Ye>=(this||ut)._features.length)throw new Error("feature index out of bounds");(this||ut)._pbf.pos=(this||ut)._features[Ye];var pt=(this||ut)._pbf.readVarint()+(this||ut)._pbf.pos;return new Dx((this||ut)._pbf,pt,(this||ut).extent,(this||ut)._keys,(this||ut)._values)};var kx=Rx;function Mf(Ye,ut,pt){if(3===Ye){var wt=new kx(pt,pt.readVarint()+pt.pos);wt.length&&(ut[wt.name]=wt)}}var Bx=Cx.VectorTile=function(Ye,pt){(this||ut).layers=Ye.readFields(Mf,{},pt)},Fx=Cx.VectorTileFeature=zx;Cx.VectorTileLayer=Rx;class If extends wu{constructor(Ye,ut,pt){super(Ye,ut),this.z=pt}}class Tf extends If{constructor(Ye,ut,pt,wt){super(Ye,ut,pt),this.w=wt}}function kf(Ye,ut,pt,wt){const Tt=[],St=0===wt?(Ye,ut,pt,wt,Tt,St)=>{Ye.push(new wu(St,pt+(St-ut)/(wt-ut)*(Tt-pt)))}:(Ye,ut,pt,wt,Tt,St)=>{Ye.push(new wu(ut+(St-pt)/(Tt-pt)*(wt-ut),St))};for(const It of Ye){const Ye=[];for(const Tt of It){if(Tt.length<=2)continue;const It=[];for(let Ye=0;Ye<Tt.length-1;Ye++){const Lt=Tt[Ye].x,$t=Tt[Ye].y,Xt=Tt[Ye+1].x,Sr=Tt[Ye+1].y,Lr=0===wt?Lt:$t,Qr=0===wt?Xt:Sr;Lr<ut?Qr>ut&&St(It,Lt,$t,Xt,Sr,ut):Lr>pt?Qr<pt&&St(It,Lt,$t,Xt,Sr,pt):It.push(Tt[Ye]),Qr<ut&&Lr>=ut&&St(It,Lt,$t,Xt,Sr,ut),Qr>pt&&Lr<=pt&&St(It,Lt,$t,Xt,Sr,pt)}let Lt=Tt[Tt.length-1];const $t=0===wt?Lt.x:Lt.y;$t>=ut&&$t<=pt&&It.push(Lt),It.length&&(Lt=It[It.length-1],It[0].x===Lt.x&&It[0].y===Lt.y||It.push(It[0]),Ye.push(It))}Ye.length&&Tt.push(Ye)}return Tt}function Pf(Ye,ut,pt,wt){const Tt="x"===pt?"y":"x",St=(wt-Ye[pt])/(ut[pt]-Ye[pt]);Ye[Tt]=Ye[Tt]+(ut[Tt]-Ye[Tt])*St,Ye[pt]=wt,Ye.hasOwnProperty("z")&&(Ye.z=Gn(Ye.z,ut.z,St)),Ye.hasOwnProperty("w")&&(Ye.w=Gn(Ye.w,ut.w,St))}function zf(Ye,ut,pt,wt){const Tt=pt,St=wt;for(const pt of["x","y"]){let wt=Ye,It=ut;wt[pt]>=It[pt]&&(wt=ut,It=Ye),wt[pt]<Tt&&It[pt]>Tt&&Pf(wt,It,pt,Tt),wt[pt]<St&&It[pt]>St&&Pf(It,wt,pt,St)}}function Ef(Ye,ut){return Ye.x-ut.x||Ye.y-ut.y}function Bf(Ye,ut){return 0===Ef(Ye.min,ut.min)&&0===Ef(Ye.max,ut.max)}function Df(Ye,ut){return!(Ye.min.x>ut.max.x||Ye.max.x<ut.min.x||Ye.min.y>ut.max.y||Ye.max.y<ut.min.y)}function Cf(Ye,ut){if(Ye.length!==ut.length)return!1;for(let pt=0;pt<Ye.length;pt++)if(Ye[pt].sourceId!==ut[pt].sourceId||!Bf(Ye[pt],ut[pt])||Ye[pt].order!==ut[pt].order||Ye[pt].clipMask!==ut[pt].clipMask)return!1;return!0}function Rf(Ye,ut,pt){const wt=1/ym,Tt=1/(1<<pt.canonical.z),St=(ut.x*wt+pt.canonical.x)*Tt+pt.wrap,It=(ut.y*wt+pt.canonical.y)*Tt;return{min:new wu((Ye.x*wt+pt.canonical.x)*Tt+pt.wrap,(Ye.y*wt+pt.canonical.y)*Tt),max:new wu(St,It)}}function Vf(Ye,ut,pt){const wt=1<<pt.canonical.z,Tt=((ut.x-pt.wrap)*wt-pt.canonical.x)*ym,St=(ut.y*wt-pt.canonical.y)*ym;return{min:new wu(((Ye.x-pt.wrap)*wt-pt.canonical.x)*ym,(Ye.y*wt-pt.canonical.y)*ym),max:new wu(Tt,St)}}function Lf(Ye,ut,pt,wt,Tt,St,It){const Lt=Ye.indices,$t=Ye.vertices,Xt=[];for(let Sr=wt;Sr<wt+Tt;Sr+=3){const wt=ut[pt[Sr+0]+St],Tt=ut[pt[Sr+1]+St],Lr=ut[pt[Sr+2]+St],Qr=Math.min(wt.x,Tt.x,Lr.x),fn=Math.max(wt.x,Tt.x,Lr.x),xn=Math.min(wt.y,Tt.y,Lr.y),vn=Math.max(wt.y,Tt.y,Lr.y);Xt.length=0,Ye.grid.query(new wu(Qr,xn),new wu(fn,vn),Xt);for(let Ye=0;Ye<Xt.length;Ye++){const ut=Xt[Ye];if(ch($t[Lt[3*ut+0]],$t[Lt[3*ut+1]],$t[Lt[3*ut+2]],wt,Tt,Lr,It))return!0}}return!1}function Of(Ye,ut,pt,wt){if(!Ye||!pt)return!1;let Tt=Ye.vertices;if(!ut.canonical.equals(wt.canonical)||ut.wrap!==wt.wrap){if(pt.vertices.length<Ye.vertices.length)return Of(pt,wt,Ye,ut);const St=ut.canonical,It=wt.canonical,Lt=Math.pow(2,It.z-St.z);Tt=Ye.vertices.map((Ye=>new wu((Ye.x+St.x*ym)*Lt-It.x*ym,(Ye.y+St.y*ym)*Lt-It.y*ym)))}return Lf(pt,Tt,Ye.indices,0,Ye.indices.length,0,0)}function Ff(Ye,ut,pt,wt){const Tt=Math.pow(2,wt.z-pt.z);return new wu((Ye+pt.x*ym)*Tt-wt.x*ym,(ut+pt.y*ym)*Tt-wt.y*ym)}function Uf(Ye,ut){const pt=[];ut.footprint.grid.queryPoint(Ye,pt);const wt=ut.footprint.indices,Tt=ut.footprint.vertices;for(let ut=0;ut<pt.length;ut++){const St=pt[ut];if(ah([Tt[wt[3*St+0]],Tt[wt[3*St+1]],Tt[wt[3*St+2]]],Ye))return!0}return!1}class Nf{constructor(Ye){this.size=Ye,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(Ye,ut){const pt=this.toIdx(Ye,ut);return{min:this.minimums[pt],max:this.maximums[pt]}}isLeaf(Ye,ut){return this.leaves[this.toIdx(Ye,ut)]}toIdx(Ye,ut){return ut*this.size+Ye}}function jf(Ye,ut,pt,wt){let Tt=0,St=Number.MAX_VALUE;for(let It=0;It<3;It++)if(Math.abs(wt[It])<1e-15){if(pt[It]<Ye[It]||pt[It]>ut[It])return null}else{const Lt=1/wt[It];let $t=(Ye[It]-pt[It])*Lt,Xt=(ut[It]-pt[It])*Lt;if($t>Xt){const Ye=$t;$t=Xt,Xt=Ye}if($t>Tt&&(Tt=$t),Xt<St&&(St=Xt),Tt>St)return null}return Tt}function qf(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr){const Lr=wt-Ye,Qr=Tt-ut,fn=St-pt,xn=It-Ye,vn=Lt-ut,kn=$t-pt,Wn=Sr[1]*kn-Sr[2]*vn,Xn=Sr[2]*xn-Sr[0]*kn,Jn=Sr[0]*vn-Sr[1]*xn,Qn=Lr*Wn+Qr*Xn+fn*Jn;if(Math.abs(Qn)<1e-15)return null;const ko=1/Qn,Fo=Xt[0]-Ye,is=Xt[1]-ut,ns=Xt[2]-pt,ss=(Fo*Wn+is*Xn+ns*Jn)*ko;if(ss<0||ss>1)return null;const as=is*fn-ns*Qr,ds=ns*Lr-Fo*fn,ps=Fo*Qr-is*Lr,ms=(Sr[0]*as+Sr[1]*ds+Sr[2]*ps)*ko;return ms<0||ss+ms>1?null:(xn*as+vn*ds+kn*ps)*ko}function $f(Ye,ut,pt){return(Ye-ut)/(pt-ut)}function Gf(Ye,ut,pt,wt,Tt,St,It,Lt,$t){const Xt=1<<pt,Sr=St-wt,Lr=It-Tt,Qr=(Ye+1)/Xt*Sr+wt,fn=(ut+0)/Xt*Lr+Tt,xn=(ut+1)/Xt*Lr+Tt;Lt[0]=(Ye+0)/Xt*Sr+wt,Lt[1]=fn,$t[0]=Qr,$t[1]=xn}class Yf{constructor(Ye){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=Ye,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const ut=function(Ye){const ut=Math.ceil(Math.log2(Ye.dim/8)),pt=[];let wt=Math.ceil(Math.pow(2,ut));const Tt=1/wt,s=(Ye,ut,pt,wt,Tt)=>{const St=wt?1:0,It=(Ye+1)*pt-St,Lt=ut*pt,$t=(ut+1)*pt-St;Tt[0]=Ye*pt,Tt[1]=Lt,Tt[2]=It,Tt[3]=$t};let St=new Nf(wt);const It=[];for(let ut=0;ut<wt*wt;ut++){s(ut%wt,Math.floor(ut/wt),Tt,!1,It);const pt=Zf(It[0],It[1],Ye),Lt=Zf(It[2],It[1],Ye),$t=Zf(It[2],It[3],Ye),Xt=Zf(It[0],It[3],Ye);St.minimums.push(Math.min(pt,Lt,$t,Xt)),St.maximums.push(Math.max(pt,Lt,$t,Xt)),St.leaves.push(1)}for(pt.push(St),wt/=2;wt>=1;wt/=2){const Ye=pt[pt.length-1];St=new Nf(wt);for(let ut=0;ut<wt*wt;ut++){s(ut%wt,Math.floor(ut/wt),2,!0,It);const pt=Ye.getElevation(It[0],It[1]),Tt=Ye.getElevation(It[2],It[1]),Lt=Ye.getElevation(It[2],It[3]),$t=Ye.getElevation(It[0],It[3]),Xt=Ye.isLeaf(It[0],It[1]),Sr=Ye.isLeaf(It[2],It[1]),Lr=Ye.isLeaf(It[2],It[3]),Qr=Ye.isLeaf(It[0],It[3]),fn=Math.min(pt.min,Tt.min,Lt.min,$t.min),xn=Math.max(pt.max,Tt.max,Lt.max,$t.max),vn=Xt&&Sr&&Lr&&Qr;St.maximums.push(xn),St.minimums.push(fn),St.leaves.push(xn-fn<=5&&vn?1:0)}pt.push(St)}return pt}(this.dem),pt=ut.length-1,wt=ut[pt];this._addNode(wt.minimums[0],wt.maximums[0],wt.leaves[0]),this._construct(ut,0,0,pt,0)}raycastRoot(Ye,ut,pt,wt,Tt,St,It=1){return jf([Ye,ut,-100],[pt,wt,this.maximums[0]*It],Tt,St)}raycast(ut,pt,wt,Tt,St,It,Lt=1){if(!this.nodeCount)return null;const $t=this.raycastRoot(ut,pt,wt,Tt,St,It,Lt);if(null==$t)return null;const Xt=[],Sr=[],Lr=[],Qr=[],fn=[{idx:0,t:$t,nodex:0,nodey:0,depth:0}];for(;fn.length>0;){const{idx:$t,t:xn,nodex:vn,nodey:kn,depth:Wn}=fn.pop();if(this.leaves[$t]){Gf(vn,kn,Wn,ut,pt,wt,Tt,Lr,Qr);const $t=1<<Wn,Xt=(vn+0)/$t,Sr=(vn+1)/$t,fn=(kn+0)/$t,Xn=(kn+1)/$t,Jn=Zf(Xt,fn,this.dem)*Lt,Qn=Zf(Sr,fn,this.dem)*Lt,ko=Zf(Sr,Xn,this.dem)*Lt,Fo=Zf(Xt,Xn,this.dem)*Lt,is=qf(Lr[0],Lr[1],Jn,Qr[0],Lr[1],Qn,Qr[0],Qr[1],ko,St,It),ns=qf(Qr[0],Qr[1],ko,Lr[0],Qr[1],Fo,Lr[0],Lr[1],Jn,St,It),ss=Math.min(null!==is?is:Number.MAX_VALUE,null!==ns?ns:Number.MAX_VALUE);if(ss!==Number.MAX_VALUE)return ss;{const ut=Ye._.scaleAndAdd([],St,It,xn);if(Xf(Jn,Qn,Fo,ko,$f(ut[0],Lr[0],Qr[0]),$f(ut[1],Lr[1],Qr[1]))>=ut[2])return xn}continue}let Xn=0;for(let Ye=0;Ye<this._siblingOffset.length;Ye++){Gf((vn<<1)+this._siblingOffset[Ye][0],(kn<<1)+this._siblingOffset[Ye][1],Wn+1,ut,pt,wt,Tt,Lr,Qr),Lr[2]=-100,Qr[2]=this.maximums[this.childOffsets[$t]+Ye]*Lt;const fn=jf(Lr,Qr,St,It);if(null!=fn){const ut=fn;Xt[Ye]=ut;let pt=!1;for(let wt=0;wt<Xn&&!pt;wt++)ut>=Xt[Sr[wt]]&&(Sr.splice(wt,0,Ye),pt=!0);pt||(Sr[Xn]=Ye),Xn++}}for(let Ye=0;Ye<Xn;Ye++){const ut=Sr[Ye];fn.push({idx:this.childOffsets[$t]+ut,t:Xt[ut],nodex:(vn<<1)+this._siblingOffset[ut][0],nodey:(kn<<1)+this._siblingOffset[ut][1],depth:Wn+1})}}return null}_addNode(Ye,ut,pt){return this.minimums.push(Ye),this.maximums.push(ut),this.leaves.push(pt),this.childOffsets.push(0),this.nodeCount++}_construct(Ye,ut,pt,wt,Tt){if(1===Ye[wt].isLeaf(ut,pt))return;this.childOffsets[Tt]||(this.childOffsets[Tt]=this.nodeCount);const St=wt-1,It=Ye[St];let Lt=0,$t=0;for(let Ye=0;Ye<this._siblingOffset.length;Ye++){const wt=2*ut+this._siblingOffset[Ye][0],Tt=2*pt+this._siblingOffset[Ye][1],St=It.getElevation(wt,Tt),Xt=It.isLeaf(wt,Tt),Sr=this._addNode(St.min,St.max,Xt);Xt&&(Lt|=1<<Ye),$t||($t=Sr)}for(let wt=0;wt<this._siblingOffset.length;wt++)Lt&1<<wt||this._construct(Ye,2*ut+this._siblingOffset[wt][0],2*pt+this._siblingOffset[wt][1],St,$t+wt)}}function Xf(Ye,ut,pt,wt,Tt,St){return Gn(Gn(Ye,pt,St),Gn(ut,wt,St),Tt)}function Zf(Ye,ut,pt){const wt=pt.dim,Tt=Ke(Ye*wt-.5,0,wt-1),St=Ke(ut*wt-.5,0,wt-1),It=Math.floor(Tt),Lt=Math.floor(St),$t=Math.min(It+1,wt-1),Xt=Math.min(Lt+1,wt-1);return Xf(pt.get(It,Lt),pt.get($t,Lt),pt.get(It,Xt),pt.get($t,Xt),Tt-It,St-Lt)}const Nx={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Kf(Ye,ut,pt){return(256*Ye*256+256*ut+pt)/10-1e4}function Wf(Ye,ut,pt){return 256*Ye+ut+pt/256-32768}class Jf{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(Ye,ut,pt,wt=!1){if(this.uid=Ye,ut.height!==ut.width)throw new RangeError("DEM tiles must be square");if(pt&&"mapbox"!==pt&&"terrarium"!==pt)return fr(`"${pt}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=ut.height;const Tt=this.dim=ut.height-2,St=new Uint32Array(ut.data.buffer);if(this.pixels=new Uint8Array(ut.data.buffer),this.floatView=new Float32Array(ut.data.buffer),this.borderReady=wt,this._modifiedForSources={},!wt){for(let Ye=0;Ye<Tt;Ye++)St[this._idx(-1,Ye)]=St[this._idx(0,Ye)],St[this._idx(Tt,Ye)]=St[this._idx(Tt-1,Ye)],St[this._idx(Ye,-1)]=St[this._idx(Ye,0)],St[this._idx(Ye,Tt)]=St[this._idx(Ye,Tt-1)];St[this._idx(-1,-1)]=St[this._idx(0,0)],St[this._idx(Tt,-1)]=St[this._idx(Tt-1,0)],St[this._idx(-1,Tt)]=St[this._idx(0,Tt-1)],St[this._idx(Tt,Tt)]=St[this._idx(Tt-1,Tt-1)]}const It="terrarium"===pt?Wf:Kf;for(let Ye=0;Ye<St.length;++Ye){const ut=4*Ye;this.floatView[Ye]=It(this.pixels[ut],this.pixels[ut+1],this.pixels[ut+2])}this._timestamp=sd.now()}_buildQuadTree(){this._tree=new Yf(this)}get(Ye,ut,pt=!1){pt&&(Ye=Ke(Ye,-1,this.dim),ut=Ke(ut,-1,this.dim));const wt=this._idx(Ye,ut);return this.floatView[wt]}set(Ye,ut,pt){const wt=this._idx(Ye,ut),Tt=this.floatView[wt];return this.floatView[wt]=pt,pt-Tt}static getUnpackVector(Ye){return Nx[Ye]}_idx(Ye,ut){if(Ye<-1||Ye>=this.dim+1||ut<-1||ut>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(ut+1)*this.stride+(Ye+1)}static pack(Ye,ut){const pt=[0,0,0,0],wt=Jf.getUnpackVector(ut);let Tt=Math.floor((Ye+wt[3])/wt[2]);return pt[2]=Tt%256,Tt=Math.floor(Tt/256),pt[1]=Tt%256,Tt=Math.floor(Tt/256),pt[0]=Tt,pt}getPixels(){return new dp({width:this.stride,height:this.stride},this.pixels)}backfillBorder(Ye,ut,pt){if(this.dim!==Ye.dim)throw new Error("dem dimension mismatch");let wt=ut*this.dim,Tt=ut*this.dim+this.dim,St=pt*this.dim,It=pt*this.dim+this.dim;switch(ut){case-1:wt=Tt-1;break;case 1:Tt=wt+1}switch(pt){case-1:St=It-1;break;case 1:It=St+1}const Lt=-ut*this.dim,$t=-pt*this.dim;for(let ut=St;ut<It;ut++)for(let pt=wt;pt<Tt;pt++){const wt=4*this._idx(pt,ut),Tt=4*this._idx(pt+Lt,ut+$t);this.pixels[wt+0]=Ye.pixels[Tt+0],this.pixels[wt+1]=Ye.pixels[Tt+1],this.pixels[wt+2]=Ye.pixels[Tt+2],this.pixels[wt+3]=Ye.pixels[Tt+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Mo(Jf,"DEMData"),Mo(Yf,"DemMinMaxQuadTree",{omit:["dem"]});class Qf{constructor(Ye,ut,pt){this._demTile=Ye,this._dem=this._demTile.dem,this._scale=ut,this._offset=pt}static create(Ye,ut,pt){const wt=pt||Ye.findDEMTileFor(ut);if(!wt||!wt.dem)return;const Tt=wt.dem,St=wt.tileID,It=1<<ut.canonical.z-St.canonical.z;return new Qf(wt,Tt.dim/ym/It,[(ut.canonical.x/It-St.canonical.x)*Tt.dim,(ut.canonical.y/It-St.canonical.y)*Tt.dim])}tileCoordToPixel(Ye,ut){const pt=ut*this._scale+this._offset[1],wt=Math.floor(Ye*this._scale+this._offset[0]),Tt=Math.floor(pt);return new wu(wt,Tt)}getElevationAt(Ye,ut,pt,wt){const Tt=Ye*this._scale+this._offset[0],St=ut*this._scale+this._offset[1],It=Math.floor(Tt),Lt=Math.floor(St),$t=this._dem;return wt=!!wt,pt?Gn(Gn($t.get(It,Lt,wt),$t.get(It,Lt+1,wt),St-Lt),Gn($t.get(It+1,Lt,wt),$t.get(It+1,Lt+1,wt),St-Lt),Tt-It):$t.get(It,Lt,wt)}getElevationAtPixel(Ye,ut,pt){return this._dem.get(Ye,ut,!!pt)}getMeterToDEM(Ye){return(1<<this._demTile.tileID.canonical.z)*Pc(1,Ye)*this._dem.stride}}const jx={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7},Gx=Fx.types,qx=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],$x=["fill-extrusion-flood-light-ground-radius"],Yx=Math.pow(2,13),lv=Math.pow(2,15)-1,cv=new wu(0,1),dv=2147483648;function ld(Ye,ut,pt,wt,Tt,St,It,Lt){Ye.emplaceBack((ut<<1)+It,(pt<<1)+St,(Math.floor(wt*Yx)<<1)+Tt,Math.round(Lt))}function ud(Ye,ut,pt,wt,Tt,St){Ye.emplaceBack(ut.x,ut.y,(pt.x<<1)+wt,(pt.y<<1)+Tt,St)}function cd(Ye,ut,pt){const wt=16384;Ye.emplaceBack(ut.x,ut.y,ut.z,pt[0]*wt,pt[1]*wt,pt[2]*wt)}class hd{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class pd{constructor(){this.centroidXY=new wu(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new wu(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new wu(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new wu(this.max.x-this.min.x,this.max.y-this.min.y)}}class fd{constructor(){this.acc=new wu(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(Ye,ut){Ye.min.x===Number.MAX_VALUE&&(Ye.min.x=Ye.max.x=ut.x,Ye.min.y=Ye.max.y=ut.y)}appendEdge(Ye,ut,pt){this.accCount++,this.acc._add(ut);let wt=!!this.borders;ut.x<Ye.min.x?(Ye.min.x=ut.x,wt=!0):ut.x>Ye.max.x&&(Ye.max.x=ut.x,wt=!0),ut.y<Ye.min.y?(Ye.min.y=ut.y,wt=!0):ut.y>Ye.max.y&&(Ye.max.y=ut.y,wt=!0),((0===ut.x||ut.x===ym)&&ut.x===pt.x)!=((0===ut.y||ut.y===ym)&&ut.y===pt.y)&&this.processBorderOverlap(ut,pt),wt&&this.checkBorderIntersection(ut,pt)}checkBorderIntersection(Ye,ut){ut.x<0!=Ye.x<0&&this.addBorderIntersection(0,Gn(ut.y,Ye.y,(0-ut.x)/(Ye.x-ut.x))),ut.x>ym!=Ye.x>ym&&this.addBorderIntersection(1,Gn(ut.y,Ye.y,(ym-ut.x)/(Ye.x-ut.x))),ut.y<0!=Ye.y<0&&this.addBorderIntersection(2,Gn(ut.x,Ye.x,(0-ut.y)/(Ye.y-ut.y))),ut.y>ym!=Ye.y>ym&&this.addBorderIntersection(3,Gn(ut.x,Ye.x,(ym-ut.y)/(Ye.y-ut.y)))}addBorderIntersection(Ye,ut){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const pt=this.borders[Ye];ut<pt[0]&&(pt[0]=ut),ut>pt[1]&&(pt[1]=ut)}processBorderOverlap(Ye,ut){if(Ye.x===ut.x){if(Ye.y===ut.y)return;const pt=0===Ye.x?0:1;this.addBorderIntersection(pt,ut.y),this.addBorderIntersection(pt,Ye.y)}else{const pt=0===Ye.y?2:3;this.addBorderIntersection(pt,ut.x),this.addBorderIntersection(pt,Ye.x)}}centroid(){return 0===this.accCount?new wu(0,0):new wu(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((Ye,ut)=>Ye+ +(ut[0]!==Number.MAX_VALUE)),0):0}}function dd(Ye,ut){const pt=Ye.add(ut)._unit(),wt=Ke(Ye.x*pt.x+Ye.y*pt.y,-1,1);var Tt,St,It;return Tt=Math.acos(wt),Math.min(4,Math.max(-4,Math.tan(Tt)))/4*lv*((St=Ye).x*(It=ut).y-St.y*It.x<0?-1:1)}const pv=[Ye=>Ye.x<0,Ye=>Ye.x>ym,Ye=>Ye.y<0,Ye=>Ye.y>ym];function yd(Ye,ut,pt,wt){const Tt=[4];if(0===wt)return Tt;pt._mult(wt);const St=Ye.sub(pt),It=ut.sub(pt),Lt=[Ye,ut,St,It];for(let Ye=0;Ye<4;Ye++)for(const ut of Lt)if(pv[Ye](ut)){Tt.push(Ye);break}return Tt}class gd{constructor(Ye){this.vertexArray=new Ll,this.indexArray=new Ql,this.programConfigurations=new Wu(Ye.layers,{zoom:Ye.zoom,lut:Ye.lut},(Ye=>$x.includes(Ye))),this._segments=new Au,this.hiddenByLandmarkVertexArray=new cu,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Au}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(Ye,ut,pt,wt=!1){const Tt=Ye.length;if(Tt>2){let St=Math.max(0,this._segments.get().length-1);const It=this._segments._prepareSegment(4*Tt,this.vertexArray.length,2*this._segmentToGroundQuads[St].length);let Lt;St!==this._segments.get().length-1&&(St++,this._segmentToGroundQuads[St]=[],this._segmentToRegionTriCounts[St]=[0,0,0,0,0]);{const ut=Ye[0],pt=Ye[1];Lt=dd(ut.sub(Ye[Tt-1])._perp()._unit(),pt.sub(ut)._perp()._unit())}for(let $t=0;$t<Tt;$t++){const Xt=$t===Tt-1?0:$t+1,Sr=Ye[$t],Lr=Ye[Xt],Qr=Ye[Xt===Tt-1?0:Xt+1],fn=Lr.sub(Sr)._perp()._unit(),xn=dd(fn,Qr.sub(Lr)._perp()._unit()),vn=Lt,kn=xn;if(wd(Sr,Lr,ut)||wt&&Md(Sr,ut)&&Md(Lr,ut)){Lt=xn;continue}const Wn=It.vertexLength;ud(this.vertexArray,Sr,Lr,1,1,vn),ud(this.vertexArray,Sr,Lr,1,0,vn),ud(this.vertexArray,Sr,Lr,0,1,kn),ud(this.vertexArray,Sr,Lr,0,0,kn),It.vertexLength+=4;const Xn=yd(Sr,Lr,fn,pt);for(const Ye of Xn)this._segmentToGroundQuads[St].push({id:Wn,region:Ye}),this._segmentToRegionTriCounts[St][Ye]+=2,It.primitiveLength+=2;Lt=xn}}}prepareBorderSegments(){if(!this.hasData())return;const Ye=this._segments.get(),ut=Ye.length;for(let Ye=0;Ye<ut;Ye++)this._segmentToGroundQuads[Ye].sort(((Ye,ut)=>Ye.region-ut.region));for(let pt=0;pt<ut;pt++){const ut=this._segmentToGroundQuads[pt],wt=Ye[pt],Tt=this._segmentToRegionTriCounts[pt];Tt.reduce(((Ye,ut)=>Ye+ut),0);let St=0;for(let Ye=0;Ye<=4;Ye++){const ut=Tt[Ye];if(0!==ut){let pt=this.regionSegments[Ye];pt||(pt=this.regionSegments[Ye]=new Au);const Tt={vertexOffset:wt.vertexOffset,primitiveOffset:wt.primitiveOffset+St,vertexLength:wt.vertexLength,primitiveLength:ut};pt.get().push(Tt)}St+=ut}for(let Ye=0;Ye<ut.length;Ye++){const pt=ut[Ye].id;this.indexArray.emplaceBack(pt,pt+1,pt+3),this.indexArray.emplaceBack(pt,pt+3,pt+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(Ye,ut,pt,wt,Tt,St){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,Ye,ut,pt,wt,Tt,St)}upload(Ye){this.hasData()&&(this.vertexBuffer=Ye.createVertexBuffer(this.vertexArray,wx.members),this.indexBuffer=Ye.createIndexBuffer(this.indexArray))}uploadPaintProperties(Ye){this.hasData()&&this.programConfigurations.upload(Ye)}update(Ye,ut,pt,wt,Tt,St){this.hasData()&&this.programConfigurations.updatePaintArrays(Ye,ut,pt,wt,Tt,St)}updateHiddenByLandmark(Ye){if(!this.hasData())return;const ut=Ye.groundVertexCount+Ye.groundVertexArrayOffset;if(0===Ye.groundVertexCount)return;const pt=Ye.flags&dv?1:0;for(let wt=Ye.groundVertexArrayOffset;wt<ut;++wt)this.hiddenByLandmarkVertexArray.emplace(wt,pt);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(Ye){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=Ye.createVertexBuffer(this.hiddenByLandmarkVertexArray,Ax.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let Ye=0;Ye<=4;Ye++){const ut=this.regionSegments[Ye];ut&&ut.destroy()}}}}class xd{constructor(Ye){this.zoom=Ye.zoom,this.canonical=Ye.canonical,this.overscaling=Ye.overscaling,this.layers=Ye.layers,this.layerIds=this.layers.map((Ye=>Ye.fqid)),this.index=Ye.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=Ye.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Ql,this.footprintVertices=new Cl,this.footprintSegments=[],this.layoutVertexArray=new Vl,this.centroidVertexArray=new _u,this.indexArray=new Ql,this.programConfigurations=new Wu(Ye.layers,{zoom:Ye.zoom,lut:Ye.lut},(Ye=>qx.includes(Ye))),this.segments=new Au,this.stateDependentLayerIds=this.layers.filter((Ye=>Ye.isStateDependent())).map((Ye=>Ye.id)),this.groundEffect=new gd(Ye),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(Ye,ut){}populate(Ye,ut,pt,wt){this.features=[],this.hasPattern=Hp("fill-extrusion",this.layers,ut),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=Lc(pt),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:Tt,id:St,index:It,sourceLayerIndex:Lt}of Ye){const Ye=this.layers[0]._featureFilter.needGeometry,$t=Xc(Tt,Ye);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),$t,pt))continue;const Xt={id:St,sourceLayerIndex:Lt,index:It,geometry:Ye?$t.geometry:Yc(Tt,pt,wt),properties:Tt.properties,type:Tt.type,patterns:{}},Sr=this.layoutVertexArray.length;this.hasPattern?this.features.push(Kp("fill-extrusion",this.layers,Xt,this.zoom,ut)):this.addFeature(Xt,Xt.geometry,It,pt,{},ut.availableImages,wt,ut.brightness),ut.featureIndex.insert(Tt,Xt.geometry,It,Lt,this.index,Sr)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(Ye,ut,pt,wt,Tt,St){for(const Ye of this.features){const{geometry:It}=Ye;this.addFeature(Ye,It,Ye.index,ut,pt,wt,Tt,St)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(Ye,ut,pt,wt,Tt){const St=0!==Object.keys(Ye).length;if(St&&!this.stateDependentLayers.length)return;const It=St?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(Ye,ut,It,pt,wt,Tt),this.groundEffect.update(Ye,ut,It,pt,wt,Tt)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(Ye){this.uploaded||(this.layoutVertexBuffer=Ye.createVertexBuffer(this.layoutVertexArray,Ix),this.indexBuffer=Ye.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=Ye.createVertexBuffer(this.layoutVertexExtArray,Sx.members,!0)),this.groundEffect.upload(Ye)),this.groundEffect.uploadPaintProperties(Ye),this.programConfigurations.upload(Ye),this.uploaded=!0}uploadCentroid(Ye){this.groundEffect.uploadHiddenByLandmark(Ye),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=Ye.createVertexBuffer(this.centroidVertexArray,Tx.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(Ye,{})/this.tileToMeter,Xt=[new wu(0,0),new wu(ym,ym)],Sr=It.projection,Lr="globe"===Sr.name,Qr="Polygon"===Gx[Ye.type],fn=new fd;fn.centroidDataIndex=this.centroidData.length;const xn=new pd,vn=this.layers[0].paint.get("fill-extrusion-base").evaluate(Ye,{},wt)<=0,kn=this.layers[0].paint.get("fill-extrusion-height").evaluate(Ye,{},wt);xn.height=kn,xn.vertexArrayOffset=this.layoutVertexArray.length,xn.groundVertexArrayOffset=this.groundEffect.vertexArray.length,Lr&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new ql);const Wn=Xp(ut,500);for(let Ye=Wn.length-1;Ye>=0;Ye--){const ut=Wn[Ye];(0===ut.length||(Xn=ut[0]).every((Ye=>Ye.x<=0))||Xn.every((Ye=>Ye.x>=ym))||Xn.every((Ye=>Ye.y<=0))||Xn.every((Ye=>Ye.y>=ym)))&&Wn.splice(Ye,1)}var Xn;let Jn;if(Lr)Jn=Td(Wn,Xt,wt);else{Jn=[];for(const Ye of Wn)Jn.push({polygon:Ye,bounds:Xt})}const Qn=Qr?this.edgeRadius:0,ko=Qn>0&&this.zoom<17,w=(Ye,ut)=>{if(0===Ye.length)return!1;const pt=Ye[Ye.length-1];return ut.x===pt.x&&ut.y===pt.y};for(const{polygon:Ye,bounds:ut}of Jn){let pt=0,Tt=0;for(const ut of Ye)Qr&&!ut[0].equals(ut[ut.length-1])&&ut.push(ut[0]),Tt+=Qr?ut.length-1:ut.length;const St=this.segments.prepareSegment((Qr?5:4)*Tt,this.layoutVertexArray,this.indexArray);xn.footprintSegIdx<0&&(xn.footprintSegIdx=this.footprintSegments.length),xn.polygonSegIdx<0&&(xn.polygonSegIdx=this.polygonSegments.length);const It={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Lt=new hd;if(Lt.vertexOffset=this.footprintVertices.length,Lt.indexOffset=3*this.footprintIndices.length,Lt.ringIndices=[],Qr){const Tt=[],It=[];pt=St.vertexLength;for(let pt=0;pt<Ye.length;pt++){const Xt=Ye[pt];Xt.length&&0!==pt&&It.push(Tt.length/2);const Qr=[];let fn,xn;fn=Xt[1].sub(Xt[0])._perp()._unit(),Lt.ringIndices.push(Xt.length-1);for(let Ye=1;Ye<Xt.length;Ye++){const ut=Xt[Ye],pt=Xt[Ye===Xt.length-1?1:Ye+1],It=ut.clone();if(Qn){xn=pt.sub(ut)._perp()._unit();const Ye=fn.add(xn)._unit(),wt=Qn*Math.min(4,1/(fn.x*Ye.x+fn.y*Ye.y));It.x+=wt*Ye.x,It.y+=wt*Ye.y,It.x=Math.round(It.x),It.y=Math.round(It.y),fn=xn}!vn||0!==Qn&&!ko||w(Qr,It)||Qr.push(It),ld(this.layoutVertexArray,It.x,It.y,0,0,1,1,0),St.vertexLength++,this.footprintVertices.emplaceBack(ut.x,ut.y),Tt.push(ut.x,ut.y),Lr&&cd(this.layoutVertexExtArray,Sr.projectTilePoint(It.x,It.y,wt),Sr.upVector(wt,It.x,It.y))}vn&&(0===Qn||ko)&&(0!==Qr.length&&w(Qr,Qr[0])&&Qr.pop(),this.groundEffect.addData(Qr,ut,$t))}const Xt=wp(Tt,It);for(let Ye=0;Ye<Xt.length;Ye+=3)this.footprintIndices.emplaceBack(Lt.vertexOffset+Xt[Ye+0],Lt.vertexOffset+Xt[Ye+1],Lt.vertexOffset+Xt[Ye+2]),this.indexArray.emplaceBack(pt+Xt[Ye],pt+Xt[Ye+2],pt+Xt[Ye+1]),St.primitiveLength++;Lt.indexCount+=Xt.length,Lt.vertexCount+=this.footprintVertices.length-Lt.vertexOffset}for(let Tt=0;Tt<Ye.length;Tt++){const It=Ye[Tt];fn.startRing(xn,It[0]);let Lt=It.length>4&&Ad(It[It.length-2],It[0],It[1]),Xt=Qn?vd(It[It.length-2],It[0],It[1],Qn):0;const kn=[];let Wn,Xn,Jn;Xn=It[1].sub(It[0])._perp()._unit();let ko=!0;for(let Ye=1,Tt=0;Ye<It.length;Ye++){let $t=It[Ye-1],Qr=It[Ye];const Fo=It[Ye===It.length-1?1:Ye+1];if(fn.appendEdge(xn,Qr,$t),wd(Qr,$t,ut)){Qn&&(Xn=Fo.sub(Qr)._perp()._unit(),ko=!ko);continue}const is=Qr.sub($t)._perp(),ns=is.x/(Math.abs(is.x)+Math.abs(is.y)),ss=is.y>0?1:0,as=$t.dist(Qr);if(Tt+as>32768&&(Tt=0),Qn){Jn=Fo.sub(Qr)._perp()._unit();let Ye=_d($t,Qr,Fo,bd(Xn,Jn),Qn);isNaN(Ye)&&(Ye=0);const ut=Qr.sub($t)._unit();$t=$t.add(ut.mult(Xt))._round(),Qr=Qr.add(ut.mult(-Ye))._round(),Xt=Ye,Xn=Jn,vn&&this.zoom>=17&&(w(kn,$t)||kn.push($t),w(kn,Qr)||kn.push(Qr))}const ds=St.vertexLength,ps=It.length>4&&Ad($t,Qr,Fo);let ms=Sd(Tt,Lt,ko);if(ld(this.layoutVertexArray,$t.x,$t.y,ns,ss,0,0,ms),ld(this.layoutVertexArray,$t.x,$t.y,ns,ss,0,1,ms),Tt+=as,ms=Sd(Tt,ps,!ko),Lt=ps,ld(this.layoutVertexArray,Qr.x,Qr.y,ns,ss,0,0,ms),ld(this.layoutVertexArray,Qr.x,Qr.y,ns,ss,0,1,ms),St.vertexLength+=4,this.indexArray.emplaceBack(ds+0,ds+1,ds+2),this.indexArray.emplaceBack(ds+1,ds+3,ds+2),St.primitiveLength+=2,Qn){const wt=pt+(1===Ye?It.length-2:Ye-2),Tt=1===Ye?pt:wt+1;if(this.indexArray.emplaceBack(ds+1,wt,ds+3),this.indexArray.emplaceBack(wt,Tt,ds+3),St.primitiveLength+=2,void 0===Wn&&(Wn=ds),!wd(Fo,It[Ye],ut)){const ut=Ye===It.length-1?Wn:St.vertexLength;this.indexArray.emplaceBack(ds+2,ds+3,ut),this.indexArray.emplaceBack(ds+3,ut+1,ut),this.indexArray.emplaceBack(ds+3,Tt,ut+1),St.primitiveLength+=3}ko=!ko}if(Lr){const Ye=this.layoutVertexExtArray,ut=Sr.projectTilePoint($t.x,$t.y,wt),pt=Sr.projectTilePoint(Qr.x,Qr.y,wt),Tt=Sr.upVector(wt,$t.x,$t.y),St=Sr.upVector(wt,Qr.x,Qr.y);cd(Ye,ut,Tt),cd(Ye,ut,Tt),cd(Ye,pt,St),cd(Ye,pt,St)}}Qr&&(pt+=It.length-1),vn&&Qn&&this.zoom>=17&&(0!==kn.length&&w(kn,kn[0])&&kn.pop(),this.groundEffect.addData(kn,ut,$t,Qn>0))}this.footprintSegments.push(Lt),It.triangleCount=this.indexArray.length-It.triangleArrayOffset,this.polygonSegments.push(It),++xn.footprintSegLen,++xn.polygonSegLen}if(xn.vertexCount=this.layoutVertexArray.length-xn.vertexArrayOffset,xn.groundVertexCount=this.groundEffect.vertexArray.length-xn.groundVertexArrayOffset,0!==xn.vertexCount){if(xn.centroidXY=fn.borders?cv:this.encodeCentroid(fn,xn),this.centroidData.push(xn),fn.borders){this.featuresOnBorder.push(fn);const Ye=this.featuresOnBorder.length-1;for(let ut=0;ut<fn.borders.length;ut++)fn.borders[ut][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ut].push(Ye)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,Ye,pt,Tt,St,wt,Lt),this.groundEffect.addPaintPropertiesData(Ye,pt,Tt,St,wt,Lt),this.maxHeight=Math.max(this.maxHeight,kn)}}sortBorders(){for(let Ye=0;Ye<this.borderFeatureIndices.length;Ye++)this.borderFeatureIndices[Ye].sort(((ut,pt)=>this.featuresOnBorder[ut].borders[Ye][0]-this.featuresOnBorder[pt].borders[Ye][0]))}splitToSubtiles(){const Ye=[];for(let ut=0;ut<this.centroidData.length;ut++){const pt=this.centroidData[ut],wt=+(pt.min.y+pt.max.y>ym),Tt=2*wt+(+(pt.min.x+pt.max.x>ym)^wt);for(let wt=0;wt<pt.polygonSegLen;wt++){const St=pt.polygonSegIdx+wt;Ye.push({centroidIdx:ut,subtile:Tt,polygonSegmentIdx:St,triangleSegmentIdx:this.polygonSegments[St].triangleSegIdx})}}const ut=new Ql;Ye.sort(((Ye,ut)=>Ye.triangleSegmentIdx===ut.triangleSegmentIdx?Ye.subtile-ut.subtile:Ye.triangleSegmentIdx-ut.triangleSegmentIdx));let pt=0,wt=0,Tt=0;for(const ut of Ye){if(ut.triangleSegmentIdx!==pt)break;Tt++}const St=Ye.length;for(;wt!==Ye.length;){pt=Ye[wt].triangleSegmentIdx;let It=0,Lt=wt,$t=wt;for(let ut=Lt;ut<Tt&&Ye[ut].subtile===It;ut++)$t++;for(;Lt!==Tt;){const wt=Ye[Lt];It=wt.subtile;const St=this.centroidData[wt.centroidIdx].min.clone(),Xt=this.centroidData[wt.centroidIdx].max.clone(),Sr={vertexOffset:this.segments.segments[pt].vertexOffset,primitiveOffset:ut.length,vertexLength:this.segments.segments[pt].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let pt=Lt;pt<$t;pt++){const wt=Ye[pt],Tt=this.polygonSegments[wt.polygonSegmentIdx],It=this.centroidData[wt.centroidIdx].min,Lt=this.centroidData[wt.centroidIdx].max,$t=this.indexArray.uint16;for(let Ye=Tt.triangleArrayOffset;Ye<Tt.triangleArrayOffset+Tt.triangleCount;Ye++)ut.emplaceBack($t[3*Ye],$t[3*Ye+1],$t[3*Ye+2]);Sr.primitiveLength+=Tt.triangleCount,St.x=Math.min(St.x,It.x),St.y=Math.min(St.y,It.y),Xt.x=Math.max(Xt.x,Lt.x),Xt.y=Math.max(Xt.y,Lt.y)}Sr.primitiveLength>0&&this.triangleSubSegments.push({segment:Sr,min:St,max:Xt}),Lt=$t;for(let ut=Lt;ut<Tt&&Ye[ut].subtile===Ye[Lt].subtile;ut++)$t++}wt=Tt;for(let ut=wt;ut<St&&Ye[ut].triangleSegmentIdx===Ye[wt].triangleSegmentIdx;ut++)Tt++}ut._trim(),this.indexArray=ut}getVisibleSegments(Ye,ut,pt){let wt=0,Tt=0;const St=1<<Ye.canonical.z;if(ut){const pt=ut.getMinMaxForTile(Ye);pt&&(wt=pt.min,Tt=pt.max)}Tt+=this.maxHeight;const It=Ye.toUnwrapped();let Lt;const $t=[It.canonical.x/St+It.wrap,It.canonical.y/St],Xt=[(It.canonical.x+1)/St+It.wrap,(It.canonical.y+1)/St],Sr=new Au,h=(Ye,ut,pt)=>[Ye[0]*(1-pt[0])+ut[0]*pt[0],Ye[1]*(1-pt[1])+ut[1]*pt[1]],Lr=[],Qr=[];for(const Ye of this.triangleSubSegments){Lr[0]=Ye.min.x/ym,Lr[1]=Ye.min.y/ym,Qr[0]=Ye.max.x/ym,Qr[1]=Ye.max.y/ym;const ut=h($t,Xt,Lr),St=h($t,Xt,Qr);if(0===new Ah([ut[0],ut[1],wt],[St[0],St[1],Tt]).intersectsPrecise(pt)){Lt&&(Sr.segments.push(Lt),Lt=void 0);continue}const It=Ye.segment;Lt&&Lt.vertexOffset!==It.vertexOffset&&(Sr.segments.push(Lt),Lt=void 0),Lt?(Lt.vertexLength+=It.vertexLength,Lt.primitiveLength+=It.primitiveLength):Lt={vertexOffset:It.vertexOffset,primitiveLength:It.primitiveLength,vertexLength:It.vertexLength,primitiveOffset:It.primitiveOffset,sortKey:void 0,vaos:{}}}return Lt&&Sr.segments.push(Lt),Sr}encodeCentroid(Ye,ut){const pt=Ye.centroid(),wt=ut.span(),Tt=Math.min(7,Math.round(wt.x*this.tileToMeter/10)),St=Math.min(7,Math.round(wt.y*this.tileToMeter/10));return new wu(Ke(pt.x,1,ym-1)<<3|Tt,Ke(pt.y,1,ym-1)<<3|St)}encodeBorderCentroid(Ye){if(!Ye.borders)return new wu(0,0);const ut=Ye.borders,pt=Number.MAX_VALUE;if(ut[0][0]!==pt||ut[1][0]!==pt){const Ye=ut[0][0]!==pt?0:1;return new wu(6|(ut[0][0]!==pt?0:65528),(ut[Ye][0]+ut[Ye][1])/2<<3|6)}{const Ye=ut[2][0]!==pt?2:3;return new wu((ut[Ye][0]+ut[Ye][1])/2<<3|6,6|(ut[2][0]!==pt?0:65528))}}showCentroid(Ye){const ut=this.centroidData[Ye.centroidDataIndex];ut.flags&=dv,ut.centroidXY.x=0,ut.centroidXY.y=0,this.writeCentroidToBuffer(ut)}writeCentroidToBuffer(Ye){this.groundEffect.updateHiddenByLandmark(Ye);const ut=Ye.vertexArrayOffset,pt=Ye.vertexCount+Ye.vertexArrayOffset,wt=Ye.flags&dv?cv:Ye.centroidXY,Tt=this.centroidVertexArray.geta_centroid_pos0(ut);if(this.centroidVertexArray.geta_centroid_pos1(ut)!==wt.y||Tt!==wt.x){for(let Ye=ut;Ye<pt;++Ye)this.centroidVertexArray.emplace(Ye,wt.x,wt.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const Ye of this.centroidData)this.writeCentroidToBuffer(Ye)}updateReplacement(Ye,ut,pt){if(ut.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=ut.updateTime;const wt=ut.getReplacementRegionsForTile(Ye.toUnwrapped());if(Cf(this.activeReplacements,wt))return;if(this.activeReplacements=wt,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const Ye of this.centroidData)Ye.flags&=2147483647;const Tt=[];for(const ut of this.activeReplacements){if(ut.order<pt)continue;const wt=Math.pow(2,ut.footprintTileId.canonical.z-Ye.canonical.z);for(const pt of this.centroidData)if(!(pt.flags&dv||ut.min.x>pt.max.x||pt.min.x>ut.max.x||ut.min.y>pt.max.y||pt.min.y>ut.max.y))for(let St=0;St<pt.footprintSegLen;St++){const It=this.footprintSegments[pt.footprintSegIdx+St];if(Tt.length=0,kd(this.footprintVertices,It.vertexOffset,It.vertexCount,ut.footprintTileId.canonical,Ye.canonical,Tt),Lf(ut.footprint,Tt,this.footprintIndices.uint16,It.indexOffset,It.indexCount,-It.vertexOffset,-wt)){pt.flags|=dv;break}}}for(const Ye of this.centroidData)this.writeCentroidToBuffer(Ye);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(Ye,ut,pt){let wt=!1;for(let Tt=0;Tt<pt.footprintSegLen;Tt++){const St=this.footprintSegments[pt.footprintSegIdx+Tt];let It=0;for(const pt of St.ringIndices){for(let Tt=It,Lt=pt+It-1;Tt<pt+It;Lt=Tt++){const pt=this.footprintVertices.int16[2*(Tt+St.vertexOffset)+0],It=this.footprintVertices.int16[2*(Tt+St.vertexOffset)+1],$t=this.footprintVertices.int16[2*(Lt+St.vertexOffset)+1];It>ut!=$t>ut&&Ye<(this.footprintVertices.int16[2*(Lt+St.vertexOffset)+0]-pt)*(ut-It)/($t-It)+pt&&(wt=!wt)}It=pt}}return wt}getHeightAtTileCoord(Ye,ut){let pt=Number.NEGATIVE_INFINITY,wt=!0;const Tt=4*(Ye+ym)*ym+(ut+ym);if(this.partLookup.hasOwnProperty(Tt)){const Ye=this.partLookup[Tt];return Ye?{height:Ye.height,hidden:!!(Ye.flags&dv)}:void 0}for(const St of this.centroidData)Ye>St.max.x||St.min.x>Ye||ut>St.max.y||St.min.y>ut||this.footprintContainsPoint(Ye,ut,St)&&St&&St.height>pt&&(pt=St.height,this.partLookup[Tt]=St,wt=!!(St.flags&dv));if(pt!==Number.NEGATIVE_INFINITY)return{height:pt,hidden:wt};this.partLookup[Tt]=void 0}}function bd(Ye,ut){const pt=Ye.add(ut)._unit();return Ye.x*pt.x+Ye.y*pt.y}function vd(Ye,ut,pt,wt){const Tt=ut.sub(Ye)._perp()._unit(),St=pt.sub(ut)._perp()._unit();return _d(Ye,ut,pt,bd(Tt,St),wt)}function _d(Ye,ut,pt,wt,Tt){const St=Math.sqrt(1-wt*wt);return Math.min(Ye.dist(ut)/3,ut.dist(pt)/3,Tt*St/wt)}function wd(Ye,ut,pt){return Ye.x<pt[0].x&&ut.x<pt[0].x||Ye.x>pt[1].x&&ut.x>pt[1].x||Ye.y<pt[0].y&&ut.y<pt[0].y||Ye.y>pt[1].y&&ut.y>pt[1].y}function Md(Ye,ut){return Ye.x<ut[0].x||Ye.x>ut[1].x||Ye.y<ut[0].y||Ye.y>ut[1].y}function Ad(Ye,ut,pt){if(Ye.x<0||Ye.x>=ym||ut.x<0||ut.x>=ym||pt.x<0||pt.x>=ym)return!1;const wt=pt.sub(ut),Tt=wt.perp(),St=Ye.sub(ut);return(wt.x*St.x+wt.y*St.y)/Math.sqrt((wt.x*wt.x+wt.y*wt.y)*(St.x*St.x+St.y*St.y))>-.866&&Tt.x*St.x+Tt.y*St.y<0}function Sd(Ye,ut,pt){const wt=ut?2|Ye:-3&Ye;return pt?1|wt:-2&wt}function Id(){const Ye=Math.PI/32,ut=Math.tan(Ye),pt=mg;return pt*Math.sqrt(1+2*ut*ut)-pt}function Td(Ye,ut,pt){const wt=1<<pt.z,Tt=zc(pt.x/wt),St=zc((pt.x+1)/wt),It=Ec(pt.y/wt),Lt=Ec((pt.y+1)/wt);return function(Ye,ut,pt,wt,Tt=0,St){const It=[];if(!Ye.length||!pt||!wt)return It;const o=(Ye,ut)=>{for(const pt of Ye)It.push({polygon:pt,bounds:ut})},Lt=Math.ceil(Math.log2(pt)),$t=Math.ceil(Math.log2(wt)),Xt=Lt-$t,Sr=[];for(let Ye=0;Ye<Math.abs(Xt);Ye++)Sr.push(Xt>0?0:1);for(let Ye=0;Ye<Math.min(Lt,$t);Ye++)Sr.push(0),Sr.push(1);let Lr=Ye;if(Lr=kf(Lr,ut[0].y-Tt,ut[1].y+Tt,1),Lr=kf(Lr,ut[0].x-Tt,ut[1].x+Tt,0),!Lr.length)return It;const Qr=[];for(Sr.length?Qr.push({polygons:Lr,bounds:ut,depth:0}):o(Lr,ut);Qr.length;){const Ye=Qr.pop(),ut=Ye.depth,pt=Sr[ut],wt=Ye.bounds[0],It=Ye.bounds[1],Lt=0===pt?wt.x:wt.y,$t=0===pt?It.x:It.y,Xt=St?St(pt,Lt,$t):.5*(Lt+$t),Lr=kf(Ye.polygons,Lt-Tt,Xt+Tt,pt),fn=kf(Ye.polygons,Xt-Tt,$t+Tt,pt);if(Lr.length){const Ye=[wt,new wu(0===pt?Xt:It.x,1===pt?Xt:It.y)];Sr.length>ut+1?Qr.push({polygons:Lr,bounds:Ye,depth:ut+1}):o(Lr,Ye)}if(fn.length){const Ye=[new wu(0===pt?Xt:wt.x,1===pt?Xt:wt.y),It];Sr.length>ut+1?Qr.push({polygons:fn,bounds:Ye,depth:ut+1}):o(fn,Ye)}}return It}(Ye,ut,Math.ceil((St-Tt)/11.25),Math.ceil((It-Lt)/11.25),1,((Ye,ut,Tt)=>{if(0===Ye)return.5*(ut+Tt);{const Ye=Ec((pt.y+ut/ym)/wt);return(kc(.5*(Ec((pt.y+Tt/ym)/wt)+Ye))*wt-pt.y)*ym}}))}function kd(Ye,ut,pt,wt,Tt,St){const It=Math.pow(2,wt.z-Tt.z);for(let Lt=0;Lt<pt;Lt++){let pt=Ye.int16[2*(Lt+ut)+0],$t=Ye.int16[2*(Lt+ut)+1];pt=(pt+Tt.x*ym)*It-wt.x*ym,$t=($t+Tt.y*ym)*It-wt.y*ym,St.push(new wu(pt,$t))}}Mo(xd,"FillExtrusionBucket",{omit:["layers","features"]}),Mo(pd,"PartData"),Mo(hd,"FootprintSegment"),Mo(fd,"BorderCentroidData"),Mo(gd,"GroundEffect");const mv=new ol({visibility:new il(O_["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new il(O_["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var gv={paint:new ol({"fill-extrusion-opacity":new il(O_["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new sl(O_["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new il(O_["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new il(O_["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new sl(O_["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new sl(O_["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new sl(O_["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new il(O_["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new il(O_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new il(O_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new il(O_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new il(O_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new il(O_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new il(O_["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new il(O_["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new sl(O_["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new sl(O_["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new il(O_["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new il(O_["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new il(O_["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new il(O_["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new il(O_["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:mv};function Ed(Ye,ut){return Ye.x*ut.x+Ye.y*ut.y}function Bd(Ye,ut){if(1===Ye.length){let pt=0;const wt=ut[pt++];let Tt;for(;!Tt||wt.equals(Tt);)if(Tt=ut[pt++],!Tt)return 1/0;for(;pt<ut.length;pt++){const St=ut[pt],It=Ye[0],Lt=Tt.sub(wt),$t=St.sub(wt),Xt=It.sub(wt),Sr=Ed(Lt,Lt),Lr=Ed(Lt,$t),Qr=Ed($t,$t),fn=Ed(Xt,Lt),xn=Ed(Xt,$t),vn=Sr*Qr-Lr*Lr,kn=(Qr*fn-Lr*xn)/vn,Wn=(Sr*xn-Lr*fn)/vn,Xn=wt.z*(1-kn-Wn)+Tt.z*kn+St.z*Wn;if(isFinite(Xn))return Xn}return 1/0}{let Ye=1/0;for(const pt of ut)Ye=Math.min(Ye,pt.z);return Ye}}function Dd(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=It*Tt.getElevationAt(Ye,ut,!0,!0),Xt=0!==St[0],Sr=Xt?0===St[1]?It*(St[0]/7-450):It*function(Ye,ut,pt){const wt=Math.floor(ut[0]/8),Tt=Math.floor(ut[1]/8),St=10*(ut[0]-8*wt),It=10*(ut[1]-8*Tt),Lt=Ye.getElevationAt(wt,Tt,!0,!0),$t=Ye.getMeterToDEM(pt),Xt=Math.floor(.5*(St*$t-1)),Sr=Math.floor(.5*(It*$t-1)),Lr=Ye.tileCoordToPixel(wt,Tt),Qr=2*Xt+1,fn=2*Sr+1,xn=function(Ye,ut,pt,wt,Tt){return[Ye.getElevationAtPixel(ut,pt,!0),Ye.getElevationAtPixel(ut+Tt,pt,!0),Ye.getElevationAtPixel(ut,pt+Tt,!0),Ye.getElevationAtPixel(ut+wt,pt+Tt,!0)]}(Ye,Lr.x-Xt,Lr.y-Sr,Qr,fn),vn=Math.abs(xn[0]-xn[1]),kn=Math.abs(xn[2]-xn[3]),Wn=Math.abs(xn[0]-xn[2])+Math.abs(xn[1]-xn[3]),Xn=Math.min(.25,.5*$t*(vn+kn)/Qr),Jn=Math.min(.25,.5*$t*Wn/fn);return Lt+Math.max(Xn*St,Jn*It)}(Tt,St,Lt):$t;return{base:$t+(0===pt)?-1:pt,top:Xt?Math.max(Sr+wt,$t+pt+2):$t+wt}}const yv=Bl([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:xv}=yv,bv=Bl([{name:"a_packed",components:4,type:"Float32"}]),{members:wv}=bv,Ev=Bl([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Mv}=Ev,Av=Bl([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Iv=Bl([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),zv=Bl([{name:"a_projected_pos",components:4,type:"Float32"}],4);Bl([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const kv=Bl([{name:"a_occlusion_query_opacity",components:1,type:"Float32"}],4),Zv=Bl([{name:"a_z_offset",components:1,type:"Float32"}],4),Wv=Bl([{name:"a_texb",components:2,type:"Uint16"}]),Xv=Bl([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),ib=Bl([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);Bl([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const rb=Bl([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),sb=Bl([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Bl([{name:"triangle",components:3,type:"Uint16"}]),Bl([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Bl([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Float32",name:"occlusionState"},{type:"Float32",name:"occlusionOpacity"},{type:"Uint8",name:"hasIconTextFit"}]),Bl([{type:"Float32",name:"offsetX"}]),Bl([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);class Kd{constructor(Ye,ut){this.width=Ye,this.height=ut,this.nextRow=0,this.image=new pp({width:Ye,height:ut}),this.positions={},this.uploaded=!1}getDash(Ye,ut){const pt=this.getKey(Ye,ut);return this.positions[pt]}trim(){const Ye=this.width,ut=this.height=sr(this.nextRow);this.image.resize({width:Ye,height:ut})}getKey(Ye,ut){return Ye.join(",")+ut}getDashRanges(Ye,ut,pt){const wt=[];let Tt=Ye.length%2==1?-Ye[Ye.length-1]*pt:0,St=Ye[0]*pt,It=!0;wt.push({left:Tt,right:St,isDash:It,zeroLength:0===Ye[0]});let Lt=Ye[0];for(let ut=1;ut<Ye.length;ut++){It=!It;const $t=Ye[ut];Tt=Lt*pt,Lt+=$t,St=Lt*pt,wt.push({left:Tt,right:St,isDash:It,zeroLength:0===$t})}return wt}addRoundDash(Ye,ut,pt){const wt=ut/2;for(let ut=-pt;ut<=pt;ut++){const Tt=this.width*(this.nextRow+pt+ut);let St=0,It=Ye[St];for(let Lt=0;Lt<this.width;Lt++){Lt/It.right>1&&(It=Ye[++St]);const $t=Math.abs(Lt-It.left),Xt=Math.abs(Lt-It.right),Sr=Math.min($t,Xt);let Lr;const Qr=ut/pt*(wt+1);if(It.isDash){const Ye=wt-Math.abs(Qr);Lr=Math.sqrt(Sr*Sr+Ye*Ye)}else Lr=wt-Math.sqrt(Sr*Sr+Qr*Qr);this.image.data[Tt+Lt]=Math.max(0,Math.min(255,Lr+128))}}}addRegularDash(Ye,ut){for(let ut=Ye.length-1;ut>=0;--ut){const pt=Ye[ut],wt=Ye[ut+1];pt.zeroLength?Ye.splice(ut,1):wt&&wt.isDash===pt.isDash&&(wt.left=pt.left,Ye.splice(ut,1))}const pt=Ye[0],wt=Ye[Ye.length-1];pt.isDash===wt.isDash&&(pt.left=wt.left-this.width,wt.right=pt.right+this.width);const Tt=this.width*this.nextRow;let St=0,It=Ye[St];for(let pt=0;pt<this.width;pt++){pt/It.right>1&&(It=Ye[++St]);const wt=Math.abs(pt-It.left),Lt=Math.abs(pt-It.right),$t=Math.min(wt,Lt);this.image.data[Tt+pt]=Math.max(0,Math.min(255,(It.isDash?$t:-$t)+ut+128))}}addDash(Ye,ut){const pt=this.getKey(Ye,ut);if(this.positions[pt])return this.positions[pt];const wt="round"===ut,Tt=wt?7:0,St=2*Tt+1;if(this.nextRow+St>this.height)return fr("LineAtlas out of space"),null;0===Ye.length&&Ye.push(1);let It=0;for(let ut=0;ut<Ye.length;ut++)Ye[ut]<0&&(fr("Negative value is found in line dasharray, replacing values with 0"),Ye[ut]=0),It+=Ye[ut];if(0!==It){const pt=this.width/It,St=this.getDashRanges(Ye,this.width,pt);wt?this.addRoundDash(St,pt,Tt):this.addRegularDash(St,"square"===ut?.5*pt:0)}const Lt=this.nextRow+Tt;this.nextRow+=St;const $t={tl:[Lt,Tt],br:[It,0]};return this.positions[pt]=$t,$t}}Mo(Kd,"LineAtlas");const lb=Fx.types,cb=Math.cos(Math.PI/180*37.5),hb=Math.cos(Math.PI/180*5);class tm{constructor(Ye){this.zoom=Ye.zoom,this.overscaling=Ye.overscaling,this.layers=Ye.layers,this.layerIds=this.layers.map((Ye=>Ye.fqid)),this.index=Ye.index,this.projection=Ye.projection,this.hasPattern=!1,this.hasZOffset=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((Ye=>{this.gradients[Ye.id]={}})),this.layoutVertexArray=new Ol,this.layoutVertexArray2=new Fl,this.patternVertexArray=new Ul,this.indexArray=new Ql,this.programConfigurations=new Wu(Ye.layers,{zoom:Ye.zoom,lut:Ye.lut}),this.segments=new Au,this.maxLineLength=0,this.zOffsetVertexArray=new Xl,this.stateDependentLayerIds=this.layers.filter((Ye=>Ye.isStateDependent())).map((Ye=>Ye.id)),this.tessellationStep=Ye.tessellationStep?Ye.tessellationStep:ym/64}updateFootprints(Ye,ut){}populate(Ye,ut,pt,wt){this.hasPattern=Hp("line",this.layers,ut);const Tt=this.layers[0].layout.get("line-sort-key"),St=this.layers[0].layout.get("line-z-offset");this.hasZOffset=!St.isConstant()||!!St.constantOr(0);const It=[];for(const{feature:ut,id:St,index:Lt,sourceLayerIndex:$t}of Ye){const Ye=this.layers[0]._featureFilter.needGeometry,Xt=Xc(ut,Ye);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Xt,pt))continue;const Sr=Tt?Tt.evaluate(Xt,{},pt):void 0,Lr={id:St,properties:ut.properties,type:ut.type,sourceLayerIndex:$t,index:Lt,geometry:Ye?Xt.geometry:Yc(ut,pt,wt),patterns:{},sortKey:Sr};It.push(Lr)}Tt&&It.sort(((Ye,ut)=>Ye.sortKey-ut.sortKey));const{lineAtlas:Lt,featureIndex:$t}=ut,Xt=this.addConstantDashes(Lt);for(const wt of It){const{geometry:Tt,index:St,sourceLayerIndex:It}=wt;if(Xt&&this.addFeatureDashes(wt,Lt),this.hasPattern){const Ye=Kp("line",this.layers,wt,this.zoom,ut);this.patternFeatures.push(Ye)}else this.addFeature(wt,Tt,St,pt,Lt.positions,ut.availableImages,ut.brightness);$t.insert(Ye[St].feature,Tt,St,It,this.index)}}addConstantDashes(Ye){let ut=!1;for(const pt of this.layers){const wt=pt.paint.get("line-dasharray").value,Tt=pt.layout.get("line-cap").value;if("constant"!==wt.kind||"constant"!==Tt.kind)ut=!0;else{const ut=Tt.value,pt=wt.value;if(!pt)continue;Ye.addDash(pt,ut)}}return ut}addFeatureDashes(Ye,ut){const pt=this.zoom;for(const wt of this.layers){const Tt=wt.paint.get("line-dasharray").value,St=wt.layout.get("line-cap").value;if("constant"===Tt.kind&&"constant"===St.kind)continue;let It,Lt;if("constant"===Tt.kind){if(It=Tt.value,!It)continue}else It=Tt.evaluate({zoom:pt},Ye);Lt="constant"===St.kind?St.value:St.evaluate({zoom:pt},Ye),ut.addDash(It,Lt),Ye.patterns[wt.id]=ut.getKey(It,Lt)}}update(Ye,ut,pt,wt,Tt){const St=0!==Object.keys(Ye).length;St&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(Ye,ut,St?this.stateDependentLayers:this.layers,pt,wt,Tt)}addFeatures(Ye,ut,pt,wt,Tt,St){for(const Ye of this.patternFeatures)this.addFeature(Ye,Ye.geometry,Ye.index,ut,pt,wt,St)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(Ye){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=Ye.createVertexBuffer(this.layoutVertexArray2,wv)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=Ye.createVertexBuffer(this.patternVertexArray,Mv)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=Ye.createVertexBuffer(this.zOffsetVertexArray,Zv.members,!0)),this.layoutVertexBuffer=Ye.createVertexBuffer(this.layoutVertexArray,xv),this.indexBuffer=Ye.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(Ye),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(Ye){if(Ye.properties&&Ye.properties.hasOwnProperty("mapbox_clip_start")&&Ye.properties.hasOwnProperty("mapbox_clip_end"))return{start:+Ye.properties.mapbox_clip_start,end:+Ye.properties.mapbox_clip_end}}addFeature(Ye,ut,pt,wt,Tt,St,It){const Lt=this.layers[0].layout,$t=Lt.get("line-join").evaluate(Ye,{}),Xt=Lt.get("line-cap").evaluate(Ye,{}),Sr=Lt.get("line-miter-limit"),Lr=Lt.get("line-round-limit");this.lineClips=this.lineFeatureClips(Ye);for(const pt of ut)this.addLine(pt,Ye,wt,$t,Xt,Sr,Lr);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,Ye,pt,Tt,St,wt,It)}addLine(Ye,ut,pt,wt,Tt,St,It){this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.currentVertex=void 0;const Lt={zoom:this.zoom,lineProgress:void 0},$t=this.layers[0].layout,Xt="none"===wt;if(this.patternJoinNone=this.hasPattern&&Xt,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let ut=0;ut<Ye.length-1;ut++)this.totalDistance+=Ye[ut].dist(Ye[ut+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const Sr="Polygon"===lb[ut.type];let Lr=Ye.length;for(;Lr>=2&&Ye[Lr-1].equals(Ye[Lr-2]);)Lr--;let Qr=0;for(;Qr<Lr-1&&Ye[Qr].equals(Ye[Qr+1]);)Qr++;if(Lr<(Sr?3:2))return;"bevel"===wt&&(St=1.05);const fn=this.overscaling<=16?15*ym/(512*this.overscaling):0,xn=this.segments.prepareSegment(10*Lr,this.layoutVertexArray,this.indexArray);let vn,kn,Wn,Xn,Jn,Qn;this.e1=this.e2=-1,Sr&&(vn=Ye[Lr-2],Jn=Ye[Qr].sub(vn)._unit()._perp());for(let pt=Qr;pt<Lr;pt++){if(Wn=pt===Lr-1?Sr?Ye[Qr+1]:void 0:Ye[pt+1],Wn&&Ye[pt].equals(Wn))continue;if(Jn&&(Xn=Jn),vn&&(kn=vn),vn=Ye[pt],this.hasZOffset){const Ye=$t.get("line-z-offset").value;if("constant"===Ye.kind)Qn=Ye.value;else{if(this.lineClips){const Ye=this.totalDistance/(this.lineClips.end-this.lineClips.start);Lt.lineProgress=(Ye*this.lineClips.start+this.distance+(kn?kn.dist(vn):0))/Ye}else fr(`line-z-offset evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`),Lt.lineProgress=0;Qn=Ye.evaluate(Lt,ut)}Qn=Qn||0}Jn=Wn?Wn.sub(vn)._unit()._perp():Xn,Xn=Xn||Jn;const ko=kn&&Wn;let Fo=ko?wt:Sr||Xt?"butt":Tt;const is=Xn.x*Jn.x+Xn.y*Jn.y;if(Xt){const t=function(Ye){if(Ye.patternJoinNone){const ut=Ye.segmentPoints.length/2,pt=Ye.lineSoFar-Ye.segmentStart;for(let wt=0;wt<ut;++wt){const ut=Ye.segmentPoints[2*wt+1],Tt=Math.round(Ye.segmentPoints[2*wt])+.5+.25*ut;Ye.patternVertexArray.emplaceBack(Tt,pt,Ye.segmentStart),Ye.patternVertexArray.emplaceBack(Tt,pt,Ye.segmentStart)}Ye.segmentPoints.length=0}Ye.e1=Ye.e2=-1};if(ko&&is<hb){this.updateDistance(kn,vn),this.addCurrentVertex(vn,Xn,1,1,xn,Qn),t(this),this.addCurrentVertex(vn,Jn,-1,-1,xn,Qn);continue}if(kn){if(!Wn){this.updateDistance(kn,vn),this.addCurrentVertex(vn,Xn,1,1,xn,Qn),t(this);continue}Fo="miter"}}let ns=Xn.add(Jn);0===ns.x&&0===ns.y||ns._unit();const ss=ns.x*Jn.x+ns.y*Jn.y,as=0!==ss?1/ss:1/0,ds=2*Math.sqrt(2-2*ss),ps=ss<cb&&kn&&Wn,ms=Xn.x*Jn.y-Xn.y*Jn.x>0;if(ps&&pt>Qr){const Ye=vn.dist(kn);if(Ye>2*fn){const ut=vn.sub(vn.sub(kn)._mult(fn/Ye)._round());this.updateDistance(kn,ut),this.addCurrentVertex(ut,Xn,0,0,xn,Qn),kn=ut}}if(ko&&"round"===Fo&&(as<It?Fo="miter":as<=2&&(Fo="fakeround")),"miter"===Fo&&as>St&&(Fo="bevel"),"bevel"===Fo&&(as>2&&(Fo="flipbevel"),as<St&&(Fo="miter")),kn&&this.updateDistance(kn,vn),"miter"===Fo)ns._mult(as),this.addCurrentVertex(vn,ns,0,0,xn,Qn);else if("flipbevel"===Fo){if(as>100)ns=Jn.mult(-1);else{const Ye=as*Xn.add(Jn).mag()/Xn.sub(Jn).mag();ns._perp()._mult(Ye*(ms?-1:1))}this.addCurrentVertex(vn,ns,0,0,xn,Qn),this.addCurrentVertex(vn,ns.mult(-1),0,0,xn,Qn)}else if("bevel"===Fo||"fakeround"===Fo){const Ye=-Math.sqrt(as*as-1),ut=ms?Ye:0,pt=ms?0:Ye;if(kn&&this.addCurrentVertex(vn,Xn,ut,pt,xn,Qn),"fakeround"===Fo){const Ye=Math.round(180*ds/Math.PI/20);for(let ut=1;ut<Ye;ut++){let pt=ut/Ye;if(.5!==pt){const Ye=pt-.5;pt+=pt*Ye*(pt-1)*((1.0904+is*(is*(3.55645-1.43519*is)-3.2452))*Ye*Ye+(.848013+is*(.215638*is-1.06021)))}const wt=Jn.sub(Xn)._mult(pt)._add(Xn)._unit()._mult(ms?-1:1);this.addHalfVertex(vn,wt.x,wt.y,!1,ms,0,xn,Qn)}}Wn&&this.addCurrentVertex(vn,Jn,-ut,-pt,xn,Qn)}else"butt"===Fo?this.addCurrentVertex(vn,ns,0,0,xn,Qn):"square"===Fo?(kn||this.addCurrentVertex(vn,ns,-1,-1,xn,Qn),this.addCurrentVertex(vn,ns,0,0,xn,Qn),kn&&this.addCurrentVertex(vn,ns,1,1,xn,Qn)):"round"===Fo&&(kn&&(this.addCurrentVertex(vn,Xn,0,0,xn,Qn),this.addCurrentVertex(vn,Xn,1,1,xn,Qn,!0)),Wn&&(this.addCurrentVertex(vn,Jn,-1,-1,xn,Qn,!0),this.addCurrentVertex(vn,Jn,0,0,xn,Qn)));if(ps&&pt<Lr-1){const Ye=vn.dist(Wn);if(Ye>2*fn){const ut=vn.add(Wn.sub(vn)._mult(fn/Ye)._round());this.updateDistance(vn,ut),this.addCurrentVertex(ut,Jn,0,0,xn,Qn),vn=ut}}}}addVerticesTo(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt){const Sr=(ut.w-Ye.w)/this.tessellationStep|0;if(Sr>1){this.lineSoFar=Ye.w;const Lr=(ut.x-Ye.x)/Sr,Qr=(ut.y-Ye.y)/Sr,fn=(ut.z-Ye.z)/Sr,xn=(ut.w-Ye.w)/Sr;for(let ut=1;ut<Sr;++ut)Ye.x+=Lr,Ye.y+=Qr,Ye.z+=fn,this.lineSoFar+=xn,this.addHalfVertex(Ye,pt,wt,Xt,!1,It,$t,Ye.z),this.addHalfVertex(Ye,Tt,St,Xt,!0,-Lt,$t,Ye.z)}this.lineSoFar=ut.w,this.addHalfVertex(ut,pt,wt,Xt,!1,It,$t,ut.z),this.addHalfVertex(ut,Tt,St,Xt,!0,-Lt,$t,ut.z)}addCurrentVertex(Ye,ut,pt,wt,Tt,St,It=!1){const Lt=ut.x+ut.y*pt,$t=ut.y-ut.x*pt,Xt=ut.y*wt-ut.x,Sr=-ut.y-ut.x*wt;if(null!=St){const ut=-10,Lr=ym+10,Qr=St,fn=new Tf(Ye.x,Ye.y,Qr,this.lineSoFar),xn=em(Ye,ut,Lr),vn=this.lineSoFar;if(this.currentVertex)if(xn){const St=this.currentVertexIsOutside,fn=this.currentVertex,xn=new Tf(Ye.x,Ye.y,Qr,this.lineSoFar);zf(fn,xn,ut,Lr),em(xn,ut,Lr)||(St&&(this.e1=this.e2=-1,this.lineSoFar=fn.w,this.addHalfVertex(fn,Lt,$t,It,!1,pt,Tt,fn.z),this.addHalfVertex(fn,Xt,Sr,It,!0,-wt,Tt,fn.z)),this.addVerticesTo(fn,xn,Lt,$t,Xt,Sr,pt,wt,Tt,It))}else{const Ye=this.currentVertex;this.currentVertexIsOutside&&(zf(Ye,fn,ut,Lr),this.e1=this.e2=-1,this.lineSoFar=Ye.w,this.addHalfVertex(Ye,Lt,$t,It,!1,pt,Tt,Ye.z),this.addHalfVertex(Ye,Xt,Sr,It,!0,-wt,Tt,Ye.z)),this.addVerticesTo(Ye,fn,Lt,$t,Xt,Sr,pt,wt,Tt,It)}else xn||(this.addHalfVertex(Ye,Lt,$t,It,!1,pt,Tt,St),this.addHalfVertex(Ye,Xt,Sr,It,!0,-wt,Tt,St));this.currentVertex=fn,this.currentVertexIsOutside=xn,this.lineSoFar=vn}else this.addHalfVertex(Ye,Lt,$t,It,!1,pt,Tt,St),this.addHalfVertex(Ye,Xt,Sr,It,!0,-wt,Tt,St)}addHalfVertex({x:Ye,y:ut},pt,wt,Tt,St,It,Lt,$t){this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),St||this.segmentPoints.push(this.lineSoFar-this.segmentStart,It)),this.layoutVertexArray.emplaceBack((Ye<<1)+(Tt?1:0),(ut<<1)+(St?1:0),Math.round(63*pt)+128,Math.round(63*wt)+128,1+(0===It?0:It<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const Xt=Lt.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,Xt),Lt.primitiveLength++),St?this.e2=Xt:this.e1=Xt,null!=$t&&this.zOffsetVertexArray.emplaceBack($t)}updateScaledDistance(){if(this.lineClips){const Ye=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=Ye*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(Ye,ut){this.distance+=Ye.dist(ut),this.updateScaledDistance()}}function em(Ye,ut,pt){return Ye.x<ut||Ye.x>pt||Ye.y<ut||Ye.y>pt}Mo(tm,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const ub=new ol({"line-cap":new sl(O_.layout_line["line-cap"]),"line-join":new sl(O_.layout_line["line-join"]),"line-miter-limit":new il(O_.layout_line["line-miter-limit"]),"line-round-limit":new il(O_.layout_line["line-round-limit"]),"line-sort-key":new sl(O_.layout_line["line-sort-key"]),"line-z-offset":new sl(O_.layout_line["line-z-offset"]),visibility:new il(O_.layout_line.visibility)});var yb={paint:new ol({"line-opacity":new sl(O_.paint_line["line-opacity"]),"line-color":new sl(O_.paint_line["line-color"]),"line-translate":new il(O_.paint_line["line-translate"]),"line-translate-anchor":new il(O_.paint_line["line-translate-anchor"]),"line-width":new sl(O_.paint_line["line-width"]),"line-gap-width":new sl(O_.paint_line["line-gap-width"]),"line-offset":new sl(O_.paint_line["line-offset"]),"line-blur":new sl(O_.paint_line["line-blur"]),"line-dasharray":new sl(O_.paint_line["line-dasharray"]),"line-pattern":new sl(O_.paint_line["line-pattern"]),"line-gradient":new al(O_.paint_line["line-gradient"]),"line-trim-offset":new il(O_.paint_line["line-trim-offset"]),"line-trim-fade-range":new il(O_.paint_line["line-trim-fade-range"]),"line-trim-color":new il(O_.paint_line["line-trim-color"]),"line-emissive-strength":new il(O_.paint_line["line-emissive-strength"]),"line-border-width":new sl(O_.paint_line["line-border-width"]),"line-border-color":new sl(O_.paint_line["line-border-color"]),"line-occlusion-opacity":new il(O_.paint_line["line-occlusion-opacity"])}),layout:ub};function im(Ye,ut,pt){return ut*(ym/(Ye.tileSize*Math.pow(2,pt-Ye.tileID.overscaledZ)))}function sm(Ye,ut){return 1/im(Ye,1,ut.tileZoom)}function am(Ye,ut,pt,wt){return Ye.translatePosMatrix(wt||ut.tileID.projMatrix,ut,pt.paint.get("line-translate"),pt.paint.get("line-translate-anchor"))}const om=Ye=>{const ut=[];lm(Ye)&&ut.push("RENDER_LINE_DASH"),Ye.paint.get("line-gradient")&&ut.push("RENDER_LINE_GRADIENT");const pt=Ye.paint.get("line-trim-offset");0===pt[0]&&0===pt[1]||ut.push("RENDER_LINE_TRIM_OFFSET"),0!==Ye.paint.get("line-border-width").constantOr(1)&&ut.push("RENDER_LINE_BORDER");const wt="none"===Ye.layout.get("line-join").constantOr("miter"),Tt=!!Ye.paint.get("line-pattern").constantOr(1);return wt&&Tt&&ut.push("LINE_JOIN_NONE"),ut};function lm(Ye){const ut=Ye.paint.get("line-dasharray").value;return ut.value||"constant"!==ut.kind}class um{constructor(Ye){this._stringToNumber={},this._numberToString=[];for(let ut=0;ut<Ye.length;ut++){const pt=Ye[ut];this._stringToNumber[pt]=ut,this._numberToString[ut]=pt}}encode(Ye){return this._stringToNumber[Ye]}decode(Ye){return this._numberToString[Ye]}}var xb={read:function(Ye,ut,pt,wt,Tt){var St,It,Lt=8*Tt-wt-1,$t=(1<<Lt)-1,Xt=$t>>1,Sr=-7,Lr=pt?Tt-1:0,Qr=pt?-1:1,fn=Ye[ut+Lr];for(Lr+=Qr,St=fn&(1<<-Sr)-1,fn>>=-Sr,Sr+=Lt;Sr>0;St=256*St+Ye[ut+Lr],Lr+=Qr,Sr-=8);for(It=St&(1<<-Sr)-1,St>>=-Sr,Sr+=wt;Sr>0;It=256*It+Ye[ut+Lr],Lr+=Qr,Sr-=8);if(0===St)St=1-Xt;else{if(St===$t)return It?NaN:1/0*(fn?-1:1);It+=Math.pow(2,wt),St-=Xt}return(fn?-1:1)*It*Math.pow(2,St-wt)},write:function(Ye,ut,pt,wt,Tt,St){var It,Lt,$t,Xt=8*St-Tt-1,Sr=(1<<Xt)-1,Lr=Sr>>1,Qr=23===Tt?Math.pow(2,-24)-Math.pow(2,-77):0,fn=wt?0:St-1,xn=wt?1:-1,vn=ut<0||0===ut&&1/ut<0?1:0;for(ut=Math.abs(ut),isNaN(ut)||ut===1/0?(Lt=isNaN(ut)?1:0,It=Sr):(It=Math.floor(Math.log(ut)/Math.LN2),ut*($t=Math.pow(2,-It))<1&&(It--,$t*=2),(ut+=It+Lr>=1?Qr/$t:Qr*Math.pow(2,1-Lr))*$t>=2&&(It++,$t/=2),It+Lr>=Sr?(Lt=0,It=Sr):It+Lr>=1?(Lt=(ut*$t-1)*Math.pow(2,Tt),It+=Lr):(Lt=ut*Math.pow(2,Lr-1)*Math.pow(2,Tt),It=0));Tt>=8;Ye[pt+fn]=255&Lt,fn+=xn,Lt/=256,Tt-=8);for(It=It<<Tt|Lt,Xt+=Tt;Xt>0;Ye[pt+fn]=255&It,fn+=xn,It/=256,Xt-=8);Ye[pt+fn-xn]|=128*vn}},bb=fm,wb=xb;function fm(Ye){(this||ut).buf=ArrayBuffer.isView&&ArrayBuffer.isView(Ye)?Ye:new Uint8Array(Ye||0),(this||ut).pos=0,(this||ut).type=0,(this||ut).length=(this||ut).buf.length}fm.Varint=0,fm.Fixed64=1,fm.Bytes=2,fm.Fixed32=5;var Mb=4294967296,Sb=1/Mb,Pb="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function gm(Ye){return Ye.type===fm.Bytes?Ye.readVarint()+Ye.pos:Ye.pos+1}function xm(Ye,ut,pt){return pt?4294967296*ut+(Ye>>>0):4294967296*(ut>>>0)+(Ye>>>0)}function bm(Ye,ut,pt){var wt=ut<=16383?1:ut<=2097151?2:ut<=268435455?3:Math.floor(Math.log(ut)/(7*Math.LN2));pt.realloc(wt);for(var Tt=pt.pos-1;Tt>=Ye;Tt--)pt.buf[Tt+wt]=pt.buf[Tt]}function vm(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeVarint(Ye[pt])}function _m(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeSVarint(Ye[pt])}function wm(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeFloat(Ye[pt])}function Mm(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeDouble(Ye[pt])}function Am(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeBoolean(Ye[pt])}function Sm(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeFixed32(Ye[pt])}function Im(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeSFixed32(Ye[pt])}function Tm(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeFixed64(Ye[pt])}function km(Ye,ut){for(var pt=0;pt<Ye.length;pt++)ut.writeSFixed64(Ye[pt])}function Pm(Ye,ut){return(Ye[ut]|Ye[ut+1]<<8|Ye[ut+2]<<16)+16777216*Ye[ut+3]}function zm(Ye,ut,pt){Ye[pt]=ut,Ye[pt+1]=ut>>>8,Ye[pt+2]=ut>>>16,Ye[pt+3]=ut>>>24}function Em(Ye,ut){return(Ye[ut]|Ye[ut+1]<<8|Ye[ut+2]<<16)+(Ye[ut+3]<<24)}fm.prototype={destroy:function(){(this||ut).buf=null},readFields:function(Ye,pt,wt){for(wt=wt||(this||ut).length;(this||ut).pos<wt;){var Tt=this.readVarint(),St=Tt>>3,It=(this||ut).pos;(this||ut).type=7&Tt,Ye(St,pt,this||ut),(this||ut).pos===It&&this.skip(Tt)}return pt},readMessage:function(Ye,pt){return this.readFields(Ye,pt,this.readVarint()+(this||ut).pos)},readFixed32:function(){var Ye=Pm((this||ut).buf,(this||ut).pos);return(this||ut).pos+=4,Ye},readSFixed32:function(){var Ye=Em((this||ut).buf,(this||ut).pos);return(this||ut).pos+=4,Ye},readFixed64:function(){var Ye=Pm((this||ut).buf,(this||ut).pos)+Pm((this||ut).buf,(this||ut).pos+4)*Mb;return(this||ut).pos+=8,Ye},readSFixed64:function(){var Ye=Pm((this||ut).buf,(this||ut).pos)+Em((this||ut).buf,(this||ut).pos+4)*Mb;return(this||ut).pos+=8,Ye},readFloat:function(){var Ye=wb.read((this||ut).buf,(this||ut).pos,!0,23,4);return(this||ut).pos+=4,Ye},readDouble:function(){var Ye=wb.read((this||ut).buf,(this||ut).pos,!0,52,8);return(this||ut).pos+=8,Ye},readVarint:function(Ye){var pt,wt,Tt=(this||ut).buf;return pt=127&(wt=Tt[(this||ut).pos++]),wt<128?pt:(pt|=(127&(wt=Tt[(this||ut).pos++]))<<7,wt<128?pt:(pt|=(127&(wt=Tt[(this||ut).pos++]))<<14,wt<128?pt:(pt|=(127&(wt=Tt[(this||ut).pos++]))<<21,wt<128?pt:function(Ye,ut,pt){var wt,Tt,St=pt.buf;if(wt=(112&(Tt=St[pt.pos++]))>>4,Tt<128)return xm(Ye,wt,ut);if(wt|=(127&(Tt=St[pt.pos++]))<<3,Tt<128)return xm(Ye,wt,ut);if(wt|=(127&(Tt=St[pt.pos++]))<<10,Tt<128)return xm(Ye,wt,ut);if(wt|=(127&(Tt=St[pt.pos++]))<<17,Tt<128)return xm(Ye,wt,ut);if(wt|=(127&(Tt=St[pt.pos++]))<<24,Tt<128)return xm(Ye,wt,ut);if(wt|=(1&(Tt=St[pt.pos++]))<<31,Tt<128)return xm(Ye,wt,ut);throw new Error("Expected varint not more than 10 bytes")}(pt|=(15&(wt=Tt[(this||ut).pos]))<<28,Ye,this||ut))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var Ye=this.readVarint();return Ye%2==1?(Ye+1)/-2:Ye/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var Ye=this.readVarint()+(this||ut).pos,pt=(this||ut).pos;return(this||ut).pos=Ye,Ye-pt>=12&&Pb?function(Ye,ut,pt){return Pb.decode(Ye.subarray(ut,pt))}((this||ut).buf,pt,Ye):function(Ye,ut,pt){for(var wt="",Tt=ut;Tt<pt;){var St,It,Lt,$t=Ye[Tt],Xt=null,Sr=$t>239?4:$t>223?3:$t>191?2:1;if(Tt+Sr>pt)break;1===Sr?$t<128&&(Xt=$t):2===Sr?128==(192&(St=Ye[Tt+1]))&&(Xt=(31&$t)<<6|63&St)<=127&&(Xt=null):3===Sr?(It=Ye[Tt+2],128==(192&(St=Ye[Tt+1]))&&128==(192&It)&&((Xt=(15&$t)<<12|(63&St)<<6|63&It)<=2047||Xt>=55296&&Xt<=57343)&&(Xt=null)):4===Sr&&(It=Ye[Tt+2],Lt=Ye[Tt+3],128==(192&(St=Ye[Tt+1]))&&128==(192&It)&&128==(192&Lt)&&((Xt=(15&$t)<<18|(63&St)<<12|(63&It)<<6|63&Lt)<=65535||Xt>=1114112)&&(Xt=null)),null===Xt?(Xt=65533,Sr=1):Xt>65535&&(Xt-=65536,wt+=String.fromCharCode(Xt>>>10&1023|55296),Xt=56320|1023&Xt),wt+=String.fromCharCode(Xt),Tt+=Sr}return wt}((this||ut).buf,pt,Ye)},readBytes:function(){var Ye=this.readVarint()+(this||ut).pos,pt=(this||ut).buf.subarray((this||ut).pos,Ye);return(this||ut).pos=Ye,pt},readPackedVarint:function(Ye,pt){if((this||ut).type!==fm.Bytes)return Ye.push(this.readVarint(pt));var wt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<wt;)Ye.push(this.readVarint(pt));return Ye},readPackedSVarint:function(Ye){if((this||ut).type!==fm.Bytes)return Ye.push(this.readSVarint());var pt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<pt;)Ye.push(this.readSVarint());return Ye},readPackedBoolean:function(Ye){if((this||ut).type!==fm.Bytes)return Ye.push(this.readBoolean());var pt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<pt;)Ye.push(this.readBoolean());return Ye},readPackedFloat:function(Ye){if((this||ut).type!==fm.Bytes)return Ye.push(this.readFloat());var pt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<pt;)Ye.push(this.readFloat());return Ye},readPackedDouble:function(Ye){if((this||ut).type!==fm.Bytes)return Ye.push(this.readDouble());var pt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<pt;)Ye.push(this.readDouble());return Ye},readPackedFixed32:function(Ye){if((this||ut).type!==fm.Bytes)return Ye.push(this.readFixed32());var pt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<pt;)Ye.push(this.readFixed32());return Ye},readPackedSFixed32:function(Ye){if((this||ut).type!==fm.Bytes)return Ye.push(this.readSFixed32());var pt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<pt;)Ye.push(this.readSFixed32());return Ye},readPackedFixed64:function(Ye){if((this||ut).type!==fm.Bytes)return Ye.push(this.readFixed64());var pt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<pt;)Ye.push(this.readFixed64());return Ye},readPackedSFixed64:function(Ye){if((this||ut).type!==fm.Bytes)return Ye.push(this.readSFixed64());var pt=gm(this||ut);for(Ye=Ye||[];(this||ut).pos<pt;)Ye.push(this.readSFixed64());return Ye},skip:function(Ye){var pt=7&Ye;if(pt===fm.Varint)for(;(this||ut).buf[(this||ut).pos++]>127;);else if(pt===fm.Bytes)(this||ut).pos=this.readVarint()+(this||ut).pos;else if(pt===fm.Fixed32)(this||ut).pos+=4;else{if(pt!==fm.Fixed64)throw new Error("Unimplemented type: "+pt);(this||ut).pos+=8}},writeTag:function(Ye,ut){this.writeVarint(Ye<<3|ut)},realloc:function(Ye){for(var pt=(this||ut).length||16;pt<(this||ut).pos+Ye;)pt*=2;if(pt!==(this||ut).length){var wt=new Uint8Array(pt);wt.set((this||ut).buf),(this||ut).buf=wt,(this||ut).length=pt}},finish:function(){return(this||ut).length=(this||ut).pos,(this||ut).pos=0,(this||ut).buf.subarray(0,(this||ut).length)},writeFixed32:function(Ye){this.realloc(4),zm((this||ut).buf,Ye,(this||ut).pos),(this||ut).pos+=4},writeSFixed32:function(Ye){this.realloc(4),zm((this||ut).buf,Ye,(this||ut).pos),(this||ut).pos+=4},writeFixed64:function(Ye){this.realloc(8),zm((this||ut).buf,-1&Ye,(this||ut).pos),zm((this||ut).buf,Math.floor(Ye*Sb),(this||ut).pos+4),(this||ut).pos+=8},writeSFixed64:function(Ye){this.realloc(8),zm((this||ut).buf,-1&Ye,(this||ut).pos),zm((this||ut).buf,Math.floor(Ye*Sb),(this||ut).pos+4),(this||ut).pos+=8},writeVarint:function(Ye){(Ye=+Ye||0)>268435455||Ye<0?function(Ye,ut){var pt,wt;if(Ye>=0?(pt=Ye%4294967296|0,wt=Ye/4294967296|0):(wt=~(-Ye/4294967296),4294967295^(pt=~(-Ye%4294967296))?pt=pt+1|0:(pt=0,wt=wt+1|0)),Ye>=0x10000000000000000||Ye<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");ut.realloc(10),function(Ye,ut,pt){pt.buf[pt.pos++]=127&Ye|128,Ye>>>=7,pt.buf[pt.pos++]=127&Ye|128,Ye>>>=7,pt.buf[pt.pos++]=127&Ye|128,Ye>>>=7,pt.buf[pt.pos++]=127&Ye|128,pt.buf[pt.pos]=127&(Ye>>>=7)}(pt,0,ut),function(Ye,ut){var pt=(7&Ye)<<4;ut.buf[ut.pos++]|=pt|((Ye>>>=3)?128:0),Ye&&(ut.buf[ut.pos++]=127&Ye|((Ye>>>=7)?128:0),Ye&&(ut.buf[ut.pos++]=127&Ye|((Ye>>>=7)?128:0),Ye&&(ut.buf[ut.pos++]=127&Ye|((Ye>>>=7)?128:0),Ye&&(ut.buf[ut.pos++]=127&Ye|((Ye>>>=7)?128:0),Ye&&(ut.buf[ut.pos++]=127&Ye)))))}(wt,ut)}(Ye,this||ut):(this.realloc(4),(this||ut).buf[(this||ut).pos++]=127&Ye|(Ye>127?128:0),Ye<=127||((this||ut).buf[(this||ut).pos++]=127&(Ye>>>=7)|(Ye>127?128:0),Ye<=127||((this||ut).buf[(this||ut).pos++]=127&(Ye>>>=7)|(Ye>127?128:0),Ye<=127||((this||ut).buf[(this||ut).pos++]=Ye>>>7&127))))},writeSVarint:function(Ye){this.writeVarint(Ye<0?2*-Ye-1:2*Ye)},writeBoolean:function(Ye){this.writeVarint(Boolean(Ye))},writeString:function(Ye){Ye=String(Ye),this.realloc(4*Ye.length),(this||ut).pos++;var pt=(this||ut).pos;(this||ut).pos=function(Ye,ut,pt){for(var wt,Tt,St=0;St<ut.length;St++){if((wt=ut.charCodeAt(St))>55295&&wt<57344){if(!Tt){wt>56319||St+1===ut.length?(Ye[pt++]=239,Ye[pt++]=191,Ye[pt++]=189):Tt=wt;continue}if(wt<56320){Ye[pt++]=239,Ye[pt++]=191,Ye[pt++]=189,Tt=wt;continue}wt=Tt-55296<<10|wt-56320|65536,Tt=null}else Tt&&(Ye[pt++]=239,Ye[pt++]=191,Ye[pt++]=189,Tt=null);wt<128?Ye[pt++]=wt:(wt<2048?Ye[pt++]=wt>>6|192:(wt<65536?Ye[pt++]=wt>>12|224:(Ye[pt++]=wt>>18|240,Ye[pt++]=wt>>12&63|128),Ye[pt++]=wt>>6&63|128),Ye[pt++]=63&wt|128)}return pt}((this||ut).buf,Ye,(this||ut).pos);var wt=(this||ut).pos-pt;wt>=128&&bm(pt,wt,this||ut),(this||ut).pos=pt-1,this.writeVarint(wt),(this||ut).pos+=wt},writeFloat:function(Ye){this.realloc(4),wb.write((this||ut).buf,Ye,(this||ut).pos,!0,23,4),(this||ut).pos+=4},writeDouble:function(Ye){this.realloc(8),wb.write((this||ut).buf,Ye,(this||ut).pos,!0,52,8),(this||ut).pos+=8},writeBytes:function(Ye){var pt=Ye.length;this.writeVarint(pt),this.realloc(pt);for(var wt=0;wt<pt;wt++)(this||ut).buf[(this||ut).pos++]=Ye[wt]},writeRawMessage:function(Ye,pt){(this||ut).pos++;var wt=(this||ut).pos;Ye(pt,this||ut);var Tt=(this||ut).pos-wt;Tt>=128&&bm(wt,Tt,this||ut),(this||ut).pos=wt-1,this.writeVarint(Tt),(this||ut).pos+=Tt},writeMessage:function(Ye,ut,pt){this.writeTag(Ye,fm.Bytes),this.writeRawMessage(ut,pt)},writePackedVarint:function(Ye,ut){ut.length&&this.writeMessage(Ye,vm,ut)},writePackedSVarint:function(Ye,ut){ut.length&&this.writeMessage(Ye,_m,ut)},writePackedBoolean:function(Ye,ut){ut.length&&this.writeMessage(Ye,Am,ut)},writePackedFloat:function(Ye,ut){ut.length&&this.writeMessage(Ye,wm,ut)},writePackedDouble:function(Ye,ut){ut.length&&this.writeMessage(Ye,Mm,ut)},writePackedFixed32:function(Ye,ut){ut.length&&this.writeMessage(Ye,Sm,ut)},writePackedSFixed32:function(Ye,ut){ut.length&&this.writeMessage(Ye,Im,ut)},writePackedFixed64:function(Ye,ut){ut.length&&this.writeMessage(Ye,Tm,ut)},writePackedSFixed64:function(Ye,ut){ut.length&&this.writeMessage(Ye,km,ut)},writeBytesField:function(Ye,ut){this.writeTag(Ye,fm.Bytes),this.writeBytes(ut)},writeFixed32Field:function(Ye,ut){this.writeTag(Ye,fm.Fixed32),this.writeFixed32(ut)},writeSFixed32Field:function(Ye,ut){this.writeTag(Ye,fm.Fixed32),this.writeSFixed32(ut)},writeFixed64Field:function(Ye,ut){this.writeTag(Ye,fm.Fixed64),this.writeFixed64(ut)},writeSFixed64Field:function(Ye,ut){this.writeTag(Ye,fm.Fixed64),this.writeSFixed64(ut)},writeVarintField:function(Ye,ut){this.writeTag(Ye,fm.Varint),this.writeVarint(ut)},writeSVarintField:function(Ye,ut){this.writeTag(Ye,fm.Varint),this.writeSVarint(ut)},writeStringField:function(Ye,ut){this.writeTag(Ye,fm.Bytes),this.writeString(ut)},writeFloatField:function(Ye,ut){this.writeTag(Ye,fm.Fixed32),this.writeFloat(ut)},writeDoubleField:function(Ye,ut){this.writeTag(Ye,fm.Fixed64),this.writeDouble(ut)},writeBooleanField:function(Ye,ut){this.writeVarintField(Ye,Boolean(ut))}};var Lb=p(bb);const Ob=["id","tile","layer","source","sourceLayer","state"];class Cm{constructor(Ye,ut,pt,wt,Tt){this.type="Feature",this._vectorTileFeature=Ye,this._z=ut,this._x=pt,this._y=wt,this.properties=Ye.properties,this.id=Tt}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(Ye){this._geometry=Ye}toJSON(){const Ye={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const ut of Ob)void 0!==this[ut]&&(Ye[ut]=this[ut]);return Ye}}class Rm{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(Ye,ut,pt){const wt=String(ut);if(this.stateChanges[Ye]=this.stateChanges[Ye]||{},this.stateChanges[Ye][wt]=this.stateChanges[Ye][wt]||{},er(this.stateChanges[Ye][wt],pt),null===this.deletedStates[Ye]){this.deletedStates[Ye]={};for(const ut in this.state[Ye])ut!==wt&&(this.deletedStates[Ye][ut]=null)}else if(this.deletedStates[Ye]&&null===this.deletedStates[Ye][wt]){this.deletedStates[Ye][wt]={};for(const ut in this.state[Ye][wt])pt[ut]||(this.deletedStates[Ye][wt][ut]=null)}else for(const ut in pt)this.deletedStates[Ye]&&this.deletedStates[Ye][wt]&&null===this.deletedStates[Ye][wt][ut]&&delete this.deletedStates[Ye][wt][ut]}removeFeatureState(Ye,ut,pt){if(null===this.deletedStates[Ye])return;const wt=String(ut);if(this.deletedStates[Ye]=this.deletedStates[Ye]||{},pt&&void 0!==ut)null!==this.deletedStates[Ye][wt]&&(this.deletedStates[Ye][wt]=this.deletedStates[Ye][wt]||{},this.deletedStates[Ye][wt][pt]=null);else if(void 0!==ut)if(this.stateChanges[Ye]&&this.stateChanges[Ye][wt])for(pt in this.deletedStates[Ye][wt]={},this.stateChanges[Ye][wt])this.deletedStates[Ye][wt][pt]=null;else this.deletedStates[Ye][wt]=null;else this.deletedStates[Ye]=null}getState(Ye,ut){const pt=String(ut),wt=er({},(this.state[Ye]||{})[pt],(this.stateChanges[Ye]||{})[pt]);if(null===this.deletedStates[Ye])return{};if(this.deletedStates[Ye]){const pt=this.deletedStates[Ye][ut];if(null===pt)return{};for(const Ye in pt)delete wt[Ye]}return wt}initializeTileState(Ye,ut){Ye.setFeatureState(this.state,ut)}coalesceChanges(Ye,ut){const pt={};for(const Ye in this.stateChanges){this.state[Ye]=this.state[Ye]||{};const ut={};for(const pt in this.stateChanges[Ye])this.state[Ye][pt]||(this.state[Ye][pt]={}),er(this.state[Ye][pt],this.stateChanges[Ye][pt]),ut[pt]=this.state[Ye][pt];pt[Ye]=ut}for(const Ye in this.deletedStates){this.state[Ye]=this.state[Ye]||{};const ut={};if(null===this.deletedStates[Ye])for(const pt in this.state[Ye])ut[pt]={},this.state[Ye][pt]={};else for(const pt in this.deletedStates[Ye]){if(null===this.deletedStates[Ye][pt])this.state[Ye][pt]={};else if(this.state[Ye][pt])for(const ut of Object.keys(this.deletedStates[Ye][pt]))delete this.state[Ye][pt][ut];ut[pt]=this.state[Ye][pt]}pt[Ye]=pt[Ye]||{},er(pt[Ye],ut)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(pt).length)for(const wt in Ye)Ye[wt].setFeatureState(pt,ut)}}class Vm{constructor(Ye,ut){this.tileID=Ye,this.x=Ye.canonical.x,this.y=Ye.canonical.y,this.z=Ye.canonical.z,this.grid=new M_(ym,16,0),this.featureIndexArray=new vu,this.promoteId=ut,this.is3DTile=!1}insert(Ye,ut,pt,wt,Tt,St=0,It=0){const Lt=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(pt,wt,Tt,St);const $t=this.grid;for(let Ye=0;Ye<ut.length;Ye++){const pt=ut[Ye],wt=[1/0,1/0,-1/0,-1/0];for(let Ye=0;Ye<pt.length;Ye++){const ut=pt[Ye];wt[0]=Math.min(wt[0],ut.x),wt[1]=Math.min(wt[1],ut.y),wt[2]=Math.max(wt[2],ut.x),wt[3]=Math.max(wt[3],ut.y)}0!==It&&(wt[0]-=It,wt[1]-=It,wt[2]+=It,wt[3]+=It),wt[0]<ym&&wt[1]<ym&&wt[2]>=0&&wt[3]>=0&&$t.insert(Lt,wt[0],wt[1],wt[2],wt[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Bx(new Lb(this.rawTileData)).layers,this.sourceLayerCoder=new um(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const Ye in this.vtLayers)this.vtFeatures[Ye]=[]}return this.vtLayers}query(Ye,ut,pt,wt){this.loadVTLayers();const Tt=Ye.params||{},St=pl(Tt.filter),It=Ye.tileResult,Lt=Ye.transform,$t=It.bufferedTilespaceBounds,Xt=this.grid.query($t.min.x,$t.min.y,$t.max.x,$t.max.y,((Ye,ut,pt,wt)=>oh(It.bufferedTilespaceGeometry,Ye,ut,pt,wt)));Xt.sort(Om);let Sr=null;Lt.elevation&&Xt.length>0&&(Sr=Qf.create(Lt.elevation,this.tileID));const Lr={};let Qr;for(let $t=0;$t<Xt.length;$t++){const fn=Xt[$t];if(fn===Qr)continue;Qr=fn;const xn=this.featureIndexArray.get(fn);let vn=null;if(this.is3DTile){const Ye=this.bucketLayerIDs[0][0],pt=ut[Ye];if("model"!==pt.type)continue;const{queryFeature:wt,intersectionZ:Tt}=pt.queryIntersectsMatchingFeature(It,xn.featureIndex,St,Lt);wt&&this.appendToResult(Lr,Ye,xn.featureIndex,wt,Tt)}else this.loadMatchingFeature(Lr,xn,St,Tt.layers,Tt.availableImages,ut,pt,wt,((ut,pt,wt,Tt=0)=>(vn||(vn=Yc(ut,this.tileID.canonical,Ye.tileTransform)),pt.queryIntersectsFeature(It,ut,wt,vn,this.z,Ye.transform,Ye.pixelPosMatrix,Sr,Tt))))}return Lr}loadMatchingFeature(Ye,ut,pt,wt,Tt,St,It,Lt,$t){const{featureIndex:Xt,bucketIndex:Sr,sourceLayerIndex:Lr,layoutVertexArrayOffset:Qr}=ut,fn=this.bucketLayerIDs[Sr];if(wt&&!function(Ye,ut){for(let pt=0;pt<Ye.length;pt++)if(ut.indexOf(Ye[pt])>=0)return!0;return!1}(wt,fn))return;const xn=this.sourceLayerCoder.decode(Lr),vn=this.vtLayers[xn].feature(Xt);if(pt.needGeometry){const Ye=Xc(vn,!0);if(!pt.filter(new Ho(this.tileID.overscaledZ),Ye,this.tileID.canonical))return}else if(!pt.filter(new Ho(this.tileID.overscaledZ),vn))return;const kn=this.getId(vn,xn);for(let ut=0;ut<fn.length;ut++){const pt=fn[ut];if(wt&&wt.indexOf(pt)<0)continue;const Sr=St[pt];if(!Sr)continue;let Lr={};void 0!==kn&&Lt&&(Lr=Lt.getState(Sr.sourceLayer||"_geojsonTileLayer",kn));const xn=!$t||$t(vn,Sr,Lr,Qr);if(!xn)continue;const Wn=new Cm(vn,this.z,this.x,this.y,kn),Xn=er({},It[pt]);Xn.paint=Lm(Xn.paint,Sr.paint,vn,Lr,Tt),Xn.layout=Lm(Xn.layout,Sr.layout,vn,Lr,Tt),Wn.layer=Xn,this.appendToResult(Ye,pt,Xt,Wn,xn)}}appendToResult(Ye,ut,pt,wt,Tt){let St=Ye[ut];void 0===St&&(St=Ye[ut]=[]),St.push({featureIndex:pt,feature:wt,intersectionZ:Tt})}lookupSymbolFeatures(Ye,ut,pt,wt,Tt,St,It,Lt){const $t={};this.loadVTLayers();const Xt=pl(Tt);for(const Tt of Ye)this.loadMatchingFeature($t,{bucketIndex:pt,sourceLayerIndex:wt,featureIndex:Tt,layoutVertexArrayOffset:0},Xt,St,It,Lt,ut);return $t}loadFeature(Ye){const{featureIndex:ut,sourceLayerIndex:pt}=Ye;this.loadVTLayers();const wt=this.sourceLayerCoder.decode(pt),Tt=this.vtFeatures[wt];if(Tt[ut])return Tt[ut];const St=this.vtLayers[wt].feature(ut);return Tt[ut]=St,St}hasLayer(Ye){for(const ut of this.bucketLayerIDs)for(const pt of ut)if(Ye===pt)return!0;return!1}getId(Ye,ut){let pt=Ye.id;if(this.promoteId){const wt="string"==typeof this.promoteId?this.promoteId:this.promoteId[ut];null!=wt&&(pt=Ye.properties[wt]),"boolean"==typeof pt&&(pt=Number(pt))}return pt}}function Lm(Ye,ut,pt,wt,Tt){return ur(Ye,((Ye,St)=>{const It=ut instanceof nl?ut.get(St):null;return It&&It.evaluate?It.evaluate(pt,wt,Tt):It}))}function Om(Ye,ut){return ut-Ye}Mo(Vm,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});var Fb=24;const Nb=128;function Nm(Ye,ut){const{expression:pt}=ut;if("constant"===pt.kind)return{kind:"constant",layoutSize:pt.evaluate(new Ho(Ye+1))};if("source"===pt.kind)return{kind:"source"};{const{zoomStops:ut,interpolationType:wt}=pt;let Tt=0;for(;Tt<ut.length&&ut[Tt]<=Ye;)Tt++;Tt=Math.max(0,Tt-1);let St=Tt;for(;St<ut.length&&ut[St]<Ye+1;)St++;St=Math.min(ut.length-1,St);const It=ut[Tt],Lt=ut[St];return"composite"===pt.kind?{kind:"composite",minZoom:It,maxZoom:Lt,interpolationType:wt}:{kind:"camera",minZoom:It,maxZoom:Lt,minSize:pt.evaluate(new Ho(It)),maxSize:pt.evaluate(new Ho(Lt)),interpolationType:wt}}}function jm(Ye,{uSize:ut,uSizeT:pt},{lowerSize:wt,upperSize:Tt}){return"source"===Ye.kind?wt/Nb:"composite"===Ye.kind?Gn(wt/Nb,Tt/Nb,pt):ut}function qm(Ye,ut){let pt=0,wt=0;if("constant"===Ye.kind)wt=Ye.layoutSize;else if("source"!==Ye.kind){const{interpolationType:Tt,minZoom:St,maxZoom:It}=Ye,Lt=Tt?Ke(va.interpolationFactor(Tt,ut,St,It),0,1):0;"camera"===Ye.kind?wt=Gn(Ye.minSize,Ye.maxSize,Lt):pt=Lt}return{uSizeT:pt,uSize:wt}}var Vb=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Nb,evaluateSizeForFeature:jm,evaluateSizeForZoom:qm,getSizeData:Nm});function Gm(Ye,ut,pt){return Ye.sections.forEach((Ye=>{Ye.text=function(Ye,ut,pt){const wt=ut.layout.get("text-transform").evaluate(pt,{});return"uppercase"===wt?Ye=Ye.toLocaleUpperCase():"lowercase"===wt&&(Ye=Ye.toLocaleLowerCase()),k_.applyArabicShaping&&(Ye=k_.applyArabicShaping(Ye)),Ye}(Ye.text,ut,pt)})),Ye}const Ub={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function Xm(Ye){return"︶"===Ye||"﹈"===Ye||"︸"===Ye||"﹄"===Ye||"﹂"===Ye||"︾"===Ye||"︼"===Ye||"︺"===Ye||"︘"===Ye||"﹀"===Ye||"︐"===Ye||"︓"===Ye||"︔"===Ye||"｀"===Ye||"￣"===Ye||"︑"===Ye||"︒"===Ye}function Zm(Ye){return"︵"===Ye||"﹇"===Ye||"︷"===Ye||"﹃"===Ye||"﹁"===Ye||"︽"===Ye||"︻"===Ye||"︹"===Ye||"︗"===Ye||"︿"===Ye}const jb=3;function Km(Ye,ut,pt){ut.glyphs=[],1===Ye&&pt.readMessage(Wm,ut)}function Wm(Ye,ut,pt){if(3===Ye){const{id:Ye,bitmap:wt,width:Tt,height:St,left:It,top:Lt,advance:$t}=pt.readMessage(Jm,{});ut.glyphs.push({id:Ye,bitmap:new pp({width:Tt+2*jb,height:St+2*jb},wt),metrics:{width:Tt,height:St,left:It,top:Lt,advance:$t}})}else 4===Ye?ut.ascender=pt.readSVarint():5===Ye&&(ut.descender=pt.readSVarint())}function Jm(Ye,ut,pt){1===Ye?ut.id=pt.readVarint():2===Ye?ut.bitmap=pt.readBytes():3===Ye?ut.width=pt.readVarint():4===Ye?ut.height=pt.readVarint():5===Ye?ut.left=pt.readSVarint():6===Ye?ut.top=pt.readSVarint():7===Ye&&(ut.advance=pt.readVarint())}const Zb=jb,Wb={horizontal:1,vertical:2,horizontalOnly:3};class ey{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(Ye,ut){const pt=new ey;return pt.scale=Ye||1,pt.fontStack=ut,pt}static forImage(Ye){const ut=new ey;return ut.imageName=Ye,ut}}class ry{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(Ye,ut){const pt=new ry;for(let wt=0;wt<Ye.sections.length;wt++){const Tt=Ye.sections[wt];Tt.image?pt.addImageSection(Tt):pt.addTextSection(Tt,ut)}return pt}length(){return this.text.length}getSection(Ye){return this.sections[this.sectionIndex[Ye]]}getSections(){return this.sections}getSectionIndex(Ye){return this.sectionIndex[Ye]}getCodePoint(Ye){return this.text.codePointAt(Ye)}verticalizePunctuation(Ye){this.text=function(Ye,ut){let pt="";for(let wt=0;wt<Ye.length;wt++){const Tt=Ye.charCodeAt(wt+1)||null,St=Ye.charCodeAt(wt-1)||null;pt+=!ut&&(Tt&&Do(Tt)&&!Ub[Ye[wt+1]]||St&&Do(St)&&!Ub[Ye[wt-1]])||!Ub[Ye[wt]]?Ye[wt]:Ub[Ye[wt]]}return pt}(this.text,Ye)}trim(){let Ye=0;for(let ut=0;ut<this.text.length&&Hb[this.text.charCodeAt(ut)];ut++)Ye++;let ut=this.text.length;for(let pt=this.text.length-1;pt>=0&&pt>=Ye&&Hb[this.text.charCodeAt(pt)];pt--)ut--;this.text=this.text.substring(Ye,ut),this.sectionIndex=this.sectionIndex.slice(Ye,ut)}substring(Ye,ut){const pt=new ry;return pt.text=this.text.substring(Ye,ut),pt.sectionIndex=this.sectionIndex.slice(Ye,ut),pt.sections=this.sections,pt}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((Ye,ut)=>Math.max(Ye,this.sections[ut].scale)),0)}addTextSection(Ye,ut){this.text+=Ye.text,this.sections.push(ey.forText(Ye.scale,Ye.fontStack||ut));const pt=this.sections.length-1;for(let ut=0;ut<Ye.text.length;++ut)this.sectionIndex.push(pt)}addImageSection(Ye){const ut=Ye.image?Ye.image.namePrimary:"";if(0===ut.length)return void fr("Can't add FormattedSection with an empty image.");const pt=this.getNextImageSectionCharCode();pt?(this.text+=String.fromCodePoint(pt),this.sections.push(ey.forImage(ut)),this.sectionIndex.push(this.sections.length-1)):fr("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function ny(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn){const vn=ry.fromFeature(Ye,Tt);Lr===Wb.vertical&&vn.verticalizePunctuation(Qr);let kn=[];const Wn=function(Ye,ut,pt,wt,Tt,St){if(!Ye)return[];const It=[],Lt=function(Ye,ut,pt,wt,Tt,St){let It=0;for(let pt=0;pt<Ye.length();pt++){const Lt=Ye.getSection(pt);It+=ay(Ye.getCodePoint(pt),Lt,wt,Tt,ut,St)}return It/Math.max(1,Math.ceil(It/pt))}(Ye,ut,pt,wt,Tt,St),$t=Ye.text.indexOf("​")>=0;let Xt=0;for(let pt=0;pt<Ye.length();pt++){const Lr=Ye.getSection(pt),Qr=Ye.getCodePoint(pt);if(Hb[Qr]||(Xt+=ay(Qr,Lr,wt,Tt,ut,St)),pt<Ye.length()-1){const ut=!((Sr=Qr)<11904||!(S_["Bopomofo Extended"](Sr)||S_.Bopomofo(Sr)||S_["CJK Compatibility Forms"](Sr)||S_["CJK Compatibility Ideographs"](Sr)||S_["CJK Compatibility"](Sr)||S_["CJK Radicals Supplement"](Sr)||S_["CJK Strokes"](Sr)||S_["CJK Symbols and Punctuation"](Sr)||S_["CJK Unified Ideographs Extension A"](Sr)||S_["CJK Unified Ideographs"](Sr)||S_["Enclosed CJK Letters and Months"](Sr)||S_["Halfwidth and Fullwidth Forms"](Sr)||S_.Hiragana(Sr)||S_["Ideographic Description Characters"](Sr)||S_["Kangxi Radicals"](Sr)||S_["Katakana Phonetic Extensions"](Sr)||S_.Katakana(Sr)||S_["Vertical Forms"](Sr)||S_["Yi Radicals"](Sr)||S_["Yi Syllables"](Sr)));(Kb[Qr]||ut||Lr.imageName)&&It.push(uy(pt+1,Xt,Lt,It,ly(Qr,Ye.getCodePoint(pt+1),ut&&$t),!1))}}var Sr;return cy(uy(Ye.length(),Xt,Lt,It,0,!0))}(vn,Xt,St,ut,wt,fn),{processBidirectionalText:Xn,processStyledBidirectionalText:Jn}=k_;if(Xn&&1===vn.sections.length){const Ye=Xn(vn.toString(),Wn);for(const ut of Ye){const Ye=new ry;Ye.text=ut,Ye.sections=vn.sections;for(let pt=0;pt<ut.length;pt++)Ye.sectionIndex.push(0);kn.push(Ye)}}else if(Jn){const Ye=Jn(vn.text,vn.sectionIndex,Wn);for(const ut of Ye){const Ye=new ry;Ye.text=ut[0],Ye.sectionIndex=ut[1],Ye.sections=vn.sections,kn.push(Ye)}}else kn=function(Ye,ut){const pt=[],wt=Ye.text;let Tt=0;for(const wt of ut)pt.push(Ye.substring(Tt,wt)),Tt=wt;return Tt<wt.length&&pt.push(Ye.substring(Tt,wt.length)),pt}(vn,Wn);const Qn=[],ko={positionedLines:Qn,text:vn.toString(),top:Sr[1],bottom:Sr[1],left:Sr[0],right:Sr[0],writingMode:Lr,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr){let Qr=0,fn=0,xn=0;const vn="right"===Lt?1:"left"===Lt?0:.5;let kn=!1;for(const Ye of Tt){const pt=Ye.getSections();for(const Ye of pt){if(Ye.imageName)continue;const pt=ut[Ye.fontStack];if(pt&&(kn=void 0!==pt.ascender&&void 0!==pt.descender,!kn))break}if(!kn)break}let Wn=0;for(const It of Tt){It.trim();const Tt=It.getMaxScale(),Lt=(Tt-1)*Fb,Jn={positionedGlyphs:[],lineOffset:0};Ye.positionedLines[Wn]=Jn;const Qn=Jn.positionedGlyphs;let ko=0;if(!It.length()){fn+=St,++Wn;continue}let Fo=0,is=0;for(let St=0;St<It.length();St++){const Lt=It.getSection(St),xn=It.getSectionIndex(St),vn=It.getCodePoint(St);let Wn=Lt.scale,Jn=null,ns=null,ss=null,as=Fb,ds=0;const ps=!($t===Wb.horizontal||!Sr&&!Bo(vn)||Sr&&(Hb[vn]||(Xn=vn,S_.Arabic(Xn)||S_["Arabic Supplement"](Xn)||S_["Arabic Extended-A"](Xn)||S_["Arabic Presentation Forms-A"](Xn)||S_["Arabic Presentation Forms-B"](Xn))));if(Lt.imageName){const ut=wt[Lt.imageName];if(!ut)continue;ss=Lt.imageName,Ye.iconsInText=Ye.iconsInText||!0,ns=ut.paddedRect;const pt=ut.displaySize;Wn=Wn*Fb/Lr,Jn={width:pt[0],height:pt[1],left:0,top:-Zb,advance:ps?pt[1]:pt[0],localGlyph:!1},ds=kn?-Jn.height*Wn:Tt*Fb-17-pt[1]*Wn,as=Jn.advance;const St=(ps?pt[0]:pt[1])*Wn-Fb*Tt;St>0&&St>ko&&(ko=St)}else{const Ye=pt[Lt.fontStack];if(!Ye)continue;Ye[vn]&&(ns=Ye[vn]);const wt=ut[Lt.fontStack];if(!wt)continue;const St=wt.glyphs[vn];if(!St)continue;if(Jn=St.metrics,as=8203!==vn?Fb:0,kn){const Ye=void 0!==wt.ascender?Math.abs(wt.ascender):0,ut=void 0!==wt.descender?Math.abs(wt.descender):0,pt=(Ye+ut)*Wn;Fo<pt&&(Fo=pt,is=(Ye-ut)/2*Wn),ds=-Ye*Wn}else ds=(Tt-Wn)*Fb-17}ps?(Ye.verticalizable=!0,Qn.push({glyph:vn,imageName:ss,x:Qr,y:fn+ds,vertical:ps,scale:Wn,localGlyph:Jn.localGlyph,fontStack:Lt.fontStack,sectionIndex:xn,metrics:Jn,rect:ns}),Qr+=as*Wn+Xt):(Qn.push({glyph:vn,imageName:ss,x:Qr,y:fn+ds,vertical:ps,scale:Wn,localGlyph:Jn.localGlyph,fontStack:Lt.fontStack,sectionIndex:xn,metrics:Jn,rect:ns}),Qr+=Jn.advance*Wn+Xt)}0!==Qn.length&&(xn=Math.max(Qr-Xt,xn),kn?py(Qn,vn,ko,is,St*Tt/2):py(Qn,vn,ko,0,St/2)),Qr=0;const ns=St*Tt+ko;Jn.lineOffset=Math.max(ko,Lt),fn+=ns,++Wn}var Xn;const Jn=fn,{horizontalAlign:Qn,verticalAlign:ko}=hy(It);(function(Ye,ut,pt,wt,Tt,St){const It=(ut-pt)*Tt,Lt=-St*wt;for(const ut of Ye)for(const Ye of ut.positionedGlyphs)Ye.x+=It,Ye.y+=Lt})(Ye.positionedLines,vn,Qn,ko,xn,Jn),Ye.top+=-ko*Jn,Ye.bottom=Ye.top+Jn,Ye.left+=-Qn*xn,Ye.right=Ye.left+xn,Ye.hasBaseline=kn}(ko,ut,pt,wt,kn,It,Lt,$t,Lr,Xt,Qr,xn),!function(Ye){for(const ut of Ye)if(0!==ut.positionedGlyphs.length)return!1;return!0}(Qn)&&ko}const Hb={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Kb={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function ay(Ye,ut,pt,wt,Tt,St){if(ut.imageName){const Ye=wt[ut.imageName];return Ye?Ye.displaySize[0]*ut.scale*Fb/St+Tt:0}{const wt=pt[ut.fontStack],St=wt&&wt.glyphs[Ye];return St?St.metrics.advance*ut.scale+Tt:0}}function oy(Ye,ut,pt,wt){const Tt=Math.pow(Ye-ut,2);return wt?Ye<ut?Tt/2:2*Tt:Tt+Math.abs(pt)*pt}function ly(Ye,ut,pt){let wt=0;return 10===Ye&&(wt-=1e4),pt&&(wt+=150),40!==Ye&&65288!==Ye||(wt+=50),41!==ut&&65289!==ut||(wt+=50),wt}function uy(Ye,ut,pt,wt,Tt,St){let It=null,Lt=oy(ut,pt,Tt,St);for(const Ye of wt){const wt=oy(ut-Ye.x,pt,Tt,St)+Ye.badness;wt<=Lt&&(It=Ye,Lt=wt)}return{index:Ye,x:ut,priorBreak:It,badness:Lt}}function cy(Ye){return Ye?cy(Ye.priorBreak).concat(Ye.index):[]}function hy(Ye){let ut=.5,pt=.5;switch(Ye){case"right":case"top-right":case"bottom-right":ut=1;break;case"left":case"top-left":case"bottom-left":ut=0}switch(Ye){case"bottom":case"bottom-right":case"bottom-left":pt=1;break;case"top":case"top-right":case"top-left":pt=0}return{horizontalAlign:ut,verticalAlign:pt}}function py(Ye,ut,pt,wt,Tt){if(!(ut||pt||wt||Tt))return;const St=Ye.length-1,It=Ye[St],Lt=(It.x+It.metrics.advance*It.scale)*ut;for(let ut=0;ut<=St;ut++)Ye[ut].x-=Lt,Ye[ut].y+=pt+wt+Tt}function fy(Ye,ut,pt,wt){const{horizontalAlign:Tt,verticalAlign:St}=hy(wt),It=pt[0]-Ye.displaySize[0]*Tt,Lt=pt[1]-Ye.displaySize[1]*St;return{imagePrimary:Ye,imageSecondary:ut,top:Lt,bottom:Lt+Ye.displaySize[1],left:It,right:It+Ye.displaySize[0]}}function dy(Ye,ut,pt,wt,Tt,St){const It=Ye.imagePrimary;let Lt;if(It.content){const Ye=It.content,ut=It.pixelRatio||1;Lt=[Ye[0]/ut,Ye[1]/ut,It.displaySize[0]-Ye[2]/ut,It.displaySize[1]-Ye[3]/ut]}const $t=ut.left*St,Xt=ut.right*St;let Sr,Lr,Qr,fn;"width"===pt||"both"===pt?(fn=Tt[0]+$t-wt[3],Lr=Tt[0]+Xt+wt[1]):(fn=Tt[0]+($t+Xt-It.displaySize[0])/2,Lr=fn+It.displaySize[0]);const xn=ut.top*St,vn=ut.bottom*St;return"height"===pt||"both"===pt?(Sr=Tt[1]+xn-wt[0],Qr=Tt[1]+vn+wt[2]):(Sr=Tt[1]+(xn+vn-It.displaySize[1])/2,Qr=Sr+It.displaySize[1]),{imagePrimary:It,imageSecondary:void 0,top:Sr,right:Lr,bottom:Qr,left:fn,collisionPadding:Lt}}class my extends wu{constructor(Ye,ut,pt,wt,Tt){super(Ye,ut),this.angle=wt,this.z=pt,void 0!==Tt&&(this.segment=Tt)}clone(){return new my(this.x,this.y,this.z,this.angle,this.segment)}}function yy(Ye,ut,pt,wt,Tt){if(void 0===ut.segment)return!0;let St=ut,It=ut.segment+1,Lt=0;for(;Lt>-pt/2;){if(It--,It<0)return!1;Lt-=Ye[It].dist(St),St=Ye[It]}Lt+=Ye[It].dist(Ye[It+1]),It++;const $t=[];let Xt=0;for(;Lt<pt/2;){const ut=Ye[It],pt=Ye[It+1];if(!pt)return!1;let St=Ye[It-1].angleTo(ut)-ut.angleTo(pt);for(St=Math.abs((St+3*Math.PI)%(2*Math.PI)-Math.PI),$t.push({distance:Lt,angleDelta:St}),Xt+=St;Lt-$t[0].distance>wt;)Xt-=$t.shift().angleDelta;if(Xt>Tt)return!1;It++,Lt+=ut.dist(pt)}return!0}function gy(Ye){let ut=0;for(let pt=0;pt<Ye.length-1;pt++)ut+=Ye[pt].dist(Ye[pt+1]);return ut}function xy(Ye,ut,pt){return Ye?.6*ut*pt:0}function by(Ye,ut){return Math.max(Ye?Ye.right-Ye.left:0,ut?ut.right-ut.left:0)}function vy(Ye,ut,pt,wt,Tt,St){const It=xy(pt,Tt,St),Lt=by(pt,wt)*St;let $t=0;const Xt=gy(Ye)/2;for(let pt=0;pt<Ye.length-1;pt++){const wt=Ye[pt],Tt=Ye[pt+1],St=wt.dist(Tt);if($t+St>Xt){const Sr=(Xt-$t)/St,Lr=Gn(wt.x,Tt.x,Sr),Qr=Gn(wt.y,Tt.y,Sr),fn=new my(Lr,Qr,0,Tt.angleTo(wt),pt);return!It||yy(Ye,fn,Lt,It,ut)?fn:void 0}$t+=St}}function _y(Ye,ut,pt,wt,Tt,St,It,Lt,$t){const Xt=xy(wt,St,It),Sr=by(wt,Tt),Lr=Sr*It,Qr=0===Ye[0].x||Ye[0].x===$t||0===Ye[0].y||Ye[0].y===$t;return ut-Lr<ut/4&&(ut=Lr+ut/4),wy(Ye,Qr?ut/2*Lt%ut:(Sr/2+2*St)*It*Lt%ut,ut,Xt,pt,Lr,Qr,!1,$t)}function wy(Ye,ut,pt,wt,Tt,St,It,Lt,$t){const Xt=St/2,Sr=gy(Ye);let Lr=0,Qr=ut-pt,fn=[];for(let ut=0;ut<Ye.length-1;ut++){const It=Ye[ut],Lt=Ye[ut+1],xn=It.dist(Lt),vn=Lt.angleTo(It);for(;Qr+pt<Lr+xn;){Qr+=pt;const kn=(Qr-Lr)/xn,Wn=Gn(It.x,Lt.x,kn),Xn=Gn(It.y,Lt.y,kn);if(Wn>=0&&Wn<$t&&Xn>=0&&Xn<$t&&Qr-Xt>=0&&Qr+Xt<=Sr){const pt=new my(Wn,Xn,0,vn,ut);wt&&!yy(Ye,pt,St,wt,Tt)||fn.push(pt)}}Lr+=xn}return Lt||fn.length||It||(fn=wy(Ye,Lr/2,pt,wt,Tt,St,It,!0,$t)),fn}function My(Ye,ut,pt,wt,Tt){const St=[];for(let It=0;It<Ye.length;It++){const Lt=Ye[It];let $t;for(let Ye=0;Ye<Lt.length-1;Ye++){let It=Lt[Ye],Xt=Lt[Ye+1];It.x<ut&&Xt.x<ut||(It.x<ut?It=new wu(ut,It.y+(ut-It.x)/(Xt.x-It.x)*(Xt.y-It.y))._round():Xt.x<ut&&(Xt=new wu(ut,It.y+(ut-It.x)/(Xt.x-It.x)*(Xt.y-It.y))._round()),It.y<pt&&Xt.y<pt||(It.y<pt?It=new wu(It.x+(pt-It.y)/(Xt.y-It.y)*(Xt.x-It.x),pt)._round():Xt.y<pt&&(Xt=new wu(It.x+(pt-It.y)/(Xt.y-It.y)*(Xt.x-It.x),pt)._round()),It.x>=wt&&Xt.x>=wt||(It.x>=wt?It=new wu(wt,It.y+(wt-It.x)/(Xt.x-It.x)*(Xt.y-It.y))._round():Xt.x>=wt&&(Xt=new wu(wt,It.y+(wt-It.x)/(Xt.x-It.x)*(Xt.y-It.y))._round()),It.y>=Tt&&Xt.y>=Tt||(It.y>=Tt?It=new wu(It.x+(Tt-It.y)/(Xt.y-It.y)*(Xt.x-It.x),Tt)._round():Xt.y>=Tt&&(Xt=new wu(It.x+(Tt-It.y)/(Xt.y-It.y)*(Xt.x-It.x),Tt)._round()),$t&&It.equals($t[$t.length-1])||($t=[It],St.push($t)),$t.push(Xt)))))}}return St}function Ay(Ye){let ut=0,pt=0;for(const wt of Ye)ut+=wt.w*wt.h,pt=Math.max(pt,wt.w);Ye.sort(((Ye,ut)=>ut.h-Ye.h));const wt=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(ut/.95)),pt),h:1/0}];let Tt=0,St=0;for(const ut of Ye)for(let Ye=wt.length-1;Ye>=0;Ye--){const pt=wt[Ye];if(!(ut.w>pt.w||ut.h>pt.h)){if(ut.x=pt.x,ut.y=pt.y,St=Math.max(St,ut.y+ut.h),Tt=Math.max(Tt,ut.x+ut.w),ut.w===pt.w&&ut.h===pt.h){const ut=wt.pop();Ye<wt.length&&(wt[Ye]=ut)}else ut.h===pt.h?(pt.x+=ut.w,pt.w-=ut.w):ut.w===pt.w?(pt.y+=ut.h,pt.h-=ut.h):(wt.push({x:pt.x+ut.w,y:pt.y,w:pt.w-ut.w,h:ut.h}),pt.y+=ut.h,pt.h-=ut.h);break}}return{w:Tt,h:St,fill:ut/(Tt*St)||0}}Mo(my,"Anchor");const ew=1;class Iy{constructor(Ye,{pixelRatio:ut,version:pt,stretchX:wt,stretchY:Tt,content:St}){this.paddedRect=Ye,this.pixelRatio=ut,this.stretchX=wt,this.stretchY=Tt,this.content=St,this.version=pt}get tl(){return[this.paddedRect.x+ew,this.paddedRect.y+ew]}get br(){return[this.paddedRect.x+this.paddedRect.w-ew,this.paddedRect.y+this.paddedRect.h-ew]}get displaySize(){return[(this.paddedRect.w-2*ew)/this.pixelRatio,(this.paddedRect.h-2*ew)/this.pixelRatio]}}class Ty{constructor(Ye,ut,pt){const wt={},Tt={};this.haveRenderCallbacks=[];const St=[];this.addImages(Ye,wt,St),this.addImages(ut,Tt,St);const{w:It,h:Lt}=Ay(St),$t=new fp({width:It||1,height:Lt||1});for(const ut in Ye){const Tt=Ye[ut],St=wt[ut].paddedRect;fp.copy(Tt.data,$t,{x:0,y:0},{x:St.x+ew,y:St.y+ew},Tt.data,pt,Tt.sdf)}for(const Ye in ut){const wt=ut[Ye],St=Tt[Ye].paddedRect,It=St.x+ew,Lt=St.y+ew,Xt=wt.data.width,Sr=wt.data.height;fp.copy(wt.data,$t,{x:0,y:0},{x:It,y:Lt},wt.data,pt),fp.copy(wt.data,$t,{x:0,y:Sr-1},{x:It,y:Lt-1},{width:Xt,height:1},pt),fp.copy(wt.data,$t,{x:0,y:0},{x:It,y:Lt+Sr},{width:Xt,height:1},pt),fp.copy(wt.data,$t,{x:Xt-1,y:0},{x:It-1,y:Lt},{width:1,height:Sr},pt),fp.copy(wt.data,$t,{x:0,y:0},{x:It+Xt,y:Lt},{width:1,height:Sr},pt)}this.image=$t,this.iconPositions=wt,this.patternPositions=Tt}addImages(Ye,ut,pt){for(const wt in Ye){const Tt=Ye[wt],St={x:0,y:0,w:Tt.data.width+2*ew,h:Tt.data.height+2*ew};pt.push(St),ut[wt]=new Iy(St,Tt),Tt.hasRenderCallback&&this.haveRenderCallbacks.push(wt)}}patchUpdatedImages(Ye,ut,pt){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((ut=>Ye.hasImage(ut,pt))),Ye.dispatchRenderCallbacks(this.haveRenderCallbacks,pt);for(const wt in Ye.getUpdatedImages(pt))this.patchUpdatedImage(this.iconPositions[wt],Ye.getImage(wt,pt),ut),this.patchUpdatedImage(this.patternPositions[wt],Ye.getImage(wt,pt),ut)}patchUpdatedImage(Ye,ut,pt){if(!Ye||!ut)return;if(Ye.version===ut.version)return;Ye.version=ut.version;const[wt,Tt]=Ye.tl,St=!!Object.keys(this.patternPositions).length;pt.update(ut.data,{useMipmap:St},{x:wt,y:Tt})}}Mo(Iy,"ImagePosition"),Mo(Ty,"ImageAtlas");const tw=1e20;function Py(Ye,ut,pt,wt,Tt,St,It,Lt,$t){for(let Xt=ut;Xt<ut+wt;Xt++)zy(Ye,pt*St+Xt,St,Tt,It,Lt,$t);for(let Xt=pt;Xt<pt+Tt;Xt++)zy(Ye,Xt*St+ut,1,wt,It,Lt,$t)}function zy(Ye,ut,pt,wt,Tt,St,It){St[0]=0,It[0]=-tw,It[1]=tw,Tt[0]=Ye[ut];for(let Lt=1,$t=0,Xt=0;Lt<wt;Lt++){Tt[Lt]=Ye[ut+Lt*pt];const wt=Lt*Lt;do{const Ye=St[$t];Xt=(Tt[Lt]-Tt[Ye]+wt-Ye*Ye)/(Lt-Ye)/2}while(Xt<=It[$t]&&--$t>-1);$t++,St[$t]=Lt,It[$t]=Xt,It[$t+1]=tw}for(let Lt=0,$t=0;Lt<wt;Lt++){for(;It[$t+1]<Lt;)$t++;const wt=St[$t],Xt=Lt-wt;Ye[ut+Lt*pt]=Tt[wt]+Xt*Xt}}const iw=2,rw={none:0,ideographs:1,all:2};class Dy{constructor(Ye,ut,pt){this.requestManager=Ye,this.localGlyphMode=ut,this.localFontFamily=pt,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(Ye,ut){this.urls[ut]=Ye}getGlyphs(Ye,ut,pt){const wt=[],Tt=this.urls[ut]||St.GLYPHS_URL;for(const ut in Ye)for(const pt of Ye[ut])wt.push({stack:ut,id:pt});Qe(wt,(({stack:Ye,id:ut},pt)=>{let wt=this.entries[Ye];wt||(wt=this.entries[Ye]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let St=wt.glyphs[ut];if(void 0!==St)return void pt(null,{stack:Ye,id:ut,glyph:St});if(St=this._tinySDF(wt,Ye,ut),St)return wt.glyphs[ut]=St,void pt(null,{stack:Ye,id:ut,glyph:St});const It=Math.floor(ut/256);if(256*It>65535)return void pt(new Error("glyphs > 65535 not supported"));if(wt.ranges[It])return void pt(null,{stack:Ye,id:ut,glyph:St});let Lt=wt.requests[It];Lt||(Lt=wt.requests[It]=[],Dy.loadGlyphRange(Ye,It,Tt,this.requestManager,((Ye,ut)=>{if(ut){wt.ascender=ut.ascender,wt.descender=ut.descender;for(const Ye in ut.glyphs)this._doesCharSupportLocalGlyph(+Ye)||(wt.glyphs[+Ye]=ut.glyphs[+Ye]);wt.ranges[It]=!0}for(const pt of Lt)pt(Ye,ut);delete wt.requests[It]}))),Lt.push(((wt,Tt)=>{wt?pt(wt):Tt&&pt(null,{stack:Ye,id:ut,glyph:Tt.glyphs[ut]||null})}))}),((Ye,ut)=>{if(Ye)pt(Ye);else if(ut){const Ye={};for(const{stack:pt,id:wt,glyph:Tt}of ut)void 0===Ye[pt]&&(Ye[pt]={}),void 0===Ye[pt].glyphs&&(Ye[pt].glyphs={}),Ye[pt].glyphs[wt]=Tt&&{id:Tt.id,bitmap:Tt.bitmap.clone(),metrics:Tt.metrics},Ye[pt].ascender=this.entries[pt].ascender,Ye[pt].descender=this.entries[pt].descender;pt(null,Ye)}}))}_doesCharSupportLocalGlyph(Ye){return this.localGlyphMode!==rw.none&&(this.localGlyphMode===rw.all?!!this.localFontFamily:!!this.localFontFamily&&(S_["CJK Unified Ideographs"](Ye)||S_["Hangul Syllables"](Ye)||S_.Hiragana(Ye)||S_.Katakana(Ye)||S_["CJK Symbols and Punctuation"](Ye)||S_["CJK Unified Ideographs Extension A"](Ye)||S_["CJK Unified Ideographs Extension B"](Ye)))}_tinySDF(Ye,ut,pt){const wt=this.localFontFamily;if(!wt||!this._doesCharSupportLocalGlyph(pt))return;let Tt=Ye.tinySDF;if(!Tt){let pt="400";/bold/i.test(ut)?pt="900":/medium/i.test(ut)?pt="500":/light/i.test(ut)&&(pt="200"),Tt=Ye.tinySDF=new Dy.TinySDF({fontFamily:wt,fontWeight:pt,fontSize:24*iw,buffer:3*iw,radius:8*iw}),Tt.fontWeight=pt}if(this.localGlyphs[Tt.fontWeight][pt])return this.localGlyphs[Tt.fontWeight][pt];const St=String.fromCodePoint(pt),{data:It,width:Lt,height:$t,glyphWidth:Xt,glyphHeight:Sr,glyphLeft:Lr,glyphTop:Qr,glyphAdvance:fn}=Tt.draw(St);return this.localGlyphs[Tt.fontWeight][pt]={id:pt,bitmap:new pp({width:Lt,height:$t},It),metrics:{width:Xt/iw,height:Sr/iw,left:Lr/iw,top:Qr/iw-27,advance:fn/iw,localGlyph:!0}}}}Dy.loadGlyphRange=function(Ye,ut,pt,wt,Tt){const St=256*ut,It=St+255,Lt=wt.transformRequest(wt.normalizeGlyphsURL(pt).replace("{fontstack}",Ye).replace("{range}",`${St}-${It}`),jd.Glyphs);en(Lt,((Ye,ut)=>{if(Ye)Tt(Ye);else if(ut){const Ye={},pt=function(Ye){return new Lb(Ye).readFields(Km,{})}(ut);for(const ut of pt.glyphs)Ye[ut.id]=ut;Tt(null,{glyphs:Ye,ascender:pt.ascender,descender:pt.descender})}}))},Dy.TinySDF=class{constructor({fontSize:Ye=24,buffer:ut=3,radius:pt=8,cutoff:wt=.25,fontFamily:Tt="sans-serif",fontWeight:St="normal",fontStyle:It="normal"}={}){this.buffer=ut,this.cutoff=wt,this.radius=pt;const Lt=this.size=Ye+4*ut,$t=this._createCanvas(Lt),Xt=this.ctx=$t.getContext("2d",{willReadFrequently:!0});Xt.font=`${It} ${St} ${Ye}px ${Tt}`,Xt.textBaseline="alphabetic",Xt.textAlign="left",Xt.fillStyle="black",this.gridOuter=new Float64Array(Lt*Lt),this.gridInner=new Float64Array(Lt*Lt),this.f=new Float64Array(Lt),this.z=new Float64Array(Lt+1),this.v=new Uint16Array(Lt)}_createCanvas(Ye){const ut=document.createElement("canvas");return ut.width=ut.height=Ye,ut}draw(Ye){const{width:ut,actualBoundingBoxAscent:pt,actualBoundingBoxDescent:wt,actualBoundingBoxLeft:Tt,actualBoundingBoxRight:St}=this.ctx.measureText(Ye),It=Math.ceil(pt),Lt=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(St-Tt))),$t=Math.min(this.size-this.buffer,It+Math.ceil(wt)),Xt=Lt+2*this.buffer,Sr=$t+2*this.buffer,Lr=Math.max(Xt*Sr,0),Qr=new Uint8ClampedArray(Lr),fn={data:Qr,width:Xt,height:Sr,glyphWidth:Lt,glyphHeight:$t,glyphTop:It,glyphLeft:0,glyphAdvance:ut};if(0===Lt||0===$t)return fn;const{ctx:xn,buffer:vn,gridInner:kn,gridOuter:Wn}=this;xn.clearRect(vn,vn,Lt,$t),xn.fillText(Ye,vn,vn+It);const Xn=xn.getImageData(vn,vn,Lt,$t);Wn.fill(tw,0,Lr),kn.fill(0,0,Lr);for(let Ye=0;Ye<$t;Ye++)for(let ut=0;ut<Lt;ut++){const pt=Xn.data[4*(Ye*Lt+ut)+3]/255;if(0===pt)continue;const wt=(Ye+vn)*Xt+ut+vn;if(1===pt)Wn[wt]=0,kn[wt]=tw;else{const Ye=.5-pt;Wn[wt]=Ye>0?Ye*Ye:0,kn[wt]=Ye<0?Ye*Ye:0}}Py(Wn,0,0,Xt,Sr,Xt,this.f,this.v,this.z),Py(kn,vn,vn,Lt,$t,Xt,this.f,this.v,this.z);for(let Ye=0;Ye<Lr;Ye++){const ut=Math.sqrt(Wn[Ye])-Math.sqrt(kn[Ye]);Qr[Ye]=Math.round(255-255*(ut/this.radius+this.cutoff))}return fn}};const nw=ew;function Ry(Ye,ut,pt,wt){const Tt=[],St=Ye.imagePrimary,It=St.pixelRatio,Lt=St.paddedRect.w-2*nw,$t=St.paddedRect.h-2*nw,Xt=Ye.right-Ye.left,Sr=Ye.bottom-Ye.top,Lr=St.stretchX||[[0,Lt]],Qr=St.stretchY||[[0,$t]],f=(Ye,ut)=>Ye+ut[1]-ut[0],fn=Lr.reduce(f,0),xn=Qr.reduce(f,0),vn=Lt-fn,kn=$t-xn;let Wn=0,Xn=fn,Jn=0,Qn=xn,ko=0,Fo=vn,is=0,ns=kn;if(St.content&&wt){const Ye=St.content;Wn=Vy(Lr,0,Ye[0]),Jn=Vy(Qr,0,Ye[1]),Xn=Vy(Lr,Ye[0],Ye[2]),Qn=Vy(Qr,Ye[1],Ye[3]),ko=Ye[0]-Wn,is=Ye[1]-Jn,Fo=Ye[2]-Ye[0]-Xn,ns=Ye[3]-Ye[1]-Qn}const I=(wt,Tt,Lt,$t)=>{const Lr=Oy(wt.stretch-Wn,Xn,Xt,Ye.left),Qr=Fy(wt.fixed-ko,Fo,wt.stretch,fn),vn=Oy(Tt.stretch-Jn,Qn,Sr,Ye.top),kn=Fy(Tt.fixed-is,ns,Tt.stretch,xn),ss=Oy(Lt.stretch-Wn,Xn,Xt,Ye.left),as=Fy(Lt.fixed-ko,Fo,Lt.stretch,fn),ds=Oy($t.stretch-Jn,Qn,Sr,Ye.top),ps=Fy($t.fixed-is,ns,$t.stretch,xn),ms=new wu(Lr,vn),Js=new wu(ss,vn),ua=new wu(ss,ds),ba=new wu(Lr,ds),Ra=new wu(Qr/It,kn/It),La=new wu(as/It,ps/It),ll=ut*Math.PI/180;if(ll){const Ye=Math.sin(ll),ut=Math.cos(ll),pt=[ut,-Ye,Ye,ut];ms._matMult(pt),Js._matMult(pt),ba._matMult(pt),ua._matMult(pt)}const yl=wt.stretch+wt.fixed,Tl=Lt.stretch+Lt.fixed,Al=Tt.stretch+Tt.fixed,Il=$t.stretch+$t.fixed,Pl=Ye.imageSecondary;return{tl:ms,tr:Js,bl:ba,br:ua,texPrimary:{x:St.paddedRect.x+nw+yl,y:St.paddedRect.y+nw+Al,w:Tl-yl,h:Il-Al},texSecondary:Pl?{x:Pl.paddedRect.x+nw+yl,y:Pl.paddedRect.y+nw+Al,w:Tl-yl,h:Il-Al}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Ra,pixelOffsetBR:La,minFontScaleX:Fo/It/Xt,minFontScaleY:ns/It/Sr,isSDF:pt}};if(wt&&(St.stretchX||St.stretchY)){const Ye=Ly(Lr,vn,fn),ut=Ly(Qr,kn,xn);for(let pt=0;pt<Ye.length-1;pt++){const wt=Ye[pt],St=Ye[pt+1];for(let Ye=0;Ye<ut.length-1;Ye++)Tt.push(I(wt,ut[Ye],St,ut[Ye+1]))}}else Tt.push(I({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:Lt+1},{fixed:0,stretch:$t+1}));return Tt}function Vy(Ye,ut,pt){let wt=0;for(const Tt of Ye)wt+=Math.max(ut,Math.min(pt,Tt[1]))-Math.max(ut,Math.min(pt,Tt[0]));return wt}function Ly(Ye,ut,pt){const wt=[{fixed:-nw,stretch:0}];for(const[ut,pt]of Ye){const Ye=wt[wt.length-1];wt.push({fixed:ut-Ye.stretch,stretch:Ye.stretch}),wt.push({fixed:ut-Ye.stretch,stretch:Ye.stretch+(pt-ut)})}return wt.push({fixed:ut+nw,stretch:pt}),wt}function Oy(Ye,ut,pt,wt){return Ye/ut*pt+wt}function Fy(Ye,ut,pt,wt){return Ye-ut*pt/wt}function Uy(Ye,ut,pt,wt){const Tt=ut+Ye.positionedLines[wt].lineOffset;return 0===wt?pt+Tt/2:pt+(Tt+(ut+Ye.positionedLines[wt-1].lineOffset))/2}function Ny(Ye,ut=1,pt=!1){let wt=1/0,Tt=1/0,St=-1/0,It=-1/0;const Lt=Ye[0];for(let Ye=0;Ye<Lt.length;Ye++){const ut=Lt[Ye];(!Ye||ut.x<wt)&&(wt=ut.x),(!Ye||ut.y<Tt)&&(Tt=ut.y),(!Ye||ut.x>St)&&(St=ut.x),(!Ye||ut.y>It)&&(It=ut.y)}const $t=Math.min(St-wt,It-Tt);let Xt=$t/2;const Sr=new hs([],jy);if(0===$t)return new wu(wt,Tt);for(let ut=wt;ut<St;ut+=$t)for(let pt=Tt;pt<It;pt+=$t)Sr.push(new qy(ut+Xt,pt+Xt,Xt,Ye));let Lr=function(Ye){let ut=0,pt=0,wt=0;const Tt=Ye[0];for(let Ye=0,St=Tt.length,It=St-1;Ye<St;It=Ye++){const St=Tt[Ye],Lt=Tt[It],$t=St.x*Lt.y-Lt.x*St.y;pt+=(St.x+Lt.x)*$t,wt+=(St.y+Lt.y)*$t,ut+=3*$t}return new qy(pt/ut,wt/ut,0,Ye)}(Ye),Qr=Sr.length;for(;Sr.length;){const wt=Sr.pop();(wt.d>Lr.d||!Lr.d)&&(Lr=wt,pt&&console.log("found best %d after %d probes",Math.round(1e4*wt.d)/1e4,Qr)),wt.max-Lr.d<=ut||(Xt=wt.h/2,Sr.push(new qy(wt.p.x-Xt,wt.p.y-Xt,Xt,Ye)),Sr.push(new qy(wt.p.x+Xt,wt.p.y-Xt,Xt,Ye)),Sr.push(new qy(wt.p.x-Xt,wt.p.y+Xt,Xt,Ye)),Sr.push(new qy(wt.p.x+Xt,wt.p.y+Xt,Xt,Ye)),Qr+=4)}return pt&&(console.log(`num probes: ${Qr}`),console.log(`best distance: ${Lr.d}`)),Lr.p}function jy(Ye,ut){return ut.max-Ye.max}class qy{constructor(Ye,ut,pt,wt){this.p=new wu(Ye,ut),this.h=pt,this.d=function(Ye,ut){let pt=!1,wt=1/0;for(let Tt=0;Tt<ut.length;Tt++){const St=ut[Tt];for(let ut=0,Tt=St.length,It=Tt-1;ut<Tt;It=ut++){const Tt=St[ut],Lt=St[It];Tt.y>Ye.y!=Lt.y>Ye.y&&Ye.x<(Lt.x-Tt.x)*(Ye.y-Tt.y)/(Lt.y-Tt.y)+Tt.x&&(pt=!pt),wt=Math.min(wt,ih(Ye,Tt,Lt))}}return(pt?1:-1)*Math.sqrt(wt)}(this.p,wt),this.max=this.d+this.h*Math.SQRT2}}const ow=Number.POSITIVE_INFINITY,sw=Math.sqrt(2);function Yy(Ye,[ut,pt]){let wt=0,Tt=0;if(pt===ow){ut<0&&(ut=0);const pt=ut/sw;switch(Ye){case"top-right":case"top-left":Tt=pt-7;break;case"bottom-right":case"bottom-left":Tt=7-pt;break;case"bottom":Tt=7-ut;break;case"top":Tt=ut-7}switch(Ye){case"top-right":case"bottom-right":wt=-pt;break;case"top-left":case"bottom-left":wt=pt;break;case"left":wt=ut;break;case"right":wt=-ut}}else{switch(ut=Math.abs(ut),pt=Math.abs(pt),Ye){case"top-right":case"top-left":case"top":Tt=pt-7;break;case"bottom-right":case"bottom-left":case"bottom":Tt=7-pt}switch(Ye){case"top-right":case"bottom-right":case"right":wt=-ut;break;case"top-left":case"bottom-left":case"left":wt=ut}}return[wt,Tt]}function Xy(Ye){switch(Ye){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Zy(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn){let vn=St.textMaxSize.evaluate(ut,{},Lr);void 0===vn&&(vn=It);const kn=Ye.layers[0].layout,Wn=kn.get("icon-offset").evaluate(ut,{},Lr),Xn=Jy(pt.horizontal)||pt.vertical,Jn="globe"===Qr.name,Qn=Fb,ko=It/Qn,Fo=Ye.tilePixelRatio*vn/Qn,is=(ua=Ye.overscaling,Ye.zoom>18&&ua>2&&(ua>>=1),Math.max(ym/(512*ua),1)*kn.get("symbol-spacing")),ns=kn.get("text-padding")*Ye.tilePixelRatio,ss=kn.get("icon-padding")*Ye.tilePixelRatio,as=$e(kn.get("text-max-angle")),ds="map"===kn.get("text-rotation-alignment")&&"point"!==kn.get("symbol-placement"),ps="map"===kn.get("icon-rotation-alignment")&&"point"!==kn.get("symbol-placement"),ms=kn.get("symbol-placement"),Js=is/2;var ua;const ba=kn.get("icon-text-fit").evaluate(ut,{},Lr),Ra=kn.get("icon-text-fit-padding").evaluate(ut,{},Lr),La="none"!==ba;let ll;!1===Ye.hasAnyIconTextFit&&La&&(Ye.hasAnyIconTextFit=!0),wt&&La&&(Ye.allowVerticalPlacement&&pt.vertical&&(ll=dy(wt,pt.vertical,ba,Ra,Wn,ko)),Xn&&(wt=dy(wt,Xn,ba,Ra,Wn,ko)));const V=(It,Lt,vn)=>{if(Lt.x<0||Lt.x>=ym||Lt.y<0||Lt.y>=ym)return;let kn=null;if(Jn){const{x:Ye,y:ut,z:pt}=Qr.projectTilePoint(Lt.x,Lt.y,vn);kn={anchor:new my(Ye,ut,pt,0,void 0),up:Qr.upVector(vn,Lt.x,Lt.y)}}!function(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn,ko,Fo,is,ns,ss,as){const ds=Ye.addToLineVertexArray(ut,wt);let ps,ms,Js,ua,ba,Ra,La,ll=0,yl=0,Tl=0,Al=0,Il=-1,Pl=-1;const ec={};let tc=sf("");const ic=pt?pt.anchor:ut,nc="none"!==$t.layout.get("icon-text-fit").evaluate(Qn,{},ns);let oc=0,sc=0;if(void 0===$t._unevaluatedLayout.getValue("text-radial-offset")?[oc,sc]=$t.layout.get("text-offset").evaluate(Qn,{},ns).map((Ye=>Ye*Fb)):(oc=$t.layout.get("text-radial-offset").evaluate(Qn,{},ns)*Fb,sc=ow),Ye.allowVerticalPlacement&&Tt.vertical){const Ye=Tt.vertical;if(xn)Ra=tg(Ye),Lt&&(La=tg(Lt));else{const pt=$t.layout.get("text-rotate").evaluate(Qn,{},ns)+90;Js=Qy(Xt,ic,ut,Sr,Lr,Qr,Ye,fn,pt,vn),Lt&&(ua=Qy(Xt,ic,ut,Sr,Lr,Qr,Lt,Wn,pt))}}if(St){const wt=$t.layout.get("icon-rotate").evaluate(Qn,{},ns),Tt=Ry(St,wt,Fo,nc),It=Lt?Ry(Lt,wt,Fo,nc):void 0;ms=Qy(Xt,ic,ut,Sr,Lr,Qr,St,Wn,wt),ll=4*Tt.length;const fn=Ye.iconSizeData;let xn=null;"source"===fn.kind?(xn=[Nb*$t.layout.get("icon-size").evaluate(Qn,{},ns)],xn[0]>lw&&fr(`${Ye.layerIds[0]}: Value for "icon-size" is >= ${aw}. Reduce your "icon-size".`)):"composite"===fn.kind&&(xn=[Nb*ko.compositeIconSizes[0].evaluate(Qn,{},ns),Nb*ko.compositeIconSizes[1].evaluate(Qn,{},ns)],(xn[0]>lw||xn[1]>lw)&&fr(`${Ye.layerIds[0]}: Value for "icon-size" is >= ${aw}. Reduce your "icon-size".`)),Ye.addSymbols(Ye.icon,Tt,xn,Jn,Xn,Qn,!1,pt,ut,ds.lineStartIndex,ds.lineLength,-1,is,ns,ss,as),Il=Ye.icon.placedSymbolArray.length-1,It&&(yl=4*It.length,Ye.addSymbols(Ye.icon,It,xn,Jn,Xn,Qn,Wb.vertical,pt,ut,ds.lineStartIndex,ds.lineLength,-1,is,ns,ss,as),Pl=Ye.icon.placedSymbolArray.length-1)}for(const wt in Tt.horizontal){const St=Tt.horizontal[wt];ps||(tc=sf(St.text),xn?ba=tg(St):ps=Qy(Xt,ic,ut,Sr,Lr,Qr,St,fn,$t.layout.get("text-rotate").evaluate(Qn,{},ns),vn));const Lt=1===St.positionedLines.length;if(Tl+=Wy(Ye,pt,ut,St,It,$t,xn,Qn,vn,ds,Tt.vertical?Wb.horizontal:Wb.horizontalOnly,Lt?Object.keys(Tt.horizontal):[wt],ec,Il,ko,is,ns,ss),Lt)break}Tt.vertical&&(Al+=Wy(Ye,pt,ut,Tt.vertical,It,$t,xn,Qn,vn,ds,Wb.vertical,["vertical"],ec,Pl,ko,is,ns,ss));let ac=-1;const Z=(Ye,ut)=>Ye?Math.max(Ye,ut):ut;ac=Z(ba,ac),ac=Z(Ra,ac),ac=Z(La,ac);const lc=ac>-1?1:0;Ye.glyphOffsetArray.length>=65535&&fr("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==Qn.sortKey&&Ye.addToSortKeyRanges(Ye.symbolInstances.length,Qn.sortKey),Ye.symbolInstances.emplaceBack(ut.x,ut.y,ic.x,ic.y,ic.z,ec.right>=0?ec.right:-1,ec.center>=0?ec.center:-1,ec.left>=0?ec.left:-1,ec.vertical>=0?ec.vertical:-1,Il,Pl,tc,void 0!==ps?ps:Ye.collisionBoxArray.length,void 0!==ps?ps+1:Ye.collisionBoxArray.length,void 0!==Js?Js:Ye.collisionBoxArray.length,void 0!==Js?Js+1:Ye.collisionBoxArray.length,void 0!==ms?ms:Ye.collisionBoxArray.length,void 0!==ms?ms+1:Ye.collisionBoxArray.length,ua||Ye.collisionBoxArray.length,ua?ua+1:Ye.collisionBoxArray.length,Sr,Tl,Al,ll,yl,lc,0,oc,sc,ac,0,1,1,nc?1:0)}(Ye,Lt,kn,It,pt,wt,Tt,ll,Ye.layers[0],Ye.collisionBoxArray,ut.index,ut.sourceLayerIndex,Ye.index,ns,ds,$t,0,ss,ps,Wn,ut,St,Xt,Sr,Lr,fn,xn)};if("line"===ms)for(const Tt of My(ut.geometry,0,0,ym,ym)){const ut=_y(Tt,is,as,pt.vertical||Xn,wt,Qn,Fo,Ye.overscaling,ym);for(const pt of ut)Xn&&eg(Ye,Xn.text,Js,pt)||V(Tt,pt,Lr)}else if("line-center"===ms){for(const Ye of ut.geometry)if(Ye.length>1){const ut=vy(Ye,as,pt.vertical||Xn,wt,Qn,Fo);ut&&V(Ye,ut,Lr)}}else if("Polygon"===ut.type)for(const Ye of Xp(ut.geometry,0)){const ut=Ny(Ye,16);V(Ye[0],new my(ut.x,ut.y,0,0,void 0),Lr)}else if("LineString"===ut.type)for(const Ye of ut.geometry)V(Ye,new my(Ye[0].x,Ye[0].y,0,0,void 0),Lr);else if("Point"===ut.type)for(const Ye of ut.geometry)for(const ut of Ye)V([ut],new my(ut.x,ut.y,0,0,void 0),Lr)}const aw=255,lw=aw*Nb;function Wy(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn){const Xn=function(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=[];if(0===ut.positionedLines.length)return $t;const Xt=wt.layout.get("text-rotate").evaluate(St,{})*Math.PI/180,Sr=function(Ye){const ut=Ye[0],pt=Ye[1],wt=ut*pt;return wt>0?[ut,-pt]:wt<0?[-ut,pt]:0===ut?[pt,ut]:[pt,-ut]}(pt);let Lr=Math.abs(ut.top-ut.bottom);for(const Ye of ut.positionedLines)Lr-=Ye.lineOffset;const Qr=ut.positionedLines.length,fn=Lr/Qr;let xn=ut.top-pt[1];for(let Ye=0;Ye<Qr;++Ye){const wt=ut.positionedLines[Ye];xn=Uy(ut,fn,xn,Ye);for(const Ye of wt.positionedGlyphs){if(!Ye.rect)continue;const wt=Ye.rect||{};let St=Zb+1,Lr=!0,Qr=1,fn=0;if(Ye.imageName){const ut=It[Ye.imageName];if(!ut)continue;if(ut.sdf){fr("SDF images are not supported in formatted text and will be ignored.");continue}Lr=!1,Qr=ut.pixelRatio,St=ew/Qr}const vn=(Tt||Lt)&&Ye.vertical,kn=Ye.metrics.advance*Ye.scale/2,Wn=Ye.metrics,Xn=Ye.rect;if(null===Xn)continue;Lt&&ut.verticalizable&&(fn=Ye.imageName?kn-Ye.metrics.width*Ye.scale/2:0);const Jn=Tt?[Ye.x+kn,Ye.y]:[0,0];let Qn=[0,0],ko=[0,0],Fo=!1;Tt||(vn?(ko=[Ye.x+kn+Sr[0],Ye.y+Sr[1]-fn],Fo=!0):Qn=[Ye.x+kn+pt[0],Ye.y+pt[1]-fn]);const is=Xn.w*Ye.scale/(Qr*(Ye.localGlyph?iw:1)),ns=Xn.h*Ye.scale/(Qr*(Ye.localGlyph?iw:1));let ss,as,ds,ps;if(vn){const ut=Ye.y-xn,pt=new wu(-kn,kn-ut),wt=-Math.PI/2,Tt=new wu(...ko);ss=new wu(-kn+Qn[0],Qn[1]),ss._rotateAround(wt,pt)._add(Tt),ss.x+=-ut+kn,ss.y-=(Wn.left-St)*Ye.scale;const It=Ye.imageName?Wn.advance*Ye.scale:Fb*Ye.scale,Lt=String.fromCodePoint(Ye.glyph);Xm(Lt)?ss.x+=(1-St)*Ye.scale:Zm(Lt)?ss.x+=It-Wn.height*Ye.scale+(-St-1)*Ye.scale:ss.x+=Ye.imageName||Wn.width+2*St===Xn.w&&Wn.height+2*St===Xn.h?(It-ns)/2:(It-(Wn.height+2*St)*Ye.scale)/2,as=new wu(ss.x,ss.y-is),ds=new wu(ss.x+ns,ss.y),ps=new wu(ss.x+ns,ss.y-is)}else{const ut=(Wn.left-St)*Ye.scale-kn+Qn[0],pt=(-Wn.top-St)*Ye.scale+Qn[1],wt=ut+is,Tt=pt+ns;ss=new wu(ut,pt),as=new wu(wt,pt),ds=new wu(ut,Tt),ps=new wu(wt,Tt)}if(Xt){let Ye;Ye=Tt?new wu(0,0):Fo?new wu(Sr[0],Sr[1]):new wu(pt[0],pt[1]),ss._rotateAround(Xt,Ye),as._rotateAround(Xt,Ye),ds._rotateAround(Xt,Ye),ps._rotateAround(Xt,Ye)}const ms=new wu(0,0),Js=new wu(0,0);$t.push({tl:ss,tr:as,bl:ds,br:ps,texPrimary:wt,texSecondary:void 0,writingMode:ut.writingMode,glyphOffset:Jn,sectionIndex:Ye.sectionIndex,isSDF:Lr,pixelOffsetTL:ms,pixelOffsetBR:Js,minFontScaleX:0,minFontScaleY:0})}}return $t}(0,wt,$t,St,It,Lt,Tt,Ye.allowVerticalPlacement),Jn=Ye.textSizeData;let Qn=null;"source"===Jn.kind?(Qn=[Nb*St.layout.get("text-size").evaluate(Lt,{},kn)],Qn[0]>lw&&fr(`${Ye.layerIds[0]}: Value for "text-size" is >= ${aw}. Reduce your "text-size".`)):"composite"===Jn.kind&&(Qn=[Nb*xn.compositeTextSizes[0].evaluate(Lt,{},kn),Nb*xn.compositeTextSizes[1].evaluate(Lt,{},kn)],(Qn[0]>lw||Qn[1]>lw)&&fr(`${Ye.layerIds[0]}: Value for "text-size" is >= ${aw}. Reduce your "text-size".`)),Ye.addSymbols(Ye.text,Xn,Qn,$t,It,Lt,Sr,ut,pt,Xt.lineStartIndex,Xt.lineLength,fn,vn,kn,Wn,!1);for(const ut of Lr)Qr[ut]=Ye.text.placedSymbolArray.length-1;return 4*Xn.length}function Jy(Ye){for(const ut in Ye)return Ye[ut];return null}function Qy(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt){let Sr=It.top,Lr=It.bottom,Qr=It.left,fn=It.right;const xn=It.collisionPadding;if(xn&&(Qr-=xn[0],Sr-=xn[1],fn+=xn[2],Lr+=xn[3]),$t){const Ye=new wu(Qr,Sr),ut=new wu(fn,Sr),pt=new wu(Qr,Lr),wt=new wu(fn,Lr),Tt=$e($t);let St=new wu(0,0);Xt&&(St=new wu(Xt[0],Xt[1])),Ye._rotateAround(Tt,St),ut._rotateAround(Tt,St),pt._rotateAround(Tt,St),wt._rotateAround(Tt,St),Qr=Math.min(Ye.x,ut.x,pt.x,wt.x),fn=Math.max(Ye.x,ut.x,pt.x,wt.x),Sr=Math.min(Ye.y,ut.y,pt.y,wt.y),Lr=Math.max(Ye.y,ut.y,pt.y,wt.y)}return Ye.emplaceBack(ut.x,ut.y,ut.z,pt.x,pt.y,Qr,Sr,fn,Lr,Lt,wt,Tt,St),Ye.length-1}function tg(Ye){Ye.collisionPadding&&(Ye.top-=Ye.collisionPadding[1],Ye.bottom+=Ye.collisionPadding[3]);const ut=Ye.bottom-Ye.top;return ut>0?Math.max(10,ut):null}function eg(Ye,ut,pt,wt){const Tt=Ye.compareText;if(ut in Tt){const Ye=Tt[ut];for(let ut=Ye.length-1;ut>=0;ut--)if(wt.dist(Ye[ut])<pt)return!0}else Tt[ut]=[];return Tt[ut].push(wt),!1}function rg(Ye,ut){const pt=Ye.fovAboveCenter,wt=Ye.elevation?Ye.elevation.getMinElevationBelowMSL()*ut:0,Tt=(Ye._camera.position[2]*Ye.worldSize-wt)/Math.cos(Ye._pitch),St=Math.sin(pt)*Tt/Math.sin(Math.max(Math.PI/2-Ye._pitch-pt,.01)),It=Math.sin(Ye._pitch)*St+Tt;return Math.min(1.01*It,Tt*(1/Ye._horizonShift))}function ng(Ye,ut){if(!ut.isReprojectedInTileSpace)return{scale:1<<Ye.z,x:Ye.x,y:Ye.y,x2:Ye.x+1,y2:Ye.y+1,projection:ut};const pt=Math.pow(2,-Ye.z),wt=Ye.x*pt,Tt=(Ye.x+1)*pt,St=Ye.y*pt,It=(Ye.y+1)*pt,Lt=zc(wt),$t=zc(Tt),Xt=Ec(St),Sr=Ec(It),Lr=ut.project(Lt,Xt),Qr=ut.project($t,Xt),fn=ut.project($t,Sr),xn=ut.project(Lt,Sr);let vn=Math.min(Lr.x,Qr.x,fn.x,xn.x),kn=Math.min(Lr.y,Qr.y,fn.y,xn.y),Wn=Math.max(Lr.x,Qr.x,fn.x,xn.x),Xn=Math.max(Lr.y,Qr.y,fn.y,xn.y);const Jn=pt/16;function v(Ye,pt,wt,Tt,St,It){const Lt=(wt+St)/2,$t=(Tt+It)/2,Xt=ut.project(zc(Lt),Ec($t)),Sr=Math.max(0,vn-Xt.x,kn-Xt.y,Xt.x-Wn,Xt.y-Xn);vn=Math.min(vn,Xt.x),Wn=Math.max(Wn,Xt.x),kn=Math.min(kn,Xt.y),Xn=Math.max(Xn,Xt.y),Sr>Jn&&(v(Ye,Xt,wt,Tt,Lt,$t),v(Xt,pt,Lt,$t,St,It))}v(Lr,Qr,wt,St,Tt,St),v(Qr,fn,Tt,St,Tt,It),v(fn,xn,Tt,It,wt,It),v(xn,Lr,wt,It,wt,St),vn-=Jn,kn-=Jn,Wn+=Jn,Xn+=Jn;const Qn=1/Math.max(Wn-vn,Xn-kn);return{scale:Qn,x:vn*Qn,y:kn*Qn,x2:Wn*Qn,y2:Xn*Qn,projection:ut}}function ig(Ye,{x:ut,y:pt},wt=0){return new wu(((ut-wt)*Ye.scale-Ye.x)*ym,(pt*Ye.scale-Ye.y)*ym)}const cw=Ye.ad.identity(new Float32Array(16));class ag{constructor(Ye){this.spec=Ye,this.name=Ye.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(Ye,ut){return{x:0,y:0,z:0}}unproject(Ye,ut){return new mc(0,0)}projectTilePoint(Ye,ut,pt){return{x:Ye,y:ut,z:0}}locationPoint(Ye,ut,pt=!0){return Ye._coordinatePoint(Ye.locationCoordinate(ut),pt)}pixelsPerMeter(Ye,ut){return Pc(1,Ye)*ut}pixelSpaceConversion(Ye,ut,pt){return 1}farthestPixelDistance(Ye){return rg(Ye,Ye.pixelsPerMeter)}pointCoordinate(Ye,ut,pt,wt){const Tt=Ye.horizonLineFromTop(!1),St=new wu(ut,Math.max(Tt,pt));return Ye.rayIntersectionCoordinate(Ye.pointRayIntersection(St,wt))}pointCoordinate3D(Ye,ut,pt){const wt=new wu(ut,pt);if(Ye.elevation)return Ye.elevation.pointCoordinate(wt);{const ut=this.pointCoordinate(Ye,wt.x,wt.y,0);return[ut.x,ut.y,ut.z]}}isPointAboveHorizon(Ye,ut){if(Ye.elevation&&Ye.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(Ye,ut.x,ut.y);const pt=Ye.horizonLineFromTop();return ut.y<pt}createInversionMatrix(Ye,ut){return cw}createTileMatrix(ut,pt,wt){let Tt,St,It;const Lt=wt.canonical,$t=Ye.ad.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const Xt=ng(Lt,this);Tt=1,St=Xt.x+wt.wrap*Xt.scale,It=Xt.y,Ye.ad.scale($t,$t,[Tt/Xt.scale,Tt/Xt.scale,ut.pixelsPerMeter/pt])}else Tt=pt/ut.zoomScale(Lt.z),St=(Lt.x+Math.pow(2,Lt.z)*wt.wrap)*Tt,It=Lt.y*Tt;return Ye.ad.translate($t,$t,[St,It,0]),Ye.ad.scale($t,$t,[Tt/ym,Tt/ym,1]),$t}upVector(Ye,ut,pt){return[0,0,1]}upVectorScale(Ye,ut,pt){return{metersToTile:1}}}class og extends ag{constructor(Ye){super(Ye),this.range=[4,7],this.center=Ye.center||[-96,37.5];const[ut,pt]=this.parallels=Ye.parallels||[29.5,45.5],wt=Math.sin($e(ut));this.n=(wt+Math.sin($e(pt)))/2,this.c=1+wt*(2*this.n-wt),this.r0=Math.sqrt(this.c)/this.n}project(Ye,ut){const{n:pt,c:wt,r0:Tt}=this,St=$e(Ye-this.center[0]),It=$e(ut),Lt=Math.sqrt(wt-2*pt*Math.sin(It))/pt;return{x:Lt*Math.sin(St*pt),y:Lt*Math.cos(St*pt)-Tt,z:0}}unproject(Ye,ut){const{n:pt,c:wt,r0:Tt}=this,St=Tt+ut;let It=Math.atan2(Ye,Math.abs(St))*Math.sign(St);St*pt<0&&(It-=Math.PI*Math.sign(Ye)*Math.sign(St));const Lt=$e(this.center[0])*pt;It=Je(It,-Math.PI-Lt,Math.PI-Lt);const $t=Ke(Ge(It/pt)+this.center[0],-180,180),Xt=Math.asin(Ke((wt-(Ye*Ye+St*St)*pt*pt)/(2*pt),-1,1)),Sr=Ke(Ge(Xt),-Bg,Bg);return new mc($t,Sr)}}const hw=1.340264,uw=-.081106,dw=893e-6,pw=.003796,fw=Math.sqrt(3)/2;class fg extends ag{project(Ye,ut){ut=ut/180*Math.PI,Ye=Ye/180*Math.PI;const pt=Math.asin(fw*Math.sin(ut)),wt=pt*pt,Tt=wt*wt*wt;return{x:.5*(Ye*Math.cos(pt)/(fw*(hw+3*uw*wt+Tt*(7*dw+9*pw*wt)))/Math.PI+.5),y:1-.5*(pt*(hw+uw*wt+Tt*(dw+pw*wt))/Math.PI+1),z:0}}unproject(Ye,ut){Ye=(2*Ye-.5)*Math.PI;let pt=ut=(2*(1-ut)-1)*Math.PI,wt=pt*pt,Tt=wt*wt*wt;for(let Ye,St,It,Lt=0;Lt<12&&(St=pt*(hw+uw*wt+Tt*(dw+pw*wt))-ut,It=hw+3*uw*wt+Tt*(7*dw+9*pw*wt),Ye=St/It,pt=Ke(pt-Ye,-Math.PI/3,Math.PI/3),wt=pt*pt,Tt=wt*wt*wt,!(Math.abs(Ye)<1e-12));++Lt);const St=fw*Ye*(hw+3*uw*wt+Tt*(7*dw+9*pw*wt))/Math.cos(pt),It=Math.asin(Math.sin(pt)/fw),Lt=Ke(180*St/Math.PI,-180,180),$t=Ke(180*It/Math.PI,-Bg,Bg);return new mc(Lt,$t)}}class dg extends ag{constructor(Ye){super(Ye),this.wrap=!0,this.supportsWorldCopies=!0}project(Ye,ut){return{x:.5+Ye/360,y:.5-ut/360,z:0}}unproject(Ye,ut){const pt=360*(Ye-.5),wt=Ke(360*(.5-ut),-Bg,Bg);return new mc(pt,wt)}}const mw=Math.PI/2;function yg(Ye){return Math.tan((mw+Ye)/2)}class gg extends ag{constructor(Ye){super(Ye),this.center=Ye.center||[0,30];const[ut,pt]=this.parallels=Ye.parallels||[30,30];let wt=$e(ut),Tt=$e(pt);this.southernCenter=wt+Tt<0,this.southernCenter&&(wt=-wt,Tt=-Tt);const St=Math.cos(wt),It=yg(wt);this.n=wt===Tt?Math.sin(wt):Math.log(St/Math.cos(Tt))/Math.log(yg(Tt)/It),this.f=St*Math.pow(yg(wt),this.n)/this.n}project(Ye,ut){ut=$e(ut),this.southernCenter&&(ut=-ut),Ye=$e(Ye-this.center[0]);const pt=1e-6,{n:wt,f:Tt}=this;Tt>0?ut<-mw+pt&&(ut=-mw+pt):ut>mw-pt&&(ut=mw-pt);const St=Tt/Math.pow(yg(ut),wt);let It=St*Math.sin(wt*Ye),Lt=Tt-St*Math.cos(wt*Ye);return It=.5*(It/Math.PI+.5),Lt=.5*(Lt/Math.PI+.5),{x:It,y:this.southernCenter?Lt:1-Lt,z:0}}unproject(Ye,ut){Ye=(2*Ye-.5)*Math.PI,this.southernCenter&&(ut=1-ut),ut=(2*(1-ut)-.5)*Math.PI;const{n:pt,f:wt}=this,Tt=wt-ut,St=Math.sign(Tt),It=Math.sign(pt)*Math.sqrt(Ye*Ye+Tt*Tt);let Lt=Math.atan2(Ye,Math.abs(Tt))*St;Tt*pt<0&&(Lt-=Math.PI*Math.sign(Ye)*St);const $t=Ke(Ge(Lt/pt)+this.center[0],-180,180),Xt=Ke(Ge(2*Math.atan(Math.pow(wt/It,1/pt))-mw),-Bg,Bg);return new mc($t,this.southernCenter?-Xt:Xt)}}class xg extends ag{constructor(Ye){super(Ye),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(Ye,ut){return{x:Tc(Ye),y:kc(ut),z:0}}unproject(Ye,ut){const pt=zc(Ye),wt=Ec(ut);return new mc(pt,wt)}}const _w=$e(Bg);class vg extends ag{project(Ye,ut){const pt=(ut=$e(ut))*ut,wt=pt*pt;return{x:.5*((Ye=$e(Ye))*(.8707-.131979*pt+wt*(wt*(.003971*pt-.001529*wt)-.013791))/Math.PI+.5),y:1-.5*(ut*(1.007226+pt*(.015085+wt*(.028874*pt-.044475-.005916*wt)))/Math.PI+1),z:0}}unproject(Ye,ut){Ye=(2*Ye-.5)*Math.PI;let pt=ut=(2*(1-ut)-1)*Math.PI,wt=25,Tt=0,St=pt*pt;do{St=pt*pt;const Ye=St*St;Tt=(pt*(1.007226+St*(.015085+Ye*(.028874*St-.044475-.005916*Ye)))-ut)/(1.007226+St*(.045255+Ye*(.259866*St-.311325-.005916*11*Ye))),pt=Ke(pt-Tt,-_w,_w)}while(Math.abs(Tt)>1e-6&&--wt>0);St=pt*pt;const It=Ke(Ge(Ye/(.8707+St*(St*(St*St*St*(.003971-.001529*St)-.013791)-.131979))),-180,180),Lt=Ge(pt);return new mc(It,Lt)}}const gw=$e(Bg);class wg extends ag{project(Ye,ut){ut=$e(ut),Ye=$e(Ye);const pt=Math.cos(ut),wt=2/Math.PI,Tt=Math.acos(pt*Math.cos(Ye/2)),St=Math.sin(Tt)/Tt,It=.5*(Ye*wt+2*pt*Math.sin(Ye/2)/St)||0,Lt=.5*(ut+Math.sin(ut)/St)||0;return{x:.5*(It/Math.PI+.5),y:1-.5*(Lt/Math.PI+1),z:0}}unproject(Ye,ut){let pt=Ye=(2*Ye-.5)*Math.PI,wt=ut=(2*(1-ut)-1)*Math.PI,Tt=25;const St=1e-6;let It=0,Lt=0;do{const Tt=Math.cos(wt),St=Math.sin(wt),$t=2*St*Tt,Xt=St*St,Sr=Tt*Tt,Lr=Math.cos(pt/2),Qr=Math.sin(pt/2),fn=2*Lr*Qr,xn=Qr*Qr,vn=1-Sr*Lr*Lr,kn=vn?1/vn:0,Wn=vn?Math.acos(Tt*Lr)*Math.sqrt(1/vn):0,Xn=.5*(2*Wn*Tt*Qr+2*pt/Math.PI)-Ye,Jn=.5*(Wn*St+wt)-ut,Qn=.5*kn*(Sr*xn+Wn*Tt*Lr*Xt)+1/Math.PI,ko=kn*(fn*$t/4-Wn*St*Qr),Fo=.125*kn*($t*Qr-Wn*St*Sr*fn),is=.5*kn*(Xt*Lr+Wn*xn*Tt)+.5,ns=ko*Fo-is*Qn;It=(Jn*ko-Xn*is)/ns,Lt=(Xn*Fo-Jn*Qn)/ns,pt=Ke(pt-It,-Math.PI,Math.PI),wt=Ke(wt-Lt,-gw,gw)}while((Math.abs(It)>St||Math.abs(Lt)>St)&&--Tt>0);return new mc(Ge(pt),Ge(wt))}}class Mg extends ag{constructor(Ye){super(Ye),this.center=Ye.center||[0,0],this.parallels=Ye.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos($e(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(Ye,ut){const{scale:pt,cosPhi:wt}=this;return{x:$e(Ye)*wt*pt+.5,y:-Math.sin($e(ut))/wt*pt+.5,z:0}}unproject(Ye,ut){const{scale:pt,cosPhi:wt}=this,Tt=-(ut-.5)/pt,St=Ke(Ge((Ye-.5)/pt)/wt,-180,180),It=Math.asin(Ke(Tt*wt,-1,1)),Lt=Ke(Ge(It),-Bg,Bg);return new mc(St,Lt)}}class Ag extends xg{constructor(Ye){super(Ye),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(ut,pt,wt){const Tt=Nh(ut,pt,wt),St=$h(Ch(wt));return Ye._.transformMat4(Tt,Tt,St),{x:Tt[0],y:Tt[1],z:Tt[2]}}locationPoint(ut,pt){const wt=pc(pt.lat,pt.lng),Tt=Ye._.normalize([],wt),St=ut.elevation?ut.elevation.getAtPointOrZero(ut.locationCoordinate(pt),ut._centerAltitude):ut._centerAltitude,It=Pc(1,0)*ym*St;Ye._.scaleAndAdd(wt,wt,Tt,It);const Lt=Ye.ad.identity(new Float64Array(16));return Ye.ad.multiply(Lt,ut.pixelMatrix,ut.globeMatrix),Ye._.transformMat4(wt,wt,Lt),new wu(wt[0],wt[1])}pixelsPerMeter(Ye,ut){return Pc(1,0)*ut}pixelSpaceConversion(Ye,ut,pt){const wt=Pc(1,Ye)*ut,Tt=Gn(Pc(1,45)*ut,wt,pt);return this.pixelsPerMeter(Ye,ut)/Tt}createTileMatrix(ut,pt,wt){const Tt=Gh(Ch(wt.canonical));return Ye.ad.multiply(new Float64Array(16),ut.globeMatrix,Tt)}createInversionMatrix(ut,pt){const{center:wt}=ut,Tt=$h(Ch(pt));return Ye.ad.rotateY(Tt,Tt,$e(wt.lng)),Ye.ad.rotateX(Tt,Tt,$e(wt.lat)),Ye.ad.scale(Tt,Tt,[ut._pixelsPerMercatorPixel,ut._pixelsPerMercatorPixel,1]),Float32Array.from(Tt)}pointCoordinate(Ye,ut,pt,wt){return Eh(Ye,ut,pt,!0)||new Oc(0,0)}pointCoordinate3D(Ye,ut,pt){const wt=this.pointCoordinate(Ye,ut,pt,0);return[wt.x,wt.y,wt.z]}isPointAboveHorizon(Ye,ut){return!Eh(Ye,ut.x,ut.y,!1)}farthestPixelDistance(ut){const pt=function(ut,pt){const wt=ut.cameraToCenterDistance,Tt=ut._centerAltitude*pt,St=ut._camera,It=ut._camera.forward(),Lt=Ye._.add([],Ye._.scale([],It,-wt),[0,0,Tt]),$t=ut.worldSize/(2*Math.PI),Xt=[0,0,-$t],Sr=ut.width/ut.height,Lr=Math.tan(ut.fovAboveCenter),Qr=Ye._.scale([],St.up(),Lr),fn=Ye._.scale([],St.right(),Lr*Sr),xn=Ye._.normalize([],Ye._.add([],Ye._.add([],It,Qr),fn)),vn=[];let kn;if(new gh(Lt,xn).closestPointOnSphere(Xt,$t,vn)){const pt=Ye._.add([],vn,Xt),wt=Ye._.sub([],pt,Lt);kn=Math.cos(ut.fovAboveCenter)*Ye._.length(wt)}else{const ut=Ye._.sub([],Lt,Xt),pt=Ye._.sub([],Xt,Lt);Ye._.normalize(pt,pt);const wt=Ye._.length(ut)-$t;kn=Math.sqrt(wt*(wt+2*$t));const Tt=Math.acos(kn/($t+wt))-Math.acos(Ye._.dot(It,pt));kn*=Math.cos(Tt)}return 1.01*kn}(ut,this.pixelsPerMeter(ut.center.lat,ut.worldSize)),wt=Hh(ut.zoom);if(wt>0){const Ye=rg(ut,Pc(1,ut.center.lat)*ut.worldSize),Tt=ut.worldSize/(2*Math.PI),St=Math.max(ut.width,ut.height)/ut.worldSize*Math.PI;return Gn(pt,Ye+Tt*(1-Math.cos(St)),Math.pow(wt,10))}return pt}upVector(Ye,ut,pt){return Nh(ut,pt,Ye,1)}upVectorScale(Ye){return{metersToTile:Ph(jh(Ch(Ye)))}}}function Sg(Ye){const ut=Ye.parallels,pt=!!ut&&Math.abs(ut[0]+ut[1])<.01;switch(Ye.name){case"mercator":return new xg(Ye);case"equirectangular":return new dg(Ye);case"naturalEarth":return new vg(Ye);case"equalEarth":return new fg(Ye);case"winkelTripel":return new wg(Ye);case"albers":return pt?new Mg(Ye):new og(Ye);case"lambertConformalConic":return pt?new Mg(Ye):new gg(Ye);case"globe":return new Ag(Ye)}throw new Error(`Invalid projection name: ${Ye.name}`)}class Ig{constructor(Ye,ut,pt,wt){this.id=Ig.uniqueIdxCounter,Ig.uniqueIdxCounter++,this.context=Ye;const Tt=Ye.gl;this.buffer=Tt.createBuffer(),this.dynamicDraw=Boolean(pt),this.context.unbindVAO(),Ye.bindElementBuffer.set(this.buffer),Tt.bufferData(Tt.ELEMENT_ARRAY_BUFFER,ut.arrayBuffer,this.dynamicDraw?Tt.DYNAMIC_DRAW:Tt.STATIC_DRAW),this.dynamicDraw||wt||ut.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(Ye){this.id=Ig.uniqueIdxCounter,Ig.uniqueIdxCounter++;const ut=this.context.gl;this.context.unbindVAO(),this.bind(),ut.bufferSubData(ut.ELEMENT_ARRAY_BUFFER,0,Ye.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Ig.uniqueIdxCounter=0;class Tg{constructor(Ye,ut,pt){this.func=Ye,this.mask=ut,this.range=pt}}Tg.ReadOnly=!1,Tg.ReadWrite=!0,Tg.disabled=new Tg(519,Tg.ReadOnly,[0,1]);const yw=7680;class Pg{constructor(Ye,ut,pt,wt,Tt,St){this.test=Ye,this.ref=ut,this.mask=pt,this.fail=wt,this.depthFail=Tt,this.pass=St}}Pg.disabled=new Pg({func:519,mask:0},0,0,yw,yw,yw);const xw=771;class Eg{constructor(Ye,ut,pt,wt){this.blendFunction=Ye,this.blendColor=ut,this.mask=pt,this.blendEquation=wt}}Eg.Replace=[1,0,1,0],Eg.disabled=new Eg(Eg.Replace,qn.transparent,[!1,!1,!1,!1]),Eg.unblended=new Eg(Eg.Replace,qn.transparent,[!0,!0,!0,!0]),Eg.alphaBlended=new Eg([1,xw,1,xw],qn.transparent,[!0,!0,!0,!0]),Eg.alphaBlendedNonPremultiplied=new Eg([770,xw,770,xw],qn.transparent,[!0,!0,!0,!0]),Eg.multiply=new Eg([774,0,774,0],qn.transparent,[!0,!0,!0,!0]);const vw=1029,bw=2305;class Cg{constructor(Ye,ut,pt){this.enable=Ye,this.mode=ut,this.frontFace=pt}}Cg.disabled=new Cg(!1,vw,bw),Cg.backCCW=new Cg(!0,vw,bw),Cg.backCW=new Cg(!0,vw,2304),Cg.frontCW=new Cg(!0,1028,2304),Cg.frontCCW=new Cg(!0,1028,bw);const ww=Fx.types,Tw=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Lg(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr){const fn=Lt?Math.min(lw,Math.round(Lt[0])):0,xn=Lt?Math.min(lw,Math.round(Lt[1])):0;Ye.emplaceBack(ut,pt,Math.round(32*wt),Math.round(32*Tt),St,It,(fn<<1)+($t?1:0),xn,16*Xt,16*Sr,256*Lr,256*Qr)}function Og(Ye,ut,pt){Ye.emplaceBack(ut,pt)}function Fg(Ye,ut,pt,wt,Tt,St,It){Ye.emplaceBack(ut,pt,wt,Tt,St,It)}function Ug(Ye,ut,pt,wt,Tt){Ye.emplaceBack(ut,pt,wt,Tt),Ye.emplaceBack(ut,pt,wt,Tt),Ye.emplaceBack(ut,pt,wt,Tt),Ye.emplaceBack(ut,pt,wt,Tt)}function Ng(Ye){for(const ut of Ye.sections)if(Vo(ut.text))return!0;return!1}class jg{constructor(Ye){this.layoutVertexArray=new $l,this.indexArray=new Ql,this.programConfigurations=Ye,this.segments=new Au,this.dynamicLayoutVertexArray=new Fl,this.opacityVertexArray=new Yl,this.occlusionQueryOpacityVertexArray=new Xl,this.placedSymbolArray=new du,this.iconTransitioningVertexArray=new Zl,this.globeExtVertexArray=new Gl,this.zOffsetVertexArray=new Xl}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(Ye,ut,pt,wt,Tt){this.isEmpty()||(pt&&(this.layoutVertexBuffer=Ye.createVertexBuffer(this.layoutVertexArray,Av.members),this.indexBuffer=Ye.createIndexBuffer(this.indexArray,ut),this.dynamicLayoutVertexBuffer=Ye.createVertexBuffer(this.dynamicLayoutVertexArray,zv.members,!0),this.opacityVertexBuffer=Ye.createVertexBuffer(this.opacityVertexArray,Tw,!0),this.occlusionQueryOpacityVertexBuffer=Ye.createVertexBuffer(this.occlusionQueryOpacityVertexArray,kv.members,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=Ye.createVertexBuffer(this.iconTransitioningVertexArray,Wv.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=Ye.createVertexBuffer(this.globeExtVertexArray,Iv.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||Tt)&&(this.zOffsetVertexBuffer=Ye.createVertexBuffer(this.zOffsetVertexArray,Zv.members,!0)),this.opacityVertexBuffer.itemSize=1),(pt||wt)&&this.programConfigurations.upload(Ye))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.occlusionQueryOpacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Mo(jg,"SymbolBuffers");class qg{constructor(Ye,ut,pt){this.layoutVertexArray=new Ye,this.layoutAttributes=ut,this.indexArray=new pt,this.segments=new Au,this.collisionVertexArray=new Jl,this.collisionVertexArrayExt=new Fl}upload(Ye){this.layoutVertexBuffer=Ye.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=Ye.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=Ye.createVertexBuffer(this.collisionVertexArray,Xv.members,!0),this.collisionVertexBufferExt=Ye.createVertexBuffer(this.collisionVertexArrayExt,ib.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Mo(qg,"CollisionBuffers");class $g{constructor(ut){this.queries=new Map,this.collisionBoxArray=ut.collisionBoxArray,this.zoom=ut.zoom,this.lut=ut.lut,this.overscaling=ut.overscaling,this.layers=ut.layers,this.layerIds=this.layers.map((Ye=>Ye.fqid)),this.index=ut.index,this.pixelRatio=ut.pixelRatio,this.sourceLayerIndex=ut.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Ye.ad.identity([]),this.placementViewportMatrix=Ye.ad.identity([]);const pt=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Nm(this.zoom,pt["text-size"]),this.iconSizeData=Nm(this.zoom,pt["icon-size"]);const wt=this.layers[0].layout,Tt=wt.get("symbol-sort-key"),St=wt.get("symbol-z-order");this.canOverlap=wt.get("text-allow-overlap")||wt.get("icon-allow-overlap")||wt.get("text-ignore-placement")||wt.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==St&&void 0!==Tt.constantOr(1),this.sortFeaturesByY=("viewport-y"===St||"auto"===St&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=wt.get("text-writing-mode").map((Ye=>Wb[Ye])),this.stateDependentLayerIds=this.layers.filter((Ye=>Ye.isStateDependent())).map((Ye=>Ye.id)),this.sourceID=ut.sourceID,this.projection=ut.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=wt.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new jg(new Wu(this.layers,{zoom:this.zoom,lut:this.lut},(Ye=>/^text/.test(Ye)))),this.icon=new jg(new Wu(this.layers,{zoom:this.zoom,lut:this.lut},(Ye=>/^icon/.test(Ye)))),this.glyphOffsetArray=new gu,this.lineVertexArray=new xu,this.symbolInstances=new yu}calculateGlyphDependencies(Ye,ut,pt,wt,Tt){for(let pt=0;pt<Ye.length;pt++){const St=Ye.codePointAt(pt);if(void 0===St)break;if(ut[St]=!0,wt&&Tt&&St<=65535){const wt=Ub[Ye.charAt(pt)];wt&&(ut[wt.charCodeAt(0)]=!0)}}}updateFootprints(Ye,ut){}updateReplacement(Ye,ut){if(ut.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=ut.updateTime;const pt=ut.getReplacementRegionsForTile(Ye.toUnwrapped(),!0);return!Cf(this.activeReplacements,pt)&&(this.activeReplacements=pt,!0)}populate(ut,pt,wt,Tt){const St=this.layers[0],It=St.layout,Lt="globe"===this.projection.name,$t=It.get("text-font"),Xt=It.get("text-field"),Sr=It.get("icon-image"),Lr=("constant"!==Xt.value.kind||Xt.value.value instanceof mi&&!Xt.value.value.isEmpty()||Xt.value.value.toString().length>0)&&("constant"!==$t.value.kind||$t.value.value.length>0),Qr="constant"!==Sr.value.kind||!!Sr.value.value||Object.keys(Sr.parameters).length>0,fn=It.get("symbol-sort-key");if(this.features=[],!Lr&&!Qr)return;const xn=pt.iconDependencies,vn=pt.glyphDependencies,kn=pt.availableImages,Wn=new Ho(this.zoom);for(const{feature:pt,id:Xt,index:Sr,sourceLayerIndex:Xn}of ut){const ut=St._featureFilter.needGeometry,Jn=Xc(pt,ut);if(!St._featureFilter.filter(Wn,Jn,wt))continue;if(ut||(Jn.geometry=Yc(pt,wt,Tt)),Lt&&1!==pt.type&&wt.z<=5){const ut=Jn.geometry,pt=.98078528056,i=(ut,Tt)=>{const St=Nh(ut.x,ut.y,wt,1),It=Nh(Tt.x,Tt.y,wt,1);return Ye._.dot(St,It)<pt};for(let Ye=0;Ye<ut.length;Ye++)ut[Ye]=jc(ut[Ye],i)}let Qn,ko;if(Lr){const Ye=St.getValueAndResolveTokens("text-field",Jn,wt,kn),ut=mi.factory(Ye);Ng(ut)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Yo()||this.hasRTLText&&k_.isParsed())&&(Qn=Gm(ut,St,Jn))}if(Qr){const Ye=St.getValueAndResolveTokens("icon-image",Jn,wt,kn);ko=Ye instanceof yi?Ye:yi.fromString(Ye)}if(!Qn&&!ko)continue;const Fo=this.sortFeaturesByKey?fn.evaluate(Jn,{},wt):void 0;if(this.features.push({id:Xt,text:Qn,icon:ko,index:Sr,sourceLayerIndex:Xn,geometry:Jn.geometry,properties:pt.properties,type:ww[pt.type],sortKey:Fo}),ko&&(xn[ko.namePrimary]=!0,ko.nameSecondary&&(xn[ko.nameSecondary]=!0)),Qn){const Ye=$t.evaluate(Jn,{},wt).join(","),ut="map"===It.get("text-rotation-alignment")&&"point"!==It.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Wb.vertical)>=0;for(const pt of Qn.sections)if(pt.image)xn[pt.image.namePrimary]=!0;else{const wt=Po(Qn.toString()),Tt=pt.fontStack||Ye,St=vn[Tt]=vn[Tt]||{};this.calculateGlyphDependencies(pt.text,St,ut,this.allowVerticalPlacement,wt)}}}"line"===It.get("symbol-placement")&&(this.features=function(Ye){const ut={},pt={},wt=[];let Tt=0;function s(ut){wt.push(Ye[ut]),Tt++}function a(Ye,ut,Tt){const St=pt[Ye];return delete pt[Ye],pt[ut]=St,wt[St].geometry[0].pop(),wt[St].geometry[0]=wt[St].geometry[0].concat(Tt[0]),St}function o(Ye,pt,Tt){const St=ut[pt];return delete ut[pt],ut[Ye]=St,wt[St].geometry[0].shift(),wt[St].geometry[0]=Tt[0].concat(wt[St].geometry[0]),St}function l(Ye,ut,pt){const wt=pt?ut[0][ut[0].length-1]:ut[0][0];return`${Ye}:${wt.x}:${wt.y}`}for(let St=0;St<Ye.length;St++){const It=Ye[St],Lt=It.geometry,$t=It.text?It.text.toString():null;if(!$t){s(St);continue}const Xt=l($t,Lt),Sr=l($t,Lt,!0);if(Xt in pt&&Sr in ut&&pt[Xt]!==ut[Sr]){const Ye=o(Xt,Sr,Lt),Tt=a(Xt,Sr,wt[Ye].geometry);delete ut[Xt],delete pt[Sr],pt[l($t,wt[Tt].geometry,!0)]=Tt,wt[Ye].geometry=null}else Xt in pt?a(Xt,Sr,Lt):Sr in ut?o(Xt,Sr,Lt):(s(St),ut[Xt]=Tt-1,pt[Sr]=Tt-1)}return wt.filter((Ye=>Ye.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((Ye,ut)=>Ye.sortKey-ut.sortKey))}update(Ye,ut,pt,wt,Tt){const St=0!==Object.keys(Ye).length;if(St&&!this.stateDependentLayers.length)return;const It=St?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(Ye,ut,It,pt,wt,Tt),this.icon.programConfigurations.updatePaintArrays(Ye,ut,It,pt,wt,Tt)}updateOcclusionOpacities(Ye,ut,pt){if(!ut.useOcclusionQueries)return!1;const wt=this;if("globe"===wt.projection.name)return!1;let Tt=!1;wt.hasTextData()&&(Tt=Tt||0!==wt.text.occlusionQueryOpacityVertexArray.length),wt.hasIconData()&&(Tt=Tt||0!==wt.icon.occlusionQueryOpacityVertexArray.length);const St=wt.layers[0].paint,It=St.get("icon-occlusion-opacity").constantOr(0),Lt=St.get("text-occlusion-opacity").constantOr(0);if(!wt.layers[0].hasInitialOcclusionOpacityProperties||1===It&&1===Lt)return!1;let $t=!Tt;for(let Ye=0;Ye<wt.symbolInstances.length;Ye++){const Tt=wt.symbolInstances.get(Ye),St=Tt.occlusionOpacity;Tt.occlusionOpacity+=(Tt.occlusionState>.5?1:-1)*ut.fadeSpeed*pt*.001,Tt.occlusionOpacity=Ke(Tt.occlusionOpacity,0,1),$t=$t||Tt.occlusionOpacity!==St}if(!$t)return!1;let Xt=0,Sr=0;const h=(Ye,ut,pt,wt)=>{let Tt=0,St=0;pt?(Tt=Sr,Sr+=wt,St=Sr):(Tt=Xt,Xt+=wt,St=Xt),St>ut.occlusionQueryOpacityVertexArray.length&&ut.occlusionQueryOpacityVertexArray.resize(St);const It=Ye.occlusionOpacity;for(let Ye=0;Ye<wt;Ye++)ut.occlusionQueryOpacityVertexArray.emplace(Ye+Tt,It)};for(let Ye=0;Ye<wt.symbolInstances.length;Ye++){const ut=wt.symbolInstances.get(Ye),{numHorizontalGlyphVertices:pt,numVerticalGlyphVertices:Tt,numIconVertices:St}=ut,It=St>0;if((pt>0||Tt>0)&&(h(ut,wt.text,!1,pt),h(ut,wt.text,!1,Tt)),It){const{placedIconSymbolIndex:Ye,verticalPlacedIconSymbolIndex:pt}=ut;Ye>=0&&h(ut,wt.icon,!0,St),pt>=0&&h(ut,wt.icon,!0,ut.numVerticalIconVertices)}}return wt.hasTextData()&&wt.text.occlusionQueryOpacityVertexBuffer&&(wt.text.occlusionQueryOpacityVertexBuffer.length<wt.text.occlusionQueryOpacityVertexArray.length?wt.text.occlusionQueryOpacityVertexBuffer=Ye.createVertexBuffer(wt.text.occlusionQueryOpacityVertexArray,kv.members,!0):wt.text.occlusionQueryOpacityVertexBuffer.updateData(wt.text.occlusionQueryOpacityVertexArray)),wt.hasIconData()&&wt.icon.occlusionQueryOpacityVertexBuffer&&(wt.icon.occlusionQueryOpacityVertexBuffer.length<wt.icon.occlusionQueryOpacityVertexArray.length?wt.icon.occlusionQueryOpacityVertexBuffer=Ye.createVertexBuffer(wt.icon.occlusionQueryOpacityVertexArray,kv.members,!0):wt.icon.occlusionQueryOpacityVertexBuffer.updateData(wt.icon.occlusionQueryOpacityVertexArray)),!0}updateZOffset(){const t=(ut,pt,wt)=>{Ye+=pt,Ye>ut.length&&ut.resize(Ye);for(let Tt=-pt;Tt<0;Tt++)ut.emplace(Tt+Ye,wt)},e=(Ye,pt,wt)=>{ut+=pt,ut>Ye.length&&Ye.resize(ut);for(let Tt=-pt;Tt<0;Tt++)Ye.emplace(Tt+ut,wt)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let Ye=0,ut=0;for(let Ye=0;Ye<this.symbolInstances.length;Ye++){const ut=this.symbolInstances.get(Ye),{numHorizontalGlyphVertices:pt,numVerticalGlyphVertices:wt,numIconVertices:Tt}=ut,St=ut.zOffset,It=Tt>0;if((pt>0||wt>0)&&(t(this.text.zOffsetVertexArray,pt,St),t(this.text.zOffsetVertexArray,wt,St)),It){const{placedIconSymbolIndex:Ye,verticalPlacedIconSymbolIndex:pt}=ut;Ye>=0&&e(this.icon.zOffsetVertexArray,Tt,St),pt>=0&&e(this.icon.zOffsetVertexArray,ut.numVerticalIconVertices,St)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(Ye){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(Ye),this.iconCollisionBox.upload(Ye)),this.text.upload(Ye,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(Ye,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Sg(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData();for(const Ye of this.queries.values())Ye.destroy()}addToLineVertexArray(Ye,ut){const pt=this.lineVertexArray.length;if(void 0!==Ye.segment)for(const{x:Ye,y:pt}of ut)this.lineVertexArray.emplaceBack(Ye,pt);return{lineStartIndex:pt,lineLength:this.lineVertexArray.length-pt}}addSymbols(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn){const kn=Ye.indexArray,Wn=Ye.layoutVertexArray,Xn=Ye.globeExtVertexArray,Jn=Ye.segments.prepareSegment(4*ut.length,Wn,kn,this.canOverlap?St.sortKey:void 0),Qn=this.glyphOffsetArray.length,ko=Jn.vertexLength,Fo=this.allowVerticalPlacement&&It===Wb.vertical?Math.PI/2:0,is=St.text&&St.text.sections;for(let wt=0;wt<ut.length;wt++){const{tl:Tt,tr:It,bl:Xt,br:Sr,texPrimary:Lr,texSecondary:Qn,pixelOffsetTL:ko,pixelOffsetBR:ns,minFontScaleX:ss,minFontScaleY:as,glyphOffset:ds,isSDF:ps,sectionIndex:ms}=ut[wt],Js=Jn.vertexLength,ua=ds[1];if(Lg(Wn,$t.x,$t.y,Tt.x,ua+Tt.y,Lr.x,Lr.y,pt,ps,ko.x,ko.y,ss,as),Lg(Wn,$t.x,$t.y,It.x,ua+It.y,Lr.x+Lr.w,Lr.y,pt,ps,ns.x,ko.y,ss,as),Lg(Wn,$t.x,$t.y,Xt.x,ua+Xt.y,Lr.x,Lr.y+Lr.h,pt,ps,ko.x,ns.y,ss,as),Lg(Wn,$t.x,$t.y,Sr.x,ua+Sr.y,Lr.x+Lr.w,Lr.y+Lr.h,pt,ps,ns.x,ns.y,ss,as),Lt){const{x:ut,y:pt,z:wt}=Lt.anchor,[Tt,St,It]=Lt.up;Fg(Xn,ut,pt,wt,Tt,St,It),Fg(Xn,ut,pt,wt,Tt,St,It),Fg(Xn,ut,pt,wt,Tt,St,It),Fg(Xn,ut,pt,wt,Tt,St,It),Ug(Ye.dynamicLayoutVertexArray,ut,pt,wt,Fo)}else Ug(Ye.dynamicLayoutVertexArray,$t.x,$t.y,$t.z,Fo);if(vn){const ut=Qn||Lr;Og(Ye.iconTransitioningVertexArray,ut.x,ut.y),Og(Ye.iconTransitioningVertexArray,ut.x+ut.w,ut.y),Og(Ye.iconTransitioningVertexArray,ut.x,ut.y+ut.h),Og(Ye.iconTransitioningVertexArray,ut.x+ut.w,ut.y+ut.h)}kn.emplaceBack(Js,Js+1,Js+2),kn.emplaceBack(Js+1,Js+2,Js+3),Jn.vertexLength+=4,Jn.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ds[0]),wt!==ut.length-1&&ms===ut[wt+1].sectionIndex||Ye.programConfigurations.populatePaintArrays(Wn.length,St,St.index,{},Qr,fn,xn,is&&is[ms])}const ns=Lt?Lt.anchor:$t;Ye.placedSymbolArray.emplaceBack(ns.x,ns.y,ns.z,$t.x,$t.y,Qn,this.glyphOffsetArray.length-Qn,ko,Xt,Sr,$t.segment,pt?pt[0]:0,pt?pt[1]:0,wt[0],wt[1],It,0,!1,0,Lr,0)}_commitLayoutVertex(Ye,ut,pt,wt,Tt,St,It){Ye.emplaceBack(ut,pt,wt,Tt,St,Math.round(It.x),Math.round(It.y))}_addCollisionDebugVertices(Ye,ut,pt,wt,Tt,St,It){const Lt=pt.segments.prepareSegment(4,pt.layoutVertexArray,pt.indexArray),$t=Lt.vertexLength,Xt=It.tileAnchorX,Sr=It.tileAnchorY;for(let Ye=0;Ye<4;Ye++)pt.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(pt.collisionVertexArrayExt,ut,Ye.padding,It.zOffset),this._commitLayoutVertex(pt.layoutVertexArray,wt,Tt,St,Xt,Sr,new wu(Ye.x1,Ye.y1)),this._commitLayoutVertex(pt.layoutVertexArray,wt,Tt,St,Xt,Sr,new wu(Ye.x2,Ye.y1)),this._commitLayoutVertex(pt.layoutVertexArray,wt,Tt,St,Xt,Sr,new wu(Ye.x2,Ye.y2)),this._commitLayoutVertex(pt.layoutVertexArray,wt,Tt,St,Xt,Sr,new wu(Ye.x1,Ye.y2)),Lt.vertexLength+=4;const Lr=pt.indexArray;Lr.emplaceBack($t,$t+1),Lr.emplaceBack($t+1,$t+2),Lr.emplaceBack($t+2,$t+3),Lr.emplaceBack($t+3,$t),Lt.primitiveLength+=4}_addTextDebugCollisionBoxes(Ye,ut,pt,wt,Tt,St){for(let It=wt;It<Tt;It++){const wt=pt.get(It),Tt=this.getSymbolInstanceTextSize(Ye,St,ut,It);this._addCollisionDebugVertices(wt,Tt,this.textCollisionBox,wt.projectedAnchorX,wt.projectedAnchorY,wt.projectedAnchorZ,St)}}_addIconDebugCollisionBoxes(Ye,ut,pt,wt,Tt,St){for(let It=wt;It<Tt;It++){const wt=pt.get(It),Tt=this.getSymbolInstanceIconSize(Ye,ut,St.placedIconSymbolIndex);this._addCollisionDebugVertices(wt,Tt,this.iconCollisionBox,wt.projectedAnchorX,wt.projectedAnchorY,wt.projectedAnchorZ,St)}}generateCollisionDebugBuffers(Ye,ut){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new qg(Kl,rb.members,Zl),this.iconCollisionBox=new qg(Kl,rb.members,Zl);const pt=qm(this.iconSizeData,Ye),wt=qm(this.textSizeData,Ye);for(let Tt=0;Tt<this.symbolInstances.length;Tt++){const St=this.symbolInstances.get(Tt);this._addTextDebugCollisionBoxes(wt,Ye,ut,St.textBoxStartIndex,St.textBoxEndIndex,St),this._addTextDebugCollisionBoxes(wt,Ye,ut,St.verticalTextBoxStartIndex,St.verticalTextBoxEndIndex,St),this._addIconDebugCollisionBoxes(pt,Ye,ut,St.iconBoxStartIndex,St.iconBoxEndIndex,St),this._addIconDebugCollisionBoxes(pt,Ye,ut,St.verticalIconBoxStartIndex,St.verticalIconBoxEndIndex,St)}}getSymbolInstanceTextSize(Ye,ut,pt,wt){const Tt=this.text.placedSymbolArray.get(ut.rightJustifiedTextSymbolIndex>=0?ut.rightJustifiedTextSymbolIndex:ut.centerJustifiedTextSymbolIndex>=0?ut.centerJustifiedTextSymbolIndex:ut.leftJustifiedTextSymbolIndex>=0?ut.leftJustifiedTextSymbolIndex:ut.verticalPlacedTextSymbolIndex>=0?ut.verticalPlacedTextSymbolIndex:wt),St=jm(this.textSizeData,Ye,Tt)/Fb;return this.tilePixelRatio*St}getSymbolInstanceIconSize(Ye,ut,pt){const wt=this.icon.placedSymbolArray.get(pt),Tt=jm(this.iconSizeData,Ye,wt);return this.tilePixelRatio*Tt}_commitDebugCollisionVertexUpdate(Ye,ut,pt,wt){Ye.emplaceBack(ut,-pt,-pt,wt),Ye.emplaceBack(ut,pt,-pt,wt),Ye.emplaceBack(ut,pt,pt,wt),Ye.emplaceBack(ut,-pt,pt,wt)}_updateTextDebugCollisionBoxes(Ye,ut,pt,wt,Tt,St){for(let It=wt;It<Tt;It++){const wt=pt.get(It),Tt=this.getSymbolInstanceTextSize(Ye,St,ut,It);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,Tt,wt.padding,St.zOffset)}}_updateIconDebugCollisionBoxes(Ye,ut,pt,wt,Tt,St){for(let It=wt;It<Tt;It++){const wt=pt.get(It),Tt=this.getSymbolInstanceIconSize(Ye,ut,St.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,Tt,wt.padding,St.zOffset)}}updateCollisionDebugBuffers(Ye,ut){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const pt=qm(this.iconSizeData,Ye),wt=qm(this.textSizeData,Ye);for(let Tt=0;Tt<this.symbolInstances.length;Tt++){const St=this.symbolInstances.get(Tt);this._updateTextDebugCollisionBoxes(wt,Ye,ut,St.textBoxStartIndex,St.textBoxEndIndex,St),this._updateTextDebugCollisionBoxes(wt,Ye,ut,St.verticalTextBoxStartIndex,St.verticalTextBoxEndIndex,St),this._updateIconDebugCollisionBoxes(pt,Ye,ut,St.iconBoxStartIndex,St.iconBoxEndIndex,St),this._updateIconDebugCollisionBoxes(pt,Ye,ut,St.verticalIconBoxStartIndex,St.verticalIconBoxEndIndex,St)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(Ye,ut,pt,wt,Tt,St,It,Lt,$t){const Xt={};if(ut<pt){const{x1:pt,y1:wt,x2:Tt,y2:St,padding:It,projectedAnchorX:Lt,projectedAnchorY:$t,projectedAnchorZ:Sr,tileAnchorX:Lr,tileAnchorY:Qr,featureIndex:fn}=Ye.get(ut);Xt.textBox={x1:pt,y1:wt,x2:Tt,y2:St,padding:It,projectedAnchorX:Lt,projectedAnchorY:$t,projectedAnchorZ:Sr,tileAnchorX:Lr,tileAnchorY:Qr},Xt.textFeatureIndex=fn}if(wt<Tt){const{x1:ut,y1:pt,x2:Tt,y2:St,padding:It,projectedAnchorX:Lt,projectedAnchorY:$t,projectedAnchorZ:Sr,tileAnchorX:Lr,tileAnchorY:Qr,featureIndex:fn}=Ye.get(wt);Xt.verticalTextBox={x1:ut,y1:pt,x2:Tt,y2:St,padding:It,projectedAnchorX:Lt,projectedAnchorY:$t,projectedAnchorZ:Sr,tileAnchorX:Lr,tileAnchorY:Qr},Xt.verticalTextFeatureIndex=fn}if(St<It){const{x1:ut,y1:pt,x2:wt,y2:Tt,padding:It,projectedAnchorX:Lt,projectedAnchorY:$t,projectedAnchorZ:Sr,tileAnchorX:Lr,tileAnchorY:Qr,featureIndex:fn}=Ye.get(St);Xt.iconBox={x1:ut,y1:pt,x2:wt,y2:Tt,padding:It,projectedAnchorX:Lt,projectedAnchorY:$t,projectedAnchorZ:Sr,tileAnchorX:Lr,tileAnchorY:Qr},Xt.iconFeatureIndex=fn}if(Lt<$t){const{x1:ut,y1:pt,x2:wt,y2:Tt,padding:St,projectedAnchorX:It,projectedAnchorY:$t,projectedAnchorZ:Sr,tileAnchorX:Lr,tileAnchorY:Qr,featureIndex:fn}=Ye.get(Lt);Xt.verticalIconBox={x1:ut,y1:pt,x2:wt,y2:Tt,padding:St,projectedAnchorX:It,projectedAnchorY:$t,projectedAnchorZ:Sr,tileAnchorX:Lr,tileAnchorY:Qr},Xt.verticalIconFeatureIndex=fn}return Xt}deserializeCollisionBoxes(Ye){this.collisionArrays=[];for(let ut=0;ut<this.symbolInstances.length;ut++){const pt=this.symbolInstances.get(ut);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(Ye,pt.textBoxStartIndex,pt.textBoxEndIndex,pt.verticalTextBoxStartIndex,pt.verticalTextBoxEndIndex,pt.iconBoxStartIndex,pt.iconBoxEndIndex,pt.verticalIconBoxStartIndex,pt.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(Ye,ut){const pt=Ye.placedSymbolArray.get(ut),wt=pt.vertexStartIndex+4*pt.numGlyphs;for(let ut=pt.vertexStartIndex;ut<wt;ut+=4)Ye.indexArray.emplaceBack(ut,ut+1,ut+2),Ye.indexArray.emplaceBack(ut+1,ut+2,ut+3)}getSortedSymbolIndexes(Ye){if(this.sortedAngle===Ye&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const ut=Math.sin(Ye),pt=Math.cos(Ye),wt=[],Tt=[],St=[];for(let Ye=0;Ye<this.symbolInstances.length;++Ye){St.push(Ye);const It=this.symbolInstances.get(Ye);wt.push(0|Math.round(ut*It.tileAnchorX+pt*It.tileAnchorY)),Tt.push(It.featureIndex)}return St.sort(((Ye,ut)=>wt[Ye]-wt[ut]||Tt[ut]-Tt[Ye])),St}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let Ye=0;Ye<this.symbolInstances.length;++Ye)this.symbolInstanceIndexesSortedZOffset.push(Ye)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((Ye,ut)=>this.symbolInstances.get(ut).zOffset-this.symbolInstances.get(Ye).zOffset))}addToSortKeyRanges(Ye,ut){const pt=this.sortKeyRanges[this.sortKeyRanges.length-1];pt&&pt.sortKey===ut?pt.symbolInstanceEnd=Ye+1:this.sortKeyRanges.push({sortKey:ut,symbolInstanceStart:Ye,symbolInstanceEnd:Ye+1})}sortFeatures(Ye){if(this.sortFeaturesByY&&this.sortedAngle!==Ye&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(Ye),this.sortedAngle=Ye,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const Ye of this.symbolInstanceIndexes){const ut=this.symbolInstances.get(Ye);this.featureSortOrder.push(ut.featureIndex);const{rightJustifiedTextSymbolIndex:pt,centerJustifiedTextSymbolIndex:wt,leftJustifiedTextSymbolIndex:Tt,verticalPlacedTextSymbolIndex:St,placedIconSymbolIndex:It,verticalPlacedIconSymbolIndex:Lt}=ut;pt>=0&&this.addIndicesForPlacedSymbol(this.text,pt),wt>=0&&wt!==pt&&this.addIndicesForPlacedSymbol(this.text,wt),Tt>=0&&Tt!==wt&&Tt!==pt&&this.addIndicesForPlacedSymbol(this.text,Tt),St>=0&&this.addIndicesForPlacedSymbol(this.text,St),It>=0&&this.addIndicesForPlacedSymbol(this.icon,It),Lt>=0&&this.addIndicesForPlacedSymbol(this.icon,Lt)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Mo($g,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),$g.addDynamicAttributes=Ug;class Gg{constructor(Ye,ut,pt,wt){this.context=Ye,this.format=pt,this.texture=Ye.gl.createTexture(),this.update(ut,wt)}update(Ye,ut,pt){const{width:wt,height:Tt}=Ye,{context:St}=this,{gl:It}=St;if(It.bindTexture(It.TEXTURE_2D,this.texture),St.pixelStoreUnpackFlipY.set(!1),St.pixelStoreUnpack.set(1),St.pixelStoreUnpackPremultiplyAlpha.set(this.format===It.RGBA&&(!ut||!1!==ut.premultiply)),this.useMipmap=Boolean(ut&&ut.useMipmap),pt||this.size&&this.size[0]===wt&&this.size[1]===Tt){const{x:ut,y:St}=pt||{x:0,y:0};if(Ye instanceof HTMLImageElement||Ye instanceof HTMLCanvasElement||Ye instanceof HTMLVideoElement||Ye instanceof ImageData||ImageBitmap&&Ye instanceof ImageBitmap)It.texSubImage2D(It.TEXTURE_2D,0,ut,St,It.RGBA,It.UNSIGNED_BYTE,Ye);else{let pt=this.format,Lt=It.UNSIGNED_BYTE;this.format===It.R32F&&(pt=It.RED,Lt=It.FLOAT),It.texSubImage2D(It.TEXTURE_2D,0,ut,St,wt,Tt,pt,Lt,Ye.data)}}else if(this.size=[wt,Tt],Ye instanceof HTMLImageElement||Ye instanceof HTMLCanvasElement||Ye instanceof HTMLVideoElement||Ye instanceof ImageData||ImageBitmap&&Ye instanceof ImageBitmap){let ut=this.format;this.format===It.R8&&(ut=It.RED),It.texImage2D(It.TEXTURE_2D,0,this.format,ut,It.UNSIGNED_BYTE,Ye)}else{let ut=this.format,pt=this.format,St=It.UNSIGNED_BYTE,Lt=!1;this.format===It.DEPTH_COMPONENT&&(ut=It.DEPTH_COMPONENT16,St=It.UNSIGNED_SHORT),this.format===It.DEPTH_STENCIL&&(ut=It.DEPTH24_STENCIL8,St=It.UNSIGNED_INT_24_8,Lt=!0),this.format===It.R8&&(pt=It.RED),this.format===It.R32F&&(St=It.FLOAT,pt=It.RED),!this.useMipmap&&Lt?It.texStorage2D(It.TEXTURE_2D,1,ut,wt,Tt):It.texImage2D(It.TEXTURE_2D,0,ut,wt,Tt,0,pt,St,Ye.data)}this.useMipmap&&It.generateMipmap(It.TEXTURE_2D)}bind(Ye,ut,pt=!1){const{context:wt}=this,{gl:Tt}=wt;Tt.bindTexture(Tt.TEXTURE_2D,this.texture),Ye!==this.minFilter&&(Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_MAG_FILTER,Ye),Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_MIN_FILTER,this.useMipmap&&!pt?Ye===Tt.NEAREST?Tt.NEAREST_MIPMAP_NEAREST:Tt.LINEAR_MIPMAP_LINEAR:Ye),this.minFilter=Ye),ut!==this.wrapS&&(Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_WRAP_S,ut),Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_WRAP_T,ut),this.wrapS=ut)}bindExtraParam(Ye,ut,pt,wt){const{context:Tt}=this,{gl:St}=Tt;St.bindTexture(St.TEXTURE_2D,this.texture),ut!==this.magFilter&&(St.texParameteri(St.TEXTURE_2D,St.TEXTURE_MAG_FILTER,ut),this.magFilter=ut),Ye!==this.minFilter&&(St.texParameteri(St.TEXTURE_2D,St.TEXTURE_MIN_FILTER,this.useMipmap?Ye===St.NEAREST?St.NEAREST_MIPMAP_NEAREST:St.LINEAR_MIPMAP_LINEAR:Ye),this.minFilter=Ye),pt!==this.wrapS&&(St.texParameteri(St.TEXTURE_2D,St.TEXTURE_WRAP_S,pt),this.wrapS=pt),wt!==this.wrapT&&(St.texParameteri(St.TEXTURE_2D,St.TEXTURE_WRAP_T,wt),this.wrapT=wt)}destroy(){const{gl:Ye}=this.context;Ye.deleteTexture(this.texture),this.texture=null}}class Yg{constructor(Ye,ut){this.context=Ye,this.texture=ut}bind(Ye,ut){const{context:pt}=this,{gl:wt}=pt;wt.bindTexture(wt.TEXTURE_2D,this.texture),Ye!==this.minFilter&&(wt.texParameteri(wt.TEXTURE_2D,wt.TEXTURE_MAG_FILTER,Ye),wt.texParameteri(wt.TEXTURE_2D,wt.TEXTURE_MIN_FILTER,Ye),this.minFilter=Ye),ut!==this.wrapS&&(wt.texParameteri(wt.TEXTURE_2D,wt.TEXTURE_WRAP_S,ut),wt.texParameteri(wt.TEXTURE_2D,wt.TEXTURE_WRAP_T,ut),this.wrapS=ut)}}const Ew=32,Mw=33,Aw=new Uint16Array(8184);for(let Ye=0;Ye<2046;Ye++){let ut=Ye+2,pt=0,wt=0,Tt=0,St=0,It=0,Lt=0;for(1&ut?Tt=St=It=Ew:pt=wt=Lt=Ew;(ut>>=1)>1;){const Ye=pt+Tt>>1,$t=wt+St>>1;1&ut?(Tt=pt,St=wt,pt=It,wt=Lt):(pt=Tt,wt=St,Tt=It,St=Lt),It=Ye,Lt=$t}const $t=4*Ye;Aw[$t+0]=pt,Aw[$t+1]=wt,Aw[$t+2]=Tt,Aw[$t+3]=St}const Sw=new Uint16Array(2178),Iw=new Uint8Array(1089),Cw=new Uint16Array(1089);function Qg(Ye){return 0===Ye?-.03125:32===Ye?.03125:0}var Pw=Bl([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]),zw=Bl([{name:"a_index",type:"Int16",components:1}]);const Dw=(()=>({type:2,extent:ym,loadGeometry:()=>[[new wu(0,0),new wu(ym+1,0),new wu(ym+1,ym+1),new wu(0,ym+1),new wu(0,0)]]}))();class nx{constructor(Ye,ut,pt,wt,Tt){this.tileID=Ye,this.uid=nr(),this.uses=0,this.tileSize=ut,this.tileZoom=pt,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=Tt,wt&&wt.style&&(this._lastUpdatedBrightness=wt.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",wt&&wt.transform&&(this.projection=wt.transform.projection)}registerFadeDuration(Ye){const ut=Ye+this.timeAdded;ut<sd.now()||this.fadeEndTime&&ut<this.fadeEndTime||(this.fadeEndTime=ut)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=ng(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(Ye,ut,pt){if(this.unloadVectorData(),this.state="loaded",Ye){Ye.featureIndex&&(this.latestFeatureIndex=Ye.featureIndex,Ye.rawTileData?(this.latestRawTileData=Ye.rawTileData,this.latestFeatureIndex.rawTileData=Ye.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=Ye.collisionBoxArray,this.buckets=function(Ye,ut){const pt={};if(!ut)return pt;for(const wt of Ye){const Ye=wt.layerIds.map((Ye=>ut.getLayer(Ye))).filter(Boolean);if(0!==Ye.length){wt.layers=Ye,wt.stateDependentLayerIds&&(wt.stateDependentLayers=wt.stateDependentLayerIds.map((ut=>Ye.filter((Ye=>Ye.id===ut))[0])));for(const ut of Ye)pt[ut.fqid]=wt}}return pt}(Ye.buckets,ut.style),this.hasSymbolBuckets=!1;for(const Ye in this.buckets){const ut=this.buckets[Ye];if(ut instanceof $g){if(this.hasSymbolBuckets=!0,!pt)break;ut.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const Ye in this.buckets){const ut=this.buckets[Ye];if(ut instanceof $g&&ut.hasRTLText){this.hasRTLText=!0,k_.isLoading()||k_.isLoaded()||"deferred"!==Yo()||Xo();break}}this.queryPadding=0;for(const Ye in this.buckets){const pt=this.buckets[Ye],wt=ut.style.getOwnLayer(Ye);if(!wt)continue;const Tt=wt.queryRadius(pt);this.queryPadding=Math.max(this.queryPadding,Tt)}Ye.imageAtlas&&(this.imageAtlas=Ye.imageAtlas),Ye.glyphAtlasImage&&(this.glyphAtlasImage=Ye.glyphAtlasImage),Ye.lineAtlas&&(this.lineAtlas=Ye.lineAtlas),this._lastUpdatedBrightness=Ye.brightness}else this.collisionBoxArray=new pu}unloadVectorData(){if(this.hasData()){for(const Ye in this.buckets)this.buckets[Ye].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(Ye){return this.buckets[Ye.fqid]}upload(Ye){for(const ut in this.buckets){const pt=this.buckets[ut];pt.uploadPending()&&pt.upload(Ye)}const ut=Ye.gl,pt=this.imageAtlas;if(pt&&!pt.uploaded){const wt=!!Object.keys(pt.patternPositions).length;this.imageAtlasTexture=new Gg(Ye,pt.image,ut.RGBA,{useMipmap:wt}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new Gg(Ye,this.glyphAtlasImage,ut.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new Gg(Ye,this.lineAtlas.image,ut.R8),this.lineAtlas.uploaded=!0)}prepare(Ye,ut,pt){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(Ye,this.imageAtlasTexture,pt),!ut||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const wt=ut.style.getBrightness();(this._lastUpdatedBrightness||wt)&&(this._lastUpdatedBrightness&&wt&&Math.abs(this._lastUpdatedBrightness-wt)<.001||(this._lastUpdatedBrightness=wt,this.updateBuckets(void 0,ut)))}queryRenderedFeatures(Ye,ut,pt,wt,Tt,St,It,Lt){return this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)?this.latestFeatureIndex.query({tileResult:wt,pixelPosMatrix:It,transform:St,params:Tt,tileTransform:this.tileTransform},Ye,ut,pt):{}}querySourceFeatures(Ye,ut){const pt=this.latestFeatureIndex;if(!pt||!pt.rawTileData)return;const wt=pt.loadVTLayers(),Tt=ut?ut.sourceLayer:"",St=wt._geojsonTileLayer||wt[Tt];if(!St)return;const It=pl(ut&&ut.filter),{z:Lt,x:$t,y:Xt}=this.tileID.canonical,Sr={z:Lt,x:$t,y:Xt};for(let ut=0;ut<St.length;ut++){const wt=St.feature(ut);if(It.needGeometry){const Ye=Xc(wt,!0);if(!It.filter(new Ho(this.tileID.overscaledZ),Ye,this.tileID.canonical))continue}else if(!It.filter(new Ho(this.tileID.overscaledZ),wt))continue;const Lr=pt.getId(wt,Tt),Qr=new Cm(wt,Lt,$t,Xt,Lr);Qr.tile=Sr,Ye.push(Qr)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}bucketsLoaded(){for(const Ye in this.buckets)if(this.buckets[Ye].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(Ye){const ut=this.expirationTime;if(Ye.cacheControl){const ut=xr(Ye.cacheControl);ut["max-age"]&&(this.expirationTime=Date.now()+1e3*ut["max-age"])}else Ye.expires&&(this.expirationTime=new Date(Ye.expires).getTime());if(this.expirationTime){const Ye=Date.now();let pt=!1;if(this.expirationTime>Ye)pt=!1;else if(ut)if(this.expirationTime<ut)pt=!0;else{const wt=this.expirationTime-ut;wt?this.expirationTime=Ye+Math.max(wt,3e4):pt=!0}else pt=!0;pt?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(Ye,ut){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&0!==Object.keys(Ye).length&&ut&&this.updateBuckets(Ye,ut)}updateBuckets(Ye,ut){if(!this.latestFeatureIndex)return;const pt=this.latestFeatureIndex.loadVTLayers(),wt=ut.style.listImages(),Tt=ut.style.getBrightness();for(const St in this.buckets){if(!ut.style.hasLayer(St))continue;const It=this.buckets[St],Lt=It.layers[0].sourceLayer||"_geojsonTileLayer",$t=pt[Lt];let Xt={};if(Ye&&(Xt=Ye[Lt],!$t||!Xt||0===Object.keys(Xt).length))continue;if(It.update(Xt,$t,wt,this.imageAtlas&&this.imageAtlas.patternPositions||{},Tt),It instanceof tm||It instanceof Wp){const Ye=ut.style.getOwnSourceCache(It.layers[0].source);ut._terrain&&ut._terrain.enabled&&Ye&&It.programConfigurations.needsUpload&&ut._terrain._clearRenderCacheForTile(Ye.id,this.tileID)}const Sr=ut&&ut.style&&ut.style.getOwnLayer(St);Sr&&(this.queryPadding=Math.max(this.queryPadding,Sr.queryRadius(It)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<sd.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(Ye){this.symbolFadeHoldUntil=sd.now()+Ye}setTexture(Ye,ut){const pt=ut.context,wt=pt.gl;this.texture=this.texture||ut.getTileTexture(Ye.width),this.texture&&this.texture instanceof Gg?this.texture.update(Ye,{useMipmap:!0}):(this.texture=new Gg(pt,Ye,wt.RGBA,{useMipmap:!0}),this.texture.bind(wt.LINEAR,wt.CLAMP_TO_EDGE))}setDependencies(Ye,ut){const pt={};for(const Ye of ut)pt[Ye]=!0;this.dependencies[Ye]=pt}hasDependency(Ye,ut){for(const pt of Ye){const Ye=this.dependencies[pt];if(Ye)for(const pt of ut)if(Ye[pt])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(Ye,ut){if(!ut||"mercator"===ut.name||this._tileDebugBuffer)return;const pt=Yc(Dw,this.tileID.canonical,this.tileTransform)[0],wt=new Cl,Tt=new au;for(let Ye=0;Ye<pt.length;Ye++){const{x:ut,y:St}=pt[Ye];wt.emplaceBack(ut,St),Tt.emplaceBack(Ye)}Tt.emplaceBack(0),this._tileDebugIndexBuffer=Ye.createIndexBuffer(Tt),this._tileDebugBuffer=Ye.createVertexBuffer(wt,ty.members),this._tileDebugSegments=Au.simpleSegment(0,0,wt.length,Tt.length)}_makeTileBoundsBuffers(Ye,ut){if(this._tileBoundsBuffer||!ut||"mercator"===ut.name)return;const pt=Yc(Dw,this.tileID.canonical,this.tileTransform)[0];let wt,Tt;if(this.isRaster){const Ye=function(Ye,ut){const pt=ng(Ye,ut),wt=Math.pow(2,Ye.z);for(let Tt=0;Tt<Mw;Tt++)for(let St=0;St<Mw;St++){const It=zc((Ye.x+(St+Qg(St))/Ew)/wt),Lt=Ec((Ye.y+(Tt+Qg(Tt))/Ew)/wt),$t=ut.project(It,Lt),Xt=Tt*Mw+St;Sw[2*Xt+0]=Math.round(($t.x*pt.scale-pt.x)*ym),Sw[2*Xt+1]=Math.round(($t.y*pt.scale-pt.y)*ym)}Iw.fill(0),Cw.fill(0);for(let Ye=2045;Ye>=0;Ye--){const ut=4*Ye,pt=Aw[ut+0],wt=Aw[ut+1],Tt=Aw[ut+2],St=Aw[ut+3],It=pt+Tt>>1,Lt=wt+St>>1,$t=It+Lt-wt,Xt=Lt+pt-It,Sr=wt*Mw+pt,Lr=St*Mw+Tt,Qr=Lt*Mw+It,fn=Math.hypot((Sw[2*Sr+0]+Sw[2*Lr+0])/2-Sw[2*Qr+0],(Sw[2*Sr+1]+Sw[2*Lr+1])/2-Sw[2*Qr+1])>=16;Iw[Qr]=Iw[Qr]||(fn?1:0),Ye<1022&&(Iw[Qr]=Iw[Qr]||Iw[(wt+Xt>>1)*Mw+(pt+$t>>1)]||Iw[(St+Xt>>1)*Mw+(Tt+$t>>1)])}const Tt=new Vl,St=new Ql;let It=0;function o(Ye,ut){const pt=ut*Mw+Ye;return 0===Cw[pt]&&(Tt.emplaceBack(Sw[2*pt+0],Sw[2*pt+1],Ye*ym/Ew,ut*ym/Ew),Cw[pt]=++It),Cw[pt]-1}function l(Ye,ut,pt,wt,Tt,It){const Lt=Ye+pt>>1,$t=ut+wt>>1;if(Math.abs(Ye-Tt)+Math.abs(ut-It)>1&&Iw[$t*Mw+Lt])l(Tt,It,Ye,ut,Lt,$t),l(pt,wt,Tt,It,Lt,$t);else{const Lt=o(Ye,ut),$t=o(pt,wt),Xt=o(Tt,It);St.emplaceBack(Lt,$t,Xt)}}return l(0,0,Ew,Ew,Ew,0),l(Ew,Ew,0,0,0,Ew),{vertices:Tt,indices:St}}(this.tileID.canonical,ut);wt=Ye.vertices,Tt=Ye.indices}else{wt=new Vl,Tt=new Ql;for(const{x:Ye,y:ut}of pt)wt.emplaceBack(Ye,ut,0,0);const Ye=wp(wt.int16,void 0,4);for(let ut=0;ut<Ye.length;ut+=3)Tt.emplaceBack(Ye[ut],Ye[ut+1],Ye[ut+2])}this._tileBoundsBuffer=Ye.createVertexBuffer(wt,Pw.members),this._tileBoundsIndexBuffer=Ye.createIndexBuffer(Tt),this._tileBoundsSegments=Au.simpleSegment(0,0,wt.length,Tt.length)}_makeGlobeTileDebugBuffers(ut,pt){const wt=pt.projection;if(!wt||"globe"!==wt.name||pt.freezeTileCoverage)return;const Tt=this.tileID.canonical,St=$h(Vh(Tt,pt)),It=Hh(pt.zoom);let Lt;It>0&&(Lt=Ye.ad.invert(new Float64Array(16),pt.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(ut,Tt,pt,St,Lt,It),this._makeGlobeTileDebugTextBuffer(ut,Tt,pt,St,Lt,It)}_globePoint(ut,pt,wt,Tt,St,It,Lt){let $t=Nh(ut,pt,wt);if(It){const St=1<<wt.z,Xt=Tc(Tt.center.lng),Sr=kc(Tt.center.lat),Lr=(wt.x+.5)/St-Xt;let Qr=0;Lr>.5?Qr=-1:Lr<-.5&&(Qr=1);let fn=(ut/ym+wt.x)/St+Qr,xn=(pt/ym+wt.y)/St;fn=(fn-Xt)*Tt._pixelsPerMercatorPixel+Xt,xn=(xn-Sr)*Tt._pixelsPerMercatorPixel+Sr;const vn=[fn*Tt.worldSize,xn*Tt.worldSize,0];Ye._.transformMat4(vn,vn,It),$t=Rh($t,vn,Lt)}return Ye._.transformMat4($t,$t,St)}_makeGlobeTileDebugBorderBuffer(Ye,ut,pt,wt,Tt,St){const It=new Cl,Lt=new au,$t=new Rl,u=(Ye,Xt,Sr,Lr,Qr)=>{const fn=(Sr-Ye)/(Qr-1),xn=(Lr-Xt)/(Qr-1),vn=It.length;for(let Sr=0;Sr<Qr;Sr++){const Lr=Ye+Sr*fn,Qr=Xt+Sr*xn;It.emplaceBack(Lr,Qr);const kn=this._globePoint(Lr,Qr,ut,pt,wt,Tt,St);$t.emplaceBack(kn[0],kn[1],kn[2]),Lt.emplaceBack(vn+Sr)}},Xt=ym;u(0,0,Xt,0,16),u(Xt,0,Xt,Xt,16),u(Xt,Xt,0,Xt,16),u(0,Xt,0,0,16),this._tileDebugIndexBuffer=Ye.createIndexBuffer(Lt),this._tileDebugBuffer=Ye.createVertexBuffer(It,ty.members),this._globeTileDebugBorderBuffer=Ye.createVertexBuffer($t,Jg.members),this._tileDebugSegments=Au.simpleSegment(0,0,It.length,Lt.length)}_makeGlobeTileDebugTextBuffer(Ye,ut,pt,wt,Tt,St){const It=ym/4,Lt=new Cl,$t=new Ql,Xt=new Rl,Sr=25;$t.reserve(32),Lt.reserve(Sr),Xt.reserve(Sr);const h=(Ye,ut)=>Sr*Ye+ut;for(let Ye=0;Ye<Sr;Ye++){const $t=Ye*It;for(let Ye=0;Ye<Sr;Ye++){const Sr=Ye*It;Lt.emplaceBack(Sr,$t);const Lr=this._globePoint(Sr,$t,ut,pt,wt,Tt,St);Xt.emplaceBack(Lr[0],Lr[1],Lr[2])}}for(let Ye=0;Ye<4;Ye++)for(let ut=0;ut<4;ut++){const pt=h(Ye,ut),wt=h(Ye,ut+1),Tt=h(Ye+1,ut),St=h(Ye+1,ut+1);$t.emplaceBack(pt,wt,Tt),$t.emplaceBack(Tt,wt,St)}this._tileDebugTextIndexBuffer=Ye.createIndexBuffer($t),this._tileDebugTextBuffer=Ye.createVertexBuffer(Lt,ty.members),this._globeTileDebugTextBuffer=Ye.createVertexBuffer(Xt,Jg.members),this._tileDebugTextSegments=Au.simpleSegment(0,0,Sr,32)}destroy(Ye=!1){for(const Ye in this.buckets)this.buckets[Ye].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!Ye&&this.texture&&this.texture instanceof Gg&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}function ix(Ye,ut,pt){1===Ye?ut.header_length=pt.readFixed32():2===Ye?ut.x=pt.readVarint():3===Ye?ut.y=pt.readVarint():4===Ye?ut.z=pt.readVarint():5===Ye&&ut.layers.push(function(Ye,ut){return Ye.readFields(ux,{version:0,name:"",units:"",tilesize:0,buffer:0,pixel_format:0,data_index:[]},ut)}(pt,pt.readVarint()+pt.pos))}function sx(Ye,ut,pt){1===Ye?(ut.delta_filter=function(Ye,ut){return Ye.readFields(ax,{block_size:0},ut)}(pt,pt.readVarint()+pt.pos),ut.filter="delta_filter"):2===Ye?(pt.readVarint(),ut.filter="zigzag_filter"):3===Ye?(pt.readVarint(),ut.filter="bitshuffle_filter"):4===Ye&&(pt.readVarint(),ut.filter="byteshuffle_filter")}function ax(Ye,ut,pt){1===Ye&&(ut.block_size=pt.readVarint())}function ox(Ye,ut,pt){1===Ye?(pt.readVarint(),ut.codec="gzip_data"):2===Ye?(pt.readVarint(),ut.codec="jpeg_image"):3===Ye?(pt.readVarint(),ut.codec="webp_image"):4===Ye&&(pt.readVarint(),ut.codec="png_image")}function lx(Ye,ut,pt){1===Ye?ut.first_byte=pt.readFixed64():2===Ye?ut.last_byte=pt.readFixed64():3===Ye?ut.filters.push(function(Ye,ut){return Ye.readFields(sx,{},ut)}(pt,pt.readVarint()+pt.pos)):4===Ye?ut.codec=function(Ye,ut){return Ye.readFields(ox,{},ut)}(pt,pt.readVarint()+pt.pos):5===Ye?ut.offset=pt.readFloat():6===Ye?ut.scale=pt.readFloat():7===Ye&&ut.bands.push(pt.readString())}function ux(Ye,ut,pt){1===Ye?ut.version=pt.readVarint():2===Ye?ut.name=pt.readString():3===Ye?ut.units=pt.readString():4===Ye?ut.tilesize=pt.readVarint():5===Ye?ut.buffer=pt.readVarint():6===Ye?ut.pixel_format=pt.readVarint():7===Ye&&ut.data_index.push(function(Ye,ut){return Ye.readFields(lx,{first_byte:0,last_byte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},ut)}(pt,pt.readVarint()+pt.pos))}function cx(Ye,ut,pt){if(2===Ye)!function(Ye,ut,pt){Ye.readFields(hx,pt,ut)}(pt,pt.readVarint()+pt.pos,ut);else if(3===Ye)throw new Error("Not implemented")}function hx(Ye,ut,pt){if(1===Ye){let Ye=0;const wt=pt.readVarint()+pt.pos;for(;pt.pos<wt;)ut[Ye++]=pt.readVarint()}}
/**
     * tiny-lru
     *
     * @copyright 2024 Jason Mulligan <jason.mulligan@avoidwork.com>
     * @license BSD-3-Clause
     * @version 11.2.11
     */class px{constructor(Ye=0,ut=0,pt=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=Ye,this.resetTtl=pt,this.size=0,this.ttl=ut}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(Ye){if(this.has(Ye)){const ut=this.items[Ye];delete this.items[Ye],this.size--,null!==ut.prev&&(ut.prev.next=ut.next),null!==ut.next&&(ut.next.prev=ut.prev),this.first===ut&&(this.first=ut.next),this.last===ut&&(this.last=ut.prev)}return this}entries(Ye=this.keys()){return Ye.map((Ye=>[Ye,this.get(Ye)]))}evict(Ye=!1){if(Ye||this.size>0){const Ye=this.first;delete this.items[Ye.key],0==--this.size?(this.first=null,this.last=null):(this.first=Ye.next,this.first.prev=null)}return this}expiresAt(Ye){let ut;return this.has(Ye)&&(ut=this.items[Ye].expiry),ut}get(Ye){let ut;if(this.has(Ye)){const pt=this.items[Ye];this.ttl>0&&pt.expiry<=Date.now()?this.delete(Ye):(ut=pt.value,this.set(Ye,ut,!0))}return ut}has(Ye){return Ye in this.items}keys(){const Ye=[];let ut=this.first;for(;null!==ut;)Ye.push(ut.key),ut=ut.next;return Ye}set(Ye,ut,pt=!1,wt=this.resetTtl){let Tt;if(pt||this.has(Ye)){if(Tt=this.items[Ye],Tt.value=ut,!1===pt&&wt&&(Tt.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.last!==Tt){const Ye=this.last,ut=Tt.next,pt=Tt.prev;this.first===Tt&&(this.first=Tt.next),Tt.next=null,Tt.prev=this.last,Ye.next=Tt,null!==pt&&(pt.next=ut),null!==ut&&(ut.prev=pt)}}else this.max>0&&this.size===this.max&&this.evict(!0),Tt=this.items[Ye]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:Ye,prev:this.last,next:null,value:ut},1==++this.size?this.first=Tt:this.last.next=Tt;return this.last=Tt,this}values(Ye=this.keys()){return Ye.map((Ye=>this.get(Ye)))}}function fx(Ye,ut){if(4!==ut.length)throw new Error(`Expected data of dimension 4 but got ${ut.length}.`);let pt=ut[3];for(let wt=2;wt>=1;wt--){const Tt=1===wt?1:0,St=2===wt?1:0;for(let wt=0;wt<ut[0];wt++){const It=ut[1]*wt;for(let wt=Tt;wt<ut[1];wt++){const Tt=ut[2]*(wt+It);for(let wt=St;wt<ut[2];wt++){const St=ut[3]*(wt+Tt);for(let wt=0;wt<ut[3];wt++){const ut=St+wt;Ye[ut]+=Ye[ut-pt]}}}}pt*=ut[wt]}return Ye}function dx(Ye){for(let ut=0,pt=Ye.length;ut<pt;ut++)Ye[ut]=Ye[ut]>>>1^-(1&Ye[ut]);return Ye}function mx(Ye,ut){switch(ut){case"uint32":return Ye;case"uint16":for(let ut=0;ut<Ye.length;ut+=2){const pt=Ye[ut],wt=Ye[ut+1];Ye[ut]=(240&pt)>>4|(61440&pt)>>8|(240&wt)<<4|61440&wt,Ye[ut+1]=15&pt|(3840&pt)>>4|(15&wt)<<8|(3840&wt)<<4}return Ye;case"uint8":for(let ut=0;ut<Ye.length;ut+=4){const pt=Ye[ut],wt=Ye[ut+1],Tt=Ye[ut+2],St=Ye[ut+3];Ye[ut+0]=(192&pt)>>6|(192&wt)>>4|(192&Tt)>>2|192&St,Ye[ut+1]=(48&pt)>>4|(48&wt)>>2|48&Tt|(48&St)<<2,Ye[ut+2]=(12&pt)>>2|12&wt|(12&Tt)<<2|(12&St)<<4,Ye[ut+3]=3&pt|(3&wt)<<2|(3&Tt)<<4|(3&St)<<6}return Ye;default:throw new Error(`Invalid pixel format, "${ut}"`)}}class yx extends Error{constructor(Ye){super(Ye),this.name="MRTError"}}var Rw=Uint8Array,Lw=Uint16Array,kw=Int32Array,Ow=new Rw([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Bw=new Rw([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Fw=new Rw([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Mx=function(Ye,ut){for(var pt=new Lw(31),wt=0;wt<31;++wt)pt[wt]=ut+=1<<Ye[wt-1];var Tt=new kw(pt[30]);for(wt=1;wt<30;++wt)for(var St=pt[wt];St<pt[wt+1];++St)Tt[St]=St-pt[wt]<<5|wt;return{b:pt,r:Tt}},Nw=Mx(Ow,2),Vw=Nw.b,Uw=Nw.r;Vw[28]=258,Uw[258]=28;for(var jw=Mx(Bw,0).b,Gw=new Lw(32768),qw=0;qw<32768;++qw){var Zw=(43690&qw)>>1|(21845&qw)<<1;Gw[qw]=((65280&(Zw=(61680&(Zw=(52428&Zw)>>2|(13107&Zw)<<2))>>4|(3855&Zw)<<4))>>8|(255&Zw)<<8)>>1}var Ex=function(Ye,ut,pt){for(var wt=Ye.length,Tt=0,St=new Lw(ut);Tt<wt;++Tt)Ye[Tt]&&++St[Ye[Tt]-1];var It,Lt=new Lw(ut);for(Tt=1;Tt<ut;++Tt)Lt[Tt]=Lt[Tt-1]+St[Tt-1]<<1;if(pt){It=new Lw(1<<ut);var $t=15-ut;for(Tt=0;Tt<wt;++Tt)if(Ye[Tt])for(var Xt=Tt<<4|Ye[Tt],Sr=ut-Ye[Tt],Lr=Lt[Ye[Tt]-1]++<<Sr,Qr=Lr|(1<<Sr)-1;Lr<=Qr;++Lr)It[Gw[Lr]>>$t]=Xt}else for(It=new Lw(wt),Tt=0;Tt<wt;++Tt)Ye[Tt]&&(It[Tt]=Gw[Lt[Ye[Tt]-1]++]>>15-Ye[Tt]);return It},$w=new Rw(288);for(qw=0;qw<144;++qw)$w[qw]=8;for(qw=144;qw<256;++qw)$w[qw]=9;for(qw=256;qw<280;++qw)$w[qw]=7;for(qw=280;qw<288;++qw)$w[qw]=8;var Ww=new Rw(32);for(qw=0;qw<32;++qw)Ww[qw]=5;var Hw=Ex($w,9,1),Xw=Ex(Ww,5,1),Vx=function(Ye){for(var ut=Ye[0],pt=1;pt<Ye.length;++pt)Ye[pt]>ut&&(ut=Ye[pt]);return ut},Lx=function(Ye,ut,pt){var wt=ut/8|0;return(Ye[wt]|Ye[wt+1]<<8)>>(7&ut)&pt},Ox=function(Ye,ut){var pt=ut/8|0;return(Ye[pt]|Ye[pt+1]<<8|Ye[pt+2]<<16)>>(7&ut)},Yw=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ux=function(Ye,ut,pt){var wt=new Error(ut||Yw[Ye]);if(wt.code=Ye,Error.captureStackTrace&&Error.captureStackTrace(wt,Ux),!pt)throw wt;return wt},Kw=new Rw(0),Jw="undefined"!=typeof TextDecoder&&new TextDecoder;try{Jw.decode(Kw,{stream:!0})}catch(Ye){}const Qw={gzip_data:"gzip"};const eT={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},tT={uint32:1,uint16:2,uint8:4},iT={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};class Xx{constructor(Ye=1){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=Ye}getLayer(Ye){return this.layers[Ye]}getHeaderLength(Ye){const ut=new Uint8Array(Ye),pt=new DataView(Ye);if(13!==ut[0])throw new yx("File is not a valid MRT.");return pt.getUint32(1,!0)}parseHeader(Ye){const ut=new Uint8Array(Ye),pt=this.getHeaderLength(Ye);if(ut.length<pt)throw new yx(`Expected header with length >= ${pt} but got buffer of length ${ut.length}`);const wt=function(Ye,ut){return Ye.readFields(ix,{header_length:0,x:0,y:0,z:0,layers:[]},void 0)}(new Lb(ut.subarray(0,pt)));if(!isNaN(this.x)&&(this.x!==wt.x||this.y!==wt.y||this.z!==wt.z))throw new yx(`Invalid attempt to parse header ${wt.z}/${wt.x}/${wt.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=wt.x,this.y=wt.y,this.z=wt.z;for(const Ye of wt.layers)this.layers[Ye.name]=new Zx(Ye,{cacheSize:this._cacheSize});return this}createDecodingTask(Ye){const ut=[],pt=this.getLayer(Ye.layerName);for(let wt=0;wt<pt.dataIndex.length;wt++){const Tt=pt.dataIndex[wt],St=Tt.first_byte-Ye.firstByte,It=Tt.last_byte+1-Ye.firstByte;if(wt<Ye.firstBlock||wt>Ye.lastBlock)continue;if(pt._blocksInProgress.has(wt))continue;const Lt={layerName:pt.name,firstByte:St,lastByte:It,pixelFormat:pt.pixelFormat,blockIndex:wt,blockShape:[Tt.bands.length].concat(pt.bandShape),buffer:pt.buffer,codec:Tt.codec.codec,filters:Tt.filters.map((Ye=>Ye.filter))};pt._blocksInProgress.add(wt),ut.push(Lt)}return new Hx(ut,(()=>{ut.forEach((Ye=>pt._blocksInProgress.delete(Ye.blockIndex)))}),((Ye,wt)=>{if(ut.forEach((Ye=>pt._blocksInProgress.delete(Ye.blockIndex))),Ye)throw Ye;wt.forEach((Ye=>{this.getLayer(Ye.layerName).processDecodedData(Ye)}))}))}}class Zx{constructor({version:Ye,name:ut,units:pt,tilesize:wt,pixel_format:Tt,buffer:St,data_index:It},Lt){if(this.version=Ye,1!==this.version)throw new yx(`Cannot parse raster layer encoded with MRT version ${Ye}`);this.name=ut,this.units=pt,this.tileSize=wt,this.buffer=St,this.pixelFormat=eT[Tt],this.dataIndex=It,this.bandShape=[wt+2*St,wt+2*St,tT[this.pixelFormat]],this._decodedBlocks=function(Ye=1e3,ut=0,pt=!1){if(isNaN(Ye)||Ye<0)throw new TypeError("Invalid max value");if(isNaN(ut)||ut<0)throw new TypeError("Invalid ttl value");if("boolean"!=typeof pt)throw new TypeError("Invalid resetTtl value");return new px(Ye,ut,pt)}(Lt?Lt.cacheSize:5),this._blocksInProgress=new Set}processDecodedData(Ye){const ut=Ye.blockIndex.toString();this._decodedBlocks.get(ut)||this._decodedBlocks.set(ut,Ye.data)}getBlockForBand(Ye){let ut=0;switch(typeof Ye){case"string":for(const[pt,wt]of this.dataIndex.entries()){for(const[Tt,St]of wt.bands.entries())if(St===Ye)return{bandIndex:ut+Tt,blockIndex:pt,blockBandIndex:Tt};ut+=wt.bands.length}break;case"number":for(const[pt,wt]of this.dataIndex.entries()){if(Ye>=ut&&Ye<ut+wt.bands.length)return{bandIndex:Ye,blockIndex:pt,blockBandIndex:Ye-ut};ut+=wt.bands.length}break;default:throw new yx(`Invalid band \`${JSON.stringify(Ye)}\`. Expected string or integer.`)}throw new yx(`Band not found: ${JSON.stringify(Ye)}`)}getDataRange(Ye){let ut=1/0,pt=-1/0,wt=1/0,Tt=-1/0;for(const St of Ye){const{blockIndex:Ye}=this.getBlockForBand(St);if(Ye<0)throw new yx(`Invalid band: ${JSON.stringify(St)}`);const It=this.dataIndex[Ye];wt=Math.min(wt,Ye),Tt=Math.max(Tt,Ye),ut=Math.min(ut,It.first_byte),pt=Math.max(pt,It.last_byte)}return{layerName:this.name,firstByte:ut,lastByte:pt,firstBlock:wt,lastBlock:Tt}}hasBand(Ye){const{blockIndex:ut}=this.getBlockForBand(Ye);return ut>=0}hasDataForBand(Ye){const{blockIndex:ut}=this.getBlockForBand(Ye);return ut>=0&&!!this._decodedBlocks.get(ut.toString())}getBandView(Ye){const{blockIndex:ut,blockBandIndex:pt}=this.getBlockForBand(Ye),wt=this._decodedBlocks.get(ut.toString());if(!wt)throw new yx(`Data for band ${JSON.stringify(Ye)} of layer "${this.name}" not decoded.`);const Tt=this.dataIndex[ut],St=this.bandShape.reduce(((Ye,ut)=>Ye*ut),1),It=pt*St,Lt=wt.subarray(It,It+St);return{data:Lt,bytes:new Uint8Array(Lt.buffer).subarray(Lt.byteOffset,Lt.byteOffset+Lt.byteLength),tileSize:this.tileSize,buffer:this.buffer,offset:Tt.offset,scale:Tt.scale}}}class Hx{constructor(Ye,ut,pt){this.tasks=Ye,this._onCancel=ut,this._onComplete=pt,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(Ye,ut){this._finalized||(this._onComplete(Ye,ut),this._finalized=!0)}}Xx.performDecoding=function(Ye,ut){return Promise.all(ut.tasks.map((ut=>{const{layerName:pt,firstByte:wt,lastByte:Tt,pixelFormat:St,blockShape:It,blockIndex:Lt,filters:$t,codec:Xt}=ut,Sr=new Uint8Array(Ye).subarray(wt,Tt+1),Lr=new Uint32Array(It[0]*It[1]*It[2]);let Qr;if("gzip_data"!==Xt)throw new Error(`Unhandled codec: ${Xt}`);return Qr=function(Ye,ut){if(!globalThis.DecompressionStream&&"gzip_data"===ut)return Promise.resolve(((St=function(Ye){31==Ye[0]&&139==Ye[1]&&8==Ye[2]||Ux(6,"invalid gzip data");var ut=Ye[3],pt=10;4&ut&&(pt+=2+(Ye[10]|Ye[11]<<8));for(var wt=(ut>>3&1)+(ut>>4&1);wt>0;wt-=!Ye[pt++]);return pt+(2&ut)}(Tt=Ye))+8>Tt.length&&Ux(6,"invalid gzip data"),function(Ye,ut,pt,wt){var Tt=Ye.length;if(!Tt||ut.f&&!ut.l)return pt||new Rw(0);var St=!pt,It=St||2!=ut.i,Lt=ut.i;St&&(pt=new Rw(3*Tt));var $t,Xt,c=function(Ye){var ut=pt.length;if(Ye>ut){var wt=new Rw(Math.max(2*ut,Ye));wt.set(pt),pt=wt}},Sr=ut.f||0,Lr=ut.p||0,Qr=ut.b||0,fn=ut.l,xn=ut.d,vn=ut.m,kn=ut.n,Wn=8*Tt;do{if(!fn){Sr=Lx(Ye,Lr,1);var Xn=Lx(Ye,Lr+1,3);if(Lr+=3,!Xn){var Jn=Ye[(Js=4+((Lr+7)/8|0))-4]|Ye[Js-3]<<8,Qn=Js+Jn;if(Qn>Tt){Lt&&Ux(0);break}It&&c(Qr+Jn),pt.set(Ye.subarray(Js,Qn),Qr),ut.b=Qr+=Jn,ut.p=Lr=8*Qn,ut.f=Sr;continue}if(1==Xn)fn=Hw,xn=Xw,vn=9,kn=5;else if(2==Xn){var ko=Lx(Ye,Lr,31)+257,Fo=Lx(Ye,Lr+10,15)+4,is=ko+Lx(Ye,Lr+5,31)+1;Lr+=14;for(var ns=new Rw(is),ss=new Rw(19),as=0;as<Fo;++as)ss[Fw[as]]=Lx(Ye,Lr+3*as,7);Lr+=3*Fo;var ds=Vx(ss),ps=(1<<ds)-1,ms=Ex(ss,ds,1);for(as=0;as<is;){var Js,ua=ms[Lx(Ye,Lr,ps)];if(Lr+=15&ua,(Js=ua>>4)<16)ns[as++]=Js;else{var ba=0,Ra=0;for(16==Js?(Ra=3+Lx(Ye,Lr,3),Lr+=2,ba=ns[as-1]):17==Js?(Ra=3+Lx(Ye,Lr,7),Lr+=3):18==Js&&(Ra=11+Lx(Ye,Lr,127),Lr+=7);Ra--;)ns[as++]=ba}}var La=ns.subarray(0,ko),ll=ns.subarray(ko);vn=Vx(La),kn=Vx(ll),fn=Ex(La,vn,1),xn=Ex(ll,kn,1)}else Ux(1);if(Lr>Wn){Lt&&Ux(0);break}}It&&c(Qr+131072);for(var yl=(1<<vn)-1,Tl=(1<<kn)-1,Al=Lr;;Al=Lr){var Il=(ba=fn[Ox(Ye,Lr)&yl])>>4;if((Lr+=15&ba)>Wn){Lt&&Ux(0);break}if(ba||Ux(2),Il<256)pt[Qr++]=Il;else{if(256==Il){Al=Lr,fn=null;break}var Pl=Il-254;Il>264&&(Pl=Lx(Ye,Lr,(1<<(ic=Ow[as=Il-257]))-1)+Vw[as],Lr+=ic);var ec=xn[Ox(Ye,Lr)&Tl],tc=ec>>4;if(ec||Ux(3),Lr+=15&ec,ll=jw[tc],tc>3){var ic=Bw[tc];ll+=Ox(Ye,Lr)&(1<<ic)-1,Lr+=ic}if(Lr>Wn){Lt&&Ux(0);break}It&&c(Qr+131072);var nc=Qr+Pl;if(Qr<ll){var oc=0-ll,sc=Math.min(ll,nc);for(oc+Qr<0&&Ux(3);Qr<sc;++Qr)pt[Qr]=(void 0)[oc+Qr]}for(;Qr<nc;++Qr)pt[Qr]=pt[Qr-ll]}}ut.l=fn,ut.p=Al,ut.b=Qr,ut.f=Sr,fn&&(Sr=1,ut.m=vn,ut.d=xn,ut.n=kn)}while(!Sr);return Qr!=pt.length&&St?($t=pt,(null==(Xt=Qr)||Xt>$t.length)&&(Xt=$t.length),new Rw($t.subarray(0,Xt))):pt.subarray(0,Qr)}(Tt.subarray(St,-8),{i:2},new Rw(((pt=Tt)[(wt=pt.length)-4]|pt[wt-3]<<8|pt[wt-2]<<16|pt[wt-1]<<24)>>>0))));var pt,wt,Tt,St;const It=Qw[ut];if(!It)throw new Error(`Unhandled codec: ${ut}`);const Lt=new globalThis.DecompressionStream(It);return new Response(new Blob([Ye]).stream().pipeThrough(Lt)).arrayBuffer().then((Ye=>new Uint8Array(Ye)))}(Sr,Xt).then((Ye=>(function(Ye,ut){Ye.readFields(cx,ut)}(new Lb(Ye),Lr),new(0,iT[St])(Lr.buffer)))),Qr.then((Ye=>{for(let ut=$t.length-1;ut>=0;ut--)switch($t[ut]){case"delta_filter":fx(Ye,It);break;case"zigzag_filter":dx(Ye);break;case"bitshuffle_filter":mx(Ye,St);break;default:throw new Error(`Unhandled filter "${$t[ut]}"`)}return{layerName:pt,blockIndex:Lt,data:Ye}})).catch((Ye=>{throw Ye}))})))};class Kx extends nx{constructor(Ye,ut,pt,wt,Tt){super(Ye,ut,pt,wt,Tt),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(Ye,ut){const pt=ut.context,wt=pt.gl;this.texture=this.texture||ut.getTileTexture(Ye.width),this.texture&&this.texture instanceof Gg?this.texture.update(Ye,{useMipmap:!1,premultiply:!1}):this.texture=new Gg(pt,Ye,wt.RGBA,{useMipmap:!1,premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(Ye=16384,ut){const pt=this._mrt=new Xx(30),wt=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(Ye-1)}});return this.entireBuffer=null,this.request=en(wt,((wt,Tt,St,It)=>{if(wt)ut(wt);else try{const wt=pt.getHeaderLength(Tt);if(wt>Ye)return void(this.request=this.fetchHeader(wt,ut));pt.parseHeader(Tt),this._isHeaderLoaded=!0;let Lt=0;for(const Ye of Object.values(pt.layers))Lt=Math.max(Lt,Ye.dataIndex[Ye.dataIndex.length-1].last_byte);Tt.byteLength>=Lt&&(this.entireBuffer=Tt),ut(null,this.entireBuffer||Tt,St,It)}catch(Ye){ut(Ye)}})),this.request}fetchBand(Ye,ut,pt){const wt=this._mrt;if(!this._isHeaderLoaded||!wt)return void pt(new Error("Tile header is not ready"));const Tt=this.actor;if(!Tt)return void pt(new Error("Can't fetch tile band without an actor"));let St;const a=(wt,Tt)=>{St.complete(wt,Tt),wt?pt(wt):(this.updateTextureDescriptor(Ye,ut),pt(null,this.textureDescriptor&&this.textureDescriptor.img))},o=(Ye,ut)=>{if(Ye)return pt(Ye);const wt=Tt.send("decodeRasterArray",{buffer:ut,task:St},a,void 0,!0);this._workQueue.push((()=>{wt&&wt.cancel(),St.cancel()}))},It=wt.getLayer(Ye);if(!It)return void pt(new Error(`Unknown sourceLayer "${Ye}"`));if(It.hasDataForBand(ut))return this.updateTextureDescriptor(Ye,ut),void pt(null,this.textureDescriptor?this.textureDescriptor.img:null);const Lt=It.getDataRange([ut]);if(St=wt.createDecodingTask(Lt),!St||St.tasks.length)if(this.flushQueues(),this.entireBuffer)o(null,this.entireBuffer.slice(Lt.firstByte,Lt.lastByte+1));else{const Ye=Object.assign({},this.requestParams,{headers:{Range:`bytes=${Lt.firstByte}-${Lt.lastByte}`}}),ut=en(Ye,o);this._fetchQueue.push((()=>{ut.cancel(),St.cancel()}))}else pt(null)}updateNeeded(Ye,ut){return(!this.textureDescriptor||this.textureDescriptor.band!==ut||this.textureDescriptor.layer!==Ye)&&"errored"!==this.state}updateTextureDescriptor(Ye,ut){if(!this._mrt)return;const pt=this._mrt.getLayer(Ye);if(!pt||!pt.hasBand(ut)||!pt.hasDataForBand(ut))return;const{bytes:wt,tileSize:Tt,buffer:St,offset:It,scale:Lt}=pt.getBandView(ut),$t=Tt+2*St,Xt={data:wt,width:$t,height:$t},Sr=this.texture;Sr&&Sr instanceof Gg&&Sr.update(Xt,{useMipmap:!1,premultiply:!1}),this.textureDescriptor={layer:Ye,band:ut,img:Xt,buffer:St,offset:It,tileSize:Tt,format:pt.pixelFormat,mix:[Lt,256*Lt,65536*Lt,16777216*Lt]}}}class Wx{constructor(Ye,ut){this.max=Ye,this.onRemove=ut,this.reset()}reset(){for(const Ye in this.data)for(const ut of this.data[Ye])ut.timeout&&clearTimeout(ut.timeout),this.onRemove(ut.value);return this.data={},this.order=[],this}add(Ye,ut,pt){const wt=Ye.wrapped().key;void 0===this.data[wt]&&(this.data[wt]=[]);const Tt={value:ut,timeout:void 0};if(void 0!==pt&&(Tt.timeout=setTimeout((()=>{this.remove(Ye,Tt)}),pt)),this.data[wt].push(Tt),this.order.push(wt),this.order.length>this.max){const Ye=this._getAndRemoveByKey(this.order[0]);Ye&&this.onRemove(Ye)}return this}has(Ye){return Ye.wrapped().key in this.data}getAndRemove(Ye){return this.has(Ye)?this._getAndRemoveByKey(Ye.wrapped().key):null}_getAndRemoveByKey(Ye){const ut=this.data[Ye].shift();return ut.timeout&&clearTimeout(ut.timeout),0===this.data[Ye].length&&delete this.data[Ye],this.order.splice(this.order.indexOf(Ye),1),ut.value}getByKey(Ye){const ut=this.data[Ye];return ut?ut[0].value:null}get(Ye){return this.has(Ye)?this.data[Ye.wrapped().key][0].value:null}remove(Ye,ut){if(!this.has(Ye))return this;const pt=Ye.wrapped().key,wt=void 0===ut?0:this.data[pt].indexOf(ut),Tt=this.data[pt][wt];return this.data[pt].splice(wt,1),Tt.timeout&&clearTimeout(Tt.timeout),0===this.data[pt].length&&delete this.data[pt],this.onRemove(Tt.value),this.order.splice(this.order.indexOf(pt),1),this}setMaxSize(Ye){for(this.max=Ye;this.order.length>this.max;){const Ye=this._getAndRemoveByKey(this.order[0]);Ye&&this.onRemove(Ye)}return this}filter(Ye){const ut=[];for(const pt in this.data)for(const wt of this.data[pt])Ye(wt.value)||ut.push(wt);for(const Ye of ut)this.remove(Ye.value.tileID,Ye)}}class Jx extends Ln{constructor(Ye,ut,pt){super(),this.id=Ye,this._onlySymbols=pt,ut.on("data",(Ye=>{"source"===Ye.dataType&&"metadata"===Ye.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===Ye.dataType&&"content"===Ye.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),ut.on("error",(()=>{this._sourceErrored=!0})),this._source=ut,this._tiles={},this._cache=new Wx(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=ut.minTileCacheSize,this._maxTileCacheSize=ut.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Rm,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(Ye){this.map=Ye,this._minTileCacheSize=void 0===this._minTileCacheSize&&Ye?Ye._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&Ye?Ye._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const Ye in this._tiles){const ut=this._tiles[Ye];if("errored"!==ut.state&&("loaded"!==ut.state||!ut.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const Ye=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,Ye&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(Ye,ut){return Ye.isSymbolTile=this._onlySymbols,Ye.isExtraShadowCaster=this._shadowCasterTiles[Ye.tileID.key],this._source.loadTile(Ye,ut)}_unloadTile(Ye){if(this._source.unloadTile)return this._source.unloadTile(Ye)}_abortTile(Ye){if(this._source.abortTile)return this._source.abortTile(Ye)}serialize(){return this._source.serialize()}prepare(Ye){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const ut in this._tiles){const pt=this._tiles[ut];pt.upload(Ye),pt.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return tr(this._tiles).map((Ye=>Ye.tileID)).sort(Qx).map((Ye=>Ye.key))}getRenderableIds(Ye,ut){const pt=[];for(const wt in this._tiles)this._isIdRenderable(+wt,Ye,ut)&&pt.push(this._tiles[wt]);return Ye?pt.sort(((Ye,ut)=>{const pt=Ye.tileID,wt=ut.tileID,Tt=new wu(pt.canonical.x,pt.canonical.y)._rotate(this.transform.angle),St=new wu(wt.canonical.x,wt.canonical.y)._rotate(this.transform.angle);return pt.overscaledZ-wt.overscaledZ||St.y-Tt.y||St.x-Tt.x})).map((Ye=>Ye.tileID.key)):pt.map((Ye=>Ye.tileID)).sort(Qx).map((Ye=>Ye.key))}hasRenderableParent(Ye){const ut=this.findLoadedParent(Ye,0);return!!ut&&this._isIdRenderable(ut.tileID.key)}_isIdRenderable(Ye,ut,pt){return this._tiles[Ye]&&this._tiles[Ye].hasData()&&!this._coveredTiles[Ye]&&(ut||!this._tiles[Ye].holdingForFade())&&(pt||!this._shadowCasterTiles[Ye])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const Ye in this._tiles)"errored"!==this._tiles[Ye].state&&this._reloadTile(+Ye,"reloading")}}_reloadTile(Ye,ut){const pt=this._tiles[Ye];pt&&("loading"!==pt.state&&(pt.state=ut),this._loadTile(pt,this._tileLoaded.bind(this,pt,Ye,ut)))}_tileLoaded(Ye,ut,pt,wt){if(wt)if(Ye.state="errored",404!==wt.status)this._source.fire(new Cn(wt,{tile:Ye}));else{if(!(Ye.tileID.key in this._loadedParentTiles))return void this._source.fire(new Dn("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const Ye=this.map.painter.terrain;this.update(this.transform,Ye.getScaledDemTileSize(),!0),Ye.resetTileLookupCache(this.id)}else this.update(this.transform)}else Ye.timeAdded=sd.now(),"expired"===pt&&(Ye.refreshedUponExpiration=!0),this._setTileReloadTimer(ut,Ye),"raster-dem"===this._source.type&&Ye.dem&&this._backfillDEM(Ye),this._state.initializeTileState(Ye,this.map?this.map.painter:null),this._source.fire(new Dn("data",{dataType:"source",tile:Ye,coord:Ye.tileID,sourceCacheId:this.id}))}_backfillDEM(Ye){const ut=this.getRenderableIds();for(let pt=0;pt<ut.length;pt++){const wt=ut[pt];if(Ye.neighboringTiles&&Ye.neighboringTiles[wt]){const ut=this.getTileByID(wt);r(Ye,ut),r(ut,Ye)}}function r(Ye,ut){if(!Ye.dem||Ye.dem.borderReady)return;Ye.needsHillshadePrepare=!0,Ye.needsDEMTextureUpload=!0;let pt=ut.tileID.canonical.x-Ye.tileID.canonical.x;const wt=ut.tileID.canonical.y-Ye.tileID.canonical.y,Tt=Math.pow(2,Ye.tileID.canonical.z),St=ut.tileID.key;0===pt&&0===wt||Math.abs(wt)>1||(Math.abs(pt)>1&&(1===Math.abs(pt+Tt)?pt+=Tt:1===Math.abs(pt-Tt)&&(pt-=Tt)),ut.dem&&Ye.dem&&(Ye.dem.backfillBorder(ut.dem,pt,wt),Ye.neighboringTiles&&Ye.neighboringTiles[St]&&(Ye.neighboringTiles[St].backfilled=!0)))}}getTile(Ye){return this.getTileByID(Ye.key)}getTileByID(Ye){return this._tiles[Ye]}_retainLoadedChildren(Ye,ut,pt,wt){for(const Tt in this._tiles){let St=this._tiles[Tt];if(wt[Tt]||!St.hasData()||St.tileID.overscaledZ<=ut||St.tileID.overscaledZ>pt)continue;let It=St.tileID;for(;St&&St.tileID.overscaledZ>ut+1;){const Ye=St.tileID.scaledTo(St.tileID.overscaledZ-1);St=this._tiles[Ye.key],St&&St.hasData()&&(It=Ye)}let Lt=It;for(;Lt.overscaledZ>ut;)if(Lt=Lt.scaledTo(Lt.overscaledZ-1),Ye[Lt.key]){wt[It.key]=It;break}}}findLoadedParent(Ye,ut){if(Ye.key in this._loadedParentTiles){const pt=this._loadedParentTiles[Ye.key];return pt&&pt.tileID.overscaledZ>=ut?pt:null}for(let pt=Ye.overscaledZ-1;pt>=ut;pt--){const ut=Ye.scaledTo(pt),wt=this._getLoadedTile(ut);if(wt)return wt}}_getLoadedTile(Ye){const ut=this._tiles[Ye.key];return ut&&ut.hasData()?ut:this._cache.getByKey(this._source.reparseOverscaled?Ye.wrapped().key:Ye.canonical.key)}updateCacheSize(Ye,ut){ut=ut||this._source.tileSize;const pt=Math.ceil(Ye.width/ut)+1,wt=Math.ceil(Ye.height/ut)+1,Tt=Math.floor(pt*wt*5),St="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,Tt):Tt,It="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,St):St;this._cache.setMaxSize(It)}handleWrapJump(Ye){const ut=Math.round((Ye-(void 0===this._prevLng?Ye:this._prevLng))/360);if(this._prevLng=Ye,ut){const Ye={};for(const pt in this._tiles){const wt=this._tiles[pt];wt.tileID=wt.tileID.unwrapTo(wt.tileID.wrap+ut),Ye[wt.tileID.key]=wt}this._tiles=Ye;for(const Ye in this._timers)clearTimeout(this._timers[Ye]),delete this._timers[Ye];for(const Ye in this._tiles)this._setTileReloadTimer(+Ye,this._tiles[Ye])}}update(Ye,ut,pt,wt){if(this.transform=Ye,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!pt)return;let Tt;if(this.updateCacheSize(Ye,ut),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain){if(this._source.tileID)Tt=Ye.getVisibleUnwrappedCoordinates(this._source.tileID).map((Ye=>new _c(Ye.canonical.z,Ye.wrap,Ye.canonical.z,Ye.canonical.x,Ye.canonical.y)));else if(0!==this.tileCoverLift){const wt=Ye.clone();wt.tileCoverLift=this.tileCoverLift,Tt=wt.coveringTiles({tileSize:ut||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!pt,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.minzoom<=1&&"globe"===Ye.projection.name&&(Tt.push(new _c(1,0,1,0,0)),Tt.push(new _c(1,0,1,1,0)),Tt.push(new _c(1,0,1,0,1)),Tt.push(new _c(1,0,1,1,1)))}else if(Tt=Ye.coveringTiles({tileSize:ut||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!pt,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile){const Ye=this._source.hasTile.bind(this._source);Tt=Tt.filter((ut=>Ye(ut)))}}else Tt=[];if(Tt.length>0&&this.castsShadows&&wt&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!tb(this._source.type)){const St=Ye.coveringZoomLevel({tileSize:ut||this._source.tileSize,roundZoom:this._source.roundZoom&&!pt}),It=Math.min(St,this._source.maxzoom),Lt=Ye.extendTileCoverForShadows(Tt,wt,It);for(const Ye of Lt)this._shadowCasterTiles[Ye.key]=!0,Tt.push(Ye)}const St=this._updateRetainedTiles(Tt);if(tb(this._source.type)&&0!==Tt.length){const Ye={},ut={},pt=Object.keys(St);for(const wt of pt){const pt=St[wt],Tt=this._tiles[wt];if(!Tt||Tt.fadeEndTime&&Tt.fadeEndTime<=sd.now())continue;const It=this.findLoadedParent(pt,Math.max(pt.overscaledZ-Jx.maxOverzooming,this._source.minzoom));It&&(this._addTile(It.tileID),Ye[It.tileID.key]=It.tileID),ut[wt]=pt}const wt=Tt[Tt.length-1].overscaledZ;for(const Ye in this._tiles){const pt=this._tiles[Ye];if(St[Ye]||!pt.hasData())continue;let Tt=pt.tileID;for(;Tt.overscaledZ>wt;){Tt=Tt.scaledTo(Tt.overscaledZ-1);const wt=this._tiles[Tt.key];if(wt&&wt.hasData()&&ut[Tt.key]){St[Ye]=pt.tileID;break}}}for(const ut in Ye)St[ut]||(this._coveredTiles[ut]=!0,St[ut]=Ye[ut])}for(const Ye in St)this._tiles[Ye].clearFadeHold();const It=function(Ye,ut){const pt=[];for(const wt in Ye)wt in ut||pt.push(wt);return pt}(this._tiles,St);for(const Ye of It){const ut=this._tiles[Ye];ut.hasSymbolBuckets&&!ut.holdingForFade()?ut.setHoldDuration(this.map._fadeDuration):ut.hasSymbolBuckets&&!ut.symbolFadeFinished()||this._removeTile(+Ye)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const Ye in this._tiles)this._tiles[Ye].holdingForFade()&&this._removeTile(+Ye)}_updateRetainedTiles(Ye){const ut={};if(0===Ye.length)return ut;const pt={},wt=Ye.reduce(((Ye,ut)=>Math.min(Ye,ut.overscaledZ)),1/0),Tt=Ye[0].overscaledZ,St=Math.max(Tt-Jx.maxOverzooming,this._source.minzoom),It=Math.max(Tt+Jx.maxUnderzooming,this._source.minzoom),Lt={};for(const pt of Ye){const Ye=this._addTile(pt);ut[pt.key]=pt,Ye.hasData()||wt<this._source.maxzoom&&(Lt[pt.key]=pt)}this._retainLoadedChildren(Lt,wt,It,ut);for(const wt of Ye){let Ye=this._tiles[wt.key];if(Ye.hasData())continue;if(wt.canonical.z>=this._source.maxzoom){const Ye=wt.children(this._source.maxzoom)[0],pt=this.getTile(Ye);if(pt&&pt.hasData()){ut[Ye.key]=Ye;continue}}else{const Ye=wt.children(this._source.maxzoom);if(ut[Ye[0].key]&&ut[Ye[1].key]&&ut[Ye[2].key]&&ut[Ye[3].key])continue}let Tt=Ye.wasRequested();for(let It=wt.overscaledZ-1;It>=St;--It){const St=wt.scaledTo(It);if(pt[St.key])break;if(pt[St.key]=!0,Ye=this.getTile(St),!Ye&&Tt&&(Ye=this._addTile(St)),Ye&&(ut[St.key]=St,Tt=Ye.wasRequested(),Ye.hasData()))break}}return ut}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const Ye in this._tiles){const ut=[];let pt,wt=this._tiles[Ye].tileID;for(;wt.overscaledZ>0;){if(wt.key in this._loadedParentTiles){pt=this._loadedParentTiles[wt.key];break}ut.push(wt.key);const Ye=wt.scaledTo(wt.overscaledZ-1);if(pt=this._getLoadedTile(Ye),pt)break;wt=Ye}for(const Ye of ut)this._loadedParentTiles[Ye]=pt}}_addTile(Ye){let ut=this._tiles[Ye.key];if(ut)return!0!==ut.isExtraShadowCaster||!!this._shadowCasterTiles[Ye.key]||this._reloadTile(Ye.key,"reloading"),ut;ut=this._cache.getAndRemove(Ye),ut&&(this._setTileReloadTimer(Ye.key,ut),ut.tileID=Ye,this._state.initializeTileState(ut,this.map?this.map.painter:null),this._cacheTimers[Ye.key]&&(clearTimeout(this._cacheTimers[Ye.key]),delete this._cacheTimers[Ye.key],this._setTileReloadTimer(Ye.key,ut)));const pt=Boolean(ut);if(!pt){const pt=this.map?this.map.painter:null,wt=this._source.tileSize*Ye.overscaleFactor();ut="raster-array"===this._source.type?new Kx(Ye,wt,this.transform.tileZoom,pt,this._isRaster):new nx(Ye,wt,this.transform.tileZoom,pt,this._isRaster),this._loadTile(ut,this._tileLoaded.bind(this,ut,Ye.key,ut.state))}return ut?(ut.uses++,this._tiles[Ye.key]=ut,pt||this._source.fire(new Dn("dataloading",{tile:ut,coord:ut.tileID,dataType:"source"})),ut):null}_setTileReloadTimer(Ye,ut){Ye in this._timers&&(clearTimeout(this._timers[Ye]),delete this._timers[Ye]);const pt=ut.getExpiryTimeout();pt&&(this._timers[Ye]=setTimeout((()=>{this._reloadTile(Ye,"expired"),delete this._timers[Ye]}),pt))}_removeTile(Ye){const ut=this._tiles[Ye];ut&&(ut.uses--,delete this._tiles[Ye],this._timers[Ye]&&(clearTimeout(this._timers[Ye]),delete this._timers[Ye]),ut.uses>0||(ut.hasData()&&"reloading"!==ut.state||"empty"===ut.state?this._cache.add(ut.tileID,ut,ut.getExpiryTimeout()):(ut.aborted=!0,this._abortTile(ut),this._unloadTile(ut))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const Ye in this._tiles)this._removeTile(+Ye);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(Ye,ut,pt){const wt=[],Tt=this.transform;if(!Tt)return wt;const St="globe"===Tt.projection.name,It=Tc(Tt.center.lng);for(const Lt in this._tiles){const $t=this._tiles[Lt];if(pt&&$t.clearQueryDebugViz(),$t.holdingForFade())continue;let Xt;if(St){const Ye=$t.tileID.canonical;if(0===Ye.z){const ut=[Math.abs(Ke(It,...eb(Ye,-1))-It),Math.abs(Ke(It,...eb(Ye,1))-It)];Xt=[0,2*ut.indexOf(Math.min(...ut))-1]}else{const ut=[Math.abs(Ke(It,...eb(Ye,-1))-It),Math.abs(Ke(It,...eb(Ye,0))-It),Math.abs(Ke(It,...eb(Ye,1))-It)];Xt=[ut.indexOf(Math.min(...ut))-1]}}else Xt=[0];for(const pt of Xt){const St=Ye.containsTile($t,Tt,ut,pt);St&&wt.push(St)}}return wt}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(Ye){return this._getRenderableCoordinates(Ye)}_getRenderableCoordinates(Ye,ut){const pt=this.getRenderableIds(Ye,ut).map((Ye=>this._tiles[Ye].tileID)),wt="globe"===this.transform.projection.name;for(const Ye of pt)Ye.projMatrix=this.transform.calculateProjMatrix(Ye.toUnwrapped()),Ye.expandedProjMatrix=wt?this.transform.calculateProjMatrix(Ye.toUnwrapped(),!1,!0):Ye.projMatrix;return pt}sortCoordinatesByDistance(Ye){const ut=Ye.slice(),pt=this.transform._camera.position,wt=this.transform._camera.forward(),Tt={};for(const Ye of ut){const ut=1/(1<<Ye.canonical.z);Tt[Ye.key]=((Ye.canonical.x+.5)*ut+Ye.wrap-pt[0])*wt[0]+((Ye.canonical.y+.5)*ut-pt[1])*wt[1]-pt[2]*wt[2]}return ut.sort(((Ye,ut)=>Tt[Ye.key]-Tt[ut.key])),ut}hasTransition(){if(this._source.hasTransition())return!0;if(tb(this._source.type))for(const Ye in this._tiles){const ut=this._tiles[Ye];if(void 0!==ut.fadeEndTime&&ut.fadeEndTime>=sd.now())return!0}return!1}setFeatureState(Ye,ut,pt){this._state.updateState(Ye=Ye||"_geojsonTileLayer",ut,pt)}removeFeatureState(Ye,ut,pt){this._state.removeFeatureState(Ye=Ye||"_geojsonTileLayer",ut,pt)}getFeatureState(Ye,ut){return this._state.getState(Ye=Ye||"_geojsonTileLayer",ut)}setDependencies(Ye,ut,pt){const wt=this._tiles[Ye];wt&&wt.setDependencies(ut,pt)}reloadTilesForDependencies(Ye,ut){for(const pt in this._tiles)this._tiles[pt].hasDependency(Ye,ut)&&this._reloadTile(+pt,"reloading");this._cache.filter((pt=>!pt.hasDependency(Ye,ut)))}_preloadTiles(Ye,ut){if(!this._sourceLoaded){const r=()=>{this._sourceLoaded&&(this._source.off("data",r),this._preloadTiles(Ye,ut))};return void this._source.on("data",r)}const pt=new Map,wt=Array.isArray(Ye)?Ye:[Ye],Tt=this.map.painter.terrain,St=this.usedForTerrain&&Tt?Tt.getScaledDemTileSize():this._source.tileSize;for(const Ye of wt){const ut=Ye.coveringTiles({tileSize:St,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const Ye of ut)pt.set(Ye.key,Ye);this.usedForTerrain&&Ye.updateElevation(!1)}Qe(Array.from(pt.values()),((Ye,ut)=>{const pt=new nx(Ye,this._source.tileSize*Ye.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(pt,(Ye=>{"raster-dem"===this._source.type&&pt.dem&&this._backfillDEM(pt),ut(Ye,pt)}))}),ut)}}function Qx(Ye,ut){const pt=Math.abs(2*Ye.wrap)-+(Ye.wrap<0),wt=Math.abs(2*ut.wrap)-+(ut.wrap<0);return Ye.overscaledZ-ut.overscaledZ||wt-pt||ut.canonical.y-Ye.canonical.y||ut.canonical.x-Ye.canonical.x}function tb(Ye){return"raster"===Ye||"image"===Ye||"video"===Ye||"custom"===Ye}function eb(Ye,ut){const pt=1<<Ye.z;return[Ye.x/pt+ut,(Ye.x+1)/pt+ut]}Jx.maxOverzooming=10,Jx.maxUnderzooming=3;const rT=new class extends sl{possiblyEvaluate(Ye,ut){return ut=new Ho(Math.floor(ut.zoom),{now:ut.now,fadeDuration:ut.fadeDuration,transition:ut.transition}),super.possiblyEvaluate(Ye,ut)}evaluate(Ye,ut,pt,wt){return ut=er({},ut,{zoom:Math.floor(ut.zoom)}),super.evaluate(Ye,ut,pt,wt)}}(yb.paint.properties["line-width"].specification);function nb(Ye,ut){return ut>0?ut+2*Ye:Ye}rT.useIntegerZoom=!0;const nT=new ol({"symbol-placement":new il(O_.layout_symbol["symbol-placement"]),"symbol-spacing":new il(O_.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new il(O_.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new sl(O_.layout_symbol["symbol-sort-key"]),"symbol-z-order":new il(O_.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new il(O_.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new il(O_.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new il(O_.layout_symbol["icon-ignore-placement"]),"icon-optional":new il(O_.layout_symbol["icon-optional"]),"icon-rotation-alignment":new il(O_.layout_symbol["icon-rotation-alignment"]),"icon-size":new sl(O_.layout_symbol["icon-size"]),"icon-text-fit":new sl(O_.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new sl(O_.layout_symbol["icon-text-fit-padding"]),"icon-image":new sl(O_.layout_symbol["icon-image"]),"icon-rotate":new sl(O_.layout_symbol["icon-rotate"]),"icon-padding":new il(O_.layout_symbol["icon-padding"]),"icon-keep-upright":new il(O_.layout_symbol["icon-keep-upright"]),"icon-offset":new sl(O_.layout_symbol["icon-offset"]),"icon-anchor":new sl(O_.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new il(O_.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new il(O_.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new il(O_.layout_symbol["text-rotation-alignment"]),"text-field":new sl(O_.layout_symbol["text-field"]),"text-font":new sl(O_.layout_symbol["text-font"]),"text-size":new sl(O_.layout_symbol["text-size"]),"text-max-width":new sl(O_.layout_symbol["text-max-width"]),"text-line-height":new sl(O_.layout_symbol["text-line-height"]),"text-letter-spacing":new sl(O_.layout_symbol["text-letter-spacing"]),"text-justify":new sl(O_.layout_symbol["text-justify"]),"text-radial-offset":new sl(O_.layout_symbol["text-radial-offset"]),"text-variable-anchor":new il(O_.layout_symbol["text-variable-anchor"]),"text-anchor":new sl(O_.layout_symbol["text-anchor"]),"text-max-angle":new il(O_.layout_symbol["text-max-angle"]),"text-writing-mode":new il(O_.layout_symbol["text-writing-mode"]),"text-rotate":new sl(O_.layout_symbol["text-rotate"]),"text-padding":new il(O_.layout_symbol["text-padding"]),"text-keep-upright":new il(O_.layout_symbol["text-keep-upright"]),"text-transform":new sl(O_.layout_symbol["text-transform"]),"text-offset":new sl(O_.layout_symbol["text-offset"]),"text-allow-overlap":new il(O_.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new il(O_.layout_symbol["text-ignore-placement"]),"text-optional":new il(O_.layout_symbol["text-optional"]),visibility:new il(O_.layout_symbol.visibility)});var oT={paint:new ol({"icon-opacity":new sl(O_.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new sl(O_.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new sl(O_.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new sl(O_.paint_symbol["text-emissive-strength"]),"icon-color":new sl(O_.paint_symbol["icon-color"]),"icon-halo-color":new sl(O_.paint_symbol["icon-halo-color"]),"icon-halo-width":new sl(O_.paint_symbol["icon-halo-width"]),"icon-halo-blur":new sl(O_.paint_symbol["icon-halo-blur"]),"icon-translate":new il(O_.paint_symbol["icon-translate"]),"icon-translate-anchor":new il(O_.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new sl(O_.paint_symbol["icon-image-cross-fade"]),"text-opacity":new sl(O_.paint_symbol["text-opacity"]),"text-occlusion-opacity":new sl(O_.paint_symbol["text-occlusion-opacity"]),"text-color":new sl(O_.paint_symbol["text-color"],{runtimeType:pf,getOverride:Ye=>Ye.textColor,hasOverride:Ye=>!!Ye.textColor}),"text-halo-color":new sl(O_.paint_symbol["text-halo-color"]),"text-halo-width":new sl(O_.paint_symbol["text-halo-width"]),"text-halo-blur":new sl(O_.paint_symbol["text-halo-blur"]),"text-translate":new il(O_.paint_symbol["text-translate"]),"text-translate-anchor":new il(O_.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new il(O_.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new il(O_.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new il(O_.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new il(O_.paint_symbol["icon-color-brightness-max"])}),layout:nT};class ab{constructor(Ye){this.type=Ye.property.overrides?Ye.property.overrides.runtimeType:cf,this.defaultValue=Ye}evaluate(Ye){if(Ye.formattedSection){const ut=this.defaultValue.property.overrides;if(ut&&ut.hasOverride(Ye.formattedSection))return ut.getOverride(Ye.formattedSection)}return Ye.feature&&Ye.featureState?this.defaultValue.evaluate(Ye.feature,Ye.featureState):this.defaultValue.property.specification.default}eachChild(Ye){this.defaultValue.isConstant()||Ye(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Mo(ab,"FormatSectionOverride",{omit:["defaultValue"]});class ob extends kl{constructor(ut,pt,wt,Tt){super(ut,oT,pt,wt,Tt),this._colorAdjustmentMatrix=Ye.ad.identity([]),this.hasInitialOcclusionOpacityProperties=void 0!==ut.paint&&("icon-occlusion-opacity"in ut.paint||"text-occlusion-opacity"in ut.paint)}recalculate(Ye,ut){super.recalculate(Ye,ut),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const pt=this.layout.get("text-writing-mode");if(pt){const Ye=[];for(const ut of pt)Ye.indexOf(ut)<0&&Ye.push(ut);this.layout._values["text-writing-mode"]=Ye}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(ut,pt,wt,Tt){return this._saturation===ut&&this._contrast===pt&&this._brightnessMin===wt&&this._brightnessMax===Tt||(this._colorAdjustmentMatrix=function(ut,pt,wt,Tt){ut=Er(ut),pt=zr(pt);const St=Ye.ad.create(),It=ut/3,Lt=1-2*It,$t=[Lt,It,It,0,It,Lt,It,0,It,It,Lt,0,0,0,0,1],Xt=.5-.5*pt,Sr=Tt-wt;return Ye.ad.multiply(St,[Sr,0,0,0,0,Sr,0,0,0,0,Sr,0,wt,wt,wt,1],[pt,0,0,0,0,pt,0,0,0,0,pt,0,Xt,Xt,Xt,1]),Ye.ad.multiply(St,St,$t),St}(ut,pt,wt,Tt),this._saturation=ut,this._contrast=pt,this._brightnessMin=wt,this._brightnessMax=Tt),this._colorAdjustmentMatrix}getValueAndResolveTokens(Ye,ut,pt,wt){const Tt=this.layout.get(Ye).evaluate(ut,{},pt,wt),St=this._unevaluatedLayout._values[Ye];return St.isDataDriven()||co(St.value)||!Tt?Tt:function(Ye,ut){return ut.replace(/{([^{}]+)}/g,((ut,pt)=>pt in Ye?String(Ye[pt]):""))}(ut.properties,Tt)}createBucket(Ye){return new $g(Ye)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const Ye of oT.paint.overridableProperties){if(!ob.hasPaintOverride(this.layout,Ye))continue;const ut=this.paint.get(Ye),pt=new ab(ut),wt=new uo(pt,ut.property.specification,this.scope,this.options);let Tt=null;Tt="constant"===ut.value.kind||"source"===ut.value.kind?new po("source",wt):new fo("composite",wt,ut.value.zoomStops,ut.value._interpolationType),this.paint._values[Ye]=new rl(ut.property,Tt,ut.parameters)}}_handleOverridablePaintPropertyUpdate(Ye,ut,pt){return!(!this.layout||ut.isDataDriven()||pt.isDataDriven())&&ob.hasPaintOverride(this.layout,Ye)}static hasPaintOverride(Ye,ut){const pt=Ye.get("text-field"),wt=oT.paint.properties[ut];let Tt=!1;const s=Ye=>{for(const ut of Ye)if(wt.overrides&&wt.overrides.hasOverride(ut))return void(Tt=!0)};if("constant"===pt.value.kind&&pt.value.value instanceof mi)s(pt.value.value.sections);else if("source"===pt.value.kind){const t=Ye=>{Tt||(Ye instanceof _i&&bi(Ye.value)===wf?s(Ye.value.sections):Ye instanceof Si?s(Ye.sections):Ye.eachChild(t))},Ye=pt.value;Ye._styleExpression&&t(Ye._styleExpression.expression)}return Tt}getProgramIds(){const Ye=0!==this.paint.get("icon-opacity").constantOr(1),ut=0!==this.paint.get("text-opacity").constantOr(1),pt=[];return Ye&&pt.push("symbolIcon"),ut&&pt.push("symbolSDF"),pt}getDefaultProgramParams(Ye,ut,pt){return{config:new Ku(this,{zoom:ut,lut:pt}),overrideFog:!1}}}const sT=new ol({visibility:new il(O_.layout_background.visibility)});var aT={paint:new ol({"background-color":new il(O_.paint_background["background-color"]),"background-pattern":new il(O_.paint_background["background-pattern"]),"background-opacity":new il(O_.paint_background["background-opacity"]),"background-emissive-strength":new il(O_.paint_background["background-emissive-strength"])}),layout:sT};const lT=new ol({visibility:new il(O_.layout_raster.visibility)});var cT={paint:new ol({"raster-opacity":new il(O_.paint_raster["raster-opacity"]),"raster-color":new al(O_.paint_raster["raster-color"]),"raster-color-mix":new il(O_.paint_raster["raster-color-mix"]),"raster-color-range":new il(O_.paint_raster["raster-color-range"]),"raster-hue-rotate":new il(O_.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new il(O_.paint_raster["raster-brightness-min"]),"raster-brightness-max":new il(O_.paint_raster["raster-brightness-max"]),"raster-saturation":new il(O_.paint_raster["raster-saturation"]),"raster-contrast":new il(O_.paint_raster["raster-contrast"]),"raster-resampling":new il(O_.paint_raster["raster-resampling"]),"raster-fade-duration":new il(O_.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new il(O_.paint_raster["raster-emissive-strength"]),"raster-array-band":new il(O_.paint_raster["raster-array-band"]),"raster-elevation":new il(O_.paint_raster["raster-elevation"])}),layout:lT};function pb(ut,pt,wt,Tt,St,It,Lt,$t){const Xt=[ut,pt,1,wt,Tt,1,St,It,1],Sr=[Lt,$t,1],Lr=Ye.bC.adjoint([],Xt),[Qr,fn,xn]=Ye._.transformMat3(Sr,Sr,Lr);return Ye.bC.multiply(Xt,Xt,[Qr,0,0,0,fn,0,0,0,xn])}function fb(ut,pt,wt,Tt,St,It,Lt,$t){const Xt=function(ut,pt,wt,Tt,St,It,Lt,$t){const Xt=pb(0,0,1,0,1,1,0,1),Sr=pb(ut,pt,wt,Tt,St,It,Lt,$t),Lr=Ye.bC.adjoint([],Xt);return Ye.bC.multiply(Sr,Sr,Lr)}(ut,pt,wt,Tt,St,It,Lt,$t);return[Xt[2]/Xt[8]/ym,Xt[5]/Xt[8]/ym]}function db(Ye){return[Ye[0],Math.min(Math.max(Ye[1],-Bg),Bg)]}class mb extends Ln{constructor(Ye,ut,pt,wt){super(),this.id=Ye,this.dispatcher=pt,this.coordinates=ut.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(wt),this.options=ut,this._dirty=!1}load(Ye,ut){if(this._loaded=ut||!1,this.fire(new Dn("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return Ye&&(this.coordinates=Ye),this._loaded=!0,void this._finishLoading();this._imageRequest=on(this.map._requestManager.transformRequest(this.url,jd.Image),((ut,pt)=>{this._imageRequest=null,this._loaded=!0,ut?this.fire(new Cn(ut)):pt&&(this.image=pt instanceof HTMLImageElement?sd.getImageData(pt):pt,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,Ye&&(this.coordinates=Ye),this._finishLoading())}))}loaded(){return this._loaded}updateImage(Ye){return Ye.url?(this._imageRequest&&Ye.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=Ye.url,this.load(Ye.coordinates,this._loaded),this):this}setTexture(Ye){if(!(Ye.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Yg(this.map.painter.context,Ye.handle),this.width=Ye.dimensions[0],this.height=Ye.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Dn("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(Ye){this.map=Ye,this.load()}onRemove(Ye){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Yg||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(Ye){if(this.coordinates=Ye,this._boundsArray=void 0,this._unsupportedCoords=!1,!Ye.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let ut=Ye[0][1],pt=Ye[0][1];for(const wt of Ye)wt[1]>pt&&(pt=wt[1]),wt[1]<ut&&(ut=wt[1]);const wt=(pt+ut)/2;if(wt>Bg?this.onNorthPole=!0:wt<-Bg&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const ut=Ye.map(Oc.fromLngLat);this.tileID=function(Ye){let ut=1/0,pt=1/0,wt=-1/0,Tt=-1/0;for(const St of Ye)ut=Math.min(ut,St.x),pt=Math.min(pt,St.y),wt=Math.max(wt,St.x),Tt=Math.max(Tt,St.y);const St=Math.max(wt-ut,Tt-pt),It=Math.max(0,Math.floor(-Math.log(St)/Math.LN2)),Lt=Math.pow(2,It);let $t=Math.floor((ut+wt)/2*Lt);return $t>1&&($t-=1),new bc(It,$t,Math.floor((pt+Tt)/2*Lt))}(ut),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Dn("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(ut){for(const Ye in this.tiles){const ut=this.tiles[Ye];"loaded"!==ut.state&&(ut.state="loaded",ut.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const pt=ng(new bc(0,0,0),this.map.transform.projection),wt=[pt.projection.project(this.coordinates[0][0],this.coordinates[0][1]),pt.projection.project(this.coordinates[1][0],this.coordinates[1][1]),pt.projection.project(this.coordinates[2][0],this.coordinates[2][1]),pt.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(Ye){const ut=Ye[1].x-Ye[0].x,pt=Ye[1].y-Ye[0].y,wt=Ye[2].x-Ye[1].x,Tt=Ye[2].y-Ye[1].y,St=Ye[3].x-Ye[2].x,It=Ye[3].y-Ye[2].y,Lt=Ye[0].x-Ye[3].x,$t=Ye[0].y-Ye[3].y,Xt=ut*Tt-wt*pt,Sr=wt*It-St*Tt,Lr=St*$t-Lt*It,Qr=Lt*pt-ut*$t;return Xt>0&&Sr>0&&Lr>0&&Qr>0||Xt<0&&Sr<0&&Lr<0&&Qr<0}(wt))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const Tt=ng(this.tileID,this.map.transform.projection),[St,It,Lt,$t]=this.coordinates.map((Ye=>{const ut=Tt.projection.project(Ye[0],Ye[1]);return ig(Tt,ut)._round()}));this.perspectiveTransform=fb(St.x,St.y,It.x,It.y,Lt.x,Lt.y,$t.x,$t.y);const Xt=this._boundsArray=new Vl;Xt.emplaceBack(St.x,St.y,0,0),Xt.emplaceBack(It.x,It.y,ym,0),Xt.emplaceBack($t.x,$t.y,0,ym),Xt.emplaceBack(Lt.x,Lt.y,ym,ym),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=ut.createVertexBuffer(Xt,Pw.members),this.boundsSegments=Au.simpleSegment(0,0,4,2);const Sr=[],Lr=function(Ye){return[db(Ye[0]),db(Ye[1]),db(Ye[2]),db(Ye[3])]}(this.coordinates),[Qr,fn,xn,vn]=function(Ye){let ut=Ye[0][0],pt=ut,wt=Ye[0][1],Tt=wt;for(let St=1;St<Ye.length;St++)Ye[St][0]<ut?ut=Ye[St][0]:Ye[St][0]>pt&&(pt=Ye[St][0]),Ye[St][1]<wt?wt=Ye[St][1]:Ye[St][1]>Tt&&(Tt=Ye[St][1]);return[ut,wt,pt-ut,Tt-wt]}(Lr);{const Tt=new Vl,[St,It,Lt,$t]=function(Ye){let ut=Ye[0].x,pt=ut,wt=Ye[0].y,Tt=wt;for(let St=1;St<Ye.length;St++)Ye[St].x<ut?ut=Ye[St].x:Ye[St].x>pt&&(pt=Ye[St].x),Ye[St].y<wt?wt=Ye[St].y:Ye[St].y>Tt&&(Tt=Ye[St].y);return[ut,wt,pt-ut,Tt-wt]}(wt),u=Ye=>[(Ye.x-St)/Lt,(Ye.y-It)/$t],[Xt,Lr,kn,Wn]=wt.map(u),Xn=function(ut,pt,wt,Tt,St,It,Lt,$t){const Xt=pb(0,0,1,0,1,1,0,1),Sr=pb(ut,pt,wt,Tt,St,It,Lt,$t),Lr=Ye.bC.adjoint([],Sr);return Ye.bC.multiply(Xt,Xt,Lr)}(Xt[0],Xt[1],Lr[0],Lr[1],kn[0],kn[1],Wn[0],Wn[1]);this.elevatedGlobePerspectiveTransform=fb(Xt[0],Xt[1],Lr[0],Lr[1],kn[0],kn[1],Wn[0],Wn[1]);const v=(ut,pt)=>{Sr.push(ut.lng);const wt=Math.round((ut.lng-Qr)/xn*ym),St=Math.round((ut.lat-fn)/vn*ym),It=u(pt),Lt=Ye._.transformMat3([],[It[0],It[1],1],Xn),$t=Math.round(Lt[0]/Lt[2]*ym),Xt=Math.round(Lt[1]/Lt[2]*ym);Tt.emplaceBack(wt,St,$t,Xt)},Jn=wt[3].x-wt[0].x,Qn=wt[3].y-wt[0].y,ko=wt[2].x-wt[1].x,Fo=wt[2].y-wt[1].y;for(let Ye=0;Ye<65;Ye++){const ut=Ye/64,Tt=[wt[0].x+ut*Jn,wt[0].y+ut*Qn],St=[wt[1].x+ut*ko,wt[1].y+ut*Fo],It=St[0]-Tt[0],Lt=St[1]-Tt[1];for(let Ye=0;Ye<65;Ye++){const ut=Ye/64,wt={x:Tt[0]+It*ut,y:Tt[1]+Lt*ut,z:0};v(pt.projection.unproject(wt.x,wt.y),wt)}}this.elevatedGlobeVertexBuffer=ut.createVertexBuffer(Tt,Pw.members)}{this.maxLongitudeTriangleSize=0;let Ye=[],pt=new Ql;const n=(ut,wt,Tt)=>{pt.emplaceBack(ut,wt,Tt);const St=Sr[ut],It=Sr[wt],Lt=Sr[Tt],$t=Math.min(Math.min(St,It),Lt),Xt=Math.max(Math.max(St,It),Lt)-$t;Xt>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Xt),Ye.push($t+Xt/2)};for(let Ye=0;Ye<64;Ye++)for(let ut=0;ut<64;ut++){const pt=65*Ye+ut,wt=pt+1,Tt=pt+65,St=Tt+1;n(pt,Tt,wt),n(wt,Tt,St)}[Ye,pt]=function(Ye,ut){const pt=Array.from({length:Ye.length},((Ye,ut)=>ut));pt.sort(((ut,pt)=>Ye[ut]-Ye[pt]));const wt=[],Tt=new Ql;for(let St=0;St<pt.length;St++){const It=pt[St];wt.push(Ye[It]);const Lt=3*It,$t=Lt+1;Tt.emplaceBack(ut.uint16[Lt],ut.uint16[$t],ut.uint16[$t+1])}return[wt,Tt]}(Ye,pt),this.elevatedGlobeTrianglesCenterLongitudes=Ye,this.elevatedGlobeIndexBuffer=ut.createIndexBuffer(pt)}this.elevatedGlobeSegments=Au.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,xn/ym,0,vn/ym,0,0,fn,Qr,0])}prepare(){const Ye=0!==Object.keys(this.tiles).length;if(this.tileID&&!Ye)return;const ut=this.map.painter.context,pt=ut.gl;!this._dirty||this.texture instanceof Yg||(this.texture?this.texture.update(this.image):(this.texture=new Gg(ut,this.image,pt.RGBA),this.texture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE)),this._dirty=!1),Ye&&this._prepareData(ut)}loadTile(Ye,ut){this.tileID&&this.tileID.equals(Ye.tileID.canonical)?(this.tiles[String(Ye.tileID.wrap)]=Ye,Ye.buckets={},ut(null)):(Ye.state="errored",ut(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(Ye){const ut=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!ut)return null;const pt=this.elevatedGlobeTrianglesCenterLongitudes;let wt=(Tt=Ye+180)+360*Math.round((pt[0]-Tt)/360);var Tt;const St=new Au,a=(Ye,pt)=>{St.segments.push({vertexOffset:0,primitiveOffset:Ye,vertexLength:ut.segments[0].vertexLength,primitiveLength:pt,sortKey:void 0,vaos:{}})},It=.51*this.maxLongitudeTriangleSize;if(Math.abs(pt[0]-wt)<=It){const Ye=Pr(pt,0,pt.length,wt+It);return Ye===pt.length||a(Ye,kr(pt,Ye+1,pt.length,wt+360-It)-Ye),St}wt<pt[0]&&(wt+=360);const Lt=kr(pt,0,pt.length,wt-It);if(Lt===pt.length)return a(0,pt.length),St;a(0,Lt-0);const $t=Pr(pt,Lt+1,pt.length,wt+It);return $t!==pt.length&&a($t,pt.length-$t),St}}const hT=(Math.pow(256,2)-1)/16907520;class gb extends kl{constructor(Ye,ut,pt,wt){super(Ye,cT,ut,pt,wt),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(Ye){return!(Ye&&Ye._source instanceof mb&&(Ye._source.onNorthPole||Ye._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(Ye){"raster-color"!==Ye&&"raster-color-range"!==Ye||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(Ye){if(!this.hasColorMap())return;if(!this._curRampRange)return;const ut=this._transitionablePaint._values["raster-color"].value.expression,[pt,wt]=Ye||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(pt)&&isNaN(wt)||pt===this._curRampRange[0]&&wt===this._curRampRange[1]||(this.colorRamp=gp({expression:ut,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:pt,end:wt}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[pt,wt])}}const uT=new ol({visibility:new il(O_["layout_raster-particle"].visibility)});var dT={paint:new ol({"raster-particle-array-band":new il(O_["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new il(O_["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new al(O_["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new il(O_["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new il(O_["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new il(O_["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new il(O_["paint_raster-particle"]["raster-particle-reset-rate-factor"])}),layout:uT};class vb extends kl{constructor(Ye,ut,pt,wt){super(Ye,dT,ut,pt,wt),this._updateColorRamp(),this.lastInvalidatedAt=sd.now()}onRemove(Ye){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(Ye){return!1}_handleSpecialPaintPropertyUpdate(Ye){"raster-particle-color"!==Ye&&"raster-particle-max-speed"!==Ye||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===Ye&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const Ye=this._transitionablePaint._values["raster-particle-color"].value.expression,ut=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=gp({expression:Ye,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:ut}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=sd.now()}}class _b extends kl{constructor(Ye,ut){super(Ye,{},ut,null),this.implementation=Ye,Ye.slot&&(this.slot=Ye.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(Ye){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(Ye){this.implementation.onAdd&&this.implementation.onAdd(Ye,Ye.painter.context.gl)}onRemove(Ye){this.implementation.onRemove&&this.implementation.onRemove(Ye,Ye.painter.context.gl)}}const pT=new ol({visibility:new il(O_.layout_sky.visibility)});var fT={paint:new ol({"sky-type":new il(O_.paint_sky["sky-type"]),"sky-atmosphere-sun":new il(O_.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new il(O_.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new il(O_.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new il(O_.paint_sky["sky-gradient-radius"]),"sky-gradient":new al(O_.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new il(O_.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new il(O_.paint_sky["sky-atmosphere-color"]),"sky-opacity":new il(O_.paint_sky["sky-opacity"])}),layout:pT};function Ab(ut,pt,wt){const Tt=[0,0,1],St=Ye.av.identity([]);return Ye.av.rotateY(St,St,wt?-$e(ut)+Math.PI:$e(ut)),Ye.av.rotateX(St,St,-$e(pt)),Ye._.transformQuat(Tt,Tt,St),Ye._.normalize(Tt,Tt)}var mT={paint:new ol({})};function Ib(ut,pt){const wt=kb(ut.projection,ut.zoom,ut.width,ut.height),Tt=function(ut,pt,wt,Tt,St){const It=new mc(wt.lng-180*_T,wt.lat),Lt=new mc(wt.lng+180*_T,wt.lat),$t=ut.project(It.lng,It.lat),Xt=ut.project(Lt.lng,Lt.lat),Sr=-Math.atan2(Xt.y-$t.y,Xt.x-$t.x),Lr=Oc.fromLngLat(wt);Lr.y=Ke(Lr.y,-1+_T,1-_T);const Qr=Lr.toLngLat(),fn=ut.project(Qr.lng,Qr.lat),xn=Oc.fromLngLat(Qr);xn.x+=_T;const vn=xn.toLngLat(),kn=ut.project(vn.lng,vn.lat),Wn=Eb(kn.x-fn.x,kn.y-fn.y,Sr),Xn=Oc.fromLngLat(Qr);Xn.y+=_T;const Jn=Xn.toLngLat(),Qn=ut.project(Jn.lng,Jn.lat),ko=Eb(Qn.x-fn.x,Qn.y-fn.y,Sr),Fo=Math.abs(Wn.x)/Math.abs(ko.y),is=Ye.ad.identity([]);Ye.ad.rotateZ(is,is,-Sr*(1-(St?0:Tt)));const ns=Ye.ad.identity([]);return Ye.ad.scale(ns,ns,[1,1-(1-Fo)*Tt,1]),ns[4]=-ko.x/ko.y*Tt,Ye.ad.rotateZ(ns,ns,Sr),Ye.ad.multiply(ns,is,ns),ns}(ut.projection,0,ut.center,wt,pt),St=Tb(ut);return Ye.ad.scale(Tt,Tt,[St,St,1]),Tt}function Tb(Ye){const ut=Ye.projection,pt=kb(Ye.projection,Ye.zoom,Ye.width,Ye.height),wt=zb(ut,Ye.center),Tt=zb(ut,mc.convert(ut.center));return Math.pow(2,wt*pt+(1-pt)*Tt)}function kb(Ye,ut,pt,wt,Tt=1/0){const St=Ye.range;if(!St)return 0;const It=Math.min(Tt,Math.max(pt,wt)),Lt=Math.log(It/1024)/Math.LN2;return We(St[0]+Lt,St[1]+Lt,ut)}const _T=1/4e4;function zb(Ye,ut){const pt=Ke(ut.lat,-Bg,Bg),wt=new mc(ut.lng-180*_T,pt),Tt=new mc(ut.lng+180*_T,pt),St=Ye.project(wt.lng,pt),It=Ye.project(Tt.lng,pt),Lt=Oc.fromLngLat(wt),$t=Oc.fromLngLat(Tt),Xt=It.x-St.x,Sr=It.y-St.y,Lr=$t.x-Lt.x,Qr=$t.y-Lt.y,fn=Math.sqrt((Lr*Lr+Qr*Qr)/(Xt*Xt+Sr*Sr));return Math.log(fn)/Math.LN2}function Eb(Ye,ut,pt){const wt=Math.cos(pt),Tt=Math.sin(pt);return{x:Ye*wt-ut*Tt,y:Ye*Tt+ut*wt}}function Bb(ut,pt,wt){Ye.ad.identity(ut),Ye.ad.rotateZ(ut,ut,$e(pt[2])),Ye.ad.rotateX(ut,ut,$e(pt[0])),Ye.ad.rotateY(ut,ut,$e(pt[1])),Ye.ad.scale(ut,ut,wt),Ye.ad.multiply(ut,ut,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Db(ut,pt,wt,Tt,St,It,Lt,$t){const Xt=[wt[0]-pt[0],wt[1]-pt[1],0],Sr=[Tt[0]-pt[0],Tt[1]-pt[1],0];if(Ye._.length(Xt)<1e-12||Ye._.length(Sr)<1e-12)return Ye.av.identity(ut);const Lr=Ye._.cross([],Xt,Sr);Ye._.normalize(Lr,Lr),Ye._.subtract(Sr,Tt,pt),Xt[2]=(It-St)*$t,Sr[2]=(Lt-St)*$t;const Qr=Xt;return Ye._.cross(Qr,Xt,Sr),Ye._.normalize(Qr,Qr),Ye.av.rotationTo(ut,Lr,Qr)}function Cb(ut,pt,wt=!1){const Tt=Hh(pt.zoom),St=function(ut,pt,wt){const Tt=pt.worldSize,St=[ut[12],ut[13],ut[14]],It=Ec(St[1]/Tt),Lt=zc(St[0]/Tt),$t=Ye.ad.identity([]),Xt=Pc(1,It)*Tt,Sr=Pc(1,0)*Tt*Rc(It,pt.zoom),Lr=1/Yh(Tt);let Qr=Sr*Lr;if(wt){const Ye=kb(pt.projection,pt.zoom,pt.width,pt.height,1024);Qr=Lr*pt.projection.pixelSpaceConversion(pt.center.lat,Tt,Ye)}const fn=pc(It,Lt);Ye._.add(fn,fn,Ye._.scale([],Ye._.normalize([],fn),Xt*Qr*St[2]));const xn=function(ut){const pt=[ut[0],ut[1],ut[2]];let wt=[0,1,0];const Tt=Ye._.cross([],wt,pt);return Ye._.cross(wt,pt,Tt),0===Ye._.squaredLength(wt)&&(wt=[0,1,0],Ye._.cross(Tt,pt,wt)),Ye._.normalize(Tt,Tt),Ye._.normalize(wt,wt),Ye._.normalize(pt,pt),[Tt[0],Tt[1],Tt[2],0,wt[0],wt[1],wt[2],0,pt[0],pt[1],pt[2],0,ut[0],ut[1],ut[2],1]}(fn);Ye.ad.scale($t,$t,[Qr,Qr,Qr*Xt]),Ye.ad.translate($t,$t,[-St[0],-St[1],-St[2]]);const vn=Ye.ad.multiply([],pt.globeMatrix,xn);return Ye.ad.multiply(vn,vn,$t),Ye.ad.multiply(vn,vn,ut),vn}(ut,pt,wt);if(Tt>0){const wt=function(ut,pt){const wt=pt.worldSize,Tt=Pc(1,0)*wt*Rc(pt.center.lat,pt.zoom)/Yh(wt),St=Pc(1,pt.center.lat)*wt,It=Ye.ad.identity([]);return Ye.ad.rotateY(It,It,$e(pt.center.lng)),Ye.ad.rotateX(It,It,$e(pt.center.lat)),Ye.ad.translate(It,It,[0,0,J_]),Ye.ad.scale(It,It,[Tt,Tt,Tt*St]),Ye.ad.translate(It,It,[pt.point.x-.5*wt,pt.point.y-.5*wt,0]),Ye.ad.multiply(It,It,ut),Ye.ad.multiply(It,pt.globeMatrix,It)}(ut,pt);return function(ut,pt,wt){const i=(ut,pt,wt)=>{const Tt=Ye._.length(ut),St=Ye._.length(pt),It=Rh(ut,pt,wt);return Ye._.scale(It,It,1/Ye._.length(It)*Gn(Tt,St,wt))},Tt=i([ut[0],ut[1],ut[2]],[pt[0],pt[1],pt[2]],wt),St=i([ut[4],ut[5],ut[6]],[pt[4],pt[5],pt[6]],wt),It=i([ut[8],ut[9],ut[10]],[pt[8],pt[9],pt[10]],wt),Lt=Rh([ut[12],ut[13],ut[14]],[pt[12],pt[13],pt[14]],wt);return[Tt[0],Tt[1],Tt[2],0,St[0],St[1],St[2],0,It[0],It[1],It[2],0,Lt[0],Lt[1],Lt[2],1]}(St,wt,Tt)}return St}function Rb(Ye,ut,pt,wt){const Tt=Ah.projectAabbCorners(wt,pt);let St=Number.MAX_VALUE,It=-1;for(let Ye=0;Ye<Tt.length;++Ye){const pt=Tt[Ye];pt[0]=(.5*pt[0]+.5)*ut.width,pt[1]=(.5-.5*pt[1])*ut.height,pt[2]<St&&(It=Ye,St=pt[2])}const o=Ye=>new wu(Tt[Ye][0],Tt[Ye][1]);let Lt;switch(It){case 0:case 6:Lt=[o(1),o(5),o(4),o(7),o(3),o(2),o(1)];break;case 1:case 7:Lt=[o(0),o(4),o(5),o(6),o(2),o(3),o(0)];break;case 3:case 5:Lt=[o(1),o(0),o(4),o(7),o(6),o(2),o(1)];break;default:Lt=[o(1),o(5),o(6),o(7),o(3),o(0),o(1)]}if(Wc(Ye,Lt))return St}const gT=Bl([{name:"a_pos_3f",components:3,type:"Float32"}]),yT=Bl([{name:"a_color_3f",components:3,type:"Float32"}]),xT=Bl([{name:"a_color_4f",components:4,type:"Float32"}]),vT=Bl([{name:"a_uv_2f",components:2,type:"Float32"}]),bT=Bl([{name:"a_normal_3f",components:3,type:"Float32"}]),wT=Bl([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),TT=Bl([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class qb{constructor(Ye,ut,pt,wt){this.message=(Ye?`${Ye}: `:"")+pt,wt&&(this.identifier=wt),null!=ut&&ut.__line__&&(this.line=ut.__line__)}}function $b(Ye,ut){const pt=-1===Ye.indexOf("://");try{return new URL(Ye,pt&&ut?"http://example.com":void 0),!0}catch(Ye){return!1}}class Gb{constructor(Ye,ut){this.feature=Ye,this.instancedDataOffset=ut,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Yb{constructor(){this.instancedDataArray=new ou,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Xb{constructor(Ye){this.zoom=Ye.zoom,this.canonical=Ye.canonical,this.layers=Ye.layers,this.layerIds=this.layers.map((Ye=>Ye.fqid)),this.projection=Ye.projection,this.index=Ye.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((Ye=>Ye.isStateDependent())).map((Ye=>Ye.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(Ye,ut){}populate(Ye,ut,pt,wt){this.tileToMeter=Lc(pt);const Tt=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:St,id:It,index:Lt,sourceLayerIndex:$t}of Ye){const Ye=null!=It?It:St.properties&&St.properties.hasOwnProperty("id")?St.properties.id:void 0,Xt=Xc(St,Tt);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Xt,pt))continue;const Sr={id:Ye,sourceLayerIndex:$t,index:Lt,geometry:Tt?Xt.geometry:Yc(St,pt,wt),properties:St.properties,type:St.type,patterns:{}},Lr=this.addFeature(Sr,Sr.geometry,Xt);Lr&&ut.featureIndex.insert(St,Sr.geometry,Lt,$t,this.index,this.instancesPerModel[Lr].instancedDataArray.length,ym/32)}this.lookup=null}update(Ye,ut,pt,wt){for(const ut in this.instancesPerModel){const pt=this.instancesPerModel[ut];for(const ut in Ye)pt.idToFeaturesIndex.hasOwnProperty(ut)&&(this.evaluate(pt.features[pt.idToFeaturesIndex[ut]],Ye[ut],pt,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let ut=!1;for(const pt in this.instancesPerModel){const wt=this.instancesPerModel[pt];for(const pt of wt.features){const Tt=this.layers[0],St=pt.feature,It=this.canonical,Lt=Tt.paint.get("model-rotation").evaluate(St,{},It),$t=Tt.paint.get("model-scale").evaluate(St,{},It),Xt=Tt.paint.get("model-translation").evaluate(St,{},It);Ye._.exactEquals(pt.rotation,Lt)&&Ye._.exactEquals(pt.scale,$t)&&Ye._.exactEquals(pt.translation,Xt)||(this.evaluate(pt,pt.featureStates,wt,!0),ut=!0)}}return ut}updateReplacement(Ye,ut,pt){if(ut.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=ut.updateTime;const wt=ut.getReplacementRegionsForTile(Ye.toUnwrapped(),!0);if(Cf(this.activeReplacements,wt))return!1;this.activeReplacements=wt;let Tt=!1;for(const ut in this.instancesPerModel){const wt=this.instancesPerModel[ut],St=wt.instancedDataArray;for(const ut of wt.features){const wt=ut.instancedDataOffset,It=ut.instancedDataCount;for(let ut=0;ut<It;ut++){const It=16*(ut+wt);let Lt=St.float32[It+0];Lt=Lt>ym?Lt-ym:Lt;const $t=Math.floor(Lt),Xt=St.float32[It+1];let Sr=!1;for(const ut of this.activeReplacements)if(!(ut.order<pt||ut.order===1/0)&&ut.clipMask&jx.Model&&!(ut.min.x>$t||$t>ut.max.x||ut.min.y>Xt||Xt>ut.max.y)&&(Sr=Uf(Ff($t,Xt,Ye.canonical,ut.footprintTileId.canonical),ut),Sr))break;St.float32[It]=Sr?Lt+ym:Lt,Tt=Tt||Sr}}}return Tt}isEmpty(){for(const Ye in this.instancesPerModel)if(0!==this.instancesPerModel[Ye].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(Ye){if(!this.uploaded)for(const ut in this.instancesPerModel){const pt=this.instancesPerModel[ut];pt.instancedDataArray.length<0||0===pt.instancedDataArray.length||(pt.instancedDataBuffer?pt.instancedDataBuffer.updateData(pt.instancedDataArray):pt.instancedDataBuffer=Ye.createVertexBuffer(pt.instancedDataArray,wT.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const Ye in this.instancesPerModel){const ut=this.instancesPerModel[Ye];0!==ut.instancedDataArray.length&&ut.instancedDataBuffer&&ut.instancedDataBuffer.destroy()}const Ye=this.layers[0].modelManager;if(Ye&&this.modelUris)for(const ut of this.modelUris)Ye.removeModel(ut,"")}addFeature(Ye,ut,pt){const wt=this.layers[0],Tt=wt.layout.get("model-id").evaluate(pt,{},this.canonical);if(!Tt)return fr(`modelId is not evaluated for layer ${wt.id} and it is not going to get rendered.`),Tt;$b(Tt,!1)&&(this.modelUris.includes(Tt)||this.modelUris.push(Tt)),this.instancesPerModel[Tt]||(this.instancesPerModel[Tt]=new Yb);const St=this.instancesPerModel[Tt],It=St.instancedDataArray,Lt=new Gb(pt,It.length);for(const Ye of ut)for(const ut of Ye){if(ut.x<0||ut.x>=ym||ut.y<0||ut.y>=ym)continue;const Ye=(this.lookupDim-1)/ym,pt=this.lookupDim*(ut.y*Ye|0)+ut.x*Ye|0;if(this.lookup){if(0!==this.lookup[pt])continue;this.lookup[pt]=1}this.instanceCount++;const wt=It.length;It.resize(wt+1),St.instancesEvaluatedElevation.push(0),It.float32[16*wt]=ut.x,It.float32[16*wt+1]=ut.y}return Lt.instancedDataCount=St.instancedDataArray.length-Lt.instancedDataOffset,Lt.instancedDataCount>0&&(Ye.id&&(St.idToFeaturesIndex[Ye.id]=St.features.length),St.features.push(Lt),this.evaluate(Lt,{},St,!1)),Tt}getModelUris(){return this.modelUris}evaluate(Ye,ut,pt,wt){const Tt=this.layers[0],St=Ye.feature,It=this.canonical,Lt=Ye.rotation=Tt.paint.get("model-rotation").evaluate(St,ut,It),$t=Ye.scale=Tt.paint.get("model-scale").evaluate(St,ut,It),Xt=Ye.translation=Tt.paint.get("model-translation").evaluate(St,ut,It),Sr=Tt.paint.get("model-color").evaluate(St,ut,It);Sr.a=Tt.paint.get("model-color-mix-intensity").evaluate(St,ut,It);const Lr=[];this.maxVerticalOffset<Xt[2]&&(this.maxVerticalOffset=Xt[2]),this.maxScale=Math.max(Math.max(this.maxScale,$t[0]),Math.max($t[1],$t[2])),Bb(Lr,Lt,$t);const Qr=Math.round(100*Sr.a)+Sr.b/1.05;for(let ut=0;ut<Ye.instancedDataCount;++ut){const Tt=Ye.instancedDataOffset+ut,St=16*Tt,Lt=pt.instancedDataArray.float32;let $t=0;wt&&($t=Lt[St+6]-pt.instancesEvaluatedElevation[Tt]);const fn=0|Lt[St+1];Lt[St]=(0|Lt[St])+Sr.r/1.05,Lt[St+1]=fn+Sr.g/1.05,Lt[St+2]=Qr,Lt[St+3]=1/(It.z>10?this.tileToMeter:Lc(It,fn)),Lt[St+4]=Xt[0],Lt[St+5]=Xt[1],Lt[St+6]=Xt[2]+$t,Lt[St+7]=Lr[0],Lt[St+8]=Lr[1],Lt[St+9]=Lr[2],Lt[St+10]=Lr[4],Lt[St+11]=Lr[5],Lt[St+12]=Lr[6],Lt[St+13]=Lr[8],Lt[St+14]=Lr[9],Lt[St+15]=Lr[10],pt.instancesEvaluatedElevation[Tt]=Xt[2]}}}Mo(Xb,"ModelBucket",{omit:["layers"]}),Mo(Yb,"PerModelAttributes"),Mo(Gb,"ModelFeature");const ET=new ol({visibility:new il(O_.layout_model.visibility),"model-id":new sl(O_.layout_model["model-id"])});var MT={paint:new ol({"model-opacity":new il(O_.paint_model["model-opacity"]),"model-rotation":new sl(O_.paint_model["model-rotation"]),"model-scale":new sl(O_.paint_model["model-scale"]),"model-translation":new sl(O_.paint_model["model-translation"]),"model-color":new sl(O_.paint_model["model-color"]),"model-color-mix-intensity":new sl(O_.paint_model["model-color-mix-intensity"]),"model-type":new il(O_.paint_model["model-type"]),"model-cast-shadows":new il(O_.paint_model["model-cast-shadows"]),"model-receive-shadows":new il(O_.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new il(O_.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new sl(O_.paint_model["model-emissive-strength"]),"model-roughness":new sl(O_.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new sl(O_.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new il(O_.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new il(O_.paint_model["model-front-cutoff"])}),layout:ET};const AT=64,ST={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Jb(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr=!1){const Lr=wt.zoom,Qr=wt.project(Tt),fn=Rc(Tt.lat,Lr),xn=1/fn;Ye.ad.identity(ut),Ye.ad.translate(ut,ut,[Qr.x+Lt[0]*xn,Qr.y+Lt[1]*xn,Lt[2]]);let vn=1,kn=1;const Wn=wt.worldSize;if(Sr){if("mercator"===wt.projection.name){let ut=0;wt.elevation&&(ut=wt.elevation.getAtPointOrZero(new Oc(Qr.x/Wn,Qr.y/Wn),0));const pt=Ye.aA.transformMat4([],[Qr.x,Qr.y,ut,1],wt.projMatrix)[3]/wt.cameraToCenterDistance;vn=pt,kn=pt*Rc(wt.center.lat,Lr)}else if("globe"===wt.projection.name){const pt=Cb(ut,wt),St=Ye.ad.multiply([],wt.projMatrix,pt),It=[0,0,0,1];Ye.aA.transformMat4(It,It,St);const Lt=It[3]/wt.cameraToCenterDistance,$t=Hh(Lr),Xt=wt.projection.pixelsPerMeter(Tt.lat,Wn)*Rc(Tt.lat,Lr),Sr=wt.projection.pixelsPerMeter(wt.center.lat,Wn)*Rc(wt.center.lat,Lr);vn=Lt/Gn(Xt,Cc(wt.center.lat),$t),kn=Lt*fn/Xt,vn*=Sr,kn*=Sr}}else vn=xn;Ye.ad.scale(ut,ut,[vn,vn,kn]);const Xn=[...ut],Jn=pt.orientation,Qn=[];if(Bb(Qn,[Jn[0]+St[0],Jn[1]+St[1],Jn[2]+St[2]],It),Ye.ad.multiply(ut,Xn,Qn),$t&&wt.elevation){let St=0;const It=[];if(Xt&&wt.elevation){St=function(ut,pt,wt,Tt,St){const It=pt.elevation;if(!It)return 0;const Lt=Ah.projectAabbCorners(wt,Tt),$t=Pc(1,St.lat)*pt.worldSize,Xt=function(ut,pt){const wt=[0,0,1],Tt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const St of Tt){const Tt=ut[St.corners[0]],It=ut[St.corners[1]],Lt=ut[St.corners[2]],$t=[It[0]-Tt[0],It[1]-Tt[1],pt*(It[2]-Tt[2])],Xt=Ye._.cross($t,$t,[Lt[0]-Tt[0],Lt[1]-Tt[1],pt*(Lt[2]-Tt[2])]);Ye._.normalize(Xt,Xt),St.dotProductWithUp=Ye._.dot(Xt,wt)}return Tt.sort(((Ye,ut)=>Ye.dotProductWithUp-ut.dotProductWithUp)),Tt[0].corners}(Lt,$t),Sr=Lt[Xt[0]],Lr=Lt[Xt[1]],Qr=Lt[Xt[2]],fn=Lt[Xt[3]],xn=It.getAtPointOrZero(new Oc(Sr[0]/pt.worldSize,Sr[1]/pt.worldSize),0),vn=It.getAtPointOrZero(new Oc(Lr[0]/pt.worldSize,Lr[1]/pt.worldSize),0),kn=It.getAtPointOrZero(new Oc(Qr[0]/pt.worldSize,Qr[1]/pt.worldSize),0),Wn=It.getAtPointOrZero(new Oc(fn[0]/pt.worldSize,fn[1]/pt.worldSize),0),Xn=(xn+Wn)/2,Jn=(vn+kn)/2;return Xn>Jn?vn<kn?Db(ut,Lr,fn,Sr,vn,Wn,xn,$t):Db(ut,Qr,Sr,fn,kn,xn,Wn,$t):xn<Wn?Db(ut,Sr,Lr,Qr,xn,vn,kn,$t):Db(ut,fn,Qr,Lr,Wn,kn,vn,$t),Math.max(Xn,Jn)}(It,wt,pt.aabb,ut,Tt);const Lt=Ye.ad.fromQuat([],It),$t=Ye.ad.multiply([],Lt,Qn);Ye.ad.multiply(ut,Xn,$t)}else St=wt.elevation.getAtPointOrZero(new Oc(Qr.x/Wn,Qr.y/Wn),0);0!==St&&(ut[14]+=St)}}function Qb(Ye,ut,pt=!1){Ye.uploaded||(Ye.gfxTexture=new Gg(ut,Ye.image,pt?ut.gl.R8:ut.gl.RGBA,{useMipmap:Ye.sampler.minFilter>=ut.gl.NEAREST_MIPMAP_NEAREST}),Ye.uploaded=!0,Ye.image=null)}function tv(Ye,ut,pt){Ye.indexBuffer=ut.createIndexBuffer(Ye.indexArray,!1,!0),Ye.vertexBuffer=ut.createVertexBuffer(Ye.vertexArray,gT.members,!1,!0),Ye.normalArray&&(Ye.normalBuffer=ut.createVertexBuffer(Ye.normalArray,bT.members,!1,!0)),Ye.texcoordArray&&(Ye.texcoordBuffer=ut.createVertexBuffer(Ye.texcoordArray,vT.members,!1,!0)),Ye.colorArray&&(Ye.colorBuffer=ut.createVertexBuffer(Ye.colorArray,(12===Ye.colorArray.bytesPerElement?yT:xT).members,!1,!0)),Ye.featureArray&&(Ye.pbrBuffer=ut.createVertexBuffer(Ye.featureArray,TT.members,!0)),Ye.segments=Au.simpleSegment(0,0,Ye.vertexArray.length,Ye.indexArray.length);const wt=Ye.material;wt.pbrMetallicRoughness.baseColorTexture&&Qb(wt.pbrMetallicRoughness.baseColorTexture,ut),wt.pbrMetallicRoughness.metallicRoughnessTexture&&Qb(wt.pbrMetallicRoughness.metallicRoughnessTexture,ut),wt.normalTexture&&Qb(wt.normalTexture,ut),wt.occlusionTexture&&Qb(wt.occlusionTexture,ut,pt),wt.emissionTexture&&Qb(wt.emissionTexture,ut)}function ev(Ye,ut,pt){if(Ye.meshes)for(const wt of Ye.meshes)tv(wt,ut,pt);if(Ye.children)for(const wt of Ye.children)ev(wt,ut,pt)}function rv(Ye){if(Ye.meshes)for(const ut of Ye.meshes)ut.indexArray.destroy(),ut.vertexArray.destroy(),ut.colorArray&&ut.colorArray.destroy(),ut.normalArray&&ut.normalArray.destroy(),ut.texcoordArray&&ut.texcoordArray.destroy(),ut.featureArray&&ut.featureArray.destroy();if(Ye.children)for(const ut of Ye.children)rv(ut)}function nv(Ye){if(Ye.meshes)for(const pt of Ye.meshes)pt.vertexBuffer&&(pt.vertexBuffer.destroy(),pt.indexBuffer.destroy(),pt.normalBuffer&&pt.normalBuffer.destroy(),pt.texcoordBuffer&&pt.texcoordBuffer.destroy(),pt.colorBuffer&&pt.colorBuffer.destroy(),pt.pbrBuffer&&pt.pbrBuffer.destroy(),pt.segments.destroy(),pt.material&&((ut=pt.material).pbrMetallicRoughness.baseColorTexture&&ut.pbrMetallicRoughness.baseColorTexture.gfxTexture&&ut.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),ut.pbrMetallicRoughness.metallicRoughnessTexture&&ut.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&ut.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),ut.normalTexture&&ut.normalTexture.gfxTexture&&ut.normalTexture.gfxTexture.destroy(),ut.emissionTexture&&ut.emissionTexture.gfxTexture&&ut.emissionTexture.gfxTexture.destroy(),ut.occlusionTexture&&ut.occlusionTexture.gfxTexture&&ut.occlusionTexture.gfxTexture.destroy()));var ut;if(Ye.children)for(const ut of Ye.children)nv(ut)}class iv{constructor(Ye){this._callback=Ye,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class sv{constructor(){this.tasks={},this.taskQueue=[],or(["process"],this),this.invoker=new iv(this.process),this.nextId=0}add(Ye,ut){const pt=this.nextId++,wt=function({type:Ye,isSymbolTile:ut,zoom:pt}){return pt=pt||0,"message"===Ye?0:"maybePrepare"!==Ye||ut?"parseTile"!==Ye||ut?"parseTile"===Ye&&ut?300-pt:"maybePrepare"===Ye&&ut?400-pt:500:200-pt:100-pt}(ut);if(0===wt){try{Ye()}finally{}return null}return this.tasks[pt]={fn:Ye,metadata:ut,priority:wt,id:pt},this.taskQueue.push(pt),this.invoker.trigger(),{cancel:()=>{delete this.tasks[pt]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((Ye=>!!this.tasks[Ye])),!this.taskQueue.length)return;const Ye=this.pick();if(null===Ye)return;const ut=this.tasks[Ye];if(delete this.tasks[Ye],this.taskQueue.length&&this.invoker.trigger(),!ut)return;ut.fn()}finally{}}pick(){let Ye=null,ut=1/0;for(let pt=0;pt<this.taskQueue.length;pt++){const wt=this.tasks[this.taskQueue[pt]];wt.priority<ut&&(ut=wt.priority,Ye=pt)}if(null===Ye)return null;const pt=this.taskQueue[Ye];return this.taskQueue.splice(Ye,1),pt}remove(){this.invoker.remove()}}class av{constructor(Ye,ut,pt){this.target=Ye,this.parent=ut,this.mapId=pt,this.callbacks={},this.cancelCallbacks={},or(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new sv}send(Ye,ut,pt,wt,Tt=!1,St){const It=Math.round(1e18*Math.random()).toString(36).substring(0,10);pt&&(pt.metadata=St,this.callbacks[It]=pt);const Lt=new Set;return this.target.postMessage({id:It,type:Ye,hasCallback:!!pt,targetMapId:wt,mustQueue:Tt,sourceMapId:this.mapId,data:Io(ut,Lt)},Lt),{cancel:()=>{pt&&delete this.callbacks[It],this.target.postMessage({id:It,type:"<cancel>",targetMapId:wt,sourceMapId:this.mapId})}}}receive(Ye){const ut=Ye.data,pt=ut.id;if(pt&&(!ut.targetMapId||this.mapId===ut.targetMapId))if("<cancel>"===ut.type){const Ye=this.cancelCallbacks[pt];delete this.cancelCallbacks[pt],Ye&&Ye.cancel()}else if(ut.mustQueue||gr()){const Ye=this.callbacks[pt],wt=this.scheduler.add((()=>this.processTask(pt,ut)),Ye&&Ye.metadata||{type:"message"});wt&&(this.cancelCallbacks[pt]=wt)}else this.processTask(pt,ut)}processTask(Ye,ut){if(delete this.cancelCallbacks[Ye],"<response>"===ut.type){const pt=this.callbacks[Ye];delete this.callbacks[Ye],pt&&(ut.error?pt(To(ut.error)):pt(null,To(ut.data)))}else{const pt=new Set,wt=ut.hasCallback?(ut,wt)=>{this.target.postMessage({id:Ye,type:"<response>",sourceMapId:this.mapId,error:ut?Io(ut):null,data:Io(wt,pt)},pt)}:Ye=>{},Tt=To(ut.data);if(this.parent[ut.type])this.parent[ut.type](ut.sourceMapId,Tt,wt);else if(this.parent.getWorkerSource){const Ye=ut.type.split(".");this.parent.getWorkerSource(ut.sourceMapId,Ye[0],Tt.source,Tt.scope)[Ye[1]](Tt,wt)}else wt(new Error(`Could not find function ${ut.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class ov{constructor(Ye,ut){this.workerPool=Ye,this.actors=[],this.currentActor=0,this.id=nr();const pt=this.workerPool.acquire(this.id);for(let Ye=0;Ye<pt.length;Ye++){const wt=new ov.Actor(pt[Ye],ut,this.id);wt.name=`Worker ${Ye}`,this.actors.push(wt)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(Ye,ut,pt){Qe(this.actors,((pt,wt)=>{pt.send(Ye,ut,wt)}),pt=pt||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((Ye=>{Ye.remove()})),this.actors=[],this.workerPool.release(this.id)}}ov.Actor=av;var IT={workerUrl:"",workerClass:null,workerParams:void 0};function uv(){return null!=IT.workerClass?new IT.workerClass:new self.Worker(IT.workerUrl,IT.workerParams)}const CT="mapboxgl_preloaded_worker_pool";class hv{constructor(){this.active={}}acquire(Ye){if(!this.workers)for(this.workers=[];this.workers.length<hv.workerCount;)this.workers.push(new uv);return this.active[Ye]=!0,this.workers.slice()}release(Ye){delete this.active[Ye],this.workers&&0===this.numActive()&&(this.workers.forEach((Ye=>{Ye.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[CT]}numActive(){return Object.keys(this.active).length}}let PT;function fv(){return PT||(PT=new hv),PT}hv.workerCount=2;let zT,DT,RT,LT,kT,OT=null;function vv(){return gr()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:DT||St.DRACO_URL}function _v(){if(gr()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(LT)return LT;const Ye=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return LT=WebAssembly.validate(Ye)?St.MESHOPT_SIMD_URL:St.MESHOPT_URL,LT}const BT={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},FT={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},NT={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Sv(Ye,ut,pt){const wt=pt.json.bufferViews.length,Tt=pt.buffers.length;ut.bufferView=wt,pt.json.bufferViews[wt]={buffer:Tt,byteLength:Ye.byteLength},pt.buffers[Tt]=Ye}const VT="KHR_draco_mesh_compression";function Tv(Ye,ut){const pt=Ye.extensions&&Ye.extensions[VT];if(!pt)return;const wt=new RT.Decoder,Tt=Cv(ut,pt.bufferView),St=new RT.Mesh;if(!wt.DecodeArrayToMesh(Tt,Tt.byteLength,St))throw new Error("Failed to decode Draco mesh");const It=ut.json.accessors[Ye.indices],Lt=BT[It.componentType],$t=It.count*Lt.BYTES_PER_ELEMENT,Xt=RT._malloc($t);Lt===Uint16Array?wt.GetTrianglesUInt16Array(St,$t,Xt):wt.GetTrianglesUInt32Array(St,$t,Xt),Sv(RT.memory.buffer.slice(Xt,Xt+$t),It,ut),RT._free(Xt);for(const Tt of Object.keys(pt.attributes)){const It=wt.GetAttributeByUniqueId(St,pt.attributes[Tt]),Lt=ut.json.accessors[Ye.attributes[Tt]],$t=FT[Lt.componentType],Xt=Lt.count*NT[Lt.type]*BT[Lt.componentType].BYTES_PER_ELEMENT,Sr=RT._malloc(Xt);wt.GetAttributeDataArrayForAllPoints(St,It,RT[$t],Xt,Sr),Sv(RT.memory.buffer.slice(Sr,Sr+Xt),Lt,ut),RT._free(Sr)}wt.destroy(),St.destroy(),delete Ye.extensions[VT]}const UT="EXT_meshopt_compression";function Pv(Ye,ut){if(!Ye.extensions||!Ye.extensions[UT])return;const pt=Ye.extensions[UT],wt=new Uint8Array(ut.buffers[pt.buffer],pt.byteOffset||0,pt.byteLength||0),Tt=new Uint8Array(pt.count*pt.byteStride);kT.decodeGltfBuffer(Tt,pt.count,pt.byteStride,wt,pt.mode,pt.filter),Ye.buffer=ut.buffers.length,Ye.byteOffset=0,ut.buffers[Ye.buffer]=Tt.buffer,delete Ye.extensions[UT]}const jT=1179937895,GT=new TextDecoder("utf8");function Bv(Ye,ut){return new URL(Ye,ut).href}function Dv(Ye,ut,pt,wt){return fetch(Bv(Ye.uri,wt)).then((Ye=>Ye.arrayBuffer())).then((Ye=>{ut.buffers[pt]=Ye}))}function Cv(Ye,ut){const pt=Ye.json.bufferViews[ut];return new Uint8Array(Ye.buffers[pt.buffer],pt.byteOffset||0,pt.byteLength)}function Rv(Ye,ut,pt,wt){if(Ye.uri){const Tt=Bv(Ye.uri,wt);return fetch(Tt).then((Ye=>Ye.blob())).then((Ye=>createImageBitmap(Ye))).then((Ye=>{ut.images[pt]=Ye}))}if(void 0!==Ye.bufferView){const wt=Cv(ut,Ye.bufferView),Tt=new Blob([wt],{type:Ye.mimeType});return createImageBitmap(Tt).then((Ye=>{ut.images[pt]=Ye}))}}function Vv(Ye,ut=0,pt){const wt={json:null,images:[],buffers:[]};if(new Uint32Array(Ye,ut,1)[0]===jT){const pt=new Uint32Array(Ye,ut);let Tt=2;const St=(pt[Tt++]>>2)-3,It=pt[Tt++]>>2;if(Tt++,wt.json=JSON.parse(GT.decode(pt.subarray(Tt,Tt+It))),Tt+=It,Tt<St){const St=pt[Tt++];Tt++;const It=ut+(Tt<<2);wt.buffers[0]=Ye.slice(It,It+St)}}else wt.json=JSON.parse(GT.decode(new Uint8Array(Ye,ut)));const{buffers:Tt,images:St,meshes:It,extensionsUsed:Lt,bufferViews:$t}=wt.json;let Xt=Promise.resolve();if(Tt){const Ye=[];for(let ut=0;ut<Tt.length;ut++){const St=Tt[ut];St.uri?Ye.push(Dv(St,wt,ut,pt)):wt.buffers[ut]||(wt.buffers[ut]=null)}Xt=Promise.all(Ye)}return Xt.then((()=>{const Ye=[],ut=Lt&&Lt.includes(VT),Tt=Lt&&Lt.includes(UT);if(ut&&Ye.push(function(){if(!RT)return zT||(zT=function(Ye){let ut,pt=null;function n(){ut=new Uint8Array(pt.buffer)}function i(){throw new Error("Unexpected Draco error.")}const wt={a:{a:i,d:function(Ye,pt,wt){return ut.copyWithin(Ye,pt,pt+wt)},c:function(Ye){const wt=ut.length,Tt=Math.max(Ye>>>0,Math.ceil(1.2*wt)),St=Math.ceil((Tt-wt)/65536);try{return pt.grow(St),n(),!0}catch(Ye){return!1}},b:i}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(Ye,wt):Ye.then((Ye=>Ye.arrayBuffer())).then((Ye=>WebAssembly.instantiate(Ye,wt)))).then((Ye=>{const{Rb:wt,Qb:Tt,P:St,T:It,X:Lt,Ja:$t,La:Xt,Qa:Sr,Va:Lr,Wa:Qr,eb:fn,jb:xn,f:vn,e:kn,yb:Wn,zb:Xn,Ab:Jn,Bb:Qn,Db:ko,Gb:Fo}=Ye.instance.exports;pt=kn;const is=(()=>{let Ye=0,pt=0,St=0,It=0;return Lt=>{St&&(wt(It),wt(Ye),pt+=St,St=Ye=0),Ye||(pt+=128,Ye=Tt(pt));const $t=Lt.length+7&-8;let Xt=Ye;$t>=pt&&(St=$t,Xt=It=Tt($t));for(let Ye=0;Ye<Lt.length;Ye++)ut[Xt+Ye]=Lt[Ye];return Xt}})();return n(),vn(),{memory:kn,_free:wt,_malloc:Tt,Mesh:class{constructor(){this.ptr=St()}destroy(){It(this.ptr)}},Decoder:class{constructor(){this.ptr=$t()}destroy(){xn(this.ptr)}DecodeArrayToMesh(Ye,ut,pt){const wt=is(Ye),Tt=Xt(this.ptr,wt,ut,pt.ptr);return!!Lt(Tt)}GetAttributeByUniqueId(Ye,ut){return{ptr:Sr(this.ptr,Ye.ptr,ut)}}GetTrianglesUInt16Array(Ye,ut,pt){Lr(this.ptr,Ye.ptr,ut,pt)}GetTrianglesUInt32Array(Ye,ut,pt){Qr(this.ptr,Ye.ptr,ut,pt)}GetAttributeDataArrayForAllPoints(Ye,ut,pt,wt,Tt){fn(this.ptr,Ye.ptr,ut.ptr,pt,wt,Tt)}},DT_INT8:Wn(),DT_UINT8:Xn(),DT_INT16:Jn(),DT_UINT16:Qn(),DT_UINT32:ko(),DT_FLOAT32:Fo()}}))}(fetch(vv())),zT.then((Ye=>{RT=Ye,zT=void 0})))}()),Tt&&Ye.push(function(){if(kT)return;const Ye=function(Ye){let ut;const pt=WebAssembly.instantiateStreaming(Ye,{}).then((Ye=>{ut=Ye.instance,ut.exports.__wasm_call_ctors()})),wt={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Tt={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:pt,supported:!0,decodeGltfBuffer(Ye,pt,St,It,Lt,$t){!function(Ye,ut,pt,wt,Tt,St,It){const Lt=Ye.exports.sbrk,$t=wt+3&-4,Xt=Lt($t*Tt),Sr=Lt(St.length),Lr=new Uint8Array(Ye.exports.memory.buffer);Lr.set(St,Sr);const Qr=ut(Xt,wt,Tt,Sr,St.length);if(0===Qr&&It&&It(Xt,$t,Tt),pt.set(Lr.subarray(Xt,Xt+wt*Tt)),Lt(Xt-Lt(0)),0!==Qr)throw new Error(`Malformed buffer data: ${Qr}`)}(ut,ut.exports[Tt[Lt]],Ye,pt,St,It,ut.exports[wt[$t]])}}}(fetch(_v()));return Ye.ready.then((()=>{kT=Ye}))}()),St)for(let ut=0;ut<St.length;ut++)Ye.push(Rv(St[ut],wt,ut,pt));return(Ye.length?Promise.all(Ye):Promise.resolve()).then((()=>{if(ut&&It)for(const{primitives:Ye}of It)for(const ut of Ye)Tv(ut,wt);if(Tt&&It&&$t)for(const Ye of $t)Pv(Ye,wt);return wt}))}))}function Lv(Ye,ut){const pt=Ye.json.bufferViews[ut.bufferView],wt=BT[ut.componentType];return new wt(Ye.buffers[pt.buffer],(ut.byteOffset||0)+(pt.byteOffset||0),ut.count*(pt.byteStride&&pt.byteStride!==NT[ut.type]*wt.BYTES_PER_ELEMENT?pt.byteStride/wt.BYTES_PER_ELEMENT:NT[ut.type]))}function Ov(Ye,ut,pt,wt){const Tt=BT[ut.componentType],St=function(Ye){switch(Ye){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(Tt),It=Ye.json.bufferViews[ut.bufferView],Lt=It.byteStride?It.byteStride/Tt.BYTES_PER_ELEMENT:NT[ut.type],$t=pt.float32,Xt=$t.length/pt.capacity;for(let Ye=0,pt=0;Ye<ut.count*Lt;Ye+=Lt,pt+=Xt)for(let ut=0;ut<Xt;ut++)$t[pt+ut]=wt[Ye+ut]*St;pt._trim()}function Fv(Ye,ut,pt){const wt=Ye.indices,Tt=Ye.attributes,St={};St.indexArray=new Ql;const It=ut.json.accessors[wt],Lt=It.count/3;St.indexArray.reserve(Lt);const $t=Lv(ut,It);for(let Ye=0;Ye<Lt;Ye++)St.indexArray.emplaceBack($t[3*Ye],$t[3*Ye+1],$t[3*Ye+2]);St.indexArray._trim(),St.vertexArray=new Ul;const Xt=ut.json.accessors[Tt.POSITION];St.vertexArray.reserve(Xt.count);const Sr=Lv(ut,Xt);for(let Ye=0;Ye<Xt.count;Ye++)St.vertexArray.emplaceBack(Sr[3*Ye],Sr[3*Ye+1],Sr[3*Ye+2]);if(St.vertexArray._trim(),St.aabb=new Ah(Xt.min,Xt.max),St.centroid=function(Ye,ut){const pt=[0,0,0],wt=Ye.length;if(wt>0){for(let Tt=0;Tt<wt;Tt++){const wt=3*Ye[Tt];pt[0]+=ut[wt],pt[1]+=ut[wt+1],pt[2]+=ut[wt+2]}pt[0]/=wt,pt[1]/=wt,pt[2]/=wt}return pt}($t,Sr),void 0!==Tt.COLOR_0){const Ye=ut.json.accessors[Tt.COLOR_0],pt=NT[Ye.type],wt=Lv(ut,Ye);St.colorArray=3===pt?new Ul:new Fl,St.colorArray.resize(Ye.count),Ov(ut,Ye,St.colorArray,wt)}if(void 0!==Tt.NORMAL){St.normalArray=new Ul;const Ye=ut.json.accessors[Tt.NORMAL];St.normalArray.resize(Ye.count);const pt=Lv(ut,Ye);Ov(ut,Ye,St.normalArray,pt)}if(void 0!==Tt.TEXCOORD_0&&pt.length>0){St.texcoordArray=new iu;const Ye=ut.json.accessors[Tt.TEXCOORD_0];St.texcoordArray.resize(Ye.count);const pt=Lv(ut,Ye);Ov(ut,Ye,St.texcoordArray,pt)}if(void 0!==Tt._FEATURE_ID_RGBA4444){const Ye=ut.json.accessors[Tt._FEATURE_ID_RGBA4444];ut.json.extensionsUsed&&ut.json.extensionsUsed.includes("EXT_meshopt_compression")&&(St.featureData=Lv(ut,Ye))}void 0!==Tt._FEATURE_RGBA4444&&(St.featureData=new Uint32Array(Lv(ut,ut.json.accessors[Tt._FEATURE_RGBA4444]).buffer));const Lr=Ye.material;return St.material=function(Ye,ut){const{emissiveFactor:pt=[0,0,0],alphaMode:wt="OPAQUE",alphaCutoff:Tt=.5,normalTexture:St,occlusionTexture:It,emissiveTexture:Lt,doubleSided:$t}=Ye,{baseColorFactor:Xt=[1,1,1,1],metallicFactor:Sr=1,roughnessFactor:Lr=1,baseColorTexture:Qr,metallicRoughnessTexture:fn}=Ye.pbrMetallicRoughness||{},xn=It?ut[It.index]:void 0;if(It&&It.extensions&&It.extensions.KHR_texture_transform&&xn){const Ye=It.extensions.KHR_texture_transform;xn.offsetScale=[Ye.offset[0],Ye.offset[1],Ye.scale[0],Ye.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new qn(...Xt),metallicFactor:Sr,roughnessFactor:Lr,baseColorTexture:Qr?ut[Qr.index]:void 0,metallicRoughnessTexture:fn?ut[fn.index]:void 0},doubleSided:$t,emissiveFactor:pt,alphaMode:wt,alphaCutoff:Tt,normalTexture:St?ut[St.index]:void 0,occlusionTexture:xn,emissionTexture:Lt?ut[Lt.index]:void 0,defined:void 0===Ye.defined}}(void 0!==Lr?ut.json.materials[Lr]:{defined:!1},pt),St}function Uv(ut,pt,wt){const{matrix:Tt,rotation:St,translation:It,scale:Lt,mesh:$t,extras:Xt,children:Sr}=ut,Lr={};if(Lr.matrix=Tt||Ye.ad.fromRotationTranslationScale([],St||[0,0,0,1],It||[0,0,0],Lt||[1,1,1]),void 0!==$t){Lr.meshes=wt[$t];const Ye=Lr.anchor=[0,0];for(const ut of Lr.meshes){const{min:pt,max:wt}=ut.aabb;Ye[0]+=pt[0]+wt[0],Ye[1]+=pt[1]+wt[1]}Ye[0]=Math.floor(Ye[0]/Lr.meshes.length/2),Ye[1]=Math.floor(Ye[1]/Lr.meshes.length/2)}if(Xt&&(Xt.id&&(Lr.id=Xt.id),Xt.lights&&(Lr.lights=function(Ye){if(!Ye.length)return[];const ut=function(Ye){const ut=atob(Ye),pt=new Uint8Array(ut.length);for(let Ye=0;Ye<ut.length;Ye++)pt[Ye]=ut.codePointAt(Ye);return pt}(Ye),pt=[],wt=ut.length/24,Tt=new Uint16Array(ut.buffer),St=new Float32Array(ut.buffer);for(let Ye=0;Ye<wt;Ye++){const ut=Tt[2*Ye*6]/30,wt=Tt[2*Ye*6+1]/30,It=Tt[2*Ye*6+10]/100,Lt=St[6*Ye+1],$t=St[6*Ye+2],Xt=St[6*Ye+3],Sr=St[6*Ye+4],Lr=Xt-Lt,Qr=Sr-$t,fn=Math.hypot(Lr,Qr);pt.push({pos:[Lt+.5*Lr,$t+.5*Qr,wt],normal:[Qr/fn,-Lr/fn,0],width:fn,height:ut,depth:It,points:[Lt,$t,Xt,Sr]})}return pt}(Xt.lights))),Sr){const Ye=[];for(const ut of Sr)Ye.push(Uv(pt.json.nodes[ut],pt,wt));Lr.children=Ye}return Lr}function Nv(Ye){if(0===Ye.vertices.length||0===Ye.indices.length)return null;const ut=new tf(Ye.vertices,Ye.indices,8,256),[pt,wt]=[ut.min.clone(),ut.max.clone()];return{vertices:Ye.vertices,indices:Ye.indices,grid:ut,min:pt,max:wt}}function jv(Ye){if(!Ye.extras||!Ye.extras.ground)return null;const ut=Ye.extras.ground;if(!ut||!Array.isArray(ut)||0===ut.length)return null;const pt=ut[0];if(!pt||!Array.isArray(pt)||0===pt.length)return null;const wt=[];for(const Ye of pt){if(!Array.isArray(Ye)||2!==Ye.length)continue;const ut=Ye[0],pt=Ye[1];"number"==typeof ut&&"number"==typeof pt&&wt.push(new wu(ut,pt))}if(wt.length<3)return null;wt.length>1&&wt[wt.length-1].equals(wt[0])&&wt.pop();let Tt=0;for(let Ye=0;Ye<wt.length;Ye++){const ut=wt[Ye],pt=wt[(Ye+1)%wt.length],St=wt[(Ye+2)%wt.length];Tt+=(ut.x-pt.x)*(St.y-pt.y)-(St.x-pt.x)*(ut.y-pt.y)}Tt>0&&wt.reverse();const St=wp(wt.flatMap((Ye=>[Ye.x,Ye.y])),[]);return 0===St.length?null:{vertices:wt,indices:St}}function qv(ut,pt){const wt=[],Tt=[];let St=0;const It=[];for(const Lt of ut){St=wt.length;const ut=Lt.vertexArray.float32,$t=Lt.indexArray.uint16;for(let Tt=0;Tt<Lt.vertexArray.length;Tt++)It[0]=ut[3*Tt+0],It[1]=ut[3*Tt+1],It[2]=ut[3*Tt+2],Ye._.transformMat4(It,It,pt),wt.push(new wu(It[0],It[1]));for(let Ye=0;Ye<3*Lt.indexArray.length;Ye++)Tt.push($t[Ye]+St)}if(Tt.length%3!=0)return null;for(let Ye=0;Ye<Tt.length;Ye+=3){const ut=wt[Tt[Ye+0]],pt=wt[Tt[Ye+1]],St=wt[Tt[Ye+2]];(ut.x-pt.x)*(St.y-pt.y)-(St.x-pt.x)*(ut.y-pt.y)>0&&([Tt[Ye+1],Tt[Ye+2]]=[Tt[Ye+2],Tt[Ye+1]])}return{vertices:wt,indices:Tt}}function $v(Ye){const ut=function(Ye,ut){const pt=[],wt=WebGL2RenderingContext;if(Ye.json.textures)for(const Tt of Ye.json.textures){const St={magFilter:wt.LINEAR,minFilter:wt.NEAREST,wrapS:wt.REPEAT,wrapT:wt.REPEAT};void 0!==Tt.sampler&&Object.assign(St,Ye.json.samplers[Tt.sampler]),pt.push({image:ut[Tt.source],sampler:St,uploaded:!1})}return pt}(Ye,Ye.images),pt=function(Ye,ut){const pt=[];for(const wt of Ye.json.meshes){const Tt=[];for(const pt of wt.primitives)Tt.push(Fv(pt,Ye,ut));pt.push(Tt)}return pt}(Ye,ut),{scenes:wt,scene:Tt,nodes:St}=Ye.json,It=wt?wt[Tt||0].nodes:St,Lt=[];for(const ut of It)Lt.push(Uv(St[ut],Ye,pt));return function(Ye,ut,pt){const wt={},Tt=new Set;for(let St=0;St<Ye.length;St++){const Ye=pt[ut[St]];if(!Ye.extras)continue;const It=Ye.extras["mapbox:footprint:version"],Lt=Ye.extras["mapbox:footprint:id"];(It||Lt)&&Tt.add(St),"1.0.0"===It&&Lt&&(wt[Lt]=St)}for(let St=0;St<Ye.length;St++){if(Tt.has(St))continue;const It=Ye[St],Lt=pt[ut[St]];if(!Lt.extras)continue;let $t=null;It.id in wt&&($t=qv(Ye[wt[It.id]].meshes,It.matrix)),$t||($t=jv(Lt)),$t&&(It.footprint=Nv($t))}if(Tt.size>0){const ut=Array.from(Tt.values()).sort(((Ye,ut)=>Ye-ut));for(let pt=ut.length-1;pt>=0;pt--)Ye.splice(ut[pt],1)}}(Lt,It,Ye.json.nodes),Lt}function Gv(Ye){Ye.heightmap=new Float32Array(4096),Ye.heightmap.fill(-1);const ut=Ye.vertexArray.float32,pt=Ye.aabb.min[0]-1,wt=Ye.aabb.min[1]-1,Tt=AT/(Ye.aabb.max[0]-pt+2),St=AT/(Ye.aabb.max[1]-wt+2);for(let It=0;It<ut.length;It+=3){const Lt=ut[It+2],$t=(ut[It+0]-pt)*Tt|0,Xt=(ut[It+1]-wt)*St|0;Lt>Ye.heightmap[Xt*AT+$t]&&(Ye.heightmap[Xt*AT+$t]=Lt)}}function Yv(ut,pt){const wt={};wt.indexArray=new Ql,wt.indexArray.reserve(4*ut.length),wt.vertexArray=new Ul,wt.vertexArray.reserve(10*ut.length),wt.colorArray=new Fl,wt.vertexArray.reserve(10*ut.length);let Tt=0;for(const St of ut){const ut=Math.min(10,Math.max(4,1.3*St.height))*pt,It=[-St.normal[1],St.normal[0],0],Lt=Math.min(.29,.1*St.width/St.depth),$t=St.width-2*St.depth*pt*(Lt+.01),Xt=Ye._.scaleAndAdd([],St.pos,It,$t/2),Sr=Ye._.scaleAndAdd([],St.pos,It,-$t/2),Lr=[Xt[0],Xt[1],Xt[2]+St.height],Qr=[Sr[0],Sr[1],Sr[2]+St.height],fn=Ye._.scaleAndAdd([],St.normal,It,Lt);Ye._.scale(fn,fn,ut);const xn=Ye._.scaleAndAdd([],St.normal,It,-Lt);Ye._.scale(xn,xn,ut),Ye._.add(fn,Xt,fn),Ye._.add(xn,Sr,xn),Xt[2]+=.1,Sr[2]+=.1,wt.vertexArray.emplaceBack(fn[0],fn[1],fn[2]),wt.vertexArray.emplaceBack(xn[0],xn[1],xn[2]),wt.vertexArray.emplaceBack(Xt[0],Xt[1],Xt[2]),wt.vertexArray.emplaceBack(Sr[0],Sr[1],Sr[2]),wt.vertexArray.emplaceBack(Lr[0],Lr[1],Lr[2]),wt.vertexArray.emplaceBack(Qr[0],Qr[1],Qr[2]),wt.vertexArray.emplaceBack(Xt[0],Xt[1],Xt[2]),wt.vertexArray.emplaceBack(Sr[0],Sr[1],Sr[2]),wt.vertexArray.emplaceBack(fn[0],fn[1],fn[2]),wt.vertexArray.emplaceBack(xn[0],xn[1],xn[2]);const vn=$t/ut/2;wt.colorArray.emplaceBack(-vn-Lt,-1,vn,.8),wt.colorArray.emplaceBack(vn+Lt,-1,vn,.8),wt.colorArray.emplaceBack(-vn,0,vn,1.3),wt.colorArray.emplaceBack(vn,0,vn,1.3),wt.colorArray.emplaceBack(vn+Lt,-.8,vn,.7),wt.colorArray.emplaceBack(vn+Lt,-.8,vn,.7),wt.colorArray.emplaceBack(0,0,vn,1.3),wt.colorArray.emplaceBack(0,0,vn,1.3),wt.colorArray.emplaceBack(vn+Lt,-1.2,vn,.8),wt.colorArray.emplaceBack(vn+Lt,-1.2,vn,.8),wt.indexArray.emplaceBack(6+Tt,4+Tt,8+Tt),wt.indexArray.emplaceBack(7+Tt,9+Tt,5+Tt),wt.indexArray.emplaceBack(0+Tt,1+Tt,2+Tt),wt.indexArray.emplaceBack(1+Tt,3+Tt,2+Tt),Tt+=10}const St={defined:!0,emissiveFactor:[0,0,0]},It={};return It.baseColorFactor=qn.white,St.pbrMetallicRoughness=It,wt.material=St,wt.aabb=new Ah([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),wt}const qT=new Float32Array(262144),ZT=new Uint8Array(262144);function Hv(Ye){let ut=0;if(Ye.meshes)for(const pt of Ye.meshes)ut=Math.max(ut,pt.aabb.max[2]);if(Ye.children)for(const pt of Ye.children)ut=Math.max(ut,Hv(pt));return ut}function Kv(Ye,ut,pt){if(Ye.meshes)for(const wt of Ye.meshes)wt.aabb.min[0]!==1/0&&pt.insert(ut,wt.aabb.min[0],wt.aabb.min[1],wt.aabb.max[0],wt.aabb.max[1]);if(Ye.children)for(const wt of Ye.children)Kv(wt,ut,pt)}const $T=["","wall","door","roof","window","lamp","logo"];class Jv{constructor(Ye){this.node=Ye,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:Ye.id,geometry:[],properties:{height:Hv(Ye)}},this.aabb=this._getLocalBounds()}_getLocalBounds(){if(!this.node.meshes)return new Ah([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let Ye=0;const ut=new Ah([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const pt of this.node.meshes)this.node.lightMeshIndex!==Ye&&(pt.transformedAabb=Ah.applyTransformFast(pt.aabb,this.node.matrix),ut.encapsulate(pt.transformedAabb)),Ye++;this.aabb=ut}return this.aabb}}class Qv{constructor(Ye,ut,pt,wt,Tt,St){this.id=ut,this.modelTraits|=ST.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,pt&&(this.modelTraits|=ST.HasMapboxMeshFeatures),wt&&(this.modelTraits|=ST.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=Tt,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const ut of Ye)this.nodesInfo.push(new Jv(ut)),Kv(ut,St.featureIndexArray.length,St.grid),St.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,St.bucketLayerIDs.length-1,0)}updateFootprints(Ye,ut){for(const pt of this.getNodesInfo()){const wt=pt.node;wt.footprint&&ut.push({footprint:wt.footprint,id:Ye})}}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(Ye){if(!this.needsUpload)return;const ut=this.getNodesInfo();for(const pt of ut){const ut=pt.node;this.uploaded?this.updatePbrBuffer(ut):ev(ut,Ye,!0)}for(const Ye of ut)rv(Ye.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(Ye){let ut=!1;if(!Ye.meshes)return ut;for(const pt of Ye.meshes)pt.pbrBuffer&&(pt.pbrBuffer.updateData(pt.featureArray),ut=!0);return ut}needsReEvaluation(Ye,ut,pt){const wt=Ye.transform.projectionOptions,Tt=Ye.style.getBrightness(),St=this.brightness!==Tt;return!!(!this.uploaded||this.dirty||wt.name!==this.projection.name||t_(pt.paint.get("model-color").value,St)||t_(pt.paint.get("model-color-mix-intensity").value,St)||t_(pt.paint.get("model-roughness").value,St)||t_(pt.paint.get("model-emissive-strength").value,St)||t_(pt.paint.get("model-height-based-emissive-strength-multiplier").value,St))&&(this.projection=wt,this.brightness=Tt,!0)}evaluateScale(Ye,ut){if(Ye.transform.zoom===this.zoom)return;this.zoom=Ye.transform.zoom;const pt=this.getNodesInfo(),wt=this.id.canonical;for(const Ye of pt){const pt=Ye.feature;Ye.evaluatedScale=ut.paint.get("model-scale").evaluate(pt,{},wt)}}evaluate(Ye){const ut=this.getNodesInfo();for(const pt of ut){if(!pt.node.meshes)continue;const ut=pt.feature,wt=pt.node.meshes&&pt.node.meshes[0].featureData,Tt=pt.evaluatedColor[2],St=pt.evaluatedRMEA[2],It=this.id.canonical;if(pt.hasTranslucentParts=!1,wt){for(let wt=0;wt<$T.length;wt++){const Tt=$T[wt];Tt.length&&(ut.properties.part=Tt);const St=Ye.paint.get("model-color").evaluate(ut,{},It).toRenderColor(null),Lt=Ye.paint.get("model-color-mix-intensity").evaluate(ut,{},It);pt.evaluatedColor[wt]=[St.r,St.g,St.b,Lt],pt.evaluatedRMEA[wt][0]=Ye.paint.get("model-roughness").evaluate(ut,{},It),pt.evaluatedRMEA[wt][2]=Ye.paint.get("model-emissive-strength").evaluate(ut,{},It),pt.evaluatedRMEA[wt][3]=St.a,pt.emissionHeightBasedParams[wt]=Ye.paint.get("model-height-based-emissive-strength-multiplier").evaluate(ut,{},It),!pt.hasTranslucentParts&&St.a<1&&(pt.hasTranslucentParts=!0)}delete ut.properties.part,r_(pt,Tt!==pt.evaluatedColor[2]||St!==pt.evaluatedRMEA[2],this.modelTraits)}else pt.evaluatedRMEA[0][2]=Ye.paint.get("model-emissive-strength").evaluate(ut,{},It);pt.evaluatedScale=Ye.paint.get("model-scale").evaluate(ut,{},It),this.updatePbrBuffer(pt.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(Ye,ut,pt,wt){const Tt=Ye.findDEMTileFor(pt);if(Tt&&(Tt.tileID.canonical!==this.terrainTile||ut!==this.terrainExaggeration)){if(Tt.dem&&Tt.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=Tt.tileID.overscaledZ;const ut=Qf.create(Ye,pt,Tt);if(!ut)return;this.modelTraits&ST.HasMapboxMeshFeatures&&this.updateDEM(Ye,ut,pt,wt);for(const Ye of this.getNodesInfo()){const pt=Ye.node;if(!pt.footprint||!pt.footprint.vertices||!pt.footprint.vertices.length)continue;const wt=pt.footprint.vertices;let Tt=ut.getElevationAt(wt[0].x,wt[0].y,!0,!0);for(let Ye=1;Ye<wt.length;Ye++)Tt=Math.min(Tt,ut.getElevationAt(wt[Ye].x,wt[Ye].y,!0,!0));pt.elevation=Tt}}this.terrainTile=Tt.tileID.canonical,this.terrainExaggeration=ut}}updateDEM(Ye,ut,pt,wt){let Tt=ut._dem._modifiedForSources[wt];if(void 0===Tt&&(ut._dem._modifiedForSources[wt]=[],Tt=ut._dem._modifiedForSources[wt]),Tt.includes(pt.canonical))return;const St=ut._dem.dim;Tt.push(pt.canonical);let It=!1;for(const Ye of this.getNodesInfo()){const pt=Ye.node;if(!pt.footprint||!pt.footprint.grid)continue;const wt=pt.footprint.grid,Tt=ut.tileCoordToPixel(wt.min.x,wt.min.y),Lt=ut.tileCoordToPixel(wt.max.x,wt.max.y),$t=Math.min(Math.min(St-Lt.y,Tt.x),Math.min(Tt.y,St-Lt.x));if($t<0)continue;const Xt=Ke($t,2,5);let Sr=Math.max(0,Tt.x-Xt),Lr=Math.max(0,Tt.y-Xt),Qr=Math.min(Lt.x+Xt,St-1),fn=Math.min(Lt.y+Xt,St-1);for(let Ye=Lr;Ye<=fn;++Ye)for(let ut=Sr;ut<=Qr;++ut)ZT[Ye*St+ut]=255;let xn=0,vn=0;for(let Ye=0;Ye<wt.cellsY;++Ye)for(let pt=0;pt<wt.cellsX;++pt){if(!wt.cells[Ye*wt.cellsX+pt])continue;const Tt=ut.tileCoordToPixel(wt.min.x+pt/wt.xScale,wt.min.y+Ye/wt.yScale),It=ut.tileCoordToPixel(wt.min.x+(pt+1)/wt.xScale,wt.min.y+(Ye+1)/wt.yScale);for(let Ye=Tt.y;Ye<=Math.min(It.y+1,St-1);++Ye)for(let pt=Tt.x;pt<=Math.min(It.x+1,St-1);++pt)255===ZT[Ye*St+pt]&&(ZT[Ye*St+pt]=0,xn+=ut.getElevationAtPixel(pt,Ye),vn++)}const kn=xn/vn;Sr=Math.max(1,Tt.x-Xt),Lr=Math.max(1,Tt.y-Xt),Qr=Math.min(Lt.x+Xt,St-2),fn=Math.min(Lt.y+Xt,St-2),It=!0;for(let Ye=Lr;Ye<=fn;++Ye)for(let pt=Sr;pt<=Qr;++pt)0===ZT[Ye*St+pt]&&(qT[Ye*St+pt]=ut._dem.set(pt,Ye,kn));for(let Ye=1;Ye<Xt;++Ye){Sr=Math.max(1,Tt.x-Ye),Lr=Math.max(1,Tt.y-Ye),Qr=Math.min(Lt.x+Ye,St-2),fn=Math.min(Lt.y+Ye,St-2);for(let pt=Lr;pt<=fn;++pt)for(let wt=Sr;wt<=Qr;++wt){const Tt=pt*St+wt;if(255===ZT[Tt]){let It=0,Lt=0,$t=-1,Sr=-1;for(let ut=-1;ut<=1;++ut)for(let Tt=-1;Tt<=1;++Tt){const Xt=(pt+ut)*St+wt+Tt;if(ZT[Xt]>=Ye)continue;const Lr=qT[Xt],Qr=Math.abs(Lr);Qr>Lt&&(It=Lr,Lt=Qr,$t=Tt,Sr=ut)}if(Lt>.1){const St=1-(Ye+.5*Math.abs($t*Sr))/Xt;let Lt=ut._dem.get(wt,pt)+It*St;const Lr=ut._dem.get(wt+$t,pt+Sr),Qr=ut._dem.get(wt-$t,pt-Sr,!0);(Lt-Lr)*(Lt-Qr)>0&&(Lt=(Lr+Qr)/2),qT[Tt]=ut._dem.set(wt,pt,Lt),ZT[Tt]=Ye}}}}}It&&(ut._demTile.needsDEMTextureUpload=!0,ut._dem._timestamp=sd.now())}getNodesInfo(){return this.nodesInfo}destroy(){const Ye=this.getNodesInfo();for(const ut of Ye)rv(ut.node),nv(ut.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(Ye,ut){if(ut.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=ut.updateTime;const pt=ut.getReplacementRegionsForTile(Ye.toUnwrapped()),wt=this.getNodesInfo();for(let Ye=0;Ye<this.nodesInfo.length;Ye++){const ut=wt[Ye].node;wt[Ye].hiddenByReplacement=!!ut.footprint&&!pt.find((Ye=>Ye.footprint===ut.footprint))}}getHeightAtTileCoord(ut,pt){const wt=this.getNodesInfo(),Tt=[],St=[0,0,0],It=Ye.ad.identity([]);for(let Lt=0;Lt<this.nodesInfo.length;Lt++){const $t=wt[Lt],Xt=$t.node.meshes[0],Sr=Xt.transformedAabb;if(ut<Sr.min[0]||pt<Sr.min[1]||ut>Sr.max[0]||pt>Sr.max[1])continue;if(!0===$t.node.hidden)return{height:0,maxHeight:$t.feature.properties.height,hidden:!1,verticalScale:$t.evaluatedScale[2]};Ye.ad.invert(It,$t.node.matrix),St[0]=ut,St[1]=pt,Ye._.transformMat4(St,St,It);const Lr=(St[0]-Xt.aabb.min[0])/(Xt.aabb.max[0]-Xt.aabb.min[0])*AT|0,Qr=Math.min(63,(St[1]-Xt.aabb.min[1])/(Xt.aabb.max[1]-Xt.aabb.min[1])*AT|0)*AT+Math.min(63,Lr),fn=Xt.heightmap[Qr];if(!(fn<0&&$t.node.footprint)){if($t.hiddenByReplacement)return;return{height:fn,maxHeight:$t.feature.properties.height,hidden:!1,verticalScale:$t.evaluatedScale[2]}}if($t.node.footprint.grid.query(new wu(ut,pt),new wu(ut,pt),Tt),Tt.length>0)return{height:void 0,maxHeight:$t.feature.properties.height,hidden:$t.hiddenByReplacement,verticalScale:$t.evaluatedScale[2]}}}}function t_(Ye,ut){return!Ye.isLightConstant&&ut}function e_(Ye,ut,pt,wt,Tt,St,It,Lt){let $t=(61440&ut|(61440&ut)>>4)>>8,Xt=(3840&ut|(3840&ut)>>4)>>4,Sr=240&ut|(240&ut)>>4;pt[3]>0&&($t=Gn($t,255*pt[0],pt[3]),Xt=Gn(Xt,255*pt[1],pt[3]),Sr=Gn(Sr,255*pt[2],pt[3]));const Lr=$t<<8|Xt,Qr=Sr<<8|Math.floor(255*wt[3]),fn=function(Ye){const ut=Ke(Ye,0,2);return Math.min(Math.round(.5*ut*255),255)}(wt[2])<<8|15*wt[0]<<4|15*wt[1],xn=Ke(Tt[0],0,1),vn=Ke(Tt[1],0,1),kn=Ke(Tt[2],0,1),Wn=Ke(Tt[3],0,1);let Xn,Jn,Qn,ko;if(xn!==vn&&It!==St&&vn!==xn){const Ye=It-St;Jn=1/(Ye*(vn-xn)),Qn=-(St+Ye*xn)/(Ye*(vn-xn));const ut=Ke(Tt[4],-1,1);ko=Math.pow(10,ut),Xn=255*kn<<8|255*Wn}else Xn=65535,Jn=0,Qn=1,ko=1;if(Ye.emplaceBack(Lr,Qr,fn,Xn,Jn,Qn,ko),Lt){const Ye=Lt.length;Lt.clear();for(let ut=0;ut<Ye;ut++)Lt.emplaceBack(Lr,Qr,fn,Xn,Jn,Qn,ko)}}function r_(Ye,ut,pt){const wt=Ye.node;let Tt=0;const St=pt&ST.HasMeshoptCompression;for(const pt of wt.meshes){if(wt.lights&&wt.lightMeshIndex===Tt)continue;if(!pt.featureData)continue;pt.featureArray=new lu,pt.featureArray.reserve(pt.featureData.length);let It=ut;for(const ut of pt.featureData){const Tt=St?65535&ut:ut>>16&65535,Lt=St?ut>>16&65535:65535&ut,$t=(15&Lt)<8?15&Lt:0,Xt=Ye.evaluatedRMEA[$t],Sr=Ye.evaluatedColor[$t],Lr=Ye.emissionHeightBasedParams[$t];let Qr;if(It&&2===$t&&wt.lights&&(Qr=new lu,Qr.resize(10*wt.lights.length)),e_(pt.featureArray,Tt,Sr,Xt,Lr,pt.aabb.min[2],pt.aabb.max[2],Qr),Qr&&It){It=!1;const Ye=wt.meshes[wt.lightMeshIndex];Ye.featureArray=Qr,Ye.featureArray._trim()}}pt.featureArray._trim(),Tt++}}function n_(Ye,ut,pt,wt){const Tt=1<<Ye.z;ut.lat=Ec((wt/ym+Ye.y)/Tt),ut.lng=zc((pt/ym+Ye.x)/Tt)}Mo(Qv,"Tiled3dModelBucket",{omit:["layers"]}),Mo(Jv,"Tiled3dModelFeature");const WT={circle:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,Hg,ut,pt,wt)}createBucket(Ye){return new Kc(Ye)}queryRadius(Ye){const ut=Ye;return hh("circle-radius",this,ut)+hh("circle-stroke-width",this,ut)+ph(this.paint.get("circle-translate"))}queryIntersectsFeature(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=dh(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),St.angle,Ye.pixelToTileUnitsFactor),Xt=this.paint.get("circle-radius").evaluate(ut,pt)+this.paint.get("circle-stroke-width").evaluate(ut,pt);return np(Ye,wt,St,It,Lt,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),$t,Xt)}getProgramIds(){return["circle"]}getDefaultProgramParams(Ye,ut,pt){const wt=rp(this);return{config:new Ku(this,{zoom:ut,lut:pt}),defines:wt,overrideFog:!1}}},heatmap:class extends kl{createBucket(Ye){return new lp(Ye)}constructor(Ye,ut,pt,wt){super(Ye,Hy,ut,pt,wt),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(Ye){"heatmap-color"===Ye&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=gp({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(Ye){return hh("heatmap-radius",this,Ye)}queryIntersectsFeature(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=this.paint.get("heatmap-radius").evaluate(ut,pt);return np(Ye,wt,St,It,Lt,!0,!0,new wu(0,0),$t)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(Ye,ut,pt){return"heatmap"===Ye?{config:new Ku(this,{zoom:ut,lut:pt}),overrideFog:!1}:{}}},hillshade:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,ex,ut,pt,wt)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(Ye,ut,pt){return{overrideFog:!1}}},fill:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,gx,ut,pt,wt)}getProgramIds(){const Ye=this.paint.get("fill-pattern"),ut=Ye&&Ye.constantOr(1),pt=[ut?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&pt.push(ut&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),pt}getDefaultProgramParams(Ye,ut,pt){return{config:new Ku(this,{zoom:ut,lut:pt}),overrideFog:!1}}recalculate(Ye,ut){super.recalculate(Ye,ut);const pt=this.paint._values["fill-outline-color"];"constant"===pt.value.kind&&void 0===pt.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(Ye){return new Wp(Ye)}queryRadius(){return ph(this.paint.get("fill-translate"))}queryIntersectsFeature(Ye,ut,pt,wt,Tt,St){return!Ye.queryGeometry.isAboveHorizon&&Qc(fh(Ye.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),St.angle,Ye.pixelToTileUnitsFactor),wt)}isTileClipped(){return!0}},"fill-extrusion":class extends kl{constructor(Ye,ut,pt,wt){super(Ye,gv,ut,pt,wt),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(Ye){return new xd(Ye)}queryRadius(){return ph(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(ut,pt,wt,Tt,St,It,Lt,$t,Xt){const Sr=dh(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),It.angle,ut.pixelToTileUnitsFactor),Lr=this.paint.get("fill-extrusion-height").evaluate(pt,wt),Qr=this.paint.get("fill-extrusion-base").evaluate(pt,wt),fn=[0,0],xn=$t&&It.elevation,vn=It.elevation?It.elevation.exaggeration():1,kn=ut.tile.getBucket(this);if(xn&&kn instanceof xd){const Ye=kn.centroidVertexArray,ut=Xt+1;ut<Ye.length&&(fn[0]=Ye.geta_centroid_pos0(ut),fn[1]=Ye.geta_centroid_pos1(ut))}if(0===fn[0]&&1===fn[1])return!1;"globe"===It.projection.name&&(Tt=Td([Tt],[new wu(0,0),new wu(ym,ym)],ut.tileID.canonical).map((Ye=>Ye.polygon)).flat());const Wn=xn?$t:null,[Xn,Jn]=function(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr){return"globe"===ut.projection.name?function(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr){const Qr=[],fn=[],xn=ut.projection.upVectorScale(Lr,ut.center.lat,ut.worldSize).metersToTile,vn=[0,0,0,1],kn=[0,0,0,1],g=(Ye,ut,pt,wt)=>{Ye[0]=ut,Ye[1]=pt,Ye[2]=wt,Ye[3]=1},Wn=Id();wt>0&&(wt+=Wn),Tt+=Wn;for(const Wn of pt){const pt=[],Xn=[];for(const Qr of Wn){const fn=Qr.x+St.x,Wn=Qr.y+St.y,Jn=ut.projection.projectTilePoint(fn,Wn,Lr),Qn=ut.projection.upVector(Lr,Qr.x,Qr.y);let ko=wt,Fo=Tt;if(Lt){const Ye=Dd(fn,Wn,wt,Tt,Lt,$t,Xt,Sr);ko+=Ye.base,Fo+=Ye.top}0!==wt?g(vn,Jn.x+Qn[0]*xn*ko,Jn.y+Qn[1]*xn*ko,Jn.z+Qn[2]*xn*ko):g(vn,Jn.x,Jn.y,Jn.z),g(kn,Jn.x+Qn[0]*xn*Fo,Jn.y+Qn[1]*xn*Fo,Jn.z+Qn[2]*xn*Fo),Ye._.transformMat4(vn,vn,It),Ye._.transformMat4(kn,kn,It),pt.push(new If(vn[0],vn[1],vn[2])),Xn.push(new If(kn[0],kn[1],kn[2]))}Qr.push(pt),fn.push(Xn)}return[Qr,fn]}(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr):Lt?function(ut,pt,wt,Tt,St,It,Lt,$t,Xt){const Sr=[],Lr=[],Qr=[0,0,0,1];for(const fn of ut){const ut=[],xn=[];for(const Sr of fn){const Lr=Sr.x+Tt.x,fn=Sr.y+Tt.y,vn=Dd(Lr,fn,pt,wt,It,Lt,$t,Xt);Qr[0]=Lr,Qr[1]=fn,Qr[2]=vn.base,Qr[3]=1,Ye.aA.transformMat4(Qr,Qr,St),Qr[3]=Math.max(Qr[3],1e-5);const kn=new If(Qr[0]/Qr[3],Qr[1]/Qr[3],Qr[2]/Qr[3]);Qr[0]=Lr,Qr[1]=fn,Qr[2]=vn.top,Qr[3]=1,Ye.aA.transformMat4(Qr,Qr,St),Qr[3]=Math.max(Qr[3],1e-5);const Wn=new If(Qr[0]/Qr[3],Qr[1]/Qr[3],Qr[2]/Qr[3]);ut.push(kn),xn.push(Wn)}Sr.push(ut),Lr.push(xn)}return[Sr,Lr]}(pt,wt,Tt,St,It,Lt,$t,Xt,Sr):function(Ye,ut,pt,wt,Tt){const St=[],It=[],Lt=Tt[8]*ut,$t=Tt[9]*ut,Xt=Tt[10]*ut,Sr=Tt[11]*ut,Lr=Tt[8]*pt,Qr=Tt[9]*pt,fn=Tt[10]*pt,xn=Tt[11]*pt;for(const ut of Ye){const Ye=[],pt=[];for(const St of ut){const ut=St.x+wt.x,It=St.y+wt.y,vn=Tt[0]*ut+Tt[4]*It+Tt[12],kn=Tt[1]*ut+Tt[5]*It+Tt[13],Wn=Tt[2]*ut+Tt[6]*It+Tt[14],Xn=Tt[3]*ut+Tt[7]*It+Tt[15],Jn=vn+Lt,Qn=kn+$t,ko=Wn+Xt,Fo=Math.max(Xn+Sr,1e-5),is=vn+Lr,ns=kn+Qr,ss=Wn+fn,as=Math.max(Xn+xn,1e-5);Ye.push(new If(Jn/Fo,Qn/Fo,ko/Fo)),pt.push(new If(is/as,ns/as,ss/as))}St.push(Ye),It.push(pt)}return[St,It]}(pt,wt,Tt,St,It)}(It,Tt,Qr,Lr,Sr,Lt,Wn,fn,vn,It.center.lat,ut.tileID.canonical),Qn=ut.queryGeometry;return function(Ye,ut,pt){let wt=1/0;Qc(pt,ut)&&(wt=Bd(pt,ut[0]));for(let Tt=0;Tt<ut.length;Tt++){const St=ut[Tt],It=Ye[Tt];for(let Ye=0;Ye<St.length-1;Ye++){const ut=St[Ye],Tt=[ut,St[Ye+1],It[Ye+1],It[Ye],ut];Wc(pt,Tt)&&(wt=Math.min(wt,Bd(pt,Tt)))}}return wt!==1/0&&wt}(Xn,Jn,Qn.isPointQuery()?Qn.screenBounds:Qn.screenGeometry)}},line:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,yb,ut,pt,wt),yb.layout&&(this.layout=new nl(yb.layout)),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(Ye){if("line-gradient"===Ye){const Ye=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=Ye._styleExpression&&Ye._styleExpression.expression instanceof ea,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(Ye,ut){super.recalculate(Ye,ut),this.paint._values["line-floorwidth"]=rT.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,Ye)}createBucket(Ye){return new tm(Ye)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(Ye,ut,pt){const wt=om(this);return{config:new Ku(this,{zoom:ut,lut:pt}),defines:wt,overrideFog:!1}}queryRadius(Ye){const ut=Ye,pt=nb(hh("line-width",this,ut),hh("line-gap-width",this,ut)),wt=hh("line-offset",this,ut);return pt/2+Math.abs(wt)+ph(this.paint.get("line-translate"))}queryIntersectsFeature(Ye,ut,pt,wt,Tt,St){if(Ye.queryGeometry.isAboveHorizon)return!1;const It=fh(Ye.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),St.angle,Ye.pixelToTileUnitsFactor),Lt=Ye.pixelToTileUnitsFactor/2*nb(this.paint.get("line-width").evaluate(ut,pt),this.paint.get("line-gap-width").evaluate(ut,pt)),$t=this.paint.get("line-offset").evaluate(ut,pt);return $t&&(wt=function(Ye,ut){const pt=[],wt=new wu(0,0);for(let Tt=0;Tt<Ye.length;Tt++){const St=Ye[Tt],It=[];for(let Ye=0;Ye<St.length;Ye++){const pt=St[Ye],Tt=St[Ye+1],Lt=0===Ye?wt:pt.sub(St[Ye-1])._unit()._perp(),$t=Ye===St.length-1?wt:Tt.sub(pt)._unit()._perp(),Xt=Lt._add($t)._unit();Xt._mult(1/(Xt.x*$t.x+Xt.y*$t.y)),It.push(Xt._mult(ut)._add(pt))}pt.push(It)}return pt}(wt,$t*Ye.pixelToTileUnitsFactor)),function(Ye,ut,pt){for(let wt=0;wt<ut.length;wt++){const Tt=ut[wt];if(Ye.length>=3)for(let ut=0;ut<Tt.length;ut++)if(ah(Ye,Tt[ut]))return!0;if(th(Ye,Tt,pt))return!0}return!1}(It,wt,Lt)}isTileClipped(){return!0}isDraped(Ye){const ut=this.layout.get("line-z-offset");return ut.isConstant()&&!ut.constantOr(0)}},symbol:ob,background:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,aT,ut,pt,wt)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(Ye,ut,pt){return{overrideFog:!1}}},raster:gb,"raster-particle":vb,sky:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,fT,ut,pt,wt),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(Ye){"sky-gradient"===Ye?this._updateColorRamp():"sky-atmosphere-sun"!==Ye&&"sky-atmosphere-halo-color"!==Ye&&"sky-atmosphere-color"!==Ye&&"sky-atmosphere-sun-intensity"!==Ye||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=gp({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(Ye){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const ut=Ye.style.light.properties.get("position");return this._lightPosition.azimuthal!==ut.azimuthal||this._lightPosition.polar!==ut.polar}return!1}getCenter(Ye,ut){if("atmosphere"===this.paint.get("sky-type")){const pt=this.paint.get("sky-atmosphere-sun"),wt=!pt,Tt=Ye.style.light,St=Tt.properties.get("position");return wt&&"viewport"===Tt.properties.get("anchor")&&fr("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),wt?Ab(St.azimuthal,90-St.polar,ut):Ab(pt[0],90-pt[1],ut)}const pt=this.paint.get("sky-gradient-center");return Ab(pt[0],90-pt[1],ut)}isSky(){return!0}markSkyboxValid(Ye){this._skyboxInvalidated=!1,this._lightPosition=Ye.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const Ye=this.paint.get("sky-type");return"atmosphere"===Ye?["skyboxCapture","skybox"]:"gradient"===Ye?["skyboxGradient"]:null}},slot:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,mT,ut,null)}},model:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,MT,ut,pt,wt),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(Ye){return new Xb(Ye)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(Ye){return Ye instanceof Qv?ym-1:0}queryIntersectsFeature(ut,pt,wt,Tt,St,It){if(!this.modelManager)return!1;const Lt=this.modelManager,$t=ut.tile.getBucket(this);if(!($t&&$t instanceof Xb))return!1;const Xt=$t;for(const wt in Xt.instancesPerModel){const Tt=Xt.instancesPerModel[wt],St=void 0!==pt.id?pt.id:pt.properties&&pt.properties.hasOwnProperty("id")?pt.properties.id:void 0;if(Tt.idToFeaturesIndex.hasOwnProperty(St)){const pt=Tt.features[Tt.idToFeaturesIndex[St]],$t=Lt.getModel(wt,this.scope);if(!$t)return!1;let Sr=Ye.ad.create();const Lr=new mc(0,0),Qr=Xt.canonical;let fn=Number.MAX_VALUE;for(let wt=0;wt<pt.instancedDataCount;++wt){const St=16*(pt.instancedDataOffset+wt),Lt=Tt.instancedDataArray.float32,Xt=[Lt[St+4],Lt[St+5],Lt[St+6]];n_(Qr,Lr,Lt[St],0|Lt[St+1]),Jb(Sr,$t,It,Lr,pt.rotation,pt.scale,Xt,!1,!1,!1),"globe"===It.projection.name&&(Sr=Cb(Sr,It));const xn=Ye.ad.multiply([],It.projMatrix,Sr),vn=ut.queryGeometry,kn=Rb(vn.isPointQuery()?vn.screenBounds:vn.screenGeometry,It,xn,$t.aabb);null!=kn&&(fn=Math.min(kn,fn))}return fn!==Number.MAX_VALUE&&fn}}return!1}_handleOverridablePaintPropertyUpdate(Ye,ut,pt){return!(!this.layout||ut.isDataDriven()||pt.isDataDriven()||"model-color"!==Ye&&"model-color-mix-intensity"!==Ye&&"model-rotation"!==Ye&&"model-scale"!==Ye&&"model-translation"!==Ye&&"model-emissive-strength"!==Ye)}_isPropertyZoomDependent(Ye){const ut=this._transitionablePaint._values[Ye];return null!=ut&&null!=ut.value&&null!=ut.value.expression&&ut.value.expression instanceof fo}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}queryIntersectsMatchingFeature(ut,pt,wt,Tt){const St=ut.tile,It=St.getBucket(this);let Lt=null,$t=Number.MAX_VALUE;if(!(It&&It instanceof Qv))return{queryFeature:Lt,intersectionZ:$t};const Xt=It.getNodesInfo()[pt];if(Xt.hiddenByReplacement||!Xt.node.meshes||!wt.filter(new Ho(St.tileID.overscaledZ),Xt.feature,St.tileID.canonical))return{queryFeature:Lt,intersectionZ:$t};const Sr=Xt.node,Lr=Tt.calculatePosMatrix(St.tileID.toUnwrapped(),Tt.worldSize),Qr=Xt.evaluatedScale;let fn=0;Tt.elevation&&Sr.elevation&&(fn=Sr.elevation*Tt.elevation.exaggeration()),Ye.ad.translate(Lr,Lr,[(Sr.anchor?Sr.anchor[0]:0)*(Qr[0]-1),(Sr.anchor?Sr.anchor[1]:0)*(Qr[1]-1),fn]),Ye.ad.scale(Lr,Lr,Qr),Ye.ad.multiply(Lr,Lr,Sr.matrix);const xn=ut.queryGeometry,vn=xn.isPointQuery()?xn.screenBounds:xn.screenGeometry,y=function(ut){const pt=Ye.ad.multiply([],Lr,ut.matrix),wt=Ye.ad.multiply(pt,Tt.expandedFarZProjMatrix,pt);for(let Ye=0;Ye<ut.meshes.length;++Ye){const pt=ut.meshes[Ye];if(Ye===ut.lightMeshIndex)continue;const St=Rb(vn,Tt,wt,pt.aabb);null!=St&&($t=Math.min(St,$t))}if(ut.children)for(const Ye of ut.children)y(Ye)};if(y(Sr),$t===Number.MAX_VALUE)return{queryFeature:Lt,intersectionZ:$t};const kn=new mc(0,0);return n_(St.tileID.canonical,kn,Xt.node.anchor[0],Xt.node.anchor[1]),Lt={type:"Feature",geometry:{type:"Point",coordinates:[kn.lng,kn.lat]},properties:Xt.feature.properties,id:Xt.feature.id,state:{},layer:this.serialize()},{queryFeature:Lt,intersectionZ:$t}}},clip:class extends kl{constructor(Ye,ut,pt,wt){super(Ye,vx,ut,pt,wt)}recalculate(Ye,ut){super.recalculate(Ye,ut)}createBucket(Ye){return new rf(Ye)}isTileClipped(){return!0}is3D(){return!0}}};Mo(Hx,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});const HT=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class a_{static from(Ye){if(!(Ye instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[ut,pt]=new Uint8Array(Ye,0,2);if(219!==ut)throw new Error("Data does not appear to be in a KDBush format.");const wt=pt>>4;if(1!==wt)throw new Error(`Got v${wt} data when expected v1.`);const Tt=HT[15&pt];if(!Tt)throw new Error("Unrecognized array type.");const[St]=new Uint16Array(Ye,2,1),[It]=new Uint32Array(Ye,4,1);return new a_(It,St,Tt,Ye)}constructor(Ye,ut=64,pt=Float64Array,wt){if(isNaN(Ye)||Ye<0)throw new Error(`Unpexpected numItems value: ${Ye}.`);this.numItems=+Ye,this.nodeSize=Math.min(Math.max(+ut,2),65535),this.ArrayType=pt,this.IndexArrayType=Ye<65536?Uint16Array:Uint32Array;const Tt=HT.indexOf(this.ArrayType),St=2*Ye*this.ArrayType.BYTES_PER_ELEMENT,It=Ye*this.IndexArrayType.BYTES_PER_ELEMENT,Lt=(8-It%8)%8;if(Tt<0)throw new Error(`Unexpected typed array class: ${pt}.`);wt&&wt instanceof ArrayBuffer?(this.data=wt,this.ids=new this.IndexArrayType(this.data,8,Ye),this.coords=new this.ArrayType(this.data,8+It+Lt,2*Ye),this._pos=2*Ye,this._finished=!0):(this.data=new ArrayBuffer(8+St+It+Lt),this.ids=new this.IndexArrayType(this.data,8,Ye),this.coords=new this.ArrayType(this.data,8+It+Lt,2*Ye),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+Tt]),new Uint16Array(this.data,2,1)[0]=ut,new Uint32Array(this.data,4,1)[0]=Ye)}add(Ye,ut){const pt=this._pos>>1;return this.ids[pt]=pt,this.coords[this._pos++]=Ye,this.coords[this._pos++]=ut,pt}finish(){const Ye=this._pos>>1;if(Ye!==this.numItems)throw new Error(`Added ${Ye} items when expected ${this.numItems}.`);return o_(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(Ye,ut,pt,wt){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Tt,coords:St,nodeSize:It}=this,Lt=[0,Tt.length-1,0],$t=[];for(;Lt.length;){const Xt=Lt.pop()||0,Sr=Lt.pop()||0,Lr=Lt.pop()||0;if(Sr-Lr<=It){for(let It=Lr;It<=Sr;It++){const Lt=St[2*It],Xt=St[2*It+1];Lt>=Ye&&Lt<=pt&&Xt>=ut&&Xt<=wt&&$t.push(Tt[It])}continue}const Qr=Lr+Sr>>1,fn=St[2*Qr],xn=St[2*Qr+1];fn>=Ye&&fn<=pt&&xn>=ut&&xn<=wt&&$t.push(Tt[Qr]),(0===Xt?Ye<=fn:ut<=xn)&&(Lt.push(Lr),Lt.push(Qr-1),Lt.push(1-Xt)),(0===Xt?pt>=fn:wt>=xn)&&(Lt.push(Qr+1),Lt.push(Sr),Lt.push(1-Xt))}return $t}within(Ye,ut,pt){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:wt,coords:Tt,nodeSize:St}=this,It=[0,wt.length-1,0],Lt=[],$t=pt*pt;for(;It.length;){const Xt=It.pop()||0,Sr=It.pop()||0,Lr=It.pop()||0;if(Sr-Lr<=St){for(let pt=Lr;pt<=Sr;pt++)h_(Tt[2*pt],Tt[2*pt+1],Ye,ut)<=$t&&Lt.push(wt[pt]);continue}const Qr=Lr+Sr>>1,fn=Tt[2*Qr],xn=Tt[2*Qr+1];h_(fn,xn,Ye,ut)<=$t&&Lt.push(wt[Qr]),(0===Xt?Ye-pt<=fn:ut-pt<=xn)&&(It.push(Lr),It.push(Qr-1),It.push(1-Xt)),(0===Xt?Ye+pt>=fn:ut+pt>=xn)&&(It.push(Qr+1),It.push(Sr),It.push(1-Xt))}return Lt}}function o_(Ye,ut,pt,wt,Tt,St){if(Tt-wt<=pt)return;const It=wt+Tt>>1;l_(Ye,ut,It,wt,Tt,St),o_(Ye,ut,pt,wt,It-1,1-St),o_(Ye,ut,pt,It+1,Tt,1-St)}function l_(Ye,ut,pt,wt,Tt,St){for(;Tt>wt;){if(Tt-wt>600){const It=Tt-wt+1,Lt=pt-wt+1,$t=Math.log(It),Xt=.5*Math.exp(2*$t/3),Sr=.5*Math.sqrt($t*Xt*(It-Xt)/It)*(Lt-It/2<0?-1:1);l_(Ye,ut,pt,Math.max(wt,Math.floor(pt-Lt*Xt/It+Sr)),Math.min(Tt,Math.floor(pt+(It-Lt)*Xt/It+Sr)),St)}const It=ut[2*pt+St];let Lt=wt,$t=Tt;for(u_(Ye,ut,wt,pt),ut[2*Tt+St]>It&&u_(Ye,ut,wt,Tt);Lt<$t;){for(u_(Ye,ut,Lt,$t),Lt++,$t--;ut[2*Lt+St]<It;)Lt++;for(;ut[2*$t+St]>It;)$t--}ut[2*wt+St]===It?u_(Ye,ut,wt,$t):($t++,u_(Ye,ut,$t,Tt)),$t<=pt&&(wt=$t+1),pt<=$t&&(Tt=$t-1)}}function u_(Ye,ut,pt,wt){c_(Ye,pt,wt),c_(ut,2*pt,2*wt),c_(ut,2*pt+1,2*wt+1)}function c_(Ye,ut,pt){const wt=Ye[ut];Ye[ut]=Ye[pt],Ye[pt]=wt}function h_(Ye,ut,pt,wt){const Tt=Ye-pt,St=ut-wt;return Tt*Tt+St*St}Ye.$=We,Ye.A=Hs,Ye.B=Ys,Ye.C=qn,Ye.D=Bi,Ye.E=Ln,Ye.G=hl,Ye.H=eo,Ye.I=Ig,Ye.J=Ja,Ye.K=function(Ye){const ut=Ye.value;let pt=[];if(!ut)return pt;const wt=Ti(ut);return"string"!==wt?(pt=pt.concat([new qb(Ye.key,ut,`string expected, "${wt}" found`)]),pt):($b(ut,!0)||(pt=pt.concat([new qb(Ye.key,ut,`invalid url "${ut}"`)])),pt)},Ye.L=O_,Ye.M=class{constructor(Ye,ut,pt,wt){this.id=Ye,this.position=null!=ut?new mc(ut[0],ut[1]):new mc(0,0),this.orientation=null!=pt?pt:[0,0,0],this.nodes=wt,this.uploaded=!1,this.aabb=new Ah([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(ut,pt){if(Ye.ad.multiply(ut.matrix,pt,ut.matrix),ut.meshes)for(const Ye of ut.meshes){const pt=Ah.applyTransformFast(Ye.aabb,ut.matrix);this.aabb.encapsulate(pt)}if(ut.children)for(const Ye of ut.children)this._applyTransformations(Ye,ut.matrix)}computeBoundsAndApplyParent(){const ut=Ye.ad.identity([]);for(const Ye of this.nodes)this._applyTransformations(Ye,ut)}computeModelMatrix(Ye,ut,pt,wt,Tt,St,It=!1){Jb(this.matrix,this,Ye.transform,this.position,ut,pt,wt,Tt,St,It)}upload(Ye){if(!this.uploaded){for(const ut of this.nodes)ev(ut,Ye);for(const Ye of this.nodes)rv(Ye);this.uploaded=!0}}destroy(){for(const Ye of this.nodes)nv(Ye)}},Ye.N=ol,Ye.O=il,Ye.P=wu,Ye.Q=class{constructor(Ye){this.specification=Ye}possiblyEvaluate(Ye,ut){return yr(Ye.expression.evaluate(ut))}interpolate(Ye,ut,pt){return{x:Gn(Ye.x,ut.x,pt),y:Gn(Ye.y,ut.y,pt),z:Gn(Ye.z,ut.z,pt),azimuthal:Gn(Ye.azimuthal,ut.azimuthal,pt),polar:Gn(Ye.polar,ut.polar,pt)}}},Ye.R=jd,Ye.S=uu,Ye.T=Gg,Ye.U=Jo,Ye.V=qb,Ye.W=er,Ye.X=Ho,Ye.Y=Oc,Ye.Z=fo,Ye.a=Eg,Ye.a$=function(Ye){const{x:ut,y:pt}=Ye.point,{lng:wt,lat:Tt}=Ye._center;return Zh(ut,pt,Ye.worldSize,wt,Tt)},Ye.a0=nl,Ye.a1=Hh,Ye.a2=Gn,Ye.a3=ym,Ye.a4=Yn,Ye.a5=class{constructor(Ye){this.specification=Ye}possiblyEvaluate(Ye,ut){return function([Ye,ut]){const pt=yr([1,Ye,ut]);return{x:pt.x,y:pt.y,z:pt.z}}(Ye.expression.evaluate(ut))}interpolate(Ye,ut,pt){return{x:Gn(Ye.x,ut.x,pt),y:Gn(Ye.y,ut.y,pt),z:Gn(Ye.z,ut.z,pt)}}},Ye.a6=Uu,Ye.a7=Du,Ye.a8=Ru,Ye.a9=Ou,Ye.aB=function(ut,pt){const{x:wt,y:Tt}=ut.point,St=Zh(wt,Tt,ut.worldSize/ut._pixelsPerMercatorPixel,0,0);return Ye.ad.multiply(St,St,Gh(Ch(pt)))},Ye.aD=qm,Ye.aE=Wb,Ye.aF=jm,Ye.aG=function(Ye,ut,pt,wt,Tt){const St=5*ut+2;Ye.float32[St+0]=pt,Ye.float32[St+1]=wt,Ye.float32[St+2]=Tt},Ye.aH=Ug,Ye.aI=mc,Ye.aJ=Sg,Ye.aK=vc,Ye.aL=_c,Ye.aM=Mh,Ye.aN=Tb,Ye.aO=bc,Ye.aP=Oh,Ye.aQ=function(Ye,ut,pt,wt,Tt,St,It,Lt,$t){if("globe"===$t.name)return Oh(Ye,ut,new bc(pt,wt,Tt),!1);const Xt=ng({z:pt,x:wt,y:Tt},$t);return new Ah([(St+Xt.x/Xt.scale)*ut,ut*(Xt.y/Xt.scale),It],[(St+Xt.x2/Xt.scale)*ut,ut*(Xt.y2/Xt.scale),Lt])},Ye.aR=function(Ye,ut,pt){let wt=0;for(let pt=0;pt<2;++pt){const Tt=0;Ye[pt]>Tt&&(wt+=(Ye[pt]-Tt)*(Ye[pt]-Tt)),ut[pt]<Tt&&(wt+=(Tt-ut[pt])*(Tt-ut[pt]))}return wt},Ye.aS=Bg,Ye.aT=gh,Ye.aU=sg,Ye.aV=function(ut){const pt=Ye.ad.identity(new Float64Array(16));Ye.ad.multiply(pt,ut.pixelMatrix,ut.globeMatrix);const wt=[0,ug,0],Tt=[0,pg,0];return Ye._.transformMat4(wt,wt,pt),Ye._.transformMat4(Tt,Tt,pt),[wt[0]>0&&wt[0]<=ut.width&&wt[1]>0&&wt[1]<=ut.height&&!Wh(ut,new mc(ut.center.lat,90)),Tt[0]>0&&Tt[0]<=ut.width&&Tt[1]>0&&Tt[1]<=ut.height&&!Wh(ut,new mc(ut.center.lat,-90))]},Ye.aW=function(ut,pt){const{scale:wt}=ut.tileTransform,Tt=wt*ym/(ut.tileSize*Math.pow(2,pt.zoom-ut.tileID.overscaledZ+ut.tileID.canonical.z));return Ye.aC.scale(new Float32Array(4),pt.inverseAdjustmentMatrix,[Tt,Tt])},Ye.aX=kb,Ye.aY=Ib,Ye.aZ=function(ut){const pt=Ib(ut,!0);return Ye.aC.invert([],[pt[0],pt[1],pt[4],pt[5]])},Ye.a_=xh,Ye.aa=Cu,Ye.ab=$e,Ye.ac=function(Ye,ut,pt){const wt=Math.sqrt(Ye*Ye+ut*ut+pt*pt),Tt=wt>0?Math.acos(pt/wt)*Mu:0;let St=0!==Ye||0!==ut?Math.atan2(-ut,-Ye)*Mu+90:0;return St<0&&(St+=360),[wt,St,Tt]},Ye.ae=Tg,Ye.af=Cg,Ye.ag=Pg,Ye.ah=function(Ye,ut){const pt={};for(let wt=0;wt<ut.length;wt++){const Tt=ut[wt];Tt in Ye&&(pt[Tt]=Ye[Tt])}return pt},Ye.ai=yc,Ye.aj=Tc,Ye.ak=kc,Ye.al=Sl,Ye.am=function(Ye){Rd++,Rd>Cd&&(Ye.getActor().send("enforceCacheSizeLimit",md),Rd=0)},Ye.an=Qd,Ye.ao=class{constructor(Ye){this.entries={},this.scheduler=Ye}request(Ye,ut,pt,wt){const Tt=this.entries[Ye]=this.entries[Ye]||{callbacks:[]};if(Tt.result){const[Ye,pt]=Tt.result;return this.scheduler?this.scheduler.add((()=>{wt(Ye,pt)}),ut):wt(Ye,pt),()=>{}}return Tt.callbacks.push(wt),Tt.cancel||(Tt.cancel=pt(((pt,wt)=>{Tt.result=[pt,wt];for(const Ye of Tt.callbacks)this.scheduler?this.scheduler.add((()=>{Ye(pt,wt)}),ut):Ye(pt,wt);setTimeout((()=>delete this.entries[Ye]),3e3)}))),()=>{Tt.result||(Tt.callbacks=Tt.callbacks.filter((Ye=>Ye!==wt)),Tt.callbacks.length||(Tt.cancel(),delete this.entries[Ye]))}}},Ye.ap=function(Ye,pt,wt){const Tt=JSON.stringify(Ye.request);return Ye.data&&((this||ut).deduped.entries[Tt]={result:[null,Ye.data]}),(this||ut).deduped.request(Tt,{type:"parseTile",isSymbolTile:Ye.isSymbolTile,zoom:Ye.tileZoom},(ut=>{const pt=en(Ye.request,((Ye,pt,Tt,St)=>{Ye?ut(Ye):pt&&ut(null,{vectorTile:wt?void 0:new Bx(new Lb(pt)),rawData:pt,cacheControl:Tt,expires:St})}));return()=>{pt.cancel(),ut()}}),pt)},Ye.aq=Vu,Ye.ar=class extends Bu{constructor(Ye){super(Ye),this.current=W_}set(Ye,ut,pt){if(this.fetchUniformLocation(Ye,ut))for(let Ye=0;Ye<9;Ye++)if(pt[Ye]!==this.current[Ye]){this.current=pt,this.gl.uniformMatrix3fv(this.location,!1,pt);break}}},Ye.as=Lu,Ye.at=Ke,Ye.au=Je,Ye.aw=Tr,Ye.ax=Pc,Ye.ay=Ec,Ye.az=function(Ye,ut,pt){Ye[4*ut+0]=pt[0],Ye[4*ut+1]=pt[1],Ye[4*ut+2]=pt[2],Ye[4*ut+3]=pt[3]},Ye.b=Au,Ye.b$=dv,Ye.b0=Ge,Ye.b1=Q_,Ye.b2=function(Ye){const ut=Math.round((Ye+45+360)%360/90)%4;return Iu[ut]},Ye.b3=45,Ye.b4=Ic,Ye.b5=Lc,Ye.b6=Ah,Ye.b7=yr,Ye.b8=function(Ye){return[Math.pow(Ye[0],1/2.2),Math.pow(Ye[1],1/2.2),Math.pow(Ye[2],1/2.2)]},Ye.b9=Xe,Ye.bA=function(Ye,ut){return[Math.pow(Ye[0],2.2)*ut,Math.pow(Ye[1],2.2)*ut,Math.pow(Ye[2],2.2)*ut]},Ye.bB=im,Ye.bD=Xh,Ye.bE=Er,Ye.bF=zr,Ye.bG=256,Ye.bH=function(ut,pt){const wt=[0,0,0],Tt=$h(Ch(pt.canonical));return Ye._.transformMat4(wt,wt,Tt),Ye._.transformMat4(wt,wt,ut),wt},Ye.bI=Ye=>({u_camera_to_center_distance:new Cu(Ye),u_extrude_scale:new qu(Ye),u_device_pixel_ratio:new Cu(Ye),u_matrix:new Uu(Ye),u_inv_rot_matrix:new Uu(Ye),u_merc_center:new Ru(Ye),u_tile_id:new Vu(Ye),u_zoom_transition:new Cu(Ye),u_up_dir:new Vu(Ye),u_emissive_strength:new Cu(Ye)}),Ye.bJ=Ye=>({u_matrix:new Uu(Ye),u_pixels_to_tile_units:new qu(Ye),u_device_pixel_ratio:new Cu(Ye),u_units_to_pixels:new Ru(Ye),u_dash_image:new Du(Ye),u_gradient_image:new Du(Ye),u_image_height:new Cu(Ye),u_texsize:new Ru(Ye),u_tile_units_to_pixels:new Cu(Ye),u_alpha_discard_threshold:new Cu(Ye),u_trim_offset:new Ru(Ye),u_trim_fade_range:new Ru(Ye),u_trim_color:new Lu(Ye),u_emissive_strength:new Cu(Ye)}),Ye.bK=Ye=>({u_matrix:new Uu(Ye),u_texsize:new Ru(Ye),u_pixels_to_tile_units:new qu(Ye),u_device_pixel_ratio:new Cu(Ye),u_image:new Du(Ye),u_units_to_pixels:new Ru(Ye),u_tile_units_to_pixels:new Cu(Ye),u_alpha_discard_threshold:new Cu(Ye),u_trim_offset:new Ru(Ye)}),Ye.bL=Wl,Ye.bM=sb,Ye.bN=Fb,Ye.bO=Vb,Ye.bP=Yy,Ye.bQ=hy,Ye.bR=rp,Ye.bS=(Ye,ut,pt,wt,Tt,St)=>{const It=Ye.transform,Lt="globe"===It.projection.name;let $t;if("map"===St.paint.get("circle-pitch-alignment"))if(Lt){const Ye=Xh(It.zoom,ut.canonical)*It._pixelsPerMercatorPixel;$t=Float32Array.from([Ye,0,0,Ye])}else $t=It.calculatePixelsToTileUnitsMatrix(pt);else $t=new Float32Array([It.pixelsToGLUnits[0],0,0,It.pixelsToGLUnits[1]]);const Xt={u_camera_to_center_distance:Ye.transform.getCameraToCenterDistance(It.projection),u_matrix:Ye.translatePosMatrix(ut.projMatrix,pt,St.paint.get("circle-translate"),St.paint.get("circle-translate-anchor")),u_device_pixel_ratio:sd.devicePixelRatio,u_extrude_scale:$t,u_inv_rot_matrix:ky,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:St.paint.get("circle-emissive-strength")};if(Lt){Xt.u_inv_rot_matrix=wt,Xt.u_merc_center=Tt,Xt.u_tile_id=[ut.canonical.x,ut.canonical.y,1<<ut.canonical.z],Xt.u_zoom_transition=Hh(It.zoom);const Ye=Tt[0]*ym,pt=Tt[1]*ym;Xt.u_up_dir=It.projection.upVector(new bc(0,0,0),Ye,pt)}return Xt},Ye.bT=om,Ye.bU=(Ye,ut,pt,wt,Tt,St)=>{const It=Ye.transform;return{u_matrix:am(Ye,ut,pt,wt),u_texsize:ut.imageAtlasTexture?ut.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:It.calculatePixelsToTileUnitsMatrix(ut),u_device_pixel_ratio:Tt,u_image:0,u_tile_units_to_pixels:sm(ut,It),u_units_to_pixels:[1/It.pixelsToGLUnits[0],1/It.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:St}},Ye.bV=(Ye,ut,pt,wt,Tt,St,It)=>{const Lt=Ye.transform,$t=Lt.calculatePixelsToTileUnitsMatrix(ut);return{u_matrix:am(Ye,ut,pt,wt),u_pixels_to_tile_units:$t,u_device_pixel_ratio:St,u_units_to_pixels:[1/Lt.pixelsToGLUnits[0],1/Lt.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:Tt,u_texsize:lm(pt)&&ut.lineAtlasTexture?ut.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:sm(ut,Ye.transform),u_alpha_discard_threshold:0,u_trim_offset:It,u_trim_fade_range:pt.paint.get("line-trim-fade-range"),u_trim_color:pt.paint.get("line-trim-color").toRenderColor(pt.lut).toArray01(),u_emissive_strength:pt.paint.get("line-emissive-strength")}},Ye.bW=sr,Ye.bX=gp,Ye.bY=Id,Ye.bZ=Dg,Ye.b_=xd,Ye.ba=function(Ye,ut,pt){const wt=Hh(pt.zoom),Tt=Ye.style.map._antialias,St=ut.options.extStandardDerivativesForceOff||Ye.terrain&&Ye.terrain.exaggeration()>0;return 0===wt&&!Tt&&!St},Ye.bb=function(ut){const pt=ut.pixelsPerMeter,wt=pt/Pc(1,ut.center.lat),Tt=Ye.ad.identity(new Float64Array(16));return Ye.ad.translate(Tt,Tt,[ut.point.x,ut.point.y,0]),Ye.ad.scale(Tt,Tt,[wt,wt,pt]),Float32Array.from(Tt)},Ye.bc=Fh,Ye.bd=function(Ye){const ut=Bg-5;Ye=Ke(Ye,-ut,ut)/ut*90;const pt=Math.pow(Math.abs(Math.sin($e(Ye))),3);return Math.round(pt*(hg.length-1))},Ye.be=function(ut,pt,wt,Tt){const St=pt.getNorth(),It=pt.getSouth(),Lt=pt.getWest(),$t=pt.getEast(),Xt=1<<ut.z,Sr=$t-Lt,Lr=St-It,Qr=Sr/cg,fn=-Lr/hg[wt],xn=[0,Qr,0,fn,0,0,St,Lt,0];if(ut.z>0){const ut=180/Tt;Ye.bC.multiply(xn,xn,[ut/Sr+1,0,0,0,ut/Lr+1,0,-.5*ut/Qr,.5*ut/fn,1])}return xn[2]=Xt,xn[5]=ut.x,xn[8]=ut.y,xn},Ye.bf=$h,Ye.bg=Ch,Ye.bh=function(ut,pt,wt){const Tt=Ye.ad.identity(new Float64Array(16)),St=(pt/(1<<ut)-.5)*Math.PI*2;return Ye.ad.rotateY(Tt,wt.globeMatrix,St),Float32Array.from(Tt)},Ye.bi=Br,Ye.bj=function(Ye){return Ye<=1?1:Math.pow(2,Math.floor(Math.log(Ye)/Math.LN2))},Ye.bk=gb,Ye.bl=vb,Ye.bm=mb,Ye.bn=function(Ye,ut){const pt=document.createElement("video");pt.muted=!0,pt.onloadstart=function(){ut(null,pt)};for(let ut=0;ut<Ye.length;ut++){const wt=document.createElement("source");rn(Ye[ut])||(pt.crossOrigin="Anonymous"),wt.src=Ye[ut],pt.appendChild(wt)}return{cancel:()=>{}}},Ye.bo=Yg,Ye.bp=or,Ye.bq=class{isDataAvailableAtPoint(Ye){const ut=this._source();if(this.isUsingMockSource()||!ut||Ye.y<0||Ye.y>1)return!1;const pt=ut.getSource().maxzoom,wt=1<<pt,Tt=Math.floor(Ye.x),St=Math.floor((Ye.x-Tt)*wt),It=Math.floor(Ye.y*wt),Lt=this.findDEMTileFor(new _c(pt,Tt,pt,St,It));return!(!Lt||!Lt.dem)}getAtPointOrZero(Ye,ut=0){return this.getAtPoint(Ye,ut)||0}getAtPoint(Ye,ut,pt=!0){if(this.isUsingMockSource())return null;null==ut&&(ut=null);const wt=this._source();if(!wt)return ut;if(Ye.y<0||Ye.y>1)return ut;const Tt=wt.getSource().maxzoom,St=1<<Tt,It=Math.floor(Ye.x),Lt=Ye.x-It,$t=new _c(Tt,It,Tt,Math.floor(Lt*St),Math.floor(Ye.y*St)),Xt=this.findDEMTileFor($t);if(!Xt||!Xt.dem)return ut;const Sr=Xt.dem,Lr=1<<Xt.tileID.canonical.z,Qr=(Lt*Lr-Xt.tileID.canonical.x)*Sr.dim,fn=(Ye.y*Lr-Xt.tileID.canonical.y)*Sr.dim,xn=Math.floor(Qr),vn=Math.floor(fn);return(pt?this.exaggeration():1)*Gn(Gn(Sr.get(xn,vn),Sr.get(xn,vn+1),fn-vn),Gn(Sr.get(xn+1,vn),Sr.get(xn+1,vn+1),fn-vn),Qr-xn)}getAtTileOffset(Ye,ut,pt){const wt=1<<Ye.canonical.z;return this.getAtPointOrZero(new Oc(Ye.wrap+(Ye.canonical.x+ut/ym)/wt,(Ye.canonical.y+pt/ym)/wt))}getAtTileOffsetFunc(ut,pt,wt,Tt){return St=>{const It=this.getAtTileOffset(ut,St.x,St.y),Lt=Tt.upVector(ut.canonical,St.x,St.y),$t=Tt.upVectorScale(ut.canonical,pt,wt).metersToTile;return Ye._.scale(Lt,Lt,It*$t),Lt}}getForTilePoints(Ye,ut,pt,wt){if(this.isUsingMockSource())return!1;const Tt=Qf.create(this,Ye,wt);return!!Tt&&(ut.forEach((Ye=>{Ye[2]=this.exaggeration()*Tt.getElevationAt(Ye[0],Ye[1],pt)})),!0)}getMinMaxForTile(Ye){if(this.isUsingMockSource())return null;const ut=this.findDEMTileFor(Ye);if(!ut||!ut.dem)return null;const pt=ut.dem.tree,wt=ut.tileID,Tt=1<<Ye.canonical.z-wt.canonical.z;let St=Ye.canonical.x/Tt-wt.canonical.x,It=Ye.canonical.y/Tt-wt.canonical.y,Lt=0;for(let ut=0;ut<Ye.canonical.z-wt.canonical.z&&!pt.leaves[Lt];ut++){St*=2,It*=2;const Ye=2*Math.floor(It)+Math.floor(St);Lt=pt.childOffsets[Lt]+Ye,St%=1,It%=1}return{min:this.exaggeration()*pt.minimums[Lt],max:this.exaggeration()*pt.maximums[Lt]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(Ye,ut,pt){throw new Error("Pure virtual method called.")}pointCoordinate(Ye){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(Ye){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const Ye=this.visibleDemTiles;if(0===Ye.length)return null;let ut=!1,pt=Number.MAX_VALUE,wt=Number.MIN_VALUE;for(const Tt of Ye){const Ye=this.getMinMaxForTile(Tt.tileID);Ye&&(pt=Math.min(pt,Ye.min),wt=Math.max(wt,Ye.max),ut=!0)}return ut?{min:pt,max:wt}:null}},Ye.br=ty,Ye.bs=Ph,Ye.bt=Cl,Ye.bu=Ql,Ye.bv=Jx,Ye.bw=ov,Ye.bx=fv,Ye.by=nx,Ye.bz=dp,Ye.c=$v,Ye.c$=tn,Ye.c0=450,Ye.c1=7,Ye.c2=hT,Ye.c3=Kx,Ye.c4=256,Ye.c5=Vh,Ye.c6=Gh,Ye.c7=Bl,Ye.c8=Ul,Ye.c9=ru,Ye.cA=function(Ye){let ut=1/0,pt=1/0,wt=-1/0,Tt=-1/0;for(const St of Ye)ut=Math.min(ut,St.x),pt=Math.min(pt,St.y),wt=Math.max(wt,St.x),Tt=Math.max(Tt,St.y);return{min:new wu(ut,pt),max:new wu(wt,Tt)}},Ye.cB=ah,Ye.cC=Uc,Ye.cD=J_,Ye.cE=["type","source","source-layer","minzoom","maxzoom","filter","layout"],Ye.cF=My,Ye.cG=Wc,Ye.cH=Ff,Ye.cI=Uf,Ye.cJ=Xy,Ye.cK=a_,Ye.cL=function(Ye){return Ye({pluginStatus:D_,pluginURL:R_}),L_.on("pluginStateChange",Ye),Ye},Ye.cM=Dy,Ye.cN=rw,Ye.cO=Gd,Ye.cP=qo,Ye.cQ=s,Ye.cR=Rr,Ye.cS=sf,Ye.cT=hr,Ye.cU=function(Ye){const ut=Ye.indexOf(F_);return ut>=0?Ye.slice(0,ut):Ye},Ye.cV=function(Ye){return Ye.indexOf(F_)>=0},Ye.cW=function(Ye){const ut=Ye.indexOf(F_);return ut>=0?Ye.slice(ut+1):""},Ye.cX=function(Ye){const ut=[],pt=Ye.id;return void 0===pt&&ut.push({message:`layers.${pt}: missing required property "id"`}),void 0===Ye.render&&ut.push({message:`layers.${pt}: missing required method "render"`}),Ye.renderingMode&&"2d"!==Ye.renderingMode&&"3d"!==Ye.renderingMode&&ut.push({message:`layers.${pt}: property "renderingMode" must be either "2d" or "3d"`}),ut},Ye.cY=function(Ye,ut,pt,wt){return"custom"===Ye.type?new _b(Ye,ut):new WT[Ye.type](Ye,ut,pt,wt)},Ye.cZ=cr,Ye.c_=L_,Ye.ca=1,Ye.cb=xw,Ye.cc=0,Ye.cd=nu,Ye.ce=function(Ye,ut,pt,wt,Tt){return Ke((Ye-ut)/(pt-ut)*(Tt-wt)+wt,wt,Tt)},Ye.cf=Na,Ye.cg=Rc,Ye.ch=class{constructor(Ye,ut,pt,wt){this.context=Ye,this.format=wt,this.size=pt,this.texture=Ye.gl.createTexture();const[Tt,St,It]=this.size,{gl:Lt}=Ye;Lt.bindTexture(Lt.TEXTURE_3D,this.texture),Ye.pixelStoreUnpackFlipY.set(!1),Ye.pixelStoreUnpack.set(1),Ye.pixelStoreUnpackPremultiplyAlpha.set(!1);let $t=this.format,Xt=Lt.UNSIGNED_BYTE;this.format===Lt.DEPTH_COMPONENT&&($t=Lt.DEPTH_COMPONENT16,Xt=Lt.UNSIGNED_SHORT),this.format===Lt.R8&&(wt=Lt.RED),this.format===Lt.R32F&&(Xt=Lt.FLOAT,wt=Lt.RED),Lt.texImage3D(Lt.TEXTURE_3D,0,$t,Tt,St,It,0,wt,Xt,ut.data)}bind(Ye,ut){const{context:pt}=this,{gl:wt}=pt;wt.bindTexture(wt.TEXTURE_3D,this.texture),Ye!==this.minFilter&&(wt.texParameteri(wt.TEXTURE_3D,wt.TEXTURE_MAG_FILTER,Ye),wt.texParameteri(wt.TEXTURE_3D,wt.TEXTURE_MIN_FILTER,Ye),this.minFilter=Ye),ut!==this.wrapS&&(wt.texParameteri(wt.TEXTURE_3D,wt.TEXTURE_WRAP_S,ut),wt.texParameteri(wt.TEXTURE_3D,wt.TEXTURE_WRAP_T,ut),this.wrapS=ut)}destroy(){const{gl:Ye}=this.context;Ye.deleteTexture(this.texture),this.texture=null}},Ye.ci=Cb,Ye.cj=[1,1,1],Ye.ck=Qf,Ye.cl=ST,Ye.cm=Zl,Ye.cn=iu,Ye.co=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new wu(1/0,1/0),max:new wu(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(Ye,ut=!1){const pt=Rf(new wu(0,0),new wu(ym,ym),Ye),wt=[];if(ut&&!Df(pt,this._globalClipBounds))return wt;for(const ut of this._activeRegions){if(ut.hiddenByOverlap)continue;if(!Df(pt,ut))continue;const Tt=Vf(ut.min,ut.max,Ye);wt.push({min:Tt.min,max:Tt.max,sourceId:this._sourceIds[ut.priority],footprint:ut.footprint,footprintTileId:ut.tileId,order:ut.order,clipMask:ut.clipMask})}return wt}setSources(Ye){this._setSources(Ye.map((Ye=>({getSourceId:()=>Ye.cache.id,getFootprints:()=>{const ut=[];for(const pt of Ye.cache.getVisibleCoordinates()){const wt=Ye.cache.getTile(pt).buckets[Ye.layer];wt&&wt.updateFootprints(pt.toUnwrapped(),ut)}return ut},getOrder:()=>Ye.order,getClipMask:()=>Ye.clipMask}))))}_addSource(Ye){const ut=Ye.getFootprints();if(0===ut.length)return;const pt=Ye.getOrder(),wt=Ye.getClipMask();for(const Ye of ut){if(!Ye.footprint)continue;const ut=Rf(Ye.footprint.min,Ye.footprint.max,Ye.id);this._activeRegions.push({min:ut.min,max:ut.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:Ye.id,footprint:Ye.footprint,order:pt,clipMask:wt})}this._sourceIds.push(Ye.getSourceId())}_computeReplacement(){this._activeRegions.sort(((Ye,ut)=>Ye.priority-ut.priority||Ef(Ye.min,ut.min)||Ef(Ye.max,ut.max)));let Ye=this._activeRegions.length!==this._prevRegions.length;if(!Ye){let ut=0;for(;!Ye&&ut!==this._activeRegions.length;){const pt=this._activeRegions[ut],wt=this._prevRegions[ut];Ye=pt.priority!==wt.priority||!Bf(pt,wt)||pt.order!==wt.order||pt.clipMask!==wt.clipMask,++ut}}if(Ye){++this._updateTime;for(const Ye of this._activeRegions)Ye.order!==1/0&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,Ye.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,Ye.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,Ye.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,Ye.max.y));const t=Ye=>{const ut=this._activeRegions;if(Ye>=ut.length)return Ye;const pt=ut[Ye].priority;for(;Ye<ut.length&&ut[Ye].priority===pt;)++Ye;return Ye};if(this._sourceIds.length>1){let Ye=0,ut=t(Ye);for(;Ye!==ut;){let pt=Ye;const wt=Ye;for(;pt!==ut;){const Ye=this._activeRegions[pt];Ye.hiddenByOverlap=!1;for(let ut=0;ut<wt;ut++){const pt=this._activeRegions[ut];if(!pt.hiddenByOverlap&&Ye.order===1/0&&Df(Ye,pt)&&(Ye.hiddenByOverlap=Of(Ye.footprint,Ye.tileId,pt.footprint,pt.tileId),Ye.hiddenByOverlap))break}++pt}Ye=ut,ut=t(Ye)}}}}_setSources(Ye){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let ut=Ye.length-1;ut>=0;ut--)this._addSource(Ye[ut]);this._computeReplacement()}},Ye.cp=Vl,Ye.cq=Pw,Ye.cr=au,Ye.cs=class{constructor(Ye){this._createGrid(Ye),this._createPoles(Ye)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const Ye of this._poleSegments)Ye.destroy();for(const Ye of this._gridSegments)Ye.withSkirts.destroy(),Ye.withoutSkirts.destroy()}_fillGridMeshWithLods(Ye,ut){const pt=new Cl,wt=new Ql,Tt=[],St=Ye+1+2,It=ut[0]+1,Lt=ut[0]+1+(1+ut.length),l=(Ye,ut,pt)=>{let wt=Ye===St-1?Ye-2:0===Ye?Ye:Ye-1;return wt+=pt?24575:0,[wt,ut]};for(let Ye=0;Ye<St;++Ye)pt.emplaceBack(...l(Ye,0,!0));for(let Ye=0;Ye<It;++Ye)for(let ut=0;ut<St;++ut)pt.emplaceBack(...l(ut,Ye,(0===ut||ut===St-1)&&!0));for(let Ye=0;Ye<ut.length;++Ye){const wt=ut[Ye];for(let Ye=0;Ye<St;++Ye)pt.emplaceBack(...l(Ye,wt,!0))}for(let Ye=0;Ye<ut.length;++Ye){const It=wt.length,$t=ut[Ye]+1+2,Xt=new Ql;for(let pt=0;pt<$t-1;pt++){const Tt=pt===$t-2,It=Tt?St*(Lt-ut.length+Ye-pt):St;for(let Ye=0;Ye<St-1;Ye++){const ut=pt*St+Ye;0===pt||Tt||0===Ye||Ye===St-2?(Xt.emplaceBack(ut+1,ut,ut+It),Xt.emplaceBack(ut+It,ut+It+1,ut+1)):(wt.emplaceBack(ut+1,ut,ut+It),wt.emplaceBack(ut+It,ut+It+1,ut+1))}}const Sr=Au.simpleSegment(0,It,pt.length,wt.length-It);for(let Ye=0;Ye<Xt.uint16.length;Ye+=3)wt.emplaceBack(Xt.uint16[Ye],Xt.uint16[Ye+1],Xt.uint16[Ye+2]);const Lr=Au.simpleSegment(0,It,pt.length,wt.length-It);Tt.push({withoutSkirts:Sr,withSkirts:Lr})}return{vertices:pt,indices:wt,segments:Tt}}_createGrid(Ye){const ut=this._fillGridMeshWithLods(cg,hg);this._gridSegments=ut.segments,this._gridBuffer=Ye.createVertexBuffer(ut.vertices,ty.members),this._gridIndexBuffer=Ye.createIndexBuffer(ut.indices,!0)}_createPoles(Ye){const ut=new Ql;for(let Ye=0;Ye<=cg;Ye++)ut.emplaceBack(0,Ye+1,Ye+2);this._poleIndexBuffer=Ye.createIndexBuffer(ut,!0);const pt=new ru,wt=new ru,Tt=new ru,St=new ru;this._poleSegments=[];for(let Ye=0,ut=0;Ye<Q_;Ye++){const It=360/(1<<Ye);pt.emplaceBack(0,-J_,0,.5,0),wt.emplaceBack(0,-J_,0,.5,1),Tt.emplaceBack(0,-J_,0,.5,.5),St.emplaceBack(0,-J_,0,.5,.5);for(let Ye=0;Ye<=cg;Ye++){let ut=Ye/cg,Lt=0;const $t=Gn(0,It,ut),[Xt,Sr,Lr]=hc(Sy,Cy,$t,J_);pt.emplaceBack(Xt,Sr,Lr,ut,Lt),wt.emplaceBack(Xt,Sr,Lr,ut,1-Lt);const Qr=$e($t);ut=.5+.5*Math.sin(Qr),Lt=.5+.5*Math.cos(Qr),Tt.emplaceBack(Xt,Sr,Lr,ut,Lt),St.emplaceBack(Xt,Sr,Lr,ut,1-Lt)}this._poleSegments.push(Au.simpleSegment(ut,0,66,64)),ut+=66}this._poleNorthVertexBuffer=Ye.createVertexBuffer(pt,Kg,!1),this._poleSouthVertexBuffer=Ye.createVertexBuffer(wt,Kg,!1),this._texturedPoleNorthVertexBuffer=Ye.createVertexBuffer(Tt,Kg,!1),this._texturedPoleSouthVertexBuffer=Ye.createVertexBuffer(St,Kg,!1)}getGridBuffers(Ye,ut){return[this._gridBuffer,this._gridIndexBuffer,ut?this._gridSegments[Ye].withSkirts:this._gridSegments[Ye].withoutSkirts]}getPoleBuffers(Ye,ut){return[ut?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,ut?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[Ye]]}},Ye.ct=function(Ye){return vp.has(Ye)},Ye.cu=jx,Ye.cv=function(Ye,ut,pt=0,wt=!0){const Tt=new wu(pt,pt),St=Ye.sub(Tt),It=ut.add(Tt),Lt=[St,new wu(It.x,St.y),It,new wu(St.x,It.y)];return wt&&Lt.push(St.clone()),Lt},Ye.cw=function(Ye,ut){const pt=[];for(let wt=0;wt<Ye.length;wt++){const Tt=Je(wt-1,-1,Ye.length-1),St=Je(wt+1,-1,Ye.length-1),It=Ye[wt],Lt=Ye[St],$t=Ye[Tt].sub(It).unit(),Xt=Lt.sub(It).unit(),Sr=Xt.angleWithSep($t.x,$t.y),Lr=$t.add(Xt).unit().mult(-1*ut/Math.sin(Sr/2));pt.push(It.add(Lr))}return pt},Ye.cx=ig,Ye.cy=oh,Ye.cz=function(ut,pt,wt=0){return Ye._.fromValues(((pt.x-wt)*ut.scale-ut.x)*ym,(pt.y*ut.scale-ut.y)*ym,Bc(pt.z,pt.y))},Ye.d=Cn,Ye.d$=Qh,Ye.d0=Ze,Ye.d1=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},Ye.d2=Fu,Ye.d3=Vc,Ye.d4=pc,Ye.d5=function([Ye,ut,pt]){const wt=Math.hypot(Ye,ut,pt),Tt=Math.atan2(Ye,pt),St=.5*Math.PI-Math.acos(-ut/wt);return new mc(Ge(Tt),Ge(St))},Ye.d6=zc,Ye.d7=mg,Ye.d8=St,Ye.d9=Wh,Ye.dA=function(Ye){const ut=Nr();if(!ut)return;const pt=ut.delete(ad);Ye&&pt.catch(Ye).then((()=>Ye()))},Ye.dB=IT,Ye.dC=vv,Ye.dD=function(Ye){DT=sd.resolveURL(Ye),OT||(OT=new ov(fv(),new Ln)),OT.broadcast("setDracoUrl",DT)},Ye.dE=_v,Ye.dF=function(Ye){LT=sd.resolveURL(Ye),OT||(OT=new ov(fv(),new Ln)),OT.broadcast("setMeshoptUrl",LT)},Ye.dG=tr,Ye.dH=Mo,Ye.dI=pp,Ye.dJ=iw,Ye.dK=ng,Ye.dL=pu,Ye.dM=um,Ye.dN=Vm,Ye.dO=Kd,Ye.dP=ur,Ye.dQ=Ty,Ye.dR=$g,Ye.dS=function(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr){Ye.createArrays(),Ye.tilePixelRatio=ym/(512*Ye.overscaling),Ye.compareText={},Ye.iconsNeedLinear=!1;const Lr=Ye.layers[0].layout,Qr=Ye.layers[0]._unevaluatedLayout._values,fn={};if("composite"===Ye.textSizeData.kind){const{minZoom:ut,maxZoom:pt}=Ye.textSizeData;fn.compositeTextSizes=[Qr["text-size"].possiblyEvaluate(new Ho(ut),Lt),Qr["text-size"].possiblyEvaluate(new Ho(pt),Lt)]}if("composite"===Ye.iconSizeData.kind){const{minZoom:ut,maxZoom:pt}=Ye.iconSizeData;fn.compositeIconSizes=[Qr["icon-size"].possiblyEvaluate(new Ho(ut),Lt),Qr["icon-size"].possiblyEvaluate(new Ho(pt),Lt)]}fn.layoutTextSize=Qr["text-size"].possiblyEvaluate(new Ho($t+1),Lt),fn.layoutIconSize=Qr["icon-size"].possiblyEvaluate(new Ho($t+1),Lt),fn.textMaxSize=Qr["text-size"].possiblyEvaluate(new Ho(18),Lt);const xn="map"===Lr.get("text-rotation-alignment")&&"point"!==Lr.get("symbol-placement"),vn=Lr.get("text-size");let kn=!1;for(const ut of Ye.features)if(ut.icon&&ut.icon.nameSecondary){kn=!0;break}for(const St of Ye.features){const $t=Lr.get("text-font").evaluate(St,{},Lt).join(","),Qr=vn.evaluate(St,{},Lt),Wn=fn.layoutTextSize.evaluate(St,{},Lt),Xn=(fn.layoutIconSize.evaluate(St,{},Lt),{horizontal:{},vertical:void 0}),Jn=St.text;let Qn,ko=[0,0];if(Jn){const wt=Jn.toString(),It=Lr.get("text-letter-spacing").evaluate(St,{},Lt)*Fb,Xt=Lr.get("text-line-height").evaluate(St,{},Lt)*Fb,Sr=zo(wt)?It:0,fn=Lr.get("text-anchor").evaluate(St,{},Lt),vn=Lr.get("text-variable-anchor");if(!vn){const Ye=Lr.get("text-radial-offset").evaluate(St,{},Lt);ko=Ye?Yy(fn,[Ye*Fb,ow]):Lr.get("text-offset").evaluate(St,{},Lt).map((Ye=>Ye*Fb))}let kn=xn?"center":Lr.get("text-justify").evaluate(St,{},Lt);const Qn="point"===Lr.get("symbol-placement"),Fo=Qn?Lr.get("text-max-width").evaluate(St,{},Lt)*Fb:1/0,M=St=>{Ye.allowVerticalPlacement&&Po(wt)&&(Xn.vertical=ny(Jn,ut,pt,Tt,$t,Fo,Xt,fn,St,Sr,ko,Wb.vertical,!0,Wn,Qr))};if(!xn&&vn){const Ye="auto"===kn?vn.map((Ye=>Xy(Ye))):[kn];let wt=!1;for(let St=0;St<Ye.length;St++){const It=Ye[St];if(!Xn.horizontal[It])if(wt)Xn.horizontal[It]=Xn.horizontal[0];else{const Ye=ny(Jn,ut,pt,Tt,$t,Fo,Xt,"center",It,Sr,ko,Wb.horizontal,!1,Wn,Qr);Ye&&(Xn.horizontal[It]=Ye,wt=1===Ye.positionedLines.length)}}M("left")}else{if("auto"===kn&&(kn=Xy(fn)),Qn||Lr.get("text-writing-mode").indexOf("horizontal")>=0||!Po(wt)){const Ye=ny(Jn,ut,pt,Tt,$t,Fo,Xt,fn,kn,Sr,ko,Wb.horizontal,!1,Wn,Qr);Ye&&(Xn.horizontal[kn]=Ye)}M(Qn?"left":kn)}}let Fo=!1;if(St.icon&&St.icon.namePrimary){const ut=wt[St.icon.namePrimary];ut&&(Qn=fy(Tt[St.icon.namePrimary],St.icon.nameSecondary?Tt[St.icon.nameSecondary]:void 0,Lr.get("icon-offset").evaluate(St,{},Lt),Lr.get("icon-anchor").evaluate(St,{},Lt)),Fo=ut.sdf,void 0===Ye.sdfIcons?Ye.sdfIcons=ut.sdf:Ye.sdfIcons!==ut.sdf&&fr("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(ut.pixelRatio!==Ye.pixelRatio||0!==Lr.get("icon-rotate").constantOr(1))&&(Ye.iconsNeedLinear=!0))}const is=Jy(Xn.horizontal)||Xn.vertical;Ye.iconsInText||(Ye.iconsInText=!!is&&is.iconsInText),(is||Qn)&&Zy(Ye,St,Xn,Qn,wt,fn,Wn,0,ko,Fo,It,Lt,Xt,Sr,kn)}St&&Ye.generateCollisionDebugBuffers($t,Ye.collisionBoxArray)},Ye.dT=tm,Ye.dU=Wp,Ye.dV=Bx,Ye.dW=Lb,Ye.dX=Jf,Ye.dY=Xx,Ye.dZ=Fx,Ye.d_=Cx,Ye.da=Kh,Ye.db=function(ut){const pt=[0,0,0],wt=Ye.ad.identity(new Float64Array(16));return Ye.ad.multiply(wt,ut.pixelMatrix,ut.globeMatrix),Ye._.transformMat4(pt,pt,wt),new wu(pt[0],pt[1])},Ye.dc=Lt,Ye.dd=It,Ye.de=function(Ye){const ut=Ye.navigator?Ye.navigator.userAgent:null;return!!function(Ye){if(null==od){const ut=Ye.navigator?Ye.navigator.userAgent:null;od=!!Ye.safari||!(!ut||!(/\b(iPad|iPhone|iPod)\b/.test(ut)||ut.match("Safari")&&!ut.match("Chrome")))}return od}(Ye)&&ut&&(ut.match("Version/15.4")||ut.match("Version/15.5")||ut.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},Ye.df=nr,Ye.dg=class{constructor(Ye,ut,pt){this._transformRequestFn=Ye,this._customAccessToken=ut,this._silenceAuthErrors=!!pt,this._createSkuToken()}_createSkuToken(){const Ye=function(){let Ye="";for(let ut=0;ut<10;ut++)Ye+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Wd,Ye].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=Ye.token,this._skuTokenExpiresAt=Ye.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(Ye,ut){return this._transformRequestFn&&this._transformRequestFn(Ye,ut)||{url:Ye}}normalizeStyleURL(Ye,ut){if(!s(Ye))return Ye;const wt=hn(Ye);return wt.params.push(`sdk=js-${pt}`),wt.path=`/styles/v1${wt.path}`,this._makeAPIURL(wt,this._customAccessToken||ut)}normalizeGlyphsURL(Ye,ut){if(!s(Ye))return Ye;const pt=hn(Ye);return pt.path=`/fonts/v1${pt.path}`,this._makeAPIURL(pt,this._customAccessToken||ut)}normalizeModelURL(Ye,ut){if(!s(Ye))return Ye;const pt=hn(Ye);return pt.path=`/models/v1${pt.path}`,this._makeAPIURL(pt,this._customAccessToken||ut)}normalizeSourceURL(Ye,ut,pt,wt){if(!s(Ye))return Ye;const Tt=hn(Ye);return Tt.path=`/v4/${Tt.authority}.json`,Tt.params.push("secure"),pt&&Tt.params.push(`language=${pt}`),wt&&Tt.params.push(`worldview=${wt}`),this._makeAPIURL(Tt,this._customAccessToken||ut)}normalizeSpriteURL(Ye,ut,pt,wt){const Tt=hn(Ye);return s(Ye)?(Tt.path=`/styles/v1${Tt.path}/sprite${ut}${pt}`,this._makeAPIURL(Tt,this._customAccessToken||wt)):(Tt.path+=`${ut}${pt}`,pn(Tt))}normalizeTileURL(Ye,ut,pt){if(this._isSkuTokenExpired()&&this._createSkuToken(),Ye&&!s(Ye))return Ye;const wt=hn(Ye);wt.path=wt.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${ut||pt&&"raster"!==wt.authority&&512===pt?"@2x":""}${Ld.supported?".webp":"$1"}`),"raster"===wt.authority?wt.path=`/${St.RASTER_URL_PREFIX}${wt.path}`:"rasterarrays"===wt.authority?wt.path=`/${St.RASTERARRAYS_URL_PREFIX}${wt.path}`:"3dtiles"===wt.authority?wt.path=`/${St.TILES3D_URL_PREFIX}${wt.path}`:(wt.path=wt.path.replace(/^.+\/v4\//,"/"),wt.path=`/${St.TILE_URL_VERSION}${wt.path}`);const Tt=this._customAccessToken||function(Ye){for(const ut of Ye){const Ye=ut.match(/^access_token=(.*)$/);if(Ye)return Ye[1]}return null}(wt.params)||St.ACCESS_TOKEN;return St.REQUIRE_ACCESS_TOKEN&&Tt&&this._skuToken&&wt.params.push(`sku=${this._skuToken}`),this._makeAPIURL(wt,Tt)}canonicalizeTileURL(Ye,ut){const pt=hn(Ye);if(!pt.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!pt.path.match(/\.[\w]+$/))return Ye;let wt="mapbox://";pt.path.match(/^\/raster\/v1\//)?wt+=`raster/${pt.path.replace(`/${St.RASTER_URL_PREFIX}/`,"")}`:pt.path.match(/^\/rasterarrays\/v1\//)?wt+=`rasterarrays/${pt.path.replace(`/${St.RASTERARRAYS_URL_PREFIX}/`,"")}`:wt+=`tiles/${pt.path.replace(`/${St.TILE_URL_VERSION}/`,"")}`;let Tt=pt.params;return ut&&(Tt=Tt.filter((Ye=>!Ye.match(/^access_token=/)))),Tt.length&&(wt+=`?${Tt.join("&")}`),wt}canonicalizeTileset(Ye,ut){const pt=!!ut&&s(ut),wt=[];for(const ut of Ye.tiles||[])i(ut)?wt.push(this.canonicalizeTileURL(ut,pt)):wt.push(ut);return wt}_makeAPIURL(Ye,ut){const pt="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",wt=hn(St.API_URL);if(Ye.protocol=wt.protocol,Ye.authority=wt.authority,"http"===Ye.protocol){const ut=Ye.params.indexOf("secure");ut>=0&&Ye.params.splice(ut,1)}if("/"!==wt.path&&(Ye.path=`${wt.path}${Ye.path}`),!St.REQUIRE_ACCESS_TOKEN)return pn(Ye);if(ut=ut||St.ACCESS_TOKEN,!this._silenceAuthErrors){if(!ut)throw new Error(`An API access token is required to use Mapbox GL. ${pt}`);if("s"===ut[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${pt}`)}return Ye.params=Ye.params.filter((Ye=>-1===Ye.indexOf("access_token"))),Ye.params.push(`access_token=${ut||""}`),pn(Ye)}},Ye.dh=function(Ye,ut){ut?vp.add(Ye):vp.delete(Ye)},Ye.di=Ld,Ye.dj=_p,Ye.dk=xp,Ye.dl=Hd,Ye.dm=tp,Ye.dn=ap,Ye.dp=function(Ye){vp.delete(Ye)},Ye.dq=yp,Ye.dr=ep,Ye.ds=Qe,Ye.dt=pt,Ye.du=function(Ye,ut){md=Ye,Cd=ut},Ye.dv=function(Ye,ut,pt=!1){if(D_===I_||D_===C_||D_===P_)throw new Error("setRTLTextPlugin cannot be called multiple times.");R_=sd.resolveURL(Ye),D_=I_,z_=ut,$o(),pt||Xo()},Ye.dw=Yo,Ye.dx=function(){fv().acquire(CT)},Ye.dy=function(){const Ye=PT;Ye&&(Ye.isPreloaded()&&1===Ye.numActive()?(Ye.release(CT),PT=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},Ye.dz=hv,Ye.e=sd,Ye.e0=bb,Ye.e1=p,Ye.e2=en,Ye.e3=function(Ye){let ut=0;if(new Uint32Array(Ye,0,1)[0]!==jT){const pt=new Uint32Array(Ye,0,7),[,,wt,Tt,St,It]=pt;ut=pt.byteLength+Tt+St+It+St,(wt!==Ye.byteLength||ut>=Ye.byteLength)&&fr("Invalid b3dm header information.")}return Vv(Ye,ut)},Ye.e4=function(Ye,ut){const pt=$v(Ye);for(const Ye of pt){for(const ut of Ye.meshes)Gv(ut);Ye.lights&&(Ye.lightMeshIndex=Ye.meshes.length,Ye.meshes.push(Yv(Ye.lights,ut)))}return pt},Ye.e5=Qv,Ye.e6=av,Ye.e7=k_,Ye.e8=function(Ye){jr(),Pd&&Pd.then((ut=>{ut.keys().then((pt=>{for(let wt=0;wt<pt.length-Ye;wt++)ut.delete(pt[wt])}))}))},Ye.f=Dn,Ye.g=function(Ye,ut){return tn(er(Ye,{type:"json"}),ut)},Ye.h=on,Ye.i=fp,Ye.j=Ay,Ye.k=Iy,Ye.l=function(Ye){return fetch(Ye).then((Ye=>Ye.arrayBuffer())).then((ut=>Vv(ut,0,Ye)))},Ye.m=class extends qb{},Ye.n=Ti,Ye.o=Zn,Ye.p=zw,Ye.q=Wa,Ye.r=Qa,Ye.s=to,Ye.t=co,Ye.u=ul,Ye.v=cl,Ye.w=fr,Ye.x=mo,Ye.y=ho,Ye.z=Xs}));define(["./shared"],(function(Ye){function t(Ye){const ut=Ye?Ye.url.toString():void 0;return ut?performance.getEntriesByName(ut):[]}function s(Ye){if("number"==typeof Ye||"boolean"==typeof Ye||"string"==typeof Ye||null==Ye)return JSON.stringify(Ye);if(Array.isArray(Ye)){let ut="[";for(const pt of Ye)ut+=`${s(pt)},`;return`${ut}]`}let ut="{";for(const pt of Object.keys(Ye).sort())ut+=`${pt}:${s(Ye[pt])},`;return`${ut}}`}function o(ut){let pt="";for(const wt of Ye.cE)pt+=`/${s(ut[wt])}`;return pt}class i{constructor(Ye){this.keyCache={},this._layers={},this._layerConfigs={},Ye&&this.replace(Ye)}replace(Ye,ut){this._layerConfigs={},this._layers={},this.update(Ye,[],ut)}update(ut,pt,wt){this._options=wt;for(const pt of ut)this._layerConfigs[pt.id]=pt,(this._layers[pt.id]=Ye.cY(pt,this.scope,null,this._options)).compileFilter(),this.keyCache[pt.id]&&delete this.keyCache[pt.id];for(const Ye of pt)delete this.keyCache[Ye],delete this._layerConfigs[Ye],delete this._layers[Ye];this.familiesBySource={};const Tt=function(Ye,ut){const pt={};for(let wt=0;wt<Ye.length;wt++){const Tt=ut&&ut[Ye[wt].id]||o(Ye[wt]);ut&&(ut[Ye[wt].id]=Tt);let St=pt[Tt];St||(St=pt[Tt]=[]),St.push(Ye[wt])}const wt=[];for(const Ye in pt)wt.push(pt[Ye]);return wt}(Ye.dG(this._layerConfigs),this.keyCache);for(const Ye of Tt){const ut=Ye.map((Ye=>this._layers[Ye.id])),pt=ut[0];if("none"===pt.visibility)continue;const wt=pt.source||"";let Tt=this.familiesBySource[wt];Tt||(Tt=this.familiesBySource[wt]={});const St=pt.sourceLayer||"_geojsonTileLayer";let It=Tt[St];It||(It=Tt[St]=[]),It.push(ut)}}}const pt=1*Ye.dJ;class r{constructor(ut){const wt={},Tt=[];for(const Ye in ut){const St=ut[Ye],It=wt[Ye]={};for(const Ye in St.glyphs){const ut=St.glyphs[+Ye];if(!ut||0===ut.bitmap.width||0===ut.bitmap.height)continue;const wt=ut.metrics.localGlyph?pt:1,Lt={x:0,y:0,w:ut.bitmap.width+2*wt,h:ut.bitmap.height+2*wt};Tt.push(Lt),It[Ye]=Lt}}const{w:St,h:It}=Ye.j(Tt),Lt=new Ye.dI({width:St||1,height:It||1});for(const Tt in ut){const St=ut[Tt];for(const ut in St.glyphs){const It=St.glyphs[+ut];if(!It||0===It.bitmap.width||0===It.bitmap.height)continue;const $t=wt[Tt][ut],Xt=It.metrics.localGlyph?pt:1;Ye.dI.copy(It.bitmap,Lt,{x:0,y:0},{x:$t.x+Xt,y:$t.y+Xt},It.bitmap)}}this.image=Lt,this.positions=wt}}Ye.dH(r,"GlyphAtlas");class a{constructor(ut){this.tileID=new Ye.aL(ut.tileID.overscaledZ,ut.tileID.wrap,ut.tileID.canonical.z,ut.tileID.canonical.x,ut.tileID.canonical.y),this.tileZoom=ut.tileZoom,this.uid=ut.uid,this.zoom=ut.zoom,this.lut=ut.lut,this.canonical=ut.tileID.canonical,this.pixelRatio=ut.pixelRatio,this.tileSize=ut.tileSize,this.source=ut.source,this.scope=ut.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=ut.showCollisionBoxes,this.collectResourceTiming=!!ut.collectResourceTiming,this.promoteId=ut.promoteId,this.isSymbolTile=ut.isSymbolTile,this.tileTransform=Ye.dK(ut.tileID.canonical,ut.projection),this.projection=ut.projection,this.brightness=ut.brightness,this.extraShadowCaster=!!ut.extraShadowCaster,this.tessellationStep=ut.tessellationStep}parse(ut,pt,wt,Tt,St){this.status="parsing",this.data=ut,this.collisionBoxArray=new Ye.dL;const It=new Ye.dM(Object.keys(ut.layers).sort()),Lt=new Ye.dN(this.tileID,this.promoteId);Lt.bucketLayerIDs=[];const $t={},Xt=new Ye.dO(256,256),Sr={featureIndex:Lt,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:Xt,availableImages:wt,brightness:this.brightness},Lr=pt.familiesBySource[this.source];for(const pt in Lr){const Tt=ut.layers[pt];if(!Tt)continue;let St=!1,Xt=!1,Qr=!1;for(const Ye of Lr[pt])"symbol"===Ye[0].type?St=!0:Xt=!0,Ye[0].is3D()&&"model"!==Ye[0].type&&(Qr=!0);if(this.extraShadowCaster&&!Qr)continue;if(!0===this.isSymbolTile&&!St)continue;if(!1===this.isSymbolTile&&!Xt)continue;1===Tt.version&&Ye.w(`Vector tile source "${this.source}" layer "${pt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const fn=It.encode(pt),xn=[];for(let Ye=0;Ye<Tt.length;Ye++){const ut=Tt.feature(Ye),wt=Lt.getId(ut,pt);xn.push({feature:ut,id:wt,index:Ye,sourceLayerIndex:fn})}for(const Ye of Lr[pt]){const ut=Ye[0];(!this.extraShadowCaster||ut.is3D()&&"model"!==ut.type)&&(void 0!==this.isSymbolTile&&"symbol"===ut.type!==this.isSymbolTile||ut.minzoom&&this.zoom<Math.floor(ut.minzoom)||ut.maxzoom&&this.zoom>=ut.maxzoom||"none"!==ut.visibility&&(l(Ye,this.zoom,Sr.brightness,wt),($t[ut.id]=ut.createBucket({index:Lt.bucketLayerIDs.length,layers:Ye,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:fn,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(xn,Sr,this.tileID.canonical,this.tileTransform),Lt.bucketLayerIDs.push(Ye.map((Ye=>Ye.id)))))}}let Qr,fn,xn,vn;Xt.trim();const kn={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},w=()=>{if(Qr)return this.status="done",St(Qr);if(this.extraShadowCaster)this.status="done",St(null,{buckets:Ye.dG($t).filter((Ye=>!Ye.isEmpty())),featureIndex:Lt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Sr.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(fn&&xn&&vn){const ut=new r(fn),pt=new Ye.dQ(xn,vn,this.lut);for(const Tt in $t){const St=$t[Tt];St instanceof Ye.dR?(l(St.layers,this.zoom,Sr.brightness,wt),Ye.dS(St,fn,ut.positions,xn,pt.iconPositions,this.showCollisionBoxes,wt,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):St.hasPattern&&(St instanceof Ye.dT||St instanceof Ye.dU||St instanceof Ye.b_)&&(l(St.layers,this.zoom,Sr.brightness,wt),St.addFeatures(Sr,this.tileID.canonical,pt.patternPositions,wt,this.tileTransform,this.brightness))}this.status="done",St(null,{buckets:Ye.dG($t).filter((Ye=>!Ye.isEmpty())),featureIndex:Lt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:ut.image,lineAtlas:Xt,imageAtlas:pt,brightness:Sr.brightness})}};if(!this.extraShadowCaster){const ut=Ye.dP(Sr.glyphDependencies,(Ye=>Object.keys(Ye).map(Number)));Object.keys(ut).length?Tt.send("getGlyphs",{uid:this.uid,stacks:ut,scope:this.scope},((Ye,ut)=>{Qr||(Qr=Ye,fn=ut,w())}),void 0,!1,kn):fn={};const pt=Object.keys(Sr.iconDependencies);pt.length?Tt.send("getImages",{icons:pt,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((Ye,ut)=>{Qr||(Qr=Ye,xn=ut,w())}),void 0,!1,kn):xn={};const wt=Object.keys(Sr.patternDependencies);wt.length?Tt.send("getImages",{icons:wt,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((Ye,ut)=>{Qr||(Qr=Ye,vn=ut,w())}),void 0,!1,kn):vn={}}w()}}function l(ut,pt,wt,Tt){const St=new Ye.X(pt,{brightness:wt});for(const Ye of ut)Ye.recalculate(St,Tt)}class c extends Ye.E{constructor(ut,pt,wt,Tt,St,It){super(),this.actor=ut,this.layerIndex=pt,this.availableImages=wt,this.loadVectorData=St||Ye.ap,this.loading={},this.loaded={},this.deduped=new Ye.ao(ut.scheduler),this.isSpriteLoaded=Tt,this.scheduler=ut.scheduler,this.brightness=It}loadTile(ut,pt){const wt=ut.uid,Tt=ut&&ut.request,St=Tt&&Tt.collectResourceTiming,It=this.loading[wt]=new a(ut);It.abort=this.loadVectorData(ut,((Lt,$t)=>{const Xt=!this.loading[wt];if(delete this.loading[wt],Xt||Lt||!$t)return It.status="done",Xt||(this.loaded[wt]=It),pt(Lt);const Sr=$t.rawData,Lr={};$t.expires&&(Lr.expires=$t.expires),$t.cacheControl&&(Lr.cacheControl=$t.cacheControl),It.vectorTile=$t.vectorTile||new Ye.dV(new Ye.dW(Sr));const f=()=>{It.parse(It.vectorTile,this.layerIndex,this.availableImages,this.actor,((ut,wt)=>{if(ut||!wt)return pt(ut);const It={};if(St){const Ye=t(Tt);Ye.length>0&&(It.resourceTiming=JSON.parse(JSON.stringify(Ye)))}pt(null,Ye.W({rawTileData:Sr.slice(0)},wt,Lr,It))}))};this.isSpriteLoaded?f():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(f,{type:"parseTile",isSymbolTile:ut.isSymbolTile,zoom:ut.tileZoom}):f()})),this.loaded=this.loaded||{},this.loaded[wt]=It}))}reloadTile(ut,pt){const wt=this.loaded,Tt=ut.uid;if(wt&&wt[Tt]){const St=wt[Tt];St.showCollisionBoxes=ut.showCollisionBoxes,St.projection=ut.projection,St.brightness=ut.brightness,St.tileTransform=Ye.dK(ut.tileID.canonical,ut.projection),St.extraShadowCaster=ut.extraShadowCaster,St.lut=ut.lut;const r=(Ye,ut)=>{const wt=St.reloadCallback;wt&&(delete St.reloadCallback,St.parse(St.vectorTile,this.layerIndex,this.availableImages,this.actor,wt)),pt(Ye,ut)};"parsing"===St.status?St.reloadCallback=r:"done"===St.status&&(St.vectorTile?St.parse(St.vectorTile,this.layerIndex,this.availableImages,this.actor,r):r())}else pt(null,void 0)}abortTile(Ye,ut){const pt=Ye.uid,wt=this.loading[pt];wt&&(wt.abort&&wt.abort(),delete this.loading[pt]),ut()}removeTile(Ye,ut){const pt=this.loaded,wt=Ye.uid;pt&&pt[wt]&&delete pt[wt],ut()}}class h{loadTile(ut,pt){const{uid:wt,encoding:Tt,rawImageData:St,padding:It}=ut,Lt=ImageBitmap&&St instanceof ImageBitmap?this.getImageData(St,It):St;pt(null,new Ye.dX(wt,Lt,Tt,It<1))}getImageData(Ye,ut){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(Ye.width,Ye.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=Ye.width,this.offscreenCanvas.height=Ye.height,this.offscreenCanvasContext.drawImage(Ye,0,0,Ye.width,Ye.height);const pt=this.offscreenCanvasContext.getImageData(-ut,-ut,Ye.width+2*ut,Ye.height+2*ut);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),pt}}class u{decodeRasterArray({task:ut,buffer:pt},wt){Ye.dY.performDecoding(pt,ut).then((Ye=>{wt(null,Ye)}),(Ye=>{wt(Ye)}))}}const wt=Ye.dZ.prototype.toGeoJSON;let Tt=class{constructor(ut){this._feature=ut,this.extent=Ye.a3,this.type=ut.type,this.properties=ut.tags,"id"in ut&&!isNaN(ut.id)&&(this.id=parseInt(ut.id,10))}loadGeometry(){if(1===this._feature.type){const ut=[];for(const pt of this._feature.geometry)ut.push([new Ye.P(pt[0],pt[1])]);return ut}{const ut=[];for(const pt of this._feature.geometry){const wt=[];for(const ut of pt)wt.push(new Ye.P(ut[0],ut[1]));ut.push(wt)}return ut}}toGeoJSON(Ye,ut,pt){return wt.call(this,Ye,ut,pt)}},St=class{constructor(ut){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=Ye.a3,this.length=ut.length,this._features=ut}feature(Ye){return new Tt(this._features[Ye])}};const It=64/4096;class m{constructor(){this.features=new Map}clear(){this.features.clear()}load(Ye=[],ut){for(const pt of Ye){const Ye=pt.id;if(null==Ye)continue;let wt=this.features.get(Ye);wt&&this.updateCache(wt,ut),pt.geometry?(wt=x(pt),this.updateCache(wt,ut),this.features.set(Ye,wt)):this.features.delete(Ye),this.updateCache(wt,ut)}}updateCache(Ye,ut){for(const{canonical:pt,uid:wt}of Object.values(ut)){const{z:Tt,x:St,y:It}=pt;y(Ye,Math.pow(2,Tt),St,It)&&delete ut[wt]}}getTile(Ye,ut,pt){const wt=Math.pow(2,Ye),Tt=[];for(const Ye of this.features.values())y(Ye,wt,ut,pt)&&Tt.push(v(Ye,wt,ut,pt));return{features:Tt}}getFeatures(){return[...this.features.values()]}}function y({minX:Ye,minY:ut,maxX:pt,maxY:wt},Tt,St,Lt){return Ye<(St+1+It)/Tt&&ut<(Lt+1+It)/Tt&&pt>(St-It)/Tt&&wt>(Lt-It)/Tt}function x(Ye){const{id:ut,geometry:pt,properties:wt}=Ye;if(!pt)return;if("GeometryCollection"===pt.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Tt,coordinates:St}=pt,It={id:ut,type:1,geometry:[],tags:wt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Lt=It.geometry;if("Point"===Tt)w(St,Lt,It);else if("MultiPoint"===Tt)for(const Ye of St)w(Ye,Lt,It);else if("LineString"===Tt)It.type=2,S(St,Lt,It);else if("MultiLineString"===Tt)It.type=2,b(St,Lt,It);else if("Polygon"===Tt)It.type=3,b(St,Lt,It,!0);else{if("MultiPolygon"!==Tt)throw new Error("Input data is not a valid GeoJSON object.");It.type=3;for(const Ye of St)b(Ye,Lt,It,!0)}return It}function w([ut,pt],wt,Tt){const St=Ye.aj(ut);let It=Ye.ak(pt);It=It<0?0:It>1?1:It,wt.push(St,It),Tt.minX=Math.min(Tt.minX,St),Tt.minY=Math.min(Tt.minY,It),Tt.maxX=Math.max(Tt.maxX,St),Tt.maxY=Math.max(Tt.maxY,It)}function S(Ye,ut,pt,wt=!1,Tt=!1){const St=[];for(const ut of Ye)w(ut,St,pt);ut.push(St),wt&&function(Ye,ut){let pt=0;for(let ut=0,wt=Ye.length,Tt=wt-2;ut<wt;Tt=ut,ut+=2)pt+=(Ye[ut]-Ye[Tt])*(Ye[ut+1]+Ye[Tt+1]);if(pt>0===ut)for(let ut=0,pt=Ye.length;ut<pt/2;ut+=2){const wt=Ye[ut],Tt=Ye[ut+1];Ye[ut]=Ye[pt-2-ut],Ye[ut+1]=Ye[pt-1-ut],Ye[pt-2-ut]=wt,Ye[pt-1-ut]=Tt}}(St,Tt)}function b(Ye,ut,pt,wt=!1){for(let Tt=0;Tt<Ye.length;Tt++)S(Ye[Tt],ut,pt,wt,0===Tt)}function v(Ye,ut,pt,wt){const{id:Tt,type:St,geometry:It,tags:Lt}=Ye,$t=[];if(1===St)I(It,ut,pt,wt,$t);else for(const Ye of It)$t.push(I(Ye,ut,pt,wt));return{id:Tt,type:St,geometry:$t,tags:Lt}}function I(Ye,ut,pt,wt,Tt=[]){for(let St=0;St<Ye.length;St+=2)Tt.push(M(Ye[St],Ye[St+1],ut,pt,wt));return Tt}function M(ut,pt,wt,Tt,St){return[Math.round(Ye.a3*(ut*wt-Tt)),Math.round(Ye.a3*(pt*wt-St))]}var Lt={exports:{}},$t=Ye.d$,Xt=Ye.d_.VectorTileFeature,Sr=_;function _(Ye,pt){(this||ut).options=pt||{},(this||ut).features=Ye,(this||ut).length=Ye.length}function L(Ye,pt){(this||ut).id="number"==typeof Ye.id?Ye.id:void 0,(this||ut).type=Ye.type,(this||ut).rawGeometry=1===Ye.type?[Ye.geometry]:Ye.geometry,(this||ut).properties=Ye.tags,(this||ut).extent=pt||4096}_.prototype.feature=function(Ye){return new L((this||ut).features[Ye],(this||ut).options.extent)},L.prototype.loadGeometry=function(){var Ye=(this||ut).rawGeometry;(this||ut).geometry=[];for(var pt=0;pt<Ye.length;pt++){for(var wt=Ye[pt],Tt=[],St=0;St<wt.length;St++)Tt.push(new $t(wt[St][0],wt[St][1]));(this||ut).geometry.push(Tt)}return(this||ut).geometry},L.prototype.bbox=function(){(this||ut).geometry||this.loadGeometry();for(var Ye=(this||ut).geometry,pt=1/0,wt=-1/0,Tt=1/0,St=-1/0,It=0;It<Ye.length;It++)for(var Lt=Ye[It],$t=0;$t<Lt.length;$t++){var Xt=Lt[$t];pt=Math.min(pt,Xt.x),wt=Math.max(wt,Xt.x),Tt=Math.min(Tt,Xt.y),St=Math.max(St,Xt.y)}return[pt,Tt,wt,St]},L.prototype.toGeoJSON=Xt.prototype.toGeoJSON;var Lr=Ye.e0,Qr=Sr;function O(Ye){var ut=new Lr;return function(Ye,ut){for(var pt in Ye.layers)ut.writeMessage(3,z,Ye.layers[pt])}(Ye,ut),ut.finish()}function z(Ye,ut){var pt;ut.writeVarintField(15,Ye.version||1),ut.writeStringField(1,Ye.name||""),ut.writeVarintField(5,Ye.extent||4096);var wt={keys:[],values:[],keycache:{},valuecache:{}};for(pt=0;pt<Ye.length;pt++)wt.feature=Ye.feature(pt),ut.writeMessage(2,Z,wt);var Tt=wt.keys;for(pt=0;pt<Tt.length;pt++)ut.writeStringField(3,Tt[pt]);var St=wt.values;for(pt=0;pt<St.length;pt++)ut.writeMessage(4,Y,St[pt])}function Z(Ye,ut){var pt=Ye.feature;void 0!==pt.id&&ut.writeVarintField(1,pt.id),ut.writeMessage(2,E,Ye),ut.writeVarintField(3,pt.type),ut.writeMessage(4,X,pt)}function E(Ye,ut){var pt=Ye.feature,wt=Ye.keys,Tt=Ye.values,St=Ye.keycache,It=Ye.valuecache;for(var Lt in pt.properties){var $t=pt.properties[Lt],Xt=St[Lt];if(null!==$t){void 0===Xt&&(wt.push(Lt),St[Lt]=Xt=wt.length-1),ut.writeVarint(Xt);var Sr=typeof $t;"string"!==Sr&&"boolean"!==Sr&&"number"!==Sr&&($t=JSON.stringify($t));var Lr=Sr+":"+$t,Qr=It[Lr];void 0===Qr&&(Tt.push($t),It[Lr]=Qr=Tt.length-1),ut.writeVarint(Qr)}}}function A(Ye,ut){return(ut<<3)+(7&Ye)}function N(Ye){return Ye<<1^Ye>>31}function X(Ye,ut){for(var pt=Ye.loadGeometry(),wt=Ye.type,Tt=0,St=0,It=pt.length,Lt=0;Lt<It;Lt++){var $t=pt[Lt],Xt=1;1===wt&&(Xt=$t.length),ut.writeVarint(A(1,Xt));for(var Sr=3===wt?$t.length-1:$t.length,Lr=0;Lr<Sr;Lr++){1===Lr&&1!==wt&&ut.writeVarint(A(2,Sr-1));var Qr=$t[Lr].x-Tt,fn=$t[Lr].y-St;ut.writeVarint(N(Qr)),ut.writeVarint(N(fn)),Tt+=Qr,St+=fn}3===wt&&ut.writeVarint(A(7,1))}}function Y(Ye,ut){var pt=typeof Ye;"string"===pt?ut.writeStringField(1,Ye):"boolean"===pt?ut.writeBooleanField(7,Ye):"number"===pt&&(Ye%1!=0?ut.writeDoubleField(3,Ye):Ye<0?ut.writeSVarintField(6,Ye):ut.writeVarintField(5,Ye))}Lt.exports=O,Lt.exports.fromVectorTileJs=O,Lt.exports.fromGeojsonVt=function(Ye,ut){ut=ut||{};var pt={};for(var wt in Ye)pt[wt]=new Qr(Ye[wt].features,ut),pt[wt].name=wt,pt[wt].version=ut.version,pt[wt].extent=ut.extent;return O({layers:pt})},Lt.exports.GeoJSONWrapper=Qr;var fn=Ye.e1(Lt.exports);const xn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ye=>Ye},vn=Math.fround||(kn=new Float32Array(1),Ye=>(kn[0]=+Ye,kn[0]));var kn;const Wn=3,Xn=5,Jn=6;class ${constructor(Ye){this.options=Object.assign(Object.create(xn),Ye),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(Ye){const{log:ut,minZoom:pt,maxZoom:wt}=this.options;ut&&console.time("total time");const Tt=`prepare ${Ye.length} points`;ut&&console.time(Tt),this.points=Ye;const St=[];for(let ut=0;ut<Ye.length;ut++){const pt=Ye[ut];if(!pt.geometry)continue;const[wt,Tt]=pt.geometry.coordinates,It=vn(K(wt)),Lt=vn(H(Tt));St.push(It,Lt,1/0,ut,-1,1),this.options.reduce&&St.push(0)}let It=this.trees[wt+1]=this._createTree(St);ut&&console.timeEnd(Tt);for(let Ye=wt;Ye>=pt;Ye--){const pt=+Date.now();It=this.trees[Ye]=this._createTree(this._cluster(It,Ye)),ut&&console.log("z%d: %d clusters in %dms",Ye,It.numItems,+Date.now()-pt)}return ut&&console.timeEnd("total time"),this}getClusters(Ye,ut){let pt=((Ye[0]+180)%360+360)%360-180;const wt=Math.max(-90,Math.min(90,Ye[1]));let Tt=180===Ye[2]?180:((Ye[2]+180)%360+360)%360-180;const St=Math.max(-90,Math.min(90,Ye[3]));if(Ye[2]-Ye[0]>=360)pt=-180,Tt=180;else if(pt>Tt){const Ye=this.getClusters([pt,wt,180,St],ut),It=this.getClusters([-180,wt,Tt,St],ut);return Ye.concat(It)}const It=this.trees[this._limitZoom(ut)],Lt=It.range(K(pt),H(St),K(Tt),H(wt)),$t=It.data,Xt=[];for(const Ye of Lt){const ut=this.stride*Ye;Xt.push($t[ut+Xn]>1?U($t,ut,this.clusterProps):this.points[$t[ut+Wn]])}return Xt}getChildren(Ye){const ut=this._getOriginId(Ye),pt=this._getOriginZoom(Ye),wt="No cluster with the specified id.",Tt=this.trees[pt];if(!Tt)throw new Error(wt);const St=Tt.data;if(ut*this.stride>=St.length)throw new Error(wt);const It=this.options.radius/(this.options.extent*Math.pow(2,pt-1)),Lt=Tt.within(St[ut*this.stride],St[ut*this.stride+1],It),$t=[];for(const ut of Lt){const pt=ut*this.stride;St[pt+4]===Ye&&$t.push(St[pt+Xn]>1?U(St,pt,this.clusterProps):this.points[St[pt+Wn]])}if(0===$t.length)throw new Error(wt);return $t}getLeaves(Ye,ut,pt){const wt=[];return this._appendLeaves(wt,Ye,ut=ut||10,pt=pt||0,0),wt}getTile(Ye,ut,pt){const wt=this.trees[this._limitZoom(Ye)],Tt=Math.pow(2,Ye),{extent:St,radius:It}=this.options,Lt=It/St,$t=(pt-Lt)/Tt,Xt=(pt+1+Lt)/Tt,Sr={features:[]};return this._addTileFeatures(wt.range((ut-Lt)/Tt,$t,(ut+1+Lt)/Tt,Xt),wt.data,ut,pt,Tt,Sr),0===ut&&this._addTileFeatures(wt.range(1-Lt/Tt,$t,1,Xt),wt.data,Tt,pt,Tt,Sr),ut===Tt-1&&this._addTileFeatures(wt.range(0,$t,Lt/Tt,Xt),wt.data,-1,pt,Tt,Sr),Sr.features.length?Sr:null}getClusterExpansionZoom(Ye){let ut=this._getOriginZoom(Ye)-1;for(;ut<=this.options.maxZoom;){const pt=this.getChildren(Ye);if(ut++,1!==pt.length)break;Ye=pt[0].properties.cluster_id}return ut}_appendLeaves(Ye,ut,pt,wt,Tt){const St=this.getChildren(ut);for(const ut of St){const St=ut.properties;if(St&&St.cluster?Tt+St.point_count<=wt?Tt+=St.point_count:Tt=this._appendLeaves(Ye,St.cluster_id,pt,wt,Tt):Tt<wt?Tt++:Ye.push(ut),Ye.length===pt)break}return Tt}_createTree(ut){const pt=new Ye.cK(ut.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Ye=0;Ye<ut.length;Ye+=this.stride)pt.add(ut[Ye],ut[Ye+1]);return pt.finish(),pt.data=ut,pt}_addTileFeatures(Ye,ut,pt,wt,Tt,St){for(const It of Ye){const Ye=It*this.stride,Lt=ut[Ye+Xn]>1;let $t,Xt,Sr;if(Lt)$t=q(ut,Ye,this.clusterProps),Xt=ut[Ye],Sr=ut[Ye+1];else{const pt=this.points[ut[Ye+Wn]];$t=pt.properties;const[wt,Tt]=pt.geometry.coordinates;Xt=K(wt),Sr=H(Tt)}const Lr={type:1,geometry:[[Math.round(this.options.extent*(Xt*Tt-pt)),Math.round(this.options.extent*(Sr*Tt-wt))]],tags:$t};let Qr;Qr=Lt||this.options.generateId?ut[Ye+Wn]:this.points[ut[Ye+Wn]].id,void 0!==Qr&&(Lr.id=Qr),St.features.push(Lr)}}_limitZoom(Ye){return Math.max(this.options.minZoom,Math.min(Math.floor(+Ye),this.options.maxZoom+1))}_cluster(Ye,ut){const{radius:pt,extent:wt,reduce:Tt,minPoints:St}=this.options,It=pt/(wt*Math.pow(2,ut)),Lt=Ye.data,$t=[],Xt=this.stride;for(let pt=0;pt<Lt.length;pt+=Xt){if(Lt[pt+2]<=ut)continue;Lt[pt+2]=ut;const wt=Lt[pt],Sr=Lt[pt+1],Lr=Ye.within(Lt[pt],Lt[pt+1],It),Qr=Lt[pt+Xn];let fn=Qr;for(const Ye of Lr){const pt=Ye*Xt;Lt[pt+2]>ut&&(fn+=Lt[pt+Xn])}if(fn>Qr&&fn>=St){let Ye,St=wt*Qr,It=Sr*Qr,xn=-1;const vn=(pt/Xt<<5)+(ut+1)+this.points.length;for(const wt of Lr){const $t=wt*Xt;if(Lt[$t+2]<=ut)continue;Lt[$t+2]=ut;const Sr=Lt[$t+Xn];St+=Lt[$t]*Sr,It+=Lt[$t+1]*Sr,Lt[$t+4]=vn,Tt&&(Ye||(Ye=this._map(Lt,pt,!0),xn=this.clusterProps.length,this.clusterProps.push(Ye)),Tt(Ye,this._map(Lt,$t)))}Lt[pt+4]=vn,$t.push(St/fn,It/fn,1/0,vn,-1,fn),Tt&&$t.push(xn)}else{for(let Ye=0;Ye<Xt;Ye++)$t.push(Lt[pt+Ye]);if(fn>1)for(const Ye of Lr){const pt=Ye*Xt;if(!(Lt[pt+2]<=ut)){Lt[pt+2]=ut;for(let Ye=0;Ye<Xt;Ye++)$t.push(Lt[pt+Ye])}}}}return $t}_getOriginId(Ye){return Ye-this.points.length>>5}_getOriginZoom(Ye){return(Ye-this.points.length)%32}_map(Ye,ut,pt){if(Ye[ut+Xn]>1){const wt=this.clusterProps[Ye[ut+Jn]];return pt?Object.assign({},wt):wt}const wt=this.points[Ye[ut+Wn]].properties,Tt=this.options.map(wt);return pt&&Tt===wt?Object.assign({},Tt):Tt}}function U(Ye,ut,pt){return{type:"Feature",id:Ye[ut+Wn],properties:q(Ye,ut,pt),geometry:{type:"Point",coordinates:[(wt=Ye[ut],360*(wt-.5)),Q(Ye[ut+1])]}};var wt}function q(Ye,ut,pt){const wt=Ye[ut+Xn],Tt=wt>=1e4?`${Math.round(wt/1e3)}k`:wt>=1e3?Math.round(wt/100)/10+"k":wt,St=Ye[ut+Jn],It=-1===St?{}:Object.assign({},pt[St]);return Object.assign(It,{cluster:!0,cluster_id:Ye[ut+Wn],point_count:wt,point_count_abbreviated:Tt})}function K(Ye){return Ye/360+.5}function H(Ye){const ut=Math.sin(Ye*Math.PI/180),pt=.5-.25*Math.log((1+ut)/(1-ut))/Math.PI;return pt<0?0:pt>1?1:pt}function Q(Ye){const ut=(180-360*Ye)*Math.PI/180;return 360*Math.atan(Math.exp(ut))/Math.PI-90}function ee(Ye,ut,pt,wt){let Tt=wt;const St=ut+(pt-ut>>1);let It,Lt=pt-ut;const $t=Ye[ut],Xt=Ye[ut+1],Sr=Ye[pt],Lr=Ye[pt+1];for(let wt=ut+3;wt<pt;wt+=3){const ut=te(Ye[wt],Ye[wt+1],$t,Xt,Sr,Lr);if(ut>Tt)It=wt,Tt=ut;else if(ut===Tt){const Ye=Math.abs(wt-St);Ye<Lt&&(It=wt,Lt=Ye)}}Tt>wt&&(It-ut>3&&ee(Ye,ut,It,wt),Ye[It+2]=Tt,pt-It>3&&ee(Ye,It,pt,wt))}function te(Ye,ut,pt,wt,Tt,St){let It=Tt-pt,Lt=St-wt;if(0!==It||0!==Lt){const $t=((Ye-pt)*It+(ut-wt)*Lt)/(It*It+Lt*Lt);$t>1?(pt=Tt,wt=St):$t>0&&(pt+=It*$t,wt+=Lt*$t)}return It=Ye-pt,Lt=ut-wt,It*It+Lt*Lt}function se(Ye,ut,pt,wt){const Tt={id:Ye??null,type:ut,geometry:pt,tags:wt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===ut||"MultiPoint"===ut||"LineString"===ut)oe(Tt,pt);else if("Polygon"===ut)oe(Tt,pt[0]);else if("MultiLineString"===ut)for(const Ye of pt)oe(Tt,Ye);else if("MultiPolygon"===ut)for(const Ye of pt)oe(Tt,Ye[0]);return Tt}function oe(Ye,ut){for(let pt=0;pt<ut.length;pt+=3)Ye.minX=Math.min(Ye.minX,ut[pt]),Ye.minY=Math.min(Ye.minY,ut[pt+1]),Ye.maxX=Math.max(Ye.maxX,ut[pt]),Ye.maxY=Math.max(Ye.maxY,ut[pt+1])}function ie(Ye,ut,pt,wt){if(!ut.geometry)return;const Tt=ut.geometry.coordinates;if(Tt&&0===Tt.length)return;const St=ut.geometry.type,It=Math.pow(pt.tolerance/((1<<pt.maxZoom)*pt.extent),2);let Lt=[],$t=ut.id;if(pt.promoteId?$t=ut.properties[pt.promoteId]:pt.generateId&&($t=wt||0),"Point"===St)ne(Tt,Lt);else if("MultiPoint"===St)for(const Ye of Tt)ne(Ye,Lt);else if("LineString"===St)re(Tt,Lt,It,!1);else if("MultiLineString"===St){if(pt.lineMetrics){for(const pt of Tt)Lt=[],re(pt,Lt,It,!1),Ye.push(se($t,"LineString",Lt,ut.properties));return}ae(Tt,Lt,It,!1)}else if("Polygon"===St)ae(Tt,Lt,It,!0);else{if("MultiPolygon"!==St){if("GeometryCollection"===St){for(const Tt of ut.geometry.geometries)ie(Ye,{id:$t,geometry:Tt,properties:ut.properties},pt,wt);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ye of Tt){const ut=[];ae(Ye,ut,It,!0),Lt.push(ut)}}Ye.push(se($t,St,Lt,ut.properties))}function ne(Ye,ut){ut.push(le(Ye[0]),ce(Ye[1]),0)}function re(Ye,ut,pt,wt){let Tt,St,It=0;for(let pt=0;pt<Ye.length;pt++){const Lt=le(Ye[pt][0]),$t=ce(Ye[pt][1]);ut.push(Lt,$t,0),pt>0&&(It+=wt?(Tt*$t-Lt*St)/2:Math.sqrt(Math.pow(Lt-Tt,2)+Math.pow($t-St,2))),Tt=Lt,St=$t}const Lt=ut.length-3;ut[2]=1,ee(ut,0,Lt,pt),ut[Lt+2]=1,ut.size=Math.abs(It),ut.start=0,ut.end=ut.size}function ae(Ye,ut,pt,wt){for(let Tt=0;Tt<Ye.length;Tt++){const St=[];re(Ye[Tt],St,pt,wt),ut.push(St)}}function le(Ye){return Ye/360+.5}function ce(Ye){const ut=Math.sin(Ye*Math.PI/180),pt=.5-.25*Math.log((1+ut)/(1-ut))/Math.PI;return pt<0?0:pt>1?1:pt}function he(Ye,ut,pt,wt,Tt,St,It,Lt){if(wt/=ut,St>=(pt/=ut)&&It<wt)return Ye;if(It<pt||St>=wt)return null;const $t=[];for(const ut of Ye){const Ye=ut.geometry;let St=ut.type;const It=0===Tt?ut.minX:ut.minY,Xt=0===Tt?ut.maxX:ut.maxY;if(It>=pt&&Xt<wt){$t.push(ut);continue}if(Xt<pt||It>=wt)continue;let Sr=[];if("Point"===St||"MultiPoint"===St)ue(Ye,Sr,pt,wt,Tt);else if("LineString"===St)de(Ye,Sr,pt,wt,Tt,!1,Lt.lineMetrics);else if("MultiLineString"===St)pe(Ye,Sr,pt,wt,Tt,!1);else if("Polygon"===St)pe(Ye,Sr,pt,wt,Tt,!0);else if("MultiPolygon"===St)for(const ut of Ye){const Ye=[];pe(ut,Ye,pt,wt,Tt,!0),Ye.length&&Sr.push(Ye)}if(Sr.length){if(Lt.lineMetrics&&"LineString"===St){for(const Ye of Sr)$t.push(se(ut.id,St,Ye,ut.tags));continue}"LineString"!==St&&"MultiLineString"!==St||(1===Sr.length?(St="LineString",Sr=Sr[0]):St="MultiLineString"),"Point"!==St&&"MultiPoint"!==St||(St=3===Sr.length?"Point":"MultiPoint"),$t.push(se(ut.id,St,Sr,ut.tags))}}return $t.length?$t:null}function ue(Ye,ut,pt,wt,Tt){for(let St=0;St<Ye.length;St+=3){const It=Ye[St+Tt];It>=pt&&It<=wt&&ge(ut,Ye[St],Ye[St+1],Ye[St+2])}}function de(Ye,ut,pt,wt,Tt,St,It){let Lt=fe(Ye);const $t=0===Tt?me:ye;let Xt,Sr,Lr=Ye.start;for(let Qr=0;Qr<Ye.length-3;Qr+=3){const fn=Ye[Qr],xn=Ye[Qr+1],vn=Ye[Qr+2],kn=Ye[Qr+3],Wn=Ye[Qr+4],Xn=0===Tt?fn:xn,Jn=0===Tt?kn:Wn;let Qn=!1;It&&(Xt=Math.sqrt(Math.pow(fn-kn,2)+Math.pow(xn-Wn,2))),Xn<pt?Jn>pt&&(Sr=$t(Lt,fn,xn,kn,Wn,pt),It&&(Lt.start=Lr+Xt*Sr)):Xn>wt?Jn<wt&&(Sr=$t(Lt,fn,xn,kn,Wn,wt),It&&(Lt.start=Lr+Xt*Sr)):ge(Lt,fn,xn,vn),Jn<pt&&Xn>=pt&&(Sr=$t(Lt,fn,xn,kn,Wn,pt),Qn=!0),Jn>wt&&Xn<=wt&&(Sr=$t(Lt,fn,xn,kn,Wn,wt),Qn=!0),!St&&Qn&&(It&&(Lt.end=Lr+Xt*Sr),ut.push(Lt),Lt=fe(Ye)),It&&(Lr+=Xt)}let Qr=Ye.length-3;const fn=Ye[Qr],xn=Ye[Qr+1],vn=0===Tt?fn:xn;vn>=pt&&vn<=wt&&ge(Lt,fn,xn,Ye[Qr+2]),Qr=Lt.length-3,St&&Qr>=3&&(Lt[Qr]!==Lt[0]||Lt[Qr+1]!==Lt[1])&&ge(Lt,Lt[0],Lt[1],Lt[2]),Lt.length&&ut.push(Lt)}function fe(Ye){const ut=[];return ut.size=Ye.size,ut.start=Ye.start,ut.end=Ye.end,ut}function pe(Ye,ut,pt,wt,Tt,St){for(const It of Ye)de(It,ut,pt,wt,Tt,St,!1)}function ge(Ye,ut,pt,wt){Ye.push(ut,pt,wt)}function me(Ye,ut,pt,wt,Tt,St){const It=(St-ut)/(wt-ut);return ge(Ye,St,pt+(Tt-pt)*It,1),It}function ye(Ye,ut,pt,wt,Tt,St){const It=(St-pt)/(Tt-pt);return ge(Ye,ut+(wt-ut)*It,St,1),It}function xe(Ye,ut){const pt=[];for(let wt=0;wt<Ye.length;wt++){const Tt=Ye[wt],St=Tt.type;let It;if("Point"===St||"MultiPoint"===St||"LineString"===St)It=we(Tt.geometry,ut);else if("MultiLineString"===St||"Polygon"===St){It=[];for(const Ye of Tt.geometry)It.push(we(Ye,ut))}else if("MultiPolygon"===St){It=[];for(const Ye of Tt.geometry){const pt=[];for(const wt of Ye)pt.push(we(wt,ut));It.push(pt)}}pt.push(se(Tt.id,St,It,Tt.tags))}return pt}function we(Ye,ut){const pt=[];pt.size=Ye.size,void 0!==Ye.start&&(pt.start=Ye.start,pt.end=Ye.end);for(let wt=0;wt<Ye.length;wt+=3)pt.push(Ye[wt]+ut,Ye[wt+1],Ye[wt+2]);return pt}function Se(Ye,ut){if(Ye.transformed)return Ye;const pt=1<<Ye.z,wt=Ye.x,Tt=Ye.y;for(const St of Ye.features){const Ye=St.geometry,It=St.type;if(St.geometry=[],1===It)for(let It=0;It<Ye.length;It+=2)St.geometry.push(be(Ye[It],Ye[It+1],ut,pt,wt,Tt));else for(let It=0;It<Ye.length;It++){const Lt=[];for(let St=0;St<Ye[It].length;St+=2)Lt.push(be(Ye[It][St],Ye[It][St+1],ut,pt,wt,Tt));St.geometry.push(Lt)}}return Ye.transformed=!0,Ye}function be(Ye,ut,pt,wt,Tt,St){return[Math.round(pt*(Ye*wt-Tt)),Math.round(pt*(ut*wt-St))]}function ve(Ye,ut,pt,wt,Tt){const St=ut===Tt.maxZoom?0:Tt.tolerance/((1<<ut)*Tt.extent),It={features:[],numPoints:0,numSimplified:0,numFeatures:Ye.length,source:null,x:pt,y:wt,z:ut,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const ut of Ye)Ie(It,ut,St,Tt);return It}function Ie(Ye,ut,pt,wt){const Tt=ut.geometry,St=ut.type,It=[];if(Ye.minX=Math.min(Ye.minX,ut.minX),Ye.minY=Math.min(Ye.minY,ut.minY),Ye.maxX=Math.max(Ye.maxX,ut.maxX),Ye.maxY=Math.max(Ye.maxY,ut.maxY),"Point"===St||"MultiPoint"===St)for(let ut=0;ut<Tt.length;ut+=3)It.push(Tt[ut],Tt[ut+1]),Ye.numPoints++,Ye.numSimplified++;else if("LineString"===St)Me(It,Tt,Ye,pt,!1,!1);else if("MultiLineString"===St||"Polygon"===St)for(let ut=0;ut<Tt.length;ut++)Me(It,Tt[ut],Ye,pt,"Polygon"===St,0===ut);else if("MultiPolygon"===St)for(let ut=0;ut<Tt.length;ut++){const wt=Tt[ut];for(let ut=0;ut<wt.length;ut++)Me(It,wt[ut],Ye,pt,!0,0===ut)}if(It.length){let pt=ut.tags||null;if("LineString"===St&&wt.lineMetrics){pt={};for(const Ye in ut.tags)pt[Ye]=ut.tags[Ye];pt.mapbox_clip_start=Tt.start/Tt.size,pt.mapbox_clip_end=Tt.end/Tt.size}const Lt={geometry:It,type:"Polygon"===St||"MultiPolygon"===St?3:"LineString"===St||"MultiLineString"===St?2:1,tags:pt};null!==ut.id&&(Lt.id=ut.id),Ye.features.push(Lt)}}function Me(Ye,ut,pt,wt,Tt,St){const It=wt*wt;if(wt>0&&ut.size<(Tt?It:wt))return void(pt.numPoints+=ut.length/3);const Lt=[];for(let Ye=0;Ye<ut.length;Ye+=3)(0===wt||ut[Ye+2]>It)&&(pt.numSimplified++,Lt.push(ut[Ye],ut[Ye+1])),pt.numPoints++;Tt&&function(Ye,ut){let pt=0;for(let ut=0,wt=Ye.length,Tt=wt-2;ut<wt;Tt=ut,ut+=2)pt+=(Ye[ut]-Ye[Tt])*(Ye[ut+1]+Ye[Tt+1]);if(pt>0===ut)for(let ut=0,pt=Ye.length;ut<pt/2;ut+=2){const wt=Ye[ut],Tt=Ye[ut+1];Ye[ut]=Ye[pt-2-ut],Ye[ut+1]=Ye[pt-1-ut],Ye[pt-2-ut]=wt,Ye[pt-1-ut]=Tt}}(Lt,St),Ye.push(Lt)}const Qn={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Te{constructor(Ye,ut){const pt=(ut=this.options=function(Ye,ut){for(const pt in ut)Ye[pt]=ut[pt];return Ye}(Object.create(Qn),ut)).debug;if(pt&&console.time("preprocess data"),ut.maxZoom<0||ut.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(ut.promoteId&&ut.generateId)throw new Error("promoteId and generateId cannot be used together.");let wt=function(Ye,ut){const pt=[];if("FeatureCollection"===Ye.type)for(let wt=0;wt<Ye.features.length;wt++)ie(pt,Ye.features[wt],ut,wt);else ie(pt,"Feature"===Ye.type?Ye:{geometry:Ye},ut);return pt}(Ye,ut);this.tiles={},this.tileCoords=[],pt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",ut.indexMaxZoom,ut.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),wt=function(Ye,ut){const pt=ut.buffer/ut.extent;let wt=Ye;const Tt=he(Ye,1,-1-pt,pt,0,-1,2,ut),St=he(Ye,1,1-pt,2+pt,0,-1,2,ut);return(Tt||St)&&(wt=he(Ye,1,-pt,1+pt,0,-1,2,ut)||[],Tt&&(wt=xe(Tt,1).concat(wt)),St&&(wt=wt.concat(xe(St,-1)))),wt}(wt,ut),wt.length&&this.splitTile(wt,0,0,0),pt&&(wt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(Ye,ut,pt,wt,Tt,St,It){const Lt=[Ye,ut,pt,wt],$t=this.options,Xt=$t.debug;for(;Lt.length;){wt=Lt.pop(),pt=Lt.pop(),ut=Lt.pop(),Ye=Lt.pop();const Sr=1<<ut,Lr=Pe(ut,pt,wt);let Qr=this.tiles[Lr];if(!Qr&&(Xt>1&&console.time("creation"),Qr=this.tiles[Lr]=ve(Ye,ut,pt,wt,$t),this.tileCoords.push({z:ut,x:pt,y:wt}),Xt)){Xt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",ut,pt,wt,Qr.numFeatures,Qr.numPoints,Qr.numSimplified),console.timeEnd("creation"));const Ye=`z${ut}`;this.stats[Ye]=(this.stats[Ye]||0)+1,this.total++}if(Qr.source=Ye,null==Tt){if(ut===$t.indexMaxZoom||Qr.numPoints<=$t.indexMaxPoints)continue}else{if(ut===$t.maxZoom||ut===Tt)continue;if(null!=Tt){const Ye=Tt-ut;if(pt!==St>>Ye||wt!==It>>Ye)continue}}if(Qr.source=null,0===Ye.length)continue;Xt>1&&console.time("clipping");const fn=.5*$t.buffer/$t.extent,xn=.5-fn,vn=.5+fn,kn=1+fn;let Wn=null,Xn=null,Jn=null,Qn=null,ko=he(Ye,Sr,pt-fn,pt+vn,0,Qr.minX,Qr.maxX,$t),Fo=he(Ye,Sr,pt+xn,pt+kn,0,Qr.minX,Qr.maxX,$t);Ye=null,ko&&(Wn=he(ko,Sr,wt-fn,wt+vn,1,Qr.minY,Qr.maxY,$t),Xn=he(ko,Sr,wt+xn,wt+kn,1,Qr.minY,Qr.maxY,$t),ko=null),Fo&&(Jn=he(Fo,Sr,wt-fn,wt+vn,1,Qr.minY,Qr.maxY,$t),Qn=he(Fo,Sr,wt+xn,wt+kn,1,Qr.minY,Qr.maxY,$t),Fo=null),Xt>1&&console.timeEnd("clipping"),Lt.push(Wn||[],ut+1,2*pt,2*wt),Lt.push(Xn||[],ut+1,2*pt,2*wt+1),Lt.push(Jn||[],ut+1,2*pt+1,2*wt),Lt.push(Qn||[],ut+1,2*pt+1,2*wt+1)}}getTile(Ye,ut,pt){Ye=+Ye,ut=+ut,pt=+pt;const wt=this.options,{extent:Tt,debug:St}=wt;if(Ye<0||Ye>24)return null;const It=1<<Ye,Lt=Pe(Ye,ut=ut+It&It-1,pt);if(this.tiles[Lt])return Se(this.tiles[Lt],Tt);St>1&&console.log("drilling down to z%d-%d-%d",Ye,ut,pt);let $t,Xt=Ye,Sr=ut,Lr=pt;for(;!$t&&Xt>0;)Xt--,Sr>>=1,Lr>>=1,$t=this.tiles[Pe(Xt,Sr,Lr)];return $t&&$t.source?(St>1&&(console.log("found parent tile z%d-%d-%d",Xt,Sr,Lr),console.time("drilling down")),this.splitTile($t.source,Xt,Sr,Lr,Ye,ut,pt),St>1&&console.timeEnd("drilling down"),this.tiles[Lt]?Se(this.tiles[Lt],Tt):null):null}}function Pe(Ye,ut,pt){return 32*((1<<Ye)*pt+ut)+Ye}function Ce(Ye,pt){const wt=Ye.tileID.canonical;if(!(this||ut)._geoJSONIndex)return pt(null,null);const Tt=(this||ut)._geoJSONIndex.getTile(wt.z,wt.x,wt.y);if(!Tt)return pt(null,null);const It=new St(Tt.features);let Lt=fn(It);0===Lt.byteOffset&&Lt.byteLength===Lt.buffer.byteLength||(Lt=new Uint8Array(Lt)),pt(null,{vectorTile:It,rawData:Lt.buffer})}class _e extends c{constructor(Ye,ut,pt,wt,Tt,St){super(Ye,ut,pt,wt,Ce,St),Tt&&(this.loadGeoJSON=Tt),this._dynamicIndex=new m}loadData(ut,pt){const wt=ut&&ut.request,Tt=wt&&wt.collectResourceTiming;this.loadGeoJSON(ut,((St,It)=>{if(St||!It)return pt(St);if("object"!=typeof It)return pt(new Error(`Input data given to '${ut.source}' is not a valid GeoJSON object.`));{try{if(ut.filter){const pt=Ye.y(ut.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===pt.result)throw new Error(pt.value.map((Ye=>`${Ye.key}: ${Ye.message}`)).join(", "));It.features=It.features.filter((Ye=>pt.value.evaluate({zoom:0},Ye)))}ut.dynamic?("Feature"===It.type&&(It={type:"FeatureCollection",features:[It]}),ut.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(It.features,this.loaded),ut.cluster&&(It.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=ut.cluster?new $(function({superclusterOptions:ut,clusterProperties:pt}){if(!pt||!ut)return ut;const wt={},Tt={},St={accumulated:null,zoom:0},It={properties:null},Lt=Object.keys(pt);for(const ut of Lt){const[St,It]=pt[ut],Lt=Ye.y(It),$t=Ye.y("string"==typeof St?[St,["accumulated"],["get",ut]]:St);wt[ut]=Lt.value,Tt[ut]=$t.value}return ut.map=Ye=>{It.properties=Ye;const ut={};for(const Ye of Lt)ut[Ye]=wt[Ye].evaluate(St,It);return ut},ut.reduce=(Ye,ut)=>{It.properties=ut;for(const ut of Lt)St.accumulated=Ye[ut],Ye[ut]=Tt[ut].evaluate(St,It)},ut}(ut)).load(It.features):ut.dynamic?this._dynamicIndex:function(Ye,ut){return new Te(Ye,ut)}(It,ut.geojsonVtOptions)}catch(Ye){return pt(Ye)}const St={};if(Tt){const Ye=t(wt);Ye&&(St.resourceTiming={},St.resourceTiming[ut.source]=JSON.parse(JSON.stringify(Ye)))}pt(null,St)}}))}reloadTile(Ye,ut){const pt=this.loaded;return pt&&pt[Ye.uid]?Ye.partial?ut(null,void 0):super.reloadTile(Ye,ut):this.loadTile(Ye,ut)}loadGeoJSON(ut,pt){if(ut.request)Ye.g(ut.request,pt);else{if("string"!=typeof ut.data)return pt(new Error(`Input data given to '${ut.source}' is not a valid GeoJSON object.`));try{return pt(null,JSON.parse(ut.data))}catch(Ye){return pt(new Error(`Input data given to '${ut.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(Ye,ut){try{ut(null,this._geoJSONIndex.getClusterExpansionZoom(Ye.clusterId))}catch(Ye){ut(Ye)}}getClusterChildren(Ye,ut){try{ut(null,this._geoJSONIndex.getChildren(Ye.clusterId))}catch(Ye){ut(Ye)}}getClusterLeaves(Ye,ut){try{ut(null,this._geoJSONIndex.getLeaves(Ye.clusterId,Ye.limit,Ye.offset))}catch(Ye){ut(Ye)}}}class Le{constructor(ut,pt){this.tileID=new Ye.aL(ut.tileID.overscaledZ,ut.tileID.wrap,ut.tileID.canonical.z,ut.tileID.canonical.x,ut.tileID.canonical.y),this.tileZoom=ut.tileZoom,this.uid=ut.uid,this.zoom=ut.zoom,this.canonical=ut.tileID.canonical,this.pixelRatio=ut.pixelRatio,this.tileSize=ut.tileSize,this.source=ut.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=ut.projection,this.brightness=pt}parse(ut,pt,wt,Tt){this.status="parsing";const St=new Ye.aL(wt.tileID.overscaledZ,wt.tileID.wrap,wt.tileID.canonical.z,wt.tileID.canonical.x,wt.tileID.canonical.y),It={},Lt=pt.familiesBySource[wt.source],$t=new Ye.dN(St,wt.promoteId);return $t.bucketLayerIDs=[],$t.is3DTile=!0,Ye.e3(ut).then((ut=>{if(!ut)return Tt(new Error("Could not parse tile"));const pt=Ye.e4(ut,1/Ye.b5(wt.tileID.canonical)),Xt=ut.json.extensionsUsed&&ut.json.extensionsUsed.includes("MAPBOX_mesh_features")||ut.json.asset.extras&&ut.json.asset.extras.MAPBOX_mesh_features,Sr=ut.json.extensionsUsed&&ut.json.extensionsUsed.includes("EXT_meshopt_compression"),Lr=new Ye.X(this.zoom,{brightness:this.brightness});for(const ut in Lt)for(const wt of Lt[ut]){const ut=wt[0];$t.bucketLayerIDs.push(wt.map((Ye=>Ye.id))),ut.recalculate(Lr,[]);const Tt=new Ye.e5(pt,St,Xt,Sr,this.brightness,$t);Xt||(Tt.needsUpload=!0),It[ut.fqid]=Tt,Tt.evaluate(ut)}this.status="done",Tt(null,{buckets:It,featureIndex:$t})})).catch((Ye=>Tt(new Error(Ye.message))))}}class De{constructor(Ye,ut,pt,wt,Tt,St){this.actor=Ye,this.layerIndex=ut,this.brightness=St,this.loading={},this.loaded={}}loadTile(ut,pt){const wt=ut.uid,Tt=this.loading[wt]=new Le(ut,this.brightness);Ye.e2(ut.request,((Ye,St)=>{const It=!this.loading[wt];return delete this.loading[wt],It||Ye?(Tt.status="done",It||(this.loaded[wt]=Tt),pt(Ye)):St&&0!==St.byteLength?void Tt.parse(St,this.layerIndex,ut,((Ye,ut)=>{Tt.status="done",this.loaded=this.loaded||{},this.loaded[wt]=Tt,Ye||!ut?pt(Ye):pt(null,ut)})):(Tt.status="done",this.loaded[wt]=Tt,pt())}))}reloadTile(Ye,ut){const pt=this.loaded,wt=Ye.uid;if(pt&&pt[wt]){const Tt=pt[wt];Tt.projection=Ye.projection,Tt.brightness=Ye.brightness;const n=(pt,wt)=>{Tt.reloadCallback&&(delete Tt.reloadCallback,this.loadTile(Ye,ut)),ut(pt,wt)};"parsing"===Tt.status?Tt.reloadCallback=n:"done"===Tt.status&&this.loadTile(Ye,ut)}}abortTile(Ye,ut){const pt=Ye.uid;this.loading[pt]&&delete this.loading[pt],ut()}removeTile(Ye,ut){const pt=this.loaded,wt=Ye.uid;pt&&pt[wt]&&delete pt[wt],ut()}}class je{constructor(ut){this.self=ut,this.actor=new Ye.e6(ut,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=Ye.aJ({name:"mercator"}),this.workerSourceTypes={vector:c,geojson:_e,"batched-model":De},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(Ye,ut)=>{if(this.workerSourceTypes[Ye])throw new Error(`Worker source with name "${Ye}" already registered.`);this.workerSourceTypes[Ye]=ut},this.self.registerRTLTextPlugin=ut=>{if(Ye.e7.isParsed())throw new Error("RTL text plugin already registered.");Ye.e7.applyArabicShaping=ut.applyArabicShaping,Ye.e7.processBidirectionalText=ut.processBidirectionalText,Ye.e7.processStyledBidirectionalText=ut.processStyledBidirectionalText}}clearCaches(Ye,ut,pt){delete this.layerIndexes[Ye],delete this.availableImages[Ye],delete this.workerSources[Ye],delete this.demWorkerSources[Ye],delete this.rasterArrayWorkerSource,pt()}checkIfReady(Ye,ut,pt){pt()}setReferrer(Ye,ut){this.referrer=ut}spriteLoaded(ut,{scope:pt,isLoaded:wt}){if(this.isSpriteLoaded[ut]||(this.isSpriteLoaded[ut]={}),this.isSpriteLoaded[ut][pt]=wt,this.workerSources[ut]&&this.workerSources[ut][pt])for(const Tt in this.workerSources[ut][pt]){const St=this.workerSources[ut][pt][Tt];for(const ut in St){const pt=St[ut];pt instanceof c&&(pt.isSpriteLoaded=wt,pt.fire(new Ye.f("isSpriteLoaded")))}}}setImages(Ye,{scope:ut,images:pt},wt){if(this.availableImages[Ye]||(this.availableImages[Ye]={}),this.availableImages[Ye][ut]=pt,this.workerSources[Ye]&&this.workerSources[Ye][ut]){for(const wt in this.workerSources[Ye][ut]){const Tt=this.workerSources[Ye][ut][wt];for(const Ye in Tt)Tt[Ye].availableImages=pt}wt()}else wt()}setProjection(ut,pt){this.projections[ut]=Ye.aJ(pt)}setBrightness(Ye,ut,pt){this.brightness=ut,pt()}setLayers(Ye,ut,pt){this.getLayerIndex(Ye,ut.scope).replace(ut.layers,ut.options),pt()}updateLayers(Ye,ut,pt){this.getLayerIndex(Ye,ut.scope).update(ut.layers,ut.removedIds,ut.options),pt()}loadTile(Ye,ut,pt){ut.projection=this.projections[Ye]||this.defaultProjection,this.getWorkerSource(Ye,ut.type,ut.source,ut.scope).loadTile(ut,pt)}loadDEMTile(Ye,ut,pt){this.getDEMWorkerSource(Ye,ut.source,ut.scope).loadTile(ut,pt)}decodeRasterArray(Ye,ut,pt){this.getRasterArrayWorkerSource().decodeRasterArray(ut,pt)}reloadTile(Ye,ut,pt){ut.projection=this.projections[Ye]||this.defaultProjection,this.getWorkerSource(Ye,ut.type,ut.source,ut.scope).reloadTile(ut,pt)}abortTile(Ye,ut,pt){this.getWorkerSource(Ye,ut.type,ut.source,ut.scope).abortTile(ut,pt)}removeTile(Ye,ut,pt){this.getWorkerSource(Ye,ut.type,ut.source,ut.scope).removeTile(ut,pt)}removeSource(Ye,ut,pt){if(!(this.workerSources[Ye]&&this.workerSources[Ye][ut.scope]&&this.workerSources[Ye][ut.scope][ut.type]&&this.workerSources[Ye][ut.scope][ut.type][ut.source]))return;const wt=this.workerSources[Ye][ut.scope][ut.type][ut.source];delete this.workerSources[Ye][ut.scope][ut.type][ut.source],void 0!==wt.removeSource?wt.removeSource(ut,pt):pt()}loadWorkerSource(Ye,ut,pt){try{this.self.importScripts(ut.url),pt()}catch(Ye){pt(Ye.toString())}}syncRTLPluginState(ut,pt,wt){try{Ye.e7.setState(pt);const ut=Ye.e7.getPluginURL();if(Ye.e7.isLoaded()&&!Ye.e7.isParsed()&&null!=ut){this.self.importScripts(ut);const pt=Ye.e7.isParsed();wt(pt?void 0:new Error(`RTL Text Plugin failed to import scripts from ${ut}`),pt)}}catch(Ye){wt(Ye.toString())}}setDracoUrl(Ye,ut){this.dracoUrl=ut}getAvailableImages(Ye,ut){this.availableImages[Ye]||(this.availableImages[Ye]={});let pt=this.availableImages[Ye][ut];return pt||(pt=[]),pt}getLayerIndex(Ye,ut){this.layerIndexes[Ye]||(this.layerIndexes[Ye]={});let pt=this.layerIndexes[Ye][ut];return pt||(pt=this.layerIndexes[Ye][ut]=new i,pt.scope=ut),pt}getWorkerSource(Ye,ut,pt,wt){return this.workerSources[Ye]||(this.workerSources[Ye]={}),this.workerSources[Ye][wt]||(this.workerSources[Ye][wt]={}),this.workerSources[Ye][wt][ut]||(this.workerSources[Ye][wt][ut]={}),this.isSpriteLoaded[Ye]||(this.isSpriteLoaded[Ye]={}),this.workerSources[Ye][wt][ut][pt]||(this.workerSources[Ye][wt][ut][pt]=new this.workerSourceTypes[ut]({send:(ut,pt,wt,Tt,St,It)=>{this.actor.send(ut,pt,wt,Ye,St,It)},scheduler:this.actor.scheduler},this.getLayerIndex(Ye,wt),this.getAvailableImages(Ye,wt),this.isSpriteLoaded[Ye][wt],void 0,this.brightness)),this.workerSources[Ye][wt][ut][pt]}getDEMWorkerSource(Ye,ut,pt){return this.demWorkerSources[Ye]||(this.demWorkerSources[Ye]={}),this.demWorkerSources[Ye][pt]||(this.demWorkerSources[Ye][pt]={}),this.demWorkerSources[Ye][pt][ut]||(this.demWorkerSources[Ye][pt][ut]=new h),this.demWorkerSources[Ye][pt][ut]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new u),this.rasterArrayWorkerSource}enforceCacheSizeLimit(ut,pt){Ye.e8(pt)}getWorkerPerformanceMetrics(Ye,ut,pt){pt(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new je(self)),je}));define(["./shared"],(function(Ye){function t(Ye,ut){if(Array.isArray(Ye)){if(!Array.isArray(ut)||Ye.length!==ut.length)return!1;for(let pt=0;pt<Ye.length;pt++)if(!t(Ye[pt],ut[pt]))return!1;return!0}if("object"==typeof Ye&&null!==Ye&&null!==ut){if("object"!=typeof ut)return!1;if(Object.keys(Ye).length!==Object.keys(ut).length)return!1;for(const pt in Ye)if(!t(Ye[pt],ut[pt]))return!1;return!0}return Ye===ut}var ut=o;function o(Ye){return!function(Ye){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var Ye,ut,pt=new Blob([""],{type:"text/javascript"}),wt=URL.createObjectURL(pt);try{ut=new Worker(wt),Ye=!0}catch(ut){Ye=!1}return ut&&ut.terminate(),URL.revokeObjectURL(wt),Ye}()?function(){var Ye=document.createElement("canvas");Ye.width=Ye.height=1;var ut=Ye.getContext("2d");if(!ut)return!1;var pt=ut.getImageData(0,0,1,1);return pt&&pt.width===Ye.width}()?(void 0===pt[ut=Ye&&Ye.failIfMajorPerformanceCaveat]&&(pt[ut]=function(Ye){var ut,pt=function(Ye){var ut=document.createElement("canvas"),pt=Object.create(o.webGLContextAttributes);return pt.failIfMajorPerformanceCaveat=Ye,ut.getContext("webgl2",pt)}(Ye);if(!pt)return!1;try{ut=pt.createShader(pt.VERTEX_SHADER)}catch(Ye){return!1}return!(!ut||pt.isContextLost())&&(pt.shaderSource(ut,"void main() {}"),pt.compileShader(ut),!0===pt.getShaderParameter(ut,pt.COMPILE_STATUS))}(ut)),pt[ut]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var ut}(Ye)}var pt={};function a(Ye,ut,pt){const wt=document.createElement(Ye);return null!=ut&&(wt.className=ut),pt&&pt.appendChild(wt),wt}function n(Ye,ut,pt){const wt=document.createElementNS("http://www.w3.org/2000/svg",Ye);for(const Ye of Object.keys(ut))wt.setAttributeNS(null,Ye,String(ut[Ye]));return pt&&pt.appendChild(wt),wt}o.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const wt="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,Tt=wt&&void 0!==wt.userSelect?"userSelect":"WebkitUserSelect";let St;function h(){wt&&Tt&&(St=wt[Tt],wt[Tt]="none")}function _(){wt&&Tt&&(wt[Tt]=St)}function u(Ye){Ye.preventDefault(),Ye.stopPropagation(),window.removeEventListener("click",u,!0)}function d(){window.addEventListener("click",u,!0),window.setTimeout((()=>{window.removeEventListener("click",u,!0)}),0)}function p(Ye,ut){const pt=Ye.getBoundingClientRect();return g(Ye,pt,ut)}function f(Ye,ut){const pt=Ye.getBoundingClientRect(),wt=[];for(let Tt=0;Tt<ut.length;Tt++)wt.push(g(Ye,pt,ut[Tt]));return wt}function m(Ye){return void 0!==window.InstallTrigger&&2===Ye.button&&Ye.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:Ye.button}function g(ut,pt,wt){const Tt=ut.offsetWidth===pt.width?1:ut.offsetWidth/pt.width;return new Ye.P((wt.clientX-pt.left)*Tt,(wt.clientY-pt.top)*Tt)}class v{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(Ye,ut){this._updatedSourceCaches[Ye]=ut,this.setDirty()}discardSourceCacheUpdate(Ye){delete this._updatedSourceCaches[Ye]}updateLayer(Ye){const ut=Ye.scope;this._updatedLayers[ut]=this._updatedLayers[ut]||new Set,this._updatedLayers[ut].add(Ye.id),this.setDirty()}removeLayer(Ye){const ut=Ye.scope;this._removedLayers[ut]=this._removedLayers[ut]||{},this._updatedLayers[ut]=this._updatedLayers[ut]||new Set,this._removedLayers[ut][Ye.id]=Ye,this._updatedLayers[ut].delete(Ye.id),this._updatedPaintProps.delete(Ye.fqid),this.setDirty()}getRemovedLayer(Ye){return this._removedLayers[Ye.scope]?this._removedLayers[Ye.scope][Ye.id]:null}discardLayerRemoval(Ye){this._removedLayers[Ye.scope]&&delete this._removedLayers[Ye.scope][Ye.id]}getLayerUpdatesByScope(){const Ye={};for(const ut in this._updatedLayers)Ye[ut]=Ye[ut]||{},Ye[ut].updatedIds=Array.from(this._updatedLayers[ut].values());for(const ut in this._removedLayers)Ye[ut]=Ye[ut]||{},Ye[ut].removedIds=Object.keys(this._removedLayers[ut]);return Ye}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(Ye){this._updatedPaintProps.add(Ye.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(Ye){this._updatedImages.add(Ye),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}const It={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class y{constructor(Ye,ut,pt,wt,Tt,St){this.length=ut.length,this.attributes=pt,this.itemSize=ut.bytesPerElement,this.dynamicDraw=wt,this.instanceCount=St,this.context=Ye;const It=Ye.gl;this.buffer=It.createBuffer(),Ye.bindVertexBuffer.set(this.buffer),It.bufferData(It.ARRAY_BUFFER,ut.arrayBuffer,this.dynamicDraw?It.DYNAMIC_DRAW:It.STATIC_DRAW),this.dynamicDraw||Tt||ut.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(Ye){const ut=this.context.gl;this.bind(),ut.bufferSubData(ut.ARRAY_BUFFER,0,Ye.arrayBuffer)}enableAttributes(Ye,ut){for(let pt=0;pt<this.attributes.length;pt++){const wt=ut.attributes[this.attributes[pt].name];void 0!==wt&&Ye.enableVertexAttribArray(wt)}}setVertexAttribPointers(Ye,ut,pt){for(let wt=0;wt<this.attributes.length;wt++){const Tt=this.attributes[wt],St=ut.attributes[Tt.name];void 0!==St&&Ye.vertexAttribPointer(St,Tt.components,Ye[It[Tt.type]],!1,this.itemSize,Tt.offset+this.itemSize*(pt||0))}}setVertexAttribDivisor(Ye,ut,pt){for(let wt=0;wt<this.attributes.length;wt++){const Tt=ut.attributes[this.attributes[wt].name];void 0!==Tt&&this.instanceCount&&this.instanceCount>0&&Ye.vertexAttribDivisor(Tt,pt)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class b{constructor(Ye){this.gl=Ye.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(Ye){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class w extends b{getDefault(){return Ye.C.transparent}set(Ye){const ut=this.current;(Ye.r!==ut.r||Ye.g!==ut.g||Ye.b!==ut.b||Ye.a!==ut.a||this.dirty)&&(this.gl.clearColor(Ye.r,Ye.g,Ye.b,Ye.a),this.current=Ye,this.dirty=!1)}}class T extends b{getDefault(){return 1}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.clearDepth(Ye),this.current=Ye,this.dirty=!1)}}class E extends b{getDefault(){return 0}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.clearStencil(Ye),this.current=Ye,this.dirty=!1)}}class C extends b{getDefault(){return[!0,!0,!0,!0]}set(Ye){const ut=this.current;(Ye[0]!==ut[0]||Ye[1]!==ut[1]||Ye[2]!==ut[2]||Ye[3]!==ut[3]||this.dirty)&&(this.gl.colorMask(Ye[0],Ye[1],Ye[2],Ye[3]),this.current=Ye,this.dirty=!1)}}class S extends b{getDefault(){return!0}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.depthMask(Ye),this.current=Ye,this.dirty=!1)}}class I extends b{getDefault(){return 255}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.stencilMask(Ye),this.current=Ye,this.dirty=!1)}}class L extends b{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(Ye){const ut=this.current;(Ye.func!==ut.func||Ye.ref!==ut.ref||Ye.mask!==ut.mask||this.dirty)&&(this.gl.stencilFunc(Ye.func,Ye.ref,Ye.mask),this.current=Ye,this.dirty=!1)}}class P extends b{getDefault(){const Ye=this.gl;return[Ye.KEEP,Ye.KEEP,Ye.KEEP]}set(Ye){const ut=this.current;(Ye[0]!==ut[0]||Ye[1]!==ut[1]||Ye[2]!==ut[2]||this.dirty)&&(this.gl.stencilOp(Ye[0],Ye[1],Ye[2]),this.current=Ye,this.dirty=!1)}}class A extends b{getDefault(){return!1}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;Ye?ut.enable(ut.STENCIL_TEST):ut.disable(ut.STENCIL_TEST),this.current=Ye,this.dirty=!1}}class R extends b{getDefault(){return[0,1]}set(Ye){const ut=this.current;(Ye[0]!==ut[0]||Ye[1]!==ut[1]||this.dirty)&&(this.gl.depthRange(Ye[0],Ye[1]),this.current=Ye,this.dirty=!1)}}class D extends b{getDefault(){return!1}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;Ye?ut.enable(ut.DEPTH_TEST):ut.disable(ut.DEPTH_TEST),this.current=Ye,this.dirty=!1}}class M extends b{getDefault(){return this.gl.LESS}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.depthFunc(Ye),this.current=Ye,this.dirty=!1)}}class z extends b{getDefault(){return!1}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;Ye?ut.enable(ut.BLEND):ut.disable(ut.BLEND),this.current=Ye,this.dirty=!1}}class O extends b{getDefault(){const Ye=this.gl;return[Ye.ONE,Ye.ZERO,Ye.ONE,Ye.ZERO]}set(Ye){const ut=this.current;(Ye[0]!==ut[0]||Ye[1]!==ut[1]||Ye[2]!==ut[2]||Ye[3]!==ut[3]||this.dirty)&&(this.gl.blendFuncSeparate(Ye[0],Ye[1],Ye[2],Ye[3]),this.current=Ye,this.dirty=!1)}}class F extends b{getDefault(){return Ye.C.transparent}set(Ye){const ut=this.current;(Ye.r!==ut.r||Ye.g!==ut.g||Ye.b!==ut.b||Ye.a!==ut.a||this.dirty)&&(this.gl.blendColor(Ye.r,Ye.g,Ye.b,Ye.a),this.current=Ye,this.dirty=!1)}}class B extends b{getDefault(){return this.gl.FUNC_ADD}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(Ye,Ye),this.current=Ye,this.dirty=!1)}}class k extends b{getDefault(){return!1}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;Ye?ut.enable(ut.CULL_FACE):ut.disable(ut.CULL_FACE),this.current=Ye,this.dirty=!1}}class N extends b{getDefault(){return this.gl.BACK}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.cullFace(Ye),this.current=Ye,this.dirty=!1)}}class U extends b{getDefault(){return this.gl.CCW}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.frontFace(Ye),this.current=Ye,this.dirty=!1)}}let Lt=class extends b{getDefault(){return null}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.useProgram(Ye),this.current=Ye,this.dirty=!1)}};class j extends b{getDefault(){return this.gl.TEXTURE0}set(Ye){(Ye!==this.current||this.dirty)&&(this.gl.activeTexture(Ye),this.current=Ye,this.dirty=!1)}}class V extends b{getDefault(){const Ye=this.gl;return[0,0,Ye.drawingBufferWidth,Ye.drawingBufferHeight]}set(Ye){const ut=this.current;(Ye[0]!==ut[0]||Ye[1]!==ut[1]||Ye[2]!==ut[2]||Ye[3]!==ut[3]||this.dirty)&&(this.gl.viewport(Ye[0],Ye[1],Ye[2],Ye[3]),this.current=Ye,this.dirty=!1)}}class W extends b{getDefault(){return null}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;ut.bindFramebuffer(ut.FRAMEBUFFER,Ye),this.current=Ye,this.dirty=!1}}class Z extends b{getDefault(){return null}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;ut.bindRenderbuffer(ut.RENDERBUFFER,Ye),this.current=Ye,this.dirty=!1}}class q extends b{getDefault(){return null}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;ut.bindTexture(ut.TEXTURE_2D,Ye),this.current=Ye,this.dirty=!1}}class H extends b{getDefault(){return null}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;ut.bindBuffer(ut.ARRAY_BUFFER,Ye),this.current=Ye,this.dirty=!1}}class $ extends b{getDefault(){return null}set(Ye){const ut=this.gl;ut.bindBuffer(ut.ELEMENT_ARRAY_BUFFER,Ye),this.current=Ye,this.dirty=!1}}class X extends b{getDefault(){return null}set(Ye){this.gl&&(Ye!==this.current||this.dirty)&&(this.gl.bindVertexArray(Ye),this.current=Ye,this.dirty=!1)}}class Y extends b{getDefault(){return 4}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;ut.pixelStorei(ut.UNPACK_ALIGNMENT,Ye),this.current=Ye,this.dirty=!1}}class K extends b{getDefault(){return!1}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;ut.pixelStorei(ut.UNPACK_PREMULTIPLY_ALPHA_WEBGL,Ye),this.current=Ye,this.dirty=!1}}class Q extends b{getDefault(){return!1}set(Ye){if(Ye===this.current&&!this.dirty)return;const ut=this.gl;ut.pixelStorei(ut.UNPACK_FLIP_Y_WEBGL,Ye),this.current=Ye,this.dirty=!1}}class J extends b{constructor(Ye,ut){super(Ye),this.context=Ye,this.parent=ut}getDefault(){return null}}class ee extends J{setDirty(){this.dirty=!0}set(Ye){if(Ye===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const ut=this.gl;ut.framebufferTexture2D(ut.FRAMEBUFFER,ut.COLOR_ATTACHMENT0,ut.TEXTURE_2D,Ye,0),this.current=Ye,this.dirty=!1}}class te extends J{attachment(){return this.gl.DEPTH_ATTACHMENT}set(Ye){if(Ye===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const ut=this.gl;ut.framebufferRenderbuffer(ut.FRAMEBUFFER,this.attachment(),ut.RENDERBUFFER,Ye),this.current=Ye,this.dirty=!1}}class ie extends J{attachment(){return this.gl.DEPTH_ATTACHMENT}set(Ye){if(Ye===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const ut=this.gl;ut.framebufferTexture2D(ut.FRAMEBUFFER,this.attachment(),ut.TEXTURE_2D,Ye,0),this.current=Ye,this.dirty=!1}}class oe extends te{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class re{constructor(Ye,ut,pt,wt,Tt){this.context=Ye,this.width=ut,this.height=pt;const St=this.framebuffer=Ye.gl.createFramebuffer();wt&&(this.colorAttachment=new ee(Ye,St)),Tt&&(this.depthAttachmentType=Tt,this.depthAttachment="renderbuffer"===Tt?new te(Ye,St):new ie(Ye,St))}destroy(){const Ye=this.context.gl;if(this.colorAttachment){const ut=this.colorAttachment.get();ut&&Ye.deleteTexture(ut)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const ut=this.depthAttachment.get();ut&&Ye.deleteRenderbuffer(ut)}else{const ut=this.depthAttachment.get();ut&&Ye.deleteTexture(ut)}Ye.deleteFramebuffer(this.framebuffer)}}class ae{constructor(Ye,ut){this.gl=Ye,this.clearColor=new w(this),this.clearDepth=new T(this),this.clearStencil=new E(this),this.colorMask=new C(this),this.depthMask=new S(this),this.stencilMask=new I(this),this.stencilFunc=new L(this),this.stencilOp=new P(this),this.stencilTest=new A(this),this.depthRange=new R(this),this.depthTest=new D(this),this.depthFunc=new M(this),this.blend=new z(this),this.blendFunc=new O(this),this.blendColor=new F(this),this.blendEquation=new B(this),this.cullFace=new k(this),this.cullFaceSide=new N(this),this.frontFace=new U(this),this.program=new Lt(this),this.activeTexture=new j(this),this.viewport=new V(this),this.bindFramebuffer=new W(this),this.bindRenderbuffer=new Z(this),this.bindTexture=new q(this),this.bindVertexBuffer=new H(this),this.bindElementBuffer=new $(this),this.bindVertexArrayOES=new X(this),this.pixelStoreUnpack=new Y(this),this.pixelStoreUnpackPremultiplyAlpha=new K(this),this.pixelStoreUnpackFlipY=new Q(this),this.options=ut?{...ut}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=Ye.getExtension("EXT_texture_filter_anisotropic")||Ye.getExtension("MOZ_EXT_texture_filter_anisotropic")||Ye.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=Ye.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=Ye.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=Ye.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=Ye.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=Ye.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=Ye.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=Ye.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=Ye.getParameter(Ye.MAX_TEXTURE_SIZE),this.maxPointSize=Ye.getParameter(Ye.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(ut,pt,wt){return new Ye.I(this,ut,pt,wt)}createVertexBuffer(Ye,ut,pt,wt,Tt){return new y(this,Ye,ut,pt,wt,Tt)}createRenderbuffer(Ye,ut,pt){const wt=this.gl,Tt=wt.createRenderbuffer();return this.bindRenderbuffer.set(Tt),wt.renderbufferStorage(wt.RENDERBUFFER,Ye,ut,pt),this.bindRenderbuffer.set(null),Tt}createFramebuffer(Ye,ut,pt,wt){return new re(this,Ye,ut,pt,wt)}clear({color:Ye,depth:ut,stencil:pt,colorMask:wt}){const Tt=this.gl;let St=0;Ye&&(St|=Tt.COLOR_BUFFER_BIT,this.clearColor.set(Ye),this.colorMask.set(wt||[!0,!0,!0,!0])),void 0!==ut&&(St|=Tt.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(ut),this.depthMask.set(!0)),void 0!==pt&&(St|=Tt.STENCIL_BUFFER_BIT,this.clearStencil.set(pt),this.stencilMask.set(255)),Tt.clear(St)}setCullFace(Ye){!1===Ye.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(Ye.mode),this.frontFace.set(Ye.frontFace))}setDepthMode(Ye){Ye.func!==this.gl.ALWAYS||Ye.mask?(this.depthTest.set(!0),this.depthFunc.set(Ye.func),this.depthMask.set(Ye.mask),this.depthRange.set(Ye.range)):this.depthTest.set(!1)}setStencilMode(Ye){Ye.test.func!==this.gl.ALWAYS||Ye.mask?(this.stencilTest.set(!0),this.stencilMask.set(Ye.mask),this.stencilOp.set([Ye.fail,Ye.depthFail,Ye.pass]),this.stencilFunc.set({func:Ye.test.func,ref:Ye.ref,mask:Ye.test.mask})):this.stencilTest.set(!1)}setColorMode(ut){t(ut.blendFunction,Ye.a.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(ut.blendFunction),this.blendColor.set(ut.blendColor),ut.blendEquation?this.blendEquation.set(ut.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(ut.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}class ne{constructor(Ye){this._gl=Ye.gl,this._query=this._gl.createQuery(),this._isFree=!0}begin(){this._gl.beginQuery(this._gl.ANY_SAMPLES_PASSED,this._query),this._isFree=!1}end(){this._gl.endQuery(this._gl.ANY_SAMPLES_PASSED)}isResultAvailable(){return this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT_AVAILABLE)}consumeResult(){const Ye=this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT);return this._isFree=!0,Ye}isFree(){return this._isFree}destroy(){this._gl.deleteQuery(this._query)}}class se{constructor(Ye){this.useOcclusionQueries=!0,this.visualizeOcclusions="none",this.occlusionQueryFrameWindow=5,this.occluderSize=32,this.fadeSpeed=7,this.depthOffset=-1e-4,Ye.registerParameter(this,["Symbols"],"useOcclusionQueries"),Ye.registerParameter(this,["Symbols"],"visualizeOcclusions",{options:{none:"none",zPass:"zPass",zTest:"zTest"}}),Ye.registerParameter(this,["Symbols"],"occlusionQueryFrameWindow",{min:1,max:30,step:1}),Ye.registerParameter(this,["Symbols"],"occluderSize",{min:1,max:100,step:1}),Ye.registerParameter(this,["Symbols"],"fadeSpeed",{min:.1,max:50,step:.1}),Ye.registerParameter(this,["Symbols"],"depthOffset",{min:-.001,max:0,step:1e-4})}}class le{constructor(ut,pt,wt,Tt){const St={width:wt[0],height:wt[1],data:null},It=ut.gl;this.targetColorTexture=new Ye.T(ut,St,It.RGBA,{useMipmap:!1}),this.backgroundColorTexture=new Ye.T(ut,St,It.RGBA,{useMipmap:!1}),this.context=ut,this.updateParticleTexture(pt,Tt),this.lastInvalidatedAt=0}updateParticleTexture(ut,pt){if(this.particleTextureDimension===pt.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const wt=this.context.gl,Tt=pt.width*pt.height;this.particleTexture0=new Ye.T(this.context,pt,wt.RGBA,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new Ye.T(this.context,pt,wt.RGBA,{premultiply:!1,useMipmap:!1});const St=new Ye.S;St.reserve(Tt);for(let Ye=0;Ye<Tt;Ye++)St.emplaceBack(Ye);this.particleIndexBuffer=this.context.createVertexBuffer(St,Ye.p.members,!0),this.particleSegment=Ye.b.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=pt.width}update(ut){return!(this.lastInvalidatedAt<ut&&(this.lastInvalidatedAt=Ye.e.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}class ce extends Ye.E{constructor(Ye){super(),this.requestManager=Ye,this.models={"":{}},this.numModelsLoading={}}loadModel(ut,pt){return Ye.l(this.requestManager.transformRequest(pt,Ye.R.Model).url).then((pt=>{if(!pt)return;const wt=Ye.c(pt),Tt=new Ye.M(ut,void 0,void 0,wt);return Tt.computeBoundsAndApplyParent(),Tt})).catch((wt=>{if(wt&&404===wt.status)return null;this.fire(new Ye.d(new Error(`Could not load model ${ut} from ${pt}: ${wt.message}`)))}))}load(ut,pt){this.models[pt]||(this.models[pt]={});const wt=Object.keys(ut);this.numModelsLoading[pt]=(this.numModelsLoading[pt]||0)+wt.length;const Tt=[];for(const Ye of wt)Tt.push(this.loadModel(Ye,ut[Ye]));Promise.allSettled(Tt).then((ut=>{for(let Ye=0;Ye<ut.length;Ye++){const{status:Tt,value:St}=ut[Ye];"fulfilled"===Tt&&St&&(this.models[pt][wt[Ye]]={model:St,numReferences:1})}this.numModelsLoading[pt]-=wt.length,this.fire(new Ye.f("data",{dataType:"style"}))})).catch((ut=>{this.fire(new Ye.d(new Error(`Could not load models: ${ut.message}`)))}))}isLoaded(){for(const Ye in this.numModelsLoading)if(this.numModelsLoading[Ye]>0)return!1;return!0}hasModel(Ye,ut){return!!this.getModel(Ye,ut)}getModel(Ye,ut){return this.models[ut]||(this.models[ut]={}),this.models[ut][Ye]?this.models[ut][Ye].model:void 0}addModel(Ye,ut,pt){this.models[pt]||(this.models[pt]={}),this.hasModel(Ye,pt)&&this.models[pt][Ye].numReferences++,this.load({[Ye]:this.requestManager.normalizeModelURL(ut)},pt)}addModels(Ye,ut){this.models[ut]||(this.models[ut]={});const pt={};for(const wt in Ye)this.models[ut][wt]={},pt[wt]=this.requestManager.normalizeModelURL(Ye[wt]);this.load(pt,ut)}addModelsFromBucket(Ye,ut){this.models[ut]||(this.models[ut]={});const pt={};for(const wt of Ye)this.hasModel(wt,ut)?this.models[ut][wt].numReferences++:pt[wt]=this.requestManager.normalizeModelURL(wt);this.load(pt,ut)}removeModel(Ye,ut){if(this.models[ut]&&this.models[ut][Ye]&&(this.models[ut][Ye].numReferences--,0===this.models[ut][Ye].numReferences)){const pt=this.models[ut][Ye].model;delete this.models[ut][Ye],pt.destroy()}}listModels(Ye){return this.models[Ye]||(this.models[Ye]={}),Object.keys(this.models[Ye])}upload(Ye,ut){this.models[ut]||(this.models[ut]={});for(const pt in this.models[ut])this.models[ut][pt].model&&this.models[ut][pt].model.upload(Ye.context)}}function he(Ye){const{userImage:ut}=Ye;return!!(ut&&ut.render&&ut.render())&&(Ye.data.replace(new Uint8Array(ut.data.buffer)),!0)}class _e extends Ye.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(ut){this.images[ut]={},this.loaded[ut]=!1,this.updatedImages[ut]={},this.patterns[ut]={},this.callbackDispatchedThisFrame[ut]={},this.atlasImage[ut]=new Ye.i({width:1,height:1})}isLoaded(){for(const Ye in this.loaded)if(!this.loaded[Ye])return!1;return!0}setLoaded(Ye,ut){if(this.loaded[ut]!==Ye&&(this.loaded[ut]=Ye,Ye)){for(const{ids:Ye,callback:pt}of this.requestors)this._notify(Ye,ut,pt);this.requestors=[]}}hasImage(Ye,ut){return!!this.getImage(Ye,ut)}getImage(Ye,ut){return this.images[ut][Ye]}addImage(Ye,ut,pt){this._validate(Ye,pt)&&(this.images[ut][Ye]=pt)}_validate(ut,pt){let wt=!0;return this._validateStretch(pt.stretchX,pt.data&&pt.data.width)||(this.fire(new Ye.d(new Error(`Image "${ut}" has invalid "stretchX" value`))),wt=!1),this._validateStretch(pt.stretchY,pt.data&&pt.data.height)||(this.fire(new Ye.d(new Error(`Image "${ut}" has invalid "stretchY" value`))),wt=!1),this._validateContent(pt.content,pt)||(this.fire(new Ye.d(new Error(`Image "${ut}" has invalid "content" value`))),wt=!1),wt}_validateStretch(Ye,ut){if(!Ye)return!0;let pt=0;for(const wt of Ye){if(wt[0]<pt||wt[1]<wt[0]||ut<wt[1])return!1;pt=wt[1]}return!0}_validateContent(Ye,ut){return!(Ye&&(4!==Ye.length||Ye[0]<0||ut.data.width<Ye[0]||Ye[1]<0||ut.data.height<Ye[1]||Ye[2]<0||ut.data.width<Ye[2]||Ye[3]<0||ut.data.height<Ye[3]||Ye[2]<Ye[0]||Ye[3]<Ye[1]))}updateImage(Ye,ut,pt){pt.version=this.images[ut][Ye].version+1,this.images[ut][Ye]=pt,this.updatedImages[ut][Ye]=!0}removeImage(Ye,ut){const pt=this.images[ut][Ye];delete this.images[ut][Ye],delete this.patterns[ut][Ye],pt.userImage&&pt.userImage.onRemove&&pt.userImage.onRemove()}listImages(Ye){return Object.keys(this.images[Ye])}getImages(Ye,ut,pt){let wt=!0;const Tt=!!this.loaded[ut];if(!Tt)for(const pt of Ye)this.images[ut][pt]||(wt=!1);Tt||wt?this._notify(Ye,ut,pt):this.requestors.push({ids:Ye,scope:ut,callback:pt})}getUpdatedImages(Ye){return this.updatedImages[Ye]}_notify(ut,pt,wt){const Tt={};for(const wt of ut){this.images[pt][wt]||this.fire(new Ye.f("styleimagemissing",{id:wt}));const ut=this.images[pt][wt];ut?Tt[wt]={data:ut.data.clone(),pixelRatio:ut.pixelRatio,sdf:ut.sdf,version:ut.version,stretchX:ut.stretchX,stretchY:ut.stretchY,content:ut.content,hasRenderCallback:Boolean(ut.userImage&&ut.userImage.render)}:Ye.w(`Image "${wt}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}wt(null,Tt)}getPixelSize(Ye){const{width:ut,height:pt}=this.atlasImage[Ye];return{width:ut,height:pt}}getPattern(ut,pt,wt){const Tt=this.patterns[pt][ut],St=this.getImage(ut,pt);if(!St)return null;if(Tt&&Tt.position.version===St.version)return Tt.position;if(Tt)Tt.position.version=St.version;else{const wt={w:St.data.width+2,h:St.data.height+2,x:0,y:0},Tt=new Ye.k(wt,St);this.patterns[pt][ut]={bin:wt,position:Tt}}return this._updatePatternAtlas(pt,wt),this.patterns[pt][ut].position}bind(ut,pt){const wt=ut.gl;let Tt=this.atlasTexture[pt];Tt?this.dirty&&(Tt.update(this.atlasImage[pt]),this.dirty=!1):(Tt=new Ye.T(ut,this.atlasImage[pt],wt.RGBA),this.atlasTexture[pt]=Tt),Tt.bind(wt.LINEAR,wt.CLAMP_TO_EDGE)}_updatePatternAtlas(ut,pt){const wt=[];for(const Ye in this.patterns[ut])wt.push(this.patterns[ut][Ye].bin);const{w:Tt,h:St}=Ye.j(wt),It=this.atlasImage[ut];It.resize({width:Tt||1,height:St||1});for(const wt in this.patterns[ut]){const{bin:Tt}=this.patterns[ut][wt],St=Tt.x+1,Lt=Tt.y+1,$t=this.images[ut][wt].data,Xt=$t.width,Sr=$t.height;Ye.i.copy($t,It,{x:0,y:0},{x:St,y:Lt},{width:Xt,height:Sr},pt),Ye.i.copy($t,It,{x:0,y:Sr-1},{x:St,y:Lt-1},{width:Xt,height:1},pt),Ye.i.copy($t,It,{x:0,y:0},{x:St,y:Lt+Sr},{width:Xt,height:1},pt),Ye.i.copy($t,It,{x:Xt-1,y:0},{x:St-1,y:Lt},{width:1,height:Sr},pt),Ye.i.copy($t,It,{x:0,y:0},{x:St+Xt,y:Lt},{width:1,height:Sr},pt)}this.dirty=!0}beginFrame(){for(const Ye in this.images)this.callbackDispatchedThisFrame[Ye]={}}dispatchRenderCallbacks(Ye,ut){for(const pt of Ye){if(this.callbackDispatchedThisFrame[ut][pt])continue;this.callbackDispatchedThisFrame[ut][pt]=!0;const Ye=this.images[ut][pt];he(Ye)&&this.updateImage(pt,ut,Ye)}}}function ue(ut){const pt=ut.key,wt=ut.value,Tt=ut.valueSpec||{},St=ut.objectElementValidators||{},It=ut.style,Lt=ut.styleSpec;let $t=[];const Xt=Ye.n(wt);if("object"!==Xt)return[new Ye.V(pt,wt,`object expected, ${Xt} found`)];for(const ut in wt){const Xt=ut.split(".")[0];let Sr;St[Xt]?Sr=St[Xt]:Tt[Xt]?Sr=ze:St["*"]?Sr=St["*"]:Tt["*"]&&(Sr=ze),Sr?$t=$t.concat(Sr({key:(pt?`${pt}.`:pt)+ut,value:wt[ut],valueSpec:Tt[Xt]||Tt["*"],style:It,styleSpec:Lt,object:wt,objectKey:ut},wt)):$t.push(new Ye.m(pt,wt[ut],`unknown property "${ut}"`))}for(const ut in Tt)St[ut]||Tt[ut].required&&void 0===Tt[ut].default&&void 0===wt[ut]&&$t.push(new Ye.V(pt,wt,`missing required property "${ut}"`));return $t}function de(ut){const pt=ut.value,wt=ut.valueSpec,Tt=ut.style,St=ut.styleSpec,It=ut.key,Lt=ut.arrayElementValidator||ze;if("array"!==Ye.n(pt))return[new Ye.V(It,pt,`array expected, ${Ye.n(pt)} found`)];if(wt.length&&pt.length!==wt.length)return[new Ye.V(It,pt,`array length ${wt.length} expected, length ${pt.length} found`)];if(wt["min-length"]&&pt.length<wt["min-length"])return[new Ye.V(It,pt,`array length at least ${wt["min-length"]} expected, length ${pt.length} found`)];let $t={type:wt.value,values:wt.values,minimum:wt.minimum,maximum:wt.maximum,function:void 0};St.$version<7&&($t.function=wt.function),"object"===Ye.n(wt.value)&&($t=wt.value);let Xt=[];for(let Ye=0;Ye<pt.length;Ye++)Xt=Xt.concat(Lt({array:pt,arrayIndex:Ye,value:pt[Ye],valueSpec:$t,style:Tt,styleSpec:St,key:`${It}[${Ye}]`},!0));return Xt}function pe(ut){const pt=ut.key,wt=ut.value,Tt=ut.valueSpec;let St=Ye.n(wt);if("number"===St&&wt!=wt&&(St="NaN"),"number"!==St)return[new Ye.V(pt,wt,`number expected, ${St} found`)];if("minimum"in Tt){let St=Tt.minimum;if("array"===Ye.n(Tt.minimum)&&(St=Tt.minimum[ut.arrayIndex]),wt<St)return[new Ye.V(pt,wt,`${wt} is less than the minimum value ${St}`)]}if("maximum"in Tt){let St=Tt.maximum;if("array"===Ye.n(Tt.maximum)&&(St=Tt.maximum[ut.arrayIndex]),wt>St)return[new Ye.V(pt,wt,`${wt} is greater than the maximum value ${St}`)]}return[]}function fe(ut){const pt=ut.valueSpec,wt=Ye.u(ut.value.type);let Tt,St,It,Lt={};const $t="categorical"!==wt&&void 0===ut.value.property,Xt=!$t,Sr="array"===Ye.n(ut.value.stops)&&"array"===Ye.n(ut.value.stops[0])&&"object"===Ye.n(ut.value.stops[0][0]),Lr=ue({key:ut.key,value:ut.value,valueSpec:ut.styleSpec.function,style:ut.style,styleSpec:ut.styleSpec,objectElementValidators:{stops:function(ut){if("identity"===wt)return[new Ye.V(ut.key,ut.value,'identity function may not have a "stops" property')];let pt=[];const Tt=ut.value;return pt=pt.concat(de({key:ut.key,value:Tt,valueSpec:ut.valueSpec,style:ut.style,styleSpec:ut.styleSpec,arrayElementValidator:u})),"array"===Ye.n(Tt)&&0===Tt.length&&pt.push(new Ye.V(ut.key,Tt,"array must have at least one stop")),pt},default:function(Ye){return ze({key:Ye.key,value:Ye.value,valueSpec:pt,style:Ye.style,styleSpec:Ye.styleSpec})}}});return"identity"===wt&&$t&&Lr.push(new Ye.V(ut.key,ut.value,'missing required property "property"')),"identity"===wt||ut.value.stops||Lr.push(new Ye.V(ut.key,ut.value,'missing required property "stops"')),"exponential"===wt&&ut.valueSpec.expression&&!Ye.s(ut.valueSpec)&&Lr.push(new Ye.V(ut.key,ut.value,"exponential functions not supported")),ut.styleSpec.$version>=8&&(Xt&&!Ye.q(ut.valueSpec)?Lr.push(new Ye.V(ut.key,ut.value,"property functions not supported")):$t&&!Ye.r(ut.valueSpec)&&Lr.push(new Ye.V(ut.key,ut.value,"zoom functions not supported"))),"categorical"!==wt&&!Sr||void 0!==ut.value.property||Lr.push(new Ye.V(ut.key,ut.value,'"property" property is required')),Lr;function u(ut){let wt=[];const Tt=ut.value,$t=ut.key;if("array"!==Ye.n(Tt))return[new Ye.V($t,Tt,`array expected, ${Ye.n(Tt)} found`)];if(2!==Tt.length)return[new Ye.V($t,Tt,`array length 2 expected, length ${Tt.length} found`)];if(Sr){if("object"!==Ye.n(Tt[0]))return[new Ye.V($t,Tt,`object expected, ${Ye.n(Tt[0])} found`)];if(void 0===Tt[0].zoom)return[new Ye.V($t,Tt,"object stop key must have zoom")];if(void 0===Tt[0].value)return[new Ye.V($t,Tt,"object stop key must have value")];const pt=Ye.u(Tt[0].zoom);if("number"!=typeof pt)return[new Ye.V($t,Tt[0].zoom,"stop zoom values must be numbers")];if(It&&It>pt)return[new Ye.V($t,Tt[0].zoom,"stop zoom values must appear in ascending order")];pt!==It&&(It=pt,St=void 0,Lt={}),wt=wt.concat(ue({key:`${$t}[0]`,value:Tt[0],valueSpec:{zoom:{}},style:ut.style,styleSpec:ut.styleSpec,objectElementValidators:{zoom:pe,value:d}}))}else wt=wt.concat(d({key:`${$t}[0]`,value:Tt[0],valueSpec:{},style:ut.style,styleSpec:ut.styleSpec},Tt));return Ye.t(Ye.v(Tt[1]))?wt.concat([new Ye.V(`${$t}[1]`,Tt[1],"expressions are not allowed in function stops.")]):wt.concat(ze({key:`${$t}[1]`,value:Tt[1],valueSpec:pt,style:ut.style,styleSpec:ut.styleSpec}))}function d(ut,It){const $t=Ye.n(ut.value),Xt=Ye.u(ut.value),Sr=null!==ut.value?ut.value:It;if(Tt){if($t!==Tt)return[new Ye.V(ut.key,Sr,`${$t} stop domain type must match previous stop domain type ${Tt}`)]}else Tt=$t;if("number"!==$t&&"string"!==$t&&"boolean"!==$t&&"number"!=typeof Xt&&"string"!=typeof Xt&&"boolean"!=typeof Xt)return[new Ye.V(ut.key,Sr,"stop domain value must be a number, string, or boolean")];if("number"!==$t&&"categorical"!==wt){let Tt=`number expected, ${$t} found`;return Ye.q(pt)&&void 0===wt&&(Tt+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Ye.V(ut.key,Sr,Tt)]}return"categorical"!==wt||"number"!==$t||"number"==typeof Xt&&isFinite(Xt)&&Math.floor(Xt)===Xt?"categorical"!==wt&&"number"===$t&&"number"==typeof Xt&&"number"==typeof St&&void 0!==St&&Xt<St?[new Ye.V(ut.key,Sr,"stop domain values must appear in ascending order")]:(St=Xt,"categorical"===wt&&Xt in Lt?[new Ye.V(ut.key,Sr,"stop domain values must be unique")]:(Lt[Xt]=!0,[])):[new Ye.V(ut.key,Sr,`integer expected, found ${String(Xt)}`)]}}function me(ut){const pt=("property"===ut.expressionContext?Ye.x:Ye.y)(Ye.v(ut.value),ut.valueSpec);if("error"===pt.result)return pt.value.map((pt=>new Ye.V(`${ut.key}${pt.key}`,ut.value,pt.message)));const wt=pt.value.expression||pt.value._styleExpression.expression;if("property"===ut.expressionContext&&"text-font"===ut.propertyKey&&!wt.outputDefined())return[new Ye.V(ut.key,ut.value,`Invalid data expression for "${ut.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===ut.expressionContext&&"layout"===ut.propertyType&&!Ye.z(wt))return[new Ye.V(ut.key,ut.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===ut.expressionContext)return ge(wt,ut);if(ut.expressionContext&&0===ut.expressionContext.indexOf("cluster")){if(!Ye.A(wt,["zoom","feature-state"]))return[new Ye.V(ut.key,ut.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===ut.expressionContext&&!Ye.B(wt))return[new Ye.V(ut.key,ut.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ge(ut,pt){const wt=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(pt.valueSpec&&pt.valueSpec.expression)for(const Ye of pt.valueSpec.expression.parameters)wt.delete(Ye);if(0===wt.size)return[];const Tt=[];return ut instanceof Ye.D&&wt.has(ut.name)?[new Ye.V(pt.key,pt.value,`["${ut.name}"] expression is not supported in a filter for a ${pt.object.type} layer with id: ${pt.object.id}`)]:(ut.eachChild((Ye=>{Tt.push(...ge(Ye,pt))})),Tt)}function ve(ut){const pt=ut.key,wt=ut.value,Tt=ut.valueSpec,St=[];return Array.isArray(Tt.values)?-1===Tt.values.indexOf(Ye.u(wt))&&St.push(new Ye.V(pt,wt,`expected one of [${Tt.values.join(", ")}], ${JSON.stringify(wt)} found`)):-1===Object.keys(Tt.values).indexOf(Ye.u(wt))&&St.push(new Ye.V(pt,wt,`expected one of [${Object.keys(Tt.values).join(", ")}], ${JSON.stringify(wt)} found`)),St}function xe(ut){return Ye.G(Ye.v(ut.value))?me(Ye.o({},ut,{expressionContext:"filter",valueSpec:ut.styleSpec[`filter_${ut.layerType||"fill"}`]})):ye(ut)}function ye(ut){const pt=ut.value,wt=ut.key;if("array"!==Ye.n(pt))return[new Ye.V(wt,pt,`array expected, ${Ye.n(pt)} found`)];const Tt=ut.styleSpec;let St,It=[];if(pt.length<1)return[new Ye.V(wt,pt,"filter array must have at least 1 element")];switch(It=It.concat(ve({key:`${wt}[0]`,value:pt[0],valueSpec:Tt.filter_operator,style:ut.style,styleSpec:ut.styleSpec})),Ye.u(pt[0])){case"<":case"<=":case">":case">=":pt.length>=2&&"$type"===Ye.u(pt[1])&&It.push(new Ye.V(wt,pt,`"$type" cannot be use with operator "${pt[0]}"`));case"==":case"!=":3!==pt.length&&It.push(new Ye.V(wt,pt,`filter array for operator "${pt[0]}" must have 3 elements`));case"in":case"!in":pt.length>=2&&(St=Ye.n(pt[1]),"string"!==St&&It.push(new Ye.V(`${wt}[1]`,pt[1],`string expected, ${St} found`)));for(let Lt=2;Lt<pt.length;Lt++)St=Ye.n(pt[Lt]),"$type"===Ye.u(pt[1])?It=It.concat(ve({key:`${wt}[${Lt}]`,value:pt[Lt],valueSpec:Tt.geometry_type,style:ut.style,styleSpec:ut.styleSpec})):"string"!==St&&"number"!==St&&"boolean"!==St&&It.push(new Ye.V(`${wt}[${Lt}]`,pt[Lt],`string, number, or boolean expected, ${St} found`));break;case"any":case"all":case"none":for(let Ye=1;Ye<pt.length;Ye++)It=It.concat(ye({key:`${wt}[${Ye}]`,value:pt[Ye],style:ut.style,styleSpec:ut.styleSpec}));break;case"has":case"!has":St=Ye.n(pt[1]),2!==pt.length?It.push(new Ye.V(wt,pt,`filter array for "${pt[0]}" operator must have 2 elements`)):"string"!==St&&It.push(new Ye.V(`${wt}[1]`,pt[1],`string expected, ${St} found`))}return It}function be(ut,pt){const wt=ut.key,Tt=ut.style,St=ut.layer,It=ut.styleSpec,Lt=ut.value,$t=ut.objectKey,Xt=It[`${pt}_${ut.layerType}`];if(!Xt)return[];const Sr=$t.match(/^(.*)-transition$/);if("paint"===pt&&Sr&&Xt[Sr[1]]&&Xt[Sr[1]].transition)return ze({key:wt,value:Lt,valueSpec:It.transition,style:Tt,styleSpec:It});const Lr=ut.valueSpec||Xt[$t];if(!Lr)return[new Ye.m(wt,Lt,`unknown property "${$t}"`)];let Qr;if("string"===Ye.n(Lt)&&Ye.q(Lr)&&!Lr.tokens&&(Qr=/^{([^}]+)}$/.exec(Lt))){const ut=`\`{ "type": "identity", "property": ${Qr?JSON.stringify(Qr[1]):'"_"'} }\``;return[new Ye.V(wt,Lt,`"${$t}" does not support interpolation syntax\nUse an identity property function instead: ${ut}.`)]}const fn=[];if("symbol"===ut.layerType)"text-field"!==$t||!Tt||Tt.glyphs||Tt.imports||fn.push(new Ye.V(wt,Lt,'use of "text-field" requires a style "glyphs" property')),"text-font"===$t&&Ye.H(Ye.v(Lt))&&"identity"===Ye.u(Lt.type)&&fn.push(new Ye.V(wt,Lt,'"text-font" does not support identity functions'));else if("model"===ut.layerType&&"paint"===pt&&St&&St.layout&&St.layout.hasOwnProperty("model-id")&&Ye.q(Lr)&&(Ye.J(Lr)||Ye.r(Lr))){const ut=Ye.x(Ye.v(Lt),Lr),pt=ut.value.expression||ut.value._styleExpression.expression;pt&&!Ye.A(pt,["measure-light"])&&("model-emissive-strength"===$t&&Ye.B(pt)&&Ye.z(pt)||fn.push(new Ye.V(wt,Lt,`${$t} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return fn.concat(ze({key:ut.key,value:Lt,valueSpec:Lr,style:Tt,styleSpec:It,expressionContext:"property",propertyType:pt,propertyKey:$t}))}function we(Ye){return be(Ye,"paint")}function Te(Ye){return be(Ye,"layout")}function Ee(ut){let pt=[];const wt=ut.value,Tt=ut.key,St=ut.style,It=ut.styleSpec;wt.type||wt.ref||pt.push(new Ye.V(Tt,wt,'either "type" or "ref" is required'));let Lt=Ye.u(wt.type);const $t=Ye.u(wt.ref);if(wt.id){const It=Ye.u(wt.id);for(let Lt=0;Lt<ut.arrayIndex;Lt++){const ut=St.layers[Lt];Ye.u(ut.id)===It&&pt.push(new Ye.V(Tt,wt.id,`duplicate layer id "${wt.id}", previously used at line ${ut.id.__line__}`))}}if("ref"in wt){let ut;["type","source","source-layer","filter","layout"].forEach((ut=>{ut in wt&&pt.push(new Ye.V(Tt,wt[ut],`"${ut}" is prohibited for ref layers`))})),St.layers.forEach((pt=>{Ye.u(pt.id)===$t&&(ut=pt)})),ut?ut.ref?pt.push(new Ye.V(Tt,wt.ref,"ref cannot reference another ref layer")):Lt=Ye.u(ut.type):"string"==typeof $t&&pt.push(new Ye.V(Tt,wt.ref,`ref layer "${$t}" not found`))}else if("background"!==Lt&&"sky"!==Lt&&"slot"!==Lt)if(wt.source){const ut=St.sources&&St.sources[wt.source],It=ut&&Ye.u(ut.type);ut?"vector"===It&&"raster"===Lt?pt.push(new Ye.V(Tt,wt.source,`layer "${wt.id}" requires a raster source`)):"raster"===It&&"raster"!==Lt?pt.push(new Ye.V(Tt,wt.source,`layer "${wt.id}" requires a vector source`)):"vector"!==It||wt["source-layer"]?"raster-dem"===It&&"hillshade"!==Lt?pt.push(new Ye.V(Tt,wt.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==It||["raster","raster-particle"].includes(Lt)?"line"!==Lt||!wt.paint||!wt.paint["line-gradient"]&&!wt.paint["line-trim-offset"]||"geojson"===It&&ut.lineMetrics?"raster-particle"===Lt&&"raster-array"!==It&&pt.push(new Ye.V(Tt,wt.source,`layer "${wt.id}" requires a 'raster-array' source.`)):pt.push(new Ye.V(Tt,wt,`layer "${wt.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):pt.push(new Ye.V(Tt,wt.source,"raster-array source can only be used with layer type 'raster'.")):pt.push(new Ye.V(Tt,wt,`layer "${wt.id}" must specify a "source-layer"`)):pt.push(new Ye.V(Tt,wt.source,`source "${wt.source}" not found`))}else pt.push(new Ye.V(Tt,wt,'missing required property "source"'));return pt=pt.concat(ue({key:Tt,value:wt,valueSpec:It.layer,style:ut.style,styleSpec:ut.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ze({key:`${Tt}.type`,value:wt.type,valueSpec:It.layer.type,style:ut.style,styleSpec:ut.styleSpec,object:wt,objectKey:"type"}),filter:ut=>xe(Ye.o({layerType:Lt},ut)),layout:ut=>ue({layer:wt,key:ut.key,value:ut.value,valueSpec:{},style:ut.style,styleSpec:ut.styleSpec,objectElementValidators:{"*":ut=>Te(Ye.o({layerType:Lt},ut))}}),paint:ut=>ue({layer:wt,key:ut.key,value:ut.value,valueSpec:{},style:ut.style,styleSpec:ut.styleSpec,objectElementValidators:{"*":ut=>we(Ye.o({layerType:Lt,layer:wt},ut))}})}})),pt}function Ce(ut){const pt=ut.value,wt=ut.key,Tt=Ye.n(pt);return"string"!==Tt?[new Ye.V(wt,pt,`string expected, ${Tt} found`)]:[]}const $t={promoteId:function({key:ut,value:pt}){if("string"===Ye.n(pt))return Ce({key:ut,value:pt});{const Ye=[];for(const wt in pt)Ye.push(...Ce({key:`${ut}.${wt}`,value:pt[wt]}));return Ye}}};function Ie(ut){const pt=ut.value,wt=ut.key,Tt=ut.styleSpec,St=ut.style;if(!pt.type)return[new Ye.V(wt,pt,'"type" is required')];const It=Ye.u(pt.type);let Lt=[];switch(["vector","raster","raster-dem","raster-array"].includes(It)&&(pt.url||pt.tiles||Lt.push(new Ye.m(wt,pt,'Either "url" or "tiles" is required.'))),It){case"vector":case"raster":case"raster-dem":case"raster-array":return Lt=Lt.concat(ue({key:wt,value:pt,valueSpec:Tt[`source_${It.replace("-","_")}`],style:ut.style,styleSpec:Tt,objectElementValidators:$t})),Lt;case"geojson":if(Lt=ue({key:wt,value:pt,valueSpec:Tt.source_geojson,style:St,styleSpec:Tt,objectElementValidators:$t}),pt.cluster)for(const Ye in pt.clusterProperties){const[ut,Tt]=pt.clusterProperties[Ye],St="string"==typeof ut?[ut,["accumulated"],["get",Ye]]:ut;Lt.push(...me({key:`${wt}.${Ye}.map`,value:Tt,expressionContext:"cluster-map"})),Lt.push(...me({key:`${wt}.${Ye}.reduce`,value:St,expressionContext:"cluster-reduce"}))}return Lt;case"video":return ue({key:wt,value:pt,valueSpec:Tt.source_video,style:St,styleSpec:Tt});case"image":return ue({key:wt,value:pt,valueSpec:Tt.source_image,style:St,styleSpec:Tt});case"canvas":return[new Ye.V(wt,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ve({key:`${wt}.type`,value:pt.type,valueSpec:{values:Le(Tt)},style:St,styleSpec:Tt})}}function Le(Ye){return Ye.source.reduce(((ut,pt)=>{const wt=Ye[pt];return"enum"===wt.type.type&&(ut=ut.concat(Object.keys(wt.type.values))),ut}),[])}function Pe(ut){const pt=ut.value,wt=ut.styleSpec,Tt=wt.light,St=ut.style;let It=[];const Lt=Ye.n(pt);if(void 0===pt)return It;if("object"!==Lt)return It=It.concat([new Ye.V("light",pt,`object expected, ${Lt} found`)]),It;for(const ut in pt){const Lt=ut.match(/^(.*)-transition$/);It=It.concat(Lt&&Tt[Lt[1]]&&Tt[Lt[1]].transition?ze({key:ut,value:pt[ut],valueSpec:wt.transition,style:St,styleSpec:wt}):Tt[ut]?ze({key:ut,value:pt[ut],valueSpec:Tt[ut],style:St,styleSpec:wt}):[new Ye.V(ut,pt[ut],`unknown property "${ut}"`)])}return It}function Ae(ut){const pt=ut.value;let wt=[];if(!pt)return wt;const Tt=Ye.n(pt);if("object"!==Tt)return wt=wt.concat([new Ye.V("light-3d",pt,`object expected, ${Tt} found`)]),wt;const St=ut.styleSpec,It=St["light-3d"],Lt=ut.key,$t=ut.style,Xt=ut.style.lights;for(const ut of["type","id"])if(!(ut in pt))return wt=wt.concat([new Ye.V("light-3d",pt,`missing property ${ut} on light`)]),wt;if(pt.type&&Xt)for(let Tt=0;Tt<ut.arrayIndex;Tt++){const ut=Ye.u(pt.type),St=Xt[Tt];Ye.u(St.type)===ut&&wt.push(new Ye.V(Lt,pt.id,`duplicate light type "${pt.type}", previously defined at line ${St.id.__line__}`))}const Sr=`properties_light_${pt.type}`;if(!(Sr in St))return wt=wt.concat([new Ye.V("light-3d",pt,`Invalid light type ${pt.type}`)]),wt;const Lr=St[Sr];for(const Tt in pt)if("properties"===Tt){const It=pt[Tt],Lt=Ye.n(It);if("object"!==Lt)return wt=wt.concat([new Ye.V("properties",It,`object expected, ${Lt} found`)]),wt;for(const pt in It)wt=wt.concat(Lr[pt]?ze({key:pt,value:It[pt],valueSpec:Lr[pt],style:$t,styleSpec:St}):[new Ye.m(ut.key,It[pt],`unknown property "${pt}"`)])}else{const ut=Tt.match(/^(.*)-transition$/);wt=wt.concat(ut&&It[ut[1]]&&It[ut[1]].transition?ze({key:Tt,value:pt[Tt],valueSpec:St.transition,style:$t,styleSpec:St}):It[Tt]?ze({key:Tt,value:pt[Tt],valueSpec:It[Tt],style:$t,styleSpec:St}):[new Ye.m(Tt,pt[Tt],`unknown property "${Tt}"`)])}return wt}function Re(ut){const pt=ut.value,wt=ut.key,Tt=ut.style,St=ut.styleSpec,It=St.terrain;let Lt=[];const $t=Ye.n(pt);if(void 0===pt)return Lt;if("null"===$t)return Lt;if("object"!==$t)return Lt=Lt.concat([new Ye.V("terrain",pt,`object expected, ${$t} found`)]),Lt;for(const ut in pt){const wt=ut.match(/^(.*)-transition$/);Lt=Lt.concat(wt&&It[wt[1]]&&It[wt[1]].transition?ze({key:ut,value:pt[ut],valueSpec:St.transition,style:Tt,styleSpec:St}):It[ut]?ze({key:ut,value:pt[ut],valueSpec:It[ut],style:Tt,styleSpec:St}):[new Ye.m(ut,pt[ut],`unknown property "${ut}"`)])}if(pt.source){const ut=Tt.sources&&Tt.sources[pt.source],St=ut&&Ye.u(ut.type);ut?"raster-dem"!==St&&Lt.push(new Ye.V(wt,pt.source,`terrain cannot be used with a source of type ${String(St)}, it only be used with a "raster-dem" source type`)):Lt.push(new Ye.V(wt,pt.source,`source "${pt.source}" not found`))}else Lt.push(new Ye.V(wt,pt,'terrain is missing required property "source"'));return Lt}function De(ut){const pt=ut.value,wt=ut.style,Tt=ut.styleSpec,St=Tt.fog;let It=[];const Lt=Ye.n(pt);if(void 0===pt)return It;if("object"!==Lt)return It=It.concat([new Ye.V("fog",pt,`object expected, ${Lt} found`)]),It;for(const ut in pt){const Lt=ut.match(/^(.*)-transition$/);It=It.concat(Lt&&St[Lt[1]]&&St[Lt[1]].transition?ze({key:ut,value:pt[ut],valueSpec:Tt.transition,style:wt,styleSpec:Tt}):St[ut]?ze({key:ut,value:pt[ut],valueSpec:St[ut],style:wt,styleSpec:Tt}):[new Ye.m(ut,pt[ut],`unknown property "${ut}"`)])}return It}const Xt={"*":()=>[],array:de,boolean:function(ut){const pt=ut.value,wt=ut.key,Tt=Ye.n(pt);return"boolean"!==Tt?[new Ye.V(wt,pt,`boolean expected, ${Tt} found`)]:[]},number:pe,color:function(ut){const pt=ut.key,wt=ut.value,Tt=Ye.n(wt);return"string"!==Tt?[new Ye.V(pt,wt,`color expected, ${Tt} found`)]:null===Ye.F(wt)?[new Ye.V(pt,wt,`color expected, "${wt}" found`)]:[]},enum:ve,filter:xe,function:fe,layer:Ee,object:ue,source:Ie,model:Ye.K,light:Pe,"light-3d":Ae,terrain:Re,fog:De,string:Ce,formatted:function(Ye){return 0===Ce(Ye).length?[]:me(Ye)},resolvedImage:function(Ye){return 0===Ce(Ye).length?[]:me(Ye)},projection:function(ut){const pt=ut.value,wt=ut.styleSpec,Tt=wt.projection,St=ut.style;let It=[];const Lt=Ye.n(pt);if("object"===Lt)for(const Ye in pt)It=It.concat(ze({key:Ye,value:pt[Ye],valueSpec:Tt[Ye],style:St,styleSpec:wt}));else"string"!==Lt&&(It=It.concat([new Ye.V("projection",pt,`object or string expected, ${Lt} found`)]));return It},import:function(ut){const{value:pt,styleSpec:wt}=ut,{data:Tt,...St}=pt;Object.defineProperty(St,"__line__",{value:pt.__line__,enumerable:!1});let It=ue(Ye.o({},ut,{value:St,valueSpec:wt.import}));return""===Ye.u(St.id)&&It.push(new Ye.V(`${ut.key}.id`,St,"import id can't be an empty string")),Tt&&(It=It.concat(Fe(Tt,wt,{key:`${ut.key}.data`}))),It}};function ze(ut,pt=!1){const wt=ut.value,Tt=ut.valueSpec,St=ut.styleSpec;if(Tt.expression&&Ye.H(Ye.u(wt)))return fe(ut);if(Tt.expression&&Ye.t(Ye.v(wt)))return me(ut);if(Tt.type&&Xt[Tt.type]){const wt=Xt[Tt.type](ut);return!0===pt&&wt.length>0&&"array"===Ye.n(ut.value)?me(ut):wt}return ue(Ye.o({},ut,{valueSpec:Tt.type?St[Tt.type]:Tt}))}function Oe(ut){const pt=ut.value,wt=ut.key,Tt=Ce(ut);return Tt.length||(-1===pt.indexOf("{fontstack}")&&Tt.push(new Ye.V(wt,pt,'"glyphs" url must include a "{fontstack}" token')),-1===pt.indexOf("{range}")&&Tt.push(new Ye.V(wt,pt,'"glyphs" url must include a "{range}" token'))),Tt}function Fe(ut,pt=Ye.L,wt={}){return ze({key:wt.key||"",value:ut,valueSpec:pt.$root,styleSpec:pt,style:ut,objectElementValidators:{glyphs:Oe,"*":()=>[]}})}function Be(ut,pt=Ye.L){return $e(Fe(ut,pt))}const ke=Ye=>$e(Ie(Ye)),Ne=Ye=>$e(Pe(Ye)),Ue=Ye=>$e(Ae(Ye)),Ge=Ye=>$e(Re(Ye)),je=Ye=>$e(De(Ye)),Ve=Ye=>$e(Ee(Ye)),We=Ye=>$e(xe(Ye)),Ze=Ye=>$e(we(Ye)),qe=Ye=>$e(Te(Ye)),He=ut=>$e(Ye.K(ut));function $e(Ye){return Ye.slice().sort(((Ye,ut)=>Ye.line&&ut.line?Ye.line-ut.line:0))}function Xe(ut,pt){let wt=!1;if(pt&&pt.length)for(const Tt of pt)Tt instanceof Ye.m?Ye.w(Tt.message):(ut.fire(new Ye.d(new Error(Tt.message))),wt=!0);return wt}const Sr=new Ye.N({anchor:new Ye.O(Ye.L.light.anchor),position:new Ye.Q(Ye.L.light.position),color:new Ye.O(Ye.L.light.color),intensity:new Ye.O(Ye.L.light.intensity)});class Ke extends Ye.E{constructor(ut,pt="flat"){super(),this._transitionable=new Ye.U(Sr),this.setLight(ut,pt),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(Ye,ut,pt={}){this._validate(Ne,Ye,pt)||(this._transitionable.setTransitionOrValue(Ye),this.id=ut)}updateTransitions(Ye){this._transitioning=this._transitionable.transitioned(Ye,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(Ye){this.properties=this._transitioning.possiblyEvaluate(Ye)}_validate(ut,pt,wt){return(!wt||!1!==wt.validate)&&Xe(this,ut.call(Be,Ye.W({value:pt,style:{glyphs:!0,sprite:!0},styleSpec:Ye.L})))}}const Lr=new Ye.N({source:new Ye.O(Ye.L.terrain.source),exaggeration:new Ye.O(Ye.L.terrain.exaggeration)});let Qr=class extends Ye.E{constructor(ut,pt,wt,Tt){super(),this.scope=wt,this._transitionable=new Ye.U(Lr,wt,Tt),this._transitionable.setTransitionOrValue(ut,Tt),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=pt}get(){return this._transitionable.serialize()}set(Ye,ut){this._transitionable.setTransitionOrValue(Ye,ut)}updateTransitions(Ye){this._transitioning=this._transitionable.transitioned(Ye,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(Ye){this.properties=this._transitioning.possiblyEvaluate(Ye)}getExaggeration(ut){return this._transitioning.possiblyEvaluate(new Ye.X(ut)).get("exaggeration")}isZoomDependent(){const ut=this._transitionable._values.exaggeration;return null!=ut&&null!=ut.value&&null!=ut.value.expression&&ut.value.expression instanceof Ye.Z}};const fn=45,xn=65,vn=.05;function ot(ut,pt,wt,Tt){const St=Ye.$(fn,xn,wt),[It,Lt]=rt(ut,Tt);let $t=1-Math.min(1,Math.exp((pt-It)/(Lt-It)*-6));return $t*=$t*$t,$t=Math.min(1,1.00747*$t),$t*St*ut.alpha}function rt(Ye,ut){const pt=.5/Math.tan(.5*ut);return[Ye.range[0]+pt,Ye.range[1]+pt]}function at(ut,pt,wt,Tt,St){const It=Ye._.transformMat4([],[pt,wt,Tt],St.mercatorFogMatrix);return ot(ut,Ye._.length(It),St.pitch,St._fov)}function nt(ut,pt,wt,Tt,St,It,Lt){const $t=[[wt,Tt,0],[St,Tt,0],[St,It,0],[wt,It,0]];let Xt=Number.MAX_VALUE,Sr=-Number.MAX_VALUE;for(const ut of $t){const wt=Ye._.transformMat4([],ut,pt),Tt=Ye._.length(wt);Xt=Math.min(Xt,Tt),Sr=Math.max(Sr,Tt)}return[ot(ut,Xt,Lt.pitch,Lt._fov),ot(ut,Sr,Lt.pitch,Lt._fov)]}const kn=new Ye.N({range:new Ye.O(Ye.L.fog.range),color:new Ye.O(Ye.L.fog.color),"high-color":new Ye.O(Ye.L.fog["high-color"]),"space-color":new Ye.O(Ye.L.fog["space-color"]),"horizon-blend":new Ye.O(Ye.L.fog["horizon-blend"]),"star-intensity":new Ye.O(Ye.L.fog["star-intensity"]),"vertical-range":new Ye.O(Ye.L.fog["vertical-range"])});class lt extends Ye.E{constructor(ut,pt,wt,Tt){super(),this._transitionable=new Ye.U(kn,wt,new Map(Tt)),this.set(ut,Tt),this._transitioning=this._transitionable.untransitioned(),this._transform=pt,this.properties=new Ye.a0(kn),this.scope=wt}get state(){const ut=this._transform,pt="globe"===ut.projection.name,wt=Ye.a1(ut.zoom),Tt=this.properties.get("range"),St=[.5,3];return{range:pt?[Ye.a2(St[0],Tt[0],wt),Ye.a2(St[1],Tt[1],wt)]:Tt,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(ut,pt,wt={}){if(this._validate(je,ut,wt))return;const Tt=Ye.W({},ut);for(const ut of Object.keys(Ye.L.fog))void 0===Tt[ut]&&(Tt[ut]=Ye.L.fog[ut].default);this._options=Tt,this._transitionable.setTransitionOrValue(this._options,pt)}getOpacity(ut){if(!this._transform.projection.supportsFog)return 0;const pt=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:Ye.$(fn,xn,ut))*pt.a}getOpacityAtLatLng(ut,pt){return this._transform.projection.supportsFog?function(ut,pt,wt){const Tt=Ye.Y.fromLngLat(pt),St=wt.elevation?wt.elevation.getAtPointOrZero(Tt):0;return at(ut,Tt.x,Tt.y,St,wt)}(this.state,ut,pt):0}getOpacityForTile(ut){if(!this._transform.projection.supportsFog)return[1,1];const pt=this._transform.calculateFogTileMatrix(ut.toUnwrapped());return nt(this.state,pt,0,0,Ye.a3,Ye.a3,this._transform)}getOpacityForBounds(Ye,ut,pt,wt,Tt){return this._transform.projection.supportsFog?nt(this.state,Ye,ut,pt,wt,Tt,this._transform):[1,1]}getFovAdjustedRange(Ye){return this._transform.projection.supportsFog?rt(this.state,Ye):[0,1]}isVisibleOnFrustum(ut){if(!this._transform.projection.supportsFog)return!1;const pt=[4,5,6,7];for(const wt of pt){const pt=ut.points[wt];let Tt;if(pt[2]>=0)Tt=pt;else{const St=ut.points[wt-4];Tt=Ye.a4(St,pt,St[2]/(St[2]-pt[2]))}if(at(this.state,Tt[0],Tt[1],0,this._transform)>=vn)return!0}return!1}updateConfig(Ye){this._transitionable.setTransitionOrValue(this._options,new Map(Ye))}updateTransitions(Ye){this._transitioning=this._transitionable.transitioned(Ye,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(Ye){this.properties=this._transitioning.possiblyEvaluate(Ye)}_validate(ut,pt,wt){return(!wt||!1!==wt.validate)&&Xe(this,ut.call(Be,Ye.W({value:pt,style:{glyphs:!0,sprite:!0},styleSpec:Ye.L})))}}class ct extends Ye.E{constructor(ut,pt,wt,Tt){super(),this.scope=wt,this._options=ut,this.properties=new Ye.a0(pt),this._transitionable=new Ye.U(pt,wt,new Map(Tt)),this._transitionable.setTransitionOrValue(ut.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(Ye){this._transitionable.setTransitionOrValue(this._options.properties,new Map(Ye))}updateTransitions(Ye){this._transitioning=this._transitionable.transitioned(Ye,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(Ye){this.properties=this._transitioning.possiblyEvaluate(Ye)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(Ye,ut){this._options=Ye,this._transitionable.setTransitionOrValue(Ye.properties,ut)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}const Wn=new Ye.N({color:new Ye.O(Ye.L.properties_light_ambient.color),intensity:new Ye.O(Ye.L.properties_light_ambient.intensity)}),Xn=new Ye.N({direction:new Ye.a5(Ye.L.properties_light_directional.direction),color:new Ye.O(Ye.L.properties_light_directional.color),intensity:new Ye.O(Ye.L.properties_light_directional.intensity),"cast-shadows":new Ye.O(Ye.L.properties_light_directional["cast-shadows"]),"shadow-intensity":new Ye.O(Ye.L.properties_light_directional["shadow-intensity"])});var Jn="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",Qn="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color) {\n#ifdef INDICATOR_CUTOUT\nfloat holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,vec2 pos,vec2 lod_coord) {vec2 size=vec2(textureSize(image,0));vec2 dx=dFdx(lod_coord.xy*size);vec2 dy=dFdy(lod_coord.xy*size);float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",ko="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",Fo="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",is="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform highp sampler2D u_depth;uniform vec2 u_depth_size_inv;uniform vec2 u_depth_range_unpack;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\n#ifdef TERRAIN_DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef TERRAIN_DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;\n#ifdef TERRAIN_DEPTH_D24\nvec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nvec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",ns="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",ss="highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}\n#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {\n#ifdef FOG_DITHERING\nvec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);\n#else\nreturn color;\n#endif\n}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",as="#ifdef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",ds="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",ps="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",ms="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef NATIVE\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const Js=[];Pt(Jn,Js),Pt(ko,Js),Pt(Qn,Js);const ua={"_prelude_fog.vertex.glsl":ns,"_prelude_terrain.vertex.glsl":is,"_prelude_shadow.vertex.glsl":ps,"_prelude_fog.fragment.glsl":ss,"_prelude_shadow.fragment.glsl":ms,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":as,"_prelude_raster_particle.glsl":ds},ba={};At("",is),At(ss,ns),At(ms,ps),At(as,""),At(ds,"");const Ra=At(Qn,ko),La=Jn;var ll={background:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:At("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:At('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:At("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:At("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:At("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:At("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutline:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nuniform float u_emissive_strength;in float v_height;void main() {\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0));gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:At("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nout vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:At('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:At("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:At("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform lowp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/clamp(u_trim_fade_range[0],1e-4,1.0)));float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/clamp(u_trim_fade_range[1],1e-4,1.0)));float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=out_color.a;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trim_alpha,out_color.rgb,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED)\nin float a_z_offset;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);\n#if defined(ELEVATED)\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 halfCellProgress=normal.yx*32.0;float ele0=elevation(pos);float ele_line=max(ele0,max(elevation(pos+halfCellProgress),elevation(pos-halfCellProgress)));float ele1=elevation(pos+offsetTile);float ele2=elevation(pos-offsetTile);float ele_max=max(ele_line,0.5*(ele1+ele2));float ele=ele_max-ele0+ele1+a_z_offset ;gl_Position=u_matrix*vec4(pos+offsetTile,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*0.1*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);\n#else\ngl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),linePattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec4 v_uv;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;float x=mod(pattern_x,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {color=vec4(0,0,0,0);}}\n#endif\n#ifdef LINE_JOIN_NONE\nfloat pattern_len=pattern_size/aspect;float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_ground(color);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED)\nin float a_z_offset;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec4 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec4 v_uv;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);\n#if defined(ELEVATED)\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 halfCellProgress=normal.yx*32.0;float ele0=elevation(pos);float ele_line=max(ele0,max(elevation(pos+halfCellProgress),elevation(pos-halfCellProgress)));float ele1=elevation(pos+offsetTile);float ele2=elevation(pos-offsetTile);float ele_max=max(ele_line,0.5*(ele1+ele2));float ele=ele_max-ele0+ele1+a_z_offset ;gl_Position=u_matrix*vec4(pos+offsetTile,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*0.1*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);\n#else\ngl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nfloat a_uv_x=a_packed[0];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef LINE_JOIN_NONE\nv_width=floorwidth+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),raster:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:At("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:At("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:At('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbolIcon:At('#include "_prelude_lighting.glsl"\nuniform sampler2D u_texture;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\nin float v_fade_opacity;in vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nlowp float alpha=opacity*v_fade_opacity;vec4 out_color;\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\nout_color*=alpha;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=globe_occlusion_fade;\n#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH\nocclusion_fade*=occlusionFade(projected_point);\n#endif\nfloat projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nv_tex_a=a_tex/u_texsize;\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\nv_fade_opacity=out_fade_opacity;\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);v_fade_opacity*=occludedFadeMultiplier;\n#endif\n}'),symbolSDF:At('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\nuniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec2 v_data0;out vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=globe_occlusion_fade;\n#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH\nocclusion_fade*=occlusionFade(projected_point);\n#endif\nfloat projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}'),symbolTextAndIcon:At('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec4 v_data0;out vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=globe_occlusion_fade;\n#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH\nocclusion_fade*=occlusionFade(projected_point);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nfloat out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+ xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}'),terrainRaster:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:At("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:At('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Fo),skyboxGradient:At('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Fo),skyboxCapture:At("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:At('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;\n#ifndef NATIVE\nc=dither(c,gl_FragCoord.xy+u_temporal_offset);\n#endif\nglFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;uniform vec2 u_depth_range_unpack;\n#ifdef TERRAIN_DEPTH_D24\nfloat unpack_depth(float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef TERRAIN_DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:At("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:At("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),occlusion:At("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Pt(Ye,ut){const pt=Ye.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let Ye of pt)if(Ye=Ye.trim(),"#"===Ye[0]&&Ye.includes("if")&&!Ye.includes("endif")){Ye=Ye.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const pt=Ye.split(" ");for(const Ye of pt)ut.includes(Ye)||ut.push(Ye)}}function At(Ye,ut){const pt=/#include\s+"([^"]+)"/g,wt=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let Tt=ut.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);Tt&&(Tt=Tt.map((Ye=>{const ut=Ye.split(" ");return ut[ut.length-1]})),Tt=[...new Set(Tt)]);const St={},It=[],Lt=[];if(Ye=Ye.replace(pt,((Ye,ut)=>(Lt.push(ut),""))),(ut=ut.replace(pt,((Ye,ut)=>(It.push(ut),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let $t=[...Js];Pt(Ye,$t),Pt(ut,$t);for(const Ye of[...It,...Lt])ua[Ye]||console.error(`Undefined include: ${Ye}`),ba[Ye]||(ba[Ye]=[],Pt(ua[Ye],ba[Ye])),$t=[...$t,...ba[Ye]];return{fragmentSource:Ye=Ye.replace(wt,((Ye,ut,pt,wt,Tt)=>(St[Tt]=!0,"define"===ut?`\n#ifndef HAS_UNIFORM_u_${Tt}\nin ${pt} ${wt} ${Tt};\n#else\nuniform ${pt} ${wt} u_${Tt};\n#endif\n`:"initialize"===ut?`\n#ifdef HAS_UNIFORM_u_${Tt}\n    ${pt} ${wt} ${Tt} = u_${Tt};\n#endif\n`:"define-attribute"===ut?`\n#ifdef HAS_ATTRIBUTE_a_${Tt}\n    in ${pt} ${wt} ${Tt};\n#endif\n`:"initialize-attribute"===ut?"":void 0))),vertexSource:ut=ut.replace(wt,((Ye,ut,pt,wt,Tt)=>{const It="float"===wt?"vec2":wt,Lt=Tt.match(/color/)?"color":It;return"define-attribute-vertex-shader-only"===ut?`\n#ifdef HAS_ATTRIBUTE_a_${Tt}\nin ${pt} ${wt} a_${Tt};\n#endif\n`:St[Tt]?"define"===ut?`\n#ifndef HAS_UNIFORM_u_${Tt}\nuniform lowp float u_${Tt}_t;\nin ${pt} ${It} a_${Tt};\nout ${pt} ${wt} ${Tt};\n#else\nuniform ${pt} ${wt} u_${Tt};\n#endif\n`:"initialize"===ut?"vec4"===Lt?`\n#ifndef HAS_UNIFORM_u_${Tt}\n    ${Tt} = a_${Tt};\n#else\n    ${pt} ${wt} ${Tt} = u_${Tt};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${Tt}\n    ${Tt} = unpack_mix_${Lt}(a_${Tt}, u_${Tt}_t);\n#else\n    ${pt} ${wt} ${Tt} = u_${Tt};\n#endif\n`:"define-attribute"===ut?`\n#ifdef HAS_ATTRIBUTE_a_${Tt}\n    in ${pt} ${wt} a_${Tt};\n    out ${pt} ${wt} ${Tt};\n#endif\n`:"initialize-attribute"===ut?`\n#ifdef HAS_ATTRIBUTE_a_${Tt}\n    ${Tt} = a_${Tt};\n#endif\n`:void 0:"define"===ut?`\n#ifndef HAS_UNIFORM_u_${Tt}\nuniform lowp float u_${Tt}_t;\nin ${pt} ${It} a_${Tt};\n#else\nuniform ${pt} ${wt} u_${Tt};\n#endif\n`:"define-instanced"===ut?"mat4"===Lt?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${Tt}0;\nin vec4 a_${Tt}1;\nin vec4 a_${Tt}2;\nin vec4 a_${Tt}3;\n#else\nuniform ${pt} ${wt} u_${Tt};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${pt} ${It} a_${Tt};\n#else\nuniform ${pt} ${wt} u_${Tt};\n#endif\n`:"initialize-attribute-custom"===ut?`\n#ifdef HAS_ATTRIBUTE_a_${Tt}\n    ${pt} ${wt} ${Tt} = a_${Tt};\n#endif\n`:"vec4"===Lt?`\n#ifndef HAS_UNIFORM_u_${Tt}\n    ${pt} ${wt} ${Tt} = a_${Tt};\n#else\n    ${pt} ${wt} ${Tt} = u_${Tt};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${Tt}\n    ${pt} ${wt} ${Tt} = unpack_mix_${Lt}(a_${Tt}, u_${Tt}_t);\n#else\n    ${pt} ${wt} ${Tt} = u_${Tt};\n#endif\n`})),staticAttributes:Tt,usedDefines:$t,vertexIncludes:It,fragmentIncludes:Lt}}class Rt{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(Ye,ut,pt,wt,Tt,St,It,Lt){this.context=Ye;let $t=this.boundPaintVertexBuffers.length!==wt.length;for(let Ye=0;!$t&&Ye<wt.length;Ye++)this.boundPaintVertexBuffers[Ye]!==wt[Ye]&&($t=!0);let Xt=this.boundDynamicVertexBuffers.length!==It.length;for(let Ye=0;!Xt&&Ye<It.length;Ye++)this.boundDynamicVertexBuffers[Ye]!==It[Ye]&&(Xt=!0);if(!this.vao||this.boundProgram!==ut||this.boundLayoutVertexBuffer!==pt||$t||Xt||this.boundIndexBuffer!==Tt||this.boundVertexOffset!==St)this.freshBind(ut,pt,wt,Tt,St,It,Lt);else{Ye.bindVertexArrayOES.set(this.vao);for(const pt of It)pt&&(pt.bind(),Lt&&pt.instanceCount&&pt.setVertexAttribDivisor(Ye.gl,ut,Lt));Tt&&Tt.dynamicDraw&&Tt.bind()}}freshBind(Ye,ut,pt,wt,Tt,St,It){const Lt=Ye.numAttributes,$t=this.context,Xt=$t.gl;this.vao&&this.destroy(),this.vao=$t.gl.createVertexArray(),$t.bindVertexArrayOES.set(this.vao),this.boundProgram=Ye,this.boundLayoutVertexBuffer=ut,this.boundPaintVertexBuffers=pt,this.boundIndexBuffer=wt,this.boundVertexOffset=Tt,this.boundDynamicVertexBuffers=St,ut.enableAttributes(Xt,Ye),ut.bind(),ut.setVertexAttribPointers(Xt,Ye,Tt);for(const ut of pt)ut.enableAttributes(Xt,Ye),ut.bind(),ut.setVertexAttribPointers(Xt,Ye,Tt);for(const ut of St)ut&&(ut.enableAttributes(Xt,Ye),ut.bind(),ut.setVertexAttribPointers(Xt,Ye,Tt),It&&ut.instanceCount&&ut.setVertexAttribDivisor(Xt,Ye,It));wt&&wt.bind(),$t.currentNumAttributes=Lt}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Dt(ut,pt){const wt=Math.pow(2,pt.canonical.z),Tt=pt.canonical.y;return[new Ye.Y(0,Tt/wt).toLngLat().lat,new Ye.Y(0,(Tt+1)/wt).toLngLat().lat]}function Mt(ut,pt,wt,Tt,St,It,Lt){const $t=ut.context,Xt=$t.gl,Sr=wt.hillshadeFBO;if(!Sr)return;ut.prepareDrawTile();const Lr=ut.isTileAffectedByFog(pt),Qr=ut.getOrCreateProgram("hillshade",{overrideFog:Lr});$t.activeTexture.set(Xt.TEXTURE0),Xt.bindTexture(Xt.TEXTURE_2D,Sr.colorAttachment.get());const fn=((ut,pt,wt,Tt)=>{const St=wt.paint.get("hillshade-shadow-color"),It=wt.paint.get("hillshade-highlight-color"),Lt=wt.paint.get("hillshade-accent-color"),$t=wt.paint.get("hillshade-emissive-strength");let Xt=Ye.ab(wt.paint.get("hillshade-illumination-direction"));if("viewport"===wt.paint.get("hillshade-illumination-anchor"))Xt-=ut.transform.angle;else if(ut.style&&ut.style.enable3dLights()&&ut.style.directionalLight){const pt=ut.style.directionalLight.properties.get("direction"),wt=Ye.ac(pt.x,pt.y,pt.z);Xt=Ye.ab(wt[1])}const Sr=!ut.options.moving;return{u_matrix:Tt||ut.transform.calculateProjMatrix(pt.tileID.toUnwrapped(),Sr),u_image:0,u_latrange:Dt(0,pt.tileID),u_light:[wt.paint.get("hillshade-exaggeration"),Xt],u_shadow:St.toRenderColor(wt.lut),u_highlight:It.toRenderColor(wt.lut),u_emissive_strength:$t,u_accent:Lt.toRenderColor(wt.lut)}})(ut,wt,Tt,ut.terrain?pt.projMatrix:null);ut.uploadCommonUniforms($t,Qr,pt.toUnwrapped());const{tileBoundsBuffer:xn,tileBoundsIndexBuffer:vn,tileBoundsSegments:kn}=ut.getTileBoundsBuffers(wt);Qr.draw(ut,Xt.TRIANGLES,St,It,Lt,Ye.af.disabled,fn,Tt.id,xn,vn,kn)}function zt(ut,pt,wt){if(!pt.needsDEMTextureUpload)return;const Tt=ut.context,St=Tt.gl;Tt.pixelStoreUnpackPremultiplyAlpha.set(!1),pt.demTexture=pt.demTexture||ut.getTileTexture(wt.stride);const It=wt.getPixels();pt.demTexture?pt.demTexture.update(It,{premultiply:!1}):pt.demTexture=new Ye.T(Tt,It,St.R32F,{premultiply:!1}),pt.needsDEMTextureUpload=!1}function Ot(ut,pt,wt){const Tt=ut.context,St=Tt.gl;if(!pt.dem)return;const It=pt.dem;if(Tt.activeTexture.set(St.TEXTURE1),zt(ut,pt,It),!pt.demTexture)return;pt.demTexture.bind(St.NEAREST,St.CLAMP_TO_EDGE);const Lt=It.dim;Tt.activeTexture.set(St.TEXTURE0);let $t=pt.hillshadeFBO;if(!$t){const ut=new Ye.T(Tt,{width:Lt,height:Lt,data:null},St.RGBA);ut.bind(St.LINEAR,St.CLAMP_TO_EDGE),$t=pt.hillshadeFBO=Tt.createFramebuffer(Lt,Lt,!0,"renderbuffer"),$t.colorAttachment.set(ut.texture)}Tt.bindFramebuffer.set($t.framebuffer),Tt.viewport.set([0,0,Lt,Lt]);const{tileBoundsBuffer:Xt,tileBoundsIndexBuffer:Sr,tileBoundsSegments:Lr}=ut.getMercatorTileBoundsBuffers(),Qr=[];ut.linearFloatFilteringSupported()&&Qr.push("TERRAIN_DEM_FLOAT_FORMAT"),ut.getOrCreateProgram("hillshadePrepare",{defines:Qr}).draw(ut,St.TRIANGLES,Ye.ae.disabled,Ye.ag.disabled,Ye.a.unblended,Ye.af.disabled,((ut,pt)=>{const wt=pt.stride,Tt=Ye.ad.create();return Ye.ad.ortho(Tt,0,Ye.a3,-Ye.a3,0,0,1),Ye.ad.translate(Tt,Tt,[0,-Ye.a3,0]),{u_matrix:Tt,u_image:1,u_dimension:[wt,wt],u_zoom:ut.overscaledZ}})(pt.tileID,It),wt.id,Xt,Sr,Lr),pt.needsHillshadePrepare=!1}function Ft(ut,pt,wt,Tt,St){const n=function(wt,Tt){if(wt)return St(wt);if(Tt){if(ut.url&&Tt.tiles&&ut.tiles&&delete ut.tiles,Tt.variants){if(!Array.isArray(Tt.variants))return St(new Error("variants must be an array"));for(const ut of Tt.variants){if(null==ut||"object"!=typeof ut||ut.constructor!==Object)return St(new Error("variant must be an object"));if(!Array.isArray(ut.capabilities))return St(new Error("capabilities must be an array"));if(1===ut.capabilities.length&&"meshopt"===ut.capabilities[0]){Tt=Ye.W(Tt,ut);break}}}const wt=Ye.ah(Ye.W(Tt,ut),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);Tt.vector_layers&&(wt.vectorLayers=Tt.vector_layers,wt.vectorLayerIds=wt.vectorLayers.map((Ye=>Ye.id))),Tt.raster_layers&&(wt.rasterLayers=Tt.raster_layers,wt.rasterLayerIds=wt.rasterLayers.map((Ye=>Ye.id))),wt.tiles=pt.canonicalizeTileset(wt,ut.url),St(null,wt)}};return ut.url?Ye.g(pt.transformRequest(pt.normalizeSourceURL(ut.url,null,wt,Tt),Ye.R.Source),n):Ye.e.frame((()=>n(null,ut)))}class Bt{constructor(ut,pt,wt){this.bounds=Ye.ai.convert(this.validateBounds(ut)),this.minzoom=pt||0,this.maxzoom=wt||24}validateBounds(Ye){return Array.isArray(Ye)&&4===Ye.length?[Math.max(-180,Ye[0]),Math.max(-90,Ye[1]),Math.min(180,Ye[2]),Math.min(90,Ye[3])]:[-180,-90,180,90]}contains(ut){const pt=Math.pow(2,ut.z),wt=Math.floor(Ye.aj(this.bounds.getWest())*pt),Tt=Math.floor(Ye.ak(this.bounds.getNorth())*pt),St=Math.ceil(Ye.aj(this.bounds.getEast())*pt),It=Math.ceil(Ye.ak(this.bounds.getSouth())*pt);return ut.x>=wt&&ut.x<St&&ut.y>=Tt&&ut.y<It}}class kt extends Ye.E{constructor(ut,pt,wt,Tt){super(),this.id=ut,this.dispatcher=wt,this.setEventedParent(Tt),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Ye.W({type:"raster"},pt),Ye.W(this,Ye.ah(pt,["url","scheme","tileSize"]))}load(ut){this._loaded=!1,this.fire(new Ye.f("dataloading",{dataType:"source"})),this._tileJSONRequest=Ft(this._options,this.map._requestManager,null,null,((pt,wt)=>{this._tileJSONRequest=null,this._loaded=!0,pt?this.fire(new Ye.d(pt)):wt&&(Ye.W(this,wt),wt.bounds&&(this.tileBounds=new Bt(wt.bounds,this.minzoom,this.maxzoom)),Ye.an(wt.tiles),this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"content"}))),ut&&ut(pt)}))}loaded(){return this._loaded}onAdd(Ye){this.map=Ye,this.load()}reload(){this.cancelTileJSONRequest();const ut=Ye.al(this.id,this.scope);this.load((()=>this.map.style.clearSource(ut)))}setTiles(Ye){return this._options.tiles=Ye,this.reload(),this}setUrl(Ye){return this.url=Ye,this._options.url=Ye,this.reload(),this}onRemove(Ye){this.cancelTileJSONRequest()}serialize(){return Ye.W({},this._options)}hasTile(Ye){return!this.tileBounds||this.tileBounds.contains(Ye.canonical)}loadTile(ut,pt){const wt=Ye.e.devicePixelRatio>=2,Tt=this.map._requestManager.normalizeTileURL(ut.tileID.canonical.url(this.tiles,this.scheme),wt,this.tileSize);ut.request=Ye.h(this.map._requestManager.transformRequest(Tt,Ye.R.Tile),((wt,Tt,St,It)=>(delete ut.request,ut.aborted?(ut.state="unloaded",pt(null)):wt?(ut.state="errored",pt(wt)):Tt?(this.map._refreshExpiredTiles&&ut.setExpiryData({cacheControl:St,expires:It}),ut.setTexture(Tt,this.map.painter),ut.state="loaded",Ye.am(this.dispatcher),void pt(null)):pt(null))))}abortTile(Ye,ut){Ye.request&&(Ye.request.cancel(),delete Ye.request),ut&&ut()}unloadTile(ut,pt){ut.texture&&ut.texture instanceof Ye.T?(ut.destroy(!0),ut.texture&&ut.texture instanceof Ye.T&&this.map.painter.saveTileTexture(ut.texture)):ut.destroy(),pt&&pt()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Nt extends Ye.E{constructor(ut,pt,wt,Tt){if(super(),this.id=ut,this.dispatcher=wt,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Ye.W(this,Ye.ah(pt,["url","scheme","tileSize","promoteId"])),this._options=Ye.W({type:"vector"},pt),this._collectResourceTiming=!!pt.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(Tt),this._tileWorkers={},this._deduped=new Ye.ao}load(ut){this._loaded=!1,this.fire(new Ye.f("dataloading",{dataType:"source"}));const pt=Array.isArray(this.map._language)?this.map._language.join():this.map._language,wt=this.map._worldview;this._tileJSONRequest=Ft(this._options,this.map._requestManager,pt,wt,((Tt,St)=>{this._tileJSONRequest=null,this._loaded=!0,Tt?(pt&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${pt}`),wt&&2!==wt.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${wt}`),this.fire(new Ye.d(Tt))):St&&(Ye.W(this,St),St.bounds&&(this.tileBounds=new Bt(St.bounds,this.minzoom,this.maxzoom)),Ye.an(St.tiles,this.map._requestManager._customAccessToken),this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"content"}))),ut&&ut(Tt)}))}loaded(){return this._loaded}hasTile(Ye){return!this.tileBounds||this.tileBounds.contains(Ye.canonical)}onAdd(Ye){this.map=Ye,this.load()}reload(){this.cancelTileJSONRequest();const ut=Ye.al(this.id,this.scope);this.load((()=>this.map.style.clearSource(ut)))}setTiles(Ye){return this._options.tiles=Ye,this.reload(),this}setUrl(Ye){return this.url=Ye,this._options.url=Ye,this.reload(),this}onRemove(Ye){this.cancelTileJSONRequest()}serialize(){return Ye.W({},this._options)}loadTile(ut,pt){const wt=this.map._requestManager.normalizeTileURL(ut.tileID.canonical.url(this.tiles,this.scheme)),Tt=this.map._requestManager.transformRequest(wt,Ye.R.Tile),St=this.map.style?this.map.style.getLut(this.scope):null,It={request:Tt,data:void 0,uid:ut.uid,tileID:ut.tileID,tileZoom:ut.tileZoom,zoom:ut.tileID.overscaledZ,lut:St?{image:St.image.clone()}:null,tileSize:this.tileSize*ut.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:Ye.e.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:ut.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:ut.isExtraShadowCaster,tessellationStep:this.map._tessellationStep};if(It.request.collectResourceTiming=this._collectResourceTiming,ut.actor&&"expired"!==ut.state)"loading"===ut.state?ut.reloadCallback=pt:ut.request=ut.actor.send("reloadTile",It,s.bind(this));else if(ut.actor=this._tileWorkers[wt]=this._tileWorkers[wt]||this.dispatcher.getActor(),this.dispatcher.ready)ut.request=ut.actor.send("loadTile",It,s.bind(this),void 0,!0);else{const pt=Ye.ap.call({deduped:this._deduped},It,((Ye,pt)=>{Ye||!pt?s.call(this,Ye):(It.data={cacheControl:pt.cacheControl,expires:pt.expires,rawData:pt.rawData.slice(0)},ut.actor&&ut.actor.send("loadTile",It,s.bind(this),void 0,!0))}),!0);ut.request={cancel:pt}}function s(wt,Tt){return delete ut.request,ut.aborted?pt(null):wt&&404!==wt.status?pt(wt):(Tt&&Tt.resourceTiming&&(ut.resourceTiming=Tt.resourceTiming),this.map._refreshExpiredTiles&&Tt&&ut.setExpiryData(Tt),ut.loadVectorData(Tt,this.map.painter),Ye.am(this.dispatcher),pt(null),void(ut.reloadCallback&&(this.loadTile(ut,ut.reloadCallback),ut.reloadCallback=null)))}}abortTile(Ye){Ye.request&&(Ye.request.cancel(),delete Ye.request),Ye.actor&&Ye.actor.send("abortTile",{uid:Ye.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(Ye,ut){Ye.actor&&Ye.actor.send("removeTile",{uid:Ye.uid,type:this.type,source:this.id,scope:this.scope}),Ye.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}const Ut=(Ye,ut,pt)=>({u_matrix:Ye,u_image0:0,u_skirt_height:ut,u_ground_shadow_factor:pt}),Gt=(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn)=>({u_proj_matrix:Float32Array.from(Ye),u_globe_matrix:ut,u_normalize_matrix:Float32Array.from(wt),u_merc_matrix:pt,u_zoom_transition:Tt,u_merc_center:St,u_image0:0,u_frustum_tl:It,u_frustum_tr:Lt,u_frustum_br:$t,u_frustum_bl:Xt,u_globe_pos:Sr,u_globe_radius:Lr,u_viewport:Qr,u_grid_matrix:vn?Float32Array.from(vn):new Float32Array(9),u_skirt_height:fn,u_far_z_cutoff:xn});class jt{constructor(Ye=0,ut=0,pt=0,wt=0){if(isNaN(Ye)||Ye<0||isNaN(ut)||ut<0||isNaN(pt)||pt<0||isNaN(wt)||wt<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=Ye,this.bottom=ut,this.left=pt,this.right=wt}interpolate(ut,pt,wt){return null!=pt.top&&null!=ut.top&&(this.top=Ye.a2(ut.top,pt.top,wt)),null!=pt.bottom&&null!=ut.bottom&&(this.bottom=Ye.a2(ut.bottom,pt.bottom,wt)),null!=pt.left&&null!=ut.left&&(this.left=Ye.a2(ut.left,pt.left,wt)),null!=pt.right&&null!=ut.right&&(this.right=Ye.a2(ut.right,pt.right,wt)),this}getCenter(ut,pt){const wt=Ye.at((this.left+ut-this.right)/2,0,ut),Tt=Ye.at((this.top+pt-this.bottom)/2,0,pt);return new Ye.P(wt,Tt)}equals(Ye){return this.top===Ye.top&&this.bottom===Ye.bottom&&this.left===Ye.left&&this.right===Ye.right}clone(){return new jt(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Vt(ut,pt){const wt=Ye.aw(ut,3);Ye.ad.fromQuat(ut,pt),Ye.az(ut,3,wt)}function Wt(ut,pt){const wt=Ye.av.identity([]);return Ye.av.rotateZ(wt,wt,-pt),Ye.av.rotateX(wt,wt,-ut),wt}function Zt(ut,pt){const wt=[ut[0],ut[1],0],Tt=[pt[0],pt[1],0];if(Ye._.length(wt)>=1e-15){const ut=Ye._.normalize([],wt);Ye._.scale(Tt,ut,Ye._.dot(Tt,ut)),pt[0]=Tt[0],pt[1]=Tt[1]}const St=Ye._.cross([],pt,ut);if(Ye._.len(St)<1e-15)return null;const It=Math.atan2(-St[1],St[0]);return Wt(Math.atan2(Math.sqrt(ut[0]*ut[0]+ut[1]*ut[1]),-ut[2]),It)}class qt{constructor(Ye,ut){this.position=Ye,this.orientation=ut}get position(){return this._position}set position(ut){if(ut){const pt=ut instanceof Ye.Y?ut:new Ye.Y(ut[0],ut[1],ut[2]);this._renderWorldCopies&&(pt.x=Ye.au(pt.x,0,1)),this._position=pt}else this._position=null}lookAtPoint(ut,pt){if(this.orientation=null,!this.position)return;const wt=this.position,Tt=this._elevation?this._elevation.getAtPointOrZero(Ye.Y.fromLngLat(ut)):0,St=Ye.Y.fromLngLat(ut,Tt),It=[St.x-wt.x,St.y-wt.y,St.z-wt.z];pt||(pt=[0,0,1]),pt[2]=Math.abs(pt[2]),this.orientation=Zt(It,pt)}setPitchBearing(ut,pt){this.orientation=Wt(Ye.ab(ut),Ye.ab(-pt))}}class Ht{constructor(ut,pt){this._transform=Ye.ad.identity([]),this.orientation=pt,this.position=ut}get mercatorPosition(){const ut=this.position;return new Ye.Y(ut[0],ut[1],ut[2])}get position(){const ut=Ye.aw(this._transform,3);return[ut[0],ut[1],ut[2]]}set position(ut){var pt;ut&&Ye.az(this._transform,3,[(pt=ut)[0],pt[1],pt[2],1])}get orientation(){return this._orientation}set orientation(ut){this._orientation=ut||Ye.av.identity([]),ut&&Vt(this._transform,this._orientation)}getPitchBearing(){const Ye=this.forward(),ut=this.right();return{bearing:Math.atan2(-ut[1],ut[0]),pitch:Math.atan2(Math.sqrt(Ye[0]*Ye[0]+Ye[1]*Ye[1]),-Ye[2])}}setPitchBearing(Ye,ut){this._orientation=Wt(Ye,ut),Vt(this._transform,this._orientation)}forward(){const ut=Ye.aw(this._transform,2);return[-ut[0],-ut[1],-ut[2]]}up(){const ut=Ye.aw(this._transform,1);return[-ut[0],-ut[1],-ut[2]]}right(){const ut=Ye.aw(this._transform,0);return[ut[0],ut[1],ut[2]]}getCameraToWorld(ut,pt){const wt=new Float64Array(16);return Ye.ad.invert(wt,this.getWorldToCamera(ut,pt)),wt}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(ut,pt,wt){const Tt=this.position;Ye._.scale(Tt,Tt,-ut);const St=new Float64Array(16);return Ye.ad.fromScaling(St,[wt,wt,wt]),Ye.ad.translate(St,St,Tt),St[10]*=pt,St}getWorldToCamera(ut,pt){const wt=new Float64Array(16),Tt=new Float64Array(4),St=this.position;return Ye.av.conjugate(Tt,this._orientation),Ye._.scale(St,St,-ut),Ye.ad.fromQuat(wt,Tt),Ye.ad.translate(wt,wt,St),wt[1]*=-1,wt[5]*=-1,wt[9]*=-1,wt[13]*=-1,wt[8]*=pt,wt[9]*=pt,wt[10]*=pt,wt[11]*=pt,wt}getCameraToClipPerspective(ut,pt,wt,Tt){const St=new Float64Array(16);return Ye.ad.perspective(St,ut,pt,wt,Tt),St}getCameraToClipOrthographic(ut,pt,wt,Tt,St,It){const Lt=new Float64Array(16);return Ye.ad.ortho(Lt,ut,pt,wt,Tt,St,It),Lt}getDistanceToElevation(ut,pt=!1){const wt=0===ut?0:Ye.ax(ut,pt?Ye.ay(this.position[1]):this.position[1]),Tt=this.forward();return(wt-this.position[2])/Tt[2]}clone(){return new Ht([...this.position],[...this.orientation])}}const yl={unknown:0,flipRequired:1,flipNotRequired:2},Tl=Math.tan(85*Math.PI/180);function Yt(ut,pt,wt,Tt,St,It,Lt){const $t=Ye.ad.create();if(wt)if("globe"===It.name){const ut=Ye.aB(St,pt);Ye.ad.multiply($t,$t,ut)}else{const ut=Ye.aC.invert([],Lt);$t[0]=ut[0],$t[1]=ut[1],$t[4]=ut[2],$t[5]=ut[3],Tt||Ye.ad.rotateZ($t,$t,St.angle)}else Ye.ad.multiply($t,St.labelPlaneMatrix,ut);return $t}function Kt(Ye,ut,pt,wt,Tt,St,It){const Lt=Yt(Ye,ut,pt,wt,Tt,St,It);return"globe"===St.name&&pt||(Lt[2]=Lt[6]=Lt[10]=Lt[14]=0),Lt}function Qt(ut,pt,wt,Tt,St,It,Lt){if(wt){if("globe"===It.name){const $t=Yt(ut,pt,wt,Tt,St,It,Lt);return Ye.ad.invert($t,$t),Ye.ad.multiply($t,ut,$t),$t}{const pt=Ye.ad.clone(ut),wt=Ye.ad.identity([]);return wt[0]=Lt[0],wt[1]=Lt[1],wt[4]=Lt[2],wt[5]=Lt[3],Ye.ad.multiply(pt,pt,wt),Tt||Ye.ad.rotateZ(pt,pt,-St.angle),pt}}return St.glCoordMatrix}function Jt(ut,pt,wt,Tt){const St=[ut,pt,wt,1];wt?Ye.aA.transformMat4(St,St,Tt):hi(St,St,Tt);const It=St[3];return St[0]/=It,St[1]/=It,St[2]/=It,St}function ei(Ye,ut){return Math.min(.5+Ye/ut*.5,1.5)}function ti(Ye,ut){const pt=Ye[0]/Ye[3],wt=Ye[1]/Ye[3];return pt>=-ut[0]&&pt<=ut[0]&&wt>=-ut[1]&&wt<=ut[1]}function ii(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr){const Lr=wt.transform,Qr=Tt?ut.textSizeData:ut.iconSizeData,fn=Ye.aD(Qr,wt.transform.zoom),xn="globe"===Lr.projection.name,vn=[256/wt.width*2+1,256/wt.height*2+1],kn=Tt?ut.text.dynamicLayoutVertexArray:ut.icon.dynamicLayoutVertexArray;kn.clear();let Wn=null;xn&&(Wn=Tt?ut.text.globeExtVertexArray:ut.icon.globeExtVertexArray);const Xn=ut.lineVertexArray,Jn=Tt?ut.text.placedSymbolArray:ut.icon.placedSymbolArray,Qn=wt.transform.width/wt.transform.height;let ko,Fo=!1;for(let Tt=0;Tt<Jn.length;Tt++){const xn=Jn.get(Tt),{numGlyphs:is,writingMode:ns}=xn;if(ns!==Ye.aE.vertical||Fo||ko===Ye.aE.horizontal||(Fo=!0),ko=ns,(xn.hidden||ns===Ye.aE.vertical)&&!Fo){ci(is,kn);continue}Fo=!1;const ss=new Ye.P(xn.tileAnchorX,xn.tileAnchorY);let{x:as,y:ds,z:ps}=Lr.projection.projectTilePoint(ss.x,ss.y,Sr.canonical);if(Xt){const[Ye,ut,pt]=Xt(ss);as+=Ye,ds+=ut,ps+=pt}const ms=[as,ds,ps,1];if(Ye.aA.transformMat4(ms,ms,pt),!ti(ms,vn)){ci(is,kn);continue}const Js=ms[3],ua=ei(wt.transform.getCameraToCenterDistance(Lr.projection),Js),ba=Ye.aF(Qr,fn,xn),Ra=Lt?ba/ua:ba*ua,La=Jt(as,ds,ps,St);if(La[3]<=0){ci(is,kn);continue}let ll={};const yl=Lt?null:Xt,Tl=ai(xn,Ra,!1,$t,pt,St,It,ut.glyphOffsetArray,Xn,kn,Wn,La,ss,ll,Qn,yl,Lr.projection,Sr,Lt);Fo=Tl.useVertical,yl&&Tl.needsFlipping&&(ll={}),(Tl.notEnoughRoom||Fo||Tl.needsFlipping&&ai(xn,Ra,!0,$t,pt,St,It,ut.glyphOffsetArray,Xn,kn,Wn,La,ss,ll,Qn,yl,Lr.projection,Sr,Lt).notEnoughRoom)&&ci(is,kn)}Tt?(ut.text.dynamicLayoutVertexBuffer.updateData(kn),Wn&&ut.text.globeExtVertexBuffer&&ut.text.globeExtVertexBuffer.updateData(Wn)):(ut.icon.dynamicLayoutVertexBuffer.updateData(kn),Wn&&ut.icon.globeExtVertexBuffer&&ut.icon.globeExtVertexBuffer.updateData(Wn))}function oi(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn){const{lineStartIndex:kn,glyphStartIndex:Wn,segment:Xn}=Lt,Jn=Wn+Lt.numGlyphs,Qn=kn+Lt.lineLength,ko=ut.getoffsetX(Wn),Fo=ut.getoffsetX(Jn-1),is=li(Ye*ko,pt,wt,Tt,St,It,Xn,kn,Qn,$t,Xt,Sr,Lr,Qr,!0,fn,xn,vn);if(!is)return null;const ns=li(Ye*Fo,pt,wt,Tt,St,It,Xn,kn,Qn,$t,Xt,Sr,Lr,Qr,!0,fn,xn,vn);return ns?{first:is,last:ns}:null}function ri(ut,pt,wt,Tt){return ut===Ye.aE.horizontal&&Math.abs(Tt)>Math.abs(wt)?{useVertical:!0}:ut===Ye.aE.vertical?Tt>0?{needsFlipping:!0}:null:pt!==yl.unknown&&function(Ye,ut){return 0===Ye||Math.abs(ut/Ye)>Tl}(wt,Tt)?pt===yl.flipRequired?{needsFlipping:!0}:null:wt<0?{needsFlipping:!0}:null}function ai(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn){const Qn=pt/24,ko=ut.lineOffsetX*Qn,Fo=ut.lineOffsetY*Qn,{lineStartIndex:is,glyphStartIndex:ns,numGlyphs:ss,segment:as,writingMode:ds,flipState:ps}=ut,ms=is+ut.lineLength,A=ut=>{if(Lr){const[pt,wt,Tt]=ut.up,St=Sr.length;Ye.aG(Lr,St+0,pt,wt,Tt),Ye.aG(Lr,St+1,pt,wt,Tt),Ye.aG(Lr,St+2,pt,wt,Tt),Ye.aG(Lr,St+3,pt,wt,Tt)}const[pt,wt,Tt]=ut.point;Ye.aH(Sr,pt,wt,Tt,ut.angle)};if(ss>1){const Ye=oi(Qn,$t,ko,Fo,wt,Qr,fn,ut,Xt,It,xn,kn,!1,Wn,Xn,Jn);if(!Ye)return{notEnoughRoom:!0};if(Tt&&!wt){let[pt,wt,Tt]=Ye.first.point,[St,It,$t]=Ye.last.point;[pt,wt]=Jt(pt,wt,Tt,Lt),[St,It]=Jt(St,It,$t,Lt);const Xt=ri(ds,ps,(St-pt)*vn,It-wt);if(ut.flipState=Xt&&Xt.needsFlipping?yl.flipRequired:yl.flipNotRequired,Xt)return Xt}A(Ye.first);for(let Ye=ns+1;Ye<ns+ss-1;Ye++){const ut=li(Qn*$t.getoffsetX(Ye),ko,Fo,wt,Qr,fn,as,is,ms,Xt,It,xn,kn,!1,!1,Wn,Xn,Jn);if(!ut)return Sr.length-=4*(Ye-ns),{notEnoughRoom:!0};A(ut)}A(Ye.last)}else{if(Tt&&!wt){const pt=Jt(fn.x,fn.y,0,St),wt=is+as+1,Tt=new Ye.P(Xt.getx(wt),Xt.gety(wt)),It=Jt(Tt.x,Tt.y,0,St),Lt=It[3]>0?It:si(fn,Tt,pt,1,St,void 0,Wn,Xn.canonical),$t=ri(ds,ps,(Lt[0]-pt[0])*vn,Lt[1]-pt[1]);if(ut.flipState=$t&&$t.needsFlipping?yl.flipRequired:yl.flipNotRequired,$t)return $t}const pt=li(Qn*$t.getoffsetX(ns),ko,Fo,wt,Qr,fn,as,is,ms,Xt,It,xn,kn,!1,!1,Wn,Xn,Jn);if(!pt)return{notEnoughRoom:!0};A(pt)}return{}}function ni(Ye,ut,pt,wt,Tt){const{x:St,y:It,z:Lt}=wt.projectTilePoint(Ye.x,Ye.y,ut);if(!Tt)return Jt(St,It,Lt,pt);const[$t,Xt,Sr]=Tt(Ye);return Jt(St+$t,It+Xt,Lt+Sr,pt)}function si(ut,pt,wt,Tt,St,It,Lt,$t){const Xt=ni(ut.sub(pt)._unit()._add(ut),$t,St,Lt,It);return Ye._.sub(Xt,wt,Xt),Ye._.normalize(Xt,Xt),Ye._.scaleAndAdd(Xt,wt,Xt,Tt)}function li(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn){const Jn=Tt?ut-pt:ut+pt;let Qn=Jn>0?1:-1,ko=0;Tt&&(Qn*=-1,ko=Math.PI),Qn<0&&(ko+=Math.PI);let Fo=$t+Lt+(Qn>0?0:1)|0,is=St,ns=St,ss=0,as=0;const ds=Math.abs(Jn),ps=[],ms=[];let Js=It,ua=Js;const D=()=>si(ua,Js,ns,ds-ss+1,Lr,fn,kn,Wn.canonical);for(;ss+as<=ds;){if(Fo+=Qn,Fo<$t||Fo>=Xt)return null;if(ns=is,ua=Js,ps.push(ns),xn&&ms.push(ua),Js=new Ye.P(Sr.getx(Fo),Sr.gety(Fo)),is=Qr[Fo],!is){const Ye=ni(Js,Wn.canonical,Lr,kn,fn);is=Ye[3]>0?Qr[Fo]=Ye:D()}ss+=as,as=Ye._.distance(ns,is)}vn&&fn&&(Qr[Fo]&&(is=D(),as=Ye._.distance(ns,is)),Qr[Fo]=is);const ba=(ds-ss)/as,Ra=Js.sub(ua)._mult(ba)._add(ua),La=Ye._.sub([],is,ns),ll=Ye._.scaleAndAdd([],ns,La,ba);let yl=[0,0,1],Tl=La[0],Al=La[1];if(Xn&&(yl=kn.upVector(Wn.canonical,Ra.x,Ra.y),0!==yl[0]||0!==yl[1]||1!==yl[2])){const ut=[yl[2],0,-yl[0]],pt=Ye._.cross([],yl,ut);Ye._.normalize(ut,ut),Ye._.normalize(pt,pt),Tl=Ye._.dot(La,ut),Al=Ye._.dot(La,pt)}if(wt){const ut=Ye._.cross([],yl,La);Ye._.normalize(ut,ut),Ye._.scaleAndAdd(ll,ll,ut,wt*Qn)}const Il=ko+Math.atan2(Al,Tl);return ps.push(ll),xn&&ms.push(Ra),{point:ll,angle:Il,path:ps,tilePath:ms,up:yl}}function ci(Ye,ut){const pt=ut.length,wt=pt+4*Ye;ut.resize(wt),ut.float32.fill(-1/0,4*pt,4*wt)}function hi(Ye,ut,pt){const wt=ut[0],Tt=ut[1];return Ye[0]=pt[0]*wt+pt[4]*Tt+pt[12],Ye[1]=pt[1]*wt+pt[5]*Tt+pt[13],Ye[3]=pt[3]*wt+pt[7]*Tt+pt[15],Ye}const _i=(Ye,ut,pt)=>(1-pt)*Ye+pt*ut,ui=Ye=>Ye*Ye*Ye*Ye*Ye;class di{constructor(ut,pt,wt,Tt,St,It,Lt){this.tileSize=512,this._renderWorldCopies=void 0===St||St,this._minZoom=ut||0,this._maxZoom=pt||22,this._minPitch=wt??0,this._maxPitch=Tt??60,this.setProjection(It),this.setMaxBounds(Lt),this.width=0,this.height=0,this._center=new Ye.aI(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new jt,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Ht,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const Ye=new di(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return Ye._elevation=this._elevation,Ye._centerAltitude=this._centerAltitude,Ye._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,Ye.tileSize=this.tileSize,Ye.mercatorFromTransition=this.mercatorFromTransition,Ye.width=this.width,Ye.height=this.height,Ye.cameraElevationReference=this.cameraElevationReference,Ye._center=this._center,Ye._setZoom(this.zoom),Ye._seaLevelZoom=this._seaLevelZoom,Ye.angle=this.angle,Ye._fov=this._fov,Ye._pitch=this._pitch,Ye._nearZ=this._nearZ,Ye._farZ=this._farZ,Ye._averageElevation=this._averageElevation,Ye._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,Ye._unmodified=this._unmodified,Ye._edgeInsets=this._edgeInsets.clone(),Ye._camera=this._camera.clone(),Ye._calcMatrices(),Ye.freezeTileCoverage=this.freezeTileCoverage,Ye.frustumCorners=this.frustumCorners,Ye}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(Ye){this._elevation!==Ye&&(this._elevation=Ye,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(Ye,ut=!1){const pt=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||pt)&&this._updateCameraOnTerrain(),(Ye||pt)&&this._constrainCamera(ut),this._calcMatrices()}getProjection(){return Ye.ah(this.projection,["name","center","parallels"])}setProjection(ut){this.projectionOptions=ut||{name:"mercator"};const pt=this.projection?this.getProjection():void 0;this.projection=Ye.aJ(this.projectionOptions);const wt=!t(pt,this.getProjection());return wt&&this._calcMatrices(),this.mercatorFromTransition=!1,wt}setOrthographicProjectionAtLowPitch(Ye){return this._orthographicProjectionAtLowPitch!==Ye&&(this._orthographicProjectionAtLowPitch=Ye,this._calcMatrices(),!0)}setMercatorFromTransition(){const ut=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=Ye.aJ({name:"mercator"});const pt=ut!==this.projection.name;return pt&&this._calcMatrices(),pt}get minZoom(){return this._minZoom}set minZoom(Ye){this._minZoom!==Ye&&(this._minZoom=Ye,this.zoom=Math.max(this.zoom,Ye))}get maxZoom(){return this._maxZoom}set maxZoom(Ye){this._maxZoom!==Ye&&(this._maxZoom=Ye,this.zoom=Math.min(this.zoom,Ye))}get minPitch(){return this._minPitch}set minPitch(Ye){this._minPitch!==Ye&&(this._minPitch=Ye,this.pitch=Math.max(this.pitch,Ye))}get maxPitch(){return this._maxPitch}set maxPitch(Ye){this._maxPitch!==Ye&&(this._maxPitch=Ye,this.pitch=Math.min(this.pitch,Ye))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(Ye){void 0===Ye?Ye=!0:null===Ye&&(Ye=!1),this._renderWorldCopies=Ye}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const Ye=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(Ye))}get cameraWorldSize(){const Ye=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(Ye))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return Ye.ax(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new Ye.P(this.width,this.height)}get bearing(){return Ye.au(this.rotation,-180,180)}set bearing(Ye){this.rotation=Ye}get rotation(){return-this.angle/Math.PI*180}set rotation(ut){const pt=-ut*Math.PI/180;this.angle!==pt&&(this._unmodified=!1,this.angle=pt,this._calcMatrices(),this.rotationMatrix=Ye.aC.create(),Ye.aC.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(ut){const pt=Ye.at(ut,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==pt&&(this._unmodified=!1,this._pitch=pt,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const Ye=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/Ye)}set fov(ut){ut=Math.max(.01,Math.min(60,ut)),this._fov!==ut&&(this._unmodified=!1,this._fov=Ye.ab(ut),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(Ye){this._averageElevation=Ye,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(Ye){const ut=Math.min(Math.max(Ye,this.minZoom),this.maxZoom);this._zoom!==ut&&(this._unmodified=!1,this._setZoom(ut),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(Ye){this._zoom=Ye,this.scale=this.zoomScale(Ye),this.tileZoom=Math.floor(Ye),this.zoomFraction=Ye-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(Ye){this._tileCoverLift!==Ye&&(this._tileCoverLift=Ye)}_updateCameraOnTerrain(){const Ye=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,ut=this.elevation&&Ye===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||Ye===Number.NEGATIVE_INFINITY&&(!ut||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const pt=this._elevation;ut||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&pt.exaggeration()&&this._centerAltitudeValidForExaggeration!==pt.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*pt.exaggeration(),this._centerAltitudeValidForExaggeration=pt.exaggeration()):(this._centerAltitude=Ye||0,this._centerAltitudeValidForExaggeration=pt.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const ut=this._elevation,pt=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],wt=this.horizonLineFromTop();let Tt=0,St=0;for(let It=0;It<pt.length;It++){const Lt=new Ye.P(pt[It][0]*this.width,wt+pt[It][1]*(this.height-wt)),$t=ut.pointCoordinate(Lt);if(!$t)continue;const Xt=1/Math.hypot($t[0]-this._camera.position[0],$t[1]-this._camera.position[1]);Tt+=$t[3]*Xt,St+=Xt}return 0===St?NaN:Tt/St}get center(){return this._center}set center(Ye){Ye.lat===this._center.lat&&Ye.lng===this._center.lng||(this._unmodified=!1,this._center=Ye,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const Ye=this._seaLevelZoom,ut=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),pt=this.pixelsPerMeter/this.worldSize*ut,wt=this._mercatorZfromZoom(Ye),Tt=this._mercatorZfromZoom(this._maxZoom),St=Math.max(wt-pt,Tt);this._setZoom(this._zoomFromMercatorZ(St))}get padding(){return this._edgeInsets.toJSON()}set padding(Ye){this._edgeInsets.equals(Ye)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,Ye,1),this._calcMatrices())}computeZoomRelativeTo(ut){const pt=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,ut.toAltitude()));let wt;wt=ut.z<this._camera.position[2]?[pt.x,pt.y,pt.z]:[ut.x,ut.y,ut.z];const Tt=Ye._.length(Ye._.sub([],this._camera.position,wt));return Ye.at(this._zoomFromMercatorZ(Tt),this._minZoom,this._maxZoom)}setFreeCameraOptions(ut){if(!this.height)return;if(!ut.position&&!ut.orientation)return;this._updateCameraState();let pt=!1;if(ut.orientation&&!Ye.av.exactEquals(ut.orientation,this._camera.orientation)&&(pt=this._setCameraOrientation(ut.orientation)),ut.position){const wt=[ut.position.x,ut.position.y,ut.position.z];Ye._.exactEquals(wt,this._camera.position)||(this._setCameraPosition(wt),pt=!0)}pt&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const ut=this._camera.position,pt=new qt;return pt.position=new Ye.Y(ut[0],ut[1],ut[2]),pt.orientation=this._camera.orientation,pt._elevation=this.elevation,pt._renderWorldCopies=this.renderWorldCopies,pt}_setCameraOrientation(ut){if(!Ye.av.length(ut))return!1;Ye.av.normalize(ut,ut);const pt=Ye._.transformQuat([],[0,0,-1],ut),wt=Ye._.transformQuat([],[0,-1,0],ut);if(wt[2]<0)return!1;const Tt=Zt(pt,wt);return!!Tt&&(this._camera.orientation=Tt,!0)}_setCameraPosition(ut){const pt=this.zoomScale(this.minZoom)*this.tileSize,wt=this.zoomScale(this.maxZoom)*this.tileSize,Tt=this.cameraToCenterDistance;ut[2]=Ye.at(ut[2],Tt/wt,Tt/pt),this._camera.position=ut}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(Ye){return this._edgeInsets.equals(Ye)}interpolatePadding(Ye,ut,pt){this._unmodified=!1,this._edgeInsets.interpolate(Ye,ut,pt),this._constrain(),this._calcMatrices()}coveringZoomLevel(Ye){const ut=(Ye.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/Ye.tileSize));return Math.max(0,ut)}getVisibleUnwrappedCoordinates(ut){const pt=[new Ye.aK(0,ut)];if(this.renderWorldCopies){const wt=this.pointCoordinate(new Ye.P(0,0)),Tt=this.pointCoordinate(new Ye.P(this.width,0)),St=this.pointCoordinate(new Ye.P(this.width,this.height)),It=this.pointCoordinate(new Ye.P(0,this.height)),Lt=Math.floor(Math.min(wt.x,Tt.x,St.x,It.x)),$t=Math.floor(Math.max(wt.x,Tt.x,St.x,It.x)),Xt=1;for(let wt=Lt-Xt;wt<=$t+Xt;wt++)0!==wt&&pt.push(new Ye.aK(wt,ut))}return pt}isLODDisabled(Ye){return(!Ye||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(ut,pt,wt){let Tt=[];if(0===pt[0]&&0===pt[1])return Tt;for(const wt of ut){const ut=wt.canonical,St=wt.overscaledZ,It=wt.wrap,Lt=1<<ut.z,$t=ut.x+1<Lt,Xt=ut.x>0,Sr=ut.y+1<Lt,Lr=ut.y>0,Qr=wt.wrap-(Xt?0:1),fn=wt.wrap+($t?0:1),xn=Xt?ut.x-1:Lt-1,vn=$t?ut.x+1:0;pt[0]<0?(Tt.push(new Ye.aL(St,fn,ut.z,vn,ut.y)),pt[1]<0&&Sr&&(Tt.push(new Ye.aL(St,It,ut.z,ut.x,ut.y+1)),Tt.push(new Ye.aL(St,fn,ut.z,vn,ut.y+1))),pt[1]>0&&Lr&&(Tt.push(new Ye.aL(St,It,ut.z,ut.x,ut.y-1)),Tt.push(new Ye.aL(St,fn,ut.z,vn,ut.y-1)))):pt[0]>0?(Tt.push(new Ye.aL(St,Qr,ut.z,xn,ut.y)),pt[1]<0&&Sr&&(Tt.push(new Ye.aL(St,It,ut.z,ut.x,ut.y+1)),Tt.push(new Ye.aL(St,Qr,ut.z,xn,ut.y+1))),pt[1]>0&&Lr&&(Tt.push(new Ye.aL(St,It,ut.z,ut.x,ut.y-1)),Tt.push(new Ye.aL(St,Qr,ut.z,xn,ut.y-1)))):pt[1]<0&&Sr?Tt.push(new Ye.aL(St,It,ut.z,ut.x,ut.y+1)):Lr&&Tt.push(new Ye.aL(St,It,ut.z,ut.x,ut.y-1))}if(Tt.length>1){Tt.sort(((Ye,ut)=>Ye.overscaledZ-ut.overscaledZ||Ye.wrap-ut.wrap||Ye.canonical.z-ut.canonical.z||Ye.canonical.x-ut.canonical.x||Ye.canonical.y-ut.canonical.y));let Ye=0,ut=0;for(;ut<Tt.length;)Tt[ut].equals(Tt[Ye])?++ut:Tt[++Ye]=Tt[ut++];Tt.length=Ye+1}const St=[];for(const Ye of Tt)Tt.some((ut=>Ye.isChildOf(ut)))||St.push(Ye);return Tt=St.filter((Ye=>!ut.some((ut=>!!(Ye.overscaledZ<wt&&ut.isChildOf(Ye))||Ye.equals(ut)||Ye.isChildOf(ut))))),Tt}coveringTiles(ut){let pt=this.coveringZoomLevel(ut);const wt=pt,Tt=this.elevation&&this.elevation.exaggeration(),St=Tt&&!ut.isTerrainDEM,It="mercator"===this.projection.name;if(void 0!==ut.minzoom&&pt<ut.minzoom)return[];void 0!==ut.maxzoom&&pt>ut.maxzoom&&(pt=ut.maxzoom);const Lt=this.locationCoordinate(this.center),$t=this.center.lat,Xt=1<<pt,Sr=[Xt*Lt.x,Xt*Lt.y,0],Lr="globe"===this.projection.name,Qr=!Lr,fn=Ye.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,pt,Qr),xn=Lr?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),vn=Xt*Ye.ax(1,this.center.lat),kn=this._camera.position[2]/Ye.ax(1,this.center.lat),Wn=[Xt*xn.x,Xt*xn.y,kn*(Qr?1:vn)],Xn=Lr||Tt,Jn=this.cameraToCenterDistance/ut.tileSize*(ut.roundZoom?1:.502),Qn=this.isLODDisabled(!0)?pt:0;let ko;if(this._elevation&&ut.isTerrainDEM)ko=1e4*this._elevation.exaggeration();else if(this._elevation){const Ye=this._elevation.getMinMaxForVisibleTiles();ko=Ye?Ye.max:this._centerAltitude}else ko=this._centerAltitude;const Fo=ut.isTerrainDEM?-ko:this._elevation?this._elevation.getMinElevationBelowMSL():0,is=this.projection.isReprojectedInTileSpace?Ye.aN(this):1,E=ut=>{const pt=1/4e4,wt=new Ye.Y(ut.x+pt,ut.y,ut.z),Tt=new Ye.Y(ut.x,ut.y+pt,ut.z),St=ut.toLngLat(),It=wt.toLngLat(),Lt=Tt.toLngLat(),$t=this.locationCoordinate(St),Xt=this.locationCoordinate(It),Sr=this.locationCoordinate(Lt),Lr=Math.hypot(Xt.x-$t.x,Xt.y-$t.y),Qr=Math.hypot(Sr.x-$t.x,Sr.y-$t.y);return Math.sqrt(Lr*Qr)*is/pt},C=ut=>{const pt=ko,wt=Fo;return{aabb:Ye.aQ(this,Xt,0,0,0,ut,wt,pt,this.projection),zoom:0,x:0,y:0,minZ:wt,maxZ:pt,wrap:ut,fullyVisible:!1}},ns=[];let ss=[];const as=pt,ds=ut.reparseOverscaled?wt:pt,ps=(kn-this._centerAltitude)*vn,R=Ye=>{if(!this._elevation||!Ye.tileID||!It)return;const ut=this._elevation.getMinMaxForTile(Ye.tileID),pt=Ye.aabb;ut?(pt.min[2]=ut.min,pt.max[2]=ut.max,pt.center[2]=(pt.min[2]+pt.max[2])/2):(Ye.shouldSplit=M(Ye),Ye.shouldSplit||(pt.min[2]=pt.max[2]=pt.center[2]=this._centerAltitude))},D=(Ye,ut)=>{if(.707*ut<Ye)return 1;const pt=ut/Ye;return pt/(1.4144271570014144+(Math.pow(1.1,pt-1.4144271570014144+1)-1)/(1.1-1)-1)},M=ut=>{if(ut.zoom<Qn)return!0;if(ut.zoom===as)return!1;if(null!=ut.shouldSplit)return ut.shouldSplit;const pt=ut.aabb.distanceX(Wn),Tt=ut.aabb.distanceY(Wn);let Lt=ps,Xt=1;if(Lr){Lt=ut.aabb.distanceZ(Wn);const pt=Math.pow(2,ut.zoom),wt=Ye.ay((ut.y+1)/pt),Tt=Ye.ay(ut.y/pt),St=Math.min(Math.max($t,wt),Tt),It=Ye.b4(St)/Ye.b4($t);if(Xt=St===$t?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,It/this._mercatorScaleRatio),this.zoom<=Ye.b1&&ut.zoom===as-1&&It>=.9)return!0}else if(St&&(Lt=ut.aabb.distanceZ(Wn)*vn),this.projection.isReprojectedInTileSpace&&wt<=5){const pt=Math.pow(2,ut.zoom),wt=E(new Ye.Y((ut.x+.5)/pt,(ut.y+.5)/pt));Xt=wt>.85?1:wt}if(!It){const Ye=Math.sqrt(pt*pt+Tt*Tt+Lt*Lt);let wt=(1<<as-ut.zoom)*Jn*Xt;return wt*=D(Math.max(Lt,ps),Ye),Ye<wt}let Qr=Number.MAX_VALUE,fn=0;const xn=ut.aabb.getCorners(),kn=[];for(const ut of xn){Ye._.sub(kn,ut,Wn),Lr||(St?kn[2]*=vn:kn[2]=ps);const pt=Ye._.dot(kn,this._camera.forward());pt<Qr&&(Qr=pt,fn=Math.abs(kn[2]))}let Xn=(1<<as-ut.zoom)*Jn*Xt;if(Xn*=D(Math.max(fn,ps),Qr),Qr<Xn)return!0;const ko=ut.aabb.closestPoint(Sr);return ko[0]===Sr[0]&&ko[1]===Sr[1]};if(this.renderWorldCopies)for(let Ye=1;Ye<=3;Ye++)ns.push(C(-Ye)),ns.push(C(Ye));for(ns.push(C(0));ns.length>0;){const wt=ns.pop(),Tt=wt.x,Lt=wt.y;let $t=wt.fullyVisible;const u=()=>"globe"===this.projection.name&&(0===wt.y||wt.y===(1<<wt.zoom)-1);if(!$t){let ut=Xn?wt.aabb.intersects(fn):wt.aabb.intersectsFlat(fn);if(0===ut&&u()){const pt=new Ye.aO(wt.zoom,Tt,Lt);ut=Ye.aP(this,Xt,pt,!0).intersects(fn)}if(0===ut)continue;$t=2===ut}if(wt.zoom!==as&&M(wt))for(let ut=0;ut<4;ut++){const pt=(Tt<<1)+ut%2,Sr=(Lt<<1)+(ut>>1),Qr={aabb:It?wt.aabb.quadrant(ut):Ye.aQ(this,Xt,wt.zoom+1,pt,Sr,wt.wrap,wt.minZ,wt.maxZ,this.projection),zoom:wt.zoom+1,x:pt,y:Sr,wrap:wt.wrap,fullyVisible:$t,tileID:void 0,shouldSplit:void 0,minZ:wt.minZ,maxZ:wt.maxZ};St&&!Lr&&(Qr.tileID=new Ye.aL(wt.zoom+1===as?ds:wt.zoom+1,wt.wrap,wt.zoom+1,pt,Sr),R(Qr)),ns.push(Qr)}else{const St=wt.zoom===as?ds:wt.zoom;if(ut.minzoom&&ut.minzoom>St)continue;if(!$t){let ut=Xn?wt.aabb.intersectsPrecise(fn):wt.aabb.intersectsPreciseFlat(fn);if(0===ut&&u()){const pt=new Ye.aO(wt.zoom,Tt,Lt);ut=Ye.aP(this,Xt,pt,!0).intersectsPrecise(fn)}if(0===ut)continue}const It=Sr[0]-(.5+Tt+(wt.wrap<<wt.zoom))*(1<<pt-wt.zoom),Lr=Sr[1]-.5-Lt,Qr=wt.tileID?wt.tileID:new Ye.aL(St,wt.wrap,wt.zoom,Tt,Lt);ss.push({tileID:Qr,distanceSq:It*It+Lr*Lr})}}if(this.fogCullDistSq){const pt=this.fogCullDistSq,wt=this.horizonLineFromTop();ss=ss.filter((Tt=>{const St=[0,0,0,1],It=[Ye.a3,Ye.a3,0,1],Lt=this.calculateFogTileMatrix(Tt.tileID.toUnwrapped());Ye.aA.transformMat4(St,St,Lt),Ye.aA.transformMat4(It,It,Lt);const $t=Ye.aA.min([],St,It),Xt=Ye.aA.max([],St,It),Sr=Ye.aR($t,Xt);if(0===Sr)return!0;let Lr=!1;const Qr=this._elevation;if(Qr&&Sr>pt&&0!==wt){const pt=this.calculateProjMatrix(Tt.tileID.toUnwrapped());let St;ut.isTerrainDEM||(St=Qr.getMinMaxForTile(Tt.tileID)),St||(St={min:Fo,max:ko});const It=Ye.b2(this.rotation),Lt=[It[0]*Ye.a3,It[1]*Ye.a3,St.max];Ye._.transformMat4(Lt,Lt,pt),Lr=(1-Lt[1])*this.height*.5<wt}return Sr<pt||Lr}))}return ss.sort(((Ye,ut)=>Ye.distanceSq-ut.distanceSq)).map((Ye=>Ye.tileID))}resize(Ye,ut){this.width=Ye,this.height=ut,this.pixelsToGLUnits=[2/Ye,-2/ut],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(Ye){return Math.pow(2,Ye)}scaleZoom(Ye){return Math.log(Ye)/Math.LN2}project(ut){const pt=Ye.at(ut.lat,-Ye.aS,Ye.aS),wt=this.projection.project(ut.lng,pt);return new Ye.P(wt.x*this.worldSize,wt.y*this.worldSize)}unproject(Ye){return this.projection.unproject(Ye.x/this.worldSize,Ye.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/Ye.ax(1,this.center.lat)/this.worldSize}setLocationAtPoint(ut,pt){let wt,Tt;const St=this.centerPoint;if("globe"===this.projection.name){const Ye=this.worldSize;wt=(pt.x-St.x)/Ye,Tt=(pt.y-St.y)/Ye}else{const Ye=this.pointCoordinate(pt),ut=this.pointCoordinate(St);wt=Ye.x-ut.x,Tt=Ye.y-ut.y}const It=this.locationCoordinate(ut);this.setLocation(new Ye.Y(It.x-wt,It.y-Tt))}setLocation(Ye){this.center=this.coordinateLocation(Ye),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(Ye){return this.projection.locationPoint(this,Ye)}locationPoint3D(Ye){return this.projection.locationPoint(this,Ye,!0)}pointLocation(Ye){return this.coordinateLocation(this.pointCoordinate(Ye))}pointLocation3D(Ye){return this.coordinateLocation(this.pointCoordinate3D(Ye))}locationCoordinate(ut,pt){const wt=pt?Ye.ax(pt,ut.lat):void 0,Tt=this.projection.project(ut.lng,ut.lat);return new Ye.Y(Tt.x,Tt.y,wt)}coordinateLocation(Ye){return this.projection.unproject(Ye.x,Ye.y)}pointRayIntersection(ut,pt){const wt=null!=pt?pt:this._centerAltitude,Tt=[ut.x,ut.y,0,1],St=[ut.x,ut.y,1,1];Ye.aA.transformMat4(Tt,Tt,this.pixelMatrixInverse),Ye.aA.transformMat4(St,St,this.pixelMatrixInverse);const It=St[3];Ye.aA.scale(Tt,Tt,1/Tt[3]),Ye.aA.scale(St,St,1/It);const Lt=Tt[2],$t=St[2];return{p0:Tt,p1:St,t:Lt===$t?0:(wt-Lt)/($t-Lt)}}screenPointToMercatorRay(ut){const pt=[ut.x,ut.y,0,1],wt=[ut.x,ut.y,1,1];return Ye.aA.transformMat4(pt,pt,this.pixelMatrixInverse),Ye.aA.transformMat4(wt,wt,this.pixelMatrixInverse),Ye.aA.scale(pt,pt,1/pt[3]),Ye.aA.scale(wt,wt,1/wt[3]),pt[2]=Ye.ax(pt[2],this._center.lat)*this.worldSize,wt[2]=Ye.ax(wt[2],this._center.lat)*this.worldSize,Ye.aA.scale(pt,pt,1/this.worldSize),Ye.aA.scale(wt,wt,1/this.worldSize),new Ye.aT([pt[0],pt[1],pt[2]],Ye._.normalize([],Ye._.sub([],wt,pt)))}rayIntersectionCoordinate(ut){const{p0:pt,p1:wt,t:Tt}=ut,St=Ye.ax(pt[2],this._center.lat),It=Ye.ax(wt[2],this._center.lat);return new Ye.Y(Ye.a2(pt[0],wt[0],Tt)/this.worldSize,Ye.a2(pt[1],wt[1],Tt)/this.worldSize,Ye.a2(St,It,Tt))}pointCoordinate(Ye,ut=this._centerAltitude){return this.projection.pointCoordinate(this,Ye.x,Ye.y,ut)}pointCoordinate3D(ut){if(!this.elevation)return this.pointCoordinate(ut);let pt=this.projection.pointCoordinate3D(this,ut.x,ut.y);if(pt)return new Ye.Y(pt[0],pt[1],pt[2]);let wt=0,Tt=this.horizonLineFromTop();if(ut.y>Tt)return this.pointCoordinate(ut);const St=.02*Tt,It=ut.clone();for(let ut=0;ut<10&&Tt-wt>St;ut++){It.y=Ye.a2(wt,Tt,.66);const ut=this.projection.pointCoordinate3D(this,It.x,It.y);ut?(Tt=It.y,pt=ut):wt=It.y}return pt?new Ye.Y(pt[0],pt[1],pt[2]):this.pointCoordinate(ut)}isPointAboveHorizon(Ye){return this.projection.isPointAboveHorizon(this,Ye)}isPointOnSurface(ut){if(ut.y<0||ut.y>this.height||ut.x<0||ut.x>this.width)return!1;if(this.elevation||this.zoom>=Ye.aU)return!this.isPointAboveHorizon(ut);const pt=this.pointCoordinate(ut);return pt.y>=0&&pt.y<=1}_coordinatePoint(ut,pt){const wt=pt&&this.elevation?this.elevation.getAtPointOrZero(ut,this._centerAltitude):this._centerAltitude,Tt=[ut.x*this.worldSize,ut.y*this.worldSize,wt+ut.toAltitude(),1];return Ye.aA.transformMat4(Tt,Tt,this.pixelMatrix),Tt[3]>0?new Ye.P(Tt[0]/Tt[3],Tt[1]/Tt[3]):new Ye.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:ut,left:pt}=this._edgeInsets,wt=this.height-this._edgeInsets.bottom,Tt=this.width-this._edgeInsets.right,St=this.pointLocation3D(new Ye.P(pt,ut)),It=this.pointLocation3D(new Ye.P(Tt,ut)),Lt=this.pointLocation3D(new Ye.P(Tt,wt)),$t=this.pointLocation3D(new Ye.P(pt,wt));let Xt=Math.min(St.lng,It.lng,Lt.lng,$t.lng),Sr=Math.max(St.lng,It.lng,Lt.lng,$t.lng),Lr=Math.min(St.lat,It.lat,Lt.lat,$t.lat),Qr=Math.max(St.lat,It.lat,Lt.lat,$t.lat);const fn=Math.pow(2,-this.zoom)/16*270,xn="globe"===this.projection.name?1:4,f=(ut,pt,wt,Tt,St)=>{const It=(ut+wt)/2,Lt=(pt+Tt)/2,$t=new Ye.P(It,Lt),{lng:vn,lat:kn}=this.pointLocation3D($t),Wn=Math.max(0,Xt-vn,Lr-kn,vn-Sr,kn-Qr);Xt=Math.min(Xt,vn),Sr=Math.max(Sr,vn),Lr=Math.min(Lr,kn),Qr=Math.max(Qr,kn),(St<xn||Wn>fn)&&(f(ut,pt,It,Lt,St+1),f(It,Lt,wt,Tt,St+1))};if(f(pt,ut,Tt,ut,1),f(Tt,ut,Tt,wt,1),f(Tt,wt,pt,wt,1),f(pt,wt,pt,ut,1),"globe"===this.projection.name){const[ut,pt]=Ye.aV(this);ut?(Qr=90,Sr=180,Xt=-180):pt&&(Lr=-90,Sr=180,Xt=-180)}return new Ye.ai(new Ye.aI(Xt,Lr),new Ye.aI(Sr,Qr))}_getBoundsRectangular(ut,pt){const{top:wt,left:Tt}=this._edgeInsets,St=this.height-this._edgeInsets.bottom,It=this.width-this._edgeInsets.right,Lt=new Ye.P(Tt,wt),$t=new Ye.P(It,wt),Xt=new Ye.P(It,St),Sr=new Ye.P(Tt,St);let Lr=this.pointCoordinate(Lt,ut),Qr=this.pointCoordinate($t,ut);const fn=this.pointCoordinate(Xt,pt),xn=this.pointCoordinate(Sr,pt),f=(Ye,ut)=>(ut.y-Ye.y)/(ut.x-Ye.x);return Lr.y>1&&Qr.y>=0?Lr=new Ye.Y((1-xn.y)/f(xn,Lr)+xn.x,1):Lr.y<0&&Qr.y<=1&&(Lr=new Ye.Y(-xn.y/f(xn,Lr)+xn.x,0)),Qr.y>1&&Lr.y>=0?Qr=new Ye.Y((1-fn.y)/f(fn,Qr)+fn.x,1):Qr.y<0&&Lr.y<=1&&(Qr=new Ye.Y(-fn.y/f(fn,Qr)+fn.x,0)),(new Ye.ai).extend(this.coordinateLocation(Lr)).extend(this.coordinateLocation(Qr)).extend(this.coordinateLocation(xn)).extend(this.coordinateLocation(fn))}_getBoundsRectangularTerrain(){const Ye=this.elevation;if(!Ye.visibleDemTiles.length||Ye.isUsingMockSource())return this._getBoundsRectangular(0,0);const ut=Ye.visibleDemTiles.reduce(((Ye,ut)=>{if(ut.dem){const pt=ut.dem.tree;Ye.min=Math.min(Ye.min,pt.minimums[0]),Ye.max=Math.max(Ye.max,pt.maximums[0])}return Ye}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(ut.min*Ye.exaggeration(),ut.max*Ye.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(Ye=!0){const ut=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,pt=this.height/2-ut*(1-this._horizonShift);return Ye?Math.max(0,pt):pt}getMaxBounds(){return this.maxBounds}setMaxBounds(ut){this.maxBounds=ut,this.minLat=-Ye.aS,this.maxLat=Ye.aS,this.minLng=-180,this.maxLng=180,ut&&(this.minLat=ut.getSouth(),this.maxLat=ut.getNorth(),this.minLng=ut.getWest(),this.maxLng=ut.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=Ye.aj(this.minLng)*this.tileSize,this.worldMaxX=Ye.aj(this.maxLng)*this.tileSize,this.worldMinY=Ye.ak(this.maxLat)*this.tileSize,this.worldMaxY=Ye.ak(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(Ye,ut){return this.projection.createTileMatrix(this,ut,Ye)}calculateDistanceTileData(ut){const pt=ut.key,wt=this._distanceTileDataCache;if(wt[pt])return wt[pt];const Tt=ut.canonical,St=1/this.height,It=this.cameraWorldSize,Lt=It/this.zoomScale(Tt.z),$t=(Tt.x+Math.pow(2,Tt.z)*ut.wrap)*Lt,Xt=Tt.y*Lt,Sr=this.point;Sr.x*=It/this.worldSize,Sr.y*=It/this.worldSize;const Lr=this.angle,Qr=Math.sin(-Lr),fn=-Math.cos(-Lr);return wt[pt]={bearing:[Qr,fn],center:[(Sr.x-$t)*St,(Sr.y-Xt)*St],scale:Lt/Ye.a3*St},wt[pt]}calculateFogTileMatrix(ut){const pt=ut.key,wt=this._fogTileMatrixCache;if(wt[pt])return wt[pt];const Tt=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,ut);return Ye.ad.multiply(Tt,this.worldToFogMatrix,Tt),wt[pt]=new Float32Array(Tt),wt[pt]}calculateProjMatrix(ut,pt=!1,wt=!1){const Tt=ut.key;let St;if(St=wt?this._expandedProjMatrixCache:pt?this._alignedProjMatrixCache:this._projMatrixCache,St[Tt])return St[Tt];const It=this.calculatePosMatrix(ut,this.worldSize);let Lt;return Lt=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:wt?this.expandedFarZProjMatrix:pt?this.alignedProjMatrix:this.projMatrix,Ye.ad.multiply(It,Lt,It),St[Tt]=new Float32Array(It),St[Tt]}calculatePixelsToTileUnitsMatrix(ut){const pt=ut.tileID.key,wt=this._pixelsToTileUnitsCache;if(wt[pt])return wt[pt];const Tt=Ye.aW(ut,this);return wt[pt]=Tt,wt[pt]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const ut=1/this.worldSize,pt=Ye.ad.fromScaling([],[ut,ut,ut]);return Ye.ad.multiply(pt,pt,this.globeMatrix),pt}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const ut=this._elevation;this._updateCameraState();const pt=Ye.ax(1,this._center.lat)*this.worldSize,wt=this._computeCameraPosition(pt),Tt=this._camera.forward(),St=Ye.ax(1,this._center.lat);wt[2]/=St,Tt[2]/=St,Ye._.normalize(Tt,Tt);const It=ut.raycast(wt,Tt,ut.exaggeration());if(It){const ut=Ye._.scaleAndAdd([],wt,Tt,It),pt=new Ye.Y(ut[0],ut[1],Ye.ax(ut[2],Ye.ay(ut[1]))),Lt=(pt.z+Ye._.length([pt.x-wt[0],pt.y-wt[1],pt.z-wt[2]*St]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(Lt),this._centerAltitude=pt.toAltitude(),this._center=this.coordinateLocation(pt),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(ut=!1){if(!this._elevation)return;const pt=this._elevation,wt=Ye.ax(1,this._center.lat)*this.worldSize,Tt=this._computeCameraPosition(wt),St=pt.getAtPointOrZero(new Ye.Y(...Tt)),It=this.pixelsPerMeter/this.worldSize*St,Lt=this._minimumHeightOverTerrain(),$t=Tt[2]-It;if($t<=Lt)if($t<0||ut){const ut=this.locationCoordinate(this._center,this._centerAltitude),pt=[Tt[0],Tt[1],ut.z-Tt[2]],wt=Ye._.length(pt);pt[2]-=(Lt-$t)/this._pixelsPerMercatorPixel;const St=Ye._.length(pt);if(0===St)return;Ye._.scale(pt,pt,wt/St*this._pixelsPerMercatorPixel),this._camera.position=[Tt[0],Tt[1],ut.z*this._pixelsPerMercatorPixel-pt[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const ut="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||ut){const pt=this.center;return pt.lat=Ye.at(pt.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!ut)&&(pt.lng=Ye.at(pt.lng,this.minLng,this.maxLng)),this.center=pt,void(this._constraining=!1)}const pt=this._unmodified,{x:wt,y:Tt}=this.point;let St=0,It=wt,Lt=Tt;const $t=this.width/2,Xt=this.height/2,Sr=this.worldMinY*this.scale,Lr=this.worldMaxY*this.scale;if(Tt-Xt<Sr&&(Lt=Sr+Xt),Tt+Xt>Lr&&(Lt=Lr-Xt),Lr-Sr<this.height&&(St=Math.max(St,this.height/(Lr-Sr)),Lt=(Lr+Sr)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const Ye=this.worldMinX*this.scale,ut=this.worldMaxX*this.scale,pt=this.worldSize/2-(Ye+ut)/2;It=(wt+pt+this.worldSize)%this.worldSize-pt,It-$t<Ye&&(It=Ye+$t),It+$t>ut&&(It=ut-$t),ut-Ye<this.width&&(St=Math.max(St,this.width/(ut-Ye)),It=(ut+Ye)/2)}It===wt&&Lt===Tt||(this.center=this.unproject(new Ye.P(It,Lt))),St&&(this.zoom+=this.scaleZoom(St)),this._constrainCamera(),this._unmodified=pt,this._constraining=!1}_minZoomForBounds(){let Ye=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(Ye=Math.max(Ye,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),Ye}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const ut=this.centerOffset,pt="globe"===this.projection.name,wt=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=Ye.ax(1,this.center.lat)/Ye.ax(1,Ye.b3));const Tt=Ye.aX(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,Tt),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const St="meters"===this.projection.zAxisUnit?wt:1,It=this._camera.getWorldToCamera(this.worldSize,St);let Lt;const $t=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if($t[8]=2*-ut.x/this.width,$t[9]=2*ut.y/this.height,this.isOrthographic){let Ye=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),pt=Ye*this.aspect,wt=-pt,Tt=-Ye;pt-=ut.x,wt-=ut.x,Ye+=ut.y,Tt+=ut.y,Lt=this._camera.getCameraToClipOrthographic(wt,pt,Tt,Ye,this._nearZ,this._farZ),((Ye,ut,pt,wt)=>{for(let Tt=0;Tt<16;Tt++)Ye[Tt]=_i(ut[Tt],pt[Tt],wt)})(Lt,Lt,$t,ui(this.pitch>=15?1:this.pitch/15))}else Lt=$t;const Xt=Ye.ad.mul([],$t,It);let Sr=Ye.ad.mul([],Lt,It);if(this.projection.isReprojectedInTileSpace){const ut=this.locationCoordinate(this.center),pt=Ye.ad.identity([]);Ye.ad.translate(pt,pt,[ut.x*this.worldSize,ut.y*this.worldSize,0]),Ye.ad.multiply(pt,pt,Ye.aY(this)),Ye.ad.translate(pt,pt,[-ut.x*this.worldSize,-ut.y*this.worldSize,0]),Ye.ad.multiply(Sr,Sr,pt),Ye.ad.multiply(Xt,Xt,pt),this.inverseAdjustmentMatrix=Ye.aZ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=Ye.ad.scale([],Sr,[this.worldSize,this.worldSize,this.worldSize/St,1]),this.projMatrix=Sr,this.invProjMatrix=Ye.ad.invert(new Float64Array(16),this.projMatrix),pt){const pt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);pt[8]=2*-ut.x/this.width,pt[9]=2*ut.y/this.height,this.expandedFarZProjMatrix=Ye.ad.mul([],pt,It)}else this.expandedFarZProjMatrix=this.projMatrix;const Lr=Ye.ad.invert([],Lt);this.frustumCorners=Ye.a_.fromInvProjectionMatrix(Lr,this.horizonLineFromTop(),this.height),this.cameraFrustum=Ye.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!pt);const Qr=new Float32Array(16);Ye.ad.identity(Qr),Ye.ad.scale(Qr,Qr,[1,-1,1]),Ye.ad.rotateX(Qr,Qr,this._pitch),Ye.ad.rotateZ(Qr,Qr,this.angle);const fn=Ye.ad.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=Ye.ad.clone(fn);const xn=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;fn[8]=2*-ut.x/this.width,fn[9]=2*(ut.y+xn)/this.height,this.skyboxMatrix=Ye.ad.multiply(Qr,fn,Qr);const vn=this.point,kn=vn.x,Wn=vn.y,Xn=this.width%2/2,Jn=this.height%2/2,Qn=Math.cos(this.angle),ko=Math.sin(this.angle),Fo=kn-Math.round(kn)+Qn*Xn+ko*Jn,is=Wn-Math.round(Wn)+Qn*Jn+ko*Xn,ns=new Float64Array(Sr);if(Ye.ad.translate(ns,ns,[Fo>.5?Fo-1:Fo,is>.5?is-1:is,0]),this.alignedProjMatrix=ns,Sr=Ye.ad.create(),Ye.ad.scale(Sr,Sr,[this.width/2,-this.height/2,1]),Ye.ad.translate(Sr,Sr,[1,-1,0]),this.labelPlaneMatrix=Sr,Sr=Ye.ad.create(),Ye.ad.scale(Sr,Sr,[1,-1,1]),Ye.ad.translate(Sr,Sr,[-1,-1,0]),Ye.ad.scale(Sr,Sr,[2/this.width,2/this.height,1]),this.glCoordMatrix=Sr,this.pixelMatrix=Ye.ad.multiply(new Float64Array(16),this.labelPlaneMatrix,Xt),this._calcFogMatrices(),this._distanceTileDataCache={},Sr=Ye.ad.invert(new Float64Array(16),this.pixelMatrix),!Sr)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=Sr,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=Ye.a$(this);const ut=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=Ye._.transformMat4(ut,ut,It),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=Sr;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const ut=this.cameraWorldSizeForFog,pt=this.cameraPixelsPerMeter,wt=this._camera.position,Tt=1/this.height/this._pixelsPerMercatorPixel,St=[ut,ut,pt];Ye._.scale(St,St,Tt),Ye._.scale(wt,wt,-1),Ye._.multiply(wt,wt,St);const It=Ye.ad.create();Ye.ad.translate(It,It,wt),Ye.ad.scale(It,It,St),this.mercatorFogMatrix=It,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(ut,pt,Tt)}_computeCameraPosition(Ye){const ut=(Ye=Ye||this.pixelsPerMeter)/this.pixelsPerMeter,pt=this._camera.forward(),wt=this.point,Tt=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*ut-Ye/this.worldSize*this._centerAltitude;return[wt.x/this.worldSize-pt[0]*Tt,wt.y/this.worldSize-pt[1]*Tt,Ye/this.worldSize*this._centerAltitude-pt[2]*Tt]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(ut){const pt=this._maxCameraBoundsDistance()*Math.cos(this._pitch),wt=this._camera.position[2],Tt=ut[2];let St=1;this.projection.wrap&&(this.center=this.center.wrap()),Tt>0&&(St=Math.min((pt-wt)/Tt,1)),this._camera.position=Ye._.scaleAndAdd([],this._camera.position,ut,St),this._updateStateFromCamera()}_updateStateFromCamera(){const ut=this._camera.position,pt=this._camera.forward(),{pitch:wt,bearing:Tt}=this._camera.getPitchBearing(),St=Ye.ax(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,It=this._mercatorZfromZoom(this._maxZoom)*Math.cos(Ye.ab(this._maxPitch)),Lt=Math.max((ut[2]-St)/Math.cos(wt),It),$t=this._zoomFromMercatorZ(Lt);Ye._.scaleAndAdd(ut,ut,pt,Lt),this._pitch=Ye.at(wt,Ye.ab(this.minPitch),Ye.ab(this.maxPitch)),this.angle=Ye.au(Tt,-Math.PI,Math.PI),this._setZoom(Ye.at($t,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new Ye.Y(ut[0],ut[1],ut[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(Ye){return Math.pow(2,Ye)*this.tileSize}_mercatorZfromZoom(Ye){return this.cameraToCenterDistance/this._worldSizeFromZoom(Ye)}_minimumHeightOverTerrain(){const Ye=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(Ye)}_zoomFromMercatorZ(Ye){return this.scaleZoom(this.cameraToCenterDistance/(Ye*this.tileSize))}zoomFromMercatorZAdjusted(ut){let pt=0,wt=Ye.aU,Tt=0,St=1/0;for(;wt-pt>1e-6&&wt>pt;){const Ye=pt+.5*(wt-pt),It=this.tileSize*Math.pow(2,Ye),Lt=this.getCameraToCenterDistance(this.projection,Ye,It),$t=this.scaleZoom(Lt/(ut*this.tileSize)),Xt=Math.abs(Ye-$t);Xt<St&&(St=Xt,Tt=Ye),Ye<$t?pt=Ye:wt=Ye}return Tt}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(Ye.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(ut,pt){const wt=Math.min(ut.x,pt.x),Tt=Math.max(ut.x,pt.x),St=Math.min(ut.y,pt.y),It=Math.max(ut.y,pt.y);if(St<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const Lt=[new Ye.P(wt,St),new Ye.P(Tt,It),new Ye.P(wt,It),new Ye.P(Tt,St)],$t=this.renderWorldCopies?-3:0,Xt=this.renderWorldCopies?4:1;for(const Ye of Lt){const ut=this.pointRayIntersection(Ye);if(ut.t<0)return!0;const pt=this.rayIntersectionCoordinate(ut);if(pt.x<$t||pt.y<0||pt.x>Xt||pt.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+Ye.b0(this.fovAboveCenter)>88||this.anyCornerOffEdge(new Ye.P(0,0),new Ye.P(this.width,this.height))}zoomDeltaToMovement(ut,pt){const wt=Ye._.length(Ye._.sub([],this._camera.position,ut)),Tt=this._zoomFromMercatorZ(wt)+pt;return wt-this._mercatorZfromZoom(Tt)}getCameraPoint(){if("globe"===this.projection.name){const ut=function([ut,pt,wt],Tt){const St=[ut,pt,wt,1];Ye.aA.transformMat4(St,St,Tt);const It=St[3]=Math.max(St[3],1e-6);return St[0]/=It,St[1]/=It,St[2]/=It,St}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new Ye.P(ut[0],ut[1])}{const ut=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new Ye.P(0,ut))}}getCameraToCenterDistance(ut,pt=this.zoom,wt=this.worldSize){const Tt=Ye.aX(ut,pt,this.width,this.height,1024),St=ut.pixelSpaceConversion(this.center.lat,wt,Tt);let It=.5/Math.tan(.5*this._fov)*this.height*St;return this.isOrthographic&&(It=_i(1,It,ui(this.pitch>=15?1:this.pitch/15))),It}getWorldToCameraMatrix(){const ut=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&Ye.ad.multiply(ut,ut,this.globeMatrix),ut}getFrustum(ut){return Ye.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,ut,"meters"===this.projection.zAxisUnit)}}const Al={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11},fi=(ut,pt)=>{if(pt>0&&ut.terrain&&Ye.w("Cutoff is currently disabled on terrain"),pt<=0||ut.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const wt=ut.transform,Tt=Math.max(Math.abs(wt._zoom-(ut.minCutoffZoom-1)),1),St=wt.isLODDisabled(!1)?Ye.$(60,45,wt.pitch):Ye.$(30,15,wt.pitch),It=wt._farZ-wt._nearZ,Lt=pt*wt.height,$t=((1-(Xt=St))*wt.cameraToCenterDistance+Xt*(wt._farZ+Lt))*Tt;var Xt;return{shouldRenderCutoff:St<1,uniformValues:{u_cutoff_params:[wt._nearZ,wt._farZ,($t-wt._nearZ)/It,($t-Lt-wt._nearZ)/It]}}},Il={cascadeCount:2,shadowMapResolution:2048};class gi{constructor(Ye,ut){this.aabb=Ye,this.lastCascade=ut}}class vi{add(Ye,ut){const pt=this.receivers[Ye.key];void 0!==pt?(pt.aabb.min[0]=Math.min(pt.aabb.min[0],ut.min[0]),pt.aabb.min[1]=Math.min(pt.aabb.min[1],ut.min[1]),pt.aabb.min[2]=Math.min(pt.aabb.min[2],ut.min[2]),pt.aabb.max[0]=Math.max(pt.aabb.max[0],ut.max[0]),pt.aabb.max[1]=Math.max(pt.aabb.max[1],ut.max[1]),pt.aabb.max[2]=Math.max(pt.aabb.max[2],ut.max[2])):this.receivers[Ye.key]=new gi(ut,null)}clear(){this.receivers={}}get(Ye){return this.receivers[Ye.key]}computeRequiredCascades(ut,pt,wt){const Tt=Ye.b6.fromPoints(ut.points);let St=0;for(const ut in this.receivers){const It=this.receivers[ut];if(!It)continue;if(!Tt.intersectsAabb(It.aabb))continue;It.aabb.min=Tt.closestPoint(It.aabb.min),It.aabb.max=Tt.closestPoint(It.aabb.max);const Lt=It.aabb.getCorners();for(let ut=0;ut<wt.length;ut++){let Tt=!0;for(const St of Lt){const It=[St[0]*pt,St[1]*pt,St[2]];if(Ye._.transformMat4(It,It,wt[ut].matrix),It[0]<-1||It[0]>1||It[1]<-1||It[1]>1){Tt=!1;break}}if(It.lastCascade=ut,St=Math.max(St,ut),Tt)break}}return St+1}}class xi{constructor(ut){this.painter=ut,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new vi,this._depthMode=new Ye.ae(ut.context.gl.LEQUAL,Ye.ae.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,ut.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),ut.tp.registerParameter(Il,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),ut.tp.registerParameter(Il,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),ut.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const Ye of this._cascades)Ye.texture.destroy(),Ye.framebuffer.destroy();this._cascades=[]}updateShadowParameters(ut,pt){const wt=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!pt||!pt.properties)return;const Tt=pt.properties.get("shadow-intensity");if(!pt.shadowsEnabled()||Tt<=0)return;if(this._shadowLayerCount=wt.style.order.reduce(((Ye,pt)=>{const Tt=wt.style._mergedLayers[pt];return Ye+(Tt.hasShadowPass()&&!Tt.isHidden(ut.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled)return;const St=wt.context,It=Il.shadowMapResolution,Lt=Il.shadowMapResolution;if(0===this._cascades.length||Il.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let ut=0;ut<Il.cascadeCount;++ut){const ut=wt._shadowMapDebug,pt=St.gl,Tt=St.createFramebuffer(It,Lt,ut,"texture"),$t=new Ye.T(St,{width:It,height:Lt,data:null},pt.DEPTH_COMPONENT);if(Tt.depthAttachment.set($t.texture),ut){const ut=new Ye.T(St,{width:It,height:Lt,data:null},pt.RGBA);Tt.colorAttachment.set(ut.texture)}this._cascades.push({framebuffer:Tt,texture:$t,matrix:[],far:0,boundingSphereRadius:0,frustum:new Ye.aM,scale:0})}}this.shadowDirection=bi(pt);let $t=0;if(ut.elevation){const Ye=ut.elevation,pt=[1e4,-1e4];Ye.visibleDemTiles.filter((Ye=>Ye.dem)).forEach((Ye=>{const ut=Ye.dem.tree;pt[0]=Math.min(pt[0],ut.minimums[0]),pt[1]=Math.max(pt[1],ut.maximums[0])})),1e4!==pt[0]&&($t=(pt[1]-pt[0])*Ye.exaggeration())}const Xt=1.5*ut.cameraToCenterDistance,Sr=3*Xt,Lr=new Float64Array(16);for(let pt=0;pt<this._cascades.length;++pt){const wt=this._cascades[pt];let Tt=ut.height/50,St=1;1===Il.cascadeCount?St=Sr:0===pt?St=Xt:(Tt=Xt,St=Sr);const[It,Lt]=Ti(ut,this.shadowDirection,Tt,St,Il.shadowMapResolution,$t);wt.scale=ut.scale,wt.matrix=It,wt.boundingSphereRadius=Lt,Ye.ad.invert(Lr,wt.matrix),wt.frustum=Ye.aM.fromInvProjectionMatrix(Lr,1,0,!0),wt.far=St}const Qr=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[Qr].far,this._cascades[Qr].far],this._uniformValues.u_shadow_intensity=Tt,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Il.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Il.shadowMapResolution,this._uniformValues.u_shadowmap_0=Al.ShadowMap0,this._uniformValues.u_shadowmap_1=Al.ShadowMap0+1,this._groundShadowTiles=wt.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const fn=wt.transform.elevation;for(const Ye of this._groundShadowTiles){let ut={min:0,max:0};if(fn){const pt=fn.getMinMaxForTile(Ye);pt&&(ut=pt)}this.addShadowReceiver(Ye.toUnwrapped(),ut.min,ut.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(Ye){this._enabled=Ye}drawShadowPass(ut,pt){if(!this.enabled)return;const wt=this.painter,Tt=wt.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(wt.transform.getFrustum(0),wt.transform.worldSize,this._cascades),Tt.viewport.set([0,0,Il.shadowMapResolution,Il.shadowMapResolution]);for(let St=0;St<this._numCascadesToRender;++St){wt.currentShadowCascade=St,Tt.bindFramebuffer.set(this._cascades[St].framebuffer.framebuffer),Tt.clear({color:Ye.C.white,depth:1});for(const Ye of ut.order){const Tt=ut._mergedLayers[Ye];if(!Tt.hasShadowPass()||Tt.isHidden(wt.transform.zoom))continue;const St=ut.getLayerSourceCache(Tt),It=St?pt[St.id]:void 0;("model"===Tt.type||It&&It.length)&&wt.renderLayer(wt,St,Tt,It)}}wt.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const ut=this.painter,pt=ut.style,wt=ut.context,Tt=pt.directionalLight,St=pt.ambientLight;if(!Tt||!St)return;const It=[],Lt=fi(ut,ut.longestCutoffRange);Lt.shouldRenderCutoff&&It.push("RENDER_CUTOFF");const $t=wi(pt,Tt,St),Xt=new Ye.ae(wt.gl.LEQUAL,Ye.ae.ReadOnly,ut.depthRangeFor3D);for(const pt of this._groundShadowTiles){const Tt=pt.toUnwrapped(),St=ut.isTileAffectedByFog(pt),Sr=ut.getOrCreateProgram("groundShadow",{defines:It,overrideFog:St});this.setupShadows(Tt,Sr),ut.uploadCommonUniforms(wt,Sr,Tt,null,Lt);const Lr={u_matrix:ut.transform.calculateProjMatrix(Tt),u_ground_shadow_factor:$t};Sr.draw(ut,wt.gl.TRIANGLES,Xt,Ye.ag.disabled,Ye.a.multiply,Ye.af.disabled,Lr,"ground_shadow",ut.tileExtentBuffer,ut.quadTriangleIndexBuffer,ut.tileExtentSegments,{},ut.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Ye.a.unblended:Ye.a.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(ut){const pt=this.painter.transform,wt=pt.calculatePosMatrix(ut,pt.worldSize);return Ye.ad.multiply(wt,this._cascades[this.painter.currentShadowCascade].matrix,wt),Float32Array.from(wt)}calculateShadowPassMatrixFromMatrix(ut){return Ye.ad.multiply(ut,this._cascades[this.painter.currentShadowCascade].matrix,ut),Float32Array.from(ut)}setupShadows(ut,pt,wt,Tt=0){if(!this.enabled)return;const St=this.painter.transform,It=this.painter.context,Lt=It.gl,$t=this._uniformValues,Xt=new Float64Array(16),Sr=St.calculatePosMatrix(ut,St.worldSize);for(let ut=0;ut<this._cascades.length;ut++)Ye.ad.multiply(Xt,this._cascades[ut].matrix,Sr),$t[0===ut?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(Xt),It.activeTexture.set(Lt.TEXTURE0+Al.ShadowMap0+ut),this._cascades[ut].texture.bind(Lt.NEAREST,Lt.CLAMP_TO_EDGE);if(this.useNormalOffset=!!wt,this.useNormalOffset){const pt=Ye.b5(ut.canonical),It=2/St.tileSize*Ye.a3/Il.shadowMapResolution,Lt=It*this._cascades[0].boundingSphereRadius,Xt=It*this._cascades[this._cascades.length-1].boundingSphereRadius,Sr=("vector-tile"===wt?1:3)/Math.pow(2,Tt-ut.canonical.z-(1-St.zoom+Math.floor(St.zoom)));$t.u_shadow_normal_offset=[pt,Lt*Sr,Xt*Sr],$t.u_shadow_bias=[6e-5,.0012,.012]}else $t.u_shadow_bias=[36e-5,.0012,.012];pt.setShadowUniformValues(It,$t)}setupShadowsFromMatrix(ut,pt,wt=!1){if(!this.enabled)return;const Tt=this.painter.context,St=Tt.gl,It=this._uniformValues,Lt=new Float64Array(16);for(let pt=0;pt<Il.cascadeCount;pt++)Ye.ad.multiply(Lt,this._cascades[pt].matrix,ut),It[0===pt?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(Lt),Tt.activeTexture.set(St.TEXTURE0+Al.ShadowMap0+pt),this._cascades[pt].texture.bind(St.NEAREST,St.CLAMP_TO_EDGE);if(this.useNormalOffset=wt,wt){const Ye=5;It.u_shadow_normal_offset=[1,Ye,Ye],It.u_shadow_bias=[6e-5,.0012,.012]}else It.u_shadow_bias=[36e-5,.0012,.012];pt.setShadowUniformValues(Tt,It)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(ut,pt,wt,Tt){if(Tt[2]>=0)return{};const St=function(ut,pt,wt){const Tt=wt/(1<<ut.canonical.z);return new Ye.b6([ut.canonical.x*Tt+ut.wrap*wt,ut.canonical.y*Tt+ut.wrap*wt,0],[(ut.canonical.x+1)*Tt+ut.wrap*wt,(ut.canonical.y+1)*Tt+ut.wrap*wt,pt])}(ut,pt,wt).getCorners(),It=pt/-Tt[2];Tt[0]<0?(Ye._.add(St[0],St[0],[Tt[0]*It,0,0]),Ye._.add(St[3],St[3],[Tt[0]*It,0,0])):Tt[0]>0&&(Ye._.add(St[1],St[1],[Tt[0]*It,0,0]),Ye._.add(St[2],St[2],[Tt[0]*It,0,0])),Tt[1]<0?(Ye._.add(St[0],St[0],[0,Tt[1]*It,0]),Ye._.add(St[1],St[1],[0,Tt[1]*It,0])):Tt[1]>0&&(Ye._.add(St[2],St[2],[0,Tt[1]*It,0]),Ye._.add(St[3],St[3],[0,Tt[1]*It,0]));const Lt={};return Lt.vertices=St,Lt.planes=[yi(St[1],St[0],St[4]),yi(St[2],St[1],St[5]),yi(St[3],St[2],St[6]),yi(St[0],St[3],St[7])],Lt}addShadowReceiver(ut,pt,wt){this._receivers.add(ut,Ye.b6.fromTileIdAndHeight(ut,pt,wt))}getMaxCascadeForTile(Ye){const ut=this._receivers.get(Ye);return ut&&ut.lastCascade?ut.lastCascade:0}}function yi(ut,pt,wt){const Tt=Ye._.sub([],wt,pt),St=Ye._.sub([],ut,pt),It=Ye._.cross([],Tt,St),Lt=Ye._.length(It);return 0===Lt?[0,0,1,0]:(Ye._.scale(It,It,1/Lt),[It[0],It[1],It[2],-Ye._.dot(It,pt)])}function bi(ut){const pt=ut.properties.get("direction"),wt=Ye.ac(pt.x,pt.y,pt.z);wt[2]=Ye.at(wt[2],0,75);const Tt=Ye.b7([wt[0],wt[1],wt[2]]);return Ye._.fromValues(Tt.x,Tt.y,Tt.z)}function wi(ut,pt,wt){const Tt=pt.properties.get("color"),St=pt.properties.get("intensity"),It=pt.properties.get("direction"),Lt=[It.x,It.y,It.z],$t=wt.properties.get("color"),Xt=wt.properties.get("intensity"),Sr=Math.max(Ye._.dot([0,0,1],Lt),0),Lr=[0,0,0];Ye._.scale(Lr,$t.toRenderColor(ut.getLut(pt.scope)).toArray01Linear().slice(0,3),Xt);const Qr=[0,0,0];return Ye._.scale(Qr,Tt.toRenderColor(ut.getLut(wt.scope)).toArray01Linear().slice(0,3),Sr*St),Ye.b8([Lr[0]>0?Lr[0]/(Lr[0]+Qr[0]):0,Lr[1]>0?Lr[1]/(Lr[1]+Qr[1]):0,Lr[2]>0?Lr[2]/(Lr[2]+Qr[2]):0])}function Ti(ut,pt,wt,Tt,St,It){const Lt=ut.zoom,$t=ut.scale,Xt=ut.worldSize,Sr=1/Xt,Lr=ut.aspect,Qr=Math.sqrt(1+Lr*Lr)*Math.tan(.5*ut.fovX),fn=Qr*Qr,xn=Tt-wt,vn=Tt+wt;let kn,Wn;fn>xn/vn?(kn=Tt,Wn=Tt*Qr):(kn=.5*vn*(1+fn),Wn=.5*Math.sqrt(xn*xn+2*(Tt*Tt+wt*wt)*fn+vn*vn*fn*fn));const Xn=ut.projection.pixelsPerMeter(ut.center.lat,Xt),Jn=ut._camera.getCameraToWorldMercator(),Qn=[0,0,-kn*Sr];Ye._.transformMat4(Qn,Qn,Jn);let ko=Wn*Sr;const Fo=ut._edgeInsets;if(!(0===Fo.left&&0===Fo.top&&0===Fo.right&&0===Fo.bottom||Fo.left===Fo.right&&Fo.top===Fo.bottom)){const pt=ut._camera.getWorldToCamera(ut.worldSize,"meters"===ut.projection.zAxisUnit?Xn:1),St=ut._camera.getCameraToClipPerspective(ut._fov,ut.width/ut.height,wt,Tt);St[8]=2*-ut.centerOffset.x/ut.width,St[9]=2*ut.centerOffset.y/ut.height;const It=new Float64Array(16);Ye.ad.mul(It,St,pt);const Sr=new Float64Array(16);Ye.ad.invert(Sr,It);const Lr=Ye.aM.fromInvProjectionMatrix(Sr,Xt,Lt,!0);for(const pt of Lr.points){const wt=((is=pt)[0]/=$t,is[1]/=$t,is[2]=Ye.ax(is[2],ut._center.lat),is);ko=Math.max(ko,Ye._.len(Ye._.subtract([],Qn,wt)))}}var is;ko*=St/(St-1);const ns=Math.acos(pt[2]),ss=Math.atan2(-pt[0],-pt[1]),as=new Ht;as.position=Qn,as.setPitchBearing(ns,ss);const ds=as.getWorldToCamera(Xt,Xn),ps=ko*Xt,ms=Math.min(ut._mercatorZfromZoom(17)*Xt*-2,-2*ps),Js=as.getCameraToClipOrthographic(-ps,ps,-ps,ps,ms,(ps+It*Xn)/pt[2]),ua=new Float64Array(16);Ye.ad.multiply(ua,Js,ds);const ba=Ye._.fromValues(Math.floor(1e6*Qn[0])/1e6*Xt,Math.floor(1e6*Qn[1])/1e6*Xt,0),Ra=.5*St,La=[0,0,0];Ye._.transformMat4(La,ba,ua),Ye._.scale(La,La,Ra);const ll=[Math.floor(La[0]),Math.floor(La[1]),Math.floor(La[2])],yl=[0,0,0];Ye._.sub(yl,La,ll),Ye._.scale(yl,yl,-1/Ra);const Tl=new Float64Array(16);return Ye.ad.identity(Tl),Ye.ad.translate(Tl,Tl,yl),Ye.ad.multiply(ua,Tl,ua),[ua,ps]}function Ei(Ye,ut){return null!=Ye&&null!=ut&&!(!Ye.hasData()||!ut.hasData())&&null!=Ye.demTexture&&null!=ut.demTexture&&Ye.tileID.key!==ut.tileID.key}const Pl=new class{constructor(){this.operations={}}newMorphing(Ye,ut,pt,wt,Tt){if(Ye in this.operations){const ut=this.operations[Ye];ut.to.tileID.key!==pt.tileID.key&&(ut.queued=pt)}else this.operations[Ye]={startTime:wt,phase:0,duration:Tt,from:ut,to:pt,queued:null}}getMorphValuesForProxy(Ye){if(!(Ye in this.operations))return null;const ut=this.operations[Ye];return{from:ut.from,to:ut.to,phase:ut.phase}}update(Ye){for(const ut in this.operations){const pt=this.operations[ut];for(pt.phase=(Ye-pt.startTime)/pt.duration;pt.phase>=1||!this._validOp(pt);)if(!this._nextOp(pt,Ye)){delete this.operations[ut];break}}}_nextOp(Ye,ut){return!!Ye.queued&&(Ye.from=Ye.to,Ye.to=Ye.queued,Ye.queued=null,Ye.phase=0,Ye.startTime=ut,!0)}_validOp(Ye){return Ye.from.hasData()&&Ye.to.hasData()}},ec={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Ii(Ye,ut,pt){if(0===ut)return 0;const wt=ut<1&&514===pt?.25/ut:1;return 6*Math.pow(1.5,22-Ye)*Math.max(ut,1)*wt}function Li(Ye,ut){const pt=1<<Ye.z;return!ut&&(0===Ye.x||Ye.x===pt-1)||0===Ye.y||Ye.y===pt-1}const Pi=Ye=>({u_matrix:Ye});function Ai(ut,pt,wt,Tt,St){if(St>0){const It=Ye.e.now(),Lt=(It-ut.timeAdded)/St,$t=pt?(It-pt.timeAdded)/St:-1,Xt=wt.getSource(),Sr=Tt.coveringZoomLevel({tileSize:Xt.tileSize,roundZoom:Xt.roundZoom}),Lr=!pt||Math.abs(pt.tileID.overscaledZ-Sr)>Math.abs(ut.tileID.overscaledZ-Sr),Qr=Lr&&ut.refreshedUponExpiration?1:Ye.at(Lr?Lt:1-$t,0,1);return ut.refreshedUponExpiration&&Lt>=1&&(ut.refreshedUponExpiration=!1),pt?{opacity:1,mix:1-Qr}:{opacity:Qr,mix:0}}return{opacity:1,mix:0}}class Ri extends kt{constructor(ut,pt,wt,Tt){super(ut,pt,wt,Tt),this.type="raster-array",this.maxzoom=22,this._options=Ye.W({type:"raster-array"},pt)}triggerRepaint(Ye){const ut=this.map.painter._terrain,pt=this.map.style.getSourceCache(this.id);ut&&ut.enabled&&pt&&ut._clearRenderCacheForTile(pt.id,Ye.tileID),this.map.triggerRepaint()}loadTile(ut,pt){const wt=this.map._requestManager.normalizeTileURL(ut.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),Tt=this.map._requestManager.transformRequest(wt,Ye.R.Tile);ut.requestParams=Tt,ut.actor||(ut.actor=this.dispatcher.getActor()),ut.request=ut.fetchHeader(void 0,((Ye,wt,Tt,St)=>{if(delete ut.request,ut.aborted)return ut.state="unloaded",pt(null);if(Ye){if(20===Ye.code)return;return ut.state="errored",pt(Ye)}this.map._refreshExpiredTiles&&ut.setExpiryData({cacheControl:Tt,expires:St}),ut.state="empty",pt(null)}))}unloadTile(ut,pt){const wt=ut.texture;wt&&wt instanceof Ye.T?(ut.destroy(!0),this.map.painter.saveTileTexture(wt)):(ut.destroy(),ut.flushQueues(),ut._isHeaderLoaded=!1,delete ut._mrt,delete ut.textureDescriptor),ut.fbo&&(ut.fbo.destroy(),delete ut.fbo),delete ut.request,delete ut.requestParams,delete ut.neighboringTiles,ut.state="unloaded"}prepareTile(ut,pt,wt){ut._isHeaderLoaded&&("empty"!==ut.state&&(ut.state="reloading"),ut.fetchBand(pt,wt,((pt,wt)=>{if(pt)return ut.state="errored",this.fire(new Ye.d(pt)),void this.triggerRepaint(ut);wt&&(ut.setTexture(wt,this.map.painter),ut.state="loaded",this.triggerRepaint(ut))})))}getInitialBand(Ye){if(!this.rasterLayers)return 0;const ut=this.rasterLayers.find((({id:ut})=>ut===Ye)),pt=ut&&ut.fields,wt=pt&&pt.bands&&pt.bands;return wt?wt[0]:0}getTextureDescriptor(ut,pt,wt){if(!ut)return;const Tt=pt.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!Tt)return;let St=null;pt instanceof Ye.bk?St=pt.paint.get("raster-array-band"):pt instanceof Ye.bl&&(St=pt.paint.get("raster-particle-array-band"));const It=St||this.getInitialBand(Tt);if(null!=It)if(ut.textureDescriptor){if(!ut.updateNeeded(Tt,It)||wt)return Object.assign({},ut.textureDescriptor,{texture:ut.texture})}else this.prepareTile(ut,Tt,It)}}const tc={vector:Nt,raster:kt,"raster-dem":class extends kt{constructor(ut,pt,wt,Tt){super(ut,pt,wt,Tt),this.type="raster-dem",this.maxzoom=22,this._options=Ye.W({type:"raster-dem"},pt),this.encoding=pt.encoding||"mapbox"}loadTile(ut,pt){const wt=this.map._requestManager.normalizeTileURL(ut.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function r(Ye,wt){Ye&&(ut.state="errored",pt(Ye)),wt&&(ut.dem=wt,ut.dem.onDeserialize(),ut.needsHillshadePrepare=!0,ut.needsDEMTextureUpload=!0,ut.state="loaded",pt(null))}ut.request=Ye.h(this.map._requestManager.transformRequest(wt,Ye.R.Tile),function(wt,Tt,St,It){if(delete ut.request,ut.aborted)ut.state="unloaded",pt(null);else if(wt)ut.state="errored",pt(wt);else if(Tt){this.map._refreshExpiredTiles&&ut.setExpiryData({cacheControl:St,expires:It});const pt=ImageBitmap&&Tt instanceof ImageBitmap&&Ye.bi(),wt=1-(Tt.width-Ye.bj(Tt.width))/2;wt<1||ut.neighboringTiles||(ut.neighboringTiles=this._getNeighboringTiles(ut.tileID));const Lt=pt?Tt:Ye.e.getImageData(Tt,wt),$t={uid:ut.uid,coord:ut.tileID,source:this.id,scope:this.scope,rawImageData:Lt,encoding:this.encoding,padding:wt};ut.actor&&"expired"!==ut.state||(ut.actor=this.dispatcher.getActor(),ut.actor.send("loadDEMTile",$t,r.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(ut){const pt=ut.canonical,wt=Math.pow(2,pt.z),Tt=(pt.x-1+wt)%wt,St=0===pt.x?ut.wrap-1:ut.wrap,It=(pt.x+1+wt)%wt,Lt=pt.x+1===wt?ut.wrap+1:ut.wrap,$t={};return $t[new Ye.aL(ut.overscaledZ,St,pt.z,Tt,pt.y).key]={backfilled:!1},$t[new Ye.aL(ut.overscaledZ,Lt,pt.z,It,pt.y).key]={backfilled:!1},pt.y>0&&($t[new Ye.aL(ut.overscaledZ,St,pt.z,Tt,pt.y-1).key]={backfilled:!1},$t[new Ye.aL(ut.overscaledZ,ut.wrap,pt.z,pt.x,pt.y-1).key]={backfilled:!1},$t[new Ye.aL(ut.overscaledZ,Lt,pt.z,It,pt.y-1).key]={backfilled:!1}),pt.y+1<wt&&($t[new Ye.aL(ut.overscaledZ,St,pt.z,Tt,pt.y+1).key]={backfilled:!1},$t[new Ye.aL(ut.overscaledZ,ut.wrap,pt.z,pt.x,pt.y+1).key]={backfilled:!1},$t[new Ye.aL(ut.overscaledZ,Lt,pt.z,It,pt.y+1).key]={backfilled:!1}),$t}},"raster-array":Ri,geojson:class extends Ye.E{constructor(ut,pt,wt,Tt){super(),this.id=ut,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=wt.getActor(),this.setEventedParent(Tt),this._data=pt.data,this._options=Ye.W({},pt),this._collectResourceTiming=pt.collectResourceTiming,void 0!==pt.maxzoom&&(this.maxzoom=pt.maxzoom),void 0!==pt.minzoom&&(this.minzoom=pt.minzoom),pt.type&&(this.type=pt.type),pt.attribution&&(this.attribution=pt.attribution),this.promoteId=pt.promoteId;const St=Ye.a3/this.tileSize;this.workerOptions=Ye.W({source:this.id,scope:this.scope,cluster:pt.cluster||!1,geojsonVtOptions:{buffer:(void 0!==pt.buffer?pt.buffer:128)*St,tolerance:(void 0!==pt.tolerance?pt.tolerance:.375)*St,extent:Ye.a3,maxZoom:this.maxzoom,lineMetrics:pt.lineMetrics||!1,generateId:pt.generateId||!1},superclusterOptions:{maxZoom:void 0!==pt.clusterMaxZoom?pt.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,pt.clusterMinPoints||2),extent:Ye.a3,radius:(void 0!==pt.clusterRadius?pt.clusterRadius:50)*St,log:!1,generateId:pt.generateId||!1},clusterProperties:pt.clusterProperties,filter:pt.filter,dynamic:pt.dynamic},pt.workerOptions)}onAdd(Ye){this.map=Ye,this.setData(this._data)}setData(Ye){return this._data=Ye,this._updateWorkerData(),this}updateData(ut){return this._options.dynamic?"string"!=typeof ut&&("Feature"===ut.type&&(ut={type:"FeatureCollection",features:[ut]}),"FeatureCollection"!==ut.type)?this.fire(new Ye.d(new Error("Data to update should be a feature or a feature collection."))):(this._coalesce&&"string"!=typeof ut&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type?this._data.features.push(...ut.features):this._data=ut,this._updateWorkerData(!0),this):this.fire(new Ye.d(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")))}getClusterExpansionZoom(Ye,ut){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:Ye,source:this.id,scope:this.scope},ut),this}getClusterChildren(Ye,ut){return this.actor.send("geojson.getClusterChildren",{clusterId:Ye,source:this.id,scope:this.scope},ut),this}getClusterLeaves(Ye,ut,pt,wt){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:Ye,limit:ut,offset:pt},wt),this}_updateWorkerData(ut=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new Ye.f("dataloading",{dataType:"source"})),this._loaded=!1;const pt=Ye.W({append:ut},this.workerOptions);pt.scope=this.scope;const wt=this._data;"string"==typeof wt?(pt.request=this.map._requestManager.transformRequest(Ye.e.resolveURL(wt),Ye.R.Source),pt.request.collectResourceTiming=this._collectResourceTiming):pt.data=JSON.stringify(wt),this._pendingLoad=this.actor.send(`${this.type}.loadData`,pt,((pt,wt)=>{if(this._loaded=!0,this._pendingLoad=null,pt)this.fire(new Ye.d(pt));else{const pt={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&wt&&wt.resourceTiming&&wt.resourceTiming[this.id]&&(pt.resourceTiming=wt.resourceTiming[this.id]),ut&&(this._partialReload=!0),this.fire(new Ye.f("data",pt)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(ut),this._coalesce=!1)}))}loaded(){return this._loaded}loadTile(ut,pt){const wt=ut.actor?"reloadTile":"loadTile";ut.actor=this.actor;const Tt=this.map.style?this.map.style.getLut(this.scope):null,St=this._partialReload,It={type:this.type,uid:ut.uid,tileID:ut.tileID,tileZoom:ut.tileZoom,zoom:ut.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:Tt?{image:Tt.image.clone()}:null,scope:this.scope,pixelRatio:Ye.e.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,partial:St};ut.request=this.actor.send(wt,It,((Ye,Tt)=>St&&!Tt?(ut.state="loaded",pt(null)):(delete ut.request,ut.destroy(),ut.aborted?pt(null):Ye?pt(Ye):(ut.loadVectorData(Tt,this.map.painter,"reloadTile"===wt),pt(null)))),void 0,"loadTile"===wt)}abortTile(Ye){Ye.request&&(Ye.request.cancel(),delete Ye.request),Ye.aborted=!0}unloadTile(Ye,ut){this.actor.send("removeTile",{uid:Ye.uid,type:this.type,source:this.id,scope:this.scope}),Ye.destroy()}onRemove(Ye){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Ye.W({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Ye.bm{constructor(Ye,ut,pt,wt){super(Ye,ut,pt,wt),this.roundZoom=!0,this.type="video",this.options=ut}load(){this._loaded=!1;const ut=this.options;this.urls=[];for(const pt of ut.urls)this.urls.push(this.map._requestManager.transformRequest(pt,Ye.R.Source).url);Ye.bn(this.urls,((ut,pt)=>{this._loaded=!0,ut?this.fire(new Ye.d(ut)):pt&&(this.video=pt,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(ut){if(this.video){const pt=this.video.seekable;ut<pt.start(0)||ut>pt.end(0)?this.fire(new Ye.d(new Ye.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${pt.start(0)} and ${pt.end(0)}-second mark.`))):this.video.currentTime=ut}}getVideo(){return this.video}onAdd(Ye){this.map||(this.map=Ye,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const ut=this.map.painter.context,pt=ut.gl;this.texture?this.video.paused||(this.texture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE),pt.texSubImage2D(pt.TEXTURE_2D,0,0,0,pt.RGBA,pt.UNSIGNED_BYTE,this.video)):(this.texture=new Ye.T(ut,this.video,pt.RGBA),this.texture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(ut)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Ye.bm,model:class extends Ye.E{constructor(Ye,ut,pt,wt){super(),this.id=Ye,this.type="model",this.models=[],this._loaded=!1,this._options=ut}load(){const ut=[];for(const pt in this._options.models){const wt=this._options.models[pt],Tt=Ye.l(this.map._requestManager.transformRequest(wt.uri,Ye.R.Model).url).then((ut=>{if(!ut)return;const Tt=Ye.c(ut),St=new Ye.M(pt,wt.position,wt.orientation,Tt);St.computeBoundsAndApplyParent(),this.models.push(St)})).catch((ut=>{this.fire(new Ye.d(new Error(`Could not load model ${pt} from ${wt.uri}: ${ut.message}`)))}));ut.push(Tt)}return Promise.allSettled(ut).then((()=>{this._loaded=!0,this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((ut=>{this.fire(new Ye.d(new Error(`Could not load models: ${ut.message}`)))}))}onAdd(Ye){this.map=Ye,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(Ye,ut){}serialize(){return{type:"model"}}},"batched-model":class extends Ye.E{constructor(Ye,ut,pt,wt){super(),this.type="batched-model",this.id=Ye,this.tileSize=512,this._options=ut,this.tiles=this._options.tiles,this.maxzoom=ut.maxzoom||19,this.minzoom=ut.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=pt,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(wt)}onAdd(Ye){this.map=Ye,this.load()}load(ut){this._loaded=!1,this.fire(new Ye.f("dataloading",{dataType:"source"}));const pt=Array.isArray(this.map._language)?this.map._language.join():this.map._language,wt=this.map._worldview;this._tileJSONRequest=Ft(this._options,this.map._requestManager,pt,wt,((Tt,St)=>{this._tileJSONRequest=null,this._loaded=!0,Tt?(pt&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${pt}`),wt&&2!==wt.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${wt}`),this.fire(new Ye.d(Tt))):St&&(Ye.W(this,St),St.bounds&&(this.tileBounds=new Bt(St.bounds,this.minzoom,this.maxzoom)),Ye.an(St.tiles,this.map._requestManager._customAccessToken),this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"content"}))),ut&&ut(Tt)}))}hasTransition(){return!1}hasTile(Ye){return!this.tileBounds||this.tileBounds.contains(Ye.canonical)}loaded(){return this._loaded}loadTile(ut,pt){const wt=this.map._requestManager.normalizeTileURL(ut.tileID.canonical.url(this.tiles,this.scheme)),Tt={request:this.map._requestManager.transformRequest(wt,Ye.R.Tile),data:void 0,uid:ut.uid,tileID:ut.tileID,tileZoom:ut.tileZoom,zoom:ut.tileID.overscaledZ,tileSize:this.tileSize*ut.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:ut.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(ut.actor&&"expired"!==ut.state)if("loading"===ut.state)ut.reloadCallback=pt;else{if(ut.buckets){const Ye=Object.values(ut.buckets);for(const ut of Ye)ut.dirty=!0;return void(ut.state="loaded")}ut.request=ut.actor.send("reloadTile",Tt,a.bind(this))}else ut.actor=this.dispatcher.getActor(),ut.request=ut.actor.send("loadTile",Tt,a.bind(this),void 0,!0);function a(Ye,wt){return ut.aborted?pt(null):Ye&&404!==Ye.status?pt(Ye):(wt&&(wt.resourceTiming&&(ut.resourceTiming=wt.resourceTiming),this.map._refreshExpiredTiles&&ut.setExpiryData(wt),ut.buckets={...ut.buckets,...wt.buckets},wt.featureIndex&&(ut.latestFeatureIndex=wt.featureIndex)),ut.state="loaded",void pt(null))}}serialize(){return Ye.W({},this._options)}},canvas:class extends Ye.bm{constructor(ut,pt,wt,Tt){super(ut,pt,wt,Tt),pt.coordinates?Array.isArray(pt.coordinates)&&4===pt.coordinates.length&&!pt.coordinates.some((Ye=>!Array.isArray(Ye)||2!==Ye.length||Ye.some((Ye=>"number"!=typeof Ye))))||this.fire(new Ye.d(new Ye.V(`sources.${ut}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new Ye.d(new Ye.V(`sources.${ut}`,null,'missing required property "coordinates"'))),pt.animate&&"boolean"!=typeof pt.animate&&this.fire(new Ye.d(new Ye.V(`sources.${ut}`,null,'optional "animate" property must be a boolean value'))),pt.canvas?"string"==typeof pt.canvas||pt.canvas instanceof HTMLCanvasElement||this.fire(new Ye.d(new Ye.V(`sources.${ut}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new Ye.d(new Ye.V(`sources.${ut}`,null,'missing required property "canvas"'))),this.options=pt,this.animate=void 0===pt.animate||pt.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new Ye.d(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(Ye){this.map=Ye,this.load(),this.canvas&&this.animate&&this.play()}onRemove(Ye){this.pause()}prepare(){let ut=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,ut=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,ut=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const pt=this.map.painter.context;this.texture?!ut&&!this._playing||this.texture instanceof Ye.bo||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new Ye.T(pt,this.canvas,pt.gl.RGBA,{premultiply:!0}),this._prepareData(pt)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const Ye of[this.canvas.width,this.canvas.height])if(isNaN(Ye)||Ye<=0)return!0;return!1}},custom:class extends Ye.E{constructor(ut,pt,wt,Tt){super(),this.id=ut,this.type="custom",this._dataType="raster",this._dispatcher=wt,this._implementation=pt,this.setEventedParent(Tt),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new Ye.d(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new Ye.d(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Bt(this._implementation.bounds,this.minzoom,this.maxzoom)),pt.update=this._update.bind(this),pt.clearTiles=this._clearTiles.bind(this),pt.coveringTiles=this._coveringTiles.bind(this),Ye.W(this,Ye.ah(pt,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return Ye.ah(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(ut){this.map=ut,this._loaded=!1,this.fire(new Ye.f("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(ut),this.load()}onRemove(Ye){this._implementation.onRemove&&this._implementation.onRemove(Ye)}hasTile(Ye){if(this._implementation.hasTile){const{x:ut,y:pt,z:wt}=Ye.canonical;return this._implementation.hasTile({x:ut,y:pt,z:wt})}return!this.tileBounds||this.tileBounds.contains(Ye.canonical)}loadTile(Ye,ut){const{x:pt,y:wt,z:Tt}=Ye.tileID.canonical,St=new AbortController;Ye.request=Promise.resolve(this._implementation.loadTile({x:pt,y:wt,z:Tt},{signal:St.signal})).then(function(pt){return delete Ye.request,Ye.aborted?(Ye.state="unloaded",ut(null)):void 0===pt?(Ye.state="errored",ut(null)):null===pt?(this.loadTileData(Ye,{width:this.tileSize,height:this.tileSize,data:null}),Ye.state="loaded",ut(null)):function(Ye){return Ye instanceof ImageData||Ye instanceof HTMLCanvasElement||Ye instanceof ImageBitmap||Ye instanceof HTMLImageElement}(pt)?(this.loadTileData(Ye,pt),Ye.state="loaded",void ut(null)):(Ye.state="errored",ut(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((pt=>{20!==pt.code&&(Ye.state="errored",ut(pt))})),Ye.request.cancel=()=>St.abort()}loadTileData(Ye,ut){Ye.setTexture(ut,this.map.painter)}unloadTile(ut,pt){if(ut.texture&&ut.texture instanceof Ye.T?(ut.destroy(!0),ut.texture&&ut.texture instanceof Ye.T&&this.map.painter.saveTileTexture(ut.texture)):ut.destroy(),this._implementation.unloadTile){const{x:Ye,y:pt,z:wt}=ut.tileID.canonical;this._implementation.unloadTile({x:Ye,y:pt,z:wt})}pt&&pt()}abortTile(Ye,ut){Ye.request&&Ye.request.cancel&&(Ye.request.cancel(),delete Ye.request),ut&&ut()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((Ye=>({x:Ye.canonical.x,y:Ye.canonical.y,z:Ye.canonical.z})))}_clearTiles(){const ut=Ye.al(this.id,this.scope);this.map.style.clearSource(ut)}_update(){this.fire(new Ye.f("data",{dataType:"source",sourceDataType:"content"}))}}},Mi=function(ut,pt,wt,Tt){const St=new tc[pt.type](ut,pt,wt,Tt);if(St.id!==ut)throw new Error(`Expected Source id to be ${ut} instead of ${St.id}`);return Ye.bp(["load","abort","unload","serialize","prepare"],St),St};class zi extends Ye.bv{constructor(ut){const pt={type:"raster-dem",maxzoom:ut.transform.maxZoom},wt=new Ye.bw(Ye.bx(),null),Tt=Mi("mock-dem",pt,wt,ut.style);super("mock-dem",Tt,!1),Tt.setEventedParent(this),this._sourceLoaded=!0}_loadTile(Ye,ut){Ye.state="loaded",ut(null)}}class Oi extends Ye.bv{constructor(ut){const pt=Mi("proxy",{type:"geojson",maxzoom:ut.transform.maxZoom},new Ye.bw(Ye.bx(),null),ut.style);super("proxy",pt,!1),pt.setEventedParent(this),this.map=this.getSource().map=ut,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(ut,pt,wt){if(ut.freezeTileCoverage)return;this.transform=ut;const Tt=ut.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((pt,wt)=>{if(pt[wt.key]="",!this._tiles[wt.key]){const pt=new Ye.by(wt,this._source.tileSize*wt.overscaleFactor(),ut.tileZoom);pt.state="loaded",this._tiles[wt.key]=pt}return pt}),{});for(const Ye in this._tiles)Ye in Tt||(this.freeFBO(Ye),this._tiles[Ye].unloadVectorData(),delete this._tiles[Ye])}freeFBO(Ye){const ut=this.proxyCachedFBO[Ye];if(void 0!==ut){const pt=Object.values(ut);this.renderCachePool.push(...pt),delete this.proxyCachedFBO[Ye]}}deallocRenderCache(){this.renderCache.forEach((Ye=>Ye.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Fi extends Ye.aL{constructor(Ye,ut,pt){super(Ye.overscaledZ,Ye.wrap,Ye.canonical.z,Ye.canonical.x,Ye.canonical.y),this.proxyTileKey=ut,this.projMatrix=pt}}class Bi extends Ye.bq{constructor(ut,pt){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},ut.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),ut.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),ut.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=ut,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[wt,Tt,St]=function(ut){const pt=new Ye.bt,wt=new Ye.bu,Tt=131;pt.reserve(17161),wt.reserve(33800);const St=Ye.a3/128,It=Ye.a3+St/2,Lt=It+St;for(let ut=-St;ut<Lt;ut+=St)for(let wt=-St;wt<Lt;wt+=St){const Tt=wt<0||wt>It||ut<0||ut>It?24575:0,St=Ye.at(Math.round(wt),0,Ye.a3),Lt=Ye.at(Math.round(ut),0,Ye.a3);pt.emplaceBack(St+Tt,Lt)}const l=(Ye,ut)=>{const pt=ut*Tt+Ye;wt.emplaceBack(pt+1,pt,pt+Tt),wt.emplaceBack(pt+Tt,pt+Tt+1,pt+1)};for(let Ye=1;Ye<129;Ye++)for(let ut=1;ut<129;ut++)l(ut,Ye);return[0,129].forEach((Ye=>{for(let ut=0;ut<130;ut++)l(ut,Ye),l(Ye,ut)})),[pt,wt,32768]}(),It=ut.context;this.gridBuffer=It.createVertexBuffer(wt,Ye.br.members),this.gridIndexBuffer=It.createIndexBuffer(Tt),this.gridSegments=Ye.b.simpleSegment(0,0,wt.length,Tt.length),this.gridNoSkirtSegments=Ye.b.simpleSegment(0,0,wt.length,St),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Oi(pt.map),this.orthoMatrix=Ye.ad.create(),Ye.ad.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,Ye.a3,0,Ye.a3,0,1);const Lt=It.gl;this._overlapStencilMode=new Ye.ag({func:Lt.GEQUAL,mask:255},0,255,Lt.KEEP,Lt.KEEP,Lt.REPLACE),this._previousZoom=ut.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=pt,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new zi(pt.map),this._pendingGroundEffectLayers=[]}set style(Ye){Ye.on("data",this._onStyleDataEvent.bind(this)),this._style=Ye,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(ut,pt,wt){if(ut&&ut.terrain){this._style!==ut&&(this.style=ut,this._evaluationZoom=void 0);const Tt=ut.terrain.properties,St=0===ut.terrain.drapeRenderMode,It=ut.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=Ye.e.now();const Lt=ut.terrain&&ut.terrain.scope,$t=Tt.get("source"),Xt=St?this._mockSourceCache:ut.getSourceCache($t,Lt);if(!Xt)return void Ye.w(`Couldn't find terrain source "${$t}".`);if(this.sourceCache=Xt,this._exaggeration=It?this.calculateExaggeration(pt):Tt.get("exaggeration"),!pt.projection.requiresDraping&&It&&0===this._exaggeration)return void this._disable();this.enabled=!0;const h=()=>{this.sourceCache.used&&Ye.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const ut=this.getScaledDemTileSize();this.sourceCache.update(pt,ut,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,h(),this._initializing=!0),h(),pt.updateElevation(!0,wt),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(pt),this._emptyDEMTextureDirty=!0,this._previousZoom=pt.zoom}else this._disable()}calculateExaggeration(ut){const pt=this._previousCameraAltitude,wt=ut.getFreeCameraOptions().position.z/ut.pixelsPerMeter*ut.worldSize;this._previousCameraAltitude=wt;const Tt=null!=pt?wt-pt:Number.MAX_VALUE;if(Math.abs(Tt)<2)return this._exaggeration;const St=ut.zoom,It=this._style.terrain;if(!this._previousUpdateTimestamp)return It.getExaggeration(St);let Lt=St-this._previousZoom;const $t=this._previousUpdateTimestamp;let Xt=St;null!=this._evaluationZoom&&(Xt=this._evaluationZoom,Math.abs(St-Xt)>.5&&(Lt=.5*(St-Xt+Lt)),Lt*Tt<0&&(Xt+=Lt)),this._evaluationZoom=Xt;const Sr=It.getExaggeration(Xt),Lr=Sr===It.getExaggeration(Math.max(0,Xt-.1));if(Lr&&Math.abs(Sr-this._exaggeration)<.01)return Sr;let Qr=Math.min(.1,.00375*(this._updateTimestamp-$t));return(Lr||Sr<.1||Math.abs(Lt)<1e-4)&&(Qr=Math.min(.2,4*Qr)),Ye.a2(this._exaggeration,Sr,Qr)}resetTileLookupCache(Ye){this._findCoveringTileCache[Ye]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(Ye){Ye.coord&&"source"===Ye.dataType?this._clearRenderCacheForTile(Ye.sourceCacheId,Ye.coord):"style"===Ye.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const Ye in this._style._mergedSourceCaches)this._style._mergedSourceCaches[Ye].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach((Ye=>Ye.fb.destroy())),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const Ye=2*this.proxySourceCache.getSource().tileSize;return[Ye,Ye]}set useVertexMorphing(Ye){this._useVertexMorphing=Ye}updateTileBinding(ut){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const pt=this.proxySourceCache,wt=this.painter.transform;this._initializing&&(this._initializing=0===wt._centerAltitude&&-1===this.getAtPointOrZero(Ye.Y.fromLngLat(wt.center),-1),this._emptyDEMTextureDirty=!this._initializing);const Tt=this.proxyCoords=pt.getIds().map((Ye=>{const ut=pt.getTileByID(Ye).tileID;return ut.projMatrix=wt.calculateProjMatrix(ut.toUnwrapped()),ut}));!function(ut,pt){const wt=pt.transform.pointCoordinate(pt.transform.getCameraPoint()),Tt=new Ye.P(wt.x,wt.y);ut.sort(((ut,pt)=>{if(pt.overscaledZ-ut.overscaledZ)return pt.overscaledZ-ut.overscaledZ;const wt=new Ye.P(ut.canonical.x+(1<<ut.canonical.z)*ut.wrap,ut.canonical.y),St=new Ye.P(pt.canonical.x+(1<<pt.canonical.z)*pt.wrap,pt.canonical.y),It=Tt.mult(1<<ut.canonical.z);return It.x-=.5,It.y-=.5,It.distSqr(wt)-It.distSqr(St)}))}(Tt,this.painter);const St=this.proxyToSource||{};this.proxyToSource={},Tt.forEach((Ye=>{this.proxyToSource[Ye.key]={}})),this.terrainTileForTile={};const It=this._style._mergedSourceCaches;for(const Ye in It){const pt=It[Ye];if(!pt.used)continue;if(pt!==this.sourceCache&&this.resetTileLookupCache(pt.id),this._setupProxiedCoordsForOrtho(pt,ut[Ye],St),pt.usedForTerrain)continue;const wt=ut[Ye];pt.getSource().reparseOverscaled&&this._assignTerrainTiles(wt)}this.proxiedCoords[pt.id]=Tt.map((Ye=>new Fi(Ye,Ye.key,this.orthoMatrix))),this._assignTerrainTiles(Tt),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(St),this.renderingToTexture=!1;const Lt={};this._visibleDemTiles=[];for(const Ye of this.proxyCoords){const ut=this.terrainTileForTile[Ye.key];if(!ut)continue;const pt=ut.tileID.key;pt in Lt||(this._visibleDemTiles.push(ut),Lt[pt]=pt)}}_assignTerrainTiles(Ye){this._initializing||Ye.forEach((Ye=>{if(this.terrainTileForTile[Ye.key])return;const ut=this._findTileCoveringTileID(Ye,this.sourceCache);ut&&(this.terrainTileForTile[Ye.key]=ut)}))}_prepareDEMTextures(){const Ye=this.painter.context,ut=Ye.gl;for(const pt in this.terrainTileForTile){const wt=this.terrainTileForTile[pt],Tt=wt.dem;!Tt||wt.demTexture&&!wt.needsDEMTextureUpload||(Ye.activeTexture.set(ut.TEXTURE1),zt(this.painter,wt,Tt))}}_prepareDemTileUniforms(Ye,ut,pt,wt){if(!ut||null==ut.demTexture)return!1;const Tt=Ye.tileID.canonical,St=Math.pow(2,ut.tileID.canonical.z-Tt.z),It=wt||"";return pt[`u_dem_tl${It}`]=[Tt.x*St%1,Tt.y*St%1],pt[`u_dem_scale${It}`]=St,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const ut=this.painter.context,pt=ut.gl;if(!this._emptyDepthBufferTexture){const wt=new Ye.i({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new Ye.T(ut,wt,pt.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let Ye=0;const ut=this._visibleDemTiles.reduce(((ut,pt)=>{if(!pt.dem)return ut;const wt=pt.dem.tree.minimums[0];return wt>0&&Ye++,ut+wt}),0);return Ye?ut/Ye:0}_updateEmptyDEMTexture(){const ut=this.painter.context,pt=ut.gl;ut.activeTexture.set(pt.TEXTURE2);const wt=this._getLoadedAreaMinimum(),[Tt,St]=(()=>{const ut=new Ye.bz({width:1,height:1},new Float32Array([wt]));return[pt.R32F,ut]})();this._emptyDEMTextureDirty=!1;let It=this._emptyDEMTexture;return It?It.update(St,{premultiply:!1}):It=this._emptyDEMTexture=new Ye.T(ut,St,Tt,{premultiply:!1}),It}setupElevationDraw(ut,pt,wt){const Tt=this.painter.context,St=Tt.gl,It={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[2,0],u_exaggeration:0};It.u_exaggeration=this.exaggeration();let Lt=null,$t=null,Xt=1;if(wt&&wt.morphing&&this._useVertexMorphing){const Ye=wt.morphing.srcDemTile,pt=wt.morphing.dstDemTile;Xt=wt.morphing.phase,Ye&&pt&&(this._prepareDemTileUniforms(ut,Ye,It,"_prev")&&($t=Ye),this._prepareDemTileUniforms(ut,pt,It)&&(Lt=pt))}const h=Ye=>Ye&&Ye.demTexture&&this.painter.linearFloatFilteringSupported()?St.LINEAR:St.NEAREST;let Sr=null;var Lr,Qr;if(this.enabled?$t&&Lt?(Sr=Lt.demTexture,Tt.activeTexture.set(St.TEXTURE4),$t.demTexture.bind(h($t),St.CLAMP_TO_EDGE),It.u_dem_lerp=Xt):(Lt=this.terrainTileForTile[ut.tileID.key],Sr=this._prepareDemTileUniforms(ut,Lt,It)?Lt.demTexture:this.emptyDEMTexture):Sr=this.emptyDEMTexture,Tt.activeTexture.set(St.TEXTURE2),Sr&&(It.u_dem_size=1===(Lr=Sr).size[0]?1:Lr.size[0]-2,Sr.bind(h(Lt),St.CLAMP_TO_EDGE)),Tt.activeTexture.set(St.TEXTURE3),wt&&wt.useDepthForOcclusion&&this.painter.terrainDepthTexture&&this.painter.terrainDepthFBO?(this.painter.terrainDepthTexture.bind(St.NEAREST,St.CLAMP_TO_EDGE),It.u_depth_size_inv=[1/this.painter.terrainDepthFBO.width,1/this.painter.terrainDepthFBO.height],It.u_depth_range_unpack=[2/((Qr=this.painter.depthRangeFor3D)[1]-Qr[0]),-1-2*Qr[0]/(Qr[1]-Qr[0])]):(this.emptyDepthBufferTexture.bind(St.NEAREST,St.CLAMP_TO_EDGE),It.u_depth_range_unpack=[2,0]),Tt.activeTexture.set(St.TEXTURE0),wt&&wt.useMeterToDem&&Lt){const ut=(1<<Lt.tileID.canonical.z)*Ye.ax(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;It.u_meter_to_dem=ut}if(wt&&wt.labelPlaneMatrixInv&&(It.u_label_plane_matrix_inv=wt.labelPlaneMatrixInv),pt.setTerrainUniformValues(Tt,It),"globe"===this.painter.transform.projection.name){const Ye=this.globeUniformValues(this.painter.transform,ut.tileID.canonical,wt&&wt.useDenormalizedUpVectorScale);pt.setGlobeUniformValues(Tt,Ye)}}globeUniformValues(ut,pt,wt){const Tt=ut.projection;return{u_tile_tl_up:Tt.upVector(pt,0,0),u_tile_tr_up:Tt.upVector(pt,Ye.a3,0),u_tile_br_up:Tt.upVector(pt,Ye.a3,Ye.a3),u_tile_bl_up:Tt.upVector(pt,0,Ye.a3),u_tile_up_scale:wt?Ye.bs(1):Tt.upVectorScale(pt,ut.center.lat,ut.worldSize).metersToTile}}renderToBackBuffer(ut){const pt=this.painter,wt=this.painter.context;0!==ut.length&&(wt.bindFramebuffer.set(null),wt.viewport.set([0,0,pt.width,pt.height]),pt.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(ut,pt,wt,Tt,St){if("globe"===ut.transform.projection.name)!function(ut,pt,wt,Tt,St){const It=ut.context,Lt=It.gl;let $t,Xt;const Sr=ut.transform,Lr=Ye.ba(ut,It,Sr),u=(Ye,pt)=>{if(Xt===pt)return;const wt=[ec[pt],"PROJECTION_GLOBE_VIEW"];Lr&&wt.push("CUSTOM_ANTIALIASING");const Tt=ut.isTileAffectedByFog(Ye);$t=ut.getOrCreateProgram("globeRaster",{defines:wt,overrideFog:Tt}),Xt=pt},Qr=ut.colorModeForRenderPass(),fn=new Ye.ae(Lt.LEQUAL,Ye.ae.ReadWrite,ut.depthRangeFor3D);Pl.update(St);const xn=Ye.bb(Sr),vn=[Ye.aj(Sr.center.lng),Ye.ak(Sr.center.lat)],kn=ut.globeSharedBuffers,Wn=[Sr.width*Ye.e.devicePixelRatio,Sr.height*Ye.e.devicePixelRatio],Xn=Float32Array.from(Sr.globeMatrix),Jn={useDenormalizedUpVectorScale:!0};{const Sr=ut.transform,Lr=Ii(Sr.zoom,pt.exaggeration(),pt.sourceCache._source.tileSize);Xt=-1;const Qn=Lt.TRIANGLES;for(const Xt of Tt){const Tt=wt.getTile(Xt),ko=Ye.ag.disabled,Fo=pt.prevTerrainTileForTile[Xt.key],is=pt.terrainTileForTile[Xt.key];Ei(Fo,is)&&Pl.newMorphing(Xt.key,Fo,is,St,250),It.activeTexture.set(Lt.TEXTURE0),Tt.texture&&Tt.texture.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE);const ns=Pl.getMorphValuesForProxy(Xt.key),ss=ns?1:0;ns&&Ye.o(Jn,{morphing:{srcDemTile:ns.from,dstDemTile:ns.to,phase:Ye.b9(ns.phase)}});const as=Ye.bc(Xt.canonical),ds=Ye.bd(as.getCenter().lat),ps=Ye.be(Xt.canonical,as,ds,Sr.worldSize/Sr._pixelsPerMercatorPixel),ms=Ye.bf(Ye.bg(Xt.canonical)),Js=Gt(Sr.expandedFarZProjMatrix,Xn,xn,ms,Ye.a1(Sr.zoom),vn,Sr.frustumCorners.TL,Sr.frustumCorners.TR,Sr.frustumCorners.BR,Sr.frustumCorners.BL,Sr.globeCenterInViewSpace,Sr.globeRadius,Wn,Lr,Sr._farZ,ps);if(u(Xt,ss),$t&&(pt.setupElevationDraw(Tt,$t,Jn),ut.uploadCommonUniforms(It,$t,Xt.toUnwrapped()),kn)){const[pt,wt,Tt]=kn.getGridBuffers(ds,0!==Lr);$t.draw(ut,Qn,fn,ko,Qr,Ye.af.backCCW,Js,"globe_raster",pt,wt,Tt)}}}if(kn&&(ut.renderDefaultNorthPole||ut.renderDefaultSouthPole)){const St=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Lr&&St.push("CUSTOM_ANTIALIASING"),$t=ut.getOrCreateProgram("globeRaster",{defines:St});for(const St of Tt){const{x:Tt,y:Xt,z:Lr}=St.canonical,xn=0===Xt,Xn=Xt===(1<<Lr)-1,[Qn,ko,Fo,is]=kn.getPoleBuffers(Lr,!1);if(is&&(xn||Xn)){const Xt=wt.getTile(St);It.activeTexture.set(Lt.TEXTURE0),Xt.texture&&Xt.texture.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE);let kn=Ye.bh(Lr,Tt,Sr);const ns=Ye.bf(Ye.bg(St.canonical)),C=(pt,wt)=>pt.draw(ut,Lt.TRIANGLES,fn,Ye.ag.disabled,Qr,Ye.af.disabled,Gt(Sr.expandedFarZProjMatrix,kn,kn,ns,0,vn,Sr.frustumCorners.TL,Sr.frustumCorners.TR,Sr.frustumCorners.BR,Sr.frustumCorners.BL,Sr.globeCenterInViewSpace,Sr.globeRadius,Wn,0,Sr._farZ),"globe_pole_raster",wt,Fo,is);pt.setupElevationDraw(Xt,$t,Jn),ut.uploadCommonUniforms(It,$t,St.toUnwrapped()),xn&&ut.renderDefaultNorthPole&&C($t,Qn),Xn&&ut.renderDefaultSouthPole&&(kn=Ye.ad.scale(Ye.ad.create(),kn,[1,-1,1]),C($t,ko))}}}}(ut,pt,wt,Tt,St);else{const It=ut.context,Lt=It.gl;let $t,Xt;const Sr=ut.shadowRenderer,Lr=fi(ut,ut.longestCutoffRange),u=Ye=>{if(Xt===Ye)return;const pt=[];pt.push(ec[Ye]),Lr.shouldRenderCutoff&&pt.push("RENDER_CUTOFF"),$t=ut.getOrCreateProgram("terrainRaster",{defines:pt}),Xt=Ye},Qr=ut.colorModeForRenderPass(),fn=new Ye.ae(Lt.LEQUAL,Ye.ae.ReadWrite,ut.depthRangeFor3D);Pl.update(St);const xn=ut.transform,vn=Ii(xn.zoom,pt.exaggeration(),pt.sourceCache._source.tileSize);let kn=[0,0,0];if(Sr){const Ye=ut.style.directionalLight,pt=ut.style.ambientLight;Ye&&pt&&(kn=wi(ut.style,Ye,pt))}{Xt=-1;const Wn=Lt.TRIANGLES,[Xn,Jn]=[pt.gridIndexBuffer,pt.gridSegments];for(const Xt of Tt){const Tt=wt.getTile(Xt),Qn=Ye.ag.disabled,ko=pt.prevTerrainTileForTile[Xt.key],Fo=pt.terrainTileForTile[Xt.key];Ei(ko,Fo)&&Pl.newMorphing(Xt.key,ko,Fo,St,250),It.activeTexture.set(Lt.TEXTURE0),Tt.texture&&Tt.texture.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE);const is=Pl.getMorphValuesForProxy(Xt.key),ns=is?1:0;let ss;is&&(ss={morphing:{srcDemTile:is.from,dstDemTile:is.to,phase:Ye.b9(is.phase)}});const as=Ut(Xt.projMatrix,Li(Xt.canonical,xn.renderWorldCopies)?vn/10:vn,kn);if(u(ns),!$t)continue;pt.setupElevationDraw(Tt,$t,ss);const ds=Xt.toUnwrapped();Sr&&Sr.setupShadows(ds,$t),ut.uploadCommonUniforms(It,$t,ds,null,Lr),$t.draw(ut,Wn,fn,Qn,Qr,Ye.af.backCCW,as,"terrain_raster",pt.gridBuffer,Xn,Jn)}}}}(pt,this,this.proxySourceCache,ut,this._updateTimestamp),this.renderingToTexture=!0,pt.gpuTimingDeferredRenderEnd(),ut.splice(0,ut.length))}renderBatch(ut){if(0===this._drapedRenderBatches.length)return ut+1;this.renderingToTexture=!0;const pt=this.painter,wt=this.painter.context,Tt=this.proxySourceCache,St=this.proxiedCoords[Tt.id],It=this._drapedRenderBatches.shift(),Lt=pt.style.order,$t=[];let Xt=0;for(const Sr of St){const St=Tt.getTileByID(Sr.proxyTileKey),Lr=Tt.proxyCachedFBO[Sr.key]?Tt.proxyCachedFBO[Sr.key][ut]:void 0,Qr=void 0!==Lr?Tt.renderCache[Lr]:this.pool[Xt++],fn=void 0!==Lr;if(St.texture=Qr.tex,fn&&!Qr.dirty){$t.push(St.tileID);continue}let xn;wt.bindFramebuffer.set(Qr.fb.framebuffer),this.renderedToTile=!1,Qr.dirty&&(wt.clear({color:Ye.C.transparent,stencil:0}),Qr.dirty=!1);for(let Ye=It.start;Ye<=It.end;++Ye){const ut=pt.style._mergedLayers[Lt[Ye]];if(ut.isHidden(pt.transform.zoom))continue;const Tt=pt.style.getLayerSourceCache(ut),St=Tt?this.proxyToSource[Sr.key][Tt.id]:[Sr];if(!St)continue;const It=St;wt.viewport.set([0,0,Qr.fb.width,Qr.fb.height]),xn!==(Tt?Tt.id:null)&&(this._setupStencil(Qr,St,ut,Tt),xn=Tt?Tt.id:null),pt.renderLayer(pt,Tt,ut,It)}if(0===this._drapedRenderBatches.length)for(const Ye of this._pendingGroundEffectLayers){const ut=pt.style._mergedLayers[Lt[Ye]];if(ut.isHidden(pt.transform.zoom))continue;const Tt=pt.style.getLayerSourceCache(ut),St=Tt?this.proxyToSource[Sr.key][Tt.id]:[Sr];if(!St)continue;const It=St;wt.viewport.set([0,0,Qr.fb.width,Qr.fb.height]),xn!==(Tt?Tt.id:null)&&(this._setupStencil(Qr,St,ut,Tt),xn=Tt?Tt.id:null),pt.renderLayer(pt,Tt,ut,It)}this.renderedToTile?(Qr.dirty=!0,$t.push(St.tileID)):fn||--Xt,5===Xt&&(Xt=0,this.renderToBackBuffer($t))}return this.renderToBackBuffer($t),this.renderingToTexture=!1,wt.bindFramebuffer.set(null),wt.viewport.set([0,0,pt.width,pt.height]),It.end+1}postRender(){}isLayerOrderingCorrect(Ye){const ut=Ye.order.length;let pt=-1,wt=ut;for(let Tt=0;Tt<ut;++Tt)this._style.isLayerDraped(Ye._mergedLayers[Ye.order[Tt]])?pt=Math.max(pt,Tt):wt=Math.min(wt,Tt);return wt>pt}getMinElevationBelowMSL(){let Ye=0;return this._visibleDemTiles.filter((Ye=>Ye.dem)).forEach((ut=>{Ye=Math.min(Ye,ut.dem.tree.minimums[0])})),0===Ye?Ye:(Ye-30)*this._exaggeration}raycast(Ye,ut,pt){if(!this._visibleDemTiles)return null;const wt=this._visibleDemTiles.filter((Ye=>Ye.dem)).map((wt=>{const Tt=wt.tileID,St=1<<Tt.overscaledZ,{x:It,y:Lt}=Tt.canonical,$t=It/St,Xt=(It+1)/St,Sr=Lt/St,Lr=(Lt+1)/St;return{minx:$t,miny:Sr,maxx:Xt,maxy:Lr,t:wt.dem.tree.raycastRoot($t,Sr,Xt,Lr,Ye,ut,pt),tile:wt}}));wt.sort(((Ye,ut)=>(null!==Ye.t?Ye.t:Number.MAX_VALUE)-(null!==ut.t?ut.t:Number.MAX_VALUE)));for(const Tt of wt){if(null==Tt.t)return null;const wt=Tt.tile.dem.tree.raycast(Tt.minx,Tt.miny,Tt.maxx,Tt.maxy,Ye,ut,pt);if(null!=wt)return wt}return null}_createFBO(){const ut=this.painter.context,pt=ut.gl,wt=this.drapeBufferSize;ut.activeTexture.set(pt.TEXTURE0);const Tt=new Ye.T(ut,{width:wt[0],height:wt[1],data:null},pt.RGBA);Tt.bind(pt.LINEAR,pt.CLAMP_TO_EDGE);const St=ut.createFramebuffer(wt[0],wt[1],!0,null);return St.colorAttachment.set(Tt.texture),St.depthAttachment=new oe(ut,St.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=ut.createRenderbuffer(ut.gl.DEPTH_STENCIL,wt[0],wt[1]),this._stencilRef=0,St.depthAttachment.set(this._sharedDepthStencil),ut.clear({stencil:0})):St.depthAttachment.set(this._sharedDepthStencil),ut.extTextureFilterAnisotropic&&pt.texParameterf(pt.TEXTURE_2D,ut.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,ut.extTextureFilterAnisotropicMax),{fb:St,tex:Tt,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache)return!0;if(this._style.hasLightTransitions())return!0;for(const Ye in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[Ye].hasTransition())return!0;return this._style.order.some((Ye=>{const ut=this._style._mergedLayers[Ye],pt=ut.isHidden(this.painter.transform.zoom);return"custom"===ut.type?!pt&&ut.shouldRedrape():!pt&&ut.hasTransition()}))}_clearLineLayersFromRenderCache(){let ut=!1;for(const Ye of this._style.getSources())if(Ye instanceof Nt){ut=!0;break}if(!ut)return;const pt={};for(let ut=0;ut<this._style.order.length;++ut){const wt=this._style._mergedLayers[this._style.order[ut]],Tt=this._style.getLayerSourceCache(wt);if(Tt&&!pt[Tt.id]&&!wt.isHidden(this.painter.transform.zoom)&&"line"===wt.type&&wt.widthExpression()instanceof Ye.Z){pt[Tt.id]=!0;for(const Ye of this.proxyCoords){const ut=this.proxyToSource[Ye.key][Tt.id];if(ut)for(const Ye of ut)this._clearRenderCacheForTile(Tt.id,Ye)}}}}_clearRasterLayersFromRenderCache(){let Ye=!1;for(const ut in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[ut]._source instanceof kt){Ye=!0;break}if(!Ye)return;const ut={};for(let Ye=0;Ye<this._style.order.length;++Ye){const pt=this._style._mergedLayers[this._style.order[Ye]],wt=this._style.getLayerSourceCache(pt);if(!wt||ut[wt.id])continue;if(pt.isHidden(this.painter.transform.zoom)||"raster"!==pt.type)continue;const Tt=pt.paint.get("raster-fade-duration");for(const Ye of this.proxyCoords){const ut=this.proxyToSource[Ye.key][wt.id];if(ut)for(const Ye of ut){const ut=Ai(wt.getTile(Ye),wt.findLoadedParent(Ye,0),wt,this.painter.transform,Tt);(1!==ut.opacity||0!==ut.mix)&&this._clearRenderCacheForTile(wt.id,Ye)}}}}_setupDrapedRenderBatches(){const ut=this._style.order,pt=ut.length;if(0===pt)return;const wt=[];this._pendingGroundEffectLayers=[];let Tt,St=0,It=this._style._mergedLayers[ut[St]];for(;!this._style.isLayerDraped(It)&&It.isHidden(this.painter.transform.zoom)&&++St<pt;)It=this._style._mergedLayers[ut[St]];for(;St<pt;++St){const Ye=this._style._mergedLayers[ut[St]];Ye.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(Ye)?void 0===Tt&&(Tt=St):("fill-extrusion"===Ye.type&&this._pendingGroundEffectLayers.push(St),void 0!==Tt&&(wt.push({start:Tt,end:St-1}),Tt=void 0)))}if(void 0!==Tt&&wt.push({start:Tt,end:St-1}),0!==wt.length){const ut=wt[wt.length-1];this._pendingGroundEffectLayers.every((Ye=>Ye>ut.end))||Ye.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=wt}_setupRenderCache(Ye){const ut=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,ut.renderCache.length>ut.renderCachePool.length){const Ye=Object.values(ut.proxyCachedFBO);ut.proxyCachedFBO={};for(let pt=0;pt<Ye.length;++pt){const wt=Object.values(Ye[pt]);ut.renderCachePool.push(...wt)}}return}this._clearRasterLayersFromRenderCache();const pt=this.proxyCoords,wt=this._tilesDirty;for(let Tt=pt.length-1;Tt>=0;Tt--){const St=pt[Tt];if(ut.getTileByID(St.key),void 0!==ut.proxyCachedFBO[St.key]){const pt=Ye[St.key],Tt=this.proxyToSource[St.key];let It=0;for(const Ye in Tt){const ut=Tt[Ye],St=pt[Ye];if(!St||St.length!==ut.length||ut.some(((ut,pt)=>ut!==St[pt]||wt[Ye]&&wt[Ye].hasOwnProperty(ut.key)))){It=-1;break}++It}for(const Ye in ut.proxyCachedFBO[St.key])ut.renderCache[ut.proxyCachedFBO[St.key][Ye]].dirty=It<0||It!==Object.values(pt).length}}const Tt=[...this._drapedRenderBatches];Tt.sort(((Ye,ut)=>ut.end-ut.start-(Ye.end-Ye.start)));for(const Ye of Tt)for(const wt of pt){if(ut.proxyCachedFBO[wt.key])continue;let pt=ut.renderCachePool.pop();void 0===pt&&ut.renderCache.length<50&&(pt=ut.renderCache.length,ut.renderCache.push(this._createFBO())),void 0!==pt&&(ut.proxyCachedFBO[wt.key]={},ut.proxyCachedFBO[wt.key][Ye.start]=pt,ut.renderCache[pt].dirty=!0)}this._tilesDirty={}}_setupStencil(Ye,ut,pt,wt){if(!wt||!this._sourceTilesOverlap[wt.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const Tt=this.painter.context,St=Tt.gl;if(ut.length<=1)return void(this._overlapStencilType=!1);let It;if(pt.isTileClipped())It=ut.length,this._overlapStencilMode.test={func:St.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(ut[0].overscaledZ>ut[ut.length-1].overscaledZ))return void(this._overlapStencilType=!1);It=1,this._overlapStencilMode.test={func:St.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+It>255&&(Tt.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=It,this._overlapStencilMode.ref=this._stencilRef,pt.isTileClipped()&&this._renderTileClippingMasks(ut,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(ut){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[ut.key]),this._overlapStencilMode):Ye.ag.disabled}_renderTileClippingMasks(ut,pt){const wt=this.painter,Tt=this.painter.context,St=Tt.gl;wt._tileClippingMaskIDs={},Tt.setColorMode(Ye.a.disabled),Tt.setDepthMode(Ye.ae.disabled);const It=wt.getOrCreateProgram("clippingMask");for(const Tt of ut){const ut=wt._tileClippingMaskIDs[Tt.key]=--pt;It.draw(wt,St.TRIANGLES,Ye.ae.disabled,new Ye.ag({func:St.ALWAYS,mask:0},ut,255,St.KEEP,St.KEEP,St.REPLACE),Ye.a.disabled,Ye.af.disabled,Pi(Tt.projMatrix),"$clipping",wt.tileExtentBuffer,wt.quadTriangleIndexBuffer,wt.tileExtentSegments)}}pointCoordinate(ut){const pt=this.painter.transform;if(ut.x<0||ut.x>pt.width||ut.y<0||ut.y>pt.height)return null;const wt=[ut.x,ut.y,1,1];Ye.aA.transformMat4(wt,wt,pt.pixelMatrixInverse),Ye.aA.scale(wt,wt,1/wt[3]),wt[0]/=pt.worldSize,wt[1]/=pt.worldSize;const Tt=pt._camera.position,St=Ye.ax(1,pt.center.lat),It=[Tt[0],Tt[1],Tt[2]/St,0],Lt=Ye._.subtract([],wt.slice(0,3),It);Ye._.normalize(Lt,Lt);const $t=this.raycast(It,Lt,this._exaggeration);return null!==$t&&$t?(Ye._.scaleAndAdd(It,It,Lt,$t),It[3]=It[2],It[2]*=St,It):null}_setupProxiedCoordsForOrtho(ut,pt,wt){if(ut.getSource()instanceof Ye.bm)return this._setupProxiedCoordsForImageSource(ut,pt,wt);this._findCoveringTileCache[ut.id]=this._findCoveringTileCache[ut.id]||{};const Tt=this.proxiedCoords[ut.id]=[],St=this.proxyCoords;for(let Ye=0;Ye<St.length;Ye++){const pt=St[Ye],It=this._findTileCoveringTileID(pt,ut);if(It){const Ye=this._createProxiedId(pt,It,wt[pt.key]&&wt[pt.key][ut.id]);Tt.push(Ye),this.proxyToSource[pt.key][ut.id]=[Ye]}}let It=!1;const Lt=new Set;for(let Ye=0;Ye<pt.length;Ye++){const St=ut.getTile(pt[Ye]);if(!St||!St.hasData())continue;const $t=this._findTileCoveringTileID(St.tileID,this.proxySourceCache);if($t&&$t.tileID.canonical.z!==St.tileID.canonical.z){const Ye=this.proxyToSource[$t.tileID.key][ut.id],pt=this._createProxiedId($t.tileID,St,wt[$t.tileID.key]&&wt[$t.tileID.key][ut.id]);Ye?Ye.splice(Ye.length-1,0,pt):this.proxyToSource[$t.tileID.key][ut.id]=[pt];const Xt=this.proxyToSource[$t.tileID.key][ut.id];Lt.has(Xt)||Lt.add(Xt),Tt.push(pt),It=!0}}if(this._sourceTilesOverlap[ut.id]=It,It&&this._debugParams.sortTilesHiZFirst)for(const Ye of Lt)Ye.sort(((Ye,ut)=>ut.overscaledZ-Ye.overscaledZ))}_setupProxiedCoordsForImageSource(ut,pt,wt){if(!ut.getSource().loaded())return;const Tt=this.proxiedCoords[ut.id]=[],St=this.proxyCoords,It=ut.getSource(),Lt=It.tileID;if(!Lt)return;const $t=new Ye.P(Lt.x,Lt.y)._div(1<<Lt.z),Xt=It.coordinates.map(Ye.Y.fromLngLat).reduce(((Ye,ut)=>(Ye.min.x=Math.min(Ye.min.x,ut.x-$t.x),Ye.min.y=Math.min(Ye.min.y,ut.y-$t.y),Ye.max.x=Math.max(Ye.max.x,ut.x-$t.x),Ye.max.y=Math.max(Ye.max.y,ut.y-$t.y),Ye)),{min:new Ye.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new Ye.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),h=(ut,pt)=>{const wt=ut.wrap+ut.canonical.x/(1<<ut.canonical.z),Tt=ut.canonical.y/(1<<ut.canonical.z),St=Ye.a3/(1<<ut.canonical.z),It=pt.wrap+pt.canonical.x/(1<<pt.canonical.z),Lt=pt.canonical.y/(1<<pt.canonical.z);return wt+St<It+Xt.min.x||wt>It+Xt.max.x||Tt+St<Lt+Xt.min.y||Tt>Lt+Xt.max.y};for(let Ye=0;Ye<St.length;Ye++){const It=St[Ye];for(let Ye=0;Ye<pt.length;Ye++){const St=ut.getTile(pt[Ye]);if(!St||!St.hasData())continue;if(h(It,St.tileID))continue;const Lt=this._createProxiedId(It,St,wt[It.key]&&wt[It.key][ut.id]),$t=this.proxyToSource[It.key][ut.id];$t?$t.push(Lt):this.proxyToSource[It.key][ut.id]=[Lt],Tt.push(Lt)}}}_createProxiedId(ut,pt,wt){let Tt=this.orthoMatrix;if(wt){const Ye=wt.find((Ye=>Ye.key===pt.tileID.key));if(Ye)return Ye}if(pt.tileID.key!==ut.key){const wt=ut.canonical.z-pt.tileID.canonical.z;let St,It,Lt;Tt=Ye.ad.create();const $t=pt.tileID.wrap-ut.wrap<<ut.overscaledZ;wt>0?(St=Ye.a3>>wt,It=St*((pt.tileID.canonical.x<<wt)-ut.canonical.x+$t),Lt=St*((pt.tileID.canonical.y<<wt)-ut.canonical.y)):(St=Ye.a3<<-wt,It=Ye.a3*(pt.tileID.canonical.x-(ut.canonical.x+$t<<-wt)),Lt=Ye.a3*(pt.tileID.canonical.y-(ut.canonical.y<<-wt))),Ye.ad.ortho(Tt,0,St,0,St,0,1),Ye.ad.translate(Tt,Tt,[It,Lt,0])}return new Fi(pt.tileID,ut.key,Tt)}_findTileCoveringTileID(ut,pt){let wt=pt.getTile(ut);if(wt&&wt.hasData())return wt;const Tt=this._findCoveringTileCache[pt.id],St=Tt[ut.key];if(wt=St?pt.getTileByID(St):null,wt&&wt.hasData()||null===St)return wt;let It=wt?wt.tileID:ut,Lt=It.overscaledZ;const $t=pt.getSource().minzoom,Xt=[];if(!St){const Tt=pt.getSource().maxzoom;if(ut.canonical.z>=Tt){const wt=ut.canonical.z-Tt;pt.getSource().reparseOverscaled?(Lt=Math.max(ut.canonical.z+2,pt.transform.tileZoom),It=new Ye.aL(Lt,ut.wrap,Tt,ut.canonical.x>>wt,ut.canonical.y>>wt)):0!==wt&&(Lt=Tt,It=new Ye.aL(Lt,ut.wrap,Tt,ut.canonical.x>>wt,ut.canonical.y>>wt))}It.key!==ut.key&&(Xt.push(It.key),wt=pt.getTile(It))}const h=Ye=>{Xt.forEach((ut=>{Tt[ut]=Ye})),Xt.length=0};for(Lt-=1;Lt>=$t&&(!wt||!wt.hasData());Lt--){wt&&h(wt.tileID.key);const Ye=It.calculateScaledKey(Lt);if(wt=pt.getTileByID(Ye),wt&&wt.hasData())break;const ut=Tt[Ye];if(null===ut)break;void 0===ut?Xt.push(Ye):wt=pt.getTileByID(ut)}return h(wt?wt.tileID.key:null),wt&&wt.hasData()?wt:null}findDEMTileFor(Ye){return this.enabled?this._findTileCoveringTileID(Ye,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(Ye,ut){let pt=this._tilesDirty[Ye];pt||(pt=this._tilesDirty[Ye]={}),pt[ut.key]=!0}}function ki(ut,pt,wt){const Tt=function(ut,pt,wt){const Tt=Ye._.dot(pt,ut),St=Ye._.dot(wt,[.2126,.7152,.0722]),n=(Ye,ut,pt)=>(1-pt)*Ye+pt*ut,It=n(1-.3*Math.min(St,1),1,Math.min(Tt+1,1));return n(.92,1,Math.asin(Ye.at(pt[2],-1,1))/Math.PI+.5)*It}(ut,[0,0,1],pt),St=[0,0,0];Ye._.scale(St,wt.slice(0,3),Tt);const It=[0,0,0];Ye._.scale(It,pt.slice(0,3),ut[2]);const Lt=[0,0,0];return Ye._.add(Lt,St,It),Ye.b8(Lt)}const ic=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],nc=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class Gi{static cacheKey(Ye,ut,pt,wt){let Tt=`${ut}${wt?wt.cacheKey:""}`;for(const ut of pt)Ye.usedDefines.includes(ut)&&(Tt+=`/${ut}`);return Tt}constructor(ut,pt,wt,Tt,St,It){const Lt=ut.gl;this.program=Lt.createProgram(),this.configuration=Tt,this.name=pt,this.fixedDefines=[...It];const $t=Tt?Tt.getBinderAttributes():[],Xt=(wt.staticAttributes||[]).concat($t);let Sr=Tt?Tt.defines():[];Sr=Sr.concat(It.map((Ye=>`#define ${Ye}`)));const Lr="#version 300 es\n";let Qr=Lr+Sr.concat("precision mediump float;",La,Ra.fragmentSource).join("\n");for(const Ye of wt.fragmentIncludes)Qr+=`\n${ua[Ye]}`;Qr+=`\n${wt.fragmentSource}`;let fn=Lr+Sr.concat("precision highp float;",La,Ra.vertexSource).join("\n");for(const Ye of wt.vertexIncludes)fn+=`\n${ua[Ye]}`;fn+=`\n${wt.vertexSource}`;const xn=Lt.createShader(Lt.FRAGMENT_SHADER);if(Lt.isContextLost())return void(this.failedToCreate=!0);Lt.shaderSource(xn,Qr),Lt.compileShader(xn),Lt.attachShader(this.program,xn);const vn=Lt.createShader(Lt.VERTEX_SHADER);if(Lt.isContextLost())this.failedToCreate=!0;else{Lt.shaderSource(vn,fn),Lt.compileShader(vn),Lt.attachShader(this.program,vn),this.attributes={},this.numAttributes=Xt.length;for(let Ye=0;Ye<this.numAttributes;Ye++)if(Xt[Ye]){const ut=Xt[Ye].startsWith("a_")?Xt[Ye]:`a_${Xt[Ye]}`;Lt.bindAttribLocation(this.program,Ye,ut),this.attributes[ut]=Ye}Lt.linkProgram(this.program),Lt.deleteShader(vn),Lt.deleteShader(xn),this.fixedUniforms=St(ut),this.binderUniforms=Tt?Tt.getUniforms(ut):[],It.includes("TERRAIN")&&(this.terrainUniforms=(ut=>({u_dem:new Ye.a7(ut),u_dem_prev:new Ye.a7(ut),u_dem_tl:new Ye.a8(ut),u_dem_scale:new Ye.aa(ut),u_dem_tl_prev:new Ye.a8(ut),u_dem_scale_prev:new Ye.aa(ut),u_dem_size:new Ye.aa(ut),u_dem_lerp:new Ye.aa(ut),u_exaggeration:new Ye.aa(ut),u_depth:new Ye.a7(ut),u_depth_size_inv:new Ye.a8(ut),u_depth_range_unpack:new Ye.a8(ut),u_meter_to_dem:new Ye.aa(ut),u_label_plane_matrix_inv:new Ye.a6(ut)}))(ut)),It.includes("GLOBE")&&(this.globeUniforms=(ut=>({u_tile_tl_up:new Ye.aq(ut),u_tile_tr_up:new Ye.aq(ut),u_tile_br_up:new Ye.aq(ut),u_tile_bl_up:new Ye.aq(ut),u_tile_up_scale:new Ye.aa(ut)}))(ut)),It.includes("FOG")&&(this.fogUniforms=(ut=>({u_fog_matrix:new Ye.a6(ut),u_fog_range:new Ye.a8(ut),u_fog_color:new Ye.as(ut),u_fog_horizon_blend:new Ye.aa(ut),u_fog_vertical_limit:new Ye.a8(ut),u_fog_temporal_offset:new Ye.aa(ut),u_frustum_tl:new Ye.aq(ut),u_frustum_tr:new Ye.aq(ut),u_frustum_br:new Ye.aq(ut),u_frustum_bl:new Ye.aq(ut),u_globe_pos:new Ye.aq(ut),u_globe_radius:new Ye.aa(ut),u_globe_transition:new Ye.aa(ut),u_is_globe:new Ye.a7(ut),u_viewport:new Ye.a8(ut)}))(ut)),It.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(ut=>({u_cutoff_params:new Ye.as(ut)}))(ut)),It.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(ut=>({u_lighting_ambient_color:new Ye.aq(ut),u_lighting_directional_dir:new Ye.aq(ut),u_lighting_directional_color:new Ye.aq(ut),u_ground_radiance:new Ye.aq(ut)}))(ut)),It.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(ut=>({u_light_matrix_0:new Ye.a6(ut),u_light_matrix_1:new Ye.a6(ut),u_fade_range:new Ye.a8(ut),u_shadow_normal_offset:new Ye.aq(ut),u_shadow_intensity:new Ye.aa(ut),u_shadow_texel_size:new Ye.aa(ut),u_shadow_map_resolution:new Ye.aa(ut),u_shadow_direction:new Ye.aq(ut),u_shadow_bias:new Ye.aq(ut),u_shadowmap_0:new Ye.a7(ut),u_shadowmap_1:new Ye.a7(ut)}))(ut))}}setTerrainUniformValues(Ye,ut){if(!this.terrainUniforms)return;const pt=this.terrainUniforms;if(!this.failedToCreate){Ye.program.set(this.program);for(const Ye in ut)pt[Ye]&&pt[Ye].set(this.program,Ye,ut[Ye])}}setGlobeUniformValues(Ye,ut){if(!this.globeUniforms)return;const pt=this.globeUniforms;if(!this.failedToCreate){Ye.program.set(this.program);for(const Ye in ut)pt[Ye]&&pt[Ye].set(this.program,Ye,ut[Ye])}}setFogUniformValues(Ye,ut){if(!this.fogUniforms)return;const pt=this.fogUniforms;if(!this.failedToCreate){Ye.program.set(this.program);for(const Ye in ut)pt[Ye].set(this.program,Ye,ut[Ye])}}setCutoffUniformValues(Ye,ut){if(!this.cutoffUniforms)return;const pt=this.cutoffUniforms;if(!this.failedToCreate){Ye.program.set(this.program);for(const Ye in ut)pt[Ye].set(this.program,Ye,ut[Ye])}}setLightsUniformValues(Ye,ut){if(!this.lightsUniforms)return;const pt=this.lightsUniforms;if(!this.failedToCreate){Ye.program.set(this.program);for(const Ye in ut)pt[Ye].set(this.program,Ye,ut[Ye])}}setShadowUniformValues(Ye,ut){if(this.failedToCreate||!this.shadowUniforms)return;const pt=this.shadowUniforms;Ye.program.set(this.program);for(const Ye in ut)pt[Ye].set(this.program,Ye,ut[Ye])}_drawDebugWireframe(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr){const Lr=ut.options.wireframe;if(!1===Lr.terrain&&!1===Lr.layers2D&&!1===Lr.layers3D)return;const Qr=ut.context;if(!(()=>!(!Lr.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!Lr.layers2D||ut._terrain&&ut._terrain.renderingToTexture||!ic.includes(this.name))||!(!Lr.layers3D||!nc.includes(this.name)))())return;const fn=Qr.gl,xn=ut.wireframeDebugCache.getLinesFromTrianglesBuffer(ut.frameCounter,St,Qr);if(!xn)return;const vn=[...this.fixedDefines];vn.push("DEBUG_WIREFRAME");const kn=ut.getOrCreateProgram(this.name,{config:this.configuration,defines:vn});Qr.program.set(kn.program);const g=(Ye,ut,pt)=>{if(ut[Ye]&&pt[Ye])for(const wt in ut[Ye])pt[Ye][wt]&&pt[Ye][wt].set(pt.program,wt,ut[Ye][wt].current)};Xt&&Xt.setUniforms(kn.program,Qr,kn.binderUniforms,Lt,{zoom:$t}),g("fixedUniforms",this,kn),g("terrainUniforms",this,kn),g("globeUniforms",this,kn),g("fogUniforms",this,kn),g("lightsUniforms",this,kn),g("shadowUniforms",this,kn),xn.bind(),Qr.setColorMode(new Ye.a([fn.ONE,fn.ONE_MINUS_SRC_ALPHA,fn.ZERO,fn.ONE],Ye.C.transparent,[!0,!0,!0,!1])),Qr.setDepthMode(new Ye.ae(pt.func===fn.LESS?fn.LEQUAL:pt.func,Ye.ae.ReadOnly,pt.range)),Qr.setStencilMode(Ye.ag.disabled);const Wn=3*It.primitiveLength*2,Xn=3*It.primitiveOffset*2*2;Sr&&Sr>1?fn.drawElementsInstanced(fn.LINES,Wn,fn.UNSIGNED_SHORT,Xn,Sr):fn.drawElements(fn.LINES,Wn,fn.UNSIGNED_SHORT,Xn),St.bind(),Qr.program.set(this.program),Qr.setDepthMode(pt),Qr.setStencilMode(wt),Qr.setColorMode(Tt)}draw(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn){const kn=Ye.context,Wn=kn.gl;if(this.failedToCreate)return;kn.program.set(this.program),kn.setDepthMode(pt),kn.setStencilMode(wt),kn.setColorMode(Tt),kn.setCullFace(St);for(const Ye of Object.keys(this.fixedUniforms))this.fixedUniforms[Ye].set(this.program,Ye,It[Ye]);fn&&fn.setUniforms(this.program,kn,this.binderUniforms,Lr,{zoom:Qr});const Xn={[Wn.POINTS]:1,[Wn.LINES]:2,[Wn.TRIANGLES]:3,[Wn.LINE_STRIP]:1}[ut],Jn=vn&&vn>0?1:void 0;for(const St of Sr.get()){const It=St.vaos||(St.vaos={});(It[Lt]||(It[Lt]=new Rt)).bind(kn,this,$t,fn?fn.getPaintVertexBuffers():[],Xt,St.vertexOffset,xn||[],Jn),vn&&vn>1?Wn.drawElementsInstanced(ut,St.primitiveLength*Xn,Wn.UNSIGNED_SHORT,St.primitiveOffset*Xn*2,vn):Xt?Wn.drawElements(ut,St.primitiveLength*Xn,Wn.UNSIGNED_SHORT,St.primitiveOffset*Xn*2):Wn.drawArrays(ut,St.vertexOffset,St.vertexLength),ut===Wn.TRIANGLES&&Xt&&this._drawDebugWireframe(Ye,pt,wt,Tt,Xt,St,Lr,Qr,fn,vn)}}}function ji(ut,pt){const wt=Math.pow(2,pt.tileID.overscaledZ),Tt=pt.tileSize*Math.pow(2,ut.transform.tileZoom)/wt,St=Tt*(pt.tileID.canonical.x+pt.tileID.wrap*wt),It=Tt*pt.tileID.canonical.y;return{u_image:0,u_texsize:pt.imageAtlasTexture?pt.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/Ye.bB(pt,1,ut.transform.tileZoom),u_pixel_coord_upper:[St>>16,It>>16],u_pixel_coord_lower:[65535&St,65535&It]}}const oc=Ye.ad.create(),Wi=(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn)=>{const Wn=pt.style.light,Xn=Wn.properties.get("position"),Jn=[Xn.x,Xn.y,Xn.z],Qn=Ye.bC.create();"viewport"===Wn.properties.get("anchor")&&(Ye.bC.fromRotation(Qn,-pt.transform.angle),Ye._.transformMat3(Jn,Jn,Qn));const ko=Wn.properties.get("color"),Fo=pt.transform,is={u_matrix:ut,u_lightpos:Jn,u_lightintensity:Wn.properties.get("intensity"),u_lightcolor:[ko.r,ko.g,ko.b],u_vertical_gradient:+wt,u_opacity:Tt,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:oc,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:St,u_edge_radius:It,u_flood_light_color:Qr,u_vertical_scale:fn,u_flood_light_intensity:xn,u_ground_shadow_factor:vn,u_emissive_strength:kn};return"globe"===Fo.projection.name&&(is.u_tile_id=[Lt.canonical.x,Lt.canonical.y,1<<Lt.canonical.z],is.u_zoom_transition=Xt,is.u_inv_rot_matrix=Lr,is.u_merc_center=Sr,is.u_up_dir=Fo.projection.upVector(new Ye.aO(0,0,0),Sr[0]*Ye.a3,Sr[1]*Ye.a3),is.u_height_lift=$t),is},Zi=(Ye,ut,pt)=>({u_matrix:Ye,u_edge_radius:ut,u_vertical_scale:pt}),qi=(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn)=>{const vn=Wi(ut,pt,wt,Tt,St,It,Lt,Xt,Sr,Lr,Qr,fn,xn,1,[0,0,0],0),kn={u_height_factor:-Math.pow(2,Lt.overscaledZ)/$t.tileSize/8};return Ye.W(vn,ji(pt,$t),kn)},Hi=(Ye,ut)=>({u_matrix:Ye,u_emissive_strength:ut}),$i=(ut,pt,wt,Tt)=>Ye.W(Hi(ut,pt),ji(wt,Tt)),Xi=(Ye,ut,pt)=>({u_matrix:Ye,u_world:pt,u_emissive_strength:ut}),Yi=(ut,pt,wt,Tt,St)=>Ye.W($i(ut,pt,wt,Tt),{u_world:St}),Ki=(ut,pt,wt,Tt)=>{const St=Ye.a3/wt.tileSize;return{u_matrix:ut,u_camera_to_center_distance:pt.getCameraToCenterDistance(Tt),u_extrude_scale:[pt.pixelsToGLUnits[0]/St,pt.pixelsToGLUnits[1]/St]}},Qi=(Ye,ut,pt=1)=>({u_matrix:Ye,u_color:ut.toRenderColor(null),u_overlay:0,u_overlay_scale:pt}),sc=Ye.ad.create(),eo=(ut,pt,wt,Tt,St,It,Lt)=>{const $t=ut.transform,Xt="globe"===$t.projection.name,Sr=Xt?Ye.bD($t.zoom,pt.canonical)*$t._pixelsPerMercatorPixel:Ye.bB(wt,1,It),Lr={u_matrix:pt.projMatrix,u_extrude_scale:Sr,u_intensity:Lt,u_inv_rot_matrix:sc,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(Xt){Lr.u_inv_rot_matrix=Tt,Lr.u_merc_center=St,Lr.u_tile_id=[pt.canonical.x,pt.canonical.y,1<<pt.canonical.z],Lr.u_zoom_transition=Ye.a1($t.zoom);const ut=St[0]*Ye.a3,wt=St[1]*Ye.a3;Lr.u_up_dir=$t.projection.upVector(new Ye.aO(0,0,0),ut,wt)}return Lr};function to(Ye,[ut,pt,wt,Tt],[St,It]){if(St===It)return[0,0,0,0];const Lt=255*(Ye-1)/(Ye*(It-St));return[ut*Lt,pt*Lt,wt*Lt,Tt*Lt]}function io(Ye,ut,[pt,wt]){return pt===wt?0:.5/Ye+(ut-pt)*(Ye-1)/(Ye*(wt-pt))}const oo=(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn,Qn,ko)=>({u_matrix:ut,u_normalize_matrix:pt,u_globe_matrix:wt,u_merc_matrix:Tt,u_grid_matrix:St,u_tl_parent:It,u_scale_parent:Sr,u_fade_t:Lr.mix,u_opacity:Lr.opacity*Qr.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:Qr.paint.get("raster-brightness-min"),u_brightness_high:Qr.paint.get("raster-brightness-max"),u_saturation_factor:Ye.bE(Qr.paint.get("raster-saturation")),u_contrast_factor:Ye.bF(Qr.paint.get("raster-contrast")),u_spin_weights:ro(Qr.paint.get("raster-hue-rotate")),u_perspective_transform:fn,u_raster_elevation:xn,u_zoom_transition:Lt,u_merc_center:$t,u_cutoff_params:Xt,u_colorization_mix:to(Ye.bG,kn,Xn),u_colorization_offset:io(Ye.bG,Wn,Xn),u_color_ramp:vn,u_texture_offset:[Qn/(Jn+2*Qn),Jn/(Jn+2*Qn)],u_texture_res:[Jn+2*Qn,Jn+2*Qn],u_emissive_strength:ko});function ro(Ye){Ye*=Math.PI/180;const ut=Math.sin(Ye),pt=Math.cos(Ye);return[(2*pt+1)/3,(-Math.sqrt(3)*ut-pt+1)/3,(Math.sqrt(3)*ut-pt+1)/3]}const ac=.05,no=(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr)=>({u_matrix:Ye,u_normalize_matrix:ut,u_globe_matrix:pt,u_merc_matrix:wt,u_grid_matrix:Tt,u_tl_parent:St,u_scale_parent:Xt,u_fade_t:Sr.mix,u_opacity:Sr.opacity,u_image0:0,u_image1:1,u_raster_elevation:Lr,u_zoom_transition:It,u_merc_center:Lt,u_cutoff_params:$t}),so=(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt)=>({u_particle_texture:Ye,u_particle_texture_side_len:ut,u_tile_offset:pt,u_velocity:wt,u_color_ramp:St,u_velocity_res:Tt,u_max_speed:It,u_uv_offset:Lt,u_data_scale:[255*$t[0],255*$t[1]],u_data_offset:Xt,u_particle_pos_scale:1.1,u_particle_pos_offset:[ac,ac]}),lo=(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt)=>({u_particle_texture:Ye,u_particle_texture_side_len:ut,u_velocity:pt,u_velocity_res:wt,u_max_speed:Tt,u_speed_factor:St,u_reset_rate:It,u_rand_seed:Math.random(),u_uv_offset:Lt,u_data_scale:[255*$t[0],255*$t[1]],u_data_offset:Xt,u_particle_pos_scale:1.1,u_particle_pos_offset:[ac,ac]}),lc=Ye.ad.create(),ho=(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn)=>{const Jn=St.transform,Qn={u_is_size_zoom_constant:+("constant"===ut||"source"===ut),u_is_size_feature_constant:+("constant"===ut||"camera"===ut),u_size_t:pt?pt.uSizeT:0,u_size:pt?pt.uSize:0,u_camera_to_center_distance:Jn.getCameraToCenterDistance(kn),u_rotate_symbol:+wt,u_aspect_ratio:Jn.width/Jn.height,u_fade_change:St.options.fadeDuration?St.symbolFadeChange:1,u_matrix:It,u_label_plane_matrix:Lt,u_coord_matrix:$t,u_is_text:+Xt,u_pitch_with_map:+Tt,u_texsize:Sr,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:lc,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:lc,u_up_vector:[0,-1,0],u_color_adj_mat:Wn,u_icon_transition:Xn||0};return"globe"===kn.name&&(Qn.u_tile_id=[Lr.canonical.x,Lr.canonical.y,1<<Lr.canonical.z],Qn.u_zoom_transition=Qr,Qn.u_inv_rot_matrix=xn,Qn.u_merc_center=fn,Qn.u_camera_forward=Jn._camera.forward(),Qn.u_ecef_origin=Ye.bH(Jn.globeMatrix,Lr.toUnwrapped()),Qn.u_tile_matrix=Float32Array.from(Jn.globeMatrix),Qn.u_up_vector=vn),Qn},_o=(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn)=>Ye.W(ho(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Qr,fn,xn,vn,kn,Wn),{u_gamma_scale:Tt?St.transform.getCameraToCenterDistance(Wn)*Math.cos(St.terrain?0:St.transform._pitch):1,u_device_pixel_ratio:Ye.e.devicePixelRatio,u_is_halo:+Lr,undefined:void 0}),uo=(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn)=>Ye.W(_o(ut,pt,wt,Tt,St,It,Lt,$t,!0,Xt,!0,Lr,Qr,fn,xn,vn,kn),{u_texsize_icon:Sr,u_texture_icon:1}),po=(Ye,ut,pt,wt)=>({u_matrix:Ye,u_emissive_strength:ut,u_opacity:pt,u_color:wt}),fo=(ut,pt,wt,Tt,St,It,Lt,$t)=>Ye.W(function(ut,pt,wt,Tt,St){const{width:It,height:Lt}=Tt.imageManager.getPixelSize(pt),$t=Math.pow(2,St.tileID.overscaledZ),Xt=St.tileSize*Math.pow(2,Tt.transform.tileZoom)/$t,Sr=Xt*(St.tileID.canonical.x+St.tileID.wrap*$t),Lr=Xt*St.tileID.canonical.y;return{u_image:0,u_pattern_tl:wt.tl,u_pattern_br:wt.br,u_texsize:[It,Lt],u_pattern_size:wt.displaySize,u_tile_units_to_pixels:1/Ye.bB(St,1,Tt.transform.tileZoom),u_pixel_coord_upper:[Sr>>16,Lr>>16],u_pixel_coord_lower:[65535&Sr,65535&Lr]}}(0,It,Lt,Tt,$t),{u_matrix:ut,u_emissive_strength:pt,u_opacity:wt}),cc=new Float32Array(Ye.ad.identity([])),go=(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn=[0,0,0],vn)=>{const kn=St.style.light,Wn=kn.properties.get("position"),Xn=[-Wn.x,-Wn.y,Wn.z],Jn=Ye.bC.create();"viewport"===kn.properties.get("anchor")&&(Ye.bC.fromRotation(Jn,-St.transform.angle),Ye._.transformMat3(Xn,Xn,Jn));const Qn="MASK"===Lr.alphaMode,ko=kn.properties.get("color").toRenderColor(null),Fo=fn.paint.get("model-ambient-occlusion-intensity"),is=fn.paint.get("model-color").constantOr(Ye.C.white).toRenderColor(null),ns=fn.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:ut,u_lighting_matrix:pt,u_normal_matrix:wt,u_node_matrix:Tt||cc,u_lightpos:Xn,u_lightintensity:kn.properties.get("intensity"),u_lightcolor:[ko.r,ko.g,ko.b],u_camera_pos:xn,u_opacity:It,u_baseTextureIsAlpha:0,u_alphaMask:+Qn,u_alphaCutoff:Lr.alphaCutoff,u_baseColorFactor:[Lt.r,Lt.g,Lt.b,Lt.a],u_emissiveFactor:[$t[0],$t[1],$t[2],1],u_metallicFactor:Xt,u_roughnessFactor:Sr,u_baseColorTexture:Al.BaseColor,u_metallicRoughnessTexture:Al.MetallicRoughness,u_normalTexture:Al.Normal,u_occlusionTexture:Al.Occlusion,u_emissionTexture:Al.Emission,u_lutTexture:Al.LUT,u_color_mix:[is.r,is.g,is.b,ns],u_aoIntensity:Fo,u_emissive_strength:Qr,u_occlusionTextureTransform:vn||[0,0,0,0]}},vo=(Ye,ut=cc,pt=cc)=>({u_matrix:Ye,u_instance:ut,u_node_matrix:pt}),xo=(Ye,ut,pt,wt,Tt)=>({u_matrix:Float32Array.from(Ye),u_anchorPos:ut,u_screenSizePx:pt,u_occluderSizePx:wt,u_color:Tt}),uc={fillExtrusion:ut=>({u_matrix:new Ye.a6(ut),u_lightpos:new Ye.aq(ut),u_lightintensity:new Ye.aa(ut),u_lightcolor:new Ye.aq(ut),u_vertical_gradient:new Ye.aa(ut),u_opacity:new Ye.aa(ut),u_edge_radius:new Ye.aa(ut),u_ao:new Ye.a8(ut),u_tile_id:new Ye.aq(ut),u_zoom_transition:new Ye.aa(ut),u_inv_rot_matrix:new Ye.a6(ut),u_merc_center:new Ye.a8(ut),u_up_dir:new Ye.aq(ut),u_height_lift:new Ye.aa(ut),u_flood_light_color:new Ye.aq(ut),u_vertical_scale:new Ye.aa(ut),u_flood_light_intensity:new Ye.aa(ut),u_ground_shadow_factor:new Ye.aq(ut),u_emissive_strength:new Ye.aa(ut)}),fillExtrusionDepth:ut=>({u_matrix:new Ye.a6(ut),u_edge_radius:new Ye.aa(ut),u_vertical_scale:new Ye.aa(ut)}),fillExtrusionPattern:ut=>({u_matrix:new Ye.a6(ut),u_lightpos:new Ye.aq(ut),u_lightintensity:new Ye.aa(ut),u_lightcolor:new Ye.aq(ut),u_vertical_gradient:new Ye.aa(ut),u_height_factor:new Ye.aa(ut),u_edge_radius:new Ye.aa(ut),u_ao:new Ye.a8(ut),u_tile_id:new Ye.aq(ut),u_zoom_transition:new Ye.aa(ut),u_inv_rot_matrix:new Ye.a6(ut),u_merc_center:new Ye.a8(ut),u_up_dir:new Ye.aq(ut),u_height_lift:new Ye.aa(ut),u_image:new Ye.a7(ut),u_texsize:new Ye.a8(ut),u_pixel_coord_upper:new Ye.a8(ut),u_pixel_coord_lower:new Ye.a8(ut),u_tile_units_to_pixels:new Ye.aa(ut),u_opacity:new Ye.aa(ut)}),fillExtrusionGroundEffect:ut=>({u_matrix:new Ye.a6(ut),u_opacity:new Ye.aa(ut),u_ao_pass:new Ye.aa(ut),u_meter_to_tile:new Ye.aa(ut),u_ao:new Ye.a8(ut),u_flood_light_intensity:new Ye.aa(ut),u_flood_light_color:new Ye.aq(ut),u_attenuation:new Ye.aa(ut),u_edge_radius:new Ye.aa(ut),u_fb:new Ye.a7(ut),u_fb_size:new Ye.aa(ut)}),fill:ut=>({u_matrix:new Ye.a6(ut),u_emissive_strength:new Ye.aa(ut)}),fillPattern:ut=>({u_matrix:new Ye.a6(ut),u_emissive_strength:new Ye.aa(ut),u_image:new Ye.a7(ut),u_texsize:new Ye.a8(ut),u_pixel_coord_upper:new Ye.a8(ut),u_pixel_coord_lower:new Ye.a8(ut),u_tile_units_to_pixels:new Ye.aa(ut)}),fillOutline:ut=>({u_matrix:new Ye.a6(ut),u_emissive_strength:new Ye.aa(ut),u_world:new Ye.a8(ut)}),fillOutlinePattern:ut=>({u_matrix:new Ye.a6(ut),u_emissive_strength:new Ye.aa(ut),u_world:new Ye.a8(ut),u_image:new Ye.a7(ut),u_texsize:new Ye.a8(ut),u_pixel_coord_upper:new Ye.a8(ut),u_pixel_coord_lower:new Ye.a8(ut),u_tile_units_to_pixels:new Ye.aa(ut)}),circle:Ye.bI,collisionBox:ut=>({u_matrix:new Ye.a6(ut),u_camera_to_center_distance:new Ye.aa(ut),u_extrude_scale:new Ye.a8(ut)}),collisionCircle:ut=>({u_matrix:new Ye.a6(ut),u_inv_matrix:new Ye.a6(ut),u_camera_to_center_distance:new Ye.aa(ut),u_viewport_size:new Ye.a8(ut)}),debug:ut=>({u_color:new Ye.a9(ut),u_matrix:new Ye.a6(ut),u_overlay:new Ye.a7(ut),u_overlay_scale:new Ye.aa(ut)}),clippingMask:ut=>({u_matrix:new Ye.a6(ut)}),heatmap:ut=>({u_extrude_scale:new Ye.aa(ut),u_intensity:new Ye.aa(ut),u_matrix:new Ye.a6(ut),u_inv_rot_matrix:new Ye.a6(ut),u_merc_center:new Ye.a8(ut),u_tile_id:new Ye.aq(ut),u_zoom_transition:new Ye.aa(ut),u_up_dir:new Ye.aq(ut)}),heatmapTexture:ut=>({u_image:new Ye.a7(ut),u_color_ramp:new Ye.a7(ut),u_opacity:new Ye.aa(ut)}),hillshade:ut=>({u_matrix:new Ye.a6(ut),u_image:new Ye.a7(ut),u_latrange:new Ye.a8(ut),u_light:new Ye.a8(ut),u_shadow:new Ye.a9(ut),u_highlight:new Ye.a9(ut),u_emissive_strength:new Ye.aa(ut),u_accent:new Ye.a9(ut)}),hillshadePrepare:ut=>({u_matrix:new Ye.a6(ut),u_image:new Ye.a7(ut),u_dimension:new Ye.a8(ut),u_zoom:new Ye.aa(ut)}),line:Ye.bJ,linePattern:Ye.bK,raster:ut=>({u_matrix:new Ye.a6(ut),u_normalize_matrix:new Ye.a6(ut),u_globe_matrix:new Ye.a6(ut),u_merc_matrix:new Ye.a6(ut),u_grid_matrix:new Ye.ar(ut),u_tl_parent:new Ye.a8(ut),u_scale_parent:new Ye.aa(ut),u_fade_t:new Ye.aa(ut),u_opacity:new Ye.aa(ut),u_image0:new Ye.a7(ut),u_image1:new Ye.a7(ut),u_brightness_low:new Ye.aa(ut),u_brightness_high:new Ye.aa(ut),u_saturation_factor:new Ye.aa(ut),u_contrast_factor:new Ye.aa(ut),u_spin_weights:new Ye.aq(ut),u_perspective_transform:new Ye.a8(ut),u_raster_elevation:new Ye.aa(ut),u_zoom_transition:new Ye.aa(ut),u_merc_center:new Ye.a8(ut),u_cutoff_params:new Ye.as(ut),u_colorization_mix:new Ye.as(ut),u_colorization_offset:new Ye.aa(ut),u_color_ramp:new Ye.a7(ut),u_texture_offset:new Ye.a8(ut),u_texture_res:new Ye.a8(ut),u_emissive_strength:new Ye.aa(ut)}),rasterParticle:ut=>({u_matrix:new Ye.a6(ut),u_normalize_matrix:new Ye.a6(ut),u_globe_matrix:new Ye.a6(ut),u_merc_matrix:new Ye.a6(ut),u_grid_matrix:new Ye.ar(ut),u_tl_parent:new Ye.a8(ut),u_scale_parent:new Ye.aa(ut),u_fade_t:new Ye.aa(ut),u_opacity:new Ye.aa(ut),u_image0:new Ye.a7(ut),u_image1:new Ye.a7(ut),u_raster_elevation:new Ye.aa(ut),u_zoom_transition:new Ye.aa(ut),u_merc_center:new Ye.a8(ut),u_cutoff_params:new Ye.as(ut)}),rasterParticleTexture:ut=>({u_texture:new Ye.a7(ut),u_opacity:new Ye.aa(ut)}),rasterParticleDraw:ut=>({u_particle_texture:new Ye.a7(ut),u_particle_texture_side_len:new Ye.aa(ut),u_tile_offset:new Ye.a8(ut),u_velocity:new Ye.a7(ut),u_color_ramp:new Ye.a7(ut),u_velocity_res:new Ye.a8(ut),u_max_speed:new Ye.aa(ut),u_uv_offset:new Ye.a8(ut),u_data_scale:new Ye.a8(ut),u_data_offset:new Ye.aa(ut),u_particle_pos_scale:new Ye.aa(ut),u_particle_pos_offset:new Ye.a8(ut)}),rasterParticleUpdate:ut=>({u_particle_texture:new Ye.a7(ut),u_particle_texture_side_len:new Ye.aa(ut),u_velocity:new Ye.a7(ut),u_velocity_res:new Ye.a8(ut),u_max_speed:new Ye.aa(ut),u_speed_factor:new Ye.aa(ut),u_reset_rate:new Ye.aa(ut),u_rand_seed:new Ye.aa(ut),u_uv_offset:new Ye.a8(ut),u_data_scale:new Ye.a8(ut),u_data_offset:new Ye.aa(ut),u_particle_pos_scale:new Ye.aa(ut),u_particle_pos_offset:new Ye.a8(ut)}),symbolIcon:ut=>({u_is_size_zoom_constant:new Ye.a7(ut),u_is_size_feature_constant:new Ye.a7(ut),u_size_t:new Ye.aa(ut),u_size:new Ye.aa(ut),u_camera_to_center_distance:new Ye.aa(ut),u_rotate_symbol:new Ye.a7(ut),u_aspect_ratio:new Ye.aa(ut),u_fade_change:new Ye.aa(ut),u_matrix:new Ye.a6(ut),u_label_plane_matrix:new Ye.a6(ut),u_coord_matrix:new Ye.a6(ut),u_is_text:new Ye.a7(ut),u_pitch_with_map:new Ye.a7(ut),u_texsize:new Ye.a8(ut),u_tile_id:new Ye.aq(ut),u_zoom_transition:new Ye.aa(ut),u_inv_rot_matrix:new Ye.a6(ut),u_merc_center:new Ye.a8(ut),u_camera_forward:new Ye.aq(ut),u_tile_matrix:new Ye.a6(ut),u_up_vector:new Ye.aq(ut),u_ecef_origin:new Ye.aq(ut),u_texture:new Ye.a7(ut),u_icon_transition:new Ye.aa(ut),u_color_adj_mat:new Ye.a6(ut)}),symbolSDF:ut=>({u_is_size_zoom_constant:new Ye.a7(ut),u_is_size_feature_constant:new Ye.a7(ut),u_size_t:new Ye.aa(ut),u_size:new Ye.aa(ut),u_camera_to_center_distance:new Ye.aa(ut),u_rotate_symbol:new Ye.a7(ut),u_aspect_ratio:new Ye.aa(ut),u_fade_change:new Ye.aa(ut),u_matrix:new Ye.a6(ut),u_label_plane_matrix:new Ye.a6(ut),u_coord_matrix:new Ye.a6(ut),u_is_text:new Ye.a7(ut),u_pitch_with_map:new Ye.a7(ut),u_texsize:new Ye.a8(ut),u_texture:new Ye.a7(ut),u_gamma_scale:new Ye.aa(ut),u_device_pixel_ratio:new Ye.aa(ut),u_tile_id:new Ye.aq(ut),u_zoom_transition:new Ye.aa(ut),u_inv_rot_matrix:new Ye.a6(ut),u_merc_center:new Ye.a8(ut),u_camera_forward:new Ye.aq(ut),u_tile_matrix:new Ye.a6(ut),u_up_vector:new Ye.aq(ut),u_ecef_origin:new Ye.aq(ut),u_is_halo:new Ye.a7(ut)}),symbolTextAndIcon:ut=>({u_is_size_zoom_constant:new Ye.a7(ut),u_is_size_feature_constant:new Ye.a7(ut),u_size_t:new Ye.aa(ut),u_size:new Ye.aa(ut),u_camera_to_center_distance:new Ye.aa(ut),u_rotate_symbol:new Ye.a7(ut),u_aspect_ratio:new Ye.aa(ut),u_fade_change:new Ye.aa(ut),u_matrix:new Ye.a6(ut),u_label_plane_matrix:new Ye.a6(ut),u_coord_matrix:new Ye.a6(ut),u_is_text:new Ye.a7(ut),u_pitch_with_map:new Ye.a7(ut),u_texsize:new Ye.a8(ut),u_texsize_icon:new Ye.a8(ut),u_texture:new Ye.a7(ut),u_texture_icon:new Ye.a7(ut),u_gamma_scale:new Ye.aa(ut),u_device_pixel_ratio:new Ye.aa(ut),u_is_halo:new Ye.a7(ut)}),background:ut=>({u_matrix:new Ye.a6(ut),u_emissive_strength:new Ye.aa(ut),u_opacity:new Ye.aa(ut),u_color:new Ye.a9(ut)}),backgroundPattern:ut=>({u_matrix:new Ye.a6(ut),u_emissive_strength:new Ye.aa(ut),u_opacity:new Ye.aa(ut),u_image:new Ye.a7(ut),u_pattern_tl:new Ye.a8(ut),u_pattern_br:new Ye.a8(ut),u_texsize:new Ye.a8(ut),u_pattern_size:new Ye.a8(ut),u_pixel_coord_upper:new Ye.a8(ut),u_pixel_coord_lower:new Ye.a8(ut),u_tile_units_to_pixels:new Ye.aa(ut)}),terrainRaster:ut=>({u_matrix:new Ye.a6(ut),u_image0:new Ye.a7(ut),u_skirt_height:new Ye.aa(ut),u_ground_shadow_factor:new Ye.aq(ut)}),skybox:ut=>({u_matrix:new Ye.a6(ut),u_sun_direction:new Ye.aq(ut),u_cubemap:new Ye.a7(ut),u_opacity:new Ye.aa(ut),u_temporal_offset:new Ye.aa(ut)}),skyboxGradient:ut=>({u_matrix:new Ye.a6(ut),u_color_ramp:new Ye.a7(ut),u_center_direction:new Ye.aq(ut),u_radius:new Ye.aa(ut),u_opacity:new Ye.aa(ut),u_temporal_offset:new Ye.aa(ut)}),skyboxCapture:ut=>({u_matrix_3f:new Ye.ar(ut),u_sun_direction:new Ye.aq(ut),u_sun_intensity:new Ye.aa(ut),u_color_tint_r:new Ye.as(ut),u_color_tint_m:new Ye.as(ut),u_luminance:new Ye.aa(ut)}),globeRaster:ut=>({u_proj_matrix:new Ye.a6(ut),u_globe_matrix:new Ye.a6(ut),u_normalize_matrix:new Ye.a6(ut),u_merc_matrix:new Ye.a6(ut),u_zoom_transition:new Ye.aa(ut),u_merc_center:new Ye.a8(ut),u_image0:new Ye.a7(ut),u_grid_matrix:new Ye.ar(ut),u_skirt_height:new Ye.aa(ut),u_far_z_cutoff:new Ye.aa(ut),u_frustum_tl:new Ye.aq(ut),u_frustum_tr:new Ye.aq(ut),u_frustum_br:new Ye.aq(ut),u_frustum_bl:new Ye.aq(ut),u_globe_pos:new Ye.aq(ut),u_globe_radius:new Ye.aa(ut),u_viewport:new Ye.a8(ut)}),globeAtmosphere:ut=>({u_frustum_tl:new Ye.aq(ut),u_frustum_tr:new Ye.aq(ut),u_frustum_br:new Ye.aq(ut),u_frustum_bl:new Ye.aq(ut),u_horizon:new Ye.aa(ut),u_transition:new Ye.aa(ut),u_fadeout_range:new Ye.aa(ut),u_color:new Ye.as(ut),u_high_color:new Ye.as(ut),u_space_color:new Ye.as(ut),u_temporal_offset:new Ye.aa(ut),u_horizon_angle:new Ye.aa(ut)}),model:ut=>({u_matrix:new Ye.a6(ut),u_lighting_matrix:new Ye.a6(ut),u_normal_matrix:new Ye.a6(ut),u_node_matrix:new Ye.a6(ut),u_lightpos:new Ye.aq(ut),u_lightintensity:new Ye.aa(ut),u_lightcolor:new Ye.aq(ut),u_camera_pos:new Ye.aq(ut),u_opacity:new Ye.aa(ut),u_baseColorFactor:new Ye.as(ut),u_emissiveFactor:new Ye.as(ut),u_metallicFactor:new Ye.aa(ut),u_roughnessFactor:new Ye.aa(ut),u_baseTextureIsAlpha:new Ye.a7(ut),u_alphaMask:new Ye.a7(ut),u_alphaCutoff:new Ye.aa(ut),u_baseColorTexture:new Ye.a7(ut),u_metallicRoughnessTexture:new Ye.a7(ut),u_normalTexture:new Ye.a7(ut),u_occlusionTexture:new Ye.a7(ut),u_emissionTexture:new Ye.a7(ut),u_lutTexture:new Ye.a7(ut),u_color_mix:new Ye.as(ut),u_aoIntensity:new Ye.aa(ut),u_emissive_strength:new Ye.aa(ut),u_occlusionTextureTransform:new Ye.as(ut)}),modelDepth:ut=>({u_matrix:new Ye.a6(ut),u_instance:new Ye.a6(ut),u_node_matrix:new Ye.a6(ut)}),groundShadow:ut=>({u_matrix:new Ye.a6(ut),u_ground_shadow_factor:new Ye.aq(ut)}),stars:ut=>({u_matrix:new Ye.a6(ut),u_up:new Ye.aq(ut),u_right:new Ye.aq(ut),u_intensity_multiplier:new Ye.aa(ut)}),occlusion:ut=>({u_matrix:new Ye.a6(ut),u_anchorPos:new Ye.aq(ut),u_screenSizePx:new Ye.a8(ut),u_occluderSizePx:new Ye.a8(ut),u_color:new Ye.as(ut)})};function bo(ut,pt,wt){const Tt=pt.createTileMatrix(ut,ut.worldSize,wt.toUnwrapped());return Ye.ad.multiply(new Float32Array(16),ut.projMatrix,Tt)}function wo(Ye,ut,pt){if(ut.projection.name===pt.projection.name)return Ye.projMatrix;const wt=pt.clone();return wt.setProjection(ut.projection),bo(wt,ut.getProjection(),Ye)}function To(Ye,ut,pt){return ut.name===pt.projection.name?Ye.projMatrix:bo(pt,ut,Ye)}let dc;function Co(ut,pt,wt,Tt,St,It,Lt){const $t=ut.context,Xt=$t.gl,Sr=ut.transform,Lr=ut.getOrCreateProgram("collisionBox"),Qr=[];let fn=0,xn=0;for(let $t=0;$t<Tt.length;$t++){const vn=Tt[$t],kn=pt.getTile(vn),Wn=kn.getBucket(wt);if(!Wn)continue;const Xn=wo(vn,Wn,Sr);let Jn=Xn;0===St[0]&&0===St[1]||(Jn=ut.translatePosMatrix(Xn,kn,St,It));const Qn=Lt?Wn.textCollisionBox:Wn.iconCollisionBox,ko=Wn.collisionCircleArray;if(ko.length>0){const ut=Ye.ad.create(),pt=Jn;Ye.ad.mul(ut,Wn.placementInvProjMatrix,Sr.glCoordMatrix),Ye.ad.mul(ut,ut,Wn.placementViewportMatrix),Qr.push({circleArray:ko,circleOffset:xn,transform:pt,invTransform:ut,projection:Wn.getProjection()}),fn+=ko.length/4,xn=fn}Qn&&(ut.terrain&&ut.terrain.setupElevationDraw(kn,Lr),Lr.draw(ut,Xt.LINES,Ye.ae.disabled,Ye.ag.disabled,ut.colorModeForRenderPass(),Ye.af.disabled,Ki(Jn,Sr,kn,Wn.getProjection()),wt.id,Qn.layoutVertexBuffer,Qn.indexBuffer,Qn.segments,null,Sr.zoom,null,[Qn.collisionVertexBuffer,Qn.collisionVertexBufferExt]))}if(!Lt||!Qr.length)return;const vn=ut.getOrCreateProgram("collisionCircle"),kn=new Ye.bL;kn.resize(4*fn),kn._trim();let Wn=0;for(const Ye of Qr)for(let ut=0;ut<Ye.circleArray.length/4;ut++){const pt=4*ut,wt=Ye.circleArray[pt+0],Tt=Ye.circleArray[pt+1],St=Ye.circleArray[pt+2],It=Ye.circleArray[pt+3];kn.emplace(Wn++,wt,Tt,St,It,0),kn.emplace(Wn++,wt,Tt,St,It,1),kn.emplace(Wn++,wt,Tt,St,It,2),kn.emplace(Wn++,wt,Tt,St,It,3)}(!dc||dc.length<2*fn)&&(dc=function(ut){const pt=2*ut,wt=new Ye.bu;wt.resize(pt),wt._trim();for(let Ye=0;Ye<pt;Ye++){const ut=6*Ye;wt.uint16[ut+0]=4*Ye+0,wt.uint16[ut+1]=4*Ye+1,wt.uint16[ut+2]=4*Ye+2,wt.uint16[ut+3]=4*Ye+2,wt.uint16[ut+4]=4*Ye+3,wt.uint16[ut+5]=4*Ye+0}return wt}(fn));const Xn=$t.createIndexBuffer(dc,!0),Jn=$t.createVertexBuffer(kn,Ye.bM.members,!0);for(const pt of Qr){const Tt={u_matrix:pt.transform,u_inv_matrix:pt.invTransform,u_camera_to_center_distance:(Qn=Sr).getCameraToCenterDistance(pt.projection),u_viewport_size:[Qn.width,Qn.height]};vn.draw(ut,Xt.TRIANGLES,Ye.ae.disabled,Ye.ag.disabled,ut.colorModeForRenderPass(),Ye.af.disabled,Tt,wt.id,Jn,Xn,Ye.b.simpleSegment(0,2*pt.circleOffset,pt.circleArray.length,pt.circleArray.length/2),null,Sr.zoom)}var Qn;Jn.destroy(),Xn.destroy()}const fc=Ye.ad.create();function Io(ut){const pt=ut._camera.getWorldToCamera(ut.worldSize,1),wt=Ye.ad.multiply([],pt,ut.globeMatrix);Ye.ad.invert(wt,wt);const Tt=[0,0,0],St=[0,1,0,0];return Ye.aA.transformMat4(St,St,wt),Tt[0]=St[0],Tt[1]=St[1],Tt[2]=St[2],Ye._.normalize(Tt,Tt),Tt}function Lo({width:ut,height:pt,anchor:wt,textOffset:Tt,textScale:St},It){const{horizontalAlign:Lt,verticalAlign:$t}=Ye.bQ(wt),Xt=-(Lt-.5)*ut,Sr=-($t-.5)*pt,Lr=Ye.bP(wt,Tt);return new Ye.P((Xt/St+Lr[0])*It,(Sr/St+Lr[1])*It)}function Po(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr){const Qr=ut.text.placedSymbolArray,fn=ut.text.dynamicLayoutVertexArray,xn=ut.icon.dynamicLayoutVertexArray,vn={},kn=ut.getProjection(),Wn=To($t,kn,It),Xn=It.elevation,Jn=kn.upVectorScale($t.canonical,It.center.lat,It.worldSize).metersToTile;fn.clear();for(let xn=0;xn<Qr.length;xn++){const Qn=Qr.get(xn),{tileAnchorX:ko,tileAnchorY:Fo,numGlyphs:is}=Qn,ns=Qn.hidden||!Qn.crossTileID||ut.allowVerticalPlacement&&!Qn.placedOrientation?null:Tt[Qn.crossTileID];if(ns){let Tt=0,Qr=0,xn=0;if(Xn){const Ye=Xn?Xn.getAtTileOffset($t,ko,Fo):0,[ut,pt,wt]=kn.upVector($t.canonical,ko,Fo);Tt=Ye*ut*Jn,Qr=Ye*pt*Jn,xn=Ye*wt*Jn}let[ss,as,ds,ps]=Jt(Qn.projectedAnchorX+Tt,Qn.projectedAnchorY+Qr,Qn.projectedAnchorZ+xn,wt?Wn:Lt);const ms=ei(It.getCameraToCenterDistance(kn),ps);let Js=St.evaluateSizeForFeature(ut.textSizeData,Sr,Qn)*ms/Ye.bN;wt&&(Js*=ut.tilePixelRatio/Xt);const ua=Lo(ns,Js);wt?(({x:ss,y:as,z:ds}=kn.projectTilePoint(ko+ua.x,Fo+ua.y,$t.canonical)),[ss,as,ds]=Jt(ss+Tt,as+Qr,ds+xn,Lt)):(pt&&ua._rotate(-It.angle),ss+=ua.x,as+=ua.y,ds=0);const ba=ut.allowVerticalPlacement&&Qn.placedOrientation===Ye.aE.vertical?Math.PI/2:0;for(let ut=0;ut<is;ut++)Ye.aH(fn,ss,as,ds,ba);Lr&&Qn.associatedIconIndex>=0&&(vn[Qn.associatedIconIndex]={x:ss,y:as,z:ds,angle:ba})}else ci(is,fn)}if(Lr){xn.clear();const pt=ut.icon.placedSymbolArray;for(let ut=0;ut<pt.length;ut++){const wt=pt.get(ut),{numGlyphs:Tt}=wt,St=vn[ut];if(wt.hidden||!St)ci(Tt,xn);else{const{x:ut,y:pt,z:wt,angle:It}=St;for(let St=0;St<Tt;St++)Ye.aH(xn,ut,pt,wt,It)}}ut.icon.dynamicLayoutVertexBuffer.updateData(xn)}ut.text.dynamicLayoutVertexBuffer.updateData(fn)}function Ao(ut,pt,wt,Tt,St,It,Lt={}){const $t=wt.paint.get("icon-translate"),Xt=wt.paint.get("text-translate"),Sr=wt.paint.get("icon-translate-anchor"),Lr=wt.paint.get("text-translate-anchor"),Qr=wt.layout.get("icon-rotation-alignment"),fn=wt.layout.get("text-rotation-alignment"),xn=wt.layout.get("icon-pitch-alignment"),vn=wt.layout.get("text-pitch-alignment"),kn=wt.layout.get("icon-keep-upright"),Wn=wt.layout.get("text-keep-upright"),Xn=wt.paint.get("icon-color-saturation"),Jn=wt.paint.get("icon-color-contrast"),Qn=wt.paint.get("icon-color-brightness-min"),ko=wt.paint.get("icon-color-brightness-max"),Fo=wt.paint.get("icon-occlusion-opacity").constantOr(0),is=wt.paint.get("text-occlusion-opacity").constantOr(0),ns=ut.context,ss=ns.gl,as=ut.transform,ds="map"===Qr,ps="map"===fn,ms="map"===xn,Js="map"===vn,ua=1!==Fo,ba=1!==is,Ra=void 0!==wt.layout.get("symbol-sort-key").constantOr(1);let La=!1;const ll=ut.depthModeForSublayer(0,Ye.ae.ReadOnly),yl=[Ye.aj(as.center.lng),Ye.ak(as.center.lat)],Tl=wt.layout.get("text-variable-anchor"),Al="globe"===as.projection.name,Il=[],Pl=[0,-1,0];for(const St of Tt){const Tt=pt.getTile(St),It=Tt.getBucket(wt);if(!It)continue;if("mercator"===It.projection.name&&Al)continue;if(It.fullyClipped)continue;const Qr="globe"===It.projection.name,fn=Qr?Ye.a1(as.zoom):0,xn=To(St,It.getProjection(),as),vn=as.calculatePixelsToTileUnitsMatrix(Tt),Fo=Tl&&It.hasTextData(),is=It.hasIconTextFit()&&Fo&&It.hasIconData(),ns=It.getProjection().createInversionMatrix(as,St.canonical),O=()=>{const pt=ds&&"point"!==wt.layout.get("symbol-placement"),Lt=[];wt.hasInitialOcclusionOpacityProperties&&ua&&ut.symbolParams.useOcclusionQueries&&!Qr&&!Al&&Lt.push("OCCLUSION_QUERIES"),wt.hasInitialOcclusionOpacityProperties||Lt.push("SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH");const Xt=pt||is,Lr=wt.paint.get("icon-image-cross-fade").constantOr(0);ut.terrainRenderModeElevated()&&ms&&Lt.push("PITCH_WITH_MAP_TERRAIN"),Qr&&(Lt.push("PROJECTION_GLOBE_VIEW"),Xt&&Lt.push("PROJECTED_POS_ON_VIEWPORT")),Lr>0&&Lt.push("ICON_TRANSITION"),It.icon.zOffsetVertexBuffer&&Lt.push("Z_OFFSET"),Lt.push("TERRAIN_DEPTH_D24"),0===Xn&&0===Jn&&0===Qn&&1===ko||Lt.push("COLOR_ADJUSTMENT");const Wn=It.icon.programConfigurations.get(wt.id),Fo=ut.getOrCreateProgram(It.sdfIcons?"symbolSDF":"symbolIcon",{config:Wn,defines:Lt});let ps;const Js=Tt.imageAtlasTexture?Tt.imageAtlasTexture.size:[0,0],ba=It.iconSizeData,Ra=Ye.aD(ba,as.zoom),La=ms||0!==as.pitch,ll=Yt(xn,Tt.tileID.canonical,ms,ds,as,It.getProjection(),vn),Tl=Qt(xn,Tt.tileID.canonical,ms,ds,as,It.getProjection(),vn),Il=ut.translatePosMatrix(Tl,Tt,$t,Sr,!0),ec=ut.translatePosMatrix(xn,Tt,$t,Sr),tc=Xt?fc:ll,ic=ds&&!ms&&!pt;let nc=Pl;!Al&&!as.mercatorFromTransition||ds||(nc=Io(as));const oc=Qr?nc:Pl;if(It.sdfIcons&&!It.iconsInText)ps=_o(ba.kind,Ra,ic,ms,ut,ec,tc,Il,!1,Js,!0,St,fn,yl,ns,oc,It.getProjection());else{const Ye=wt.getColorAdjustmentMatrix(Xn,Jn,Qn,ko);ps=ho(ba.kind,Ra,ic,ms,ut,ec,tc,Il,!1,Js,St,fn,yl,ns,oc,It.getProjection(),Ye,Lr)}const sc=Tt.imageAtlasTexture?Tt.imageAtlasTexture:null,ac=1!==wt.layout.get("icon-size").constantOr(0)||It.iconsNeedLinear,lc=It.sdfIcons||ut.options.rotating||ut.options.zooming||ac||La?ss.LINEAR:ss.NEAREST,cc=It.sdfIcons&&0!==wt.paint.get("icon-halo-width").constantOr(1),uc=ut.terrain&&ms&&pt?Ye.ad.invert(Ye.ad.create(),ll):fc;if(pt&&It.icon){const Ye=as.elevation,pt=Ye?Ye.getAtTileOffsetFunc(St,as.center.lat,as.worldSize,It.getProjection()):null,wt=Kt(xn,Tt.tileID.canonical,ms,ds,as,It.getProjection(),vn);ii(It,xn,ut,!1,wt,Tl,ms,kn,pt,St)}return{program:Fo,buffers:It.icon,uniformValues:ps,atlasTexture:sc,atlasTextureIcon:null,atlasInterpolation:lc,atlasInterpolationIcon:null,isSDF:It.sdfIcons,hasHalo:cc,tile:Tt,labelPlaneMatrixInv:uc}},G=()=>{const pt=ps&&"point"!==wt.layout.get("symbol-placement"),Lt=[],$t=pt||Tl||is;wt.hasInitialOcclusionOpacityProperties&&ba&&ut.symbolParams.useOcclusionQueries&&!Qr&&!Al&&Lt.push("OCCLUSION_QUERIES"),wt.hasInitialOcclusionOpacityProperties||Lt.push("SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH"),ut.terrainRenderModeElevated()&&Js&&Lt.push("PITCH_WITH_MAP_TERRAIN"),Qr&&(Lt.push("PROJECTION_GLOBE_VIEW"),$t&&Lt.push("PROJECTED_POS_ON_VIEWPORT")),It.text.zOffsetVertexBuffer&&Lt.push("Z_OFFSET"),Lt.push("TERRAIN_DEPTH_D24");const Sr=It.text.programConfigurations.get(wt.id),kn=ut.getOrCreateProgram(It.iconsInText?"symbolTextAndIcon":"symbolSDF",{config:Sr,defines:Lt});let Xn,Jn=[0,0],Qn=null;const ko=It.textSizeData;It.iconsInText&&(Jn=Tt.imageAtlasTexture?Tt.imageAtlasTexture.size:[0,0],Qn=Tt.imageAtlasTexture?Tt.imageAtlasTexture:null,Xn=Js||0!==as.pitch||ut.options.rotating||ut.options.zooming||"composite"===ko.kind||"camera"===ko.kind?ss.LINEAR:ss.NEAREST);const Fo=Tt.glyphAtlasTexture?Tt.glyphAtlasTexture.size:[0,0],ds=Ye.aD(ko,as.zoom),ms=Yt(xn,Tt.tileID.canonical,Js,ps,as,It.getProjection(),vn),ua=Qt(xn,Tt.tileID.canonical,Js,ps,as,It.getProjection(),vn),Ra=ut.translatePosMatrix(ua,Tt,Xt,Lr,!0),La=ut.translatePosMatrix(xn,Tt,Xt,Lr),ll=$t?fc:ms,Il=ps&&!Js&&!pt;let ec=Pl;!Al&&!as.mercatorFromTransition||ps||(ec=Io(as));const tc=Qr?ec:Pl;let ic;ic=It.iconsInText?uo(ko.kind,ds,Il,Js,ut,La,ll,Ra,Fo,Jn,St,fn,yl,ns,tc,It.getProjection()):_o(ko.kind,ds,Il,Js,ut,La,ll,Ra,!0,Fo,!0,St,fn,yl,ns,tc,It.getProjection());const nc=Tt.glyphAtlasTexture?Tt.glyphAtlasTexture:null,oc=ss.LINEAR,sc=0!==wt.paint.get("text-halo-width").constantOr(1),ac=ut.terrain&&Js&&pt?Ye.ad.invert(Ye.ad.create(),ms):fc;if(pt&&It.text){const Ye=as.elevation,pt=Ye?Ye.getAtTileOffsetFunc(St,as.center.lat,as.worldSize,It.getProjection()):null,wt=Kt(xn,Tt.tileID.canonical,Js,ps,as,It.getProjection(),vn);ii(It,xn,ut,!0,wt,ua,Js,Wn,pt,St)}return{program:kn,buffers:It.text,uniformValues:ic,atlasTexture:nc,atlasTextureIcon:Qn,atlasInterpolation:oc,atlasInterpolationIcon:Xn,isSDF:!0,hasHalo:sc,tile:Tt,labelPlaneMatrixInv:ac}},ll=It.icon.segments.get().length,ec=It.text.segments.get().length,tc=ll&&!Lt.onlyText?O():null,ic=ec&&!Lt.onlyIcons?G():null,nc=wt.paint.get("icon-opacity").constantOr(1),oc=wt.paint.get("text-opacity").constantOr(1);if(Ra&&It.canOverlap){La=!0;const ut=nc&&!Lt.onlyText?It.icon.segments.get():[],pt=oc&&!Lt.onlyIcons?It.text.segments.get():[];for(const pt of ut)Il.push({segments:new Ye.b([pt]),sortKey:pt.sortKey,state:tc});for(const ut of pt)Il.push({segments:new Ye.b([ut]),sortKey:ut.sortKey,state:ic})}else Lt.onlyText||Il.push({segments:nc?It.icon.segments:new Ye.b([]),sortKey:0,state:tc}),Lt.onlyIcons||Il.push({segments:oc?It.text.segments:new Ye.b([]),sortKey:0,state:ic})}La&&Il.sort(((Ye,ut)=>Ye.sortKey-ut.sortKey));for(const Ye of Il){const pt=Ye.state;if(pt)if(ut.terrain&&ut.terrain.setupElevationDraw(pt.tile,pt.program,{useDepthForOcclusion:!wt.hasInitialOcclusionOpacityProperties&&as.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:pt.labelPlaneMatrixInv}),ns.activeTexture.set(ss.TEXTURE0),pt.atlasTexture&&pt.atlasTexture.bind(pt.atlasInterpolation,ss.CLAMP_TO_EDGE,!0),pt.atlasTextureIcon&&(ns.activeTexture.set(ss.TEXTURE1),pt.atlasTextureIcon&&pt.atlasTextureIcon.bind(pt.atlasInterpolationIcon,ss.CLAMP_TO_EDGE,!0)),ut.uploadCommonLightUniforms(ut.context,pt.program),pt.hasHalo){const Tt=pt.uniformValues;Tt.u_is_halo=1,Ro(pt.buffers,Ye.segments,wt,ut,pt.program,ll,St,It,Tt,2),Tt.u_is_halo=0}else{if(pt.isSDF){const Tt=pt.uniformValues;pt.hasHalo&&(Tt.u_is_halo=1,Ro(pt.buffers,Ye.segments,wt,ut,pt.program,ll,St,It,Tt,1)),Tt.u_is_halo=0}Ro(pt.buffers,Ye.segments,wt,ut,pt.program,ll,St,It,pt.uniformValues,1)}}}function Ro(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr){const Lr=Tt.context.gl,Qr=[ut.dynamicLayoutVertexBuffer,ut.opacityVertexBuffer,ut.iconTransitioningVertexBuffer,ut.globeExtVertexBuffer,ut.zOffsetVertexBuffer];ut.occlusionQueryOpacityVertexBuffer.length>0&&Qr.push(ut.occlusionQueryOpacityVertexBuffer),St.draw(Tt,Lr.TRIANGLES,It,Lt,$t,Ye.af.disabled,Xt,wt.id,ut.layoutVertexBuffer,ut.indexBuffer,pt,wt.paint,Tt.transform.zoom,ut.programConfigurations.get(wt.id),Qr,Sr)}function Do(ut,pt,wt,Tt,St,It,Lt){const $t=ut.context.gl,Xt=wt.paint.get("fill-pattern"),Sr=Xt&&Xt.constantOr(1);let Lr,Qr,fn,xn,vn;Lt?(Qr=Sr&&!wt.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Lr=$t.LINES):(Qr=Sr?"fillPattern":"fill",Lr=$t.TRIANGLES);for(const kn of Tt){const Tt=pt.getTile(kn);if(Sr&&!Tt.patternsLoaded())continue;const Wn=Tt.getBucket(wt);if(!Wn)continue;ut.prepareDrawTile();const Xn=Wn.programConfigurations.get(wt.id),Jn=ut.isTileAffectedByFog(kn),Qn=ut.getOrCreateProgram(Qr,{config:Xn,overrideFog:Jn});Sr&&(ut.context.activeTexture.set($t.TEXTURE0),Tt.imageAtlasTexture&&Tt.imageAtlasTexture.bind($t.LINEAR,$t.CLAMP_TO_EDGE),Xn.updatePaintBuffers());const ko=Xt.constantOr(null);if(ko&&Tt.imageAtlas){const Ye=Tt.imageAtlas.patternPositions[ko.toString()];Ye&&Xn.setConstantPatternPositions(Ye)}const Fo=ut.translatePosMatrix(kn.projMatrix,Tt,wt.paint.get("fill-translate"),wt.paint.get("fill-translate-anchor")),is=wt.paint.get("fill-emissive-strength");if(Lt){xn=Wn.indexBuffer2,vn=Wn.segments2;const Ye=ut.terrain&&ut.terrain.renderingToTexture?ut.terrain.drapeBufferSize:[$t.drawingBufferWidth,$t.drawingBufferHeight];fn="fillOutlinePattern"===Qr&&Sr?Yi(Fo,is,ut,Tt,Ye):Xi(Fo,is,Ye)}else xn=Wn.indexBuffer,vn=Wn.segments,fn=Sr?$i(Fo,is,ut,Tt):Hi(Fo,is);ut.uploadCommonUniforms(ut.context,Qn,kn.toUnwrapped()),Qn.draw(ut,Lr,St,ut.stencilModeForClipping(kn),It,Ye.af.disabled,fn,wt.id,Wn.layoutVertexBuffer,xn,vn,wt.paint,ut.transform.zoom,Xn,void 0)}}function Mo(ut,pt,wt,Tt,St,It,Lt,$t){wt.resetLayerRenderingStats(ut);const Xt=ut.context,Sr=Xt.gl,Lr=ut.transform,Qr=wt.paint.get("fill-extrusion-pattern"),fn=Qr.constantOr(1),xn=wt.paint.get("fill-extrusion-opacity"),vn=ut.style.enable3dLights(),kn=wt.paint.get(vn&&!fn?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Wn=[wt.paint.get("fill-extrusion-ambient-occlusion-intensity"),kn],Xn=wt.layout.get("fill-extrusion-edge-radius"),Jn=Xn>0&&!wt.paint.get("fill-extrusion-rounded-roof"),Qn=Jn?0:Xn,ko="globe"===Lr.projection.name?Ye.bY():0,Fo="globe"===Lr.projection.name,is=Fo?Ye.a1(Lr.zoom):0,ns=[Ye.aj(Lr.center.lng),Ye.ak(Lr.center.lat)],ss=wt.paint.get("fill-extrusion-flood-light-color").toRenderColor(wt.lut).toArray01().slice(0,3),as=wt.paint.get("fill-extrusion-flood-light-intensity"),ds=wt.paint.get("fill-extrusion-vertical-scale"),ps=fi(ut,wt.paint.get("fill-extrusion-cutoff-fade-range")),ms=wt.paint.get("fill-extrusion-emissive-strength"),Js=[];let ua;Fo&&Js.push("PROJECTION_GLOBE_VIEW"),Wn[0]>0&&Js.push("FAUX_AO"),Jn&&Js.push("ZERO_ROOF_RADIUS"),$t&&Js.push("HAS_CENTROID"),as>0&&Js.push("FLOOD_LIGHT"),ps.shouldRenderCutoff&&Js.push("RENDER_CUTOFF");const ba="shadow"===ut.renderPass,Ra=ut.shadowRenderer,La=ba&&!!Ra;ut.shadowRenderer&&(ut.shadowRenderer.useNormalOffset=!0);let ll=[0,0,0];if(Ra){const Ye=ut.style.directionalLight,pt=ut.style.ambientLight;Ye&&pt&&(ll=wi(ut.style,Ye,pt)),ua=Js.concat(["SHADOWS_SINGLE_CASCADE"])}const yl=La?"fillExtrusionDepth":fn?"fillExtrusionPattern":"fillExtrusion",Tl=wt.getLayerRenderingStats();for(const vn of Tt){const Tt=pt.getTile(vn),kn=Tt.getBucket(wt);if(!kn||kn.projection.name!==Lr.projection.name)continue;let Xn=!1;Ra&&(Xn=0===Ra.getMaxCascadeForTile(vn.toUnwrapped()));const Jn=ut.isTileAffectedByFog(vn),La=kn.programConfigurations.get(wt.id),Al=ut.getOrCreateProgram(yl,{config:La,defines:Xn?ua:Js,overrideFog:Jn});if(ut.terrain&&ut.terrain.setupElevationDraw(Tt,Al,{useMeterToDem:!0}),!kn.centroidVertexBuffer){const Ye=Al.attributes.a_centroid_pos;void 0!==Ye&&Sr.vertexAttrib2f(Ye,0,0)}!ba&&Ra&&Ra.setupShadows(Tt.tileID.toUnwrapped(),Al,"vector-tile",Tt.tileID.overscaledZ),fn&&(ut.context.activeTexture.set(Sr.TEXTURE0),Tt.imageAtlasTexture&&Tt.imageAtlasTexture.bind(Sr.LINEAR,Sr.CLAMP_TO_EDGE),La.updatePaintBuffers());const Il=Qr.constantOr(null);if(Il&&Tt.imageAtlas){const Ye=Tt.imageAtlas.patternPositions[Il.toString()];Ye&&La.setConstantPatternPositions(Ye)}const Pl=wt.paint.get("fill-extrusion-vertical-gradient");let ec;if(ba&&Ra){if(No(Tt.tileID,kn,ut))continue;const Ye=Ra.calculateShadowPassMatrixFromTile(Tt.tileID.toUnwrapped());ec=Zi(Ye,Qn,ds)}else{const Ye=ut.translatePosMatrix(vn.expandedProjMatrix,Tt,wt.paint.get("fill-extrusion-translate"),wt.paint.get("fill-extrusion-translate-anchor")),pt=Lr.projection.createInversionMatrix(Lr,vn.canonical);ec=fn?qi(Ye,ut,Pl,xn,Wn,Qn,vn,Tt,ko,is,ns,pt,ss,ds):Wi(Ye,ut,Pl,xn,Wn,Qn,vn,ko,is,ns,pt,ss,ds,as,ll,ms)}ut.uploadCommonUniforms(Xt,Al,vn.toUnwrapped(),null,ps);let tc=kn.segments;if("mercator"===Lr.projection.name&&!ba&&(tc=kn.getVisibleSegments(Tt.tileID,ut.terrain,ut.transform.getFrustum(0)),!tc.get().length))continue;if(Tl)if(ba)for(const Ye of tc.get())Tl.numRenderedVerticesInShadowPass+=Ye.primitiveLength;else for(const Ye of tc.get())Tl.numRenderedVerticesInTransparentPass+=Ye.primitiveLength;const ic=[];(ut.terrain||$t)&&ic.push(kn.centroidVertexBuffer),Fo&&ic.push(kn.layoutVertexExtBuffer),Al.draw(ut,Xt.gl.TRIANGLES,St,It,Lt,Ye.af.backCCW,ec,wt.id,kn.layoutVertexBuffer,kn.indexBuffer,tc,wt.paint,ut.transform.zoom,La,ic)}ut.shadowRenderer&&(ut.shadowRenderer.useNormalOffset=!1)}function zo(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn,Xn,Jn){const Qn=ut.context,ko=Qn.gl,Fo=ut.transform,is=ut.transform.zoom,ns=[],ss=fi(ut,wt.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===Sr?(ns.push("CLEAR_SUBPASS"),Jn&&(ns.push("CLEAR_FROM_TEXTURE"),Qn.activeTexture.set(ko.TEXTURE0),Jn.bind(ko.LINEAR,ko.CLAMP_TO_EDGE))):"sdf"===Sr&&ns.push("SDF_SUBPASS"),Wn&&ns.push("HAS_CENTROID"),ss.shouldRenderCutoff&&ns.push("RENDER_CUTOFF");const as=wt.layout.get("fill-extrusion-edge-radius"),I=(Ye,pt,Tt,Sr,Xn)=>{const ko=pt.programConfigurations.get(wt.id),Fo=ut.isTileAffectedByFog(Ye),ds=ut.getOrCreateProgram("fillExtrusionGroundEffect",{config:ko,defines:ns,overrideFog:Fo}),ps=((Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr)=>({u_matrix:ut,u_opacity:pt,u_ao_pass:wt?1:0,u_meter_to_tile:Tt,u_ao:St,u_flood_light_intensity:It,u_flood_light_color:Lt,u_attenuation:$t,u_edge_radius:Xt,u_fb:0,u_fb_size:Sr}))(0,Sr,Lr,Xt,Xn,[Qr,fn*Xn],xn,vn,kn,is>=17?0:as*Xn,Jn?Jn.size[0]:0),ms=[];Wn&&ms.push(pt.hiddenByLandmarkVertexBuffer),ut.uploadCommonUniforms(Qn,ds,Ye.toUnwrapped(),null,ss),ds.draw(ut,Qn.gl.TRIANGLES,St,It,Lt,$t,ps,wt.id,pt.vertexBuffer,pt.indexBuffer,Tt,wt.paint,is,ko,ms)};for(const St of Tt){const Tt=pt.getTile(St),It=Tt.getBucket(wt);if(!It||It.projection.name!==Fo.projection.name||!It.groundEffect||It.groundEffect&&!It.groundEffect.hasData())continue;const Lt=It.groundEffect,$t=1/It.tileToMeter;{const Ye=ut.translatePosMatrix(St.projMatrix,Tt,wt.paint.get("fill-extrusion-translate"),wt.paint.get("fill-extrusion-translate-anchor")),pt=Lt.getDefaultSegment();I(St,Lt,pt,Ye,$t)}if(Xn)for(let It=0;It<4;It++){const Lt=Ye.bZ[It](St),Xt=pt.getTile(Lt);if(!Xt)continue;const Sr=Xt.getBucket(wt);if(!Sr||Sr.projection.name!==Fo.projection.name||!Sr.groundEffect||Sr.groundEffect&&!Sr.groundEffect.hasData())continue;const Lr=Sr.groundEffect;let Qr,fn;0===It?(Qr=[-Ye.a3,0,0],fn=1):1===It?(Qr=[Ye.a3,0,0],fn=0):2===It?(Qr=[0,-Ye.a3,0],fn=3):(Qr=[0,Ye.a3,0],fn=2);const xn=Lr.regionSegments[fn];if(!xn)continue;const vn=new Float32Array(16);Ye.ad.translate(vn,St.projMatrix,Qr),I(St,Lr,xn,ut.translatePosMatrix(vn,Tt,wt.paint.get("fill-extrusion-translate"),wt.paint.get("fill-extrusion-translate-anchor")),$t)}}}function Oo(ut,pt,wt,Tt,St,It,Lt){0===Tt.centroidVertexArray.length&&Tt.createCentroidsBuffer();const $t=It?It.findDEMTileFor(wt):null;if(!($t&&$t.dem||Lt))return;const c=ut=>new Ye.P(Math.ceil((ut+Ye.c0)*Ye.c1),0),h=Ye=>{const ut=pt.getSource().minzoom,o=Ye=>{const ut=pt.getTileByID(Ye);if(ut&&ut.hasData())return ut.getBucket(St)},wt=[0,-1,1];for(const pt of wt){if(Ye.overscaledZ+pt<ut)continue;const wt=o(Ye.calculateScaledKey(Ye.overscaledZ+pt));if(wt)return wt}},Xt=[0,0,0],u=(ut,pt)=>(Xt[0]=Math.min(ut.min.y,pt.min.y),Xt[1]=Math.max(ut.max.y,pt.max.y),Xt[2]=Ye.a3-pt.min.x>ut.max.x?pt.min.x-Ye.a3:ut.max.x,Xt),d=(ut,pt)=>(Xt[0]=Math.min(ut.min.x,pt.min.x),Xt[1]=Math.max(ut.max.x,pt.max.x),Xt[2]=Ye.a3-pt.min.y>ut.max.y?pt.min.y-Ye.a3:ut.max.y,Xt),Sr=[(Ye,ut)=>u(Ye,ut),(Ye,ut)=>u(ut,Ye),(Ye,ut)=>d(Ye,ut),(Ye,ut)=>d(ut,Ye)],f=(ut,pt,Tt,St,Lt,Xt,Sr)=>{if(!It)return 0;const Lr=[[Xt?Tt:ut,Xt?ut:Tt,0],[Xt?Tt:pt,Xt?pt:Tt,0]],Qr=Sr<0?Ye.a3+Sr:Sr,fn=[Xt?Qr:(ut+pt)/2,Xt?(ut+pt)/2:Qr,0];return 0===Tt&&Sr<0||0!==Tt&&Sr>0?It.getForTilePoints(Lt,[fn],!0,St):Lr.push(fn),It.getForTilePoints(wt,Lr,!0,$t),Math.max(Lr[0][2],Lr[1][2],fn[2])/It.exaggeration()};for(let ut=0;ut<4;ut++){const pt=Tt.borderFeatureIndices[ut];if(0===pt.length)continue;const St=Ye.bZ[ut](wt),$t=h(St);if(!($t&&$t instanceof Ye.b_))continue;if(Tt.borderDoneWithNeighborZ[ut]===$t.canonical.z)continue;0===$t.centroidVertexArray.length&&$t.createCentroidsBuffer();const Xt=It?It.findDEMTileFor(St):null;if(!(Xt&&Xt.dem||Lt))continue;const fn=(ut<2?1:5)-ut,xn=$t.borderDoneWithNeighborZ[fn]!==Tt.canonical.z,vn=$t.borderFeatureIndices[fn];let kn=0;if(Tt.canonical.z!==$t.canonical.z){for(const Ye of pt)Tt.showCentroid(Tt.featuresOnBorder[Ye]);if(xn)for(const Ye of vn)$t.showCentroid($t.featuresOnBorder[Ye]);Tt.borderDoneWithNeighborZ[ut]=$t.canonical.z,$t.borderDoneWithNeighborZ[fn]=Tt.canonical.z}for(const wt of pt){const pt=Tt.featuresOnBorder[wt],It=Tt.centroidData[pt.centroidDataIndex],xn=pt.borders[ut];let Wn;for(;kn<vn.length;){Wn=$t.featuresOnBorder[vn[kn]];const Ye=Wn.borders[fn];if(Ye[1]>xn[0]+3||Ye[0]>xn[0]-3)break;$t.showCentroid(Wn),kn++}if(Wn&&kn<vn.length){const wt=kn;let Xn=0;for(;!(Wn.borders[fn][0]>xn[1]-3)&&(Xn++,++kn!==vn.length);)Wn=$t.featuresOnBorder[vn[kn]];if(Wn=$t.featuresOnBorder[vn[wt]],Xn>1){const Ye=Wn.borders[fn];Math.abs(xn[0]-Ye[0])<3&&Math.abs(xn[1]-Ye[1])<3&&(Xn=1,kn=wt+1)}else if(0===Xn){Tt.showCentroid(pt);continue}const Jn=$t.centroidData[Wn.centroidDataIndex];Lt&&1===Xn&&(((Lr=It).flags|(Qr=Jn).flags)&Ye.b$?(Lr.flags|=Ye.b$,Qr.flags|=Ye.b$):(Lr.flags&=~Ye.b$,Qr.flags&=~Ye.b$));const Qn=pt.intersectsCount()>1||Wn.intersectsCount()>1;if(Xn>1)kn=wt,It.centroidXY=Jn.centroidXY=new Ye.P(0,0);else if(Xt&&Xt.dem&&!Qn){const pt=Sr[ut](It,Jn),wt=ut%2?Ye.a3-1:0,Tt=f(pt[0],Math.min(Ye.a3-1,pt[1]),wt,Xt,St,ut<2,pt[2]);It.centroidXY=Jn.centroidXY=c(Tt)}else Qn?It.centroidXY=Jn.centroidXY=new Ye.P(0,0):(It.centroidXY=Tt.encodeBorderCentroid(pt),Jn.centroidXY=$t.encodeBorderCentroid(Wn));Tt.writeCentroidToBuffer(It),$t.writeCentroidToBuffer(Jn)}else Tt.showCentroid(pt)}Tt.borderDoneWithNeighborZ[ut]=$t.canonical.z,$t.borderDoneWithNeighborZ[fn]=Tt.canonical.z}var Lr,Qr;(Tt.needsCentroidUpdate||!Tt.centroidVertexBuffer&&0!==Tt.centroidVertexArray.length)&&Tt.uploadCentroid(ut)}const gc=[1,0,0],xc=[0,1,0],Mc=[0,0,1];function No(ut,pt,wt){const Tt=wt.transform,St=wt.shadowRenderer;if(!St)return!0;const It=ut.toUnwrapped(),Lt=Tt.tileSize*St._cascades[wt.currentShadowCascade].scale;let $t=pt.maxHeight;if(Tt.elevation){const Ye=Tt.elevation.getMinMaxForTile(ut);Ye&&($t+=Ye.max)}const Xt=[...St.shadowDirection];Xt[2]=-Xt[2];const Sr=St.computeSimplifiedTileShadowVolume(It,$t,Lt,Xt);if(!Sr)return!1;const Lr=[gc,xc,Mc,Xt,[Xt[0],0,Xt[2]],[0,Xt[1],Xt[2]]],Qr="globe"===Tt.projection.name,fn=Tt.scaleZoom(Lt),xn=Ye.aM.fromInvProjectionMatrix(Tt.invProjMatrix,Tt.worldSize,fn,!Qr),vn=St.getCurrentCascadeFrustum();return 0===xn.intersectsPrecise(Sr.vertices,Sr.planes,Lr)||0===vn.intersectsPrecise(Sr.vertices,Sr.planes,Lr)}function Uo(ut){return[ut[0]*Ye.c2,ut[1]*Ye.c2,ut[2]*Ye.c2,0]}function Go(ut,pt,wt,Tt,St,It,Lt,$t,Xt){const Sr=Tt.getSource(),Lr=wt.globeSharedBuffers;if(!Lr)return;let Qr,fn,xn;if(pt&&(Qr=Tt.getTile(pt)),Sr instanceof Ye.bm?(fn=Sr.texture,xn=Ye.bh(0,0,wt.transform)):Qr&&pt&&(fn=Qr.texture,xn=Ye.bh(pt.canonical.z,pt.canonical.x,wt.transform)),!fn||!xn)return;ut||(xn=Ye.ad.scale(Ye.ad.create(),xn,[1,-1,1]));const vn=wt.context,kn=vn.gl,Wn="nearest"===St.paint.get("raster-resampling")?kn.NEAREST:kn.LINEAR,Xn=wt.colorModeForDrapableLayerRenderPass(It),Jn=Lt.defines;Jn.push("GLOBE_POLES");const Qn=new Ye.ae(kn.LEQUAL,Ye.ae.ReadWrite,wt.depthRangeFor3D),ko=Float32Array.from(wt.transform.expandedFarZProjMatrix),Fo=Float32Array.from(Ye.bf(Ye.bg(new Ye.aO(0,0,0))));wt.terrain&&wt.terrain.prepareDrawTile(),vn.activeTexture.set(kn.TEXTURE0),fn.bind(Wn,kn.CLAMP_TO_EDGE),vn.activeTexture.set(kn.TEXTURE1),fn.bind(Wn,kn.CLAMP_TO_EDGE),fn.useMipmap&&vn.extTextureFilterAnisotropic&&wt.transform.pitch>20&&kn.texParameterf(kn.TEXTURE_2D,vn.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,vn.extTextureFilterAnisotropicMax);const[is,ns,ss,as]=pt?Lr.getPoleBuffers(pt.canonical.z,!1):Lr.getPoleBuffers(0,!0),ds=St.paint.get("raster-elevation");let ps;ut?(ps=is,wt.renderDefaultNorthPole=0!==ds):(ps=ns,wt.renderDefaultSouthPole=0!==ds);const ms=Uo(Lt.mix),Js=((Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr)=>oo(Ye,ut,pt,new Float32Array(16),new Float32Array(9),[0,0],wt,[0,0],[0,0,0,0],1,{opacity:1,mix:0},St,[0,0]||[0,0],Lt,2,Xt,Sr,Lr,1,0,Qr))(ko,Fo,xn,Ye.a1(wt.transform.zoom),0,St,0,ds,0,ms,Lt.offset,Lt.range,It),ua=wt.getOrCreateProgram("raster",{defines:Jn});wt.uploadCommonUniforms(vn,ua,null),ua.draw(wt,kn.TRIANGLES,Qn,Xt,Xn,$t,Js,St.id,ps,ss,as)}function jo(Ye){const ut=Ye._nearZ,pt=Ye.projection.farthestPixelDistance(Ye),wt=pt-ut,Tt=.2*Ye.height,St=ut+Tt;return[ut,pt,(St-Tt-ut)/wt,(St-ut)/wt]}function Vo(ut,pt,wt,Tt){if(ut)return pt instanceof Ri&&ut instanceof Ye.c3?pt.getTextureDescriptor(ut,wt,!0):{texture:ut.texture,mix:Uo(Tt.mix),offset:Tt.offset,buffer:0,tileSize:1}}function Wo(ut,pt,wt){if(!ut)return null;const Tt=pt.getTextureDescriptor(ut,wt,!0);if(!Tt)return null;let{texture:St,mix:It,offset:Lt,tileSize:$t,buffer:Xt,format:Sr}=Tt;if(!St||!Sr)return null;let Lr=!1;return"uint32"===Sr&&(Lr=!0,It[3]=0,It=to(Ye.c4,It,[0,wt.paint.get("raster-particle-max-speed")]),Lt=io(Ye.c4,Lt,[0,wt.paint.get("raster-particle-max-speed")])),{texture:St,textureOffset:[Xt/($t+2*Xt),$t/($t+2*Xt)],tileSize:$t,scalarData:Lr,scale:It,offset:Lt,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[Sr]]}}function Zo(Ye){const ut=Ye._nearZ,pt=Ye.projection.farthestPixelDistance(Ye),wt=pt-ut,Tt=.2*Ye.height,St=ut+Tt;return[ut,pt,(St-Tt-ut)/wt,(St-ut)/wt]}const Ac=new Ye.C(1,0,0,1),Sc=new Ye.C(0,1,0,1),Dc=new Ye.C(0,0,1,1),qc=new Ye.C(1,0,1,1),$c=new Ye.C(0,1,1,1);function Ko(ut,pt,wt,Tt,St,It,Lt){const $t=ut.context,Xt=ut.transform,Sr=$t.gl,Lr="globe"===Xt.projection.name,Qr=Lr?["PROJECTION_GLOBE_VIEW"]:[];let fn=Ye.ad.clone(wt.projMatrix);if(Lr&&Ye.a1(Xt.zoom)>0){const ut=Ye.c5(wt.canonical,Xt),pt=Ye.c6(ut);fn=Ye.ad.multiply(new Float32Array(16),Xt.globeMatrix,pt),Ye.ad.multiply(fn,Xt.projMatrix,fn)}const xn=Ye.ad.create();xn[12]+=2*St/(Ye.e.devicePixelRatio*Xt.width),xn[13]+=2*It/(Ye.e.devicePixelRatio*Xt.height),Ye.ad.multiply(fn,xn,fn);const vn=ut.getOrCreateProgram("debug",{defines:Qr}),kn=pt.getTileByID(wt.key);ut.terrain&&ut.terrain.setupElevationDraw(kn,vn);const Wn=Ye.ae.disabled,Xn=Ye.ag.disabled,Jn=ut.colorModeForRenderPass(),Qn="$debug";$t.activeTexture.set(Sr.TEXTURE0),ut.emptyTexture.bind(Sr.LINEAR,Sr.CLAMP_TO_EDGE),Lr?kn._makeGlobeTileDebugBuffers(ut.context,Xt):kn._makeDebugTileBoundsBuffers(ut.context,Xt.projection);const ko=kn._tileDebugBuffer||ut.debugBuffer,Fo=kn._tileDebugIndexBuffer||ut.debugIndexBuffer,is=kn._tileDebugSegments||ut.debugSegments;if(vn.draw(ut,Sr.LINE_STRIP,Wn,Xn,Jn,Ye.af.disabled,Qi(fn,Tt),Qn,ko,Fo,is,null,null,null,[kn._globeTileDebugBorderBuffer]),Lt){const Ye=kn.latestRawTileData,pt=Math.floor((Ye&&Ye.byteLength||0)/1024);let Tt=wt.canonical.toString();wt.overscaledZ!==wt.canonical.z&&(Tt+=` => ${wt.overscaledZ}`),Tt+=` ${kn.state}`,Tt+=` ${pt}kb`,function(Ye,ut){Ye.initDebugOverlayCanvas();const pt=Ye.debugOverlayCanvas,wt=Ye.context.gl,Tt=Ye.debugOverlayCanvas.getContext("2d");Tt.clearRect(0,0,pt.width,pt.height),Tt.shadowColor="white",Tt.shadowBlur=2,Tt.lineWidth=1.5,Tt.strokeStyle="white",Tt.textBaseline="top",Tt.font="bold 36px Open Sans, sans-serif",Tt.fillText(ut,5,5),Tt.strokeText(ut,5,5),Ye.debugOverlayTexture.update(pt),Ye.debugOverlayTexture.bind(wt.LINEAR,wt.CLAMP_TO_EDGE)}(ut,Tt)}const ns=pt.getTile(wt).tileSize,ss=512/Math.min(ns,512)*(wt.overscaledZ/Xt.zoom)*.5,as=kn._tileDebugTextBuffer||ut.debugBuffer,ds=kn._tileDebugTextIndexBuffer||ut.quadTriangleIndexBuffer,ps=kn._tileDebugTextSegments||ut.debugSegments;vn.draw(ut,Sr.TRIANGLES,Wn,Xn,Ye.a.alphaBlended,Ye.af.disabled,Qi(fn,Ye.C.transparent,ss),Qn,as,ds,ps,null,null,null,[kn._globeTileDebugTextBuffer])}function Qo(Ye,ut,pt,wt){er(Ye,0,ut+pt/2,Ye.transform.width,pt,wt)}function Jo(Ye,ut,pt,wt){er(Ye,ut-pt/2,0,pt,Ye.transform.height,wt)}function er(ut,pt,wt,Tt,St,It){const Lt=ut.context,$t=Lt.gl;$t.enable($t.SCISSOR_TEST),$t.scissor(pt*Ye.e.devicePixelRatio,wt*Ye.e.devicePixelRatio,Tt*Ye.e.devicePixelRatio,St*Ye.e.devicePixelRatio),Lt.clear({color:It}),$t.disable($t.SCISSOR_TEST)}const mh=Ye.c7([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:yh}=mh;function or(Ye,ut,pt,wt){Ye.emplaceBack(ut,pt,wt)}class rr{constructor(ut){this.vertexArray=new Ye.c8,this.indices=new Ye.bu,or(this.vertexArray,-1,-1,1),or(this.vertexArray,1,-1,1),or(this.vertexArray,-1,1,1),or(this.vertexArray,1,1,1),or(this.vertexArray,-1,-1,-1),or(this.vertexArray,1,-1,-1),or(this.vertexArray,-1,1,-1),or(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=ut.createVertexBuffer(this.vertexArray,yh),this.indexBuffer=ut.createIndexBuffer(this.indices),this.segment=Ye.b.simpleSegment(0,0,36,12)}}function ar(ut,pt,wt,Tt,St,It){const Lt=ut.context.gl,$t=pt.paint.get("sky-atmosphere-color"),Xt=pt.paint.get("sky-atmosphere-halo-color"),Sr=pt.paint.get("sky-atmosphere-sun-intensity"),Lr=((Ye,ut,pt,wt,Tt)=>({u_matrix_3f:Ye,u_sun_direction:ut,u_sun_intensity:pt,u_color_tint_r:[wt.r,wt.g,wt.b,wt.a],u_color_tint_m:[Tt.r,Tt.g,Tt.b,Tt.a],u_luminance:5e-5}))(Ye.bC.fromMat4(Ye.bC.create(),Tt),St,Sr,$t,Xt);Lt.framebufferTexture2D(Lt.FRAMEBUFFER,Lt.COLOR_ATTACHMENT0,Lt.TEXTURE_CUBE_MAP_POSITIVE_X+It,pt.skyboxTexture,0),wt.draw(ut,Lt.TRIANGLES,Ye.ae.disabled,Ye.ag.disabled,Ye.a.unblended,Ye.af.frontCW,Lr,"skyboxCapture",pt.skyboxGeometry.vertexBuffer,pt.skyboxGeometry.indexBuffer,pt.skyboxGeometry.segment)}const Th=Ye.c7([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class sr{constructor(ut){const pt=new Ye.c9;pt.emplaceBack(-1,1,1,0,0),pt.emplaceBack(1,1,1,1,0),pt.emplaceBack(1,-1,1,1,1),pt.emplaceBack(-1,-1,1,0,1);const wt=new Ye.bu;wt.emplaceBack(0,1,2),wt.emplaceBack(2,3,0),this.vertexBuffer=ut.createVertexBuffer(pt,Th.members),this.indexBuffer=ut.createIndexBuffer(wt),this.segments=Ye.b.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Sh=Ye.c7([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class cr{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class hr{constructor(ut){this.colorModeAlphaBlendedWriteRGB=new Ye.a([Ye.ca,Ye.cb,Ye.ca,Ye.cb],Ye.C.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Ye.a([Ye.ca,Ye.cc,Ye.ca,Ye.cc],Ye.C.transparent,[!1,!1,!1,!0]),this.params=new cr,this.updateNeeded=!0,ut.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),ut.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),ut.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),ut.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(ut){const pt=ut.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new sr(pt);const ut=this.params.sizeRange,wt=this.params.intensityRange,Tt=function(ut){const pt=Ye.cf(30),wt=[];for(let Tt=0;Tt<ut;++Tt){const ut=2*Math.PI*pt(),Tt=Math.acos(1-2*pt())-.5*Math.PI;wt.push(Ye._.fromValues(Math.cos(Tt)*Math.cos(ut),Math.cos(Tt)*Math.sin(ut),Math.sin(Tt)))}return wt}(this.params.starsCount),St=Ye.cf(300),It=new Ye.cd,Lt=new Ye.bu;let $t=0;for(let pt=0;pt<Tt.length;++pt){const Xt=Ye._.scale([],Tt[pt],200),Sr=Math.max(0,1+.01*ut*(1*St()-.5)),Lr=Math.max(0,1+.01*wt*(1*St()-.5));It.emplaceBack(Xt[0],Xt[1],Xt[2],-1,-1,Sr,Lr),It.emplaceBack(Xt[0],Xt[1],Xt[2],1,-1,Sr,Lr),It.emplaceBack(Xt[0],Xt[1],Xt[2],1,1,Sr,Lr),It.emplaceBack(Xt[0],Xt[1],Xt[2],-1,1,Sr,Lr),Lt.emplaceBack($t+0,$t+1,$t+2),Lt.emplaceBack($t+0,$t+2,$t+3),$t+=4}this.starsVx=pt.createVertexBuffer(It,Sh.members),this.starsIdx=pt.createIndexBuffer(Lt),this.starsSegments=Ye.b.simpleSegment(0,0,It.length,Lt.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(ut,pt){const wt=ut.context,Tt=wt.gl,St=ut.transform,It=new Ye.ae(Tt.LEQUAL,Ye.ae.ReadOnly,[0,1]),Lt=Ye.a1(St.zoom),$t=ut.style.getLut(pt.scope),Xt=pt.properties.get("color").toRenderColor($t).toArray01(),Sr=pt.properties.get("high-color").toRenderColor($t).toArray01(),Lr=pt.properties.get("space-color").toRenderColor($t).toArray01PremultipliedAlpha(),Qr=5e-4,fn=Ye.ce(pt.properties.get("horizon-blend"),0,1,Qr,.25),xn=Ye.ba(ut,wt,St)&&fn===Qr?St.worldSize/(2*Math.PI*1.025)-1:St.globeRadius,vn=ut.frameCounter/1e3%1,kn=Ye._.length(St.globeCenterInViewSpace),Wn=Math.sqrt(Math.pow(kn,2)-Math.pow(xn,2)),Xn=Math.acos(Wn/kn),x=pt=>{const $t="globe"===St.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];pt&&$t.push("ALPHA_PASS");const Qr=ut.getOrCreateProgram("globeAtmosphere",{defines:$t}),xn=((Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr)=>({u_frustum_tl:Ye,u_frustum_tr:ut,u_frustum_br:pt,u_frustum_bl:wt,u_horizon:Tt,u_transition:St,u_fadeout_range:It,u_color:Lt,u_high_color:$t,u_space_color:Xt,u_temporal_offset:Sr,u_horizon_angle:Lr}))(St.frustumCorners.TL,St.frustumCorners.TR,St.frustumCorners.BR,St.frustumCorners.BL,St.frustumCorners.horizon,Lt,fn,Xt,Sr,Lr,vn,Xn);ut.uploadCommonUniforms(wt,Qr);const kn=this.atmosphereBuffer;kn&&Qr.draw(ut,Tt.TRIANGLES,It,Ye.ag.disabled,pt?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Ye.af.backCW,xn,pt?"atmosphere_glow_alpha":"atmosphere_glow",kn.vertexBuffer,kn.indexBuffer,kn.segments)};x(!1),x(!0)}drawStars(ut,pt){const wt=Ye.at(pt.properties.get("star-intensity"),0,1);if(0===wt)return;const Tt=ut.context,St=Tt.gl,It=ut.transform,Lt=ut.getOrCreateProgram("stars"),$t=Ye.av.identity([]);Ye.av.rotateX($t,$t,-It._pitch),Ye.av.rotateZ($t,$t,-It.angle),Ye.av.rotateX($t,$t,Ye.ab(It._center.lat)),Ye.av.rotateY($t,$t,-Ye.ab(It._center.lng));const Xt=Ye.ad.fromQuat(new Float32Array(16),$t),Sr=Ye.ad.multiply([],It.starsProjMatrix,Xt),Lr=Ye.bC.fromMat4([],Xt),Qr=Ye.bC.invert([],Lr),fn=[0,1,0];Ye._.transformMat3(fn,fn,Qr),Ye._.scale(fn,fn,this.params.sizeMultiplier);const xn=[1,0,0];Ye._.transformMat3(xn,xn,Qr),Ye._.scale(xn,xn,this.params.sizeMultiplier);const vn=(kn=fn,Wn=xn,Xn=wt,{u_matrix:Float32Array.from(Sr),u_up:kn,u_right:Wn,u_intensity_multiplier:Xn});var kn,Wn,Xn;ut.uploadCommonUniforms(Tt,Lt),this.starsVx&&this.starsIdx&&Lt.draw(ut,St.TRIANGLES,Ye.ae.disabled,Ye.ag.disabled,this.colorModeAlphaBlendedWriteRGB,Ye.af.disabled,vn,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function _r(ut,pt){const wt=[...ut],Tt=pt.cameraWorldSizeForFog/pt.worldSize,St=Ye.ad.identity([]);return Ye.ad.scale(St,St,[Tt,Tt,1]),Ye.ad.multiply(wt,St,wt),Ye.ad.multiply(wt,pt.worldToFogMatrix,wt),wt}function ur(ut,pt,wt,Tt,St){const It=wt.material,Lt=Tt.context,{baseColorTexture:$t,metallicRoughnessTexture:Xt}=It.pbrMetallicRoughness,{normalTexture:Sr,occlusionTexture:Lr,emissionTexture:Qr}=It;function d(Ye,pt,wt){if(Ye&&(ut.push(pt),Lt.activeTexture.set(Lt.gl.TEXTURE0+wt),Ye.gfxTexture)){const{minFilter:ut,magFilter:pt,wrapS:wt,wrapT:Tt}=Ye.sampler;Ye.gfxTexture.bindExtraParam(ut,pt,wt,Tt)}}d($t,"HAS_TEXTURE_u_baseColorTexture",Al.BaseColor),d(Xt,"HAS_TEXTURE_u_metallicRoughnessTexture",Al.MetallicRoughness),d(Sr,"HAS_TEXTURE_u_normalTexture",Al.Normal),d(Lr,"HAS_TEXTURE_u_occlusionTexture",Al.Occlusion),d(Qr,"HAS_TEXTURE_u_emissionTexture",Al.Emission),St&&(St.texture||(St.texture=new Ye.ch(Tt.context,St.image,[St.image.height,St.image.height,St.image.height],Lt.gl.RGBA)),Lt.activeTexture.set(Lt.gl.TEXTURE0+Al.LUT),St.texture&&St.texture.bind(Lt.gl.LINEAR,Lt.gl.CLAMP_TO_EDGE),ut.push("APPLY_LUT_ON_GPU")),wt.texcoordBuffer&&(ut.push("HAS_ATTRIBUTE_a_uv_2f"),pt.push(wt.texcoordBuffer)),wt.colorBuffer&&(ut.push(12===wt.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),pt.push(wt.colorBuffer)),wt.normalBuffer&&(ut.push("HAS_ATTRIBUTE_a_normal_3f"),pt.push(wt.normalBuffer)),wt.pbrBuffer&&(ut.push("HAS_ATTRIBUTE_a_pbr"),ut.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),pt.push(wt.pbrBuffer)),"OPAQUE"!==It.alphaMode&&"MASK"!==It.alphaMode||ut.push("UNPREMULT_TEXTURE_IN_SHADER"),It.defined||ut.push("DIFFUSE_SHADED"),ut.push("USE_STANDARD_DERIVATIVES")}function dr(ut,pt,wt,Tt,St,It){const Lt=wt.paint.get("model-opacity"),$t=pt.context,Xt=new Ye.ae(pt.context.gl.LEQUAL,Ye.ae.ReadWrite,pt.depthRangeFor3D),Sr=pt.transform,Lr=ut.mesh,Qr=Lr.material,fn=Qr.pbrMetallicRoughness,xn=pt.style.fog;let kn;kn="pixels"===pt.transform.projection.zAxisUnit?[...ut.nodeModelMatrix]:Ye.ad.multiply([],Tt.zScaleMatrix,ut.nodeModelMatrix),Ye.ad.multiply(kn,Tt.negCameraPosMatrix,kn);const Wn=Ye.ad.invert([],kn);Ye.ad.transpose(Wn,Wn);const Xn=wt.paint.get("model-emissive-strength").constantOr(0),Jn=go(new Float32Array(ut.worldViewProjection),new Float32Array(kn),new Float32Array(Wn),null,pt,Lt,fn.baseColorFactor.toRenderColor(null),Qr.emissiveFactor,fn.metallicFactor,fn.roughnessFactor,Qr,Xn,wt),Qn={defines:[]},ko=[];ur(Qn.defines,ko,Lr,pt,wt.lut);const Fo=pt.shadowRenderer;Fo&&(Fo.useNormalOffset=!1);let is=null;if(xn){const Ye=_r(ut.nodeModelMatrix,pt.transform);if(is=new Float32Array(Ye),"globe"!==Sr.projection.name){const ut=Lr.aabb.min,pt=Lr.aabb.max,[wt,Tt]=xn.getOpacityForBounds(Ye,ut[0],ut[1],pt[0],pt[1]);Qn.overrideFog=wt>=vn||Tt>=vn}}const ns=fi(pt,wt.paint.get("model-cutoff-fade-range"));ns.shouldRenderCutoff&&Qn.defines.push("RENDER_CUTOFF");const ss=pt.getOrCreateProgram("model",Qn);pt.uploadCommonUniforms($t,ss,null,is,ns),"shadow"!==pt.renderPass&&Fo&&Fo.setupShadowsFromMatrix(ut.nodeModelMatrix,ss),ss.draw(pt,$t.gl.TRIANGLES,Xt,St,It,Lr.material.doubleSided?Ye.af.disabled:Ye.af.backCCW,Jn,wt.id,Lr.vertexBuffer,Lr.indexBuffer,Lr.segments,wt.paint,pt.transform.zoom,void 0,ko)}function pr(ut,pt,wt,Tt,St,It,Lt){let $t;$t="globe"===ut.projection.name?Ye.ci(wt,ut):[...wt],Ye.ad.multiply($t,$t,pt.matrix);const Xt=Ye.ad.multiply([],Tt,$t);if(pt.meshes)for(const ut of pt.meshes){if("BLEND"!==ut.material.alphaMode){Lt.push({mesh:ut,depth:0,modelIndex:St,worldViewProjection:Xt,nodeModelMatrix:$t});continue}const pt=Ye._.transformMat4([],ut.centroid,Xt);pt[2]>0&&It.push({mesh:ut,depth:pt[2],modelIndex:St,worldViewProjection:Xt,nodeModelMatrix:$t})}if(pt.children)for(const Ye of pt.children)pr(ut,Ye,wt,Tt,St,It,Lt)}function fr(ut,pt,wt,Tt){const St=wt.shadowRenderer;if(!St)return;const It=St.getShadowPassDepthMode(),Lt=St.getShadowPassColorMode(),$t=St.calculateShadowPassMatrixFromMatrix(pt),Xt=vo($t);wt.getOrCreateProgram("modelDepth",{defines:wt._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(wt,wt.context.gl.TRIANGLES,It,Ye.ag.disabled,Lt,Ye.af.backCCW,Xt,Tt.id,ut.vertexBuffer,ut.indexBuffer,ut.segments,Tt.paint,wt.transform.zoom,void 0,void 0)}function mr(ut,pt,wt){const Tt=pt.updateZoomBasedPaintProperties(),St=function(ut,pt,wt){let Tt,St,It,Lt=ut.terrain?ut.terrain.exaggeration():0;if(ut.terrain&&Lt>0){const pt=ut.terrain,St=pt.findDEMTileFor(wt);St&&St.dem?Tt=Ye.ck.create(pt,wt,St):Lt=0}if(0===Lt&&(pt.terrainElevationMin=0,pt.terrainElevationMax=0),Lt===pt.validForExaggeration&&(0===Lt||Tt&&Tt._demTile&&Tt._demTile.tileID===pt.validForDEMTile.id&&Tt._dem._timestamp===pt.validForDEMTile.timestamp))return!1;for(const Ye in pt.instancesPerModel){const ut=pt.instancesPerModel[Ye];for(let Ye=0;Ye<ut.instancedDataArray.length;++Ye){const wt=(Tt?Lt*Tt.getElevationAt(0|ut.instancedDataArray.float32[16*Ye],0|ut.instancedDataArray.float32[16*Ye+1],!0,!0):0)+ut.instancesEvaluatedElevation[Ye];ut.instancedDataArray.float32[16*Ye+6]=wt,St=St?Math.min(pt.terrainElevationMin,wt):wt,It=It?Math.max(pt.terrainElevationMax,wt):wt}}return pt.terrainElevationMin=St||0,pt.terrainElevationMax=It||0,pt.validForExaggeration=Lt,pt.validForDEMTile=Tt&&Tt._demTile?{id:Tt._demTile.tileID,timestamp:Tt._dem._timestamp}:{id:void 0,timestamp:0},!0}(ut,pt,wt);(Tt||St)&&(pt.uploaded=!1,pt.upload(ut.context))}const Ih={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new Ye.b6([0,0,0],[Ye.a3,Ye.a3,0])};function vr(ut,pt){const wt=1<<ut.canonical.z,Tt=pt.getFreeCameraOptions().position,St=pt.elevation,It=ut.canonical.x/wt,Lt=(ut.canonical.x+1)/wt,$t=ut.canonical.y/wt,Xt=(ut.canonical.y+1)/wt;let Sr=pt._centerAltitude;if(St){const Ye=St.getMinMaxForTile(ut);Ye&&Ye.max>Sr&&(Sr=Ye.max)}const Lr=Ye.at(Tt.x,It,Lt)-Tt.x,Qr=Ye.at(Tt.y,$t,Xt)-Tt.y,fn=Ye.ax(Sr,pt.center.lat)-Tt.z;return pt._zoomFromMercatorZ(Math.sqrt(Lr*Lr+Qr*Qr+fn*fn))}function xr(ut,pt,wt,Tt,St,It,Lt){const $t=ut.context,Xt="shadow"===ut.renderPass,Sr=ut.shadowRenderer,Lr=Xt&&Sr?Sr.getShadowPassDepthMode():new Ye.ae($t.gl.LEQUAL,Ye.ae.ReadWrite,ut.depthRangeFor3D),Qr=ut.isTileAffectedByFog(It);if(wt.meshes)for(const fn of wt.meshes){const xn=["MODEL_POSITION_ON_GPU"],vn=[];let kn,Wn,Xn;Tt.instancedDataArray.length>20&&xn.push("INSTANCED_ARRAYS");const Jn=fi(ut,pt.paint.get("model-cutoff-fade-range"));if(Jn.shouldRenderCutoff&&xn.push("RENDER_CUTOFF"),Xt&&Sr)kn=ut.getOrCreateProgram("modelDepth",{defines:xn}),Wn=vo(Lt.shadowTileMatrix,Lt.shadowTileMatrix,Float32Array.from(wt.matrix)),Xn=Sr.getShadowPassColorMode();else{ur(xn,vn,fn,ut,pt.lut),kn=ut.getOrCreateProgram("model",{defines:xn,overrideFog:Qr});const Tt=fn.material,Xt=Tt.pbrMetallicRoughness,Lr=pt.paint.get("model-opacity"),Qn=pt.paint.get("model-emissive-strength").constantOr(0);Wn=go(It.expandedProjMatrix,Float32Array.from(wt.matrix),new Float32Array(16),null,ut,Lr,Xt.baseColorFactor.toRenderColor(null),Tt.emissiveFactor,Xt.metallicFactor,Xt.roughnessFactor,Tt,Qn,pt,St),Sr&&(Lt.shadowUniformsInitialized?kn.setShadowUniformValues($t,Sr.getShadowUniformValues()):(Sr.setupShadows(It.toUnwrapped(),kn,"model-tile",It.overscaledZ),Lt.shadowUniformsInitialized=!0)),Xn=Jn.shouldRenderCutoff||Lr<1||"OPAQUE"!==Tt.alphaMode?Ye.a.alphaBlended:Ye.a.unblended}ut.uploadCommonUniforms($t,kn,It.toUnwrapped(),null,Jn);const Qn=fn.material.doubleSided?Ye.af.disabled:Ye.af.backCCW;if(Tt.instancedDataArray.length>20)vn.push(Tt.instancedDataBuffer),kn.draw(ut,$t.gl.TRIANGLES,Lr,Ye.ag.disabled,Xn,Qn,Wn,pt.id,fn.vertexBuffer,fn.indexBuffer,fn.segments,pt.paint,ut.transform.zoom,void 0,vn,Tt.instancedDataArray.length);else{const wt=Xt?"u_instance":"u_normal_matrix";for(let St=0;St<Tt.instancedDataArray.length;++St)Wn[wt]=new Float32Array(Tt.instancedDataArray.arrayBuffer,64*St,16),kn.draw(ut,$t.gl.TRIANGLES,Lr,Ye.ag.disabled,Xn,Qn,Wn,pt.id,fn.vertexBuffer,fn.indexBuffer,fn.segments,pt.paint,ut.transform.zoom,void 0,vn)}}if(wt.children)for(const Ye of wt.children)xr(ut,pt,Ye,Tt,St,It,Lt)}const zh=[1,-1,1];function br(ut,pt,wt,Tt){if(!wt.modelManager)return!0;const St=wt.modelManager;if(!wt.shadowRenderer)return!0;const It=wt.shadowRenderer,Lt=pt.aabb;let $t=!0,Xt=ut.maxHeight;if(0===Xt){let Ye=0;for(const pt in ut.instancesPerModel){const ut=St.getModel(pt,Tt);ut?Ye=Math.max(Ye,Math.max(Math.max(ut.aabb.max[0],ut.aabb.max[1]),ut.aabb.max[2])):$t=!1}Xt=ut.maxScale*Ye*1.41+ut.maxVerticalOffset,$t&&(ut.maxHeight=Xt)}Lt.max[2]=Xt,Lt.min[2]+=ut.terrainElevationMin,Lt.max[2]+=ut.terrainElevationMax,Ye._.transformMat4(Lt.min,Lt.min,pt.tileMatrix),Ye._.transformMat4(Lt.max,Lt.max,pt.tileMatrix);const Sr=Lt.intersects(It.getCurrentCascadeFrustum());return 0===wt.currentShadowCascade&&(ut.isInsideFirstShadowMapFrustum=2===Sr),0===Sr}function wr(ut,pt){const wt=ut.uniformValues.u_cutoff_params[0],Tt=ut.uniformValues.u_cutoff_params[1],St=ut.uniformValues.u_cutoff_params[2],It=ut.uniformValues.u_cutoff_params[3];return Tt===wt||It===St?1:Ye.at(((pt-wt)/(Tt-wt)-St)/(It-St),0,1)}function Tr(ut,pt,wt,Tt){if(pt.pitch<20)return 1;const St=pt.getWorldToCameraMatrix(),It=Ye.ad.multiply([],St,ut),Lt=[...wt.min,1];let $t=Ye.aA.transformMat4([],Lt,It),Xt=$t,Sr=$t;Lt[1]=wt.max[1],$t=Ye.aA.transformMat4([],Lt,It),Xt=$t[1]<Xt[1]?$t:Xt,Sr=$t[1]>Sr[1]?$t:Sr,Lt[0]=wt.max[0],$t=Ye.aA.transformMat4([],Lt,It),Xt=$t[1]<Xt[1]?$t:Xt,Sr=$t[1]>Sr[1]?$t:Sr,Lt[1]=wt.min[1],$t=Ye.aA.transformMat4([],Lt,It),Xt=$t[1]<Xt[1]?$t:Xt,Sr=$t[1]>Sr[1]?$t:Sr;const Lr=Ye.at(Tt[0],0,1),Qr=100*pt.pixelsPerMeter*Ye.at(Tt[1],0,1),fn=Ye.at(Tt[2],0,1),xn=Ye._.lerp([],Xt,Sr,Lr),vn=Math.tan(.5*pt.fovX),kn=-xn[2]*vn;if(0===Qr)return xn[1]<-Math.abs(kn)?fn:1;const Wn=(-Math.abs(kn)-xn[1])/Qr,v=(Ye,ut,pt)=>(1-pt)*Ye+pt*ut,Xn=Ye.at(v(1,fn,Wn),fn,1);return v(1,Xn,Ye.at((pt.pitch-20)/20,0,1))}class Er{}class Cr{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(ut,pt,wt){{const Ye=this._storage.get(pt.id);if(Ye)return Ye.lastUsedFrameIdx=ut,Ye.buf}const Tt=wt.gl,St=Tt.getBufferParameter(Tt.ELEMENT_ARRAY_BUFFER,Tt.BUFFER_SIZE),It=new ArrayBuffer(St),Lt=new Int16Array(It);Tt.getBufferSubData(Tt.ELEMENT_ARRAY_BUFFER,0,new Int16Array(It));const $t=new Ye.cm;for(let Ye=0;Ye<St/2;Ye+=3){const ut=Lt[Ye],pt=Lt[Ye+1],wt=Lt[Ye+2];$t.emplaceBack(ut,pt),$t.emplaceBack(pt,wt),$t.emplaceBack(wt,ut)}const Xt=wt.bindVertexArrayOES.current,Sr=new Er;return Sr.buf=new Ye.I(wt,$t),Sr.lastUsedFrameIdx=ut,this._storage.set(pt.id,Sr),wt.bindVertexArrayOES.set(Xt),Sr.buf}update(Ye){for(const[ut,pt]of this._storage)Ye-pt.lastUsedFrameIdx>30&&(pt.buf.destroy(),this._storage.delete(ut))}destroy(){for(const[Ye,ut]of this._storage)ut.buf.destroy(),this._storage.delete(Ye)}}const kh=Ye.c7([{type:"Float32",name:"a_offset_xy",components:2}]);class Ir{constructor(ut){const pt=new Ye.cn,wt=new Ye.bu;pt.emplaceBack(-1,-1),pt.emplaceBack(1,-1),pt.emplaceBack(1,1),pt.emplaceBack(-1,1),wt.emplaceBack(0,1,2),wt.emplaceBack(0,2,3),this.segments=Ye.b.simpleSegment(0,0,pt.length,wt.length),this.vx=ut.createVertexBuffer(pt,kh.members),this.idx=ut.createIndexBuffer(wt)}destroy(){this.vx.destroy(),this.idx.destroy()}}const qh={symbol:function(ut,pt,wt,Tt,St){if("translucent"!==ut.renderPass)return;const It=Ye.ag.disabled,Lt=ut.colorModeForRenderPass();wt.layout.get("text-variable-anchor")&&function(ut,pt,wt,Tt,St,It,Lt){const $t=pt.transform,Xt="map"===St,Sr="map"===It;for(const pt of ut){const ut=Tt.getTile(pt),St=ut.getBucket(wt);if(!St||!St.text||!St.text.segments.get().length)continue;const It=Ye.aD(St.textSizeData,$t.zoom),Lr=To(pt,St.getProjection(),$t),Qr=$t.calculatePixelsToTileUnitsMatrix(ut),fn=Yt(Lr,ut.tileID.canonical,Sr,Xt,$t,St.getProjection(),Qr),xn=St.hasIconTextFit()&&St.hasIconData();if(It){const wt=Math.pow(2,$t.zoom-ut.tileID.overscaledZ);Po(St,Xt,Sr,Lt,Ye.bO,$t,fn,pt,wt,It,xn)}}}(Tt,ut,wt,pt,wt.layout.get("text-rotation-alignment"),wt.layout.get("text-pitch-alignment"),St);const $t=0!==wt.paint.get("icon-opacity").constantOr(1),Xt=0!==wt.paint.get("text-opacity").constantOr(1);void 0!==wt.layout.get("symbol-sort-key").constantOr(1)&&($t||Xt)?Ao(ut,pt,wt,Tt,It,Lt):($t&&Ao(ut,pt,wt,Tt,It,Lt,{onlyIcons:!0}),Xt&&Ao(ut,pt,wt,Tt,It,Lt,{onlyText:!0}),function(ut,pt,wt,Tt){if(!ut.symbolParams.useOcclusionQueries)return;const St=ut.context.gl,It=ut.transform,Lt=wt.paint,$t=Lt.get("icon-occlusion-opacity").constantOr(0),Xt=Lt.get("text-occlusion-opacity").constantOr(0);if(!wt.hasInitialOcclusionOpacityProperties||1===$t&&1===Xt)return;const Sr="globe"===It.projection.name;for(const Lt of Tt){const Tt=pt.getTile(Lt),$t=Tt.getBucket(wt);if(!$t)continue;if("mercator"===$t.projection.name&&Sr)continue;if($t.fullyClipped)continue;if("globe"===$t.projection.name){Ye.w(`Occlusion not supported for globe mode. Layer: ${wt.type}`);continue}const Xt=To(Lt,$t.getProjection(),It),Lr=Ye.ad.fromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,ut.symbolParams.depthOffset,1),Qr=Ye.ad.multiply([],Lr,Xt),fn="none"!==ut.symbolParams.visualizeOcclusions?1:ut.symbolParams.occlusionQueryFrameWindow;for(let pt=0;pt<$t.symbolInstances.length;pt++){const wt=$t.symbolInstances.get(pt),Lt=ut.style.placement.opacities[wt.crossTileID];if(Lt&&Lt.isHidden())continue;if((ut.frameCounter+pt)%fn!=0)continue;const Xt=wt.tileAnchorX,Sr=wt.tileAnchorY,Lr=wt.zOffset;let xn;if("none"===ut.symbolParams.visualizeOcclusions){const Ye=$t.queries.get(pt);if(Ye){if(!Ye.isFree()){if(!Ye.isResultAvailable())continue;const ut=Ye.consumeResult();wt.occlusionState=0===ut?0:1;continue}xn=Ye}else xn=new ne(ut.context),$t.queries.set(pt,xn)}const vn=ut.getOrCreateProgram("occlusion"),kn=ut.symbolParams.occluderSize,Wn=xo(Qr,[Xt,Sr,Lr],[It.width,It.height],[kn,kn],"zPass"===ut.symbolParams.visualizeOcclusions?[1,0,0,.8]:[1,.4,.2,.9]);ut.terrain&&ut.terrain.setupElevationDraw(Tt,vn,{useDepthForOcclusion:!1,labelPlaneMatrixInv:void 0}),"none"===ut.symbolParams.visualizeOcclusions&&xn&&xn.begin();const Xn=new Ye.ae("zPass"===ut.symbolParams.visualizeOcclusions?ut.context.gl.ALWAYS:ut.context.gl.LEQUAL,Ye.ae.ReadOnly,ut.depthRangeFor3D);vn.draw(ut,St.TRIANGLES,Xn,Ye.ag.disabled,"none"!==ut.symbolParams.visualizeOcclusions?Ye.a.alphaBlendedNonPremultiplied:Ye.a.disabled,Ye.af.disabled,Wn,"occlusion",ut.occlusionBuffers.vx,ut.occlusionBuffers.idx,ut.occlusionBuffers.segments),"none"===ut.symbolParams.visualizeOcclusions&&xn&&xn.end()}}}(ut,pt,wt,Tt)),pt.map.showCollisionBoxes&&(Co(ut,pt,wt,Tt,wt.paint.get("text-translate"),wt.paint.get("text-translate-anchor"),!0),Co(ut,pt,wt,Tt,wt.paint.get("icon-translate"),wt.paint.get("icon-translate-anchor"),!1))},circle:function(ut,pt,wt,Tt){if("translucent"!==ut.renderPass)return;const St=wt.paint.get("circle-opacity"),It=wt.paint.get("circle-stroke-width"),Lt=wt.paint.get("circle-stroke-opacity"),$t=void 0!==wt.layout.get("circle-sort-key").constantOr(1),Xt=wt.paint.get("circle-emissive-strength");if(0===St.constantOr(1)&&(0===It.constantOr(1)||0===Lt.constantOr(1)))return;const Sr=ut.context,Lr=Sr.gl,Qr=ut.transform,fn=ut.depthModeForSublayer(0,Ye.ae.ReadOnly),xn=Ye.ag.disabled,vn=ut.colorModeForDrapableLayerRenderPass(Xt),kn="globe"===Qr.projection.name,Wn=[Ye.aj(Qr.center.lng),Ye.ak(Qr.center.lat)],Xn=[];for(let St=0;St<Tt.length;St++){const It=Tt[St],Lt=pt.getTile(It),Xt=Lt.getBucket(wt);if(!Xt||Xt.projection.name!==Qr.projection.name)continue;const Sr=Xt.programConfigurations.get(wt.id),Lr=Ye.bR(wt),fn=ut.isTileAffectedByFog(It);kn&&Lr.push("PROJECTION_GLOBE_VIEW"),Lr.push("TERRAIN_DEPTH_D24");const xn=ut.getOrCreateProgram("circle",{config:Sr,defines:Lr,overrideFog:fn}),vn=Xt.layoutVertexBuffer,Jn=Xt.globeExtVertexBuffer,Qn=Xt.indexBuffer,ko=Qr.projection.createInversionMatrix(Qr,It.canonical),Fo={programConfiguration:Sr,program:xn,layoutVertexBuffer:vn,globeExtVertexBuffer:Jn,indexBuffer:Qn,uniformValues:Ye.bS(ut,It,Lt,ko,Wn,wt),tile:Lt};if($t){const ut=Xt.segments.get();for(const pt of ut)Xn.push({segments:new Ye.b([pt]),sortKey:pt.sortKey,state:Fo})}else Xn.push({segments:Xt.segments,sortKey:0,state:Fo})}$t&&Xn.sort(((Ye,ut)=>Ye.sortKey-ut.sortKey));const Jn={useDepthForOcclusion:Qr.depthOcclusionForSymbolsAndCircles};for(const pt of Xn){const{programConfiguration:Tt,program:St,layoutVertexBuffer:It,globeExtVertexBuffer:Lt,indexBuffer:$t,uniformValues:Xt,tile:kn}=pt.state,Wn=pt.segments;ut.terrain&&ut.terrain.setupElevationDraw(kn,St,Jn),ut.uploadCommonUniforms(Sr,St,kn.tileID.toUnwrapped()),St.draw(ut,Lr.TRIANGLES,fn,xn,vn,Ye.af.disabled,Xt,wt.id,It,$t,Wn,wt.paint,Qr.zoom,Tt,[Lt])}},heatmap:function(ut,pt,wt,Tt){if(0!==wt.paint.get("heatmap-opacity"))if("offscreen"===ut.renderPass){const St=ut.context,It=St.gl,Lt=Ye.ag.disabled,$t=new Ye.a([It.ONE,It.ONE,It.ONE,It.ONE],Ye.C.transparent,[!0,!0,!0,!0]);!function(Ye,ut,pt,wt){const Tt=Ye.gl,St=ut.width*wt,It=ut.height*wt;Ye.activeTexture.set(Tt.TEXTURE1),Ye.viewport.set([0,0,St,It]);let Lt=pt.heatmapFbo;if(!Lt||Lt&&(Lt.width!==St||Lt.height!==It)){Lt&&Lt.destroy();const ut=Tt.createTexture();Tt.bindTexture(Tt.TEXTURE_2D,ut),Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_WRAP_S,Tt.CLAMP_TO_EDGE),Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_WRAP_T,Tt.CLAMP_TO_EDGE),Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_MIN_FILTER,Tt.LINEAR),Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_MAG_FILTER,Tt.LINEAR),Lt=pt.heatmapFbo=Ye.createFramebuffer(St,It,!0,null),function(Ye,ut,pt,wt,Tt,St){const It=Ye.gl;It.texImage2D(It.TEXTURE_2D,0,Ye.extRenderToTextureHalfFloat?It.RGBA16F:It.RGBA,Tt,St,0,It.RGBA,Ye.extRenderToTextureHalfFloat?It.HALF_FLOAT:It.UNSIGNED_BYTE,null),wt.colorAttachment.set(pt)}(Ye,0,ut,Lt,St,It)}else Tt.bindTexture(Tt.TEXTURE_2D,Lt.colorAttachment.get()),Ye.bindFramebuffer.set(Lt.framebuffer)}(St,ut,wt,"globe"===ut.transform.projection.name?.5:.25),St.clear({color:Ye.C.transparent});const Xt=ut.transform,Sr="globe"===Xt.projection.name,Lr=Sr?["PROJECTION_GLOBE_VIEW"]:[],Qr=Sr?Ye.af.frontCCW:Ye.af.disabled,fn=[Ye.aj(Xt.center.lng),Ye.ak(Xt.center.lat)];for(let xn=0;xn<Tt.length;xn++){const vn=Tt[xn];if(pt.hasRenderableParent(vn))continue;const kn=pt.getTile(vn),Wn=kn.getBucket(wt);if(!Wn||Wn.projection.name!==Xt.projection.name)continue;const Xn=ut.isTileAffectedByFog(vn),Jn=Wn.programConfigurations.get(wt.id),Qn=ut.getOrCreateProgram("heatmap",{config:Jn,defines:Lr,overrideFog:Xn}),{zoom:ko}=ut.transform;ut.terrain&&ut.terrain.setupElevationDraw(kn,Qn),ut.uploadCommonUniforms(St,Qn,vn.toUnwrapped());const Fo=Xt.projection.createInversionMatrix(Xt,vn.canonical);Qn.draw(ut,It.TRIANGLES,Ye.ae.disabled,Lt,$t,Qr,eo(ut,vn,kn,Fo,fn,ko,wt.paint.get("heatmap-intensity")),wt.id,Wn.layoutVertexBuffer,Wn.indexBuffer,Wn.segments,wt.paint,ut.transform.zoom,Jn,Sr?[Wn.globeExtVertexBuffer]:null)}St.viewport.set([0,0,ut.width,ut.height])}else"translucent"===ut.renderPass&&(ut.context.setColorMode(ut.colorModeForRenderPass()),function(ut,pt){const wt=ut.context,Tt=wt.gl,St=pt.heatmapFbo;if(!St)return;wt.activeTexture.set(Tt.TEXTURE0),Tt.bindTexture(Tt.TEXTURE_2D,St.colorAttachment.get()),wt.activeTexture.set(Tt.TEXTURE1);let It=pt.colorRampTexture;It||(It=pt.colorRampTexture=new Ye.T(wt,pt.colorRamp,Tt.RGBA)),It.bind(Tt.LINEAR,Tt.CLAMP_TO_EDGE),ut.getOrCreateProgram("heatmapTexture").draw(ut,Tt.TRIANGLES,Ye.ae.disabled,Ye.ag.disabled,ut.colorModeForRenderPass(),Ye.af.disabled,((Ye,ut,pt,wt)=>({u_image:0,u_color_ramp:1,u_opacity:ut.paint.get("heatmap-opacity")}))(0,pt),pt.id,ut.viewportBuffer,ut.quadTriangleIndexBuffer,ut.viewportSegments,pt.paint,ut.transform.zoom)}(ut,wt))},line:function(ut,pt,wt,Tt){if("translucent"!==ut.renderPass)return;const St=wt.paint.get("line-opacity"),It=wt.paint.get("line-width");if(0===St.constantOr(1)||0===It.constantOr(1))return;const Lt=wt.paint.get("line-emissive-strength"),$t=wt.paint.get("line-occlusion-opacity"),Xt=ut.context,Sr=Xt.gl,Lr=wt.layout.get("line-z-offset"),Qr=!Lr.isConstant()||!!Lr.constantOr(0),fn=Qr?new Ye.ae(ut.depthOcclusion?Sr.GREATER:Sr.LEQUAL,Ye.ae.ReadOnly,ut.depthRangeFor3D):ut.depthModeForSublayer(0,Ye.ae.ReadOnly),xn=ut.colorModeForDrapableLayerRenderPass(Lt),vn=ut.terrain&&ut.terrain.renderingToTexture,kn=vn?1:Ye.e.devicePixelRatio,Wn=wt.paint.get("line-dasharray"),Xn=Wn.constantOr(1),Jn=wt.layout.get("line-cap"),Qn=Wn.constantOr(null),ko=Jn.constantOr(null),Fo=wt.paint.get("line-pattern"),is=Fo.constantOr(1),ns=Fo.constantOr(null),ss=wt.paint.get("line-opacity").constantOr(1);let as=!is&&1!==ss||ut.depthOcclusion&&$t>0&&$t<1;const ds=wt.paint.get("line-gradient"),ps=is?"linePattern":"line",ms=Ye.bT(wt);let Js;if(vn&&ut.terrain&&ut.terrain.clipOrMaskOverlapStencilType()&&(as=!1),0!==$t&&ut.depthOcclusion){const ut=wt.paint._values["line-opacity"];ut&&ut.value&&"constant"===ut.value.kind?Js=ut.value:Ye.w(`Occlusion opacity for layer ${wt.id} is supported only when line-opacity isn't data-driven.`)}if(Qr&&(ut.forceTerrainMode=!0),!Qr&&0!==$t&&ut.terrain&&!vn)return void Ye.w(`Occlusion opacity for layer ${wt.id} is supported on terrain only if the layer has non-zero line-z-offset.`);const ua=as&&Qr?ut.stencilModeFor3D():Ye.ag.disabled;for(const St of Tt){const Tt=pt.getTile(St);if(is&&!Tt.patternsLoaded())continue;const It=Tt.getBucket(wt);if(!It)continue;ut.prepareDrawTile();const Lt=It.programConfigurations.get(wt.id),Lr=ut.isTileAffectedByFog(St),Wn=ut.getOrCreateProgram(ps,{config:Lt,defines:Qr?[...ms,"ELEVATED"]:ms,overrideFog:Lr});if(ns&&Tt.imageAtlas){const Ye=Tt.imageAtlas.patternPositions[ns.toString()];Ye&&Lt.setConstantPatternPositions(Ye)}if(!is&&Qn&&ko&&Tt.lineAtlas){const Ye=Tt.lineAtlas.getDash(Qn,ko);Ye&&Lt.setConstantPatternPositions(Ye)}let[Jn,Fo]=wt.paint.get("line-trim-offset");if("round"===ko||"square"===ko){const Ye=1;Jn!==Fo&&(0===Jn&&(Jn-=Ye),1===Fo&&(Fo+=Ye))}const ba=vn?St.projMatrix:null,Ra=is?Ye.bU(ut,Tt,wt,ba,kn,[Jn,Fo]):Ye.bV(ut,Tt,wt,ba,It.lineClipsArray.length,kn,[Jn,Fo]);if(ds){const Tt=It.gradients[wt.id];let Lt=Tt.texture;if(wt.gradientVersion!==Tt.version){let $t=256;if(wt.stepInterpolant){const wt=pt.getSource().maxzoom,Tt=St.canonical.z===wt?Math.ceil(1<<ut.transform.maxZoom-St.canonical.z):1;$t=Ye.at(Ye.bW(It.maxLineLength/Ye.a3*1024*Tt),256,Xt.maxTextureSize)}Tt.gradient=Ye.bX({expression:wt.gradientExpression(),evaluationKey:"lineProgress",resolution:$t,image:Tt.gradient||void 0,clips:It.lineClipsArray}),Tt.texture?Tt.texture.update(Tt.gradient):Tt.texture=new Ye.T(Xt,Tt.gradient,Sr.RGBA),Tt.version=wt.gradientVersion,Lt=Tt.texture}Xt.activeTexture.set(Sr.TEXTURE1),Lt.bind(wt.stepInterpolant?Sr.NEAREST:Sr.LINEAR,Sr.CLAMP_TO_EDGE)}Xn&&(Xt.activeTexture.set(Sr.TEXTURE0),Tt.lineAtlasTexture&&Tt.lineAtlasTexture.bind(Sr.LINEAR,Sr.REPEAT),Lt.updatePaintBuffers()),is&&(Xt.activeTexture.set(Sr.TEXTURE0),Tt.imageAtlasTexture&&Tt.imageAtlasTexture.bind(Sr.LINEAR,Sr.CLAMP_TO_EDGE),Lt.updatePaintBuffers()),Qr&&ut.terrain.setupElevationDraw(Tt,Wn),ut.uploadCommonUniforms(Xt,Wn,St.toUnwrapped());const z=pt=>{null!=Js&&(Js.value=ss*$t),Wn.draw(ut,Sr.TRIANGLES,fn,pt,xn,Ye.af.disabled,Ra,wt.id,It.layoutVertexBuffer,It.indexBuffer,It.segments,wt.paint,ut.transform.zoom,Lt,[It.layoutVertexBuffer2,It.patternVertexBuffer,It.zOffsetVertexBuffer]),null!=Js&&(Js.value=ss)};if(as&&!Qr){const pt=ut.stencilModeForClipping(St).ref;0===pt&&vn&&Xt.clear({stencil:0});const wt={func:Sr.EQUAL,mask:255};Ra.u_alpha_discard_threshold=.8,z(new Ye.ag(wt,pt,255,Sr.KEEP,Sr.KEEP,Sr.INVERT)),Ra.u_alpha_discard_threshold=0,z(new Ye.ag(wt,pt,255,Sr.KEEP,Sr.KEEP,Sr.KEEP))}else as&&Qr&&(Ra.u_alpha_discard_threshold=.001),z(Qr?ua:ut.stencilModeForClipping(St))}as&&(ut.resetStencilClippingMasks(),vn&&Xt.clear({stencil:0})),0===$t||ut.depthOcclusion||vn||ut.layersWithOcclusionOpacity.push(ut.currentLayer),Qr&&(ut.forceTerrainMode=!1)},fill:function(ut,pt,wt,Tt){const St=wt.paint.get("fill-color"),It=wt.paint.get("fill-opacity");if(0===It.constantOr(1))return;const Lt=wt.paint.get("fill-emissive-strength"),$t=ut.colorModeForDrapableLayerRenderPass(Lt),Xt=wt.paint.get("fill-pattern"),Sr=ut.opaquePassEnabledForLayer()&&!Xt.constantOr(1)&&1===St.constantOr(Ye.C.transparent).a&&1===It.constantOr(0)?"opaque":"translucent";if(ut.renderPass===Sr){const St=ut.depthModeForSublayer(1,"opaque"===ut.renderPass?Ye.ae.ReadWrite:Ye.ae.ReadOnly);Do(ut,pt,wt,Tt,St,$t,!1)}if("translucent"===ut.renderPass&&wt.paint.get("fill-antialias")){const St=ut.depthModeForSublayer(wt.getPaintProperty("fill-outline-color")?2:0,Ye.ae.ReadOnly);Do(ut,pt,wt,Tt,St,$t,!0)}},"fill-extrusion":function(ut,pt,wt,Tt){const St=wt.paint.get("fill-extrusion-opacity"),It=ut.context,Lt=It.gl,$t=ut.terrain,Xt=$t&&$t.renderingToTexture;if(0===St)return;const Sr=ut.conflationActive&&ut.style.isLayerClipped(wt,pt.getSource()),Lr=ut.style.order.indexOf(wt.fqid);if(Sr&&function(Ye,ut,pt,wt,Tt){for(const St of wt){const wt=ut.getTile(St).getBucket(pt);wt&&(wt.updateReplacement(St,Ye.replacementSource,Tt),wt.uploadCentroid(Ye.context))}}(ut,pt,wt,Tt,Lr),$t||Sr)for(const Ye of Tt){const Tt=pt.getTile(Ye).getBucket(wt);Tt&&Oo(ut.context,pt,Ye,Tt,wt,$t,Sr)}if("shadow"===ut.renderPass&&ut.shadowRenderer){const It=ut.shadowRenderer;if($t&&St<.65&&wt._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof Ye.Z)return;const Lt=It.getShadowPassDepthMode(),Xt=It.getShadowPassColorMode();Mo(ut,pt,wt,Tt,Lt,Ye.ag.disabled,Xt,Sr)}else if("translucent"===ut.renderPass){const Lr=!wt.paint.get("fill-extrusion-pattern").constantOr(1),Qr=wt.paint.get("fill-extrusion-color").constantOr(Ye.C.white);if(!Xt&&0!==Qr.a){const It=new Ye.ae(ut.context.gl.LEQUAL,Ye.ae.ReadWrite,ut.depthRangeFor3D);1===St&&Lr?Mo(ut,pt,wt,Tt,It,Ye.ag.disabled,Ye.a.unblended,Sr):(Mo(ut,pt,wt,Tt,It,Ye.ag.disabled,Ye.a.disabled,Sr),Mo(ut,pt,wt,Tt,It,ut.stencilModeFor3D(),ut.colorModeForRenderPass(),Sr),ut.resetStencilClippingMasks())}if(ut.style.enable3dLights()&&Lr&&(!$t&&"globe"!==ut.transform.projection.name||Xt)){const St=wt.paint.get("fill-extrusion-opacity"),Lr=wt.paint.get("fill-extrusion-ambient-occlusion-intensity"),Qr=wt.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),fn=wt.paint.get("fill-extrusion-flood-light-intensity"),xn=wt.paint.get("fill-extrusion-flood-light-color").toRenderColor(wt.lut).toArray01().slice(0,3),vn=Lr>0&&Qr>0,kn=fn>0,g=(Ye,ut,pt)=>(1-pt)*Ye+pt*ut,v=It=>{const $t=ut.depthModeForSublayer(1,Ye.ae.ReadOnly,Lt.LEQUAL,!0),Xt=wt.paint.get(It?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),vn=g(.1,3,Xt),kn=ut._showOverdrawInspector;if(!kn){const Xt=new Ye.ag({func:Lt.ALWAYS,mask:255},255,255,Lt.KEEP,Lt.KEEP,Lt.REPLACE),kn=new Ye.a([Lt.ONE,Lt.ONE,Lt.ONE,Lt.ONE],Ye.C.transparent,[!1,!1,!1,!0],Lt.MIN);zo(ut,pt,wt,Tt,$t,Xt,kn,Ye.af.disabled,It,"sdf",St,Lr,Qr,fn,xn,vn,Sr,!1)}{const Xt=kn?Ye.ag.disabled:new Ye.ag({func:Lt.EQUAL,mask:255},255,255,Lt.KEEP,Lt.DECR,Lt.DECR),Wn=kn?ut.colorModeForRenderPass():new Ye.a([Lt.ONE_MINUS_DST_ALPHA,Lt.DST_ALPHA,Lt.ONE,Lt.ONE],Ye.C.transparent,[!0,!0,!0,!0]);zo(ut,pt,wt,Tt,$t,Xt,Wn,Ye.af.disabled,It,"color",St,Lr,Qr,fn,xn,vn,Sr,!1)}};if(Xt){const c=(It,$t,Xt)=>{const vn=ut.depthModeForSublayer(1,Ye.ae.ReadOnly,Lt.LEQUAL,!1),kn=wt.paint.get(It?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Wn=g(.1,3,kn);{const Xt=new Ye.a([Lt.ONE,Lt.ONE,Lt.ONE,Lt.ONE],Ye.C.transparent,[!1,!1,!1,!0]);zo(ut,pt,wt,Tt,vn,Ye.ag.disabled,Xt,Ye.af.disabled,It,"clear",St,Lr,Qr,fn,xn,Wn,Sr,$t)}{const Xt=new Ye.ag({func:Lt.ALWAYS,mask:255},255,255,Lt.KEEP,Lt.KEEP,Lt.REPLACE),kn=new Ye.a([Lt.ONE,Lt.ONE,Lt.ONE,Lt.ONE],Ye.C.transparent,[!1,!1,!1,!0],Lt.MIN);zo(ut,pt,wt,Tt,vn,Xt,kn,Ye.af.disabled,It,"sdf",St,Lr,Qr,fn,xn,Wn,Sr,$t)}{const Xt=It?Lt.ZERO:Lt.ONE_MINUS_DST_ALPHA,kn=new Ye.ag({func:Lt.EQUAL,mask:255},255,255,Lt.KEEP,Lt.DECR,Lt.DECR),Xn=new Ye.a([Xt,Lt.DST_ALPHA,Lt.ONE_MINUS_DST_ALPHA,Lt.ZERO],Ye.C.transparent,[!0,!0,!0,!0]);zo(ut,pt,wt,Tt,vn,kn,Xn,Ye.af.disabled,It,"color",St,Lr,Qr,fn,xn,Wn,Sr,$t)}{const kn=new Ye.a([Lt.ONE,Lt.ONE,Lt.ONE,It?Lt.ZERO:Lt.ONE],Ye.C.transparent,[!1,!1,!1,!0],It?Lt.FUNC_ADD:Lt.MAX);zo(ut,pt,wt,Tt,vn,Ye.ag.disabled,kn,Ye.af.disabled,It,"clear",St,Lr,Qr,fn,xn,Wn,Sr,$t,Xt)}};if(vn||kn){let pt;if(ut.prepareDrawTile(),$t){const ut=$t.drapeBufferSize[0],wt=$t.drapeBufferSize[1];pt=$t.framebufferCopyTexture,pt&&(!pt||pt.size[0]===ut&&pt.size[1]===wt)||(pt&&pt.destroy(),pt=$t.framebufferCopyTexture=new Ye.T(It,new Ye.i({width:ut,height:wt}),Lt.RGBA)),pt.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE),Lt.copyTexImage2D(Lt.TEXTURE_2D,0,Lt.RGBA,0,0,ut,wt,0)}vn&&c(!0,!1,pt),kn&&c(!1,!0,pt)}}else vn&&v(!0),kn&&v(!1)}}},hillshade:function(ut,pt,wt,Tt){if("offscreen"!==ut.renderPass&&"translucent"!==ut.renderPass)return;if(ut.style.disableElevatedTerrain)return;const St=ut.context,It=ut.terrain&&ut.terrain.renderingToTexture,[Lt,$t]="translucent"!==ut.renderPass||It?[{},Tt]:ut.stencilConfigForOverlap(Tt);for(const Tt of $t){const St=pt.getTile(Tt);if(St.needsHillshadePrepare&&"offscreen"===ut.renderPass)Ot(ut,St,wt);else if("translucent"===ut.renderPass){const pt=ut.depthModeForSublayer(0,Ye.ae.ReadOnly),$t=wt.paint.get("hillshade-emissive-strength"),Xt=ut.colorModeForDrapableLayerRenderPass($t),Sr=It&&ut.terrain?ut.terrain.stencilModeForRTTOverlap(Tt):Lt[Tt.overscaledZ];Mt(ut,Tt,St,wt,pt,Sr,Xt)}}St.viewport.set([0,0,ut.width,ut.height]),ut.resetStencilClippingMasks()},raster:function(ut,pt,wt,Tt,St,It){if("translucent"!==ut.renderPass)return;if(0===wt.paint.get("raster-opacity"))return;const Lt="globe"===ut.transform.projection.name,$t=0!==wt.paint.get("raster-elevation"),Xt=$t&&Lt;if(ut.renderElevatedRasterBackface&&!Xt)return;const Sr=ut.context,Lr=Sr.gl,Qr=pt.getSource(),fn=function(ut,pt,wt,Tt){const St=pt.paint.get("raster-color"),It="raster-array"===ut.type,Lt=[],$t=pt.paint.get("raster-resampling"),Xt=pt.paint.get("raster-color-mix");let Sr=pt.paint.get("raster-color-range");const Lr=[Xt[0],Xt[1],Xt[2],0],Qr=Xt[3];let fn="nearest"===$t?Tt.NEAREST:Tt.LINEAR;if(It&&(Lt.push("RASTER_ARRAY"),St||Lt.push("RASTER_COLOR"),"linear"===$t&&Lt.push("RASTER_ARRAY_LINEAR"),fn=Tt.NEAREST,!Sr&&ut.rasterLayers)){const Ye=ut.rasterLayers.find((({id:Ye})=>Ye===pt.sourceLayer));Ye&&Ye.fields&&Ye.fields.range&&(Sr=Ye.fields.range)}if(Sr=Sr||[0,1],St){Lt.push("RASTER_COLOR"),wt.activeTexture.set(Tt.TEXTURE2),pt.updateColorRamp(Sr);let ut=pt.colorRampTexture;ut||(ut=pt.colorRampTexture=new Ye.T(wt,pt.colorRamp,Tt.RGBA)),ut.bind(Tt.LINEAR,Tt.CLAMP_TO_EDGE)}return{mix:Lr,range:Sr,offset:Qr,defines:Lt,resampling:fn}}(Qr,wt,Sr,Lr);if(Qr instanceof Ye.bm&&!Tt.length&&!Lt)return;const xn=wt.paint.get("raster-emissive-strength"),vn=ut.colorModeForDrapableLayerRenderPass(xn),kn=ut.terrain&&ut.terrain.renderingToTexture,Wn=!ut.options.moving,Xn="nearest"===wt.paint.get("raster-resampling")?Lr.NEAREST:Lr.LINEAR;if(Qr instanceof Ye.bm&&!Tt.length&&(Qr.onNorthPole||Qr.onSouthPole)){const Tt=$t?ut.stencilModeFor3D():Ye.ag.disabled;return void Go(!!Qr.onNorthPole,null,ut,pt,wt,xn,fn,Ye.af.disabled,Tt)}if(!Tt.length)return;const[Jn,Qn]=Qr instanceof Ye.bm||kn?[{},Tt]:ut.stencilConfigForOverlap(Tt),ko=Qn[Qn.length-1].overscaledZ;Xt&&fn.defines.push("PROJECTION_GLOBE_VIEW"),$t&&fn.defines.push("RENDER_CUTOFF");const w=(Tt,St,Qn)=>{for(const Fo of Tt){const Tt=Fo.toUnwrapped(),is=pt.getTile(Fo);if(kn&&(!is||!is.hasData()))continue;Sr.activeTexture.set(Lr.TEXTURE0);const ns=Vo(is,Qr,wt,fn);if(!ns||!ns.texture)continue;const{texture:ss,mix:as,offset:ds,tileSize:ps,buffer:ms}=ns;let Js,ua;kn?(Js=Ye.ae.disabled,ua=Fo.projMatrix):$t?(Js=new Ye.ae(Lr.LEQUAL,Ye.ae.ReadWrite,ut.depthRangeFor3D),ua=Lt?Float32Array.from(ut.transform.expandedFarZProjMatrix):ut.transform.calculateProjMatrix(Tt,Wn)):(Js=ut.depthModeForSublayer(Fo.overscaledZ-ko,1===wt.paint.get("raster-opacity")?Ye.ae.ReadWrite:Ye.ae.ReadOnly,Lr.LESS),ua=ut.transform.calculateProjMatrix(Tt,Wn));const ba=ut.terrain&&kn?ut.terrain.stencilModeForRTTOverlap(Fo):Jn[Fo.overscaledZ],Ra=It?0:wt.paint.get("raster-fade-duration");is.registerFadeDuration(Ra);const La=pt.findLoadedParent(Fo,0),ll=Ai(is,La,pt,ut.transform,Ra);let yl,Tl;ut.terrain&&ut.terrain.prepareDrawTile(),Sr.activeTexture.set(Lr.TEXTURE0),ss.bind(Xn,Lr.CLAMP_TO_EDGE),Sr.activeTexture.set(Lr.TEXTURE1),La?(La.texture&&La.texture.bind(Xn,Lr.CLAMP_TO_EDGE),yl=Math.pow(2,La.tileID.overscaledZ-is.tileID.overscaledZ),Tl=[is.tileID.canonical.x*yl%1,is.tileID.canonical.y*yl%1]):ss.bind(Xn,Lr.CLAMP_TO_EDGE),ss.useMipmap&&Sr.extTextureFilterAnisotropic&&ut.transform.pitch>20&&Lr.texParameterf(Lr.TEXTURE_2D,Sr.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Sr.extTextureFilterAnisotropicMax);const Al=ut.transform;let Il;const Pl=$t?jo(Al):[0,0,0,0];let ec,tc,ic,nc,oc,sc=0;if(Xt&&Qr instanceof Ye.bm&&Qr.coordinates.length>3)ec=Float32Array.from(Ye.bf(Ye.bg(new Ye.aO(0,0,0)))),tc=Float32Array.from(Al.globeMatrix),ic=Float32Array.from(Ye.bb(Al)),nc=[Ye.aj(Al.center.lng),Ye.ak(Al.center.lat)],Il=Qr.elevatedGlobePerspectiveTransform,oc=Qr.elevatedGlobeGridMatrix||new Float32Array(9);else if(Xt){const ut=Ye.bc(Fo.canonical);sc=Ye.bd(ut.getCenter().lat),ec=Float32Array.from(Ye.bf(Ye.bg(Fo.canonical))),tc=Float32Array.from(Al.globeMatrix),ic=Float32Array.from(Ye.bb(Al)),nc=[Ye.aj(Al.center.lng),Ye.ak(Al.center.lat)],Il=[0,0],oc=Float32Array.from(Ye.be(Fo.canonical,ut,sc,Al.worldSize/Al._pixelsPerMercatorPixel))}else Il=Qr instanceof Ye.bm?Qr.perspectiveTransform:[0,0],ec=new Float32Array(16),tc=new Float32Array(9),ic=new Float32Array(16),nc=[0,0],oc=new Float32Array(9);const ac=oo(ua,ec,tc,ic,oc,Tl||[0,0],Ye.a1(ut.transform.zoom),nc,Pl,yl||1,ll,wt,Il,$t?wt.paint.get("raster-elevation"):0,2,as,ds,fn.range,ps,ms,xn),lc=ut.isTileAffectedByFog(Fo),cc=ut.getOrCreateProgram("raster",{defines:fn.defines,overrideFog:lc});if(ut.uploadCommonUniforms(Sr,cc,Tt),Qr instanceof Ye.bm){const pt=Qr.elevatedGlobeVertexBuffer,Tt=Qr.elevatedGlobeIndexBuffer;if(kn||!Lt)Qr.boundsBuffer&&Qr.boundsSegments&&cc.draw(ut,Lr.TRIANGLES,Js,Ye.ag.disabled,vn,Ye.af.disabled,ac,wt.id,Qr.boundsBuffer,ut.quadTriangleIndexBuffer,Qr.boundsSegments);else if(pt&&Tt){const It=Al.zoom<=Ye.b1?Qr.elevatedGlobeSegments:Qr.getSegmentsForLongitude(Al.center.lng);It&&cc.draw(ut,Lr.TRIANGLES,Js,Ye.ag.disabled,vn,St,ac,wt.id,pt,Tt,It)}}else if(Xt){Js=new Ye.ae(Lr.LEQUAL,Ye.ae.ReadOnly,ut.depthRangeFor3D);const pt=ut.globeSharedBuffers;if(pt){const[Ye,Tt,It]=pt.getGridBuffers(sc,!1);cc.draw(ut,Lr.TRIANGLES,Js,Qn||ba,ut.colorModeForRenderPass(),St,ac,wt.id,Ye,Tt,It)}}else{const{tileBoundsBuffer:pt,tileBoundsIndexBuffer:Tt,tileBoundsSegments:St}=ut.getTileBoundsBuffers(is);cc.draw(ut,Lr.TRIANGLES,Js,ba,vn,Ye.af.disabled,ac,wt.id,pt,Tt,St)}}if(!(Qr instanceof Ye.bm)&&Xt)for(const It of Tt){const Tt=It.canonical.y===(1<<It.canonical.z)-1;0===It.canonical.y&&Go(!0,It,ut,pt,wt,xn,fn,St,Qn||Ye.ag.disabled),Tt&&Go(!1,It,ut,pt,wt,xn,fn,St===Ye.af.frontCW?Ye.af.backCW:Ye.af.frontCW,Qn||Ye.ag.disabled)}};Xt?w(Qn,ut.renderElevatedRasterBackface?Ye.af.backCW:Ye.af.frontCW,ut.stencilModeFor3D()):w(Qn,Ye.af.disabled,void 0),ut.resetStencilClippingMasks()},"raster-particle":function(ut,pt,wt,Tt,St,It){"offscreen"===ut.renderPass&&function(ut,pt,wt,Tt){if(!Tt.length)return;const St=ut.context,It=St.gl,Lt=pt.getSource();if(!(Lt instanceof Ri))return;const $t=Math.ceil(Math.sqrt(wt.paint.get("raster-particle-count")));let Xt=wt.particlePositionRGBAImage;if(!Xt||Xt.width!==$t){const ut=function(Ye){const ut=Ye*Ye,pt=new Uint8Array(4*ut),o=function(Ye){return Ye|=0,Ye=Math.imul(2747636419^Ye,2654435769),Ye=Math.imul(Ye^Ye>>>16,2654435769),((Ye=Math.imul(Ye^Ye>>>16,2654435769))>>>0)/4294967296},wt=1/1.1;for(let Ye=0;Ye<ut;Ye++){const ut=wt*(o(2*Ye+0)+ac),Tt=wt*(o(2*Ye+1)+ac),St=255*ut%1,It=255*Tt%1,Lt=St,$t=Tt-It/255,Xt=It;pt[4*Ye+0]=255*(ut-St/255),pt[4*Ye+1]=255*Lt,pt[4*Ye+2]=255*$t,pt[4*Ye+3]=255*Xt}return pt}($t);Xt=wt.particlePositionRGBAImage=new Ye.i({width:$t,height:$t},ut)}let Sr=wt.particleFramebuffer;Sr?Sr.width!==$t&&(Sr.destroy(),Sr=wt.particleFramebuffer=St.createFramebuffer($t,$t,!0,null)):Sr=wt.particleFramebuffer=St.createFramebuffer($t,$t,!0,null);const Lr=[];for(const ut of Tt){const Tt=pt.getTile(ut);if(!(Tt instanceof Ye.c3))continue;const It=Wo(Tt,Lt,wt);if(!It)continue;const Sr=[Tt.tileSize,Tt.tileSize];let Qr=wt.tileFramebuffer;Qr||(Qr=wt.tileFramebuffer=St.createFramebuffer(Sr[0],Sr[1],!0,null));let fn=Tt.rasterParticleState;fn||(fn=Tt.rasterParticleState=new le(St,ut,Sr,Xt));const xn=fn.update(wt.lastInvalidatedAt);fn.particleTextureDimension!==$t&&fn.updateParticleTexture(ut,Xt);const vn=fn.targetColorTexture;fn.targetColorTexture=fn.backgroundColorTexture,fn.backgroundColorTexture=vn;const kn=fn.particleTexture0;fn.particleTexture0=fn.particleTexture1,fn.particleTexture1=kn,Lr.push([ut,It,fn,xn])}if(0===Lr.length)return;const Qr=Ye.e.now(),fn=wt.previousDrawTimestamp?.001*(Qr-wt.previousDrawTimestamp):.0167;if(wt.previousDrawTimestamp=Qr,wt.hasColorMap()){St.activeTexture.set(It.TEXTURE0+2);let ut=wt.colorRampTexture;ut||(ut=wt.colorRampTexture=new Ye.T(St,wt.colorRamp,It.RGBA)),ut.bind(It.LINEAR,It.CLAMP_TO_EDGE)}St.bindFramebuffer.set(wt.tileFramebuffer.framebuffer),function(ut,pt,wt){const Tt=ut.context,St=Tt.gl,It=pt.tileFramebuffer;Tt.activeTexture.set(St.TEXTURE0);const Lt={u_texture:0,u_opacity:1.05*(Xt=pt.paint.get("raster-particle-fade-opacity-factor"))/(Xt+.05)},$t=ut.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Xt;for(const Xt of wt){const[,,wt,Sr]=Xt;It.colorAttachment.set(wt.targetColorTexture.texture),Tt.viewport.set([0,0,It.width,It.height]),Tt.clear({color:Ye.C.transparent}),Sr&&(wt.backgroundColorTexture.bind(St.NEAREST,St.CLAMP_TO_EDGE),$t.draw(ut,St.TRIANGLES,Ye.ae.disabled,Ye.ag.disabled,Ye.a.alphaBlended,Ye.af.disabled,Lt,pt.id,ut.viewportBuffer,ut.quadTriangleIndexBuffer,ut.viewportSegments))}}(ut,wt,Lr),function(ut,pt,wt,Tt){const St=ut.context,It=St.gl,Lt=wt.tileFramebuffer,$t="globe"===ut.transform.projection.name,Xt=wt.paint.get("raster-particle-max-speed");for(const Sr of Tt){const[Tt,Lr,Qr]=Sr;St.activeTexture.set(It.TEXTURE0+0),Lr.texture.bind(It.LINEAR,It.CLAMP_TO_EDGE),Lt.colorAttachment.set(Qr.targetColorTexture.texture);const fn=ut.getOrCreateProgram("rasterParticleDraw",{defines:Lr.defines,overrideFog:!1});St.activeTexture.set(It.TEXTURE0+1);const xn=Lr.scalarData?[]:[0,1,2,3].map((ut=>Ye.bZ[ut](Tt)));xn.push(Tt);const vn=Tt.canonical.x,kn=Tt.canonical.y;for(const St of xn){const Lt=pt.getTile($t?St.wrapped():St);if(!Lt)continue;const Sr=Lt.rasterParticleState;if(!Sr)continue;const Qr=St.canonical.x+(1<<St.canonical.z)*(St.wrap-Tt.wrap),xn=St.canonical.y;Sr.particleTexture0.bind(It.NEAREST,It.CLAMP_TO_EDGE);const Wn=so(1,Sr.particleTexture0.size[0],[Qr-vn,xn-kn],0,Lr.texture.size,2,Xt,Lr.textureOffset,Lr.scale,Lr.offset);fn.draw(ut,It.POINTS,Ye.ae.disabled,Ye.ag.disabled,Ye.a.alphaBlended,Ye.af.disabled,Wn,wt.id,Sr.particleIndexBuffer,void 0,Sr.particleSegment)}}}(ut,pt,wt,Lr),St.bindFramebuffer.set(wt.particleFramebuffer.framebuffer),function(ut,pt,wt,Tt){const St=ut.context,It=St.gl,Lt=pt.paint.get("raster-particle-max-speed"),$t=Tt*pt.paint.get("raster-particle-speed-factor")*.15,Xt=function(Ye){return Math.pow(Ye,6)}(.01+1*pt.paint.get("raster-particle-reset-rate-factor")),Sr=pt.particleFramebuffer;St.viewport.set([0,0,Sr.width,Sr.height]);for(const Tt of wt){const[,wt,Lr]=Tt;St.activeTexture.set(It.TEXTURE0+0),wt.texture.bind(It.LINEAR,It.CLAMP_TO_EDGE),St.activeTexture.set(It.TEXTURE0+1);const Qr=Lr.particleTexture0;Qr.bind(It.NEAREST,It.CLAMP_TO_EDGE);const fn=lo(1,Qr.size[0],0,wt.texture.size,Lt,$t,Xt,wt.textureOffset,wt.scale,wt.offset);Sr.colorAttachment.set(Lr.particleTexture1.texture),St.clear({color:Ye.C.transparent}),ut.getOrCreateProgram("rasterParticleUpdate",{defines:wt.defines}).draw(ut,It.TRIANGLES,Ye.ae.disabled,Ye.ag.disabled,Ye.a.unblended,Ye.af.disabled,fn,pt.id,ut.viewportBuffer,ut.quadTriangleIndexBuffer,ut.viewportSegments)}}(ut,wt,Lr,fn)}(ut,pt,wt,Tt),"translucent"===ut.renderPass&&(function(ut,pt,wt,Tt,St){const It=ut.context,Lt=It.gl,$t=!ut.options.moving,Xt="globe"===ut.transform.projection.name;if(!Tt.length)return;const[Sr,Lr]=ut.stencilConfigForOverlap(Tt),Qr=[];Xt&&Qr.push("PROJECTION_GLOBE_VIEW");const fn=ut.stencilModeFor3D();for(const Tt of Lr){const St=Tt.toUnwrapped(),Lr=pt.getTile(Tt);if(!Lr.rasterParticleState)continue;const xn=Lr.rasterParticleState,vn=100;Lr.registerFadeDuration(vn);const kn=pt.findLoadedParent(Tt,0),Wn=Ai(Lr,kn,pt,ut.transform,vn);let Xn,Jn;ut.terrain&&ut.terrain.prepareDrawTile(),It.activeTexture.set(Lt.TEXTURE0),xn.targetColorTexture.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE),It.activeTexture.set(Lt.TEXTURE1),kn&&kn.rasterParticleState?(kn.rasterParticleState.targetColorTexture.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE),Xn=Math.pow(2,kn.tileID.overscaledZ-Lr.tileID.overscaledZ),Jn=[Lr.tileID.canonical.x*Xn%1,Lr.tileID.canonical.y*Xn%1]):xn.targetColorTexture.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE);const Qn=Xt?Float32Array.from(ut.transform.expandedFarZProjMatrix):ut.transform.calculateProjMatrix(St,$t),ko=ut.transform,Fo=Zo(ko),is=Ye.bc(Tt.canonical),ns=Ye.bd(is.getCenter().lat);let ss,as,ds,ps,ms;Xt?(ss=Float32Array.from(Ye.bf(Ye.bg(Tt.canonical))),as=Float32Array.from(ko.globeMatrix),ds=Float32Array.from(Ye.bb(ko)),ps=[Ye.aj(ko.center.lng),Ye.ak(ko.center.lat)],ms=Float32Array.from(Ye.be(Tt.canonical,is,ns,ko.worldSize/ko._pixelsPerMercatorPixel))):(ss=new Float32Array(16),as=new Float32Array(9),ds=new Float32Array(16),ps=[0,0],ms=new Float32Array(9));const Js=no(Qn,ss,as,ds,ms,Jn||[0,0],Ye.a1(ut.transform.zoom),ps,Fo,Xn||1,Wn,250),ua=ut.isTileAffectedByFog(Tt),ba=ut.getOrCreateProgram("rasterParticle",{defines:Qr,overrideFog:ua});if(ut.uploadCommonUniforms(It,ba,St),Xt){const pt=new Ye.ae(Lt.LEQUAL,Ye.ae.ReadWrite,ut.depthRangeFor3D),Tt=0,St=ut.globeSharedBuffers;if(St){const[It,$t,Xt]=St.getGridBuffers(ns,0!==Tt);ba.draw(ut,Lt.TRIANGLES,pt,fn,Ye.a.alphaBlended,Ye.af.backCCW,Js,wt.id,It,$t,Xt)}}else{const pt=ut.depthModeForSublayer(0,Ye.ae.ReadOnly),St=Sr[Tt.overscaledZ],{tileBoundsBuffer:It,tileBoundsIndexBuffer:$t,tileBoundsSegments:Xt}=ut.getTileBoundsBuffers(Lr);ba.draw(ut,Lt.TRIANGLES,pt,St,Ye.a.alphaBlended,Ye.af.disabled,Js,wt.id,It,$t,Xt)}}ut.resetStencilClippingMasks()}(ut,pt,wt,Tt),ut.style.map.triggerRepaint())},background:function(ut,pt,wt,Tt){const St=wt.paint.get("background-color"),It=wt.paint.get("background-opacity"),Lt=wt.paint.get("background-emissive-strength");if(0===It)return;const $t=ut.context,Xt=$t.gl,Sr=ut.transform,Lr=Sr.tileSize,Qr=wt.paint.get("background-pattern");let fn;if(void 0!==Qr){if(null===Qr)return;if(fn=ut.imageManager.getPattern(Qr.toString(),wt.scope,ut.style.getLut(wt.scope)),!fn)return}const xn=!Qr&&1===St.a&&1===It&&ut.opaquePassEnabledForLayer()?"opaque":"translucent";if(ut.renderPass!==xn)return;const vn=Ye.ag.disabled,kn=ut.depthModeForSublayer(0,"opaque"===xn?Ye.ae.ReadWrite:Ye.ae.ReadOnly),Wn=ut.colorModeForDrapableLayerRenderPass(Lt),Xn=Qr?"backgroundPattern":"background";let Jn,Qn=Tt;Qn||(Jn=ut.getBackgroundTiles(),Qn=Object.values(Jn).map((Ye=>Ye.tileID))),Qr&&($t.activeTexture.set(Xt.TEXTURE0),ut.imageManager.bind(ut.context,wt.scope));for(const xn of Qn){const Qn=ut.isTileAffectedByFog(xn),ko=ut.getOrCreateProgram(Xn,{overrideFog:Qn}),Fo=xn.toUnwrapped(),is=Tt?xn.projMatrix:ut.transform.calculateProjMatrix(Fo);ut.prepareDrawTile();const ns=pt?pt.getTile(xn):Jn?Jn[xn.key]:new Ye.by(xn,Lr,Sr.zoom,ut),ss=Qr?fo(is,Lt,It,ut,0,wt.scope,fn,{tileID:xn,tileSize:Lr}):po(is,Lt,It,St.toRenderColor(wt.lut));ut.uploadCommonUniforms($t,ko,Fo);const{tileBoundsBuffer:as,tileBoundsIndexBuffer:ds,tileBoundsSegments:ps}=ut.getTileBoundsBuffers(ns);ko.draw(ut,Xt.TRIANGLES,kn,vn,Wn,Ye.af.disabled,ss,wt.id,as,ds,ps)}},sky:function(ut,pt,wt){const Tt=ut._atmosphere?Ye.a1(ut.transform.zoom):1,St=wt.paint.get("sky-opacity")*Tt;if(0===St)return;const It=ut.context,Lt=wt.paint.get("sky-type"),$t=new Ye.ae(It.gl.LEQUAL,Ye.ae.ReadOnly,[0,1]),Xt=ut.frameCounter/1e3%1;"atmosphere"===Lt?"offscreen"===ut.renderPass?wt.needsSkyboxCapture(ut)&&(function(ut,pt,wt,Tt){const St=ut.context,It=St.gl;let Lt=pt.skyboxFbo;if(!Lt){Lt=pt.skyboxFbo=St.createFramebuffer(32,32,!0,null),pt.skyboxGeometry=new rr(St),pt.skyboxTexture=St.gl.createTexture(),It.bindTexture(It.TEXTURE_CUBE_MAP,pt.skyboxTexture),It.texParameteri(It.TEXTURE_CUBE_MAP,It.TEXTURE_WRAP_S,It.CLAMP_TO_EDGE),It.texParameteri(It.TEXTURE_CUBE_MAP,It.TEXTURE_WRAP_T,It.CLAMP_TO_EDGE),It.texParameteri(It.TEXTURE_CUBE_MAP,It.TEXTURE_MIN_FILTER,It.LINEAR),It.texParameteri(It.TEXTURE_CUBE_MAP,It.TEXTURE_MAG_FILTER,It.LINEAR);for(let Ye=0;Ye<6;++Ye)It.texImage2D(It.TEXTURE_CUBE_MAP_POSITIVE_X+Ye,0,It.RGBA,32,32,0,It.RGBA,It.UNSIGNED_BYTE,null)}St.bindFramebuffer.set(Lt.framebuffer),St.viewport.set([0,0,32,32]);const $t=pt.getCenter(ut,!0),Xt=ut.getOrCreateProgram("skyboxCapture"),Sr=new Float64Array(16);Ye.ad.identity(Sr),Ye.ad.rotateY(Sr,Sr,.5*-Math.PI),ar(ut,pt,Xt,Sr,$t,0),Ye.ad.identity(Sr),Ye.ad.rotateY(Sr,Sr,.5*Math.PI),ar(ut,pt,Xt,Sr,$t,1),Ye.ad.identity(Sr),Ye.ad.rotateX(Sr,Sr,.5*-Math.PI),ar(ut,pt,Xt,Sr,$t,2),Ye.ad.identity(Sr),Ye.ad.rotateX(Sr,Sr,.5*Math.PI),ar(ut,pt,Xt,Sr,$t,3),Ye.ad.identity(Sr),ar(ut,pt,Xt,Sr,$t,4),Ye.ad.identity(Sr),Ye.ad.rotateY(Sr,Sr,Math.PI),ar(ut,pt,Xt,Sr,$t,5),St.viewport.set([0,0,ut.width,ut.height])}(ut,wt),wt.markSkyboxValid(ut)):"sky"===ut.renderPass&&function(ut,pt,wt,Tt,St){const It=ut.context,Lt=It.gl,$t=ut.transform,Xt=ut.getOrCreateProgram("skybox");It.activeTexture.set(Lt.TEXTURE0),Lt.bindTexture(Lt.TEXTURE_CUBE_MAP,pt.skyboxTexture);const Sr=((Ye,ut,pt,wt,Tt)=>({u_matrix:Ye,u_sun_direction:ut,u_cubemap:0,u_opacity:wt,u_temporal_offset:Tt}))($t.skyboxMatrix,pt.getCenter(ut,!1),0,Tt,St);ut.uploadCommonUniforms(It,Xt),Xt.draw(ut,Lt.TRIANGLES,wt,Ye.ag.disabled,ut.colorModeForRenderPass(),Ye.af.backCW,Sr,"skybox",pt.skyboxGeometry.vertexBuffer,pt.skyboxGeometry.indexBuffer,pt.skyboxGeometry.segment)}(ut,wt,$t,St,Xt):"gradient"===Lt&&"sky"===ut.renderPass&&function(ut,pt,wt,Tt,St){const It=ut.context,Lt=It.gl,$t=ut.transform,Xt=ut.getOrCreateProgram("skyboxGradient");pt.skyboxGeometry||(pt.skyboxGeometry=new rr(It)),It.activeTexture.set(Lt.TEXTURE0);let Sr=pt.colorRampTexture;Sr||(Sr=pt.colorRampTexture=new Ye.T(It,pt.colorRamp,Lt.RGBA)),Sr.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE);const Lr=((ut,pt,wt,Tt,St)=>({u_matrix:ut,u_color_ramp:0,u_center_direction:pt,u_radius:Ye.ab(wt),u_opacity:Tt,u_temporal_offset:St}))($t.skyboxMatrix,pt.getCenter(ut,!1),pt.paint.get("sky-gradient-radius"),Tt,St);ut.uploadCommonUniforms(It,Xt),Xt.draw(ut,Lt.TRIANGLES,wt,Ye.ag.disabled,ut.colorModeForRenderPass(),Ye.af.backCW,Lr,"skyboxGradient",pt.skyboxGeometry.vertexBuffer,pt.skyboxGeometry.indexBuffer,pt.skyboxGeometry.segment)}(ut,wt,$t,St,Xt)},debug:function(ut,pt,wt,Tt,St,It){for(let Lt=0;Lt<wt.length;Lt++)if(St){const St=1,$t=.8,Xt=new Ye.C(Tt.r*$t,Tt.g*$t,Tt.b*$t,1);Ko(ut,pt,wt[Lt],Tt,-St,-St,It),Ko(ut,pt,wt[Lt],Tt,-St,St,It),Ko(ut,pt,wt[Lt],Tt,St,St,It),Ko(ut,pt,wt[Lt],Tt,St,-St,It),Ko(ut,pt,wt[Lt],Xt,0,0,It)}else Ko(ut,pt,wt[Lt],Tt,0,0,It)},custom:function(ut,pt,wt,Tt){const St=ut.context,It=wt.implementation;if(!ut.transform.projection.unsupportedLayers||!ut.transform.projection.unsupportedLayers.includes("custom")||ut.terrain&&(ut.terrain.renderingToTexture||"offscreen"===ut.renderPass)&&wt.isDraped(pt)){if("offscreen"===ut.renderPass){const pt=It.prerender;if(pt){if(ut.setCustomLayerDefaults(),St.setColorMode(ut.colorModeForRenderPass()),"globe"===ut.transform.projection.name){const wt=ut.transform.pointMerc;pt.call(It,St.gl,ut.transform.customLayerMatrix(),ut.transform.getProjection(),ut.transform.globeToMercatorMatrix(),Ye.a1(ut.transform.zoom),[wt.x,wt.y],ut.transform.pixelsPerMeterRatio)}else pt.call(It,St.gl,ut.transform.customLayerMatrix());St.setDirty(),ut.setBaseState()}}else if("translucent"===ut.renderPass){if(ut.terrain&&ut.terrain.renderingToTexture){const pt=It.renderToTile;if(pt){const wt=Tt[0].canonical,Lt=new Ye.Y(wt.x+Tt[0].wrap*(1<<wt.z),wt.y,wt.z);St.setDepthMode(Ye.ae.disabled),St.setStencilMode(Ye.ag.disabled),St.setColorMode(ut.colorModeForRenderPass()),ut.setCustomLayerDefaults(),pt.call(It,St.gl,Lt),St.setDirty(),ut.setBaseState()}return}ut.setCustomLayerDefaults(),St.setColorMode(ut.colorModeForRenderPass()),St.setStencilMode(Ye.ag.disabled);const pt="3d"===It.renderingMode?new Ye.ae(ut.context.gl.LEQUAL,Ye.ae.ReadWrite,ut.depthRangeFor3D):ut.depthModeForSublayer(0,Ye.ae.ReadOnly);if(St.setDepthMode(pt),"globe"===ut.transform.projection.name){const pt=ut.transform.pointMerc;It.render(St.gl,ut.transform.customLayerMatrix(),ut.transform.getProjection(),ut.transform.globeToMercatorMatrix(),Ye.a1(ut.transform.zoom),[pt.x,pt.y],ut.transform.pixelsPerMeterRatio)}else It.render(St.gl,ut.transform.customLayerMatrix());St.setDirty(),ut.setBaseState(),St.bindFramebuffer.set(null)}}else Ye.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(ut,pt,wt,Tt){if("opaque"===ut.renderPass)return;const St=wt.paint.get("model-opacity");if(0===St)return;const It=wt.paint.get("model-cast-shadows");if("shadow"===ut.renderPass){if(!It)return;if(ut.terrain&&St<.65&&wt._transitionablePaint._values["model-opacity"].value.expression instanceof Ye.Z)return}const Lt=ut.shadowRenderer,$t=wt.paint.get("model-receive-shadows");Lt&&(Lt.useNormalOffset=!0,$t||(Lt.enabled=!1));const c=()=>{Lt&&(Lt.useNormalOffset=!0,$t||(Lt.enabled=!0))},Xt=pt.getSource();if("light-beam"===ut.renderPass&&"batched-model"!==Xt.type)return;if("vector"===Xt.type||"geojson"===Xt.type)return function(ut,pt,wt,Tt,St){const It=ut.transform;if("mercator"!==It.projection.name)return void Ye.w(`Drawing 3D models for ${It.projection.name} projection is not yet implemented`);const Lt=It.getFreeCameraOptions().position;if(!ut.modelManager)return;const $t=ut.modelManager;wt.modelManager=$t;const Xt=ut.shadowRenderer;if(!wt._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const Sr=wt._unevaluatedLayout._values["model-id"],Lr={...wt.layout.get("model-id").parameters},Qr=ut.style.order.indexOf(wt.fqid);for(const fn of Tt){const Tt=pt.getTile(fn).getBucket(wt);if(!Tt||Tt.projection.name!==It.projection.name)continue;const xn=Tt.getModelUris();xn&&!Tt.modelsRequested&&($t.addModelsFromBucket(xn,St),Tt.modelsRequested=!0);const vn=vr(fn,It);Lr.zoom=vn;const kn=Sr.possiblyEvaluate(Lr);if(mr(ut,Tt,fn),Ih.shadowUniformsInitialized=!1,Ih.useSingleShadowCascade=!!Xt&&0===Xt.getMaxCascadeForTile(fn.toUnwrapped()),"shadow"===ut.renderPass&&Xt){if(1===ut.currentShadowCascade&&Tt.isInsideFirstShadowMapFrustum)continue;const pt=It.calculatePosMatrix(fn.toUnwrapped(),It.worldSize);if(Ih.tileMatrix.set(pt),Ih.shadowTileMatrix=Float32Array.from(Xt.calculateShadowPassMatrixFromMatrix(pt)),Ih.aabb.min.fill(0),Ih.aabb.max[0]=Ih.aabb.max[1]=Ye.a3,Ih.aabb.max[2]=0,br(Tt,Ih,ut,wt.scope))continue}const Wn=1<<fn.canonical.z,Xn=[((Lt.x-fn.wrap)*Wn-fn.canonical.x)*Ye.a3,(Lt.y*Wn-fn.canonical.y)*Ye.a3,Lt.z*Wn*Ye.a3];ut.conflationActive&&Object.keys(Tt.instancesPerModel).length>0&&ut.style.isLayerClipped(wt,pt.getSource())&&Tt.updateReplacement(fn,ut.replacementSource,Qr)&&(Tt.uploaded=!1,Tt.upload(ut.context));for(let Ye in Tt.instancesPerModel){const pt=Tt.instancesPerModel[Ye];pt.features.length>0&&(Ye=kn.evaluate(pt.features[0].feature,{}));const It=$t.getModel(Ye,St);if(It&&It.uploaded)for(const Ye of It.nodes)xr(ut,wt,Ye,pt,Xn,fn,Ih)}}}(ut,pt,wt,Tt,"vector"===Xt.type?wt.scope:""),void c();if(!Xt.loaded())return;if("batched-model"===Xt.type)return function(ut,pt,wt,Tt){wt.resetLayerRenderingStats(ut);const St=ut.context,It=ut.transform,Lt=ut.style.fog,$t=ut.shadowRenderer;if("mercator"!==It.projection.name)return void Ye.w(`Drawing 3D landmark models for ${It.projection.name} projection is not yet implemented`);const Xt=ut.transform.getFreeCameraOptions().position,Sr=Ye._.scale([],[Xt.x,Xt.y,Xt.z],ut.transform.worldSize);Ye._.negate(Sr,Sr);const Lr=Ye.ad.identity([]),Qr=Ye.cg(It.center.lat,It.zoom),fn=Ye.ad.fromScaling([],[1,1,1/Qr]);Ye.ad.translate(Lr,Lr,Sr);const xn=wt.paint.get("model-opacity"),kn=new Ye.ae(St.gl.LEQUAL,Ye.ae.ReadWrite,ut.depthRangeFor3D),Wn=new Ye.ae(St.gl.LEQUAL,Ye.ae.ReadOnly,ut.depthRangeFor3D),Xn=new Ye.b6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Jn="shadow"===ut.renderPass,Qn=Jn&&$t?$t.getCurrentCascadeFrustum():It.getFrustum(It.scaleZoom(It.worldSize)),ko=wt.paint.get("model-front-cutoff"),Fo=ko[2]<1,is=fi(ut,wt.paint.get("model-cutoff-fade-range")),ns=wt.getLayerRenderingStats();(function(Ye,ut,pt,wt){const Tt=Ye.terrain?Ye.terrain.exaggeration():0,St=Ye.transform.zoom;for(const It of wt){const wt=ut.getTile(It).getBucket(pt);wt&&(Ye.conflationActive&&wt.updateReplacement(It,Ye.replacementSource),wt.evaluateScale(Ye,pt),Ye.terrain&&Tt>0&&wt.elevationUpdate(Ye.terrain,Tt,It,pt.source),wt.needsReEvaluation(Ye,St,pt)&&wt.evaluate(pt))}})(ut,pt,wt,Tt),function(){let Xt,Sr,Qr;Fo?(Xt=Tt.length-1,Sr=-1,Qr=-1):(Xt=0,Sr=Tt.length,Qr=1);for(let ss=Xt;ss!==Sr;ss+=Qr){const Xt=Tt[ss],Sr=pt.getTile(Xt).getBucket(wt);if(!Sr||!Sr.uploaded)continue;let Qr=!1;$t&&(Qr=0===$t.getMaxCascadeForTile(Xt.toUnwrapped()));const as=It.calculatePosMatrix(Xt.toUnwrapped(),It.worldSize),ds=Sr.modelTraits,ps=[];for(const pt of Sr.getNodesInfo()){if(pt.hiddenByReplacement)continue;if(!pt.node.meshes)continue;const wt=pt.node;let Tt=0;ut.terrain&&wt.elevation&&(Tt=wt.elevation*ut.terrain.exaggeration());const St=pt.evaluatedScale;if(St[0]<=1&&St[1]<=1&&St[2]<=1&&0===(()=>{const ut=pt.aabb;return Xn.min=[...ut.min],Xn.max=[...ut.max],Xn.min[2]+=Tt,Xn.max[2]+=Tt,Ye._.transformMat4(Xn.min,Xn.min,as),Ye._.transformMat4(Xn.max,Xn.max,as),Xn})().intersects(Qn))continue;const Lt=[...as],$t=wt.anchor?wt.anchor[0]:0,Xt=wt.anchor?wt.anchor[1]:0;Ye.ad.translate(Lt,Lt,[$t*(St[0]-1),Xt*(St[1]-1),Tt]),Ye._.exactEquals(St,Ye.cj)||Ye.ad.scale(Lt,Lt,St);const Sr=Ye.ad.multiply([],Lt,wt.matrix),Lr=Ye.ad.multiply([],It.expandedFarZProjMatrix,Sr),Qr=Ye.ad.multiply([],It.expandedFarZProjMatrix,Lt),fn=Ye.aA.transformMat4([],[$t,Xt,Tt,1],Lr)[2];wt.hidden=!1;let vn=xn;Jn||(Fo&&(vn*=Tr(Lt,It,pt.aabb,ko)),vn*=wr(is,fn)),0!==vn?ps.push({nodeInfo:pt,depth:fn,opacity:vn,wvpForNode:Lr,wvpForTile:Qr,nodeModelMatrix:Sr,tileModelMatrix:Lt}):wt.hidden=!0}Jn||ps.sort(((Ye,ut)=>!Fo||1===Ye.opacity&&1===ut.opacity?Ye.depth<ut.depth?-1:1:1===Ye.opacity?-1:1===ut.opacity?1:Ye.depth>ut.depth?-1:1));for(const pt of ps){const Tt=pt.nodeInfo,Xt=Tt.node;let Sr=Ye.ad.multiply([],fn,pt.tileModelMatrix);Ye.ad.multiply(Sr,Lr,Sr);const xn=Ye.ad.invert([],Sr);Ye.ad.transpose(xn,xn),Ye.ad.scale(xn,xn,zh),Sr=Ye.ad.multiply(Sr,Sr,Xt.matrix);const Xn="light-beam"===ut.renderPass,Qn=ds&Ye.cl.HasMapboxMeshFeatures,ko=Qn?0:Tt.evaluatedRMEA[0][2];for(let Lr=0;Lr<Xt.meshes.length;++Lr){const fn=Xt.meshes[Lr],Fo=Lr===Xt.lightMeshIndex;let is=pt.wvpForNode;if(Fo){if(!Xn&&!ut.terrain&&ut.shadowRenderer){ut.currentLayer<ut.firstLightBeamLayer&&(ut.firstLightBeamLayer=ut.currentLayer);continue}is=pt.wvpForTile}else if(Xn)continue;const ss={defines:[]},as=[];if(ur(ss.defines,as,fn,ut,wt.lut),Qn||ss.defines.push("DIFFUSE_SHADED"),Qr&&ss.defines.push("SHADOWS_SINGLE_CASCADE"),ns&&(Jn?ns.numRenderedVerticesInShadowPass+=fn.vertexArray.length:ns.numRenderedVerticesInTransparentPass+=fn.vertexArray.length),Jn){fr(fn,pt.nodeModelMatrix,ut,wt);continue}let ds=null;if(Lt){const Ye=_r(pt.nodeModelMatrix,ut.transform);if(ds=new Float32Array(Ye),"globe"!==It.projection.name){const ut=fn.aabb.min,pt=fn.aabb.max,[wt,Tt]=Lt.getOpacityForBounds(Ye,ut[0],ut[1],pt[0],pt[1]);ss.overrideFog=wt>=vn||Tt>=vn}}const ps=fn.material;let ms;ps.occlusionTexture&&ps.occlusionTexture.offsetScale&&(ms=ps.occlusionTexture.offsetScale,ss.defines.push("OCCLUSION_TEXTURE_TRANSFORM")),!Jn&&$t&&($t.useNormalOffset=!!fn.normalBuffer);const Js=ut.getOrCreateProgram("model",ss);!Jn&&$t&&$t.setupShadowsFromMatrix(pt.tileModelMatrix,Js,$t.useNormalOffset),ut.uploadCommonUniforms(St,Js,null,ds);const ua=ps.pbrMetallicRoughness;ua.metallicFactor=.9,ua.roughnessFactor=.5;const ba=go(new Float32Array(is),new Float32Array(Sr),new Float32Array(xn),new Float32Array(Xt.matrix),ut,pt.opacity,ua.baseColorFactor.toRenderColor(null),ps.emissiveFactor,ua.metallicFactor,ua.roughnessFactor,ps,ko,wt,[0,0,0],ms);!Fo&&(Tt.hasTranslucentParts||pt.opacity<1)&&Js.draw(ut,St.gl.TRIANGLES,kn,Ye.ag.disabled,Ye.a.disabled,Ye.af.backCCW,ba,wt.id,fn.vertexBuffer,fn.indexBuffer,fn.segments,wt.paint,ut.transform.zoom,void 0,as),Js.draw(ut,St.gl.TRIANGLES,Fo?Wn:kn,Ye.ag.disabled,Fo||pt.opacity<1||Tt.hasTranslucentParts?Ye.a.alphaBlended:Ye.a.unblended,Ye.af.backCCW,ba,wt.id,fn.vertexBuffer,fn.indexBuffer,fn.segments,wt.paint,ut.transform.zoom,void 0,as)}}}}()}(ut,pt,wt,Tt),void c();if("model"!==Xt.type)return;const Sr=Xt.getModels(),Lr=[],Qr=ut.transform.getFreeCameraOptions().position,fn=Ye._.scale([],[Qr.x,Qr.y,Qr.z],ut.transform.worldSize);Ye._.negate(fn,fn);const xn=[],kn=[];let Wn=0;for(const pt of Sr){const Tt=wt.paint.get("model-rotation").constantOr(null),St=wt.paint.get("model-scale").constantOr(null),It=wt.paint.get("model-translation").constantOr(null);pt.computeModelMatrix(ut,Tt,St,It,!0,!0,!1);const Lt=Ye.ad.identity([]),$t=Ye.cg(pt.position.lat,ut.transform.zoom),Xt=Ye.ad.fromScaling([],[1,1,1/$t]);Ye.ad.translate(Lt,Lt,fn),Lr.push({zScaleMatrix:Xt,negCameraPosMatrix:Lt});for(const Ye of pt.nodes)pr(ut.transform,Ye,pt.matrix,ut.transform.expandedFarZProjMatrix,Wn,xn,kn);Wn++}if(xn.sort(((Ye,ut)=>ut.depth-Ye.depth)),"shadow"!==ut.renderPass){if(1===St)for(const pt of kn)dr(pt,ut,wt,Lr[pt.modelIndex],Ye.ag.disabled,ut.colorModeForRenderPass());else{for(const pt of kn)dr(pt,ut,wt,Lr[pt.modelIndex],Ye.ag.disabled,Ye.a.disabled);for(const Ye of kn)dr(Ye,ut,wt,Lr[Ye.modelIndex],ut.stencilModeFor3D(),ut.colorModeForRenderPass());ut.resetStencilClippingMasks()}for(const pt of xn)dr(pt,ut,wt,Lr[pt.modelIndex],Ye.ag.disabled,ut.colorModeForRenderPass());c()}else{for(const Ye of kn)fr(Ye.mesh,Ye.nodeModelMatrix,ut,wt);for(const Ye of xn)fr(Ye.mesh,Ye.nodeModelMatrix,ut,wt);c()}}},Jh={model:function(Ye,ut,pt){const wt=ut.getSource();if(!wt.loaded())return;if("vector"===wt.type||"geojson"===wt.type)return void(pt.modelManager&&pt.modelManager.upload(pt,"vector"===wt.type?Ye.scope:""));if("batched-model"===wt.type)return;if("model"!==wt.type)return;const Tt=wt.getModels();for(const Ye of Tt)Ye.upload(pt.context)},raster:function(Ye,ut,pt){const wt=ut.getSource();if(!(wt instanceof Ri&&wt.loaded()))return;const Tt=Ye.sourceLayer||wt.rasterLayerIds&&wt.rasterLayerIds[0];if(!Tt)return;const St=Ye.paint.get("raster-array-band")||wt.getInitialBand(Tt);if(null==St)return;const It=ut.getIds().map((Ye=>ut.getTileByID(Ye)));for(const Ye of It)Ye.updateNeeded(Tt,St)&&wt.prepareTile(Ye,Tt,St)},"raster-particle":function(Ye,ut,pt){const wt=ut.getSource();if(!(wt instanceof Ri&&wt.loaded()))return;const Tt=Ye.sourceLayer||wt.rasterLayerIds&&wt.rasterLayerIds[0];if(!Tt)return;const St=Ye.paint.get("raster-particle-array-band")||wt.getInitialBand(Tt);if(null==St)return;const It=ut.getIds().map((Ye=>ut.getTileByID(Ye)));for(const Ye of It)Ye.updateNeeded(Tt,St)&&wt.prepareTile(Ye,Tt,St)}};class Ar{constructor(ut,pt,wt,Tt){this.context=new ae(ut,pt),this.occlusionBuffers=new Ir(this.context),this.transform=wt,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=Tt,this._timeStamp=Ye.e.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const St=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const Ye of St)this._debugParams.enabledLayers[Ye]=!0;Tt.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),Tt.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),Tt.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),Tt.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),Tt.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const Ye of St)Tt.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],Ye);this.symbolParams=new se(Tt),this.setup(),this.numSublayers=Ye.bv.maxUnderzooming+Ye.bv.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new Ye.co,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new xi(this),this._wireframeDebugCache=new Cr,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[]}updateTerrain(Ye,ut){const pt=!!Ye&&!!Ye.terrain&&this.transform.projection.supportsTerrain;if(!(pt||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Bi(this,Ye));const wt=this._terrain;this.transform.elevation=pt?wt:null,wt.update(Ye,this.transform,ut),this.transform.elevation&&!wt.enabled&&(this.transform.elevation=null)}_updateFog(Ye){const ut=Ye.fog;if(!ut||"globe"===this.transform.projection.name||ut.getOpacity(this.transform.pitch)<1||ut.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[pt,wt]=ut.getFovAdjustedRange(this.transform._fov);if(pt>wt)return void(this.transform.fogCullDistSq=null);const Tt=pt+.78*(wt-pt);this.transform.fogCullDistSq=Tt*Tt}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(Ye){Ye&&!this._terrain&&(this._terrain=new Bi(this,this.style)),this._forceTerrainMode=Ye}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(ut,pt){if(this.width=ut*Ye.e.devicePixelRatio,this.height=pt*Ye.e.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const Ye of this.style.order)this.style._mergedLayers[Ye].resize()}setup(){const ut=this.context,pt=new Ye.bt;pt.emplaceBack(0,0),pt.emplaceBack(Ye.a3,0),pt.emplaceBack(0,Ye.a3),pt.emplaceBack(Ye.a3,Ye.a3),this.tileExtentBuffer=ut.createVertexBuffer(pt,Ye.br.members),this.tileExtentSegments=Ye.b.simpleSegment(0,0,4,2);const wt=new Ye.bt;wt.emplaceBack(0,0),wt.emplaceBack(Ye.a3,0),wt.emplaceBack(0,Ye.a3),wt.emplaceBack(Ye.a3,Ye.a3),this.debugBuffer=ut.createVertexBuffer(wt,Ye.br.members),this.debugSegments=Ye.b.simpleSegment(0,0,4,5);const Tt=new Ye.bt;Tt.emplaceBack(-1,-1),Tt.emplaceBack(1,-1),Tt.emplaceBack(-1,1),Tt.emplaceBack(1,1),this.viewportBuffer=ut.createVertexBuffer(Tt,Ye.br.members),this.viewportSegments=Ye.b.simpleSegment(0,0,4,2);const St=new Ye.cp;St.emplaceBack(0,0,0,0),St.emplaceBack(Ye.a3,0,Ye.a3,0),St.emplaceBack(0,Ye.a3,0,Ye.a3),St.emplaceBack(Ye.a3,Ye.a3,Ye.a3,Ye.a3),this.mercatorBoundsBuffer=ut.createVertexBuffer(St,Ye.cq.members),this.mercatorBoundsSegments=Ye.b.simpleSegment(0,0,4,2);const It=new Ye.bu;It.emplaceBack(0,1,2),It.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=ut.createIndexBuffer(It);const Lt=new Ye.cr;for(const Ye of[0,1,3,2,0])Lt.emplaceBack(Ye);this.debugIndexBuffer=ut.createIndexBuffer(Lt),this.emptyTexture=new Ye.T(ut,new Ye.i({width:1,height:1},Uint8Array.of(0,0,0,0)),ut.gl.RGBA),this.identityMat=Ye.ad.create();const $t=this.context.gl;this.stencilClearMode=new Ye.ag({func:$t.ALWAYS,mask:0},0,255,$t.ZERO,$t.ZERO,$t.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(Ye){return Ye._makeTileBoundsBuffers(this.context,this.transform.projection),Ye._tileBoundsBuffer?{tileBoundsBuffer:Ye._tileBoundsBuffer,tileBoundsIndexBuffer:Ye._tileBoundsIndexBuffer,tileBoundsSegments:Ye._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const ut=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,ut.TRIANGLES,Ye.ae.disabled,this.stencilClearMode,Ye.a.disabled,Ye.af.disabled,Pi(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(ut,pt,wt){if(!pt||this.currentStencilSource===pt.id||!ut.isTileClipped()||!wt||0===wt.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let Ye=!1;for(const ut of wt)if(void 0===this._tileClippingMaskIDs[ut.key]){Ye=!0;break}if(!Ye)return}this.currentStencilSource=pt.id;const Tt=this.context,St=Tt.gl;this.nextStencilID+wt.length>256&&this.clearStencil(),Tt.setColorMode(Ye.a.disabled),Tt.setDepthMode(Ye.ae.disabled);const It=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const ut of wt){const wt=pt.getTile(ut),Tt=this._tileClippingMaskIDs[ut.key]=this.nextStencilID++,{tileBoundsBuffer:Lt,tileBoundsIndexBuffer:$t,tileBoundsSegments:Xt}=this.getTileBoundsBuffers(wt);It.draw(this,St.TRIANGLES,Ye.ae.disabled,new Ye.ag({func:St.ALWAYS,mask:0},Tt,255,St.KEEP,St.KEEP,St.REPLACE),Ye.a.disabled,Ye.af.disabled,Pi(ut.projMatrix),"$clipping",Lt,$t,Xt)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const ut=this.nextStencilID++,pt=this.context.gl;return new Ye.ag({func:pt.NOTEQUAL,mask:255},ut,255,pt.KEEP,pt.KEEP,pt.REPLACE)}stencilModeForClipping(ut){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(ut);const pt=this.context.gl;return new Ye.ag({func:pt.EQUAL,mask:255},this._tileClippingMaskIDs[ut.key],0,pt.KEEP,pt.KEEP,pt.REPLACE)}stencilConfigForOverlap(ut){const pt=this.context.gl,wt=ut.sort(((Ye,ut)=>ut.overscaledZ-Ye.overscaledZ)),Tt=wt[wt.length-1].overscaledZ,St=wt[0].overscaledZ-Tt+1;if(St>1){this.currentStencilSource=void 0,this.nextStencilID+St>256&&this.clearStencil();const ut={};for(let wt=0;wt<St;wt++)ut[wt+Tt]=new Ye.ag({func:pt.GEQUAL,mask:255},wt+this.nextStencilID,255,pt.KEEP,pt.KEEP,pt.REPLACE);return this.nextStencilID+=St,[ut,wt]}return[{[Tt]:Ye.ag.disabled},wt]}colorModeForRenderPass(){const ut=this.context.gl;if(this._showOverdrawInspector){const pt=1/8;return new Ye.a([ut.CONSTANT_COLOR,ut.ONE,ut.CONSTANT_COLOR,ut.ONE],new Ye.C(pt,pt,pt,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?Ye.a.unblended:Ye.a.alphaBlended}colorModeForDrapableLayerRenderPass(ut){const pt=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new Ye.a([pt.ONE,pt.ONE_MINUS_SRC_ALPHA,pt.CONSTANT_ALPHA,pt.ONE_MINUS_SRC_ALPHA],new Ye.C(0,0,0,void 0===ut?0:ut),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(ut,pt,wt,Tt=!1){if(this.depthOcclusion)return new Ye.ae(this.context.gl.GREATER,Ye.ae.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!Tt)return Ye.ae.disabled;const St=1-((1+this.currentLayer)*this.numSublayers+ut)*this.depthEpsilon;return new Ye.ae(wt||this.context.gl.LEQUAL,pt,[St,St])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const ut=this.context.gl,pt=Math.ceil(this.width),wt=Math.ceil(this.height),Tt=this.context.bindFramebuffer.get(),St=ut.getParameter(ut.TEXTURE_BINDING_2D);this.terrainDepthFBO&&this.terrainDepthFBO.width===pt&&this.terrainDepthFBO.height===wt||(this.terrainDepthFBO&&(this.terrainDepthFBO.destroy(),this.terrainDepthFBO=void 0,this.terrainDepthTexture=void 0),0!==pt&&0!==wt&&(this.terrainDepthFBO=new re(this.context,pt,wt,!1,"texture"),this.terrainDepthTexture=new Ye.T(this.context,{width:pt,height:wt,data:null},ut.DEPTH_STENCIL),this.terrainDepthFBO.depthAttachment.set(this.terrainDepthTexture.texture))),this.context.bindFramebuffer.set(Tt),ut.bindTexture(ut.TEXTURE_2D,St),this.terrainDepthFBO&&(ut.bindFramebuffer(ut.READ_FRAMEBUFFER,null),ut.bindFramebuffer(ut.DRAW_FRAMEBUFFER,this.terrainDepthFBO.framebuffer),ut.blitFramebuffer(0,0,pt,wt,0,0,pt,wt,ut.DEPTH_BUFFER_BIT,ut.NEAREST),ut.bindFramebuffer(ut.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((Ye,ut)=>Ye+ut/this._fpsHistory.length),0))}render(ut,pt){const wt=Ye.e.now();this._dt=wt-this._timeStamp,this._timeStamp=wt,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=ut.map.repaint,this.style=ut,this.options=pt;const Tt=this.style._mergedLayers,St=this.style.order.filter((Ye=>{const ut=Tt[Ye];return!(ut.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[ut.type]})),It=St.map((Ye=>Tt[Ye])),Lt=this.style._mergedSourceCaches;this.imageManager=ut.imageManager,this.modelManager=ut.modelManager,this.symbolFadeChange=ut.placement.symbolFadeChange(Ye.e.now()),this.imageManager.beginFrame();let $t=0,Xt=!1;for(const Ye in Lt){const ut=Lt[Ye];ut.used&&(ut.prepare(this.context),ut.getSource().usedInConflation&&++$t)}let Sr=!1;for(const Ye of It)Ye.isHidden(this.transform.zoom)||("clip"===Ye.type&&(Sr=!0),this.prepareLayer(Ye));const Lr={},Qr={},fn={},xn={},vn={};for(const Ye in Lt){const ut=Lt[Ye];Lr[Ye]=ut.getVisibleCoordinates(),Qr[Ye]=Lr[Ye].slice().reverse(),fn[Ye]=ut.getVisibleCoordinates(!0).reverse(),xn[Ye]=ut.getShadowCasterCoordinates(),vn[Ye]=ut.sortCoordinatesByDistance(Lr[Ye])}const m=Ye=>{const ut=this.style.getLayerSourceCache(Ye);return ut&&ut.used?ut.getSource():null};if($t||Sr){const ut=[],pt=[];let wt=0;for(const Ye of It)this.isSourceForClippingOrConflation(Ye,m(Ye))&&(ut.push(Ye),pt.push(wt)),wt++;if(ut&&(Sr||ut.length>1)){const wt=[];for(let Tt=0;Tt<ut.length;Tt++){const St=ut[Tt],It=pt[Tt],Lt=this.style.getLayerSourceCache(St);if(!Lt||!Lt.used||!Lt.getSource().usedInConflation&&"clip"!==St.type)continue;let $t=1/0,Xt=Ye.cu.None;if("clip"===St.type){$t=It;for(const ut of St.layout.get("clip-layer-types"))Xt|="model"===ut?Ye.cu.Model:"symbol"===ut?Ye.cu.Symbol:Ye.cu.FillExtrusion}wt.push({layer:St.fqid,cache:Lt,order:$t,clipMask:Xt})}this.replacementSource.setSources(wt),Xt=!0}}Xt||this.replacementSource.clear(),this.conflationActive=Xt,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Ye=0;Ye<It.length;Ye++){const ut=It[Ye],pt=ut.cutoffRange();if(this.longestCutoffRange=Math.max(pt,this.longestCutoffRange),pt>0){const Ye=m(ut);Ye&&(this.minCutoffZoom=Math.max(Ye.minzoom,this.minCutoffZoom)),ut.minzoom&&(this.minCutoffZoom=Math.max(ut.minzoom,this.minCutoffZoom))}ut.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Ye),this._lastOcclusionLayer=Ye)}const kn=this.style&&this.style.fog;kn?(this._fogVisible=0!==kn.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=kn.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(fn),this.opaquePassCutoff=0);const Wn=this._shadowRenderer;if(Wn){Wn.updateShadowParameters(this.transform,this.style.directionalLight);for(const Ye in Lt)for(const ut of Lr[Ye]){let Ye={min:0,max:0};this.terrain&&(Ye=this.terrain.getMinMaxForTile(ut)||Ye),Wn.addShadowReceiver(ut.toUnwrapped(),Ye.min,Ye.max)}}if("globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new Ye.cs(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new hr(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!Ye.ct(this.context.gl))return;this.renderPass="offscreen";for(const Ye of It){const pt=ut.getLayerSourceCache(Ye);if(!Ye.hasOffscreenPass()||Ye.isHidden(this.transform.zoom))continue;const wt=pt?Qr[pt.id]:void 0;("custom"===Ye.type||"raster"===Ye.type||"raster-particle"===Ye.type||Ye.isSky()||wt&&wt.length)&&this.renderLayer(this,pt,Ye,wt)}this.depthRangeFor3D=[0,1-(It.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,xn)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const Xn="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),Jn=(()=>{if(pt.showOverdrawInspector)return Ye.C.black;const ut=this.style.fog;if(ut&&this.transform.projection.supportsFog){const pt=this.style.getLut(ut.scope);if(!Xn){const wt=ut.properties.get("color").toRenderColor(pt).toArray01();return new Ye.C(...wt)}if(Xn){const wt=ut.properties.get("space-color").toRenderColor(pt).toArray01();return new Ye.C(...wt)}}return Ye.C.transparent})();if(this.context.clear({color:Jn,depth:1}),this.clearStencil(),this._showOverdrawInspector=pt.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Xn&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=St.length-1;this.currentLayer>=0;this.currentLayer--){const Ye=It[this.currentLayer],pt=ut.getLayerSourceCache(Ye);if(Ye.isSky())continue;const wt=pt?(Ye.is3D()?vn:Qr)[pt.id]:void 0;this._renderTileClippingMasks(Ye,pt,wt),this.renderLayer(this,pt,Ye,wt)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Xn&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||Ye.a1(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<St.length;this.currentLayer++){const Ye=It[this.currentLayer],pt=ut.getLayerSourceCache(Ye);Ye.isSky()&&this.renderLayer(this,pt,Ye,pt?Qr[pt.id]:void 0)}function b(Ye,ut){let pt;return ut&&(pt=("symbol"===Ye.type?fn:Ye.is3D()?vn:Qr)[ut.id]),pt}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<St.length;){const Ye=It[this.currentLayer];if("raster"===Ye.type){const pt=ut.getLayerSourceCache(Ye);this.renderLayer(this,pt,Ye,b(Ye,pt))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Qn=0;Wn&&(Qn=Wn.getShadowCastingLayerCount());let ko=!1;for(;this.currentLayer<St.length;){const Ye=It[this.currentLayer],pt=ut.getLayerSourceCache(Ye);if(Ye.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Ye)){if(Ye.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(ko||!this.terrain||!this.style.hasSymbolLayers()&&!this.style.hasCircleLayers()||this.transform.isOrthographic||(ko=!0,this.blitDepth()),Ye.is3D()||this.terrain||this._renderTileClippingMasks(Ye,pt,pt?Lr[pt.id]:void 0),this.renderLayer(this,pt,Ye,b(Ye,pt)),!this.terrain&&Wn&&Qn>0&&Ye.hasShadowPass()&&0==--Qn&&(Wn.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const Ye=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Ye;this.currentLayer++){const Ye=It[this.currentLayer];if(!Ye.hasLightBeamPass())continue;const pt=ut.getLayerSourceCache(Ye);this.renderLayer(this,pt,Ye,pt?Qr[pt.id]:void 0)}this.currentLayer=Ye,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Ye=this.currentLayer;this.depthOcclusion=!0;for(const Ye of this.layersWithOcclusionOpacity){this.currentLayer=Ye;const pt=It[this.currentLayer],wt=ut.getLayerSourceCache(pt),Tt=wt?Qr[wt.id]:void 0;pt.is3D()||this.terrain||this._renderTileClippingMasks(pt,wt,wt?Lr[wt.id]:void 0),this.renderLayer(this,wt,pt,Tt)}this.depthOcclusion=!1,this.currentLayer=Ye,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let pt=null;It.forEach((Ye=>{const wt=ut.getLayerSourceCache(Ye);wt&&!Ye.isHidden(this.transform.zoom)&&wt.getVisibleCoordinates().length&&(!pt||pt.getSource().maxzoom<wt.getSource().maxzoom)&&(pt=wt)})),pt&&this.options.showTileBoundaries&&qh.debug(this,pt,pt.getVisibleCoordinates(),Ye.C.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&qh.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new Ye.C(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Ye){const ut=Ye.transform.padding;Qo(Ye,Ye.transform.height-(ut.top||0),3,Ac),Qo(Ye,ut.bottom||0,3,Sc),Jo(Ye,ut.left||0,3,Dc),Jo(Ye,Ye.transform.width-(ut.right||0),3,qc);const pt=Ye.transform.centerPoint;!function(Ye,ut,pt,wt){er(Ye,ut-1,pt-10,2,20,wt),er(Ye,ut-10,pt-1,20,2,wt)}(Ye,pt.x,Ye.transform.height-pt.y,$c)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),Xt||(this.conflationActive=!1)}prepareLayer(Ye){this.gpuTimingStart(Ye);const{unsupportedLayers:ut}=this.transform.projection,pt=!ut||!ut.includes(Ye.type);if(Jh[Ye.type]&&(pt||this.terrain&&"custom"===Ye.type)){const ut=this.style.getLayerSourceCache(Ye);Jh[Ye.type](Ye,ut,this)}this.gpuTimingEnd()}renderLayer(Ye,ut,pt,wt){pt.isHidden(this.transform.zoom)||("background"===pt.type||"sky"===pt.type||"custom"===pt.type||"model"===pt.type||"raster"===pt.type||"raster-particle"===pt.type||wt&&wt.length)&&(this.id=pt.id,this.gpuTimingStart(pt),Ye.transform.projection.unsupportedLayers&&Ye.transform.projection.unsupportedLayers.includes(pt.type)&&(!Ye.terrain||"custom"!==pt.type)||"clip"===pt.type||qh[pt.type](Ye,ut,pt,wt,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(Ye){if(!this.options.gpuTiming)return;const ut=this.context.extTimerQuery,pt=this.context.gl;let wt=this.gpuTimers[Ye.id];wt||(wt=this.gpuTimers[Ye.id]={calls:0,cpuTime:0,query:pt.createQuery()}),wt.calls++,pt.beginQuery(ut.TIME_ELAPSED_EXT,wt.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const Ye=this.context.extTimerQuery,ut=this.context.gl,pt=ut.createQuery();this.deferredRenderGpuTimeQueries.push(pt),ut.beginQuery(Ye.TIME_ELAPSED_EXT,pt)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const Ye=this.gpuTimers;return this.gpuTimers={},Ye}collectDeferredRenderGpuQueries(){const Ye=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],Ye}queryGpuTimers(Ye){const ut={};for(const pt in Ye){const wt=Ye[pt],Tt=this.context.extTimerQuery,St=Tt.getQueryParameter(wt.query,this.context.gl.QUERY_RESULT)/1e6;Tt.deleteQueryEXT(wt.query),ut[pt]=St}return ut}queryGpuTimeDeferredRender(Ye){if(!this.options.gpuTimingDeferredRender)return 0;const ut=this.context.extTimerQuery,pt=this.context.gl;let wt=0;for(const Tt of Ye)wt+=ut.getQueryParameter(Tt,pt.QUERY_RESULT)/1e6,ut.deleteQueryEXT(Tt);return wt}translatePosMatrix(ut,pt,wt,Tt,St){if(!wt[0]&&!wt[1])return ut;const It=St?"map"===Tt?this.transform.angle:0:"viewport"===Tt?-this.transform.angle:0;if(It){const Ye=Math.sin(It),ut=Math.cos(It);wt=[wt[0]*ut-wt[1]*Ye,wt[0]*Ye+wt[1]*ut]}const Lt=[St?wt[0]:Ye.bB(pt,wt[0],this.transform.zoom),St?wt[1]:Ye.bB(pt,wt[1],this.transform.zoom),0],$t=new Float32Array(16);return Ye.ad.translate($t,ut,Lt),$t}saveTileTexture(Ye){const ut=Ye.size[0],pt=this._tileTextures[ut];pt?pt.push(Ye):this._tileTextures[ut]=[Ye]}getTileTexture(Ye){const ut=this._tileTextures[Ye];return ut&&ut.length>0?ut.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(Ye,ut,pt){const wt=void 0===pt?this.terrain&&this.terrain.renderingToTexture:pt,Tt=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===Ye||"terrainRaster"===Ye?(Tt.push("LIGHTING_3D_MODE"),Tt.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):wt||Tt.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass?this._shadowMapDebug||Tt.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?Tt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):Tt.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(Tt.push("TERRAIN"),this.linearFloatFilteringSupported()&&Tt.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&Tt.push("GLOBE"),!this._fogVisible||wt||void 0!==ut&&!ut||Tt.push("FOG","FOG_DITHERING"),wt&&Tt.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&Tt.push("OVERDRAW_INSPECTOR"),Tt}getOrCreateProgram(Ye,ut){this.cache=this.cache||{};const pt=ut&&ut.defines||[],wt=ut&&ut.config,Tt=this.currentGlobalDefines(Ye,ut&&ut.overrideFog,ut&&ut.overrideRtt).concat(pt),St=Gi.cacheKey(ll[Ye],Ye,Tt,wt);return this.cache[St]||(this.cache[St]=new Gi(this.context,Ye,ll[Ye],wt,uc[Ye],Tt)),this.cache[St]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const Ye=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(Ye.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new Ye.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.terrainDepthFBO&&(this.terrainDepthFBO.destroy(),this.terrainDepthFBO=void 0,this.terrainDepthTexture=void 0)}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(ut,pt){if(this.style.enable3dLights()){const wt=this.style.directionalLight,Tt=this.style.ambientLight;if(wt&&Tt){const St=((ut,pt,wt)=>{const Tt=ut.properties.get("direction"),St=ut.properties.get("color").toRenderColor(wt.getLut(ut.scope)).toArray01(),It=ut.properties.get("intensity"),Lt=pt.properties.get("color").toRenderColor(wt.getLut(pt.scope)).toArray01(),$t=pt.properties.get("intensity"),Xt=[Tt.x,Tt.y,Tt.z],Sr=Ye.bA(Lt,$t),Lr=Ye.bA(St,It);return{u_lighting_ambient_color:Sr,u_lighting_directional_dir:Xt,u_lighting_directional_color:Lr,u_ground_radiance:ki(Xt,Lr,Sr)}})(wt,Tt,this.style);pt.setLightsUniformValues(ut,St)}}}uploadCommonUniforms(ut,pt,wt,Tt,St){if(this.uploadCommonLightUniforms(ut,pt),this.terrain&&this.terrain.renderingToTexture)return;const It=this.style.fog;if(It){const St=It.getOpacity(this.transform.pitch),Lt=((ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr)=>{const fn=ut.transform,xn=pt.properties.get("color").toRenderColor(ut.style.getLut(pt.scope)).toArray01();xn[3]=Tt;const vn=ut.frameCounter/1e3%1,[kn,Wn]=pt.properties.get("vertical-range");return{u_fog_matrix:wt?fn.calculateFogTileMatrix(wt):Qr||ut.identityMat,u_fog_range:pt.getFovAdjustedRange(fn._fov),u_fog_color:xn,u_fog_horizon_blend:pt.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(kn,Wn),Wn],u_fog_temporal_offset:vn,u_frustum_tl:St,u_frustum_tr:It,u_frustum_br:Lt,u_frustum_bl:$t,u_globe_pos:Xt,u_globe_radius:Sr,u_viewport:Lr,u_globe_transition:Ye.a1(fn.zoom),u_is_globe:+("globe"===fn.projection.name)}})(this,It,wt,St,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*Ye.e.devicePixelRatio,this.transform.height*Ye.e.devicePixelRatio],Tt);pt.setFogUniformValues(ut,Lt)}St&&pt.setCutoffUniformValues(ut,St.uniformValues)}setTileLoadedFlag(Ye){this.tileLoaded=Ye}saveCanvasCopy(){const Ye=this.canvasCopy();Ye&&(this.frameCopies.push(Ye),this.tileLoaded=!1)}canvasCopy(){const Ye=this.context.gl,ut=Ye.createTexture();return Ye.bindTexture(Ye.TEXTURE_2D,ut),Ye.copyTexImage2D(Ye.TEXTURE_2D,0,Ye.RGBA,0,0,Ye.drawingBufferWidth,Ye.drawingBufferHeight,0),ut}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const Ye=this.style&&this.style.fog;return!!Ye&&0!==Ye.getOpacity(this.transform.pitch)}getBackgroundTiles(){const ut=this._backgroundTiles,pt=this._backgroundTiles={},wt=this.transform.coveringTiles({tileSize:512});for(const Tt of wt)pt[Tt.key]=ut[Tt.key]||new Ye.by(Tt,512,this.transform.tileZoom,this);return pt}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(Ye,ut){return!(!Ye.is3D()||Ye.minzoom&&Ye.minzoom>this.transform.zoom||(this.style._clipLayerIndices.length||"building"!==Ye.sourceLayer)&&"clip"!==Ye.type&&(!ut||"batched-model"!==ut.type))}isTileAffectedByFog(Ye){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let ut=this._cachedTileFogOpacities[Ye.key];return ut||(this._cachedTileFogOpacities[Ye.key]=ut=this.style.fog.getOpacityForTile(Ye)),ut[0]>=vn||ut[1]>=vn}}class Rr{constructor(Ye,ut,pt,wt){this.screenBounds=Ye,this.cameraPoint=ut,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=pt,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,wt)}static createFromScreenPoints(ut,pt){let wt,Tt;if(ut instanceof Ye.P||"number"==typeof ut[0]){const St=Ye.P.convert(ut);wt=[St],Tt=pt.isPointAboveHorizon(St)}else{const St=Ye.P.convert(ut[0]),It=Ye.P.convert(ut[1]);wt=[St,It],Tt=Ye.cv(St,It).every((Ye=>pt.isPointAboveHorizon(Ye)))}return new Rr(wt,pt.getCameraPoint(),Tt,pt)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(ut){return Ye.cv(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],ut)}bufferedCameraGeometry(ut){const pt=this.screenBounds[0],wt=1===this.screenBounds.length?this.screenBounds[0].add(new Ye.P(1,1)):this.screenBounds[1],Tt=Ye.cv(pt,wt,0,!1);return this.cameraPoint.y>wt.y&&(this.cameraPoint.x>pt.x&&this.cameraPoint.x<wt.x?Tt.splice(3,0,this.cameraPoint):this.cameraPoint.x>=wt.x?Tt[2]=this.cameraPoint:this.cameraPoint.x<=pt.x&&(Tt[3]=this.cameraPoint)),Ye.cw(Tt,ut)}bufferedCameraGeometryGlobe(ut){const pt=this.screenBounds[0],wt=1===this.screenBounds.length?this.screenBounds[0].add(new Ye.P(1,1)):this.screenBounds[1],Tt=Ye.cv(pt,wt,ut),St=this.cameraPoint.clone();switch(3*((St.y>pt.y)+(St.y>wt.y))+((St.x>pt.x)+(St.x>wt.x))){case 0:Tt[0]=St,Tt[4]=St.clone();break;case 1:Tt.splice(1,0,St);break;case 2:Tt[1]=St;break;case 3:Tt.splice(4,0,St);break;case 5:Tt.splice(2,0,St);break;case 6:Tt[3]=St;break;case 7:Tt.splice(3,0,St);break;case 8:Tt[2]=St}return Tt}containsTile(ut,pt,wt,Tt=0){const St=ut.queryPadding/pt._pixelsPerMercatorPixel+1,It=wt?this._bufferedCameraMercator(St,pt):this._bufferedScreenMercator(St,pt);let Lt=ut.tileID.wrap+(It.unwrapped?Tt:0);const $t=It.polygon.map((pt=>Ye.cx(ut.tileTransform,pt,Lt)));if(!Ye.cy($t,0,0,Ye.a3,Ye.a3))return;Lt=ut.tileID.wrap+(this.screenGeometryMercator.unwrapped?Tt:0);const Xt=this.screenGeometryMercator.polygon.map((pt=>Ye.cz(ut.tileTransform,pt,Lt))),Sr=Xt.map((ut=>new Ye.P(ut[0],ut[1]))),Lr=pt.getFreeCameraOptions().position||new Ye.Y(0,0,0),Qr=Ye.cz(ut.tileTransform,Lr,Lt),fn=Xt.map((ut=>{const pt=Ye._.sub(ut,ut,Qr);return Ye._.normalize(pt,pt),new Ye.aT(Qr,pt)})),xn=Ye.bB(ut,1,pt.zoom)*pt._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:Sr,tilespaceRays:fn,bufferedTilespaceGeometry:$t,bufferedTilespaceBounds:(vn=Ye.cA($t),vn.min.x=Ye.at(vn.min.x,0,Ye.a3),vn.min.y=Ye.at(vn.min.y,0,Ye.a3),vn.max.x=Ye.at(vn.max.x,0,Ye.a3),vn.max.y=Ye.at(vn.max.y,0,Ye.a3),vn),tile:ut,tileID:ut.tileID,pixelToTileUnitsFactor:xn};var vn}_bufferedScreenMercator(Ye,ut){const pt=zr(Ye);if(this._screenRaycastCache[pt])return this._screenRaycastCache[pt];{let wt;return wt="globe"===ut.projection.name?this._projectAndResample(this.bufferedScreenGeometry(Ye),ut):{polygon:this.bufferedScreenGeometry(Ye).map((Ye=>ut.pointCoordinate3D(Ye))),unwrapped:!0},this._screenRaycastCache[pt]=wt,wt}}_bufferedCameraMercator(Ye,ut){const pt=zr(Ye);if(this._cameraRaycastCache[pt])return this._cameraRaycastCache[pt];{let wt;return wt="globe"===ut.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(Ye),ut):{polygon:this.bufferedCameraGeometry(Ye).map((Ye=>ut.pointCoordinate3D(Ye))),unwrapped:!0},this._cameraRaycastCache[pt]=wt,wt}}_projectAndResample(ut,pt){const wt=function(ut,pt){const wt=Ye.ad.multiply([],pt.pixelMatrix,pt.globeMatrix),Tt=[0,-Ye.cD,0,1],St=[0,Ye.cD,0,1],It=[0,0,0,1];Ye.aA.transformMat4(Tt,Tt,wt),Ye.aA.transformMat4(St,St,wt),Ye.aA.transformMat4(It,It,wt);const Lt=new Ye.P(Tt[0]/Tt[3],Tt[1]/Tt[3]),$t=new Ye.P(St[0]/St[3],St[1]/St[3]),Xt=Ye.cB(ut,Lt)&&Tt[3]<It[3],Sr=Ye.cB(ut,$t)&&St[3]<It[3];if(!Xt&&!Sr)return null;const Lr=function(Ye,ut,pt){for(let wt=1;wt<Ye.length;wt++){const Tt=Mr(ut.pointCoordinate3D(Ye[wt-1]).x),St=Mr(ut.pointCoordinate3D(Ye[wt]).x);if(pt<0){if(Tt<St)return{idx:wt,t:-Tt/(St-1-Tt)}}else if(St<Tt)return{idx:wt,t:(1-Tt)/(St+1-Tt)}}return null}(ut,pt,Xt?-1:1);if(!Lr)return null;const{idx:Qr,t:fn}=Lr;let xn=Qr>1?Dr(ut.slice(0,Qr),pt):[],vn=Qr<ut.length?Dr(ut.slice(Qr),pt):[];xn=xn.map((ut=>new Ye.P(Mr(ut.x),ut.y))),vn=vn.map((ut=>new Ye.P(Mr(ut.x),ut.y)));const kn=[...xn];0===kn.length&&kn.push(vn[vn.length-1]);const Wn=Ye.a2(kn[kn.length-1].y,(0===vn.length?xn[0]:vn[0]).y,fn);let Xn;return Xn=Xt?[new Ye.P(0,Wn),new Ye.P(0,0),new Ye.P(1,0),new Ye.P(1,Wn)]:[new Ye.P(1,Wn),new Ye.P(1,1),new Ye.P(0,1),new Ye.P(0,Wn)],kn.push(...Xn),0===vn.length?kn.push(xn[0]):kn.push(...vn),{polygon:kn.map((ut=>new Ye.Y(ut.x,ut.y))),unwrapped:!1}}(ut,pt);if(wt)return wt;const Tt=function(ut,pt){let wt=!1,Tt=-1/0,St=0;for(let Ye=0;Ye<ut.length-1;Ye++)ut[Ye].x>Tt&&(Tt=ut[Ye].x,St=Ye);for(let Ye=0;Ye<ut.length-1;Ye++){const pt=(St+Ye)%(ut.length-1),Tt=ut[pt],It=ut[pt+1];Math.abs(Tt.x-It.x)>.5&&(Tt.x<It.x?(Tt.x+=1,0===pt&&(ut[ut.length-1].x+=1)):(It.x+=1,pt+1===ut.length-1&&(ut[0].x+=1)),wt=!0)}const It=Ye.aj(pt.center.lng);return wt&&It<Math.abs(It-1)&&ut.forEach((Ye=>{Ye.x-=1})),{polygon:ut,unwrapped:wt}}(Dr(ut,pt).map((ut=>new Ye.P(Mr(ut.x),ut.y))),pt);return{polygon:Tt.polygon.map((ut=>new Ye.Y(ut.x,ut.y))),unwrapped:Tt.unwrapped}}}function Dr(ut,pt){return Ye.cC(ut,(Ye=>{const ut=pt.pointCoordinate3D(Ye);Ye.x=ut.x,Ye.y=ut.y}),1/256)}function Mr(Ye){return Ye<0?1+Ye%1:Ye%1}function zr(Ye){return 100*Ye|0}function Or(ut,pt){const wt=Ye.ad.identity([]);return Ye.ad.scale(wt,wt,[.5*ut.width,.5*-ut.height,1]),Ye.ad.translate(wt,wt,[1,-1,0]),Ye.ad.multiply(wt,wt,ut.calculateProjMatrix(pt.toUnwrapped())),Float32Array.from(wt)}function Fr(Ye,ut,pt,wt,Tt,St,It,Lt=!1){const $t=Ye.tilesIn(wt,It,Lt);$t.sort(kr);const Xt=[];for(const wt of $t)Xt.push({wrappedTileID:wt.tile.tileID.wrapped().key,queryResults:wt.tile.queryRenderedFeatures(ut,pt,Ye._state,wt,Tt,St,Or(Ye.transform,wt.tile.tileID),Lt)});const Sr=function(Ye){const ut={},pt={};for(const wt of Ye){const Ye=wt.queryResults,Tt=wt.wrappedTileID,St=pt[Tt]=pt[Tt]||{};for(const pt in Ye){const wt=Ye[pt],Tt=St[pt]=St[pt]||{},It=ut[pt]=ut[pt]||[];for(const Ye of wt)Tt[Ye.featureIndex]||(Tt[Ye.featureIndex]=!0,It.push(Ye))}}return ut}(Xt);for(const ut in Sr)Sr[ut].forEach((ut=>{const pt=ut.feature,wt=pt.layer;wt&&"background"!==wt.type&&"sky"!==wt.type&&"slot"!==wt.type&&(pt.source=wt.source,wt["source-layer"]&&(pt.sourceLayer=wt["source-layer"]),pt.state=void 0!==pt.id?Ye.getFeatureState(wt["source-layer"],pt.id):{})}));return Sr}function Br(Ye,ut){const pt=Ye.getRenderableIds().map((ut=>Ye.getTileByID(ut))),wt=[],Tt={};for(let Ye=0;Ye<pt.length;Ye++){const St=pt[Ye],It=St.tileID.canonical.key;Tt[It]||(Tt[It]=!0,St.querySourceFeatures(wt,ut))}return wt}function kr(Ye,ut){const pt=Ye.tileID,wt=ut.tileID;return pt.overscaledZ-wt.overscaledZ||pt.canonical.y-wt.canonical.y||pt.wrap-wt.wrap||pt.canonical.x-wt.canonical.x}class Nr{constructor(Ye){this.style=Ye,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const Ye=!1,ut=!1;for(const pt in this.style._mergedLayers){const wt=this.style._mergedLayers[pt];if("fill-extrusion"===wt.type)this.layers.push({layer:wt,visible:Ye,visibilityChanged:ut});else if("model"===wt.type){const pt=this.style.getLayerSource(wt);pt&&"batched-model"===pt.type&&this.layers.push({layer:wt,visible:Ye,visibilityChanged:ut})}}}onNewFrame(Ye){this.layersGotHidden=!1;for(const ut of this.layers){const pt=ut.layer;let wt=!1;"fill-extrusion"===pt.type?wt=!pt.isHidden(Ye)&&pt.paint.get("fill-extrusion-opacity")>0:"model"===pt.type&&(wt=!pt.isHidden(Ye)&&pt.paint.get("model-opacity")>0),this.layersGotHidden=this.layersGotHidden||!wt&&ut.visible,ut.visible=wt}}updateZOffset(Ye,ut){this.currentBuildingBuckets=[];for(const Ye of this.layers){const pt=Ye.layer,wt=this.style.getLayerSourceCache(pt);let Tt=1;"fill-extrusion"===pt.type&&(Tt=Ye.visible?pt.paint.get("fill-extrusion-vertical-scale"):0);let St=wt?wt.getTile(ut):null;if(!St&&wt&&ut.canonical.z>wt.getSource().minzoom){let Ye=ut.scaledTo(Math.min(wt.getSource().maxzoom,ut.overscaledZ-1));for(;Ye.overscaledZ>=wt.getSource().minzoom&&(St=wt.getTile(Ye),!St&&0!==Ye.overscaledZ);)Ye=Ye.scaledTo(Ye.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:St?St.getBucket(pt):null,tileID:St?St.tileID:ut,verticalScale:Tt})}Ye.hasAnyZOffset=!1;let pt=!1;for(let wt=0;wt<Ye.symbolInstances.length;wt++){const Tt=Ye.symbolInstances.get(wt),St=Tt.zOffset,It=this._getHeightAtTileOffset(ut,Tt.tileAnchorX,Tt.tileAnchorY);Tt.zOffset=It!==Number.NEGATIVE_INFINITY?It:St,pt||St===Tt.zOffset||(pt=!0),Ye.hasAnyZOffset||0===Tt.zOffset||(Ye.hasAnyZOffset=!0)}pt&&(Ye.zOffsetBuffersNeedUpload=!0,Ye.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(ut,pt,wt,Tt){let St=pt,It=wt;if(ut.canonical.z!==Tt.canonical.z){const Lt=Tt.canonical,$t=1/(1<<ut.canonical.z-Lt.z);St=(pt+ut.canonical.x*Ye.a3)*$t-Lt.x*Ye.a3|0,It=(wt+ut.canonical.y*Ye.a3)*$t-Lt.y*Ye.a3|0}return{tileX:St,tileY:It}}_getHeightAtTileOffset(Ye,ut,pt){let wt,Tt;for(let St=0;St<this.layers.length;++St){if("fill-extrusion"!==this.layers[St].layer.type)continue;const{bucket:It,tileID:Lt,verticalScale:$t}=this.currentBuildingBuckets[St];if(!It)continue;const{tileX:Xt,tileY:Sr}=this._mapCoordToOverlappingTile(Ye,ut,pt,Lt),Lr=It.getHeightAtTileCoord(Xt,Sr);Lr&&void 0!==Lr.height&&(Lr.hidden?wt=Lr.height:Tt=Math.max(Lr.height*$t,Tt||0))}if(void 0!==Tt)return Tt;for(let Tt=0;Tt<this.layers.length;++Tt){const St=this.layers[Tt];if("model"!==St.layer.type||!St.visible)continue;const{bucket:It,tileID:Lt}=this.currentBuildingBuckets[Tt];if(!It)continue;const{tileX:$t,tileY:Xt}=this._mapCoordToOverlappingTile(Ye,ut,pt,Lt),Sr=It.getHeightAtTileCoord($t,Xt);if(Sr&&!Sr.hidden)return void 0===Sr.height&&void 0!==wt?Math.min(Sr.maxHeight,wt)*Sr.verticalScale:Sr.height?Sr.height*Sr.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Ur(ut,pt){const wt={};for(const Ye in ut)"ref"!==Ye&&(wt[Ye]=ut[Ye]);return Ye.cE.forEach((Ye=>{Ye in pt&&(wt[Ye]=pt[Ye])})),wt}function Gr(Ye){Ye=Ye.slice();const ut=Object.create(null);for(let pt=0;pt<Ye.length;pt++)ut[Ye[pt].id]=Ye[pt];for(let pt=0;pt<Ye.length;pt++)"ref"in Ye[pt]&&(Ye[pt]=Ur(Ye[pt],ut[Ye[pt].ref]));return Ye}const Qh={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Vr(Ye,ut,pt){pt.push({command:Qh.addSource,args:[Ye,ut[Ye]]})}function Wr(Ye,ut,pt){ut.push({command:Qh.removeSource,args:[Ye]}),pt[Ye]=!0}function Zr(Ye,ut,pt,wt){Wr(Ye,pt,wt),Vr(Ye,ut,pt)}function qr(Ye,ut,pt){let wt;for(wt in Ye[pt])if(Ye[pt].hasOwnProperty(wt)&&"data"!==wt&&!t(Ye[pt][wt],ut[pt][wt]))return!1;for(wt in ut[pt])if(ut[pt].hasOwnProperty(wt)&&"data"!==wt&&!t(Ye[pt][wt],ut[pt][wt]))return!1;return!0}function Hr(Ye,ut,pt,wt,Tt,St){let It;for(It in ut=ut||{},Ye=Ye||{})Ye.hasOwnProperty(It)&&(t(Ye[It],ut[It])||pt.push({command:St,args:[wt,It,ut[It],Tt]}));for(It in ut)ut.hasOwnProperty(It)&&!Ye.hasOwnProperty(It)&&(t(Ye[It],ut[It])||pt.push({command:St,args:[wt,It,ut[It],Tt]}))}function $r(Ye){return Ye.id}function Xr(Ye,ut){return Ye[ut.id]=ut,Ye}class Yr{constructor(Ye,ut){this.reset(Ye,ut)}reset(Ye,ut){this.points=Ye||[],this._distances=[0];for(let Ye=1;Ye<this.points.length;Ye++)this._distances[Ye]=this._distances[Ye-1]+this.points[Ye].dist(this.points[Ye-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(ut||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(ut){if(1===this.points.length)return this.points[0];ut=Ye.at(ut,0,1);let pt=1,wt=this._distances[pt];const Tt=ut*this.paddedLength+this.padding;for(;wt<Tt&&pt<this._distances.length;)wt=this._distances[++pt];const St=pt-1,It=this._distances[St],Lt=wt-It,$t=Lt>0?(Tt-It)/Lt:0;return this.points[St].mult(1-$t).add(this.points[pt].mult($t))}}class Kr{constructor(Ye,ut,pt){const wt=this.boxCells=[],Tt=this.circleCells=[];this.xCellCount=Math.ceil(Ye/pt),this.yCellCount=Math.ceil(ut/pt);for(let Ye=0;Ye<this.xCellCount*this.yCellCount;Ye++)wt.push([]),Tt.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=Ye,this.height=ut,this.xScale=this.xCellCount/Ye,this.yScale=this.yCellCount/ut,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(Ye,ut,pt,wt,Tt){this._forEachCell(ut,pt,wt,Tt,this._insertBoxCell,this.boxUid++),this.boxKeys.push(Ye),this.bboxes.push(ut),this.bboxes.push(pt),this.bboxes.push(wt),this.bboxes.push(Tt)}insertCircle(Ye,ut,pt,wt){this._forEachCell(ut-wt,pt-wt,ut+wt,pt+wt,this._insertCircleCell,this.circleUid++),this.circleKeys.push(Ye),this.circles.push(ut),this.circles.push(pt),this.circles.push(wt)}_insertBoxCell(Ye,ut,pt,wt,Tt,St){this.boxCells[Tt].push(St)}_insertCircleCell(Ye,ut,pt,wt,Tt,St){this.circleCells[Tt].push(St)}_query(Ye,ut,pt,wt,Tt,St){if(pt<0||Ye>this.width||wt<0||ut>this.height)return!Tt&&[];const It=[];if(Ye<=0&&ut<=0&&this.width<=pt&&this.height<=wt){if(Tt)return!0;for(let Ye=0;Ye<this.boxKeys.length;Ye++)It.push({key:this.boxKeys[Ye],x1:this.bboxes[4*Ye],y1:this.bboxes[4*Ye+1],x2:this.bboxes[4*Ye+2],y2:this.bboxes[4*Ye+3]});for(let Ye=0;Ye<this.circleKeys.length;Ye++){const ut=this.circles[3*Ye],pt=this.circles[3*Ye+1],wt=this.circles[3*Ye+2];It.push({key:this.circleKeys[Ye],x1:ut-wt,y1:pt-wt,x2:ut+wt,y2:pt+wt})}return St?It.filter(St):It}return this._forEachCell(Ye,ut,pt,wt,this._queryCell,It,{hitTest:Tt,seenUids:{box:{},circle:{}}},St),Tt?It.length>0:It}_queryCircle(Ye,ut,pt,wt,Tt){const St=Ye-pt,It=Ye+pt,Lt=ut-pt,$t=ut+pt;if(It<0||St>this.width||$t<0||Lt>this.height)return!wt&&[];const Xt=[];return this._forEachCell(St,Lt,It,$t,this._queryCellCircle,Xt,{hitTest:wt,circle:{x:Ye,y:ut,radius:pt},seenUids:{box:{},circle:{}}},Tt),wt?Xt.length>0:Xt}query(Ye,ut,pt,wt,Tt){return this._query(Ye,ut,pt,wt,!1,Tt)}hitTest(Ye,ut,pt,wt,Tt){return this._query(Ye,ut,pt,wt,!0,Tt)}hitTestCircle(Ye,ut,pt,wt){return this._queryCircle(Ye,ut,pt,!0,wt)}_queryCell(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=It.seenUids,Xt=this.boxCells[Tt];if(null!==Xt){const Tt=this.bboxes;for(const Sr of Xt)if(!$t.box[Sr]){$t.box[Sr]=!0;const Xt=4*Sr;if(Ye<=Tt[Xt+2]&&ut<=Tt[Xt+3]&&pt>=Tt[Xt+0]&&wt>=Tt[Xt+1]&&(!Lt||Lt(this.boxKeys[Sr]))){if(It.hitTest)return St.push(!0),!0;St.push({key:this.boxKeys[Sr],x1:Tt[Xt],y1:Tt[Xt+1],x2:Tt[Xt+2],y2:Tt[Xt+3]})}}}const Sr=this.circleCells[Tt];if(null!==Sr){const Tt=this.circles;for(const Xt of Sr)if(!$t.circle[Xt]){$t.circle[Xt]=!0;const Sr=3*Xt;if(this._circleAndRectCollide(Tt[Sr],Tt[Sr+1],Tt[Sr+2],Ye,ut,pt,wt)&&(!Lt||Lt(this.circleKeys[Xt]))){if(It.hitTest)return St.push(!0),!0;{const Ye=Tt[Sr],ut=Tt[Sr+1],pt=Tt[Sr+2];St.push({key:this.circleKeys[Xt],x1:Ye-pt,y1:ut-pt,x2:Ye+pt,y2:ut+pt})}}}}}_queryCellCircle(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=It.circle,Xt=It.seenUids,Sr=this.boxCells[Tt];if(null!==Sr){const Ye=this.bboxes;for(const ut of Sr)if(!Xt.box[ut]){Xt.box[ut]=!0;const pt=4*ut;if(this._circleAndRectCollide($t.x,$t.y,$t.radius,Ye[pt+0],Ye[pt+1],Ye[pt+2],Ye[pt+3])&&(!Lt||Lt(this.boxKeys[ut])))return St.push(!0),!0}}const Lr=this.circleCells[Tt];if(null!==Lr){const Ye=this.circles;for(const ut of Lr)if(!Xt.circle[ut]){Xt.circle[ut]=!0;const pt=3*ut;if(this._circlesCollide(Ye[pt],Ye[pt+1],Ye[pt+2],$t.x,$t.y,$t.radius)&&(!Lt||Lt(this.circleKeys[ut])))return St.push(!0),!0}}}_forEachCell(Ye,ut,pt,wt,Tt,St,It,Lt){const $t=this._convertToXCellCoord(Ye),Xt=this._convertToYCellCoord(ut),Sr=this._convertToXCellCoord(pt),Lr=this._convertToYCellCoord(wt);for(let Qr=$t;Qr<=Sr;Qr++)for(let $t=Xt;$t<=Lr;$t++)if(Tt.call(this,Ye,ut,pt,wt,this.xCellCount*$t+Qr,St,It,Lt))return}_convertToXCellCoord(Ye){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(Ye*this.xScale)))}_convertToYCellCoord(Ye){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(Ye*this.yScale)))}_circlesCollide(Ye,ut,pt,wt,Tt,St){const It=wt-Ye,Lt=Tt-ut,$t=pt+St;return $t*$t>It*It+Lt*Lt}_circleAndRectCollide(Ye,ut,pt,wt,Tt,St,It){const Lt=(St-wt)/2,$t=Math.abs(Ye-(wt+Lt));if($t>Lt+pt)return!1;const Xt=(It-Tt)/2,Sr=Math.abs(ut-(Tt+Xt));if(Sr>Xt+pt)return!1;if($t<=Lt||Sr<=Xt)return!0;const Lr=$t-Lt,Qr=Sr-Xt;return Lr*Lr+Qr*Qr<=pt*pt}}const wu=100;class Jr{constructor(Ye,ut,pt=new Kr(Ye.width+200,Ye.height+200,25),wt=new Kr(Ye.width+200,Ye.height+200,25)){this.transform=Ye,this.grid=pt,this.ignoredGrid=wt,this.pitchfactor=Math.cos(Ye._pitch)*Ye.cameraToCenterDistance,this.screenRightBoundary=Ye.width+wu,this.screenBottomBoundary=Ye.height+wu,this.gridRightBoundary=Ye.width+200,this.gridBottomBoundary=Ye.height+200,this.fogState=ut}placeCollisionBox(Ye,ut,pt,wt,Tt,St,It,Lt){let $t=pt.projectedAnchorX,Xt=pt.projectedAnchorY,Sr=pt.projectedAnchorZ;const Lr=pt.elevation,Qr=pt.tileID,fn=Ye.getProjection();if(Lr&&Qr){const[Ye,ut,wt]=fn.upVector(Qr.canonical,pt.tileAnchorX,pt.tileAnchorY),Tt=fn.upVectorScale(Qr.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;$t+=Ye*Lr*Tt,Xt+=ut*Lr*Tt,Sr+=wt*Lr*Tt}const xn=this.projectAndGetPerspectiveRatio(It,$t,Xt,Sr,pt.tileID,"globe"===fn.name||!!Lr||this.transform.pitch>0,fn),vn=St*xn.perspectiveRatio,kn=(pt.x1*ut+wt.x-pt.padding)*vn+xn.point.x,Wn=(pt.y1*ut+wt.y-pt.padding)*vn+xn.point.y,Xn=(pt.x2*ut+wt.x+pt.padding)*vn+xn.point.x,Jn=(pt.y2*ut+wt.y+pt.padding)*vn+xn.point.y,Qn=xn.perspectiveRatio<=.55||xn.occluded;return!this.isInsideGrid(kn,Wn,Xn,Jn)||!Tt&&this.grid.hitTest(kn,Wn,Xn,Jn,Lt)||Qn?{box:[],offscreen:!1,occluded:xn.occluded}:{box:[kn,Wn,Xn,Jn],offscreen:this.isOffscreen(kn,Wn,Xn,Jn),occluded:!1}}placeCollisionCircles(ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn){const kn=[],Wn=this.transform.elevation,Xn=ut.getProjection(),Jn=Wn?Wn.getAtTileOffsetFunc(vn,this.transform.center.lat,this.transform.worldSize,Xn):null,Qn=new Ye.P(wt.tileAnchorX,wt.tileAnchorY);let{x:ko,y:Fo,z:is}=Xn.projectTilePoint(Qn.x,Qn.y,vn.canonical);if(Jn){const[Ye,ut,pt]=Jn(Qn);ko+=Ye,Fo+=ut,is+=pt}const ns="globe"===Xn.name,ss=this.projectAndGetPerspectiveRatio(Lt,ko,Fo,is,vn,ns||!!Wn||this.transform.pitch>0,Xn),{perspectiveRatio:as}=ss,ds=(Lr?It/as:It*as)/Ye.bN,ps=Jt(ko,Fo,is,$t),ms=ss.signedDistanceFromCamera>0?oi(ds,St,wt.lineOffsetX*ds,wt.lineOffsetY*ds,!1,ps,Qn,wt,Tt,$t,{},Wn&&!Lr?Jn:null,Lr&&!!Wn,Xn,vn,Lr):null;let Js=!1,ua=!1,ba=!0;if(ms&&!ss.occluded){const ut=.5*fn*as+xn,wt=new Ye.P(-100,-100),Tt=new Ye.P(this.screenRightBoundary,this.screenBottomBoundary),St=new Yr,{first:It,last:Lt}=ms,$t=It.path.length;let Lr=[];for(let Ye=$t-1;Ye>=1;Ye--)Lr.push(It.path[Ye]);for(let Ye=1;Ye<Lt.path.length;Ye++)Lr.push(Lt.path[Ye]);const vn=2.5*ut;Xt&&(Lr=Lr.map((([Ye,ut,pt],wt)=>(Jn&&!ns&&(pt=Jn(wt<$t-1?It.tilePath[$t-1-wt]:Lt.tilePath[wt-$t+2])[2]),Jt(Ye,ut,pt,Xt)))),Lr.some((Ye=>Ye[3]<=0))&&(Lr=[]));let Wn=[];if(Lr.length>0){let ut=1/0,pt=-1/0,St=1/0,It=-1/0;for(const Ye of Lr)ut=Math.min(ut,Ye[0]),St=Math.min(St,Ye[1]),pt=Math.max(pt,Ye[0]),It=Math.max(It,Ye[1]);pt>=wt.x&&ut<=Tt.x&&It>=wt.y&&St<=Tt.y&&(Wn=[Lr.map((ut=>new Ye.P(ut[0],ut[1])))],(ut<wt.x||pt>Tt.x||St<wt.y||It>Tt.y)&&(Wn=Ye.cF(Wn,wt.x,wt.y,Tt.x,Tt.y)))}for(const Ye of Wn){St.reset(Ye,.25*ut);let wt=0;wt=St.length<=.5*ut?1:Math.ceil(St.paddedLength/vn)+1;for(let Ye=0;Ye<wt;Ye++){const Tt=Ye/Math.max(wt-1,1),It=St.lerp(Tt),Lt=It.x+wu,$t=It.y+wu;kn.push(Lt,$t,ut,0);const Xt=Lt-ut,Lr=$t-ut,fn=Lt+ut,xn=$t+ut;if(ba=ba&&this.isOffscreen(Xt,Lr,fn,xn),ua=ua||this.isInsideGrid(Xt,Lr,fn,xn),!pt&&this.grid.hitTestCircle(Lt,$t,ut,Qr)&&(Js=!0,!Sr))return{circles:[],offscreen:!1,collisionDetected:Js,occluded:!1}}}}return{circles:!Sr&&Js||!ua?[]:kn,offscreen:ba,collisionDetected:Js,occluded:ss.occluded}}queryRenderedSymbols(ut){if(0===ut.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const pt=[];let wt=1/0,Tt=1/0,St=-1/0,It=-1/0;for(const Lt of ut){const ut=new Ye.P(Lt.x+wu,Lt.y+wu);wt=Math.min(wt,ut.x),Tt=Math.min(Tt,ut.y),St=Math.max(St,ut.x),It=Math.max(It,ut.y),pt.push(ut)}const Lt=this.grid.query(wt,Tt,St,It).concat(this.ignoredGrid.query(wt,Tt,St,It)),$t={},Xt={};for(const ut of Lt){const wt=ut.key;if(void 0===$t[wt.bucketInstanceId]&&($t[wt.bucketInstanceId]={}),$t[wt.bucketInstanceId][wt.featureIndex])continue;const Tt=[new Ye.P(ut.x1,ut.y1),new Ye.P(ut.x2,ut.y1),new Ye.P(ut.x2,ut.y2),new Ye.P(ut.x1,ut.y2)];Ye.cG(pt,Tt)&&($t[wt.bucketInstanceId][wt.featureIndex]=!0,void 0===Xt[wt.bucketInstanceId]&&(Xt[wt.bucketInstanceId]=[]),Xt[wt.bucketInstanceId].push(wt.featureIndex))}return Xt}insertCollisionBox(Ye,ut,pt,wt,Tt){(ut?this.ignoredGrid:this.grid).insert({bucketInstanceId:pt,featureIndex:wt,collisionGroupID:Tt},Ye[0],Ye[1],Ye[2],Ye[3])}insertCollisionCircles(Ye,ut,pt,wt,Tt){const St=ut?this.ignoredGrid:this.grid,It={bucketInstanceId:pt,featureIndex:wt,collisionGroupID:Tt};for(let ut=0;ut<Ye.length;ut+=4)St.insertCircle(It,Ye[ut],Ye[ut+1],Ye[ut+2])}projectAndGetPerspectiveRatio(ut,pt,wt,Tt,St,It,Lt){const $t=[pt,wt,Tt,1];let Xt=!1;if(Tt||this.transform.pitch>0){if(Ye.aA.transformMat4($t,$t,ut),this.fogState&&St&&"globe"!==Lt.name){const ut=function(ut,pt,wt,Tt,St,It){const Lt=It.calculateFogTileMatrix(St),$t=[pt,wt,Tt];return Ye._.transformMat4($t,$t,Lt),ot(ut,Ye._.length($t),It.pitch,It._fov)}(this.fogState,pt,wt,Tt,St.toUnwrapped(),this.transform);Xt=ut>.9}}else hi($t,$t,ut);const Sr=$t[3];return{point:new Ye.P(($t[0]/Sr+1)/2*this.transform.width+wu,(-$t[1]/Sr+1)/2*this.transform.height+wu),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(Lt)/Sr*.5,1.5),signedDistanceFromCamera:Sr,occluded:It&&$t[2]>Sr||Xt}}isOffscreen(Ye,ut,pt,wt){return pt<wu||Ye>=this.screenRightBoundary||wt<wu||ut>this.screenBottomBoundary}isInsideGrid(Ye,ut,pt,wt){return pt>=0&&Ye<this.gridRightBoundary&&wt>=0&&ut<this.gridBottomBoundary}getViewportMatrix(){const ut=Ye.ad.identity([]);return Ye.ad.translate(ut,ut,[-100,-100,0]),ut}}class ea{constructor(Ye,ut,pt,wt){this.opacity=Ye?Math.max(0,Math.min(1,Ye.opacity+(Ye.placed?ut:-ut))):wt&&pt?1:0,this.placed=pt}isHidden(){return 0===this.opacity&&!this.placed}}class ta{constructor(Ye,ut,pt,wt,Tt,St=!1){this.text=new ea(Ye?Ye.text:null,ut,pt,Tt),this.icon=new ea(Ye?Ye.icon:null,ut,wt,Tt),this.clipped=St}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ia{constructor(Ye,ut,pt,wt=!1){this.text=Ye,this.icon=ut,this.skipFade=pt,this.clipped=wt}}class oa{constructor(){this.invProjMatrix=Ye.ad.create(),this.viewportMatrix=Ye.ad.create(),this.circles=[]}}class ra{constructor(Ye,ut,pt,wt,Tt){this.bucketInstanceId=Ye,this.featureIndex=ut,this.sourceLayerIndex=pt,this.bucketIndex=wt,this.tileID=Tt}}class aa{constructor(Ye){this.crossSourceCollisions=Ye,this.maxGroupID=0,this.collisionGroups={}}get(Ye){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[Ye]){const ut=++this.maxGroupID;this.collisionGroups[Ye]={ID:ut,predicate:Ye=>Ye.collisionGroupID===ut}}return this.collisionGroups[Ye]}}function na(ut,pt,wt,Tt,St){const{horizontalAlign:It,verticalAlign:Lt}=Ye.bQ(ut),$t=-(It-.5)*pt,Xt=-(Lt-.5)*wt,Sr=Ye.bP(ut,Tt);return new Ye.P($t+Sr[0]*St,Xt+Sr[1]*St)}function sa(ut,pt,wt,Tt,St){const It=new Ye.P(ut,pt);return wt&&It._rotate(Tt?St:-St),It}class la{constructor(Ye,ut,pt,wt,Tt,St){this.transform=Ye.clone(),this.projection=Ye.projection.name,this.collisionIndex=new Jr(this.transform,Tt),this.buildingIndex=St,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=ut,this.retainedQueryData={},this.collisionGroups=new aa(pt),this.collisionCircleArrays={},this.prevPlacement=wt,wt&&(wt.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(ut,pt,wt,Tt){const St=wt.getBucket(pt),It=wt.latestFeatureIndex;if(!St||!It||pt.fqid!==St.layerIds[0])return;const Lt=St.layers[0].layout,$t=wt.collisionBoxArray,Xt=Math.pow(2,this.transform.zoom-wt.tileID.overscaledZ),Sr=wt.tileSize/Ye.a3,Lr=wt.tileID.toUnwrapped();this.transform.setProjection(St.projection);const Qr=(fn=wt.tileID,xn=St.getProjection(),vn=this.transform,xn.name===this.projection?vn.calculateProjMatrix(fn.toUnwrapped()):bo(vn,xn,fn));var fn,xn,vn;const kn="map"===Lt.get("text-pitch-alignment"),Wn="map"===Lt.get("text-rotation-alignment");pt.compileFilter();const Xn=pt.dynamicFilter(),Jn=pt.dynamicFilterNeedsFeature(),Qn=this.transform.calculatePixelsToTileUnitsMatrix(wt),ko=Kt(Qr,wt.tileID.canonical,kn,Wn,this.transform,St.getProjection(),Qn);let Fo=null;if(kn){const ut=Qt(Qr,wt.tileID.canonical,kn,Wn,this.transform,St.getProjection(),Qn);Fo=Ye.ad.multiply([],this.transform.labelPlaneMatrix,ut)}let is=null;Xn&&wt.latestFeatureIndex&&(is={unwrappedTileID:Lr,dynamicFilter:Xn,dynamicFilterNeedsFeature:Jn,featureIndex:wt.latestFeatureIndex}),this.retainedQueryData[St.bucketInstanceId]=new ra(St.bucketInstanceId,It,St.sourceLayerIndex,St.index,wt.tileID);const ns={bucket:St,layout:Lt,posMatrix:Qr,textLabelPlaneMatrix:ko,labelToScreenMatrix:Fo,clippingData:is,scale:Xt,textPixelRatio:Sr,holdingForFade:wt.holdingForFade(),collisionBoxArray:$t,partiallyEvaluatedTextSize:Ye.aD(St.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:Ye.aD(St.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(St.sourceID)};if(Tt)for(const Ye of St.sortKeyRanges){const{sortKey:pt,symbolInstanceStart:wt,symbolInstanceEnd:Tt}=Ye;ut.push({sortKey:pt,symbolInstanceStart:wt,symbolInstanceEnd:Tt,parameters:ns})}else ut.push({symbolInstanceStart:0,symbolInstanceEnd:St.symbolInstances.length,parameters:ns})}attemptAnchorPlacement(Ye,ut,pt,wt,Tt,St,It,Lt,$t,Xt,Sr,Lr,Qr,fn,xn,vn,kn,Wn){const{textOffset0:Xn,textOffset1:Jn,crossTileID:Qn}=Lr,ko=[Xn,Jn],Fo=na(Ye,pt,wt,ko,Tt),is=this.collisionIndex.placeCollisionBox(fn,Tt,ut,sa(Fo.x,Fo.y,St,It,this.transform.angle),Sr,Lt,$t,Xt.predicate);if(vn){const Ye=fn.getSymbolInstanceIconSize(Wn,this.transform.zoom,Lr.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(fn,Ye,vn,sa(Fo.x,Fo.y,St,It,this.transform.angle),Sr,Lt,$t,Xt.predicate).box.length)return}if(is.box.length>0){let ut;return this.prevPlacement&&this.prevPlacement.variableOffsets[Qn]&&this.prevPlacement.placements[Qn]&&this.prevPlacement.placements[Qn].text&&(ut=this.prevPlacement.variableOffsets[Qn].anchor),this.variableOffsets[Qn]={textOffset:ko,width:pt,height:wt,anchor:Ye,textScale:Tt,prevAnchor:ut},this.markUsedJustification(fn,Ye,Lr,xn),fn.allowVerticalPlacement&&(this.markUsedOrientation(fn,xn,Lr),this.placedOrientations[Qn]=xn),{shift:Fo,placedGlyphBoxes:is}}}placeLayerBucketPart(ut,pt,wt,Tt){const{bucket:St,layout:It,posMatrix:Lt,textLabelPlaneMatrix:$t,labelToScreenMatrix:Xt,clippingData:Sr,textPixelRatio:Lr,holdingForFade:Qr,collisionBoxArray:fn,partiallyEvaluatedTextSize:xn,partiallyEvaluatedIconSize:vn,collisionGroup:kn}=ut.parameters,Wn=It.get("text-optional"),Xn=It.get("icon-optional"),Jn=It.get("text-allow-overlap"),Qn=It.get("icon-allow-overlap"),ko="map"===It.get("text-rotation-alignment"),Fo="map"===It.get("text-pitch-alignment"),is="viewport-y"===It.get("symbol-z-order"),ns=It.get("symbol-z-elevate");this.transform.setProjection(St.projection);let ss=Jn&&(Qn||!St.hasIconData()||Xn),as=Qn&&(Jn||!St.hasTextData()||Wn);!St.collisionArrays&&fn&&St.deserializeCollisionBoxes(fn),wt&&Tt&&St.updateCollisionDebugBuffers(this.transform.zoom,fn);const I=(ut,Tt,fn)=>{const{crossTileID:is,numVerticalGlyphVertices:ns}=ut;if(Sr){const wt={zoom:this.transform.zoom,pitch:this.transform.pitch};let Tt=null;if(Sr.dynamicFilterNeedsFeature){const Ye=this.retainedQueryData[St.bucketInstanceId];Tt=Sr.featureIndex.loadFeature({featureIndex:ut.featureIndex,bucketIndex:Ye.bucketIndex,sourceLayerIndex:Ye.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,Sr.dynamicFilter)(wt,Tt,this.retainedQueryData[St.bucketInstanceId].tileID.canonical,new Ye.P(ut.tileAnchorX,ut.tileAnchorY),this.transform.calculateDistanceTileData(Sr.unwrappedTileID)))return this.placements[is]=new ia(!1,!1,!1,!0),void pt.add(is)}if(pt.has(is))return;if(Qr)return void(this.placements[is]=new ia(!1,!1,!1));let ds=!1,ps=!1,ms=!0,Js=!1,ua=!1,ba=null,Ra={box:null,offscreen:null,occluded:null},La={box:null,offscreen:null,occluded:null},ll=null,yl=null,Tl=null,Al=0,Il=0,Pl=0;fn.textFeatureIndex?Al=fn.textFeatureIndex:ut.useRuntimeCollisionCircles&&(Al=ut.featureIndex),fn.verticalTextFeatureIndex&&(Il=fn.verticalTextFeatureIndex);const G=Ye=>{Ye.tileID=this.retainedQueryData[St.bucketInstanceId].tileID;const pt=this.transform.elevation;Ye.elevation=ut.zOffset+(pt?pt.getAtTileOffset(Ye.tileID,Ye.tileAnchorX,Ye.tileAnchorY):0)},ec=fn.textBox;if(ec){G(ec);const i=pt=>{let wt=Ye.aE.horizontal;if(St.allowVerticalPlacement&&!pt&&this.prevPlacement){const Ye=this.prevPlacement.placedOrientations[is];Ye&&(this.placedOrientations[is]=Ye,wt=Ye,this.markUsedOrientation(St,wt,ut))}return wt},o=(ut,pt)=>{if(St.allowVerticalPlacement&&ns>0&&fn.verticalTextBox){for(const wt of St.writingModes)if(wt===Ye.aE.vertical?(Ra=pt(),La=Ra):Ra=ut(),Ra&&Ra.box&&Ra.box.length)break}else Ra=ut()};if(It.get("text-variable-anchor")){let pt=It.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[is]){const Ye=this.prevPlacement.variableOffsets[is];pt.indexOf(Ye.anchor)>0&&(pt=pt.filter((ut=>ut!==Ye.anchor)),pt.unshift(Ye.anchor))}const c=(Ye,wt,It)=>{const $t=St.getSymbolInstanceTextSize(xn,ut,this.transform.zoom,Tt),Xt=(Ye.x2-Ye.x1)*$t+2*Ye.padding,Sr=(Ye.y2-Ye.y1)*$t+2*Ye.padding,Qr=ut.hasIconTextFit&&!Qn?wt:null;Qr&&G(Qr);let fn={box:[],offscreen:!1,occluded:!1};const Wn=Jn?2*pt.length:pt.length;for(let wt=0;wt<Wn;++wt){const Wn=this.attemptAnchorPlacement(pt[wt%pt.length],Ye,Xt,Sr,$t,ko,Fo,Lr,Lt,kn,wt>=pt.length,ut,Tt,St,It,Qr,xn,vn);if(Wn&&(fn=Wn.placedGlyphBoxes,fn&&fn.box&&fn.box.length)){ds=!0,ba=Wn.shift;break}}return fn};o((()=>c(ec,fn.iconBox,Ye.aE.horizontal)),(()=>{const ut=fn.verticalTextBox;return ut&&G(ut),St.allowVerticalPlacement&&!(Ra&&Ra.box&&Ra.box.length)&&ns>0&&ut?c(ut,fn.verticalIconBox,Ye.aE.vertical):{box:null,offscreen:null,occluded:null}})),Ra&&(ds=Ra.box,ms=Ra.offscreen,Js=Ra.occluded);const wt=i(!(!Ra||!Ra.box));if(!ds&&this.prevPlacement){const Ye=this.prevPlacement.variableOffsets[is];Ye&&(this.variableOffsets[is]=Ye,this.markUsedJustification(St,Ye.anchor,ut,wt))}}else{const n=(pt,wt)=>{const It=St.getSymbolInstanceTextSize(xn,ut,this.transform.zoom,Tt),$t=this.collisionIndex.placeCollisionBox(St,It,pt,new Ye.P(0,0),Jn,Lr,Lt,kn.predicate);return $t&&$t.box&&$t.box.length&&(this.markUsedOrientation(St,wt,ut),this.placedOrientations[is]=wt),$t};o((()=>n(ec,Ye.aE.horizontal)),(()=>{const ut=fn.verticalTextBox;return St.allowVerticalPlacement&&ns>0&&ut?(G(ut),n(ut,Ye.aE.vertical)):{box:null,offscreen:null,occluded:null}})),i(!!(Ra&&Ra.box&&Ra.box.length))}}if(ll=Ra,ds=ll&&ll.box&&ll.box.length>0,ms=ll&&ll.offscreen,Js=ll&&ll.occluded,ut.useRuntimeCollisionCircles){const pt=St.text.placedSymbolArray.get(ut.centerJustifiedTextSymbolIndex>=0?ut.centerJustifiedTextSymbolIndex:ut.verticalPlacedTextSymbolIndex),Tt=Ye.aF(St.textSizeData,xn,pt),Sr=It.get("text-padding");yl=this.collisionIndex.placeCollisionCircles(St,Jn,pt,St.lineVertexArray,St.glyphOffsetArray,Tt,Lt,$t,Xt,wt,Fo,kn.predicate,ut.collisionCircleDiameter*Tt/Ye.bN,Sr,this.retainedQueryData[St.bucketInstanceId].tileID),ds=Jn||yl.circles.length>0&&!yl.collisionDetected,ms=ms&&yl.offscreen,Js=yl.occluded}if(fn.iconFeatureIndex&&(Pl=fn.iconFeatureIndex),fn.iconBox){const i=pt=>{G(pt);const wt=ut.hasIconTextFit&&ba?sa(ba.x,ba.y,ko,Fo,this.transform.angle):new Ye.P(0,0),Tt=St.getSymbolInstanceIconSize(vn,this.transform.zoom,ut.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(St,Tt,pt,wt,Qn,Lr,Lt,kn.predicate)};La&&La.box&&La.box.length&&fn.verticalIconBox?(Tl=i(fn.verticalIconBox),ps=Tl.box.length>0):(Tl=i(fn.iconBox),ps=Tl.box.length>0),ms=ms&&Tl.offscreen,ua=Tl.occluded}const tc=Wn||0===ut.numHorizontalGlyphVertices&&0===ns,ic=Xn||0===ut.numIconVertices;if(tc||ic?ic?tc||(ps=ps&&ds):ds=ps&&ds:ps=ds=ps&&ds,ds&&ll&&ll.box&&this.collisionIndex.insertCollisionBox(ll.box,It.get("text-ignore-placement"),St.bucketInstanceId,La&&La.box&&Il?Il:Al,kn.ID),ps&&Tl&&this.collisionIndex.insertCollisionBox(Tl.box,It.get("icon-ignore-placement"),St.bucketInstanceId,Pl,kn.ID),yl&&(ds&&this.collisionIndex.insertCollisionCircles(yl.circles,It.get("text-ignore-placement"),St.bucketInstanceId,Al,kn.ID),wt)){const Ye=St.bucketInstanceId;let ut=this.collisionCircleArrays[Ye];void 0===ut&&(ut=this.collisionCircleArrays[Ye]=new oa);for(let Ye=0;Ye<yl.circles.length;Ye+=4)ut.circles.push(yl.circles[Ye+0]),ut.circles.push(yl.circles[Ye+1]),ut.circles.push(yl.circles[Ye+2]),ut.circles.push(yl.collisionDetected?1:0)}const nc="globe"!==St.projection.name;ss=ss&&(nc||!Js),as=as&&(nc||!ua),this.placements[is]=new ia(ds||ss,ps||as,ms||St.justReloaded),pt.add(is)};if(ns&&this.buildingIndex&&(this.buildingIndex.updateZOffset(St,this.retainedQueryData[St.bucketInstanceId].tileID),St.updateZOffset()),is){const ut=St.getSortedSymbolIndexes(this.transform.angle);for(let Ye=ut.length-1;Ye>=0;--Ye){const pt=ut[Ye];I(St.symbolInstances.get(pt),pt,St.collisionArrays[pt])}St.hasAnyZOffset&&Ye.w(`${St.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(St.hasAnyZOffset){const Ye=St.getSortedIndexesByZOffset();for(let ut=0;ut<Ye.length;++ut){const pt=Ye[ut];I(St.symbolInstances.get(pt),pt,St.collisionArrays[pt])}}else for(let Ye=ut.symbolInstanceStart;Ye<ut.symbolInstanceEnd;Ye++)I(St.symbolInstances.get(Ye),Ye,St.collisionArrays[Ye]);if(wt&&St.bucketInstanceId in this.collisionCircleArrays){const ut=this.collisionCircleArrays[St.bucketInstanceId];Ye.ad.invert(ut.invProjMatrix,Lt),ut.viewportMatrix=this.collisionIndex.getViewportMatrix()}St.justReloaded=!1}markUsedJustification(ut,pt,wt,Tt){const{leftJustifiedTextSymbolIndex:St,centerJustifiedTextSymbolIndex:It,rightJustifiedTextSymbolIndex:Lt,verticalPlacedTextSymbolIndex:$t,crossTileID:Xt}=wt,Sr=Ye.cJ(pt),Lr=Tt===Ye.aE.vertical?$t:"left"===Sr?St:"center"===Sr?It:"right"===Sr?Lt:-1;St>=0&&(ut.text.placedSymbolArray.get(St).crossTileID=Lr>=0&&St!==Lr?0:Xt),It>=0&&(ut.text.placedSymbolArray.get(It).crossTileID=Lr>=0&&It!==Lr?0:Xt),Lt>=0&&(ut.text.placedSymbolArray.get(Lt).crossTileID=Lr>=0&&Lt!==Lr?0:Xt),$t>=0&&(ut.text.placedSymbolArray.get($t).crossTileID=Lr>=0&&$t!==Lr?0:Xt)}markUsedOrientation(ut,pt,wt){const Tt=pt===Ye.aE.horizontal||pt===Ye.aE.horizontalOnly?pt:0,St=pt===Ye.aE.vertical?pt:0,{leftJustifiedTextSymbolIndex:It,centerJustifiedTextSymbolIndex:Lt,rightJustifiedTextSymbolIndex:$t,verticalPlacedTextSymbolIndex:Xt}=wt,Sr=ut.text.placedSymbolArray;It>=0&&(Sr.get(It).placedOrientation=Tt),Lt>=0&&(Sr.get(Lt).placedOrientation=Tt),$t>=0&&(Sr.get($t).placedOrientation=Tt),Xt>=0&&(Sr.get(Xt).placedOrientation=St)}commit(Ye){this.commitTime=Ye,this.zoomAtLastRecencyCheck=this.transform.zoom;const ut=this.prevPlacement;let pt=!1;this.prevZoomAdjustment=ut?ut.zoomAdjustment(this.transform.zoom):0;const wt=ut?ut.symbolFadeChange(Ye):1,Tt=ut?ut.opacities:{},St=ut?ut.variableOffsets:{},It=ut?ut.placedOrientations:{};for(const Ye in this.placements){const ut=this.placements[Ye],St=Tt[Ye];St?(this.opacities[Ye]=new ta(St,wt,ut.text,ut.icon,null,ut.clipped),pt=pt||ut.text!==St.text.placed||ut.icon!==St.icon.placed):(this.opacities[Ye]=new ta(null,wt,ut.text,ut.icon,ut.skipFade,ut.clipped),pt=pt||ut.text||ut.icon)}for(const Ye in Tt){const ut=Tt[Ye];if(!this.opacities[Ye]){const Tt=new ta(ut,wt,!1,!1);Tt.isHidden()||(this.opacities[Ye]=Tt,pt=pt||ut.text.placed||ut.icon.placed)}}for(const Ye in St)this.variableOffsets[Ye]||!this.opacities[Ye]||this.opacities[Ye].isHidden()||(this.variableOffsets[Ye]=St[Ye]);for(const Ye in It)this.placedOrientations[Ye]||!this.opacities[Ye]||this.opacities[Ye].isHidden()||(this.placedOrientations[Ye]=It[Ye]);pt?this.lastPlacementChangeTime=Ye:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=ut?ut.lastPlacementChangeTime:Ye)}updateLayerOpacities(Ye,ut,pt,wt){const Tt=new Set;for(const St of ut){const ut=St.getBucket(Ye);ut&&St.latestFeatureIndex&&Ye.fqid===ut.layerIds[0]&&(this.updateBucketOpacities(ut,Tt,St.collisionBoxArray,pt,wt,St.tileID),ut.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(ut,St.tileID),ut.updateZOffset()))}}updateBucketOpacities(ut,pt,wt,Tt,St,It){ut.hasTextData()&&ut.text.opacityVertexArray.clear(),ut.hasIconData()&&ut.icon.opacityVertexArray.clear(),ut.hasIconCollisionBoxData()&&ut.iconCollisionBox.collisionVertexArray.clear(),ut.hasTextCollisionBoxData()&&ut.textCollisionBox.collisionVertexArray.clear();const Lt=ut.layers[0].layout,$t=!!ut.layers[0].dynamicFilter(),Xt=new ta(null,0,!1,!1,!0),Sr=Lt.get("text-allow-overlap"),Lr=Lt.get("icon-allow-overlap"),Qr=Lt.get("text-variable-anchor"),fn="map"===Lt.get("text-rotation-alignment"),xn="map"===Lt.get("text-pitch-alignment"),vn=new ta(null,0,Sr&&(Lr||!ut.hasIconData()||Lt.get("icon-optional")),Lr&&(Sr||!ut.hasTextData()||Lt.get("text-optional")),!0);!ut.collisionArrays&&wt&&(ut.hasIconCollisionBoxData()||ut.hasTextCollisionBoxData())&&ut.deserializeCollisionBoxes(wt);const m=(Ye,ut,pt)=>{for(let wt=0;wt<ut/4;wt++)Ye.opacityVertexArray.emplaceBack(pt)};let kn=0;St&&ut.updateReplacement(It,St);for(let wt=0;wt<ut.symbolInstances.length;wt++){const Lt=ut.symbolInstances.get(wt),{numHorizontalGlyphVertices:Sr,numVerticalGlyphVertices:Lr,crossTileID:Wn,numIconVertices:Xn,tileAnchorX:Jn,tileAnchorY:Qn}=Lt,ko=pt.has(Wn);let Fo=this.opacities[Wn];ko?Fo=Xt:Fo||(Fo=vn,this.opacities[Wn]=Fo),pt.add(Wn);const is=Sr>0||Lr>0,ns=Xn>0,ss=this.placedOrientations[Wn],as=ss===Ye.aE.vertical,ds=ss===Ye.aE.horizontal||ss===Ye.aE.horizontalOnly;!is&&!ns||Fo.isHidden()||kn++;let ps=!1;if((is||ns)&&St)for(const pt of ut.activeReplacements){if(pt.order<Tt||pt.order===1/0||!(pt.clipMask&Ye.cu.Symbol))continue;if(pt.min.x>Jn||Jn>pt.max.x||pt.min.y>Qn||Qn>pt.max.y)continue;const ut=Ye.cH(Jn,Qn,It.canonical,pt.footprintTileId.canonical);if(ps=Ye.cI(ut,pt),ps)break}if(is){const Ye=ps?ed:ga(Fo.text);m(ut.text,Sr,as?ed:Ye),m(ut.text,Lr,ds?ed:Ye);const pt=Fo.text.isHidden(),{leftJustifiedTextSymbolIndex:wt,centerJustifiedTextSymbolIndex:Tt,rightJustifiedTextSymbolIndex:St,verticalPlacedTextSymbolIndex:It}=Lt,$t=ut.text.placedSymbolArray,Xt=pt||as?1:0;wt>=0&&($t.get(wt).hidden=Xt),Tt>=0&&($t.get(Tt).hidden=Xt),St>=0&&($t.get(St).hidden=Xt),It>=0&&($t.get(It).hidden=pt||ds?1:0);const Qr=this.variableOffsets[Wn];Qr&&this.markUsedJustification(ut,Qr.anchor,Lt,ss);const fn=this.placedOrientations[Wn];fn&&(this.markUsedJustification(ut,"left",Lt,fn),this.markUsedOrientation(ut,fn,Lt))}if(ns){const Ye=ps?ed:ga(Fo.icon),{placedIconSymbolIndex:pt,verticalPlacedIconSymbolIndex:wt}=Lt,Tt=ut.icon.placedSymbolArray,St=Fo.icon.isHidden()?1:0;pt>=0&&(m(ut.icon,Xn,as?ed:Ye),Tt.get(pt).hidden=St),wt>=0&&(m(ut.icon,Lt.numVerticalIconVertices,ds?ed:Ye),Tt.get(wt).hidden=St)}if(ut.hasIconCollisionBoxData()||ut.hasTextCollisionBoxData()){const pt=ut.collisionArrays[wt];if(pt){let wt=new Ye.P(0,0),Tt=!0;if(pt.textBox||pt.verticalTextBox){if(Qr){const Ye=this.variableOffsets[Wn];Ye?(wt=na(Ye.anchor,Ye.width,Ye.height,Ye.textOffset,Ye.textScale),fn&&wt._rotate(xn?this.transform.angle:-this.transform.angle)):Tt=!1}$t&&(Tt=!Fo.clipped),pt.textBox&&ca(ut.textCollisionBox.collisionVertexArray,Fo.text.placed,!Tt||as,wt.x,wt.y),pt.verticalTextBox&&ca(ut.textCollisionBox.collisionVertexArray,Fo.text.placed,!Tt||ds,wt.x,wt.y)}const St=Tt&&Boolean(!ds&&pt.verticalIconBox);pt.iconBox&&ca(ut.iconCollisionBox.collisionVertexArray,Fo.icon.placed,St,Lt.hasIconTextFit?wt.x:0,Lt.hasIconTextFit?wt.y:0),pt.verticalIconBox&&ca(ut.iconCollisionBox.collisionVertexArray,Fo.icon.placed,!St,Lt.hasIconTextFit?wt.x:0,Lt.hasIconTextFit?wt.y:0)}}}if(ut.fullyClipped=0===kn,ut.sortFeatures(this.transform.angle),this.retainedQueryData[ut.bucketInstanceId]&&(this.retainedQueryData[ut.bucketInstanceId].featureSortOrder=ut.featureSortOrder),ut.hasTextData()&&ut.text.opacityVertexBuffer&&ut.text.opacityVertexBuffer.updateData(ut.text.opacityVertexArray),ut.hasIconData()&&ut.icon.opacityVertexBuffer&&ut.icon.opacityVertexBuffer.updateData(ut.icon.opacityVertexArray),ut.hasIconCollisionBoxData()&&ut.iconCollisionBox.collisionVertexBuffer&&ut.iconCollisionBox.collisionVertexBuffer.updateData(ut.iconCollisionBox.collisionVertexArray),ut.hasTextCollisionBoxData()&&ut.textCollisionBox.collisionVertexBuffer&&ut.textCollisionBox.collisionVertexBuffer.updateData(ut.textCollisionBox.collisionVertexArray),ut.bucketInstanceId in this.collisionCircleArrays){const Ye=this.collisionCircleArrays[ut.bucketInstanceId];ut.placementInvProjMatrix=Ye.invProjMatrix,ut.placementViewportMatrix=Ye.viewportMatrix,ut.collisionCircleArray=Ye.circles,delete this.collisionCircleArrays[ut.bucketInstanceId]}}symbolFadeChange(Ye){return 0===this.fadeDuration?1:(Ye-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(Ye){return Math.max(0,(this.transform.zoom-Ye)/1.5)}hasTransitions(Ye){return this.stale||Ye-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(Ye,ut){const pt=this.zoomAtLastRecencyCheck===ut?1-this.zoomAdjustment(ut):1;return this.zoomAtLastRecencyCheck=ut,this.commitTime+this.fadeDuration*pt>Ye}setStale(){this.stale=!0}}function ca(Ye,ut,pt,wt,Tt){Ye.emplaceBack(ut?1:0,pt?1:0,wt||0,Tt||0),Ye.emplaceBack(ut?1:0,pt?1:0,wt||0,Tt||0),Ye.emplaceBack(ut?1:0,pt?1:0,wt||0,Tt||0),Ye.emplaceBack(ut?1:0,pt?1:0,wt||0,Tt||0)}const Tu=Math.pow(2,25),Mu=Math.pow(2,24),Iu=Math.pow(2,17),Fu=Math.pow(2,16),Nu=Math.pow(2,9),ju=Math.pow(2,8),Ju=Math.pow(2,1);function ga(Ye){if(0===Ye.opacity&&!Ye.placed)return 0;if(1===Ye.opacity&&Ye.placed)return 4294967295;const ut=Ye.placed?1:0,pt=Math.floor(127*Ye.opacity);return pt*Tu+ut*Mu+pt*Iu+ut*Fu+pt*Nu+ut*ju+pt*Ju+ut}const ed=0;class xa{constructor(Ye){this._sortAcrossTiles="viewport-y"!==Ye.layout.get("symbol-z-order")&&void 0!==Ye.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(Ye,ut,pt,wt,Tt){const St=this._bucketParts;for(;this._currentTileIndex<Ye.length;)if(ut.getBucketParts(St,wt,Ye[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,Tt())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,St.sort(((Ye,ut)=>Ye.sortKey-ut.sortKey)));this._currentPartIndex<St.length;){const Ye=St[this._currentPartIndex];if(ut.placeLayerBucketPart(Ye,this._seenCrossTileIDs,pt,0===Ye.symbolInstanceStart),this._currentPartIndex++,Tt())return!0}return!1}}class ya{constructor(Ye,ut,pt,wt,Tt,St,It,Lt,$t){this.placement=new la(Ye,Tt,St,It,Lt,$t),this._currentPlacementIndex=ut.length-1,this._forceFullPlacement=pt,this._showCollisionBoxes=wt,this._done=!1}isDone(){return this._done}continuePlacement(ut,pt,wt,Tt){const St=Ye.e.now(),n=()=>{const ut=Ye.e.now()-St;return!this._forceFullPlacement&&ut>2};for(;this._currentPlacementIndex>=0;){const St=pt[ut[this._currentPlacementIndex]],It=this.placement.collisionIndex.transform.zoom;if("symbol"===St.type&&(!St.minzoom||St.minzoom<=It)&&(!St.maxzoom||St.maxzoom>It)){const ut=St,pt=ut.layout.get("symbol-z-elevate"),It=this._inProgressLayer=this._inProgressLayer||new xa(ut),Lt=Ye.al(St.source,St.scope);if(It.continuePlacement(pt?Tt[Lt]:wt[Lt],this.placement,this._showCollisionBoxes,St,n))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(Ye){return this.placement.commit(Ye),this.placement}}const td=512/Ye.a3/2;class wa{constructor(ut,pt,wt){this.tileID=ut,this.bucketInstanceId=wt,this.index=new Ye.cK(pt.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const Tt=ut.canonical.x*Ye.a3,St=ut.canonical.y*Ye.a3;for(let Ye=0;Ye<pt.length;Ye++){const{key:ut,crossTileID:wt,tileAnchorX:It,tileAnchorY:Lt}=pt.get(Ye),$t=Math.floor((Tt+It)*td),Xt=Math.floor((St+Lt)*td);this.index.add($t,Xt),this.keys.push(ut),this.crossTileIDs.push(wt)}this.index.finish()}findMatches(ut,pt,wt){const Tt=this.tileID.canonical.z<pt.canonical.z?1:Math.pow(2,this.tileID.canonical.z-pt.canonical.z),St=td/Math.pow(2,pt.canonical.z-this.tileID.canonical.z),It=pt.canonical.x*Ye.a3,Lt=pt.canonical.y*Ye.a3;for(let Ye=0;Ye<ut.length;Ye++){const pt=ut.get(Ye);if(pt.crossTileID)continue;const{key:$t,tileAnchorX:Xt,tileAnchorY:Sr}=pt,Lr=Math.floor((It+Xt)*St),Qr=Math.floor((Lt+Sr)*St),fn=this.index.range(Lr-Tt,Qr-Tt,Lr+Tt,Qr+Tt);for(const Ye of fn){const ut=this.crossTileIDs[Ye];if(this.keys[Ye]===$t&&!wt.has(ut)){wt.add(ut),pt.crossTileID=ut;break}}}}}class Ta{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Ea{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(Ye){const ut=Math.round((Ye-this.lng)/360);if(0!==ut)for(const Ye in this.indexes){const pt=this.indexes[Ye],wt={};for(const Ye in pt){const Tt=pt[Ye];Tt.tileID=Tt.tileID.unwrapTo(Tt.tileID.wrap+ut),wt[Tt.tileID.key]=Tt}this.indexes[Ye]=wt}this.lng=Ye}addBucket(Ye,ut,pt){if(this.indexes[Ye.overscaledZ]&&this.indexes[Ye.overscaledZ][Ye.key]){if(this.indexes[Ye.overscaledZ][Ye.key].bucketInstanceId===ut.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(Ye.overscaledZ,this.indexes[Ye.overscaledZ][Ye.key])}for(let Ye=0;Ye<ut.symbolInstances.length;Ye++)ut.symbolInstances.get(Ye).crossTileID=0;this.usedCrossTileIDs[Ye.overscaledZ]||(this.usedCrossTileIDs[Ye.overscaledZ]=new Set);const wt=this.usedCrossTileIDs[Ye.overscaledZ];for(const pt in this.indexes){const Tt=this.indexes[pt];if(Number(pt)>Ye.overscaledZ)for(const pt in Tt){const St=Tt[pt];St.tileID.isChildOf(Ye)&&St.findMatches(ut.symbolInstances,Ye,wt)}else{const St=Tt[Ye.scaledTo(Number(pt)).key];St&&St.findMatches(ut.symbolInstances,Ye,wt)}}for(let Ye=0;Ye<ut.symbolInstances.length;Ye++){const Tt=ut.symbolInstances.get(Ye);Tt.crossTileID||(Tt.crossTileID=pt.generate(),wt.add(Tt.crossTileID))}return void 0===this.indexes[Ye.overscaledZ]&&(this.indexes[Ye.overscaledZ]={}),this.indexes[Ye.overscaledZ][Ye.key]=new wa(Ye,ut.symbolInstances,ut.bucketInstanceId),!0}removeBucketCrossTileIDs(Ye,ut){for(const pt of ut.crossTileIDs)this.usedCrossTileIDs[Ye].delete(pt)}removeStaleBuckets(Ye){let ut=!1;for(const pt in this.indexes){const wt=this.indexes[pt];for(const Tt in wt)Ye[wt[Tt].bucketInstanceId]||(this.removeBucketCrossTileIDs(pt,wt[Tt]),delete wt[Tt],ut=!0)}return ut}}class Ca{constructor(){this.layerIndexes={},this.crossTileIDs=new Ta,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(Ye,ut,pt,wt){let Tt=this.layerIndexes[Ye.fqid];void 0===Tt&&(Tt=this.layerIndexes[Ye.fqid]=new Ea);let St=!1;const It={};"globe"!==wt.name&&Tt.handleWrapJump(pt);for(const pt of ut){const ut=pt.getBucket(Ye);ut&&Ye.fqid===ut.layerIds[0]&&(ut.bucketInstanceId||(ut.bucketInstanceId=++this.maxBucketInstanceId),Tt.addBucket(pt.tileID,ut,this.crossTileIDs)&&(St=!0),It[ut.bucketInstanceId]=!0)}return Tt.removeStaleBuckets(It)&&(St=!0),St}pruneUnusedLayers(Ye){const ut={};Ye.forEach((Ye=>{ut[Ye]=!0}));for(const Ye in this.layerIndexes)ut[Ye]||delete this.layerIndexes[Ye]}}const id=new Ye.N({data:new Ye.O(Ye.L.colorTheme.data)}),Ia=(Ye,ut)=>Xe(Ye,ut&&ut.filter((Ye=>"source.canvas"!==Ye.identifier))),rd=Ye.ah(Qh,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","updateImport"]),nd=Ye.ah(Qh,["setCenter","setZoom","setBearing","setPitch"]),od={version:8,layers:[],sources:{}},sd={duration:300,delay:0};class Da extends Ye.E{constructor(ut,pt={}){super(),this.map=ut,this.scope=pt.scope||"",this.globalId=null,this.fragments=[],this.importDepth=pt.importDepth||0,this.importsCache=pt.importsCache||new Map,this.resolvedImports=pt.resolvedImports||new Set,this.transition=Ye.W({},sd),this._buildingIndex=new Nr(this),this.crossTileSymbolIndex=new Ca,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerIndices=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=pt.styleChanges||new v,this.dispatcher=pt.dispatcher?pt.dispatcher:new Ye.bw(Ye.bx(),this),pt.imageManager?this.imageManager=pt.imageManager:(this.imageManager=new _e,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=pt.glyphManager?pt.glyphManager:new Ye.cM(ut._requestManager,pt.localFontFamily?Ye.cN.all:pt.localIdeographFontFamily?Ye.cN.ideographs:Ye.cN.none,pt.localFontFamily||pt.localIdeographFontFamily),pt.modelManager?this.modelManager=pt.modelManager:(this.modelManager=new ce(ut._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null},this._styleColorThemeForScope={},this.options=pt.configOptions?pt.configOptions:new Map,this._configDependentLayers=pt.configDependentLayers?pt.configDependentLayers:new Set,this._config=pt.config,this._initialConfig=pt.initialConfig,this.dispatcher.broadcast("setReferrer",Ye.cO());const wt=this;this._rtlTextPluginCallback=Da.registerForPluginStateChange((ut=>{wt.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:ut.pluginStatus,pluginURL:ut.pluginURL},((ut,pt)=>{if(Ye.cP(ut),pt&&pt.every((Ye=>Ye)))for(const Ye in wt._sourceCaches){const ut=wt._sourceCaches[Ye],pt=ut.getSource().type;"vector"!==pt&&"geojson"!==pt||ut.reload()}}))})),this.on("data",(Ye=>{if("source"!==Ye.dataType||"metadata"!==Ye.sourceDataType)return;const ut=this.getOwnSource(Ye.sourceId);if(ut&&ut.vectorLayerIds)for(const Ye in this._layers){const pt=this._layers[Ye];pt.source===ut.id&&this._validateLayer(pt)}}))}load(Ye){return Ye?("string"==typeof Ye?this.loadURL(Ye):this.loadJSON(Ye),this):this}_getGlobalId(ut){if(!ut)return null;if("string"==typeof ut){if(Ye.cQ(ut))return ut;const pt=Ye.cR(ut);if(!pt.startsWith("http"))try{return new URL(pt,location.href).toString()}catch(Ye){return pt}return pt}return`json://${Ye.cS(JSON.stringify(ut))}`}_diffStyle(ut,pt,wt){this.globalId=this._getGlobalId(ut);const r=(Ye,ut)=>{try{ut(null,this.setState(Ye,wt))}catch(Ye){ut(Ye,!1)}};if("string"==typeof ut){const wt=this.map._requestManager.normalizeStyleURL(ut),Tt=this.map._requestManager.transformRequest(wt,Ye.R.Style);Ye.g(Tt,((ut,wt)=>{ut?this.fire(new Ye.d(ut)):wt&&r(wt,pt)}))}else"object"==typeof ut&&r(ut,pt)}loadURL(ut,pt={}){this.fire(new Ye.f("dataloading",{dataType:"style"}));const wt="boolean"==typeof pt.validate?pt.validate:!Ye.cQ(ut);this.globalId=this._getGlobalId(ut),ut=this.map._requestManager.normalizeStyleURL(ut,pt.accessToken),this.resolvedImports.add(ut);const Tt=this.importsCache.get(ut);if(Tt)return this._load(Tt,wt);const St=this.map._requestManager.transformRequest(ut,Ye.R.Style);this._request=Ye.g(St,((pt,Tt)=>{if(this._request=null,pt)this.fire(new Ye.d(pt));else if(Tt)return this.importsCache.set(ut,Tt),this._load(Tt,wt)}))}loadJSON(ut,pt={}){this.fire(new Ye.f("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(ut),this._request=Ye.e.frame((()=>{this._request=null,this._load(ut,!1!==pt.validate)}))}loadEmpty(){this.fire(new Ye.f("dataloading",{dataType:"style"})),this._load(od,!1)}_loadImports(ut,pt,wt){if(this.importDepth>=4)return Ye.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const Tt=[];for(const Ye of ut){const ut=this._createFragmentStyle(Ye),St=new Promise((Ye=>{ut.once("style.import.load",Ye),ut.once("error",Ye)})).then((()=>this.mergeAll()));if(Tt.push(St),this.resolvedImports.has(Ye.url)){ut.loadEmpty();continue}const It=Ye.data||this.importsCache.get(Ye.url);It?(ut.loadJSON(It,{validate:pt}),this._isInternalStyle(It)&&(ut.globalId=null)):Ye.url?ut.loadURL(Ye.url,{validate:pt}):ut.loadEmpty();const Lt={style:ut,id:Ye.id,config:Ye.config};if(wt){const Ye=this.fragments.findIndex((({id:Ye})=>Ye===wt));this.fragments=this.fragments.slice(0,Ye).concat(Lt).concat(this.fragments.slice(Ye))}else this.fragments.push(Lt)}return Promise.allSettled(Tt)}getImportGlobalIds(Ye=this,ut=new Set){for(const pt of Ye.fragments)pt.style.globalId&&ut.add(pt.style.globalId),this.getImportGlobalIds(pt.style,ut);return[...ut.values()]}_createFragmentStyle(ut){const pt=this.scope?Ye.al(ut.id,this.scope):ut.id;let wt;const Tt=this._initialConfig&&this._initialConfig[pt];(ut.config||Tt)&&(wt=Ye.W({},ut.config,Tt));const St=new Da(this.map,{scope:pt,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:wt,configOptions:this.options,configDependentLayers:this._configDependentLayers});return St.setEventedParent(this.map,{style:St}),St}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.isRootStyle()}_isInternalStyle(Ye){return this.isRootStyle()&&(Ye.fragment||!!Ye.schema&&!1!==Ye.fragment)}_load(ut,pt){const wt=ut.schema;if(this._isInternalStyle(ut)){const wt=Ye.W({},od,{imports:[{id:"basemap",data:ut,url:""}]});return void this._load(wt,pt)}if(this.updateConfig(this._config,wt),pt&&Ia(this,Be(ut)))return;this._loaded=!0,this.stylesheet=Ye.cT(ut);const r=()=>{for(const Ye in ut.sources)this.addSource(Ye,ut.sources[Ye],{validate:!1,isInitialLoad:!0});ut.sprite?this._loadSprite(ut.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(ut.glyphs,this.scope);const wt=Gr(this.stylesheet.layers);if(this._order=wt.map((Ye=>Ye.id)),this.stylesheet.light&&Ye.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const Ye=this.stylesheet.lights[0];this.light=new Ke(Ye.properties,Ye.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Ke(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const ut of wt){const pt=Ye.cY(ut,this.scope,this._styleColorTheme.lut,this.options);pt.isConfigDependent&&this._configDependentLayers.add(pt.fqid),pt.setEventedParent(this,{layer:{id:pt.id}}),this._layers[pt.id]=pt,this._serializedLayers[pt.id]=pt.serialize();const wt=this.getOwnLayerSourceCache(pt),Tt=!!this.directionalLight&&this.directionalLight.shadowsEnabled();wt&&pt.canCastShadows()&&Tt&&(wt.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const Tt=this.stylesheet.terrain;Tt&&(this.checkCanvasFingerprintNoise(),this.terrainSetForDrapingOnly()||this._createTerrain(Tt,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new Ye.f("data",{dataType:"style"}));const St=this.isRootStyle();ut.imports?this._loadImports(ut.imports,pt).then((()=>{this._reloadImports(),this.fire(new Ye.f(St?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new Ye.f(St?"style.load":"style.import.load")))},Tt=this.stylesheet["color-theme"];if(this._styleColorTheme.colorTheme=Tt,Tt){const ut=this._evaluateColorThemeData(Tt);this._loadColorTheme(ut).then((()=>{r()})).catch((ut=>{Ye.w(`Couldn't load color theme from the stylesheet: ${ut}`),r()}))}else this._styleColorTheme.lut=null,r()}isRootStyle(){return 0===this.importDepth}mergeAll(){let ut,pt,wt,Tt,St,It,Lt,$t;const Xt={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((Ye=>{if(Ye.stylesheet){if(null!=Ye.light&&(ut=Ye.light),Ye.stylesheet.lights)for(const ut of Ye.stylesheet.lights)"ambient"===ut.type&&null!=Ye.ambientLight&&(pt=Ye.ambientLight),"directional"===ut.type&&null!=Ye.directionalLight&&(wt=Ye.directionalLight);Tt=this._prioritizeTerrain(Tt,Ye.terrain,Ye.stylesheet.terrain),Ye.stylesheet.fog&&null!=Ye.fog&&(St=Ye.fog),null!=Ye.stylesheet.camera&&($t=Ye.stylesheet.camera),null!=Ye.stylesheet.projection&&(It=Ye.stylesheet.projection),null!=Ye.stylesheet.transition&&(Lt=Ye.stylesheet.transition),Xt[Ye.scope]=Ye._styleColorTheme}})),this.light=ut,this.ambientLight=pt,this.directionalLight=wt,this.fog=St,this._styleColorThemeForScope=Xt,null===Tt?delete this.terrain:this.terrain=Tt,this.camera=$t||{"camera-projection":"perspective"},this.projection=It||{name:"mercator"},this.transition=Ye.W({},sd,Lt),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(Ye){const t=ut=>{for(const Ye of ut.fragments)t(Ye.style);Ye(ut)};t(this)}_prioritizeTerrain(Ye,ut,pt){const wt=Ye&&0===Ye.drapeRenderMode;return null===pt?ut&&0===ut.drapeRenderMode?ut:wt?Ye:null:null!=ut&&(!Ye||wt||ut&&1===ut.drapeRenderMode)?ut:Ye}mergeTerrain(){let Ye;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((ut=>{Ye=this._prioritizeTerrain(Ye,ut.terrain,ut.stylesheet.terrain)})),null===Ye?delete this.terrain:this.terrain=Ye}mergeProjection(){let Ye;this.forEachFragmentStyle((ut=>{null!=ut.stylesheet.projection&&(Ye=ut.stylesheet.projection)})),this.projection=Ye||{name:"mercator"}}mergeSources(){const ut={},pt={},wt={};this.forEachFragmentStyle((Tt=>{for(const pt in Tt._sourceCaches){const wt=Ye.al(pt,Tt.scope);ut[wt]=Tt._sourceCaches[pt]}for(const ut in Tt._otherSourceCaches){const wt=Ye.al(ut,Tt.scope);pt[wt]=Tt._otherSourceCaches[ut]}for(const ut in Tt._symbolSourceCaches){const pt=Ye.al(ut,Tt.scope);wt[pt]=Tt._symbolSourceCaches[ut]}})),this._mergedSourceCaches=ut,this._mergedOtherSourceCaches=pt,this._mergedSymbolSourceCaches=wt}mergeLayers(){const ut={},pt=[],wt={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((wt=>{for(const Tt of wt._order){const St=wt._layers[Tt];if("slot"===St.type){const pt=Ye.cU(Tt);if(ut[pt])continue;ut[pt]=[]}St.slot&&ut[St.slot]?ut[St.slot].push(St):pt.push(St)}})),this._mergedOrder=[],this._clipLayerIndices=[];let Tt=0;const a=(pt=[])=>{for(const St of pt)if("slot"===St.type){const pt=Ye.cU(St.id);ut[pt]&&a(ut[pt]),this._mergedSlots.push(pt)}else{const ut=Ye.al(St.id,St.scope);this._mergedOrder.push(ut),wt[ut]=St,St.is3D()&&(this._has3DLayers=!0),"circle"===St.type&&(this._hasCircleLayers=!0),"symbol"===St.type&&(this._hasSymbolLayers=!0),"clip"===St.type&&this._clipLayerIndices.push(Tt),Tt++}};a(pt),this._mergedLayers=wt,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(ut){return this.stylesheet.camera=Ye.W({},this.stylesheet.camera,ut),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(ut){return ut.data?function(ut,pt,wt){const Tt=Ye.W({},pt);for(const ut of Object.keys(Ye.L.colorTheme))void 0===Tt[ut]&&(Tt[ut]=Ye.L.colorTheme[ut].default);const St=new Ye.U(id,ut,new Map(wt));return St.setTransitionOrValue(Tt,wt),St.untransitioned().possiblyEvaluate(new Ye.X(0))}(this.scope,ut,this.options).get("data"):null}_loadColorTheme(ut){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const pt=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((wt,Tt)=>{const St="data:image/png;base64,";if(!ut||0===ut.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void wt();let It=ut;It.startsWith(St)||(It=St+It);const Lt="mapbox-reserved-lut",$t=new Image;$t.src=It,$t.onerror=()=>{this._styleColorTheme.lutLoading=!1,Tt(new Error("Failed to load image data"))},$t.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==pt)return void wt();this._styleColorTheme.lutLoading=!1;const{width:St,height:It,data:Xt}=Ye.e.getImageData($t);if(It>32)return void Tt(new Error("The height of the image must be less than or equal to 32 pixels."));if(St!==It*It)return void Tt(new Error("The width of the image must be equal to the height squared."));this.getImage(Lt)&&this.removeImage(Lt),this.addImage(Lt,{data:new Ye.i({width:St,height:It},Xt),pixelRatio:1,sdf:!1,version:0});const Sr=this.imageManager.getImage(Lt,this.scope);Sr?(this._styleColorTheme.lut={image:Sr.data,data:ut},wt()):Tt(new Error("Missing LUT image."))}}))}getLut(Ye){const ut=this._styleColorThemeForScope[Ye];return ut?ut.lut:null}setProjection(Ye){Ye?this.stylesheet.projection=Ye:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(ut){this._spriteRequest=function(ut,pt,wt){let Tt,St,It;const Lt=Ye.e.devicePixelRatio>1?"@2x":"";let $t=Ye.g(pt.transformRequest(pt.normalizeSpriteURL(ut,Lt,".json"),Ye.R.SpriteJSON),((Ye,ut)=>{$t=null,It||(It=Ye,Tt=ut,h())})),Xt=Ye.h(pt.transformRequest(pt.normalizeSpriteURL(ut,Lt,".png"),Ye.R.SpriteImage),((Ye,ut)=>{Xt=null,It||(It=Ye,St=ut,h())}));function h(){if(It)wt(It);else if(Tt&&St){const ut=Ye.e.getImageData(St),pt={};for(const wt in Tt){const{width:St,height:It,x:Lt,y:$t,sdf:Xt,pixelRatio:Sr,stretchX:Lr,stretchY:Qr,content:fn}=Tt[wt],xn=new Ye.i({width:St,height:It});Ye.i.copy(ut,xn,{x:Lt,y:$t},{x:0,y:0},{width:St,height:It},null),pt[wt]={data:xn,pixelRatio:Sr,sdf:Xt,stretchX:Lr,stretchY:Qr,content:fn}}wt(null,pt)}}return{cancel(){$t&&($t.cancel(),$t=null),Xt&&(Xt.cancel(),Xt=null)}}}(ut,this.map._requestManager,((ut,pt)=>{if(this._spriteRequest=null,ut)this.fire(new Ye.d(ut));else if(pt)for(const Ye in pt)this.imageManager.addImage(Ye,this.scope,pt[Ye]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new Ye.f("data",{dataType:"style"}))}))}_validateLayer(ut){const pt=this.getOwnSource(ut.source);if(!pt)return;const wt=ut.sourceLayer;wt&&("geojson"===pt.type||pt.vectorLayerIds&&-1===pt.vectorLayerIds.indexOf(wt))&&this.fire(new Ye.d(new Error(`Source layer "${wt}" does not exist on source "${pt.id}" as specified by style layer "${ut.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const Ye in this._sourceCaches)if(!this._sourceCaches[Ye].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(!this.modelManager.isLoaded())return!1;if(this._styleColorTheme.lutLoading)return!1;for(const{style:Ye}of this.fragments)if(!Ye.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((Ye,ut)=>{const pt=this.fragments[ut];return pt&&pt.style&&(Ye.data=pt.style.serialize()),Ye}))}_serializeSources(){const Ye={};for(const ut in this._sourceCaches){const pt=this._sourceCaches[ut].getSource();Ye[pt.id]||(Ye[pt.id]=pt.serialize())}return Ye}_serializeLayers(Ye){const ut=[];for(const pt of Ye){const Ye=this._layers[pt];Ye&&"custom"!==Ye.type&&ut.push(Ye.serialize())}return ut}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;for(const Ye in this._sourceCaches)if(this._sourceCaches[Ye].hasTransition())return!0;for(const Ye in this._layers)if(this._layers[Ye].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(Ye){return!!this.terrain&&Ye.isDraped(this.getLayerSourceCache(Ye))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(ut){const pt=this.getOwnLayer(ut);if(pt)return pt;this.fire(new Ye.d(new Error(`The layer '${ut}' does not exist in the map's style.`)))}_checkSource(ut){const pt=this.getOwnSource(ut);if(pt)return pt;this.fire(new Ye.d(new Error(`The source '${ut}' does not exist in the map's style.`)))}update(ut){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(ut),this.directionalLight&&this.directionalLight.recalculate(ut);const pt=this.calculateLightsBrightness();ut.brightness=pt||0,pt!==this._brightness&&(this._brightness=pt,this.dispatcher.broadcast("setBrightness",pt));const wt=this._changes.isDirty();let Tt=!1;if(this._changes.isDirty()){const Ye=this._changes.getLayerUpdatesByScope();for(const ut in Ye){const{updatedIds:pt,removedIds:wt}=Ye[ut];(pt||wt)&&(this._updateWorkerLayers(ut,pt,wt),Tt=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(ut),this.light&&this.light.updateTransitions(ut),this.ambientLight&&this.ambientLight.updateTransitions(ut),this.directionalLight&&this.directionalLight.updateTransitions(ut),this.fog&&this.fog.updateTransitions(ut),this._changes.reset()}const St={};for(const Ye in this._mergedSourceCaches){const ut=this._mergedSourceCaches[Ye];St[Ye]=ut.used,ut.used=!1,ut.tileCoverLift=0}for(const Ye of this._mergedOrder){const pt=this._mergedLayers[Ye];if(pt.recalculate(ut,this._availableImages),!pt.isHidden(ut.zoom)){const Ye=this.getLayerSourceCache(pt);Ye&&(Ye.used=!0,Ye.tileCoverLift=Math.max(Ye.tileCoverLift,pt.tileCoverLift()))}if(!this._precompileDone&&this._shouldPrecompile)for(let Ye=pt.minzoom||0;Ye<(pt.maxzoom||25.5);Ye++){const Ye=this.map.painter;if(Ye){const wt=pt.getProgramIds();if(!wt)continue;for(const Tt of wt){const wt=pt.getDefaultProgramParams(Tt,ut.zoom,this._styleColorTheme.lut);wt&&(Ye.style=this,this.fog&&(Ye._fogVisible=!0,wt.overrideFog=!0,Ye.getOrCreateProgram(Tt,wt)),Ye._fogVisible=!1,wt.overrideFog=!1,Ye.getOrCreateProgram(Tt,wt),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(wt.overrideRtt=!0,Ye.getOrCreateProgram(Tt,wt)))}}}}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&Tt&&this.mergeLayers();for(const ut in St){const pt=this._mergedSourceCaches[ut];St[ut]!==pt.used&&pt.getSource().fire(new Ye.f("data",{sourceDataType:"visibility",dataType:"source",sourceId:pt.getSource().id}))}this.light&&this.light.recalculate(ut),this.terrain&&this.terrain.recalculate(ut),this.fog&&this.fog.recalculate(ut),this.z=ut.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),wt&&this.fire(new Ye.f("data",{dataType:"style"}))}_updateTilesForChangedImages(){const Ye=this._changes.getUpdatedImages();if(Ye.length){for(const ut in this._sourceCaches)this._sourceCaches[ut].reloadTilesForDependencies(["icons","patterns"],Ye);this._changes.resetUpdatedImages()}}_updateWorkerLayers(Ye,ut,pt){const wt=this.getFragmentStyle(Ye);wt&&this.dispatcher.broadcast("updateLayers",{layers:ut?wt._serializeLayers(ut):[],scope:Ye,removedIds:pt||[],options:wt.options})}setState(ut,pt){if(this._checkLoaded(),Ia(this,Be(ut)))return!1;(ut=Ye.cT(ut)).layers=Gr(ut.layers);const wt=function(Ye,ut){if(!Ye)return[{command:Qh.setStyle,args:[ut]}];let pt=[];try{if(!t(Ye.version,ut.version))return[{command:Qh.setStyle,args:[ut]}];if(t(Ye.center,ut.center)||pt.push({command:Qh.setCenter,args:[ut.center]}),t(Ye.zoom,ut.zoom)||pt.push({command:Qh.setZoom,args:[ut.zoom]}),t(Ye.bearing,ut.bearing)||pt.push({command:Qh.setBearing,args:[ut.bearing]}),t(Ye.pitch,ut.pitch)||pt.push({command:Qh.setPitch,args:[ut.pitch]}),t(Ye.sprite,ut.sprite)||pt.push({command:Qh.setSprite,args:[ut.sprite]}),t(Ye.glyphs,ut.glyphs)||pt.push({command:Qh.setGlyphs,args:[ut.glyphs]}),t(Ye.imports,ut.imports)||function(Ye=[],ut=[],pt){ut=ut||[];const wt=(Ye=Ye||[]).map($r),Tt=ut.map($r),St=Ye.reduce(Xr,{}),It=ut.reduce(Xr,{}),Lt=wt.slice();let $t,Xt,Sr,Lr;for($t=0,Xt=0;$t<wt.length;$t++)Sr=wt[$t],It.hasOwnProperty(Sr)?Xt++:(pt.push({command:Qh.removeImport,args:[Sr]}),Lt.splice(Lt.indexOf(Sr,Xt),1));for($t=0,Xt=0;$t<Tt.length;$t++)Sr=Tt[Tt.length-1-$t],Lt[Lt.length-1-$t]!==Sr&&(St.hasOwnProperty(Sr)?(pt.push({command:Qh.removeImport,args:[Sr]}),Lt.splice(Lt.lastIndexOf(Sr,Lt.length-Xt),1)):Xt++,Lr=Lt[Lt.length-$t],pt.push({command:Qh.addImport,args:[It[Sr],Lr]}),Lt.splice(Lt.length-$t,0,Sr));for(const Ye of ut){const ut=St[Ye.id];ut&&!t(ut,Ye)&&pt.push({command:Qh.updateImport,args:[Ye.id,Ye]})}}(Ye.imports,ut.imports,pt),t(Ye.transition,ut.transition)||pt.push({command:Qh.setTransition,args:[ut.transition]}),t(Ye.light,ut.light)||pt.push({command:Qh.setLight,args:[ut.light]}),t(Ye.fog,ut.fog)||pt.push({command:Qh.setFog,args:[ut.fog]}),t(Ye.projection,ut.projection)||pt.push({command:Qh.setProjection,args:[ut.projection]}),t(Ye.lights,ut.lights)||pt.push({command:Qh.setLights,args:[ut.lights]}),t(Ye.camera,ut.camera)||pt.push({command:Qh.setCamera,args:[ut.camera]}),!t(Ye["color-theme"],ut["color-theme"]))return[{command:Qh.setStyle,args:[ut]}];const wt={},Tt=[];!function(Ye,ut,pt,wt){let Tt;for(Tt in ut=ut||{},Ye=Ye||{})Ye.hasOwnProperty(Tt)&&(ut.hasOwnProperty(Tt)||Wr(Tt,pt,wt));for(Tt in ut){if(!ut.hasOwnProperty(Tt))continue;const St=ut[Tt];Ye.hasOwnProperty(Tt)?t(Ye[Tt],St)||("geojson"===Ye[Tt].type&&"geojson"===St.type&&qr(Ye,ut,Tt)?pt.push({command:Qh.setGeoJSONSourceData,args:[Tt,St.data]}):Zr(Tt,ut,pt,wt)):Vr(Tt,ut,pt)}}(Ye.sources,ut.sources,Tt,wt);const St=[];Ye.layers&&Ye.layers.forEach((Ye=>{Ye.source&&wt[Ye.source]?pt.push({command:Qh.removeLayer,args:[Ye.id]}):St.push(Ye)}));let It=Ye.terrain;It&&wt[It.source]&&(pt.push({command:Qh.setTerrain,args:[void 0]}),It=void 0),pt=pt.concat(Tt),t(It,ut.terrain)||pt.push({command:Qh.setTerrain,args:[ut.terrain]}),function(Ye,ut,pt){ut=ut||[];const wt=(Ye=Ye||[]).map($r),Tt=ut.map($r),St=Ye.reduce(Xr,{}),It=ut.reduce(Xr,{}),Lt=wt.slice(),$t=Object.create(null);let Xt,Sr,Lr,Qr,fn,xn,vn;for(Xt=0,Sr=0;Xt<wt.length;Xt++)Lr=wt[Xt],It.hasOwnProperty(Lr)?Sr++:(pt.push({command:Qh.removeLayer,args:[Lr]}),Lt.splice(Lt.indexOf(Lr,Sr),1));for(Xt=0,Sr=0;Xt<Tt.length;Xt++)Lr=Tt[Tt.length-1-Xt],Lt[Lt.length-1-Xt]!==Lr&&(St.hasOwnProperty(Lr)?(pt.push({command:Qh.removeLayer,args:[Lr]}),Lt.splice(Lt.lastIndexOf(Lr,Lt.length-Sr),1)):Sr++,xn=Lt[Lt.length-Xt],pt.push({command:Qh.addLayer,args:[It[Lr],xn]}),Lt.splice(Lt.length-Xt,0,Lr),$t[Lr]=!0);for(Xt=0;Xt<Tt.length;Xt++)if(Lr=Tt[Xt],Qr=St[Lr],fn=It[Lr],!$t[Lr]&&!t(Qr,fn))if(t(Qr.source,fn.source)&&t(Qr["source-layer"],fn["source-layer"])&&t(Qr.type,fn.type)){for(vn in Hr(Qr.layout,fn.layout,pt,Lr,null,Qh.setLayoutProperty),Hr(Qr.paint,fn.paint,pt,Lr,null,Qh.setPaintProperty),t(Qr.slot,fn.slot)||pt.push({command:Qh.setSlot,args:[Lr,fn.slot]}),t(Qr.filter,fn.filter)||pt.push({command:Qh.setFilter,args:[Lr,fn.filter]}),t(Qr.minzoom,fn.minzoom)&&t(Qr.maxzoom,fn.maxzoom)||pt.push({command:Qh.setLayerZoomRange,args:[Lr,fn.minzoom,fn.maxzoom]}),Qr)Qr.hasOwnProperty(vn)&&"layout"!==vn&&"paint"!==vn&&"filter"!==vn&&"metadata"!==vn&&"minzoom"!==vn&&"maxzoom"!==vn&&"slot"!==vn&&(0===vn.indexOf("paint.")?Hr(Qr[vn],fn[vn],pt,Lr,vn.slice(6),Qh.setPaintProperty):t(Qr[vn],fn[vn])||pt.push({command:Qh.setLayerProperty,args:[Lr,vn,fn[vn]]}));for(vn in fn)fn.hasOwnProperty(vn)&&!Qr.hasOwnProperty(vn)&&"layout"!==vn&&"paint"!==vn&&"filter"!==vn&&"metadata"!==vn&&"minzoom"!==vn&&"maxzoom"!==vn&&"slot"!==vn&&(0===vn.indexOf("paint.")?Hr(Qr[vn],fn[vn],pt,Lr,vn.slice(6),Qh.setPaintProperty):t(Qr[vn],fn[vn])||pt.push({command:Qh.setLayerProperty,args:[Lr,vn,fn[vn]]}))}else pt.push({command:Qh.removeLayer,args:[Lr]}),xn=Lt[Lt.lastIndexOf(Lr)+1],pt.push({command:Qh.addLayer,args:[fn,xn]})}(St,ut.layers,pt)}catch(Ye){console.warn("Unable to compute style diff:",Ye),pt=[{command:Qh.setStyle,args:[ut]}]}return pt}(this.serialize(),ut).filter((Ye=>!(Ye.command in nd)));if(0===wt.length)return!1;const Tt=wt.filter((Ye=>!(Ye.command in rd)));if(Tt.length>0)throw new Error(`Unimplemented: ${Tt.map((Ye=>Ye.command)).join(", ")}.`);const St=[];return wt.forEach((Ye=>{St.push(this[Ye.command].apply(this,Ye.args))})),pt&&Promise.all(St).then(pt),this.stylesheet=ut,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(ut,pt){return this.getImage(ut)?this.fire(new Ye.d(new Error("An image with this name already exists."))):(this.imageManager.addImage(ut,this.scope,pt),this._afterImageUpdated(ut),this)}updateImage(Ye,ut){this.imageManager.updateImage(Ye,this.scope,ut)}getImage(Ye){return this.imageManager.getImage(Ye,this.scope)}removeImage(ut){return this.getImage(ut)?(this.imageManager.removeImage(ut,this.scope),this._afterImageUpdated(ut),this):this.fire(new Ye.d(new Error("No image with this name exists.")))}_afterImageUpdated(ut){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(ut),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new Ye.f("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(Ye,ut,pt={}){return this._checkLoaded(),this._validate(He,`models.${Ye}`,ut,null,pt)||(this.modelManager.addModel(Ye,ut,this.scope),this._changes.setDirty()),this}hasModel(Ye){return this.modelManager.hasModel(Ye,this.scope)}removeModel(ut){return this.hasModel(ut)?(this.modelManager.removeModel(ut,this.scope),this):this.fire(new Ye.d(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(ut,pt,wt={}){if(this._checkLoaded(),void 0!==this.getOwnSource(ut))throw new Error(`There is already a source with ID "${ut}".`);if(!pt.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(pt).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(pt.type)>=0&&this._validate(ke,`sources.${ut}`,pt,null,wt))return;this.map&&this.map._collectResourceTiming&&(pt.collectResourceTiming=!0);const Tt=Mi(ut,pt,this.dispatcher,this);Tt.scope=this.scope,Tt.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(Tt.id),source:Tt.serialize(),sourceId:Tt.id})));const a=ut=>{const pt=(ut?"symbol:":"other:")+Tt.id,wt=Ye.al(pt,this.scope),St=this._sourceCaches[pt]=new Ye.bv(wt,Tt,ut);(ut?this._symbolSourceCaches:this._otherSourceCaches)[Tt.id]=St,St.onAdd(this.map)};a(!1),"vector"!==pt.type&&"geojson"!==pt.type||a(!0),Tt.onAdd&&Tt.onAdd(this.map),wt.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(ut){this._checkLoaded();const pt=this.getOwnSource(ut);if(!pt)throw new Error("There is no source with this ID");for(const pt in this._layers)if(this._layers[pt].source===ut)return this.fire(new Ye.d(new Error(`Source "${ut}" cannot be removed while layer "${pt}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===ut)return this.fire(new Ye.d(new Error(`Source "${ut}" cannot be removed while terrain is using it.`)));const wt=this.getOwnSourceCaches(ut);for(const ut of wt){const pt=Ye.cU(ut.id);delete this._sourceCaches[pt],this._changes.discardSourceCacheUpdate(ut.id),ut.fire(new Ye.f("data",{sourceDataType:"metadata",dataType:"source",sourceId:ut.getSource().id})),ut.setEventedParent(null),ut.clearTiles()}return delete this._otherSourceCaches[ut],delete this._symbolSourceCaches[ut],this.mergeSources(),pt.setEventedParent(null),pt.onRemove&&pt.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(Ye,ut){this._checkLoaded(),this.getOwnSource(Ye).setData(ut),this._changes.setDirty()}getOwnSource(Ye){const ut=this.getOwnSourceCache(Ye);return ut&&ut.getSource()}getOwnSources(){const Ye=[];for(const ut in this._otherSourceCaches){const pt=this.getOwnSourceCache(ut);pt&&Ye.push(pt.getSource())}return Ye}areTilesLoaded(){const Ye=this._mergedSourceCaches;for(const ut in Ye){const pt=Ye[ut]._tiles;for(const Ye in pt){const ut=pt[Ye];if("loaded"!==ut.state&&"errored"!==ut.state)return!1}}return!0}setLights(ut){if(this._checkLoaded(),!ut)return delete this.ambientLight,void delete this.directionalLight;const pt=this._getTransitionParameters();for(const Ye of ut){if(this._validate(Ue,"lights",Ye))return;switch(Ye.type){case"ambient":if(this.ambientLight){const ut=this.ambientLight;ut.set(Ye),ut.updateTransitions(pt)}else this.ambientLight=new ct(Ye,Wn,this.scope,this.options);break;case"directional":if(this.directionalLight){const ut=this.directionalLight;ut.set(Ye),ut.updateTransitions(pt)}else this.directionalLight=new ct(Ye,Xn,this.scope,this.options)}}const wt=new Ye.X(this.z||0,pt);this.ambientLight&&this.ambientLight.recalculate(wt),this.directionalLight&&this.directionalLight.recalculate(wt),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const ut=this.directionalLight,pt=this.ambientLight;if(!ut||!pt)return;const o=Ye=>.2126*(Ye[0]<=.03928?Ye[0]/12.92:Math.pow((Ye[0]+.055)/1.055,2.4))+.7152*(Ye[1]<=.03928?Ye[1]/12.92:Math.pow((Ye[1]+.055)/1.055,2.4))+.0722*(Ye[2]<=.03928?Ye[2]/12.92:Math.pow((Ye[2]+.055)/1.055,2.4)),wt=ut.properties.get("color").toRenderColor(null).toArray01(),Tt=ut.properties.get("intensity"),St=ut.properties.get("direction"),It=1-Ye.ac(St.x,St.y,St.z)[2]/90,Lt=o(wt)*Tt*It,$t=pt.properties.get("color").toRenderColor(null).toArray01(),Xt=pt.properties.get("intensity");return(Lt+o($t)*Xt)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const Ye=[];return this.directionalLight&&Ye.push(this.directionalLight.get()),this.ambientLight&&Ye.push(this.ambientLight.get()),Ye}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(ut){if(!ut)return this;if(Ye.cV(ut)){const pt=Ye.cW(ut),wt=this.fragments.find((({id:Ye})=>Ye===pt));if(!wt)throw new Error(`Style import not found: ${ut}`);const Tt=Ye.cU(ut);return wt.style.getFragmentStyle(Tt)}{const Ye=this.fragments.find((({id:Ye})=>Ye===ut));if(!Ye)throw new Error(`Style import not found: ${ut}`);return Ye.style}}getConfigProperty(ut,pt){const wt=this.getFragmentStyle(ut);if(!wt)return null;const Tt=Ye.al(pt,wt.scope),St=wt.options.get(Tt),It=St?St.value||St.default:null;return It?It.serialize():null}setConfigProperty(ut,pt,wt){const Tt=this.getFragmentStyle(ut);if(!Tt)return;const St=Tt.stylesheet.schema;if(!St||!St[pt])return;const It=Ye.y(wt);if("success"!==It.result)return void Ia(this,It.value);const Lt=It.value.expression,$t=Ye.al(pt,Tt.scope),Xt=Tt.options.get($t);if(!Xt)return;let Sr;const{minValue:Lr,maxValue:Qr,stepValue:fn,type:xn,values:vn}=St[pt],kn=Ye.y(St[pt].default);"success"===kn.result&&(Sr=kn.value.expression),Sr?(this.options.set($t,{...Xt,value:Lt,default:Sr,minValue:Lr,maxValue:Qr,stepValue:fn,type:xn,values:vn}),this.updateConfigDependencies()):this.fire(new Ye.d(new Error(`No schema defined for the config option "${pt}" in the "${ut}" fragment.`)))}getConfig(ut){const pt=this.getFragmentStyle(ut);if(!pt)return null;const wt=pt.stylesheet.schema;if(!wt)return null;const Tt={};for(const ut in wt){const wt=Ye.al(ut,pt.scope),St=pt.options.get(wt),It=St?St.value||St.default:null;Tt[ut]=It?It.serialize():null}return Tt}setConfig(Ye,ut){const pt=this.getFragmentStyle(Ye);pt&&(pt.updateConfig(ut,pt.stylesheet.schema),this.updateConfigDependencies())}getSchema(Ye){const ut=this.getFragmentStyle(Ye);return ut?ut.stylesheet.schema:null}setSchema(Ye,ut){const pt=this.getFragmentStyle(Ye);pt&&(pt.stylesheet.schema=ut,pt.updateConfig(pt._config,ut),this.updateConfigDependencies())}updateConfig(ut,pt){if(this._config=ut,ut||pt)if(pt)for(const wt in pt){let Tt,St;const It=Ye.y(pt[wt].default);if("success"===It.result&&(Tt=It.value.expression),ut&&void 0!==ut[wt]){const pt=Ye.y(ut[wt]);"success"===pt.result&&(St=pt.value.expression)}const{minValue:Lt,maxValue:$t,stepValue:Xt,type:Sr,values:Lr}=pt[wt];if(Tt){const ut=Ye.al(wt,this.scope);this.options.set(ut,{default:Tt,value:St,minValue:Lt,maxValue:$t,stepValue:Xt,type:Sr,values:Lr})}else this.fire(new Ye.d(new Error(`No schema defined for config option "${wt}".`)))}else this.fire(new Ye.d(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const Ye of this._configDependentLayers){const ut=this.getLayer(Ye);ut&&(ut.possiblyEvaluateVisibility(),this._updateLayer(ut))}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.forEachFragmentStyle((Ye=>{if(Ye._styleColorTheme.colorTheme){const ut=Ye._evaluateColorThemeData(Ye._styleColorTheme.colorTheme);(!Ye._styleColorTheme.lut||Ye._styleColorTheme.lut&&ut!==Ye._styleColorTheme.lut.data)&&Ye.setColorTheme(Ye._styleColorTheme.colorTheme)}})),this._changes.setDirty()}addLayer(ut,pt,wt={}){this._checkLoaded();const Tt=ut.id;if(this._layers[Tt])return void this.fire(new Ye.d(new Error(`Layer with id "${Tt}" already exists on this map`)));let St;if("custom"===ut.type){if(Ia(this,Ye.cX(ut)))return;St=Ye.cY(ut,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof ut.source&&(this.addSource(Tt,ut.source),ut=Ye.cT(ut),ut=Ye.W(ut,{source:Tt})),this._validate(Ve,`layers.${Tt}`,ut,{arrayIndex:-1},wt))return;St=Ye.cY(ut,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(St),St.setEventedParent(this,{layer:{id:Tt}}),this._serializedLayers[St.id]=St.serialize()}St.isConfigDependent&&this._configDependentLayers.add(St.fqid);let It=this._order.length;if(pt){const ut=this._order.indexOf(pt);if(-1===ut)return void this.fire(new Ye.d(new Error(`Layer with id "${pt}" does not exist on this map.`)));St.slot===this._layers[pt].slot?It=ut:Ye.w(`Layer with id "${pt}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(It,0,Tt),this._layerOrderChanged=!0,this._layers[Tt]=St;const Lt=this.getOwnLayerSourceCache(St),$t=!!this.directionalLight&&this.directionalLight.shadowsEnabled();Lt&&St.canCastShadows()&&$t&&(Lt.castsShadows=!0);const Xt=this._changes.getRemovedLayer(St);if(Xt&&St.source&&Lt&&"custom"!==St.type){this._changes.discardLayerRemoval(St);const ut=Ye.al(St.source,St.scope);Xt.type!==St.type?this._changes.updateSourceCache(ut,"clear"):(this._changes.updateSourceCache(ut,"reload"),Lt.pause())}this._updateLayer(St),St.onAdd&&St.onAdd(this.map),St.scope=this.scope,this.mergeLayers()}moveLayer(ut,pt){this._checkLoaded();const wt=this._checkLayer(ut);if(!wt)return;if(ut===pt)return;const Tt=this._order.indexOf(ut);this._order.splice(Tt,1);let St=this._order.length;if(pt){const ut=this._order.indexOf(pt);if(-1===ut)return void this.fire(new Ye.d(new Error(`Layer with id "${pt}" does not exist on this map.`)));wt.slot===this._layers[pt].slot?St=ut:Ye.w(`Layer with id "${pt}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(St,0,ut),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(Ye){this._checkLoaded();const ut=this._checkLayer(Ye);if(!ut)return;ut.setEventedParent(null);const pt=this._order.indexOf(Ye);this._order.splice(pt,1),delete this._layers[Ye],delete this._serializedLayers[Ye],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(ut.fqid),this._changes.removeLayer(ut);const wt=this.getOwnLayerSourceCache(ut);if(wt&&wt.castsShadows){let Ye=!1;for(const pt in this._layers)if(this._layers[pt].source===ut.source&&this._layers[pt].canCastShadows()){Ye=!0;break}wt.castsShadows=Ye}ut.onRemove&&ut.onRemove(this.map),this.mergeLayers()}getOwnLayer(Ye){return this._layers[Ye]}hasLayer(Ye){return Ye in this._mergedLayers}hasLayerType(Ye){for(const ut in this._layers)if(this._layers[ut].type===Ye)return!0;return!1}setLayerZoomRange(Ye,ut,pt){this._checkLoaded();const wt=this._checkLayer(Ye);wt&&(wt.minzoom===ut&&wt.maxzoom===pt||(null!=ut&&(wt.minzoom=ut),null!=pt&&(wt.maxzoom=pt),this._updateLayer(wt)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(Ye,ut){this._checkLoaded();const pt=this._checkLayer(Ye);pt&&pt.slot!==ut&&(pt.slot=ut,this._updateLayer(pt))}setFilter(ut,pt,wt={}){this._checkLoaded();const Tt=this._checkLayer(ut);if(Tt&&!t(Tt.filter,pt))return null==pt?(Tt.filter=void 0,void this._updateLayer(Tt)):void(this._validate(We,`layers.${Tt.id}.filter`,pt,{layerType:Tt.type},wt)||(Tt.filter=Ye.cT(pt),this._updateLayer(Tt)))}getFilter(ut){const pt=this._checkLayer(ut);if(pt)return Ye.cT(pt.filter)}setLayoutProperty(ut,pt,wt,Tt={}){this._checkLoaded();const St=this._checkLayer(ut);if(St&&!t(St.getLayoutProperty(pt),wt)){if(null!=wt&&(!Tt||!1!==Tt.validate)&&Ia(St,qe.call(Be,{key:`layers.${ut}.layout.${pt}`,layerType:St.type,objectKey:pt,value:wt,styleSpec:Ye.L,style:{glyphs:!0,sprite:!0}})))return;St.setLayoutProperty(pt,wt),St.isConfigDependent&&this._configDependentLayers.add(St.fqid),this._updateLayer(St)}}getLayoutProperty(Ye,ut){const pt=this._checkLayer(Ye);if(pt)return pt.getLayoutProperty(ut)}setPaintProperty(ut,pt,wt,Tt={}){this._checkLoaded();const St=this._checkLayer(ut);if(!St)return;if(t(St.getPaintProperty(pt),wt))return;if(null!=wt&&(!Tt||!1!==Tt.validate)&&Ia(St,Ze.call(Be,{key:`layers.${ut}.paint.${pt}`,layerType:St.type,objectKey:pt,value:wt,styleSpec:Ye.L})))return;const It=St.setPaintProperty(pt,wt);St.isConfigDependent&&this._configDependentLayers.add(St.fqid),It&&this._updateLayer(St),this._changes.updatePaintProperties(St)}getPaintProperty(Ye,ut){const pt=this._checkLayer(Ye);if(pt)return pt.getPaintProperty(ut)}setFeatureState(ut,pt){this._checkLoaded();const wt=ut.source,Tt=ut.sourceLayer,St=this._checkSource(wt);if(!St)return;const It=St.type;if("geojson"===It&&Tt)return void this.fire(new Ye.d(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===It&&!Tt)return void this.fire(new Ye.d(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===ut.id&&this.fire(new Ye.d(new Error("The feature id parameter must be provided.")));const Lt=this.getOwnSourceCaches(wt);for(const Ye of Lt)Ye.setFeatureState(Tt,ut.id,pt)}removeFeatureState(ut,pt){this._checkLoaded();const wt=ut.source,Tt=this._checkSource(wt);if(!Tt)return;const St=Tt.type,It="vector"===St?ut.sourceLayer:void 0;if("vector"===St&&!It)return void this.fire(new Ye.d(new Error("The sourceLayer parameter must be provided for vector source types.")));if(pt&&"string"!=typeof ut.id&&"number"!=typeof ut.id)return void this.fire(new Ye.d(new Error("A feature id is required to remove its specific state property.")));const Lt=this.getOwnSourceCaches(wt);for(const Ye of Lt)Ye.removeFeatureState(It,ut.id,pt)}getFeatureState(ut){this._checkLoaded();const pt=ut.source,wt=ut.sourceLayer,Tt=this._checkSource(pt);if(Tt){if("vector"!==Tt.type||wt)return void 0===ut.id&&this.fire(new Ye.d(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(pt)[0].getFeatureState(wt,ut.id);this.fire(new Ye.d(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(ut){return this.stylesheet.transition=Ye.W({},this.stylesheet.transition,ut),this.transition=this.stylesheet.transition,this}getTransition(){return Ye.W({},this.stylesheet.transition)}serialize(){this._checkLoaded();const ut=this.getTerrain(),pt=ut&&this.terrain&&this.terrain.scope===this.scope?ut:this.stylesheet.terrain;return Ye.cZ({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:pt,fog:this.stylesheet.fog,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(Ye=>void 0!==Ye))}_updateLayer(ut){this._changes.updateLayer(ut);const pt=this.getLayerSourceCache(ut),wt=Ye.al(ut.source,ut.scope),Tt=this._changes.getUpdatedSourceCaches();ut.source&&!Tt[wt]&&pt&&"raster"!==pt.getSource().type&&(this._changes.updateSourceCache(wt,"reload"),pt.pause()),ut.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(Ye){const t=Ye=>"fill-extrusion"===this._mergedLayers[Ye].type||"model"===this._mergedLayers[Ye].type,ut=this.order,pt={},wt=[];for(let Tt=ut.length-1;Tt>=0;Tt--){const St=ut[Tt];if(t(St)){pt[St]=Tt;for(const ut of Ye){const Ye=ut[St];if(Ye)for(const ut of Ye)wt.push(ut)}}}wt.sort(((Ye,ut)=>ut.intersectionZ-Ye.intersectionZ));const Tt=[];for(let St=ut.length-1;St>=0;St--){const It=ut[St];if(t(It))for(let Ye=wt.length-1;Ye>=0;Ye--){const ut=wt[Ye].feature;if(ut.layer&&pt[ut.layer.id]<St)break;Tt.push(ut),wt.pop()}else for(const ut of Ye){const Ye=ut[It];if(Ye)for(const ut of Ye)Tt.push(ut.feature)}}return Tt}queryRenderedFeatures(ut,pt,wt){pt&&pt.filter&&this._validate(We,"queryRenderedFeatures.filter",pt.filter,null,pt),pt.scope=this.scope,pt.availableImages=this._availableImages,pt.serializedLayers=this._serializedLayers;const Tt={};if(pt&&pt.layers){if(!Array.isArray(pt.layers))return this.fire(new Ye.d(new Error("parameters.layers must be an Array."))),[];for(const ut of pt.layers){const pt=this._mergedLayers[ut];if(!pt)return this.fire(new Ye.d(new Error(`The layer '${ut}' does not exist in the map's style and cannot be queried for features.`))),[];Tt[pt.source]=!0}}const St=[],It=pt.serializedLayers||{},Lt=pt&&pt.layers?pt.layers.some((Ye=>{const ut=this.getLayer(Ye);return ut&&ut.is3D()})):this.has3DLayers(),$t=Rr.createFromScreenPoints(ut,wt);for(const Ye in this._mergedSourceCaches){const ut=this._mergedSourceCaches[Ye].getSource();if(!ut||ut.scope!==pt.scope)continue;const Xt=this._mergedSourceCaches[Ye].getSource().id;pt.layers&&!Tt[Xt]||St.push(Fr(this._mergedSourceCaches[Ye],this._mergedLayers,It,$t,pt,wt,Lt,!!this.map._showQueryGeometry))}return this.placement&&St.push(function(Ye,ut,pt,wt,Tt,St,It){const Lt={},$t=St.queryRenderedSymbols(wt),Xt=[];for(const Ye of Object.keys($t).map(Number))Xt.push(It[Ye]);Xt.sort(kr);for(const pt of Xt){const wt=pt.featureIndex.lookupSymbolFeatures($t[pt.bucketInstanceId],ut,pt.bucketIndex,pt.sourceLayerIndex,Tt.filter,Tt.layers,Tt.availableImages,Ye);for(const Ye in wt){const ut=Lt[Ye]=Lt[Ye]||[],Tt=wt[Ye];Tt.sort(((Ye,ut)=>{const wt=pt.featureSortOrder;if(wt){const pt=wt.indexOf(Ye.featureIndex);return wt.indexOf(ut.featureIndex)-pt}return ut.featureIndex-Ye.featureIndex}));for(const Ye of Tt)ut.push(Ye)}}for(const ut in Lt)Lt[ut].forEach((wt=>{const Tt=wt.feature,St=pt(Ye[ut]);if(!St)return;const It=St.getFeatureState(Tt.layer["source-layer"],Tt.id);Tt.source=Tt.layer.source,Tt.layer["source-layer"]&&(Tt.sourceLayer=Tt.layer["source-layer"]),Tt.state=It}));return Lt}(this._mergedLayers,It,this.getLayerSourceCache.bind(this),$t.screenGeometry,pt,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(St)}querySourceFeatures(Ye,ut){ut&&ut.filter&&this._validate(We,"querySourceFeatures.filter",ut.filter,null,ut);const pt=this.getOwnSourceCaches(Ye);let wt=[];for(const Ye of pt)wt=wt.concat(Br(Ye,ut));return wt}addSourceType(Ye,ut,pt){return Da.getSourceType(Ye)?pt(new Error(`A source type called "${Ye}" already exists.`)):(Da.setSourceType(Ye,ut),ut.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:Ye,url:ut.workerSourceURL},pt):pt(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(Ye,ut,pt={}){this._checkLoaded();const wt=this.light.getLight();let Tt=!1;for(const ut in Ye)if(!t(Ye[ut],wt[ut])){Tt=!0;break}if(!Tt)return;const St=this._getTransitionParameters();this.light.setLight(Ye,ut,pt),this.light.updateTransitions(St)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=Ye.e.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&Ye.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(ut,pt=1){if(this._checkLoaded(),!ut)return this.terrainSetForDrapingOnly()&&0!==pt||delete this.terrain,null===ut?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let wt=ut;const Tt=null==ut.source;if(1===pt){if(this.disableElevatedTerrain)return;if("object"==typeof wt.source){const ut="terrain-dem-src";this.addSource(ut,wt.source),wt=Ye.cT(wt),wt=Ye.W(wt,{source:ut})}const ut=Ye.W({},wt),pt={};if(this.terrain&&Tt){ut.source=this.terrain.get().source;const Ye=this.terrain?this.getFragmentStyle(this.terrain.scope):null;Ye&&(pt.style=Ye.serialize())}if(this._validate(Ge,"terrain",ut,pt))return}if(!this.terrain||this.terrain.scope!==this.scope&&!Tt||this.terrain&&pt!==this.terrain.drapeRenderMode){if(!wt)return;this._createTerrain(wt,pt),this.fire(new Ye.f("data",{dataType:"style"}))}else{const pt=this.terrain,Tt=pt.get();for(const ut of Object.keys(Ye.L.terrain))!wt.hasOwnProperty(ut)&&Ye.L.terrain[ut].default&&(wt[ut]=Ye.L.terrain[ut].default);for(const wt in ut)if(!t(ut[wt],Tt[wt])){pt.set(ut,this.options),this.stylesheet.terrain=ut;const wt=this._getTransitionParameters({duration:0});pt.updateTransitions(wt),this.fire(new Ye.f("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(Ye){const ut=this.fog=new lt(Ye,this.map.transform,this.scope,this.options);this.stylesheet.fog=ut.get();const pt=this._getTransitionParameters({duration:0});ut.updateTransitions(pt)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const Ye of this.map._markers)Ye._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(Ye){if(this._checkLoaded(),!Ye)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const ut=this.fog;if(!t(ut.get(),Ye)){ut.set(Ye,this.options),this.stylesheet.fog=ut.get();const pt=this._getTransitionParameters({duration:0});ut.updateTransitions(pt)}}else this._createFog(Ye);this._markersNeedUpdate=!0}setColorTheme(ut){this._checkLoaded();const i=()=>{for(const Ye in this._layers)this._layers[Ye].lut=this._styleColorTheme.lut;for(const Ye in this._sourceCaches)this._sourceCaches[Ye].clearTiles()};if(this._styleColorTheme.colorTheme=ut,!ut)return this._styleColorTheme.lut=null,void i();const pt=this._evaluateColorThemeData(ut);this._loadColorTheme(pt).then((()=>{this.fire(new Ye.f("colorthemeset")),i()})).catch((ut=>{Ye.w(`Couldn't set color theme: ${ut}`)}))}_getTransitionParameters(ut){return{now:Ye.e.now(),transition:Ye.W(this.transition,ut)}}updateDrapeFirstLayers(){if(!this.terrain)return;const Ye=[],ut=[];for(const pt in this._mergedLayers)this.isLayerDraped(this._mergedLayers[pt])?Ye.push(pt):ut.push(pt);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...Ye),this._drapedFirstOrder.push(...ut)}_createTerrain(Ye,ut){const pt=this.terrain=new Qr(Ye,ut,this.scope,this.options);1===ut&&(this.stylesheet.terrain=Ye),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const wt=this._getTransitionParameters({duration:0});pt.updateTransitions(wt)}_force3DLayerUpdate(){for(const Ye in this._layers){const ut=this._layers[Ye];"fill-extrusion"===ut.type&&this._updateLayer(ut)}}_forceSymbolLayerUpdate(){for(const Ye in this._layers){const ut=this._layers[Ye];"symbol"===ut.type&&this._updateLayer(ut)}}_validate(ut,pt,wt,Tt,St={}){if(St&&!1===St.validate)return!1;const It=Ye.W({},this.serialize());return Ia(this,ut.call(Be,Ye.W({key:pt,style:It,value:wt,styleSpec:Ye.L},Tt)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),Ye.c_.off("pluginStateChange",this._rtlTextPluginCallback);for(const Ye in this._mergedLayers)this._mergedLayers[Ye].setEventedParent(null);for(const Ye in this._mergedSourceCaches)this._mergedSourceCaches[Ye].clearTiles(),this._mergedSourceCaches[Ye].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(Ye){const ut=this.getSourceCaches(Ye);for(const Ye of ut)Ye.clearTiles()}clearSources(){for(const Ye in this._mergedSourceCaches)this._mergedSourceCaches[Ye].clearTiles()}reloadSource(Ye){const ut=this.getSourceCaches(Ye);for(const Ye of ut)Ye.resume(),Ye.reload()}reloadSources(){for(const Ye of this.getSources())Ye.reload&&Ye.reload()}updateSources(Ye){let ut;this.directionalLight&&(ut=bi(this.directionalLight));for(const pt in this._mergedSourceCaches)this._mergedSourceCaches[pt].update(Ye,void 0,void 0,ut)}_generateCollisionBoxes(){for(const Ye in this._sourceCaches){const ut=this._sourceCaches[Ye];ut.resume(),ut.reload()}}_updatePlacement(ut,pt,wt,Tt,St,It,Lt=!1){let $t=!1,Xt=!1;const Sr={},Lr={};for(const ut of this._mergedOrder){const wt=this._mergedLayers[ut];if("symbol"!==wt.type)continue;const Tt=Ye.al(wt.source,wt.scope);let St=Sr[Tt];if(!St){const Ye=this.getLayerSourceCache(wt);if(!Ye)continue;const ut=Ye.getRenderableIds(!0).map((ut=>Ye.getTileByID(ut)));Lr[Tt]=ut.slice(),St=Sr[Tt]=ut.sort(((Ye,ut)=>ut.tileID.overscaledZ-Ye.tileID.overscaledZ||(Ye.tileID.isLessThan(ut.tileID)?-1:1)))}const It=this.crossTileSymbolIndex.addLayer(wt,St,pt.center.lng,pt.projection);$t=$t||It}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),Lt=Lt||this._layerOrderChanged||0===Tt,this._layerOrderChanged&&this.fire(new Ye.f("neworder")),(Lt||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(Ye.e.now(),pt.zoom))&&(this.pauseablePlacement=new ya(pt,this._mergedOrder,Lt,wt,Tt,St,this.placement,this.fog&&pt.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,Sr,Lr),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(Ye.e.now()),Xt=!0),$t&&this.pauseablePlacement.placement.setStale()),Xt||$t){this._buildingIndex.onNewFrame(pt.zoom);for(let ut=0;ut<this._mergedOrder.length;ut++){const pt=this._mergedLayers[this._mergedOrder[ut]];if("symbol"!==pt.type)continue;const wt=this.isLayerClipped(pt)&&this._clipLayerIndices.some((Ye=>ut<Ye));this.placement.updateLayerOpacities(pt,Sr[Ye.al(pt.source,pt.scope)],ut,wt?It:null)}}let Qr=!1;for(const pt of this._mergedOrder){const wt=this._mergedLayers[pt];if("symbol"!==wt.type)continue;const Tt=Sr[Ye.al(wt.source,wt.scope)];for(const Ye of Tt){const pt=Ye.getBucket(wt);pt&&Ye.latestFeatureIndex&&wt.fqid===pt.layerIds[0]&&(Qr=pt.updateOcclusionOpacities(ut.context,ut.symbolParams,ut._dt)||Qr)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(Ye.e.now())||Qr,occlusionQueryBasedOpacityChanged:Qr}}_releaseSymbolFadeTiles(){for(const Ye in this._sourceCaches)this._sourceCaches[Ye].releaseSymbolFadeTiles()}addImport(ut,pt){this._checkLoaded();const wt=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==wt.findIndex((({id:Ye})=>Ye===ut.id)))return void this.fire(new Ye.d(new Error(`Import with id '${ut.id}' already exists in the map's style.`)));if(!pt)return wt.push(ut),this._loadImports([ut],!0);const Tt=wt.findIndex((({id:Ye})=>Ye===pt));return-1===Tt&&this.fire(new Ye.d(new Error(`Import with id "${pt}" does not exist on this map.`))),this.stylesheet.imports=wt.slice(0,Tt).concat(ut).concat(wt.slice(Tt)),this._loadImports([ut],!0,pt)}updateImport(Ye,ut){this._checkLoaded();const pt=this.stylesheet.imports||[],wt=this.getImportIndex(Ye);return-1===wt?this:"string"==typeof ut?(this.setImportUrl(Ye,ut),this):(ut.url&&ut.url!==pt[wt].url&&this.setImportUrl(Ye,ut.url),t(ut.config,pt[wt].config)||this.setImportConfig(Ye,ut.config),t(ut.data,pt[wt].data)||this.setImportData(Ye,ut.data),this)}moveImport(Ye,ut){this._checkLoaded();let pt=this.stylesheet.imports||[];const wt=this.getImportIndex(Ye);if(-1===wt)return this;const Tt=this.getImportIndex(ut);if(-1===Tt)return this;const St=pt[wt],It=this.fragments[wt];return pt=pt.filter((({id:ut})=>ut!==Ye)),this.fragments=this.fragments.filter((({id:ut})=>ut!==Ye)),this.stylesheet.imports=pt.slice(0,Tt).concat(St).concat(pt.slice(Tt)),this.fragments=this.fragments.slice(0,Tt).concat(It).concat(this.fragments.slice(Tt)),this.mergeLayers(),this}setImportUrl(Ye,ut){this._checkLoaded();const pt=this.stylesheet.imports||[],wt=this.getImportIndex(Ye);if(-1===wt)return this;pt[wt].url=ut;const Tt=this.fragments[wt];return Tt.style=this._createFragmentStyle(pt[wt]),Tt.style.on("style.import.load",(()=>this.mergeAll())),Tt.style.loadURL(ut),this}setImportData(Ye,ut){this._checkLoaded();const pt=this.getImportIndex(Ye),wt=this.stylesheet.imports||[];return-1===pt?this:ut?(this.fragments[pt].style.setState(ut),this._reloadImports(),this):(delete wt[pt].data,this.setImportUrl(Ye,wt[pt].url))}setImportConfig(Ye,ut){this._checkLoaded();const pt=this.getImportIndex(Ye),wt=this.stylesheet.imports||[];if(-1===pt)return this;ut?wt[pt].config=ut:delete wt[pt].config;const Tt=this.fragments[pt],St=Tt.style.stylesheet&&Tt.style.stylesheet.schema;return Tt.config=ut,Tt.style.updateConfig(ut,St),this.updateConfigDependencies(),this}removeImport(Ye){this._checkLoaded();const ut=this.stylesheet.imports||[],pt=this.getImportIndex(Ye);-1!==pt&&(ut.splice(pt,1),this.fragments[pt].style._remove(),this.fragments.splice(pt,1),this._reloadImports())}getImportIndex(ut){const pt=(this.stylesheet.imports||[]).findIndex((Ye=>Ye.id===ut));return-1===pt&&this.fire(new Ye.d(new Error(`Import '${ut}' does not exist in the map's style and cannot be updated.`))),pt}getLayer(Ye){return this._mergedLayers[Ye]}getSources(){const Ye=[];for(const ut in this._mergedOtherSourceCaches){const pt=this._mergedOtherSourceCaches[ut];pt&&Ye.push(pt.getSource())}return Ye}getSource(Ye,ut){const pt=this.getSourceCache(Ye,ut);return pt&&pt.getSource()}getLayerSource(Ye){const ut=this.getLayerSourceCache(Ye);return ut&&ut.getSource()}getSourceCache(ut,pt){const wt=Ye.al(ut,pt);return this._mergedOtherSourceCaches[wt]}getLayerSourceCache(ut){const pt=Ye.al(ut.source,ut.scope);return"symbol"===ut.type?this._mergedSymbolSourceCaches[pt]:this._mergedOtherSourceCaches[pt]}getSourceCaches(Ye){if(null==Ye)return Object.values(this._mergedSourceCaches);const ut=[];return this._mergedOtherSourceCaches[Ye]&&ut.push(this._mergedOtherSourceCaches[Ye]),this._mergedSymbolSourceCaches[Ye]&&ut.push(this._mergedSymbolSourceCaches[Ye]),ut}updateSourceCaches(){const Ye=this._changes.getUpdatedSourceCaches();for(const ut in Ye){const pt=Ye[ut];"reload"===pt?this.reloadSource(ut):"clear"===pt&&this.clearSource(ut)}}updateLayers(Ye){const ut=this._changes.getUpdatedPaintProperties();for(const pt of ut){const ut=this.getLayer(pt);ut&&ut.updateTransitions(Ye)}}getImages(Ye,ut,pt){this.imageManager.getImages(ut.icons,ut.scope,pt),this._updateTilesForChangedImages();const o=Ye=>{Ye&&Ye.setDependencies(ut.tileID.key,ut.type,ut.icons)};o(this._otherSourceCaches[ut.source]),o(this._symbolSourceCaches[ut.source])}getGlyphs(Ye,ut,pt){this.glyphManager.getGlyphs(ut.stacks,ut.scope,pt)}getResource(ut,pt,wt){return Ye.c$(pt,wt)}getOwnSourceCache(Ye){return this._otherSourceCaches[Ye]}getOwnLayerSourceCache(Ye){return"symbol"===Ye.type?this._symbolSourceCaches[Ye.source]:this._otherSourceCaches[Ye.source]}getOwnSourceCaches(Ye){const ut=[];return this._otherSourceCaches[Ye]&&ut.push(this._otherSourceCaches[Ye]),this._symbolSourceCaches[Ye]&&ut.push(this._symbolSourceCaches[Ye]),ut}_isSourceCacheLoaded(ut){const pt=this.getOwnSourceCaches(ut);return 0===pt.length?(this.fire(new Ye.d(new Error(`There is no source with ID '${ut}'`))),!1):pt.every((Ye=>Ye.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(ut,pt){if(0===this._clipLayerIndices.length&&"fill-extrusion"!==ut.type)return!1;const wt="fill-extrusion"===ut.type&&"building"===ut.sourceLayer;let Tt=0;if(ut.is3D()){if(wt||pt&&"batched-model"===pt.type)return!0;"model"===ut.type&&(Tt=Ye.cu.Model)}else"symbol"===ut.type&&(Tt=Ye.cu.Symbol);for(const ut of this._clipLayerIndices){const pt=this._mergedLayers[this._mergedOrder[ut]];if(!pt)continue;const wt=[];for(const ut of pt.layout.get("clip-layer-types"))wt.push("model"===ut?Ye.cu.Model:"symbol"===ut?Ye.cu.Symbol:Ye.cu.FillExtrusion);for(const Ye of wt)if(Tt&Ye)return!0}return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((Ye=>{Ye.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function Ma(Ye,ut){let pt=!1,wt=null;const r=()=>{wt=null,pt&&(Ye(),wt=setTimeout(r,ut),pt=!1)};return()=>(pt=!0,wt||r(),wt)}Da.getSourceType=function(Ye){return tc[Ye]},Da.setSourceType=function(Ye,ut){tc[Ye]=ut},Da.registerForPluginStateChange=Ye.cL;class za{constructor(ut){this._hashName=ut&&encodeURIComponent(ut),Ye.bp(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ma(this._updateHashUnthrottled.bind(this),300)}addTo(Ye){return this._map=Ye,window.addEventListener("hashchange",this._onHashChange,!1),Ye.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const Ye=this._map;if(!Ye)return"";const ut=Oa(Ye);if(this._hashName){const Ye=this._hashName;let pt=!1;const wt=location.hash.slice(1).split("&").map((wt=>{const Tt=wt.split("=")[0];return Tt===Ye?(pt=!0,`${Tt}=${ut}`):wt})).filter((Ye=>Ye));return pt||wt.push(`${Ye}=${ut}`),`#${wt.join("&")}`}return`#${ut}`}_getCurrentHash(){const Ye=location.hash.replace("#","");if(this._hashName){let ut;return Ye.split("&").map((Ye=>Ye.split("="))).forEach((Ye=>{Ye[0]===this._hashName&&(ut=Ye)})),(ut&&ut[1]||"").split("/")}return Ye.split("/")}_onHashChange(){const Ye=this._map;if(!Ye)return!1;const ut=this._getCurrentHash();if(ut.length>=3&&!ut.some((Ye=>isNaN(Ye)))){const pt=Ye.dragRotate.isEnabled()&&Ye.touchZoomRotate.isEnabled()?+(ut[3]||0):Ye.getBearing();return Ye.jumpTo({center:[+ut[2],+ut[1]],zoom:+ut[0],bearing:pt,pitch:+(ut[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Oa(Ye,ut){const pt=Ye.getCenter(),wt=Math.round(100*Ye.getZoom())/100,Tt=Math.ceil((wt*Math.LN2+Math.log(512/360/.5))/Math.LN10),St=Math.pow(10,Tt),It=Math.round(pt.lng*St)/St,Lt=Math.round(pt.lat*St)/St,$t=Ye.getBearing(),Xt=Ye.getPitch();let Sr=ut?`/${It}/${Lt}/${wt}`:`${wt}/${Lt}/${It}`;return($t||Xt)&&(Sr+="/"+Math.round(10*$t)/10),Xt&&(Sr+=`/${Math.round(Xt)}`),Sr}const ad={linearity:.3,easing:Ye.d0(0,0,.3,1)},md=Ye.W({deceleration:2500,maxSpeed:1400},ad),Cd=Ye.W({deceleration:20,maxSpeed:1400},ad),Pd=Ye.W({deceleration:1e3,maxSpeed:360},ad),zd=Ye.W({deceleration:1e3,maxSpeed:90},ad);class Ga{constructor(Ye){this._map=Ye,this.clear()}clear(){this._inertiaBuffer=[]}record(ut){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:Ye.e.now(),settings:ut})}_drainInertiaBuffer(){const ut=this._inertiaBuffer,pt=Ye.e.now();for(;ut.length>0&&pt-ut[0].time>160;)ut.shift()}_onMoveEnd(ut){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const pt={zoom:0,bearing:0,pitch:0,pan:new Ye.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:Ye}of this._inertiaBuffer)pt.zoom+=Ye.zoomDelta||0,pt.bearing+=Ye.bearingDelta||0,pt.pitch+=Ye.pitchDelta||0,Ye.panDelta&&pt.pan._add(Ye.panDelta),Ye.around&&(pt.around=Ye.around),Ye.pinchAround&&(pt.pinchAround=Ye.pinchAround);const wt=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,Tt={};if(pt.pan.mag()){const St=Va(pt.pan.mag(),wt,Ye.W({},md,ut||{}));Tt.offset=pt.pan.mult(St.amount/pt.pan.mag()),Tt.center=this._map.transform.center,ja(Tt,St)}if(pt.zoom){const Ye=Va(pt.zoom,wt,Cd);Tt.zoom=this._map.transform.zoom+Ye.amount,ja(Tt,Ye)}if(pt.bearing){const ut=Va(pt.bearing,wt,Pd);Tt.bearing=this._map.transform.bearing+Ye.at(ut.amount,-179,179),ja(Tt,ut)}if(pt.pitch){const Ye=Va(pt.pitch,wt,zd);Tt.pitch=this._map.transform.pitch+Ye.amount,ja(Tt,Ye)}if(Tt.zoom||Tt.bearing){const Ye=void 0===pt.pinchAround?pt.around:pt.pinchAround;Tt.around=Ye?this._map.unproject(Ye):this._map.getCenter()}return this.clear(),Tt.noMoveStart=!0,Tt}}function ja(Ye,ut){(!Ye.duration||Ye.duration<ut.duration)&&(Ye.duration=ut.duration,Ye.easing=ut.easing)}function Va(ut,pt,wt){const{maxSpeed:Tt,linearity:St,deceleration:It}=wt,Lt=Ye.at(ut*St/(pt/1e3),-Tt,Tt),$t=Math.abs(Lt)/(It*St);return{easing:wt.easing,duration:1e3*$t,amount:Lt*($t/2)}}class Wa extends Ye.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(ut,pt,wt,Tt={}){const St=p(pt.getCanvasContainer(),wt),It=pt.unproject(St);super(ut,Ye.W({point:St,lngLat:It,originalEvent:wt},Tt)),this._defaultPrevented=!1,this.target=pt}}class Za extends Ye.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(ut,pt,wt){const Tt="touchend"===ut?wt.changedTouches:wt.touches,St=f(pt.getCanvasContainer(),Tt),It=St.map((Ye=>pt.unproject(Ye))),Lt=St.reduce(((Ye,ut,pt,wt)=>Ye.add(ut.div(wt.length))),new Ye.P(0,0));super(ut,{points:St,point:Lt,lngLats:It,lngLat:pt.unproject(Lt),originalEvent:wt}),this._defaultPrevented=!1}}class qa extends Ye.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(Ye,ut){super("wheel",{originalEvent:ut}),this._defaultPrevented=!1}}class Ha{constructor(Ye,ut){this._map=Ye,this._clickTolerance=ut.clickTolerance}reset(){this._mousedownPos=void 0}wheel(Ye){return this._firePreventable(new qa(this._map,Ye))}mousedown(Ye,ut){return this._mousedownPos=ut,this._firePreventable(new Wa(Ye.type,this._map,Ye))}mouseup(Ye){this._map.fire(new Wa(Ye.type,this._map,Ye))}preclick(ut){const pt=Ye.W({},ut);pt.type="preclick",this._map.fire(new Wa(pt.type,this._map,pt))}click(Ye,ut){this._mousedownPos&&this._mousedownPos.dist(ut)>=this._clickTolerance||(this.preclick(Ye),this._map.fire(new Wa(Ye.type,this._map,Ye)))}dblclick(Ye){return this._firePreventable(new Wa(Ye.type,this._map,Ye))}mouseover(Ye){this._map.fire(new Wa(Ye.type,this._map,Ye))}mouseout(Ye){this._map.fire(new Wa(Ye.type,this._map,Ye))}touchstart(Ye){return this._firePreventable(new Za(Ye.type,this._map,Ye))}touchmove(Ye){this._map.fire(new Za(Ye.type,this._map,Ye))}touchend(Ye){this._map.fire(new Za(Ye.type,this._map,Ye))}touchcancel(Ye){this._map.fire(new Za(Ye.type,this._map,Ye))}_firePreventable(Ye){if(this._map.fire(Ye),Ye.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class $a{constructor(Ye){this._map=Ye}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(Ye){this._map.fire(new Wa(Ye.type,this._map,Ye))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Wa("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(Ye){this._delayContextMenu?this._contextMenuEvent=Ye:this._map.fire(new Wa(Ye.type,this._map,Ye)),this._map.listens("contextmenu")&&Ye.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Xa{constructor(Ye,ut){this._map=Ye,this._el=Ye.getCanvasContainer(),this._container=Ye.getContainer(),this._clickTolerance=ut.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(Ye,ut){this.isEnabled()&&Ye.shiftKey&&0===Ye.button&&(h(),this._startPos=this._lastPos=ut,this._active=!0)}mousemoveWindow(Ye,ut){if(!this._active)return;const pt=ut,wt=this._startPos,Tt=this._lastPos;if(!wt||!Tt||Tt.equals(pt)||!this._box&&pt.dist(wt)<this._clickTolerance)return;this._lastPos=pt,this._box||(this._box=a("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",Ye));const St=Math.min(wt.x,pt.x),It=Math.max(wt.x,pt.x),Lt=Math.min(wt.y,pt.y),$t=Math.max(wt.y,pt.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${St}px,${Lt}px)`,this._box.style.width=It-St+"px",this._box.style.height=$t-Lt+"px")}))}mouseupWindow(ut,pt){if(!this._active)return;const wt=this._startPos,Tt=pt;if(wt&&0===ut.button){if(this.reset(),d(),wt.x!==Tt.x||wt.y!==Tt.y)return this._map.fire(new Ye.f("boxzoomend",{originalEvent:ut})),{cameraAnimation:Ye=>Ye.fitScreenCoordinates(wt,Tt,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",ut)}}keydown(Ye){this._active&&27===Ye.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",Ye))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),_(),delete this._startPos,delete this._lastPos}_fireEvent(ut,pt){return this._map.fire(new Ye.f(ut,{originalEvent:pt}))}}function Ya(Ye,ut){const pt={};for(let wt=0;wt<Ye.length;wt++)pt[Ye[wt].identifier]=ut[wt];return pt}class Ka{constructor(Ye){this.reset(),this.numTouches=Ye.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(ut,pt,wt){(this.centroid||wt.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=ut.timeStamp),wt.length===this.numTouches&&(this.centroid=function(ut){const pt=new Ye.P(0,0);for(const Ye of ut)pt._add(Ye);return pt.div(ut.length)}(pt),this.touches=Ya(wt,pt)))}touchmove(Ye,ut,pt){if(this.aborted||!this.centroid)return;const wt=Ya(pt,ut);for(const Ye in this.touches){const ut=wt[Ye];(!ut||ut.dist(this.touches[Ye])>30)&&(this.aborted=!0)}}touchend(Ye,ut,pt){if((!this.centroid||Ye.timeStamp-this.startTime>500)&&(this.aborted=!0),0===pt.length){const Ye=!this.aborted&&this.centroid;if(this.reset(),Ye)return Ye}}}class Qa{constructor(Ye){this.singleTap=new Ka(Ye),this.numTaps=Ye.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(Ye,ut,pt){this.singleTap.touchstart(Ye,ut,pt)}touchmove(Ye,ut,pt){this.singleTap.touchmove(Ye,ut,pt)}touchend(Ye,ut,pt){const wt=this.singleTap.touchend(Ye,ut,pt);if(wt){const ut=Ye.timeStamp-this.lastTime<500,pt=!this.lastTap||this.lastTap.dist(wt)<30;if(ut&&pt||this.reset(),this.count++,this.lastTime=Ye.timeStamp,this.lastTap=wt,this.count===this.numTaps)return this.reset(),wt}}}class Ja{constructor(){this._zoomIn=new Qa({numTouches:1,numTaps:2}),this._zoomOut=new Qa({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(Ye,ut,pt){this._zoomIn.touchstart(Ye,ut,pt),this._zoomOut.touchstart(Ye,ut,pt)}touchmove(Ye,ut,pt){this._zoomIn.touchmove(Ye,ut,pt),this._zoomOut.touchmove(Ye,ut,pt)}touchend(Ye,ut,pt){const wt=this._zoomIn.touchend(Ye,ut,pt),Tt=this._zoomOut.touchend(Ye,ut,pt);return wt?(this._active=!0,Ye.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:ut=>ut.easeTo({duration:300,zoom:ut.getZoom()+1,around:ut.unproject(wt)},{originalEvent:Ye})}):Tt?(this._active=!0,Ye.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:ut=>ut.easeTo({duration:300,zoom:ut.getZoom()-1,around:ut.unproject(Tt)},{originalEvent:Ye})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Rd={0:1,2:2};class tn{constructor(Ye){this.reset(),this._clickTolerance=Ye.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(Ye,ut){return!1}_move(Ye,ut){return{}}mousedown(Ye,ut){if(this._lastPoint)return;const pt=m(Ye);this._correctButton(Ye,pt)&&(this._lastPoint=ut,this._eventButton=pt)}mousemoveWindow(Ye,ut){const pt=this._lastPoint;if(pt)if(Ye.preventDefault(),null!=this._eventButton&&function(Ye,ut){const pt=Rd[ut];return void 0===Ye.buttons||(Ye.buttons&pt)!==pt}(Ye,this._eventButton))this.reset();else if(this._moved||!(ut.dist(pt)<this._clickTolerance))return this._moved=!0,this._lastPoint=ut,this._move(pt,ut)}mouseupWindow(Ye){this._lastPoint&&m(Ye)===this._eventButton&&(this._moved&&d(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class on extends tn{mousedown(Ye,ut){super.mousedown(Ye,ut),this._lastPoint&&(this._active=!0)}_correctButton(Ye,ut){return 0===ut&&!Ye.ctrlKey}_move(Ye,ut){return{around:ut,panDelta:ut.sub(Ye)}}}class rn extends tn{_correctButton(Ye,ut){return 0===ut&&Ye.ctrlKey||2===ut}_move(Ye,ut){const pt=.8*(ut.x-Ye.x);if(pt)return this._active=!0,{bearingDelta:pt}}contextmenu(Ye){Ye.preventDefault()}}class an extends tn{_correctButton(Ye,ut){return 0===ut&&Ye.ctrlKey||2===ut}_move(Ye,ut){const pt=-.5*(ut.y-Ye.y);if(pt)return this._active=!0,{pitchDelta:pt}}contextmenu(Ye){Ye.preventDefault()}}class nn{constructor(ut,pt){this._map=ut,this._el=ut.getCanvasContainer(),this._minTouches=1,this._clickTolerance=pt.clickTolerance||1,this.reset(),Ye.bp(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new Ye.P(0,0)}touchstart(Ye,ut,pt){return this._calculateTransform(Ye,ut,pt)}touchmove(ut,pt,wt){if(this._active&&!(wt.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===wt.length&&!Ye.d1())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return ut.cancelable&&ut.preventDefault(),this._calculateTransform(ut,pt,wt)}}touchend(Ye,ut,pt){this._calculateTransform(Ye,ut,pt),this._active&&pt.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(ut,pt,wt){wt.length>0&&(this._active=!0);const Tt=Ya(wt,pt),St=new Ye.P(0,0),It=new Ye.P(0,0);let Lt=0;for(const Ye in Tt){const ut=Tt[Ye],pt=this._touches[Ye];pt&&(St._add(ut),It._add(ut.sub(pt)),Lt++,Tt[Ye]=ut)}if(this._touches=Tt,Lt<this._minTouches||!It.mag())return;const $t=It.div(Lt);return this._sum._add($t),this._sum.mag()<this._clickTolerance?void 0:{around:St.div(Lt),panDelta:$t}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=a("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class sn{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(Ye){}_move(Ye,ut,pt){return{}}touchstart(Ye,ut,pt){this._firstTwoTouches||pt.length<2||(this._firstTwoTouches=[pt[0].identifier,pt[1].identifier],this._start([ut[0],ut[1]]))}touchmove(Ye,ut,pt){const wt=this._firstTwoTouches;if(!wt)return;Ye.preventDefault();const[Tt,St]=wt,It=ln(pt,ut,Tt),Lt=ln(pt,ut,St);if(!It||!Lt)return;const $t=this._aroundCenter?null:It.add(Lt).div(2);return this._move([It,Lt],$t,Ye)}touchend(Ye,ut,pt){if(!this._firstTwoTouches)return;const[wt,Tt]=this._firstTwoTouches,St=ln(pt,ut,wt),It=ln(pt,ut,Tt);St&&It||(this._active&&d(),this.reset())}touchcancel(){this.reset()}enable(Ye){this._enabled=!0,this._aroundCenter=!!Ye&&"center"===Ye.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function ln(Ye,ut,pt){for(let wt=0;wt<Ye.length;wt++)if(Ye[wt].identifier===pt)return ut[wt]}function cn(Ye,ut){return Math.log(Ye/ut)/Math.LN2}class hn extends sn{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(Ye){this._startDistance=this._distance=Ye[0].dist(Ye[1])}_move(Ye,ut){const pt=this._distance;if(this._distance=Ye[0].dist(Ye[1]),this._active||!(Math.abs(cn(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:cn(this._distance,pt),pinchAround:ut}}}function _n(Ye,ut){return 180*Ye.angleWith(ut)/Math.PI}class un extends sn{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(Ye){this._startVector=this._vector=Ye[0].sub(Ye[1]),this._minDiameter=Ye[0].dist(Ye[1])}_move(Ye,ut){const pt=this._vector;if(this._vector=Ye[0].sub(Ye[1]),pt&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:_n(this._vector,pt),pinchAround:ut}}_isBelowThreshold(Ye){this._minDiameter=Math.min(this._minDiameter,Ye.mag());const ut=25/(Math.PI*this._minDiameter)*360,pt=this._startVector;if(!pt)return!1;const wt=_n(Ye,pt);return Math.abs(wt)<ut}}function dn(Ye){return Math.abs(Ye.y)>Math.abs(Ye.x)}class pn extends sn{constructor(Ye){super(),this._map=Ye}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(Ye){this._lastPoints=Ye,dn(Ye[0].sub(Ye[1]))&&(this._valid=!1)}_move(ut,pt,wt){const Tt=this._lastPoints;if(!Tt)return;const St=ut[0].sub(Tt[0]),It=ut[1].sub(Tt[1]);return this._map._cooperativeGestures&&!Ye.d1()&&wt.touches.length<3||(this._valid=this.gestureBeginsVertically(St,It,wt.timeStamp),!this._valid)?void 0:(this._lastPoints=ut,this._active=!0,{pitchDelta:(St.y+It.y)/2*-.5})}gestureBeginsVertically(Ye,ut,pt){if(void 0!==this._valid)return this._valid;const wt=Ye.mag()>=2,Tt=ut.mag()>=2;if(!wt&&!Tt)return;if(!wt||!Tt)return null==this._firstMove&&(this._firstMove=pt),pt-this._firstMove<100&&void 0;const St=Ye.y>0==ut.y>0;return dn(Ye)&&dn(ut)&&St}}const Ld={panStep:100,bearingStep:15,pitchStep:10};class mn{constructor(){const Ye=Ld;this._panStep=Ye.panStep,this._bearingStep=Ye.bearingStep,this._pitchStep=Ye.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(Ye){if(Ye.altKey||Ye.ctrlKey||Ye.metaKey)return;let ut=0,pt=0,wt=0,Tt=0,St=0;switch(Ye.keyCode){case 61:case 107:case 171:case 187:ut=1;break;case 189:case 109:case 173:ut=-1;break;case 37:Ye.shiftKey?pt=-1:(Ye.preventDefault(),Tt=-1);break;case 39:Ye.shiftKey?pt=1:(Ye.preventDefault(),Tt=1);break;case 38:Ye.shiftKey?wt=1:(Ye.preventDefault(),St=-1);break;case 40:Ye.shiftKey?wt=-1:(Ye.preventDefault(),St=1);break;default:return}return this._rotationDisabled&&(pt=0,wt=0),{cameraAnimation:It=>{const Lt=It.getZoom();It.easeTo({duration:300,easeId:"keyboardHandler",easing:gn,zoom:ut?Math.round(Lt)+ut*(Ye.shiftKey?2:1):Lt,bearing:It.getBearing()+pt*this._bearingStep,pitch:It.getPitch()+wt*this._pitchStep,offset:[-Tt*this._panStep,-St*this._panStep],center:It.getCenter()},{originalEvent:Ye})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function gn(Ye){return Ye*(2-Ye)}const Od=4.000244140625,Fd=1/450;class yn{constructor(ut,pt){this._map=ut,this._el=ut.getCanvasContainer(),this._handler=pt,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Fd,Ye.bp(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(Ye){this._defaultZoomRate=Ye}setWheelZoomRate(Ye){this._wheelZoomRate=Ye}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(Ye){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!Ye&&"center"===Ye.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(ut){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(ut.ctrlKey||ut.metaKey||this.isZooming()||Ye.d1()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let pt=ut.deltaMode===WheelEvent.DOM_DELTA_LINE?40*ut.deltaY:ut.deltaY;const wt=Ye.e.now(),Tt=wt-(this._lastWheelEventTime||0);this._lastWheelEventTime=wt,0!==pt&&pt%Od==0?this._type="wheel":0!==pt&&Math.abs(pt)<4?this._type="trackpad":Tt>400?(this._type=null,this._lastValue=pt,this._timeout=setTimeout(this._onTimeout,40,ut)):this._type||(this._type=Math.abs(Tt*pt)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,pt+=this._lastValue)),ut.shiftKey&&pt&&(pt/=4),this._type&&(this._lastWheelEvent=ut,this._delta-=pt,this._active||this._start(ut)),ut.preventDefault()}_onTimeout(Ye){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(Ye)}_start(Ye){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const ut=p(this._el,Ye);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:ut,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const ut=this._map.transform;"wheel"===this._type&&ut.projection.wrap&&(ut._center.lng>=180||ut._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>ut._terrainEnabled()&&this._aroundCoord?ut.computeZoomRelativeTo(this._aroundCoord):ut.zoom;if(0!==this._delta){const Ye="wheel"===this._type&&Math.abs(this._delta)>Od?this._wheelZoomRate:this._defaultZoomRate;let pt=2/(1+Math.exp(-Math.abs(this._delta*Ye)));this._delta<0&&0!==pt&&(pt=1/pt);const wt=i(),Tt=Math.pow(2,wt),St="number"==typeof this._targetZoom?ut.zoomScale(this._targetZoom):Tt;this._targetZoom=Math.min(ut.maxZoom,Math.max(ut.minZoom,ut.scaleZoom(St*pt))),"wheel"===this._type&&(this._startZoom=wt,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const pt="number"==typeof this._targetZoom?this._targetZoom:i(),wt=this._startZoom,Tt=this._easing;let St,It=!1;if("wheel"===this._type&&wt&&Tt){const ut=Math.min((Ye.e.now()-this._lastWheelEventTime)/200,1),Lt=Tt(ut);St=Ye.a2(wt,pt,Lt),ut<1?this._frameId||(this._frameId=!0):It=!0}else St=pt,It=!0;this._active=!0,It&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let Lt=St-i();return Lt*this._lastDelta<0&&(Lt=0),{noInertia:!0,needsRenderFrame:!It,zoomDelta:Lt,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(ut){let pt=Ye.d2;if(this._prevEase){const ut=this._prevEase,wt=(Ye.e.now()-ut.start)/ut.duration,Tt=ut.easing(wt+.01)-ut.easing(wt),St=.27/Math.sqrt(Tt*Tt+1e-4)*.01,It=Math.sqrt(.0729-St*St);pt=Ye.d0(St,It,.25,1)}return this._prevEase={start:Ye.e.now(),duration:ut,easing:pt},pt}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=a("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class bn{constructor(Ye,ut){this._clickZoom=Ye,this._tapZoom=ut}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class wn{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(Ye,ut){return Ye.preventDefault(),{cameraAnimation:pt=>{pt.easeTo({duration:300,zoom:pt.getZoom()+(Ye.shiftKey?-1:1),around:pt.unproject(ut)},{originalEvent:Ye})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Tn{constructor(){this._tap=new Qa({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(Ye,ut,pt){this._swipePoint||(this._tapTime&&Ye.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?pt.length>0&&(this._swipePoint=ut[0],this._swipeTouch=pt[0].identifier):this._tap.touchstart(Ye,ut,pt))}touchmove(Ye,ut,pt){if(this._tapTime){if(this._swipePoint){if(pt[0].identifier!==this._swipeTouch)return;const wt=ut[0],Tt=wt.y-this._swipePoint.y;return this._swipePoint=wt,Ye.preventDefault(),this._active=!0,{zoomDelta:Tt/128}}}else this._tap.touchmove(Ye,ut,pt)}touchend(Ye,ut,pt){this._tapTime?this._swipePoint&&0===pt.length&&this.reset():this._tap.touchend(Ye,ut,pt)&&(this._tapTime=Ye.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class En{constructor(Ye,ut,pt){this._el=Ye,this._mousePan=ut,this._touchPan=pt}enable(Ye){this._inertiaOptions=Ye||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Cn{constructor(Ye,ut,pt){this._pitchWithRotate=Ye.pitchWithRotate,this._mouseRotate=ut,this._mousePitch=pt}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Sn{constructor(Ye,ut,pt,wt){this._el=Ye,this._touchZoom=ut,this._touchRotate=pt,this._tapDragZoom=wt,this._rotationDisabled=!1,this._enabled=!0}enable(Ye){this._touchZoom.enable(Ye),this._rotationDisabled||this._touchRotate.enable(Ye),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const In=Ye=>Ye.zoom||Ye.drag||Ye.pitch||Ye.rotate;class Ln extends Ye.f{}class Pn{constructor(){this.constants=[1,1,.01],this.radius=0}setup(ut,pt){const wt=Ye._.sub([],pt,ut);this.radius=Ye._.length(wt[2]<0?Ye._.div([],wt,this.constants):[wt[0],wt[1],0])}projectRay(ut){Ye._.div(ut,ut,this.constants),Ye._.normalize(ut,ut),Ye._.mul(ut,ut,this.constants);const pt=Ye._.scale([],ut,this.radius);if(pt[2]>0){const ut=Ye._.scale([],[0,0,1],Ye._.dot(pt,[0,0,1])),wt=Ye._.scale([],Ye._.normalize([],[pt[0],pt[1],0]),this.radius),Tt=Ye._.add([],pt,Ye._.scale([],Ye._.sub([],Ye._.add([],wt,ut),pt),2));pt[0]=Tt[0],pt[1]=Tt[1]}return pt}}function An(Ye){return Ye.panDelta&&Ye.panDelta.mag()||Ye.zoomDelta||Ye.bearingDelta||Ye.pitchDelta}class Rn{constructor(ut,pt){this._map=ut,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Ga(ut),this._bearingSnap=pt.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Pn,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(pt),Ye.bp(["handleEvent","handleWindowEvent"],this);const wt=this._el;this._listeners=[[wt,"touchstart",{passive:!0}],[wt,"touchmove",{passive:!1}],[wt,"touchend",void 0],[wt,"touchcancel",void 0],[wt,"mousedown",void 0],[wt,"mousemove",void 0],[wt,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[wt,"mouseover",void 0],[wt,"mouseout",void 0],[wt,"dblclick",void 0],[wt,"click",void 0],[wt,"keydown",{capture:!1}],[wt,"keyup",void 0],[wt,"wheel",{passive:!1}],[wt,"contextmenu",void 0],[window,"blur",void 0]];for(const[Ye,ut,pt]of this._listeners){const wt=Ye===document?this.handleWindowEvent:this.handleEvent;Ye.addEventListener(ut,wt,pt)}}destroy(){for(const[Ye,ut,pt]of this._listeners){const wt=Ye===document?this.handleWindowEvent:this.handleEvent;Ye.removeEventListener(ut,wt,pt)}}_addDefaultHandlers(Ye){const ut=this._map,pt=ut.getCanvasContainer();this._add("mapEvent",new Ha(ut,Ye));const wt=ut.boxZoom=new Xa(ut,Ye);this._add("boxZoom",wt);const Tt=new Ja,St=new wn;ut.doubleClickZoom=new bn(St,Tt),this._add("tapZoom",Tt),this._add("clickZoom",St);const It=new Tn;this._add("tapDragZoom",It);const Lt=ut.touchPitch=new pn(ut);this._add("touchPitch",Lt);const $t=new rn(Ye),Xt=new an(Ye);ut.dragRotate=new Cn(Ye,$t,Xt),this._add("mouseRotate",$t,["mousePitch"]),this._add("mousePitch",Xt,["mouseRotate"]);const Sr=new on(Ye),Lr=new nn(ut,Ye);ut.dragPan=new En(pt,Sr,Lr),this._add("mousePan",Sr),this._add("touchPan",Lr,["touchZoom","touchRotate"]);const Qr=new un,fn=new hn;ut.touchZoomRotate=new Sn(pt,fn,Qr,It),this._add("touchRotate",Qr,["touchPan","touchZoom"]),this._add("touchZoom",fn,["touchPan","touchRotate"]),this._add("blockableMapEvent",new $a(ut));const xn=ut.scrollZoom=new yn(ut,this);this._add("scrollZoom",xn,["mousePan"]);const vn=ut.keyboard=new mn;this._add("keyboard",vn);for(const pt of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])Ye.interactive&&Ye[pt]&&ut[pt].enable(Ye[pt])}_add(Ye,ut,pt){this._handlers.push({handlerName:Ye,handler:ut,allowed:pt}),this._handlersById[Ye]=ut}stop(Ye){if(!this._updatingCamera){for(const{handler:Ye}of this._handlers)Ye.reset();this._inertia.clear(),this._fireEvents({},{},Ye),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:Ye}of this._handlers)if(Ye.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!In(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(Ye,ut,pt){for(const wt in Ye)if(wt!==pt&&(!ut||ut.indexOf(wt)<0))return!0;return!1}handleWindowEvent(Ye){this.handleEvent(Ye,`${Ye.type}Window`)}_getMapTouches(Ye){const ut=[];for(const pt of Ye)this._el.contains(pt.target)&&ut.push(pt);return ut}handleEvent(Ye,ut){this._updatingCamera=!0;const pt="renderFrame"===Ye.type,wt=pt?void 0:Ye,Tt={needsRenderFrame:!1},St={},It={},Lt=Ye.touches?this._getMapTouches(Ye.touches):void 0,$t=Lt?f(this._el,Lt):pt?void 0:p(this._el,Ye);for(const{handlerName:pt,handler:Xt,allowed:Sr}of this._handlers){if(!Xt.isEnabled())continue;let Lr;this._blockedByActive(It,Sr,pt)?Xt.reset():Xt[ut||Ye.type]&&(Lr=Xt[ut||Ye.type](Ye,$t,Lt),this.mergeHandlerResult(Tt,St,Lr,pt,wt),Lr&&Lr.needsRenderFrame&&this._triggerRenderFrame()),(Lr||Xt.isActive())&&(It[pt]=Xt)}const Xt={};for(const Ye in this._previousActiveHandlers)It[Ye]||(Xt[Ye]=wt);this._previousActiveHandlers=It,(Object.keys(Xt).length||An(Tt))&&(this._changes.push([Tt,St,Xt]),this._triggerRenderFrame()),(Object.keys(It).length||An(Tt))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:Sr}=Tt;Sr&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],Sr(this._map))}mergeHandlerResult(ut,pt,wt,Tt,St){if(!wt)return;Ye.W(ut,wt);const It={handlerName:Tt,originalEvent:wt.originalEvent||St};void 0!==wt.zoomDelta&&(pt.zoom=It),void 0!==wt.panDelta&&(pt.drag=It),void 0!==wt.pitchDelta&&(pt.pitch=It),void 0!==wt.bearingDelta&&(pt.rotate=It)}_applyChanges(){const ut={},pt={},wt={};for(const[Tt,St,It]of this._changes)Tt.panDelta&&(ut.panDelta=(ut.panDelta||new Ye.P(0,0))._add(Tt.panDelta)),Tt.zoomDelta&&(ut.zoomDelta=(ut.zoomDelta||0)+Tt.zoomDelta),Tt.bearingDelta&&(ut.bearingDelta=(ut.bearingDelta||0)+Tt.bearingDelta),Tt.pitchDelta&&(ut.pitchDelta=(ut.pitchDelta||0)+Tt.pitchDelta),void 0!==Tt.around&&(ut.around=Tt.around),void 0!==Tt.aroundCoord&&(ut.aroundCoord=Tt.aroundCoord),void 0!==Tt.pinchAround&&(ut.pinchAround=Tt.pinchAround),Tt.noInertia&&(ut.noInertia=Tt.noInertia),Ye.W(pt,St),Ye.W(wt,It);this._updateMapTransform(ut,pt,wt),this._changes=[]}_updateMapTransform(ut,pt,wt){const Tt=this._map,St=Tt.transform,n=Ye=>[Ye.x,Ye.y,Ye.z];if((Ye=>{const ut=this._eventsInProgress.drag;return ut&&!this._handlersById[ut.handlerName].isActive()})()&&!An(ut)){const Ye=St.zoom;St.cameraElevationReference="sea",null!=this._originalZoom&&St._orthographicProjectionAtLowPitch&&"globe"!==St.projection.name&&0===St.pitch?(St.cameraElevationReference="ground",St.zoom=this._originalZoom):(St.recenterOnTerrain(),St.cameraElevationReference="ground"),Ye!==St.zoom&&this._map._update(!0)}if(St._isCameraConstrained&&Tt._stop(!0),!An(ut))return void this._fireEvents(pt,wt,!0);let{panDelta:It,zoomDelta:Lt,bearingDelta:$t,pitchDelta:Xt,around:Sr,aroundCoord:Lr,pinchAround:Qr}=ut;St._isCameraConstrained&&(Lt>0&&(Lt=0),St._isCameraConstrained=!1),void 0!==Qr&&(Sr=Qr),(Lt||(Ye=>pt[Ye]&&!this._eventsInProgress[Ye])("drag"))&&Sr&&(this._dragOrigin=n(St.pointCoordinate3D(Sr)),this._originalZoom=St.zoom,this._trackingEllipsoid.setup(St._camera.position,this._dragOrigin)),St.cameraElevationReference="sea",Tt._stop(!0),Sr=Sr||Tt.transform.centerPoint,$t&&(St.bearing+=$t),Xt&&(St.pitch+=Xt),St._updateCameraState();const fn=[0,0,0];if(It)if("mercator"===St.projection.name){const Ye=this._trackingEllipsoid.projectRay(St.screenPointToMercatorRay(Sr).dir),ut=this._trackingEllipsoid.projectRay(St.screenPointToMercatorRay(Sr.sub(It)).dir);fn[0]=ut[0]-Ye[0],fn[1]=ut[1]-Ye[1]}else{const ut=St.pointCoordinate(Sr);if("globe"===St.projection.name){It=It.rotate(-St.angle);const pt=St._pixelsPerMercatorPixel/St.worldSize;fn[0]=-It.x*Ye.d3(Ye.ay(ut.y))*pt,fn[1]=-It.y*Ye.d3(St.center.lat)*pt}else{const Ye=St.pointCoordinate(Sr.sub(It));ut&&Ye&&(fn[0]=Ye.x-ut.x,fn[1]=Ye.y-ut.y)}}const xn=St.zoom,vn=[0,0,0];if(Lt){const ut=n(Lr||St.pointCoordinate3D(Sr)),pt={dir:Ye._.normalize([],Ye._.sub([],ut,St._camera.position))};if(pt.dir[2]<0){const wt=St.zoomDeltaToMovement(ut,Lt);Ye._.scale(vn,pt.dir,wt)}}const kn=Ye._.add(fn,fn,vn);St._translateCameraConstrained(kn),Lt&&Math.abs(St.zoom-xn)>1e-4&&St.recenterOnTerrain(),St.cameraElevationReference="ground",this._map._update(),ut.noInertia||this._inertia.record(ut),this._fireEvents(pt,wt,!0)}_fireEvents(ut,pt,wt){const Tt=In(this._eventsInProgress),St=In(ut),It={};for(const Ye in ut){const{originalEvent:pt}=ut[Ye];this._eventsInProgress[Ye]||(It[`${Ye}start`]=pt),this._eventsInProgress[Ye]=ut[Ye]}!Tt&&St&&this._fireEvent("movestart",St.originalEvent);for(const Ye in It)this._fireEvent(Ye,It[Ye]);St&&this._fireEvent("move",St.originalEvent);for(const Ye in ut){const{originalEvent:pt}=ut[Ye];this._fireEvent(Ye,pt)}const Lt={};let $t;for(const Ye in this._eventsInProgress){const{handlerName:ut,originalEvent:wt}=this._eventsInProgress[Ye];this._handlersById[ut].isActive()||(delete this._eventsInProgress[Ye],$t=pt[ut]||wt,Lt[`${Ye}end`]=$t)}for(const Ye in Lt)this._fireEvent(Ye,Lt[Ye]);const Xt=In(this._eventsInProgress);if(wt&&(Tt||St)&&!Xt){this._updatingCamera=!0;const ut=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=Ye=>0!==Ye&&-this._bearingSnap<Ye&&Ye<this._bearingSnap;ut?(i(ut.bearing||this._map.getBearing())&&(ut.bearing=0),this._map.easeTo(ut,{originalEvent:$t})):(this._map.fire(new Ye.f("moveend",{originalEvent:$t})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(ut,pt){this._map.fire(new Ye.f(ut,pt?{originalEvent:pt}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((Ye=>{this._frameId=void 0,this.handleEvent(new Ln("renderFrame",{timeStamp:Ye})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Nd="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Mn extends Ye.E{constructor(ut,pt){super(),this._moving=!1,this._zooming=!1,this.transform=ut,this._bearingSnap=pt.bearingSnap,this._respectPrefersReducedMotion=!1!==pt.respectPrefersReducedMotion,Ye.bp(["_renderFrameCallback"],this)}getCenter(){return new Ye.aI(this.transform.center.lng,this.transform.center.lat)}setCenter(Ye,ut){return this.jumpTo({center:Ye},ut)}panBy(ut,pt,wt){return ut=Ye.P.convert(ut).mult(-1),this.panTo(this.transform.center,Ye.W({offset:ut},pt),wt)}panTo(ut,pt,wt){return this.easeTo(Ye.W({center:ut},pt),wt)}getZoom(){return this.transform.zoom}setZoom(Ye,ut){return this.jumpTo({zoom:Ye},ut),this}zoomTo(ut,pt,wt){return this.easeTo(Ye.W({zoom:ut},pt),wt)}zoomIn(Ye,ut){return this.zoomTo(this.getZoom()+1,Ye,ut),this}zoomOut(Ye,ut){return this.zoomTo(this.getZoom()-1,Ye,ut),this}getBearing(){return this.transform.bearing}setBearing(Ye,ut){return this.jumpTo({bearing:Ye},ut),this}getPadding(){return this.transform.padding}setPadding(Ye,ut){return this.jumpTo({padding:Ye},ut),this}rotateTo(ut,pt,wt){return this.easeTo(Ye.W({bearing:ut},pt),wt)}resetNorth(ut,pt){return this.rotateTo(0,Ye.W({duration:1e3},ut),pt),this}resetNorthPitch(ut,pt){return this.easeTo(Ye.W({bearing:0,pitch:0,duration:1e3},ut),pt),this}snapToNorth(Ye,ut){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(Ye,ut):this}getPitch(){return this.transform.pitch}setPitch(Ye,ut){return this.jumpTo({pitch:Ye},ut),this}cameraForBounds(ut,pt){ut=Ye.ai.convert(ut);const wt=pt&&pt.bearing||0,Tt=pt&&pt.pitch||0,St=ut.getNorthWest(),It=ut.getSouthEast();return this._cameraForBounds(this.transform,St,It,wt,Tt,pt)}_extendPadding(ut){const pt={top:0,right:0,bottom:0,left:0};return null==ut?Ye.W({},pt,this.transform.padding):"number"==typeof ut?{top:ut,bottom:ut,right:ut,left:ut}:Ye.W({},pt,ut)}_extendCameraOptions(ut){return(ut=Ye.W({offset:[0,0],maxZoom:this.transform.maxZoom},ut)).padding=this._extendPadding(ut.padding),ut}_minimumAABBFrustumDistance(Ye,ut){const pt=ut.max[0]-ut.min[0],wt=ut.max[1]-ut.min[1];return pt/wt>Ye.aspect?pt/(2*Math.tan(.5*Ye.fovX)*Ye.aspect):wt/(2*Math.tan(.5*Ye.fovY)*Ye.aspect)}_cameraForBoundsOnGlobe(ut,pt,wt,Tt,St,It){const Lt=ut.clone(),$t=this._extendCameraOptions(It);Lt.bearing=Tt,Lt.pitch=St;const Xt=Ye.aI.convert(pt),Sr=Ye.aI.convert(wt),Lr=.5*(Xt.lat+Sr.lat),Qr=.5*(Xt.lng+Sr.lng),fn=Ye.d4(Lr,Qr),xn=Ye._.normalize([],fn),vn=Ye._.normalize([],Ye._.cross([],xn,[0,1,0])),kn=Ye._.cross([],vn,xn),Wn=[vn[0],vn[1],vn[2],0,kn[0],kn[1],kn[2],0,xn[0],xn[1],xn[2],0,0,0,0,1],Xn=[fn,Ye.d4(Xt.lat,Xt.lng),Ye.d4(Sr.lat,Xt.lng),Ye.d4(Sr.lat,Sr.lng),Ye.d4(Xt.lat,Sr.lng),Ye.d4(Lr,Xt.lng),Ye.d4(Lr,Sr.lng),Ye.d4(Xt.lat,Qr),Ye.d4(Sr.lat,Qr)];let Jn=Ye.b6.fromPoints(Xn.map((ut=>[Ye._.dot(vn,ut),Ye._.dot(kn,ut),Ye._.dot(xn,ut)])));const Qn=Ye._.transformMat4([],Jn.center,Wn);0===Ye._.squaredLength(Qn)&&Ye._.set(Qn,0,0,1),Ye._.normalize(Qn,Qn),Ye._.scale(Qn,Qn,Ye.cD),Lt.center=Ye.d5(Qn);const ko=Lt.getWorldToCameraMatrix(),Fo=Ye.ad.invert(new Float64Array(16),ko);Jn=Ye.b6.applyTransform(Jn,Ye.ad.multiply([],ko,Wn));const is=this._extendAABB(Jn,Lt,$t,Tt);if(!is)return void Ye.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Jn=is,Ye._.transformMat4(Qn,Qn,ko);const ns=.5*(Jn.max[2]-Jn.min[2]),ss=this._minimumAABBFrustumDistance(Lt,Jn),as=Ye._.scale([],[0,0,1],ns),ds=Ye._.add(as,Qn,as),ps=ss+(0===Lt.pitch?0:Ye._.distance(Qn,ds)),ms=Lt.globeCenterInViewSpace,Js=Ye._.sub([],Qn,[ms[0],ms[1],ms[2]]);Ye._.normalize(Js,Js),Ye._.scale(Js,Js,ps);const ua=Ye._.add([],Qn,Js);Ye._.transformMat4(ua,ua,Fo);const ba=Ye.d7/Ye.cD,Ra=Ye._.length(ua),La=Ye.ax(Math.max(Ra*ba-Ye.d7,Number.EPSILON),0),ll=Math.min(Lt.zoomFromMercatorZAdjusted(La),$t.maxZoom);return ll>.5*(Ye.b1+Ye.aU)?(Lt.setProjection({name:"mercator"}),Lt.zoom=ll,this._cameraForBounds(Lt,pt,wt,Tt,St,It)):{center:Lt.center,zoom:ll,bearing:Tt,pitch:St}}_extendAABB(ut,pt,wt,Tt){const St=.5*((wt.padding.left||0)+(wt.padding.right||0)),It=.5*((wt.padding.top||0)+(wt.padding.bottom||0)),Lt=It,$t=St,Xt=St,Sr=It,Lr=pt.width-($t+Xt),Qr=pt.height-(Lt+Sr),fn=Ye._.sub([],ut.max,ut.min),xn=Math.min(Lr/fn[0],Qr/fn[1]),vn=Math.min(pt.scaleZoom(pt.scale*xn),wt.maxZoom);if(isNaN(vn))return null;const kn=pt.scale/pt.zoomScale(vn),Wn=new Ye.b6([ut.min[0]-$t*kn,ut.min[1]-Sr*kn,ut.min[2]],[ut.max[0]+Xt*kn,ut.max[1]+Lt*kn,ut.max[2]]),Xn=("number"==typeof wt.offset.x&&"number"==typeof wt.offset.y?new Ye.P(wt.offset.x,wt.offset.y):Ye.P.convert(wt.offset)).rotate(-Ye.ab(Tt));return Wn.center[0]-=Xn.x*kn,Wn.center[1]+=Xn.y*kn,Wn}queryTerrainElevation(ut,pt){const wt=this.transform.elevation;return wt?(pt=Ye.W({},{exaggerated:!0},pt),wt.getAtPoint(Ye.Y.fromLngLat(ut),null,pt.exaggerated)):null}_cameraForBounds(ut,pt,wt,Tt,St,It){if("globe"===ut.projection.name)return this._cameraForBoundsOnGlobe(ut,pt,wt,Tt,St,It);const Lt=ut.clone(),$t=this._extendCameraOptions(It);Lt.bearing=Tt,Lt.pitch=St;const Xt=Ye.aI.convert(pt),Sr=Ye.aI.convert(wt),Lr=new Ye.aI(Xt.lng,Sr.lat),Qr=new Ye.aI(Sr.lng,Xt.lat),fn=Lt.project(Xt),xn=Lt.project(Sr),vn=this.queryTerrainElevation(Xt),kn=this.queryTerrainElevation(Sr),Wn=this.queryTerrainElevation(Lr),Xn=this.queryTerrainElevation(Qr),Jn=[[fn.x,fn.y,Math.min(vn||0,kn||0,Wn||0,Xn||0)],[xn.x,xn.y,Math.max(vn||0,kn||0,Wn||0,Xn||0)]];let Qn=Ye.b6.fromPoints(Jn);const ko=Lt.getWorldToCameraMatrix(),Fo=Ye.ad.invert(new Float64Array(16),ko);Qn=Ye.b6.applyTransform(Qn,ko);const is=this._extendAABB(Qn,Lt,$t,Tt);if(!is)return void Ye.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Qn=is;const ns=.5*Ye._.sub([],Qn.max,Qn.min)[2],ss=this._minimumAABBFrustumDistance(Lt,Qn),as=[0,0,1,0];Ye.aA.transformMat4(as,as,ko),Ye.aA.normalize(as,as);const ds=Ye._.scale([],as,ss+ns),ps=Ye._.add([],Qn.center,ds);Ye._.transformMat4(Qn.center,Qn.center,Fo),Ye._.transformMat4(ps,ps,Fo);const ms=[Qn.center[0],Qn.center[1],ps[2]*Lt.pixelsPerMeter];Ye._.scale(ms,ms,1/Lt.worldSize);const Js=Ye.d6(ms[0]),ua=Ye.ay(ms[1]),ba=Math.min(Lt._zoomFromMercatorZ(ms[2]),$t.maxZoom),Ra=new Ye.aI(Js,ua);return Lt.mercatorFromTransition&&ba<.5*(Ye.b1+Ye.aU)?(Lt.setProjection({name:"globe"}),Lt.zoom=ba,this._cameraForBounds(Lt,pt,wt,Tt,St,It)):{center:Ra,zoom:ba,bearing:Tt,pitch:St}}fitBounds(Ye,ut,pt){const wt=this.cameraForBounds(Ye,ut);return this._fitInternal(wt,ut,pt)}fitScreenCoordinates(ut,pt,wt,Tt,St){const It=Ye.P.convert(ut),Lt=Ye.P.convert(pt),$t=new Ye.P(Math.min(It.x,Lt.x),Math.min(It.y,Lt.y)),Xt=new Ye.P(Math.max(It.x,Lt.x),Math.max(It.y,Lt.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(It,Lt))return this;const Sr=this.transform.pointLocation3D($t),Lr=this.transform.pointLocation3D(Xt),Qr=this.transform.pointLocation3D(new Ye.P($t.x,Xt.y)),fn=this.transform.pointLocation3D(new Ye.P(Xt.x,$t.y)),xn=[Math.min(Sr.lng,Lr.lng,Qr.lng,fn.lng),Math.min(Sr.lat,Lr.lat,Qr.lat,fn.lat)],vn=[Math.max(Sr.lng,Lr.lng,Qr.lng,fn.lng),Math.max(Sr.lat,Lr.lat,Qr.lat,fn.lat)],kn=Tt&&Tt.pitch?Tt.pitch:this.getPitch(),Wn=this._cameraForBounds(this.transform,xn,vn,wt,kn,Tt);return this._fitInternal(Wn,Tt,St)}_fitInternal(ut,pt,wt){return ut?(pt=Ye.W(ut,pt)).linear?this.easeTo(pt,wt):this.flyTo(pt,wt):this}jumpTo(ut,pt){this.stop();const wt=ut.preloadOnly?this.transform.clone():this.transform;let Tt=!1,St=!1,It=!1;if("zoom"in ut&&wt.zoom!==+ut.zoom&&(Tt=!0,wt.zoom=+ut.zoom),void 0!==ut.center&&(wt.center=Ye.aI.convert(ut.center)),"bearing"in ut&&wt.bearing!==+ut.bearing&&(St=!0,wt.bearing=+ut.bearing),"pitch"in ut&&wt.pitch!==+ut.pitch&&(It=!0,wt.pitch=+ut.pitch),null!=ut.padding){const Ye="number"==typeof ut.padding?this._extendPadding(ut.padding):ut.padding;wt.isPaddingEqual(Ye)||(wt.padding=Ye)}return ut.preloadOnly?(this._preloadTiles(wt),this):(this.fire(new Ye.f("movestart",pt)).fire(new Ye.f("move",pt)),Tt&&this.fire(new Ye.f("zoomstart",pt)).fire(new Ye.f("zoom",pt)).fire(new Ye.f("zoomend",pt)),St&&this.fire(new Ye.f("rotatestart",pt)).fire(new Ye.f("rotate",pt)).fire(new Ye.f("rotateend",pt)),It&&this.fire(new Ye.f("pitchstart",pt)).fire(new Ye.f("pitch",pt)).fire(new Ye.f("pitchend",pt)),this.fire(new Ye.f("moveend",pt)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||Ye.w(Nd),this.transform.getFreeCameraOptions()}setFreeCameraOptions(ut,pt){const wt=this.transform;if(!wt.projection.supportsFreeCamera)return Ye.w(Nd),this;this.stop();const Tt=wt.zoom,St=wt.pitch,It=wt.bearing;wt.setFreeCameraOptions(ut);const Lt=Tt!==wt.zoom,$t=St!==wt.pitch,Xt=It!==wt.bearing;return this.fire(new Ye.f("movestart",pt)).fire(new Ye.f("move",pt)),Lt&&this.fire(new Ye.f("zoomstart",pt)).fire(new Ye.f("zoom",pt)).fire(new Ye.f("zoomend",pt)),Xt&&this.fire(new Ye.f("rotatestart",pt)).fire(new Ye.f("rotate",pt)).fire(new Ye.f("rotateend",pt)),$t&&this.fire(new Ye.f("pitchstart",pt)).fire(new Ye.f("pitch",pt)).fire(new Ye.f("pitchend",pt)),this.fire(new Ye.f("moveend",pt)),this}easeTo(ut,pt){this._stop(!1,ut.easeId),(!1===(ut=Ye.W({offset:[0,0],duration:500,easing:Ye.d2},ut)).animate||this._prefersReducedMotion(ut))&&(ut.duration=0);const wt=this.transform,Tt=this.getZoom(),St=this.getBearing(),It=this.getPitch(),Lt=this.getPadding(),$t="zoom"in ut?+ut.zoom:Tt,Xt="bearing"in ut?this._normalizeBearing(ut.bearing,St):St,Sr="pitch"in ut?+ut.pitch:It,Lr=this._extendPadding(ut.padding),Qr=Ye.P.convert(ut.offset);let fn,xn,vn;if("globe"===wt.projection.name){const pt=Ye.Y.fromLngLat(wt.center),Tt=Qr.rotate(-wt.angle);pt.x+=Tt.x/wt.worldSize,pt.y+=Tt.y/wt.worldSize;const St=pt.toLngLat(),It=Ye.aI.convert(ut.center||St);this._normalizeCenter(It),fn=wt.centerPoint.add(Tt),xn=new Ye.P(pt.x,pt.y).mult(wt.worldSize),vn=new Ye.P(Ye.aj(It.lng),Ye.ak(It.lat)).mult(wt.worldSize).sub(xn)}else{fn=wt.centerPoint.add(Qr);const pt=wt.pointLocation(fn),Tt=Ye.aI.convert(ut.center||pt);this._normalizeCenter(Tt),xn=wt.project(pt),vn=wt.project(Tt).sub(xn)}const kn=wt.zoomScale($t-Tt);let Wn,Xn;ut.around&&(Wn=Ye.aI.convert(ut.around),Xn=wt.locationPoint(Wn));const Jn=this._zooming||$t!==Tt,Qn=this._rotating||St!==Xt,ko=this._pitching||Sr!==It,Fo=!wt.isPaddingEqual(Lr),T=wt=>is=>{if(Jn&&(wt.zoom=Ye.a2(Tt,$t,is)),Qn&&(wt.bearing=Ye.a2(St,Xt,is)),ko&&(wt.pitch=Ye.a2(It,Sr,is)),Fo&&(wt.interpolatePadding(Lt,Lr,is),fn=wt.centerPoint.add(Qr)),Wn)wt.setLocationAtPoint(Wn,Xn);else{const Ye=wt.zoomScale(wt.zoom-Tt),ut=$t>Tt?Math.min(2,kn):Math.max(.5,kn),pt=Math.pow(ut,1-is),St=wt.unproject(xn.add(vn.mult(is*pt)).mult(Ye));wt.setLocationAtPoint(wt.renderWorldCopies?St.wrap():St,fn)}return ut.preloadOnly||this._fireMoveEvents(pt),wt};if(ut.preloadOnly){const Ye=this._emulate(T,ut.duration,wt);return this._preloadTiles(Ye),this}const is={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Jn,this._rotating=Qn,this._pitching=ko,this._padding=Fo,this._easeId=ut.easeId,this._prepareEase(pt,ut.noMoveStart,is),this._ease(T(wt),(Ye=>{"sea"===wt.cameraElevationReference&&wt.recenterOnTerrain(),this._afterEase(pt,Ye)}),ut),this}_prepareEase(ut,pt,wt={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),pt||wt.moving||this.fire(new Ye.f("movestart",ut)),this._zooming&&!wt.zooming&&this.fire(new Ye.f("zoomstart",ut)),this._rotating&&!wt.rotating&&this.fire(new Ye.f("rotatestart",ut)),this._pitching&&!wt.pitching&&this.fire(new Ye.f("pitchstart",ut))}_fireMoveEvents(ut){this.fire(new Ye.f("move",ut)),this._zooming&&this.fire(new Ye.f("zoom",ut)),this._rotating&&this.fire(new Ye.f("rotate",ut)),this._pitching&&this.fire(new Ye.f("pitch",ut))}_afterEase(ut,pt){if(this._easeId&&pt&&this._easeId===pt)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const wt=this._zooming,Tt=this._rotating,St=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,wt&&this.fire(new Ye.f("zoomend",ut)),Tt&&this.fire(new Ye.f("rotateend",ut)),St&&this.fire(new Ye.f("pitchend",ut)),this.fire(new Ye.f("moveend",ut))}flyTo(ut,pt){if(this._prefersReducedMotion(ut)){const wt=Ye.ah(ut,["center","zoom","bearing","pitch","around","padding"]);return this.jumpTo(wt,pt)}this.stop(),ut=Ye.W({offset:[0,0],speed:1.2,curve:1.42,easing:Ye.d2},ut);const wt=this.transform,Tt=this.getZoom(),St=this.getBearing(),It=this.getPitch(),Lt=this.getPadding(),$t="zoom"in ut?Ye.at(+ut.zoom,wt.minZoom,wt.maxZoom):Tt,Xt="bearing"in ut?this._normalizeBearing(ut.bearing,St):St,Sr="pitch"in ut?+ut.pitch:It,Lr=this._extendPadding(ut.padding),Qr=wt.zoomScale($t-Tt),fn=Ye.P.convert(ut.offset);let xn=wt.centerPoint.add(fn);const vn=wt.pointLocation(xn),kn=Ye.aI.convert(ut.center||vn);this._normalizeCenter(kn);const Wn=wt.project(vn),Xn=wt.project(kn).sub(Wn);let Jn=ut.curve;const Qn=Math.max(wt.width,wt.height),ko=Qn/Qr,Fo=Xn.mag();if("minZoom"in ut){const pt=Ye.at(Math.min(ut.minZoom,Tt,$t),wt.minZoom,wt.maxZoom),St=Qn/wt.zoomScale(pt-Tt);Jn=Math.sqrt(St/Fo*2)}const is=Jn*Jn;function E(Ye){const ut=(ko*ko-Qn*Qn+(Ye?-1:1)*is*is*Fo*Fo)/(2*(Ye?ko:Qn)*is*Fo);return Math.log(Math.sqrt(ut*ut+1)-ut)}function C(Ye){return(Math.exp(Ye)-Math.exp(-Ye))/2}function S(Ye){return(Math.exp(Ye)+Math.exp(-Ye))/2}const ns=E(0);let L=function(Ye){return S(ns)/S(ns+Jn*Ye)},P=function(Ye){return Qn*((S(ns)*(C(ut=ns+Jn*Ye)/S(ut))-C(ns))/is)/Fo;var ut},ss=(E(1)-ns)/Jn;if(Math.abs(Fo)<1e-6||!isFinite(ss)){if(Math.abs(Qn-ko)<1e-6)return this.easeTo(ut,pt);const Ye=ko<Qn?-1:1;ss=Math.abs(Math.log(ko/Qn))/Jn,P=function(){return 0},L=function(ut){return Math.exp(Ye*Jn*ut)}}ut.duration="duration"in ut?+ut.duration:1e3*ss/("screenSpeed"in ut?+ut.screenSpeed/Jn:+ut.speed),ut.maxDuration&&ut.duration>ut.maxDuration&&(ut.duration=0);const as=St!==Xt,ds=Sr!==It,ps=!wt.isPaddingEqual(Lr),z=wt=>Qr=>{const vn=Qr*ss,Jn=1/L(vn);wt.zoom=1===Qr?$t:Tt+wt.scaleZoom(Jn),as&&(wt.bearing=Ye.a2(St,Xt,Qr)),ds&&(wt.pitch=Ye.a2(It,Sr,Qr)),ps&&(wt.interpolatePadding(Lt,Lr,Qr),xn=wt.centerPoint.add(fn));const Qn=1===Qr?kn:wt.unproject(Wn.add(Xn.mult(P(vn))).mult(Jn));return wt.setLocationAtPoint(wt.renderWorldCopies?Qn.wrap():Qn,xn),wt._updateCameraOnTerrain(),ut.preloadOnly||this._fireMoveEvents(pt),wt};if(ut.preloadOnly){const Ye=this._emulate(z,ut.duration,wt);return this._preloadTiles(Ye),this}return this._zooming=!0,this._rotating=as,this._pitching=ds,this._padding=ps,this._prepareEase(pt,!1),this._ease(z(wt),(()=>this._afterEase(pt)),ut),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(Ye){}_cancelRenderFrame(Ye){}_stop(Ye,ut){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const Ye=this._onEaseEnd;this._onEaseEnd=void 0,Ye.call(this,ut)}if(!Ye){const Ye=this.handlers;Ye&&Ye.stop(!1)}return this}_ease(ut,pt,wt){!1===wt.animate||0===wt.duration?(ut(1),pt()):(this._easeStart=Ye.e.now(),this._easeOptions=wt,this._onEaseFrame=ut,this._onEaseEnd=pt,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const ut=Math.min((Ye.e.now()-this._easeStart)/this._easeOptions.duration,1),pt=this._onEaseFrame;pt&&pt(this._easeOptions.easing(ut)),ut<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(ut,pt){ut=Ye.au(ut,-180,180);const wt=Math.abs(ut-pt);return Math.abs(ut-360-pt)<wt&&(ut-=360),Math.abs(ut+360-pt)<wt&&(ut+=360),ut}_normalizeCenter(Ye){const ut=this.transform;if(ut.maxBounds)return;if("globe"!==ut.projection.name&&!ut.renderWorldCopies)return;const pt=Ye.lng-ut.center.lng;Ye.lng+=pt>180?-360:pt<-180?360:0}_prefersReducedMotion(ut){return this._respectPrefersReducedMotion&&Ye.e.prefersReducedMotion&&!(ut&&ut.essential)}_emulate(Ye,ut,pt){const wt=Math.ceil(15*ut/1e3),Tt=[],St=Ye(pt.clone());for(let Ye=0;Ye<=wt;Ye++){const ut=St(Ye/wt);Tt.push(ut.clone())}return Tt}_preloadTiles(Ye,ut){}}class zn{constructor(ut={}){this.options=ut,Ye.bp(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(Ye){const ut=this.options&&this.options.compact;return this._map=Ye,this._container=a("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=a("button","mapboxgl-ctrl-attrib-button",this._container),a("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=a("div","mapboxgl-ctrl-attrib-inner",this._container),ut&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===ut&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(Ye,ut){const pt=this._map._getUIString(`AttributionControl.${ut}`);Ye.removeAttribute("title"),Ye.firstElementChild&&Ye.firstElementChild.setAttribute("title",pt)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let ut=this._editLink;ut||(ut=this._editLink=this._container.querySelector(".mapbox-improve-map"));const pt=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||Ye.d8.ACCESS_TOKEN}];if(ut){const wt=pt.reduce(((Ye,ut,wt)=>(ut.value&&(Ye+=`${ut.key}=${ut.value}${wt<pt.length-1?"&":""}`),Ye)),"?");ut.href=`${Ye.d8.FEEDBACK_URL}/${wt}#${Oa(this._map,!0)}`,ut.rel="noopener nofollow",this._setElementTitle(ut,"MapFeedback")}}_updateData(Ye){!Ye||"metadata"!==Ye.sourceDataType&&"visibility"!==Ye.sourceDataType&&"style"!==Ye.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let Ye=[];if(this._map.style.stylesheet){const Ye=this._map.style.stylesheet;this.styleOwner=Ye.owner,this.styleId=Ye.id}const ut=this._map.style._mergedSourceCaches;for(const pt in ut){const wt=ut[pt];if(wt.used){const ut=wt.getSource();ut.attribution&&Ye.indexOf(ut.attribution)<0&&Ye.push(ut.attribution)}}Ye.sort(((Ye,ut)=>Ye.length-ut.length)),Ye=Ye.filter(((ut,pt)=>{for(let wt=pt+1;wt<Ye.length;wt++)if(Ye[wt].indexOf(ut)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?Ye=[...this.options.customAttribution,...Ye]:Ye.unshift(this.options.customAttribution));const pt=Ye.join(" | ");pt!==this._attribHTML&&(this._attribHTML=pt,Ye.length?(this._innerContainer.innerHTML=pt,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class On{constructor(){Ye.bp(["_updateLogo","_updateCompact"],this)}onAdd(Ye){this._map=Ye,this._container=a("div","mapboxgl-ctrl");const ut=a("a","mapboxgl-ctrl-logo");return ut.target="_blank",ut.rel="noopener nofollow",ut.href="https://www.mapbox.com/",ut.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),ut.setAttribute("rel","noopener nofollow"),this._container.appendChild(ut),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(Ye){Ye&&"metadata"!==Ye.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const Ye=this._map.style._sourceCaches;if(0===Object.entries(Ye).length)return!0;for(const ut in Ye){const pt=Ye[ut].getSource();if(pt.hasOwnProperty("mapbox_logo")&&!pt.mapbox_logo)return!1}return!0}_updateCompact(){const Ye=this._container.children;if(Ye.length){const ut=Ye[0];this._map.getCanvasContainer().offsetWidth<250?ut.classList.add("mapboxgl-compact"):ut.classList.remove("mapboxgl-compact")}}}class Fn{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(Ye){const ut=++this._id;return this._queue.push({callback:Ye,id:ut,cancelled:!1}),ut}remove(Ye){const ut=this._currentlyRunning,pt=ut?this._queue.concat(ut):this._queue;for(const ut of pt)if(ut.id===Ye)return void(ut.cancelled=!0)}run(Ye=0){const ut=this._currentlyRunning=this._queue;this._queue=[];for(const pt of ut)if(!pt.cancelled&&(pt.callback(Ye),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Bn(ut,pt,wt){if(ut=new Ye.aI(ut.lng,ut.lat),pt){const Tt=new Ye.aI(ut.lng-360,ut.lat),St=new Ye.aI(ut.lng+360,ut.lat),It=360*Math.ceil(Math.abs(ut.lng-wt.center.lng)/360),Lt=wt.locationPoint(ut).distSqr(pt),$t=pt.x<0||pt.y<0||pt.x>wt.width||pt.y>wt.height;wt.locationPoint(Tt).distSqr(pt)<Lt&&($t||Math.abs(Tt.lng-wt.center.lng)<It)?ut=Tt:wt.locationPoint(St).distSqr(pt)<Lt&&($t||Math.abs(St.lng-wt.center.lng)<It)&&(ut=St)}for(;Math.abs(ut.lng-wt.center.lng)>180;){const Ye=wt.locationPoint(ut);if(Ye.x>=0&&Ye.y>=0&&Ye.x<=wt.width&&Ye.y<=wt.height)break;ut.lng>wt.center.lng?ut.lng-=360:ut.lng+=360}return ut}const Vd={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Nn extends Ye.E{constructor(ut,pt){if(super(),(ut instanceof HTMLElement||pt)&&(ut=Ye.W({element:ut},pt)),Ye.bp(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=ut&&ut.anchor||"center",this._color=ut&&ut.color||"#3FB1CE",this._scale=ut&&ut.scale||1,this._draggable=ut&&ut.draggable||!1,this._clickTolerance=ut&&ut.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=ut&&ut.rotation||0,this._rotationAlignment=ut&&ut.rotationAlignment||"auto",this._pitchAlignment=ut&&ut.pitchAlignment&&ut.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=ut&&ut.occludedOpacity||.2,ut&&ut.element)this._element=ut.element,this._offset=Ye.P.convert(ut&&ut.offset||[0,0]);else{this._defaultMarker=!0,this._element=a("div");const pt=41,wt=27,Tt=n("svg",{display:"block",height:pt*this._scale+"px",width:wt*this._scale+"px",viewBox:`0 0 ${wt} ${pt}`},this._element),St=n("radialGradient",{id:"shadowGradient"},n("defs",{},Tt));n("stop",{offset:"10%","stop-opacity":.4},St),n("stop",{offset:"100%","stop-opacity":.05},St),n("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},Tt),n("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},Tt),n("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},Tt),n("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},Tt),this._offset=Ye.P.convert(ut&&ut.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(Ye=>{Ye.preventDefault()})),this._element.addEventListener("mousedown",(Ye=>{Ye.preventDefault()}));const wt=this._element.classList;for(const Ye in Vd)wt.remove(`mapboxgl-marker-anchor-${Ye}`);wt.add(`mapboxgl-marker-anchor-${this._anchor}`);const Tt=ut&&ut.className?ut.className.trim().split(/\s+/):[];wt.add(...Tt),this._popup=null}addTo(Ye){return Ye===this._map||(this.remove(),this._map=Ye,Ye.getCanvasContainer().appendChild(this._element),Ye.on("move",this._updateMoving),Ye.on("moveend",this._update),Ye.on("remove",this._clearFadeTimer),Ye._addMarker(this),this.setDraggable(this._draggable),this._update(),Ye.on("click",this._onMapClick)),this}remove(){const Ye=this._map;return Ye&&(Ye.off("click",this._onMapClick),Ye.off("move",this._updateMoving),Ye.off("moveend",this._update),Ye.off("mousedown",this._addDragHandler),Ye.off("touchstart",this._addDragHandler),Ye.off("mouseup",this._onUp),Ye.off("touchend",this._onUp),Ye.off("mousemove",this._onMove),Ye.off("touchmove",this._onMove),Ye.off("remove",this._clearFadeTimer),Ye._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(ut){return this._lngLat=Ye.aI.convert(ut),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(Ye){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),Ye){if(!("offset"in Ye.options)){const ut=38.1,pt=13.5,wt=Math.sqrt(Math.pow(pt,2)/2);Ye.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-ut],"bottom-left":[wt,-1*(ut-pt+wt)],"bottom-right":[-wt,-1*(ut-pt+wt)],left:[pt,-1*(ut-pt)],right:[-pt,-1*(ut-pt)]}:this._offset}this._popup=Ye,Ye._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(Ye){const ut=Ye.code,pt=Ye.charCode||Ye.keyCode;"Space"!==ut&&"Enter"!==ut&&32!==pt&&13!==pt||this.togglePopup()}_onMapClick(Ye){const ut=Ye.originalEvent.target,pt=this._element;this._popup&&(ut===pt||pt.contains(ut))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const Ye=this._popup;return Ye?(Ye.isOpen()?(Ye.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(Ye.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const Ye=this._map,ut=this._pos;if(!Ye||!ut)return!1;const pt=Ye.unproject(ut),wt=Ye.getFreeCameraOptions();if(!wt.position)return!1;const Tt=wt.position.toLngLat();return Tt.distanceTo(pt)<.9*Tt.distanceTo(this._lngLat)}_evaluateOpacity(){const ut=this._map;if(!ut)return;const pt=this._pos;if(!pt||pt.x<0||pt.x>ut.transform.width||pt.y<0||pt.y>ut.transform.height)return void this._clearFadeTimer();const wt=ut.unproject(pt);let Tt;ut._showingGlobe()&&Ye.d9(ut.transform,this._lngLat)?Tt=0:(Tt=1-ut._queryFogOpacity(wt),ut.transform._terrainEnabled()&&ut.getTerrain()&&this._behindTerrain()&&(Tt*=this._occludedOpacity)),this._element.style.opacity=`${Tt}`,this._element.style.pointerEvents=Tt>0?"auto":"none",this._popup&&this._popup._setOpacity(Tt),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const Ye=this._pos;if(!Ye||!this._map)return;const ut=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${Ye.x}px,${Ye.y}px)\n            ${Vd[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${ut.x}px,${ut.y}px)\n        `}_calculateXYTransform(){const ut=this._pos,pt=this._map,wt=this.getPitchAlignment();if(!pt||!ut||"map"!==wt)return"";if(!pt._showingGlobe()){const Ye=pt.getPitch();return Ye?`rotateX(${Ye}deg)`:""}const Tt=Ye.b0(Ye.da(pt.transform,this._lngLat)),St=ut.sub(Ye.db(pt.transform)),It=Math.abs(St.x)+Math.abs(St.y);if(0===It)return"";const Lt=Tt/It;return`rotateX(${-St.y*Lt}deg) rotateY(${St.x*Lt}deg)`}_calculateZTransform(){const ut=this._pos,pt=this._map;if(!pt||!ut)return"";let wt=0;const Tt=this.getRotationAlignment();if("map"===Tt)if(pt._showingGlobe()){const ut=pt.project(new Ye.aI(this._lngLat.lng,this._lngLat.lat+.001)),Tt=pt.project(new Ye.aI(this._lngLat.lng,this._lngLat.lat-.001)).sub(ut);wt=Ye.b0(Math.atan2(Tt.y,Tt.x))-90}else wt=-pt.getBearing();else if("horizon"===Tt){const Tt=Ye.$(4,6,pt.getZoom()),St=Ye.db(pt.transform);St.y+=Tt*pt.transform.height;const It=ut.sub(St),Lt=Ye.b0(Math.atan2(It.y,It.x));wt=(Lt>90?Lt-270:Lt+90)*(1-Tt)}return wt+=this._rotation,wt?`rotateZ(${wt}deg)`:""}_update(Ye){cancelAnimationFrame(this._updateFrameId);const ut=this._map;ut&&(ut.transform.renderWorldCopies&&(this._lngLat=Bn(this._lngLat,this._pos,ut.transform)),this._pos=ut.project(this._lngLat),!0===Ye?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),ut._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(ut._showingGlobe()||ut.getTerrain()||ut.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(ut){return this._offset=Ye.P.convert(ut),this._update(),this}addClassName(Ye){return this._element.classList.add(Ye),this}removeClassName(Ye){return this._element.classList.remove(Ye),this}toggleClassName(Ye){return this._element.classList.toggle(Ye)}_onMove(ut){const pt=this._map;if(!pt)return;const wt=this._pointerdownPos,Tt=this._positionDelta;if(wt&&Tt){if(!this._isDragging){const Ye=this._clickTolerance||pt._clickTolerance;if(ut.point.dist(wt)<Ye)return;this._isDragging=!0}this._pos=ut.point.sub(Tt),this._lngLat=pt.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new Ye.f("dragstart"))),this.fire(new Ye.f("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const ut=this._map;ut&&(ut.off("mousemove",this._onMove),ut.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new Ye.f("dragend")),this._state="inactive"}_addDragHandler(Ye){const ut=this._map,pt=this._pos;ut&&pt&&this._element.contains(Ye.originalEvent.target)&&(Ye.preventDefault(),this._positionDelta=Ye.point.sub(pt),this._pointerdownPos=Ye.point,this._state="pending",ut.on("mousemove",this._onMove),ut.on("touchmove",this._onMove),ut.once("mouseup",this._onUp),ut.once("touchend",this._onUp))}setDraggable(Ye){this._draggable=!!Ye;const ut=this._map;return ut&&(Ye?(ut.on("mousedown",this._addDragHandler),ut.on("touchstart",this._addDragHandler)):(ut.off("mousedown",this._addDragHandler),ut.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(Ye){return this._rotation=Ye||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(Ye){return this._rotationAlignment=Ye||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(Ye){return this._pitchAlignment=Ye||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(Ye){return this._occludedOpacity=Ye||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Ud={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},jd=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function jn(ut=new Ye.P(0,0),pt="bottom"){if("number"==typeof ut){const wt=Math.round(Math.sqrt(.5*Math.pow(ut,2)));switch(pt){case"top":return new Ye.P(0,ut);case"top-left":return new Ye.P(wt,wt);case"top-right":return new Ye.P(-wt,wt);case"bottom":return new Ye.P(0,-ut);case"bottom-left":return new Ye.P(wt,-wt);case"bottom-right":return new Ye.P(-wt,-wt);case"left":return new Ye.P(ut,0);case"right":return new Ye.P(-ut,0)}return new Ye.P(0,0)}return ut instanceof Ye.P||Array.isArray(ut)?Ye.P.convert(ut):Ye.P.convert(ut[pt]||[0,0])}class Vn{constructor(Ye){this.jumpTo(Ye)}getValue(ut){if(ut<=this._startTime)return this._start;if(ut>=this._endTime)return this._end;const pt=Ye.b9((ut-this._startTime)/(this._endTime-this._startTime));return this._start*(1-pt)+this._end*pt}isEasing(Ye){return Ye>=this._startTime&&Ye<=this._endTime}jumpTo(Ye){this._startTime=-1/0,this._endTime=-1/0,this._start=Ye,this._end=Ye}easeTo(Ye,ut,pt){this._start=this.getValue(ut),this._end=Ye,this._startTime=ut,this._endTime=ut+pt}}const Gd={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Zn{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}const qd={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},Zd={showCompass:!0,showZoom:!0,visualizePitch:!1};class $n{constructor(ut,pt,wt=!1){this._clickTolerance=10,this.element=pt,this.mouseRotate=new rn({clickTolerance:ut.dragRotate._mouseRotate._clickTolerance}),this.map=ut,wt&&(this.mousePitch=new an({clickTolerance:ut.dragRotate._mousePitch._clickTolerance})),Ye.bp(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),pt.addEventListener("mousedown",this.mousedown),pt.addEventListener("touchstart",this.touchstart,{passive:!1}),pt.addEventListener("touchmove",this.touchmove),pt.addEventListener("touchend",this.touchend),pt.addEventListener("touchcancel",this.reset)}down(Ye,ut){this.mouseRotate.mousedown(Ye,ut),this.mousePitch&&this.mousePitch.mousedown(Ye,ut),h()}move(Ye,ut){const pt=this.map,wt=this.mouseRotate.mousemoveWindow(Ye,ut),Tt=wt&&wt.bearingDelta;if(Tt&&pt.setBearing(pt.getBearing()+Tt),this.mousePitch){const wt=this.mousePitch.mousemoveWindow(Ye,ut),Tt=wt&&wt.pitchDelta;Tt&&pt.setPitch(pt.getPitch()+Tt)}}off(){const Ye=this.element;Ye.removeEventListener("mousedown",this.mousedown),Ye.removeEventListener("touchstart",this.touchstart,{passive:!1}),Ye.removeEventListener("touchmove",this.touchmove),Ye.removeEventListener("touchend",this.touchend),Ye.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){_(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(ut){this.down(Ye.W({},ut,{ctrlKey:!0,preventDefault:()=>ut.preventDefault()}),p(this.element,ut)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(Ye){this.move(Ye,p(this.element,Ye))}mouseup(Ye){this.mouseRotate.mouseupWindow(Ye),this.mousePitch&&this.mousePitch.mouseupWindow(Ye),this.offTemp()}touchstart(Ye){1!==Ye.targetTouches.length?this.reset():(this._startPos=this._lastPos=f(this.element,Ye.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>Ye.preventDefault()},this._startPos))}touchmove(Ye){1!==Ye.targetTouches.length?this.reset():(this._lastPos=f(this.element,Ye.targetTouches)[0],this.move({preventDefault:()=>Ye.preventDefault()},this._lastPos))}touchend(Ye){0===Ye.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const $d={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Wd={maxWidth:100,unit:"metric"},Hd={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Xd={version:Ye.dt,supported:ut,setRTLTextPlugin:Ye.dv,getRTLTextPluginStatus:Ye.dw,Map:class extends Mn{constructor(ut){Ye.dc.mark(Ye.dd.create);const pt=ut;if(null!=(ut=Ye.W({},qd,ut)).minZoom&&null!=ut.maxZoom&&ut.minZoom>ut.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=ut.minPitch&&null!=ut.maxPitch&&ut.minPitch>ut.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=ut.minPitch&&ut.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=ut.maxPitch&&ut.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(ut.antialias&&Ye.de(window)&&(ut.antialias=!1,Ye.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new di(ut.minZoom,ut.maxZoom,ut.minPitch,ut.maxPitch,ut.renderWorldCopies),ut),this._repaint=!!ut.repaint,this._interactive=ut.interactive,this._minTileCacheSize=ut.minTileCacheSize,this._maxTileCacheSize=ut.maxTileCacheSize,this._failIfMajorPerformanceCaveat=ut.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=ut.preserveDrawingBuffer,this._antialias=ut.antialias,this._trackResize=ut.trackResize,this._bearingSnap=ut.bearingSnap,this._refreshExpiredTiles=ut.refreshExpiredTiles,this._fadeDuration=ut.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=ut.crossSourceCollisions,this._collectResourceTiming=ut.collectResourceTiming,this._language=this._parseLanguage(ut.language),this._worldview=ut.worldview,this._renderTaskQueue=new Fn,this._domRenderTaskQueue=new Fn,this._controls=[],this._markers=[],this._popups=[],this._mapId=Ye.df(),this._locale=Ye.W({},Gd,ut.locale),this._clickTolerance=ut.clickTolerance,this._cooperativeGestures=ut.cooperativeGestures,this._performanceMetricsCollection=ut.performanceMetricsCollection,this._tessellationStep=ut.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Vn(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._lastDirtyFrameId=0,this._requestManager=new Ye.dg(ut.transformRequest,ut.accessToken,ut.testMode),this._silenceAuthErrors=!!ut.testMode,this._contextCreateOptions=ut.contextCreateOptions?{...ut.contextCreateOptions}:{},"string"==typeof ut.container){const Ye=document.getElementById(ut.container);if(!Ye)throw new Error(`Container '${ut.container.toString()}' not found.`);this._container=Ye}else{if(!(ut.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=ut.container}if(this._container.childNodes.length>0&&Ye.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),ut.maxBounds&&this.setMaxBounds(ut.maxBounds),Ye.bp(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Zn),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Rn(this,ut),this._localFontFamily=ut.localFontFamily,this._localIdeographFontFamily=ut.localIdeographFontFamily,(ut.style||!ut.testMode)&&this.setStyle(ut.style||Ye.d8.DEFAULT_STYLE,{config:ut.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),ut.projection&&this.setProjection(ut.projection),ut.hash&&(this._hash=new za("string"==typeof ut.hash&&ut.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==pt.center&&null==pt.zoom||(this.transform._unmodified=!1),this.jumpTo({center:ut.center,zoom:ut.zoom,bearing:ut.bearing,pitch:ut.pitch});const wt=ut.bounds;wt&&(this.resize(),this.fitBounds(wt,Ye.W({},ut.fitBoundsOptions,{duration:0})))}this.resize(),ut.attributionControl&&this.addControl(new zn({customAttribution:ut.customAttribution})),this._logoControl=new On,this.addControl(this._logoControl,ut.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()})),this.on("data",(ut=>{this._update("style"===ut.dataType),this.fire(new Ye.f(`${ut.dataType}data`,ut))})),this.on("dataloading",(ut=>{this.fire(new Ye.f(`${ut.dataType}dataloading`,ut))}))}_getMapId(){return this._mapId}addControl(ut,pt){if(void 0===pt&&(pt=ut.getDefaultPosition?ut.getDefaultPosition():"top-right"),!ut||!ut.onAdd)return this.fire(new Ye.d(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const wt=ut.onAdd(this);this._controls.push(ut);const Tt=this._controlPositions[pt];return-1!==pt.indexOf("bottom")?Tt.insertBefore(wt,Tt.firstChild):Tt.appendChild(wt),this}removeControl(ut){if(!ut||!ut.onRemove)return this.fire(new Ye.d(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const pt=this._controls.indexOf(ut);return pt>-1&&this._controls.splice(pt,1),ut.onRemove(this),this}hasControl(Ye){return this._controls.indexOf(Ye)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(ut){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const pt=!this._moving;return pt&&this.fire(new Ye.f("movestart",ut)).fire(new Ye.f("move",ut)),this.fire(new Ye.f("resize",ut)),pt&&this.fire(new Ye.f("moveend",ut)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(ut){return this.transform.setMaxBounds(Ye.ai.convert(ut)),this._update()}setMinZoom(ut){if((ut=ut??-2)>=-2&&ut<=this.transform.maxZoom)return this.transform.minZoom=ut,this._update(),this.getZoom()<ut?this.setZoom(ut):this.fire(new Ye.f("zoomstart")).fire(new Ye.f("zoom")).fire(new Ye.f("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(ut){if((ut=ut??22)>=this.transform.minZoom)return this.transform.maxZoom=ut,this._update(),this.getZoom()>ut?this.setZoom(ut):this.fire(new Ye.f("zoomstart")).fire(new Ye.f("zoom")).fire(new Ye.f("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(ut){if((ut=ut??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(ut>=0&&ut<=this.transform.maxPitch)return this.transform.minPitch=ut,this._update(),this.getPitch()<ut?this.setPitch(ut):this.fire(new Ye.f("pitchstart")).fire(new Ye.f("pitch")).fire(new Ye.f("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(ut){if((ut=ut??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(ut>=this.transform.minPitch)return this.transform.maxPitch=ut,this._update(),this.getPitch()>ut?this.setPitch(ut):this.fire(new Ye.f("pitchstart")).fire(new Ye.f("pitch")).fire(new Ye.f("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(Ye){return this.transform.renderWorldCopies=Ye,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(Ye){return"auto"===Ye?navigator.language:Array.isArray(Ye)?0===Ye.length?void 0:Ye.map((Ye=>"auto"===Ye?navigator.language:Ye)):Ye}setLanguage(Ye){const ut=this._parseLanguage(Ye);if(!this.style||ut===this._language)return this;this._language=ut,this.style.reloadSources();for(const Ye of this._controls)Ye._setLanguage&&Ye._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(Ye){return this.style&&Ye!==this._worldview?(this._worldview=Ye,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(Ye){return this._lazyInitEmptyStyle(),Ye?"string"==typeof Ye&&(Ye={name:Ye}):Ye=null,this._useExplicitProjection=!!Ye,this._prioritizeAndUpdateProjection(Ye,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const ut=this.transform,pt=ut.projection.name;let wt;"globe"===pt&&ut.zoom>=Ye.aU?(ut.setMercatorFromTransition(),wt=!0):"mercator"===pt&&ut.zoom<Ye.aU&&(ut.setProjection({name:"globe"}),wt=!0),wt&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(Ye,ut){return this._updateProjection(Ye||ut||{name:"mercator"})}_updateProjection(ut){let pt;return pt="globe"===ut.name&&this.transform.zoom>=Ye.aU?this.transform.setMercatorFromTransition():this.transform.setProjection(ut),this.style.applyProjectionUpdate(),pt&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(ut){return this.transform.locationPoint3D(Ye.aI.convert(ut))}unproject(ut){return this.transform.pointLocation3D(Ye.P.convert(ut))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(Ye,ut,pt){if("mouseenter"===Ye||"mouseover"===Ye){let wt=!1;const r=Tt=>{const St=ut.filter((Ye=>this.getLayer(Ye))),It=St.length?this.queryRenderedFeatures(Tt.point,{layers:St}):[];It.length?wt||(wt=!0,pt.call(this,new Wa(Ye,this,Tt.originalEvent,{features:It}))):wt=!1},a=()=>{wt=!1};return{layers:new Set(ut),listener:pt,delegates:{mousemove:r,mouseout:a}}}if("mouseleave"===Ye||"mouseout"===Ye){let wt=!1;const r=Tt=>{const St=ut.filter((Ye=>this.getLayer(Ye)));(St.length?this.queryRenderedFeatures(Tt.point,{layers:St}):[]).length?wt=!0:wt&&(wt=!1,pt.call(this,new Wa(Ye,this,Tt.originalEvent)))},a=ut=>{wt&&(wt=!1,pt.call(this,new Wa(Ye,this,ut.originalEvent)))};return{layers:new Set(ut),listener:pt,delegates:{mousemove:r,mouseout:a}}}{const o=Ye=>{const wt=ut.filter((Ye=>this.getLayer(Ye))),Tt=wt.length?this.queryRenderedFeatures(Ye.point,{layers:wt}):[];Tt.length&&(Ye.features=Tt,pt.call(this,Ye),delete Ye.features)};return{layers:new Set(ut),listener:pt,delegates:{[Ye]:o}}}}on(Ye,ut,pt){if("function"==typeof ut||void 0===pt)return super.on(Ye,ut);if(Array.isArray(ut)||(ut=[ut]),ut)for(const Ye of ut)if(!this._isValidId(Ye))return this;const wt=this._createDelegatedListener(Ye,ut,pt);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[Ye]=this._delegatedListeners[Ye]||[],this._delegatedListeners[Ye].push(wt);for(const Ye in wt.delegates)this.on(Ye,wt.delegates[Ye]);return this}once(Ye,ut,pt){if("function"==typeof ut||void 0===pt)return super.once(Ye,ut);if(Array.isArray(ut)||(ut=[ut]),ut)for(const Ye of ut)if(!this._isValidId(Ye))return this;const wt=this._createDelegatedListener(Ye,ut,pt);for(const Ye in wt.delegates)this.once(Ye,wt.delegates[Ye]);return this}off(Ye,ut,pt){if("function"==typeof ut||void 0===pt)return super.off(Ye,ut);const wt=new Set(Array.isArray(ut)?ut:[ut]);for(const Ye of wt)if(!this._isValidId(Ye))return this;const r=(Ye,ut)=>{if(Ye.size!==ut.size)return!1;for(const pt of Ye)if(!ut.has(pt))return!1;return!0},Tt=this._delegatedListeners?this._delegatedListeners[Ye]:void 0;return Tt&&(Ye=>{for(let ut=0;ut<Ye.length;ut++){const Tt=Ye[ut];if(Tt.listener===pt&&r(Tt.layers,wt)){for(const Ye in Tt.delegates)this.off(Ye,Tt.delegates[Ye]);return Ye.splice(ut,1),this}}})(Tt),this}queryRenderedFeatures(ut,pt){if(!this.style)return[];if(void 0!==pt||void 0===ut||ut instanceof Ye.P||Array.isArray(ut)||(pt=ut,ut=void 0),ut=ut||[[0,0],[this.transform.width,this.transform.height]],(pt=pt||{}).layers&&Array.isArray(pt.layers))for(const Ye of pt.layers)if(!this._isValidId(Ye))return[];return this.style.queryRenderedFeatures(ut,pt,this.transform)}querySourceFeatures(Ye,ut){return this._isValidId(Ye)?this.style.querySourceFeatures(Ye,ut):[]}isPointOnSurface(ut){const{name:pt}=this.transform.projection;return"globe"!==pt&&"mercator"!==pt&&Ye.w(`${pt} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(Ye.P.convert(ut))}setStyle(ut,pt){return pt=Ye.W({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},pt),this.style&&ut&&!1!==pt.diff&&pt.localFontFamily===this._localFontFamily&&pt.localIdeographFontFamily===this._localIdeographFontFamily&&!pt.config?(this.style._diffStyle(ut,((wt,Tt)=>{wt?(Ye.w(`Unable to perform style diff: ${String(wt.message||wt.error||wt)}. Rebuilding the style from scratch.`),this._updateStyle(ut,pt)):Tt&&this._update(!0)}),(()=>{this._postStyleLoadEvent()})),this):(this._localIdeographFontFamily=pt.localIdeographFontFamily,this._localFontFamily=pt.localFontFamily,this._updateStyle(ut,pt))}_getUIString(Ye){const ut=this._locale[Ye];if(null==ut)throw new Error(`Missing UI string '${Ye}'`);return ut}_updateStyle(ut,pt){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),ut){const wt=Ye.W({},pt);pt&&pt.config&&(wt.initialConfig=pt.config,delete wt.config),this.style=new Da(this,wt).load(ut),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Da(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(Ye.w("There is no style added to the map."),!1)}_isValidId(ut){return null==ut?(this.fire(new Ye.d(new Error("IDs can't be empty."))),!1):!Ye.cV(ut)||(this.fire(new Ye.d(new Error(`IDs can't contain special symbols: "${ut}".`))),!1)}addSource(Ye,ut){return this._isValidId(Ye)?(this._lazyInitEmptyStyle(),this.style.addSource(Ye,ut),this._update(!0)):this}isSourceLoaded(Ye){return!!this._isValidId(Ye)&&!!this.style&&this.style._isSourceCacheLoaded(Ye)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(Ye,ut,pt){this._lazyInitEmptyStyle(),this.style.addSourceType(Ye,ut,pt)}removeSource(Ye){return this._isValidId(Ye)?(this.style.removeSource(Ye),this._updateTerrain(),this._update(!0)):this}getSource(Ye){return this._isValidId(Ye)?this.style.getOwnSource(Ye):null}addImage(ut,pt,{pixelRatio:wt=1,sdf:Tt=!1,stretchX:St,stretchY:It,content:Lt}={}){if(this._lazyInitEmptyStyle(),pt instanceof HTMLImageElement||ImageBitmap&&pt instanceof ImageBitmap){const{width:$t,height:Xt,data:Sr}=Ye.e.getImageData(pt);this.style.addImage(ut,{data:new Ye.i({width:$t,height:Xt},Sr),pixelRatio:wt,stretchX:St,stretchY:It,content:Lt,sdf:Tt,version:0})}else if(void 0===pt.width||void 0===pt.height)this.fire(new Ye.d(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:$t,height:Xt}=pt,Sr=pt;this.style.addImage(ut,{data:new Ye.i({width:$t,height:Xt},new Uint8Array(Sr.data)),pixelRatio:wt,stretchX:St,stretchY:It,content:Lt,sdf:Tt,version:0,userImage:Sr}),Sr.onAdd&&Sr.onAdd(this,ut)}}updateImage(ut,pt){this._lazyInitEmptyStyle();const wt=this.style.getImage(ut);if(!wt)return void this.fire(new Ye.d(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const Tt=pt instanceof HTMLImageElement||ImageBitmap&&pt instanceof ImageBitmap?Ye.e.getImageData(pt):pt,{width:St,height:It,data:Lt}=Tt;if(void 0===St||void 0===It)return void this.fire(new Ye.d(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(St!==wt.data.width||It!==wt.data.height)return void this.fire(new Ye.d(new Error(`The width and height of the updated image (${St}, ${It})\n                must be that same as the previous version of the image\n                (${wt.data.width}, ${wt.data.height})`)));const $t=!(pt instanceof HTMLImageElement||ImageBitmap&&pt instanceof ImageBitmap);wt.data.replace(Lt,$t),this.style.updateImage(ut,wt)}hasImage(ut){return ut?!!this.style&&!!this.style.getImage(ut):(this.fire(new Ye.d(new Error("Missing required image id"))),!1)}removeImage(Ye){this.style.removeImage(Ye)}loadImage(ut,pt){Ye.h(this._requestManager.transformRequest(ut,Ye.R.Image),((ut,wt)=>{pt(ut,wt instanceof HTMLImageElement?Ye.e.getImageData(wt):wt)}))}listImages(){return this.style.listImages()}addModel(Ye,ut){this._lazyInitEmptyStyle(),this.style.addModel(Ye,ut)}hasModel(ut){return ut?this.style.hasModel(ut):(this.fire(new Ye.d(new Error("Missing required model id"))),!1)}removeModel(Ye){this.style.removeModel(Ye)}listModels(){return this.style.listModels()}addLayer(Ye,ut){return this._isValidId(Ye.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(Ye,ut),this._update(!0)):this}getSlot(Ye){const ut=this.getLayer(Ye);return ut&&ut.slot||null}setSlot(Ye,ut){return this.style.setSlot(Ye,ut),this.style.mergeLayers(),this._update(!0)}addImport(Ye,ut){return this.style.addImport(Ye,ut),this}updateImport(Ye,ut){return"string"!=typeof ut&&ut.id!==Ye?(this.removeImport(Ye),this.addImport(ut)):(this.style.updateImport(Ye,ut),this._update(!0))}removeImport(Ye){return this.style.removeImport(Ye),this}moveImport(Ye,ut){return this.style.moveImport(Ye,ut),this._update(!0)}moveLayer(Ye,ut){return this._isValidId(Ye)?(this.style.moveLayer(Ye,ut),this._update(!0)):this}removeLayer(Ye){return this._isValidId(Ye)?(this.style.removeLayer(Ye),this._update(!0)):this}getLayer(Ye){if(!this._isValidId(Ye))return null;const ut=this.style.getOwnLayer(Ye);return ut?ut.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(Ye,ut,pt){return this._isValidId(Ye)?(this.style.setLayerZoomRange(Ye,ut,pt),this._update(!0)):this}setFilter(Ye,ut,pt={}){return this._isValidId(Ye)?(this.style.setFilter(Ye,ut,pt),this._update(!0)):this}getFilter(Ye){return this._isValidId(Ye)?this.style.getFilter(Ye):null}setPaintProperty(Ye,ut,pt,wt={}){return this._isValidId(Ye)?(this.style.setPaintProperty(Ye,ut,pt,wt),this._update(!0)):this}getPaintProperty(Ye,ut){return this._isValidId(Ye)?this.style.getPaintProperty(Ye,ut):null}setLayoutProperty(Ye,ut,pt,wt={}){return this._isValidId(Ye)?(this.style.setLayoutProperty(Ye,ut,pt,wt),this._update(!0)):this}getLayoutProperty(Ye,ut){return this._isValidId(Ye)?this.style.getLayoutProperty(Ye,ut):null}getSchema(Ye){return this.style.getSchema(Ye)}setSchema(Ye,ut){return this.style.setSchema(Ye,ut),this._update(!0)}getConfig(Ye){return this.style.getConfig(Ye)}setConfig(Ye,ut){return this.style.setConfig(Ye,ut),this._update(!0)}getConfigProperty(Ye,ut){return this.style.getConfigProperty(Ye,ut)}setConfigProperty(Ye,ut,pt){return this.style.setConfigProperty(Ye,ut,pt),this._update(!0)}setLights(Ye){if(this._lazyInitEmptyStyle(),Ye&&1===Ye.length&&"flat"===Ye[0].type){const ut=Ye[0];ut.properties?this.style.setFlatLight(ut.properties,ut.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(Ye),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const Ye=this.style.getLights()||[];return 0===Ye.length&&Ye.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),Ye}setLight(Ye,ut={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:Ye}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(Ye){return this._lazyInitEmptyStyle(),!Ye&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(Ye),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(Ye){return this._lazyInitEmptyStyle(),this.style.setFog(Ye),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setColorTheme(Ye){return this._lazyInitEmptyStyle(),this.style.setColorTheme(Ye),this._update(!0)}setCamera(Ye){return this.style.setCamera(Ye),this._triggerCameraUpdate(Ye)}_triggerCameraUpdate(Ye){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===Ye["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(ut){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(Ye.aI.convert(ut),this.transform):0}setFeatureState(Ye,ut){return this._isValidId(Ye.source)?(this.style.setFeatureState(Ye,ut),this._update()):this}removeFeatureState(Ye,ut){return this._isValidId(Ye.source)?(this.style.removeFeatureState(Ye,ut),this._update()):this}getFeatureState(Ye){return this._isValidId(Ye.source)?this.style.getFeatureState(Ye):null}_updateContainerDimensions(){if(!this._container)return;const Ye=this._container.getBoundingClientRect().width||400,ut=this._container.getBoundingClientRect().height||300;let pt,wt,Tt,St=this._container;for(;St&&(!wt||!Tt);){const Ye=window.getComputedStyle(St).transform;Ye&&"none"!==Ye&&(pt=Ye.match(/matrix.*\((.+)\)/)[1].split(", "),pt[0]&&"0"!==pt[0]&&"1"!==pt[0]&&(wt=pt[0]),pt[3]&&"0"!==pt[3]&&"1"!==pt[3]&&(Tt=pt[3])),St=St.parentElement}this._containerWidth=wt?Math.abs(Ye/wt):Ye,this._containerHeight=Tt?Math.abs(ut/Tt):ut}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&Ye.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const Ye=this._container;Ye.classList.add("mapboxgl-map"),(this._missingCSSCanary=a("div","mapboxgl-canary",Ye)).style.visibility="hidden",this._detectMissingCSS();const ut=this._canvasContainer=a("div","mapboxgl-canvas-container",Ye);this._canvas=a("canvas","mapboxgl-canvas",ut),this._interactive&&(ut.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const pt=this._controlContainer=a("div","mapboxgl-control-container",Ye),wt=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((Ye=>{wt[Ye]=a("div",`mapboxgl-ctrl-${Ye}`,pt)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(ut,pt){const wt=Ye.e.devicePixelRatio||1;this._canvas.width=wt*Math.ceil(ut),this._canvas.height=wt*Math.ceil(pt),this._canvas.style.width=`${ut}px`,this._canvas.style.height=`${pt}px`}_addMarker(Ye){this._markers.push(Ye)}_removeMarker(Ye){const ut=this._markers.indexOf(Ye);-1!==ut&&this._markers.splice(ut,1)}_addPopup(Ye){this._popups.push(Ye)}_removePopup(Ye){const ut=this._popups.indexOf(Ye);-1!==ut&&this._popups.splice(ut,1)}_setupPainter(){const pt=Ye.W({},ut.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),wt=this._canvas.getContext("webgl2",pt);wt?(Ye.dh(wt,!0),this.painter=new Ar(wt,this._contextCreateOptions,this.transform,this._tp),this.on("data",(Ye=>{"source"===Ye.dataType&&this.painter.setTileLoadedFlag(!0)})),Ye.di.testSupport(wt)):this.fire(new Ye.d(new Error("Failed to initialize WebGL")))}_contextLost(ut){ut.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new Ye.f("webglcontextlost",{originalEvent:ut}))}_contextRestored(ut){this._setupPainter(),this.resize(),this._update(),this.fire(new Ye.f("webglcontextrestored",{originalEvent:ut}))}_onMapScroll(Ye){if(Ye.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty&&!this._occlusionOpacityChanged&&this._occlusionCriteriaSatisfied()}_update(Ye){return this.style?(this._styleDirty=this._styleDirty||Ye,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(Ye){return this._update(),this._renderTaskQueue.add(Ye)}_cancelRenderFrame(Ye){this._renderTaskQueue.remove(Ye)}_requestDomTask(Ye){!this.loaded()||this.loaded()&&!this.isMoving()?Ye():this._domRenderTaskQueue.add(Ye)}_render(ut){let pt;this.fire(new Ye.f("renderstart")),++this._frameId;const wt=this.painter.context.extTimerQuery,Tt=Ye.e.now(),St=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(pt=St.createQuery(),St.beginQuery(wt.TIME_ELAPSED_EXT,pt)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(ut),this._domRenderTaskQueue.run(ut),this._removed)return;this._updateProjectionTransition();const It=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const ut=this.transform.zoom,pt=this.transform.pitch,wt=Ye.e.now(),Tt=new Ye.X(ut,{now:wt,fadeDuration:It,pitch:pt,transition:this.style.transition});this.style.update(Tt)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let Lt=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),Lt=this._updateAverageElevation(Tt),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):Lt=this._updateAverageElevation(Tt);const $t=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,It,this._crossSourceCollisions,this.painter.replacementSource);if($t&&(this._placementDirty=$t.needsRerender,this._occlusionOpacityChanged=$t.occlusionQueryBasedOpacityChanged),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:It,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new Ye.f("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Ye.dc.mark(Ye.dd.load),this.fire(new Ye.f("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),pt){const ut=Ye.e.now()-Tt;St.endQuery(wt.TIME_ELAPSED_EXT),setTimeout((()=>{const wt=St.getQueryParameter(pt,St.QUERY_RESULT)/1e6;St.deleteQuery(pt),this.fire(new Ye.f("gpu-timing-frame",{cpuTime:ut,gpuTime:wt}))}),50)}if(this.listens("gpu-timing-layer")){const ut=this.painter.collectGpuTimers();setTimeout((()=>{const pt=this.painter.queryGpuTimers(ut);this.fire(new Ye.f("gpu-timing-layer",{layerTimes:pt}))}),50)}if(this.listens("gpu-timing-deferred-render")){const ut=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const pt=this.painter.queryGpuTimeDeferredRender(ut);this.fire(new Ye.f("gpu-timing-deferred-render",{gpuTime:pt}))}),50)}const Xt=this._sourcesDirty||this._styleDirty||this._placementDirty||this._occlusionOpacityChanged||Lt;if((this._sourcesDirty||this._styleDirty||Lt||this._occlusionOpacityChanged)&&(this._lastDirtyFrameId=this._frameId),Xt||this._repaint||!this._occlusionCriteriaSatisfied())this.triggerRepaint();else{const ut=!this.isMoving()&&this.loaded();if(ut&&(Lt=this._updateAverageElevation(Tt,!0)),Lt)this.triggerRepaint();else if(this._triggerFrame(!1),ut&&(this.fire(new Ye.f("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const ut=this._calculateSpeedIndex();this.fire(new Ye.f("speedindexcompleted",{speedIndex:ut})),this.speedIndexTiming=!1}}this._loaded&&!this._fullyLoaded&&!Xt&&this._occlusionCriteriaSatisfied()&&(this._fullyLoaded=!0,Ye.dc.mark(Ye.dd.fullLoad),this._performanceMetricsCollection&&Ye.dj(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(Ye){for(const ut of this._markers)Ye&&!this.getRenderWorldCopies()&&(ut._lngLat=ut._lngLat.wrap()),ut._update();for(const ut of this._popups)!Ye||this.getRenderWorldCopies()||ut._trackPointer||(ut._lngLat=ut._lngLat.wrap()),ut._update()}_updateAverageElevation(Ye,ut=!1){const i=Ye=>(this.transform.averageElevation=Ye,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const pt=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(pt||(ut||Ye-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(Ye)){const ut=this.transform.averageElevation;let wt=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(wt)?wt=0:this._averageElevationLastSampledAt=Ye;const Tt=Math.abs(ut-wt);if(Tt>1){if(this._isInitialLoad||pt)return this._averageElevation.jumpTo(wt),i(wt);this._averageElevation.easeTo(wt,Ye,300)}else if(Tt>1e-4)return this._averageElevation.jumpTo(wt),i(wt)}return!!this._averageElevation.isEasing(Ye)&&i(this._averageElevation.getValue(Ye))}_authenticate(){Ye.dk(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(ut=>{if(ut&&(ut.message===Ye.dl||401===ut.status)){const ut=this.painter.context.gl;Ye.dh(ut,!1),this._logoControl instanceof On&&this._logoControl._updateLogo(),ut&&ut.clear(ut.DEPTH_BUFFER_BIT|ut.COLOR_BUFFER_BIT|ut.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new Ye.d(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),Ye.dm(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&Ye.dn(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const Ye=this._isDragging();this.painter.updateTerrain(this.style,Ye)}_calculateSpeedIndex(){const Ye=this.painter.canvasCopy(),ut=this.painter.getCanvasCopiesAndTimestamps();ut.timeStamps.push(performance.now());const pt=this.painter.context.gl,wt=pt.createFramebuffer();function r(Ye){pt.framebufferTexture2D(pt.FRAMEBUFFER,pt.COLOR_ATTACHMENT0,pt.TEXTURE_2D,Ye,0);const ut=new Uint8Array(pt.drawingBufferWidth*pt.drawingBufferHeight*4);return pt.readPixels(0,0,pt.drawingBufferWidth,pt.drawingBufferHeight,pt.RGBA,pt.UNSIGNED_BYTE,ut),ut}return pt.bindFramebuffer(pt.FRAMEBUFFER,wt),this._canvasPixelComparison(r(Ye),ut.canvasCopies.map(r),ut.timeStamps)}_canvasPixelComparison(Ye,ut,pt){let wt=pt[1]-pt[0];const Tt=Ye.length/4;for(let St=0;St<ut.length;St++){const It=ut[St];let Lt=0;for(let ut=0;ut<It.length;ut+=4)It[ut]===Ye[ut]&&It[ut+1]===Ye[ut+1]&&It[ut+2]===Ye[ut+2]&&It[ut+3]===Ye[ut+3]&&(Lt+=1);wt+=(pt[St+2]-pt[St+1])*(1-Lt/Tt)}return wt}remove(){this._hash&&this._hash.remove();for(const Ye of this._controls)Ye.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const ut=this.painter.context.gl.getExtension("WEBGL_lose_context");ut&&ut.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Ye.dp(this.painter.context.gl),Ye.dq.remove(),Ye.dr.remove(),this._removed=!0,this.fire(new Ye.f("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(ut){this._renderNextFrame=this._renderNextFrame||ut,this.style&&!this._frame&&(this._frame=Ye.e.frame((Ye=>{const ut=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,ut&&this._render(Ye)})))}_preloadTiles(ut){const pt=this.style?this.style.getSourceCaches():[];return Ye.ds(pt,((Ye,pt)=>Ye._preloadTiles(ut,pt)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(Ye){this._trackResize&&this.resize({originalEvent:Ye})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(Ye){this._showTileBoundaries!==Ye&&(this._showTileBoundaries=Ye,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(Ye){this._showParseStatus!==Ye&&(this._showParseStatus=Ye,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(Ye){this._showTerrainWireframe!==Ye&&(this._showTerrainWireframe=Ye,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(Ye){this._showLayers2DWireframe!==Ye&&(this._showLayers2DWireframe=Ye,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(Ye){this._showLayers3DWireframe!==Ye&&(this._showLayers3DWireframe=Ye,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(Ye){this._speedIndexTiming!==Ye&&(this._speedIndexTiming=Ye,this._update())}get showPadding(){return!!this._showPadding}set showPadding(Ye){this._showPadding!==Ye&&(this._showPadding=Ye,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(Ye){this._showCollisionBoxes!==Ye&&(this._showCollisionBoxes=Ye,this._tp.refreshUI(),Ye?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(Ye){this._showOverdrawInspector!==Ye&&(this._showOverdrawInspector=Ye,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(Ye){this._repaint!==Ye&&(this._repaint=Ye,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(Ye){this._vertices=Ye,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(Ye){this._showTileAABBs!==Ye&&(this._showTileAABBs=Ye,this._tp.refreshUI(),Ye&&this._update())}_setCacheLimits(ut,pt){Ye.du(ut,pt)}_occlusionCriteriaSatisfied(){const Ye=this.style&&(this.style.has3DLayers()||this.style.terrain&&!this.style.disableElevatedTerrain);return!(this.style&&this.style.hasSymbolLayers()&&Ye&&this.painter)||this._frameId-this._lastDirtyFrameId>5+2*this.painter.symbolParams.occlusionQueryFrameWindow}get version(){return Ye.dt}},NavigationControl:class{constructor(ut={}){this.options=Ye.W({},Zd,ut),this._container=a("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(Ye=>Ye.preventDefault())),this.options.showZoom&&(Ye.bp(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(Ye=>{this._map&&this._map.zoomIn({},{originalEvent:Ye})})),a("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(Ye=>{this._map&&this._map.zoomOut({},{originalEvent:Ye})})),a("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(Ye.bp(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(Ye=>{const ut=this._map;ut&&(this.options.visualizePitch?ut.resetNorthPitch({},{originalEvent:Ye}):ut.resetNorth({},{originalEvent:Ye}))})),this._compassIcon=a("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const Ye=this._map;if(!Ye)return;const ut=Ye.getZoom(),pt=ut===Ye.getMaxZoom(),wt=ut===Ye.getMinZoom();this._zoomInButton.disabled=pt,this._zoomOutButton.disabled=wt,this._zoomInButton.setAttribute("aria-disabled",pt.toString()),this._zoomOutButton.setAttribute("aria-disabled",wt.toString())}_rotateCompassArrow(){const Ye=this._map;if(!Ye)return;const ut=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(Ye.transform.pitch*(Math.PI/180)),.5)}) rotateX(${Ye.transform.pitch}deg) rotateZ(${Ye.transform.angle*(180/Math.PI)}deg)`:`rotate(${Ye.transform.angle*(180/Math.PI)}deg)`;Ye._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=ut)}))}onAdd(Ye){return this._map=Ye,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),Ye.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&Ye.on("pitch",this._rotateCompassArrow),Ye.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new $n(Ye,this._compass,this.options.visualizePitch)),this._container}onRemove(){const Ye=this._map;Ye&&(this._container.remove(),this.options.showZoom&&Ye.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&Ye.off("pitch",this._rotateCompassArrow),Ye.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(Ye,ut){const pt=a("button",Ye,this._container);return pt.type="button",pt.addEventListener("click",ut),pt}_setButtonTitle(Ye,ut){if(!this._map)return;const pt=this._map._getUIString(`NavigationControl.${ut}`);Ye.setAttribute("aria-label",pt),Ye.firstElementChild&&Ye.firstElementChild.setAttribute("title",pt)}},GeolocateControl:class extends Ye.E{constructor(ut={}){super();const pt=navigator.geolocation;this.options=Ye.W({geolocation:pt},$d,ut),Ye.bp(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ma(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(Ye){return this._map=Ye,this._container=a("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(Ye){const t=(ut=!!this.options.geolocation)=>{this._supportsGeolocation=ut,Ye(ut)};void 0!==this._supportsGeolocation?Ye(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((Ye=>t("denied"!==Ye.state))).catch((()=>t())):t()}_isOutOfMapMaxBounds(Ye){const ut=this._map.getMaxBounds(),pt=Ye.coords;return!!ut&&(pt.longitude<ut.getWest()||pt.longitude>ut.getEast()||pt.latitude<ut.getSouth()||pt.latitude>ut.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(ut){if(this._map){if(this._isOutOfMapMaxBounds(ut))return this._setErrorState(),this.fire(new Ye.f("outofmaxbounds",ut)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=ut,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(ut),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(ut),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new Ye.f("geolocate",ut)),this._finish()}}_updateCamera(ut){const pt=new Ye.aI(ut.coords.longitude,ut.coords.latitude),wt=ut.coords.accuracy,Tt=this._map.getBearing(),St=Ye.W({bearing:Tt},this.options.fitBoundsOptions);this._map.fitBounds(pt.toBounds(wt),St,{geolocateSource:!0})}_updateMarker(ut){if(ut){const pt=new Ye.aI(ut.coords.longitude,ut.coords.latitude);this._accuracyCircleMarker.setLngLat(pt).addTo(this._map),this._userLocationDotMarker.setLngLat(pt).addTo(this._map),this._accuracy=ut.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const ut=this._map.transform,pt=Ye.ax(1,ut._center.lat)*ut.worldSize,wt=Math.ceil(2*this._accuracy*pt);this._circleElement.style.width=`${wt}px`,this._circleElement.style.height=`${wt}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(ut){if(this._map){if(this.options.trackUserLocation)if(1===ut.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const Ye=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",Ye),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",Ye),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===ut.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new Ye.f("error",ut)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(ut){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(Ye=>Ye.preventDefault())),this._geolocateButton=a("button","mapboxgl-ctrl-geolocate",this._container),a("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===ut){Ye.w("Geolocation support is not available so the GeolocateControl will be disabled.");const ut=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",ut),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",ut)}else{const Ye=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",Ye),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",Ye)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=a("div","mapboxgl-user-location"),this._dotElement.appendChild(a("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(a("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Nn({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=a("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Nn({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(ut=>{ut.geolocateSource||"ACTIVE_LOCK"!==this._watchState||ut.originalEvent&&"resize"===ut.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new Ye.f("trackuserlocationend")))}))}}_onDeviceOrientation(Ye){this._userLocationDotMarker&&(Ye.webkitCompassHeading?this._heading=Ye.webkitCompassHeading:!0===Ye.absolute&&(this._heading=-1*Ye.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return Ye.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new Ye.f("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new Ye.f("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new Ye.f("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let Ye;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(Ye={maximumAge:6e5,timeout:0},this._noTimeout=!0):(Ye=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,Ye),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((Ye=>{"granted"===Ye&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:zn,ScaleControl:class{constructor(ut={}){this.options=Ye.W({},Wd,ut),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(Ye){return!1}}(),Ye.bp(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const Ye=this.options.maxWidth||100,ut=this._map,pt=ut._containerHeight/2,wt=ut._containerWidth/2-Ye/2,Tt=ut.unproject([wt,pt]),St=ut.unproject([wt+Ye,pt]),It=Tt.distanceTo(St);if("imperial"===this.options.unit){const ut=3.2808*It;ut>5280?this._setScale(Ye,ut/5280,"mile"):this._setScale(Ye,ut,"foot")}else"nautical"===this.options.unit?this._setScale(Ye,It/1852,"nautical-mile"):It>=1e3?this._setScale(Ye,It/1e3,"kilometer"):this._setScale(Ye,It,"meter")}_setScale(Ye,ut,pt){this._map._requestDomTask((()=>{const wt=function(Ye){const ut=Math.pow(10,`${Math.floor(Ye)}`.length-1);let pt=Ye/ut;return pt=pt>=10?10:pt>=5?5:pt>=3?3:pt>=2?2:pt>=1?1:function(Ye){const ut=Math.pow(10,Math.ceil(-Math.log(Ye)/Math.LN10));return Math.round(Ye*ut)/ut}(pt),ut*pt}(ut),Tt=wt/ut;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==pt?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:pt}).format(wt):`${wt}&nbsp;${Hd[pt]}`,this._container.style.width=Ye*Tt+"px"}))}onAdd(Ye){return this._map=Ye,this._language=Ye.getLanguage(),this._container=a("div","mapboxgl-ctrl mapboxgl-ctrl-scale",Ye.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(Ye){this._language=Ye,this._update()}setUnit(Ye){this.options.unit=Ye,this._update()}},FullscreenControl:class{constructor(ut={}){this._fullscreen=!1,ut&&ut.container&&(ut.container instanceof HTMLElement?this._container=ut.container:Ye.w("Full screen control 'container' must be a DOM element.")),Ye.bp(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(ut){return this._map=ut,this._container||(this._container=this._map.getContainer()),this._controlContainer=a("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",Ye.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const Ye=this._fullscreenButton=a("button","mapboxgl-ctrl-fullscreen",this._controlContainer);a("span","mapboxgl-ctrl-icon",Ye).setAttribute("aria-hidden","true"),Ye.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const Ye=this._getTitle();this._fullscreenButton.setAttribute("aria-label",Ye),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",Ye)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends Ye.E{constructor(ut){super(),this.options=Ye.W(Object.create(Ud),ut),Ye.bp(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(ut&&ut.className?ut.className.trim().split(/\s+/):[])}addTo(ut){return this._map&&this.remove(),this._map=ut,this.options.closeOnClick&&ut.on("preclick",this._onClose),this.options.closeOnMove&&ut.on("move",this._onClose),ut.on("remove",this.remove),this._update(),ut._addPopup(this),this._focusFirstElement(),this._trackPointer?(ut.on("mousemove",this._onMouseEvent),ut.on("mouseup",this._onMouseEvent),ut._canvasContainer.classList.add("mapboxgl-track-pointer")):ut.on("move",this._update),this.fire(new Ye.f("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const ut=this._map;return ut&&(ut.off("move",this._update),ut.off("move",this._onClose),ut.off("preclick",this._onClose),ut.off("click",this._onClose),ut.off("remove",this.remove),ut.off("mousemove",this._onMouseEvent),ut.off("mouseup",this._onMouseEvent),ut.off("drag",this._onMouseEvent),ut._canvasContainer&&ut._canvasContainer.classList.remove("mapboxgl-track-pointer"),ut._removePopup(this),this._map=void 0),this.fire(new Ye.f("close")),this}getLngLat(){return this._lngLat}setLngLat(ut){this._lngLat=Ye.aI.convert(ut),this._pos=null,this._trackPointer=!1,this._update();const pt=this._map;return pt&&(pt.on("move",this._update),pt.off("mousemove",this._onMouseEvent),pt._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const Ye=this._map;return Ye&&(Ye.off("move",this._update),Ye.on("mousemove",this._onMouseEvent),Ye.on("drag",this._onMouseEvent),Ye._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(Ye){return this.setDOMContent(document.createTextNode(Ye))}setHTML(Ye){const ut=document.createDocumentFragment(),pt=document.createElement("body");let wt;for(pt.innerHTML=Ye;wt=pt.firstChild,wt;)ut.appendChild(wt);return this.setDOMContent(ut)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(Ye){return this.options.maxWidth=Ye,this._update(),this}setDOMContent(Ye){let ut=this._content;if(ut)for(;ut.hasChildNodes();)ut.firstChild&&ut.removeChild(ut.firstChild);else ut=this._content=a("div","mapboxgl-popup-content",this._container||void 0);if(ut.appendChild(Ye),this.options.closeButton){const Ye=this._closeButton=a("button","mapboxgl-popup-close-button",ut);Ye.type="button",Ye.setAttribute("aria-label","Close popup"),Ye.setAttribute("aria-hidden","true"),Ye.innerHTML="&#215;",Ye.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(Ye){return this._classList.add(Ye),this._updateClassList(),this}removeClassName(Ye){return this._classList.delete(Ye),this._updateClassList(),this}setOffset(Ye){return this.options.offset=Ye,this._update(),this}toggleClassName(Ye){let ut;return this._classList.delete(Ye)?ut=!1:(this._classList.add(Ye),ut=!0),this._updateClassList(),ut}_onMouseEvent(Ye){this._update(Ye.point)}_getAnchor(Ye){if(this.options.anchor)return this.options.anchor;const ut=this._map,pt=this._container,wt=this._pos;if(!ut||!pt||!wt)return"bottom";const Tt=pt.offsetWidth,St=pt.offsetHeight,It=wt.x<Tt/2,Lt=wt.x>ut.transform.width-Tt/2;if(wt.y+Ye<St)return It?"top-left":Lt?"top-right":"top";if(wt.y>ut.transform.height-St){if(It)return"bottom-left";if(Lt)return"bottom-right"}return It?"left":Lt?"right":"bottom"}_updateClassList(){const Ye=this._container;if(!Ye)return;const ut=[...this._classList];ut.push("mapboxgl-popup"),this._anchor&&ut.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&ut.push("mapboxgl-popup-track-pointer"),Ye.className=ut.join(" ")}_update(ut){const pt=this._map,wt=this._content;if(!pt||!this._lngLat&&!this._trackPointer||!wt)return;let Tt=this._container;if(Tt||(Tt=this._container=a("div","mapboxgl-popup",pt.getContainer()),this._tip=a("div","mapboxgl-popup-tip",Tt),Tt.appendChild(wt)),this.options.maxWidth&&Tt.style.maxWidth!==this.options.maxWidth&&(Tt.style.maxWidth=this.options.maxWidth),pt.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Bn(this._lngLat,this._pos,pt.transform)),!this._trackPointer||ut){const wt=this._pos=this._trackPointer&&ut instanceof Ye.P?ut:pt.project(this._lngLat),Tt=jn(this.options.offset),St=this._anchor=this._getAnchor(Tt.y),It=jn(this.options.offset,St),Lt=wt.add(It).round();pt._requestDomTask((()=>{this._container&&St&&(this._container.style.transform=`${Vd[St]} translate(${Lt.x}px,${Lt.y}px)`)}))}if(!this._marker&&pt._showingGlobe()){const ut=Ye.d9(pt.transform,this._lngLat)?0:1;this._setOpacity(ut)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const Ye=this._container.querySelector(jd);Ye&&Ye.focus()}_onClose(){this.remove()}_setOpacity(Ye){this._container&&(this._container.style.opacity=`${Ye}`),this._content&&(this._content.style.pointerEvents=Ye?"auto":"none")}},Marker:Nn,Style:Da,LngLat:Ye.aI,LngLatBounds:Ye.ai,Point:Ye.P,MercatorCoordinate:Ye.Y,FreeCameraOptions:qt,Evented:Ye.E,config:Ye.d8,prewarm:Ye.dx,clearPrewarmedResources:Ye.dy,get accessToken(){return Ye.d8.ACCESS_TOKEN},set accessToken(ut){Ye.d8.ACCESS_TOKEN=ut},get baseApiUrl(){return Ye.d8.API_URL},set baseApiUrl(ut){Ye.d8.API_URL=ut},get workerCount(){return Ye.dz.workerCount},set workerCount(ut){Ye.dz.workerCount=ut},get maxParallelImageRequests(){return Ye.d8.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(ut){Ye.d8.MAX_PARALLEL_IMAGE_REQUESTS=ut},clearStorage(ut){Ye.dA(ut)},get workerUrl(){return Ye.dB.workerUrl},set workerUrl(ut){Ye.dB.workerUrl=ut},get workerClass(){return Ye.dB.workerClass},set workerClass(ut){Ye.dB.workerClass=ut},get workerParams(){return Ye.dB.workerParams},set workerParams(ut){Ye.dB.workerParams=ut},get dracoUrl(){return Ye.dC()},set dracoUrl(ut){Ye.dD(ut)},get meshoptUrl(){return Ye.dE()},set meshoptUrl(ut){Ye.dF(ut)},setNow:Ye.e.setNow,restoreNow:Ye.e.restoreNow};return Xd}));var St=Tt;return St}));var Tt=pt;export{Tt as default};

